================================================================================
Year: 2017 | Commits: 600 | Contributors: 17
Insertions: +19701 | Deletions: -4286
================================================================================

[d1ad9561e9cd] 2017-12-29 22:42:45 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support for '-f[no-][un]signed-char'

Till now, sparse's plain chars where signed with no possibility
to change it. This is a problem when using sparse on code
for architectures like ARM where chars are by default unsigned
or simply for code compiled with GCC's '-f[no-][un]signed-char'.

Change this by parsing these options and adjusting the type
of plain chars accordingly.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+3/-0), lib.h (+1/-0), sparse.1 (+5/-0), symbol.c (+6/-0), validation/char-signed.c (+9/-0), ... and 1 more
--------------------------------------------------------------------------------

[95ae484069eb] 2017-12-29 00:09:24 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: let handle_switches() also handle reverse logic

Some flags, for good or less good reasons, exist under two
different names: like a positive version and a negative one.
This is in addition of the 'no-' prefix.

The use case here is '-f[no-][un]signed-char'.

Make it easy and allow to specify that a given flag is the
negative version of another one so that '-fsigned-char' is
handled exactly as '-fno-unsigned-char'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+2/-0)
--------------------------------------------------------------------------------

[813fb036ba90] 2017-12-28 22:17:04 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix implicit size of unsized arrays

When an array is declared without an explicit size. In this case,
an implicit size is given by the number of elements in its initializer
if one is present.

Currently, in sparse, this implicit size is only associated with
the node corresponding to the initializer while the base type is
left unsized. This is a problem because the node is only used for
the modifiers & address-space and the bitsize of nodes are expected
to match the size of the basetype. So this implicit size can be used
for when directly using the bit_size of the node but the array is
still left, essentially unsized.

It's not enough to simply copy the bitsize of the node to the base
type because:
1) sym->array_size need to be set in the node & the base type.
2) the base type can be shared between several declarators.
It's thus needed to copy the the base type to unshare it before
setting the sym->array_size.

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+18/-1), validation/array-implicit-size.c (+26/-0), validation/constexpr-preop.c (+2/-0)
--------------------------------------------------------------------------------

[d111934dc7d8] 2017-12-28 21:52:20 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for type comparison

Sparse, as an extension and with a special syntax, supports the
direct comparison of types, either equality modulo qualifiers for
'==' and '!=', or size comparison for '<', '>', '<=' and '>='.

Add some testcases to avoid possible regressions here.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/type-compare.c (+76/-0)
--------------------------------------------------------------------------------

[5826deab5956] 2017-12-28 21:38:59 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add more testcases for function designator dereference

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/Waddress-weak.c (+2/-0), validation/Waddress.c (+4/-0), validation/linear/degen-function.c (+13/-0)
--------------------------------------------------------------------------------

[5881114fa8fa] 2017-12-28 18:45:17 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: default init of arrays & structs

Linearization of arrays & structs default initialization is done
as if these objects would be an integer as large as the object.
This integer is then simply zero-initialized.
(This may be objectionable and will be done differently).

However, sparse-llvm is not ready to handle this situation where
a non-scalar is initialized with a scalar value.

Workaround this by using LLVMConstNull() when possible.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+6/-0)
--------------------------------------------------------------------------------

[184347035074] 2017-12-28 18:42:34 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: simplify emit of null pointers

Most pointers with a constant value are simply null-pointers.
The only exception is when a known address is casted to pointer.

The current code only handle code for the general case:
emit code for a constant integer and then cast this to a pointer.
This obfuscate a bit the ouput, making it hard to read.

Change this by special handling the normal case of null-pointers
by directly using LLVM's LLVMConstPointerNull().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+6/-4)
--------------------------------------------------------------------------------

[bc92aabb7546] 2017-12-28 18:28:10 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix crash on bad expression in linearize_switch()

If the expression for the condition is dereferenced
for its type even if it is NULL.

Fix this by returning early if the expression linearize to VOID.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+2/-0), validation/empty-expr.c (+0/-1)
--------------------------------------------------------------------------------

[f1e3c9e9c9ae] 2017-12-28 18:06:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: warn on empty parenthesized expressions

Empty sub-expressions are normally caught as syntax error
in most expressions but this is not the case for parenthesized
expressions.

Fix this by adding a check at the end of parens_expressions()
and warning if needed.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expression.c (+6/-0), validation/empty-expr.c (+27/-0)
--------------------------------------------------------------------------------

[62171af39abe] 2017-12-28 16:12:24 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testcases: add missing return statements

In some testcases, some non-void functions are missing
a return statement.  This is undetected because:
- no checks are done and so no warnings can be given
- there are some bugs in the linearization of returns
  (the value returned by the last statement is implicitly used).

Fix the testcases by adding the missing return.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/call-variadic.c (+1/-1), validation/struct-as.c (+1/-1)
--------------------------------------------------------------------------------

[052706dd18d6] 2017-12-27 16:37:39 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: add declares for function prototypes

Currently, for the LLVM's IR, the functions are only declared
when they are called (or otherwise used) or when they are defined,
whichever come first. But systematically adding a declaration
for each function we have the prototype shouldn't hurt and
would add one level of type checking.

Change this by adding the declaration (via get_sym_value())
for each prototype we have.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+4/-1)
--------------------------------------------------------------------------------

[52a8baf4fb03] 2017-12-27 16:33:12 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: use LLVMModuleRef for get_sym_value()

This function only need the reference for the module,
but currently is given the whole 'struct function'.

Change this by directly passing the module reference to
get_sym_value() so that this function can now be used
before the 'struct function' is created.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+8/-8)
--------------------------------------------------------------------------------

[84a00109ff52] 2017-12-27 16:00:53 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix: previous function ref MUST be reused

In sparse-llvm, when  a reference to a function is made via
get_sym_value(), for example for a call, the reference is
created with LLVMAddFunction() and if needed later, the existing
reference is returned via LLVMGetNamedFunction().
This is the correct way to do it.

However, when emitting the code for a function definition, a fresh
reference is always made. If a previous reference to this function
already existed, the second one will have a slightly different name:
the given name suffixed by ".<somenumber>". LLVM does this for every
created references, to disambiguate them. As consequence, the
compiled function will not be name "<functionname>", as expected,
but "<functionname>.<somenumber>".

Fix this by always using get_sym_value() when emitting the code
for the function definition as this will return the reference
for the given function name if it already exist.
This has the added bonus to remove some code duplication.

CC: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+2/-23), validation/backend/fn-ref.c (+32/-0)
--------------------------------------------------------------------------------

[c32bba86f932] 2017-12-21 12:48:44 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: restore CSE on floating-point compares

Since commit "1c182507c (fix support of floating-point compare)",
CSE wasn't done anymore on floating-point compare.

Fix this by adding the two missing 'case OP_FPCMP ...'

Fixes: 1c182507c3981aa20193c68d7cfd32d750b571cf
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cse.c (+3/-1), validation/optim/cse-fcmp.c (+0/-1)
--------------------------------------------------------------------------------

[3713d65642d5] 2017-12-21 12:46:59 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for CSE of floating-point compares

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/cse-fcmp.c (+20/-0)
--------------------------------------------------------------------------------

[b0b38fff5b42] 2017-12-21 12:41:59 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix expansion of constant bitfield dereference

During the expansion of a dereference, it's checked if the
initializer corrresponding to the offset we're interested in
is a constant. If it's the case, the dereference can be avoided
and the constant given as initializer can be used instead.

However, it's not enough to check for the offset since, for
bitfields there are (usualy) several distinct fields at the
same offset. Currently, the first initializer matching the
offset is selected and, if a constant, its value is used
for the result of the dereferencing of the whole structure.

Fix this by refusing such expansion if the constant value
correspond to a bitfield.

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expand.c (+2/-0), validation/linear/bitfield-expand-deref.c (+0/-1)
--------------------------------------------------------------------------------

[c18aec74fd9f] 2017-12-21 12:40:29 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for constant bitfield dereference

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/bitfield-expand-deref.c (+28/-0)
--------------------------------------------------------------------------------

[69a789a78d4e] 2017-12-21 01:54:31 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'deref-fun-ptr' and 'deref-base-type' into tip

[Auto-summary] Modifies evaluate.c. Adds/updates 2 test(s). Changes: +63/-0 in 3 file(s)

Files: evaluate.c (+1/-0), validation/linear/deref-ptr-ptr.c (+26/-0), validation/linear/unexamined-base-type.c (+36/-0)
--------------------------------------------------------------------------------

[eeacb2cb90b2] 2017-12-21 01:53:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dereference of a function is a no-op

For the '*' operator and functions, the C standard says:
        "If the operand points to a function, the result is a
         function designator; ... If the operand has type
         ‘pointer to type’, the result has type ‘type’".
but also (C11 6.3.2.1p4):
        "(except with 'sizeof' ...) a function designator with type
         ‘function returning type’ is converted to an expression
          that has type ‘pointer to function returning type’".

This means that in dereferencement of a function-designator is
a no-op since the resulting expression is immediately back converted
to a pointer to the function.

The change effectively drop any dereferencement of function types
during their evaluation.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+3/-0), validation/function-pointer-type.c (+0/-1), validation/linear/call-builtin.c (+0/-1), validation/linear/call-direct.c (+0/-1), validation/linear/call-indirect.c (+0/-1), ... and 2 more
--------------------------------------------------------------------------------

[fe71f6b30640] 2017-12-21 01:53:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: avoid unneeded alloc on error path

In evaluate_dereference(), a node is allocated but
is not used if there is an error.

Fix this by allocating the node after the error checks.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+2/-1)
--------------------------------------------------------------------------------

[9a0fe9ce8e8b] 2017-12-21 01:53:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for multiple deref of calls

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/function-pointer-type.c (+4/-0), validation/linear/call-builtin.c (+5/-1), validation/linear/call-direct.c (+5/-1), validation/linear/call-indirect.c (+4/-1), validation/linear/call-inline.c (+5/-1)
--------------------------------------------------------------------------------

[2be50b1451d9] 2017-12-21 01:53:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix linearize (*fun)()

A function call via a function pointer can be written like:
	fp(), (fp)() or (*fp)()
In the latter case the dereference is unneeded but legal and
idiomatic.

However, the linearization doesn't handle this unneeded deref
and leads to the generation of a load of the pointer:

	int foo(int a, int (*fun)(int))
	{
		(*fun)(a);
	}

gives something like:
	foo:
		load        %r2 <- 0[%arg2]
		call.32     %r3 <- %r2, %arg1
		ret.32      %r3

This happens because, at linearization, the deref is dropped
but only if the sub-expression is a symbol and the test for
node is not done.

Fix this by using is_func_type() to test the type of all call
expressions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+3/-7), validation/linear/call-basic.c (+0/-1), validation/linear/call-casted-pointer.c (+0/-1), validation/linear/call-indirect.c (+0/-1)
--------------------------------------------------------------------------------

[c2f4b9f69159] 2017-12-21 01:53:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify linearize_call_expression()

Use the fact that fn->ctype can't be NULL if expr->ctype
is not NULL.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+3/-8)
--------------------------------------------------------------------------------

[fd02a4ef554a] 2017-12-21 01:53:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for the linearization of calls

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/builtin-arith.c (+52/-0), validation/function-pointer-type.c (+9/-0), validation/linear/call-basic.c (+58/-0), validation/linear/call-builtin.c (+14/-0), validation/linear/call-casted-pointer.c (+32/-0), ... and 7 more
--------------------------------------------------------------------------------

[696b243a5ae0] 2017-12-21 01:23:56 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: evaluate_dereference() unexamined base type

Examination of a pointer type doesn't examine the corresponding
base type (this base type may not yet be complete). So, this
examination must be done later, when the base type is needed.

However, in some cases it's possible to call evaluate_dereference()
while the base type is still unexamined.

Fix this by adding the missing examine_symbol_type() on the base type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-0), validation/linear/deref-ptr-ptr.c (+0/-1), validation/linear/unexamined-base-type.c (+0/-1)
--------------------------------------------------------------------------------

[26d547eeb3df] 2017-12-21 00:33:43 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for unexamined base type

evaluate_dereference() lacks an explicit examination of the
base type. Most of the time, the base type has already been
examined via another path, but in some case, it's not.

The symptom here is the dereferenced value having a null size.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/deref-ptr-ptr.c (+27/-0), validation/linear/unexamined-base-type.c (+37/-0)
--------------------------------------------------------------------------------

[178f19ad47c9] 2017-12-16 16:31:35 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'testsuite-arg-env' into cli-macro

[Auto-summary] Adds/updates 1 test(s). Changes: +6/-8 in 1 file(s)

Files: validation/test-suite (+6/-8)
--------------------------------------------------------------------------------

[2f922ba822da] 2017-12-16 16:31:06 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: spaces in macro definition on the command line

GCC's manual or POSIX say about the '-D' option something like:
    '−D name[=value]' should be treated as if in directive
    '#define name value' (with '1' as default for the value),
    including its tokenization.
So an option like '-DM(X, Y)=...' should be processed like a
directive '#define M(X, Y) ...'.

However, the current code treat a space as a separator between
the macro and its definition, just like the '='. As consequence,
the above option is processed like the directive would be
'#define M(X, Y)=...', with 'M(X,' as the macro (name) and
'Y)=...' as its definition.

Fix this by stopping to treat the space character specially,
thus only using '=' as the separator.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-1), validation/preprocessor/cli-D-space.c (+0/-1)
--------------------------------------------------------------------------------

[5a24ca94da07] 2017-12-16 16:31:06 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for space within command line

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/preprocessor/cli-D-space.c (+11/-0)
--------------------------------------------------------------------------------

[266efab3fa3c] 2017-12-16 16:26:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'testsuite-fix-quotes-cmdline' into cli-macro

[Auto-summary] Adds/updates 2 test(s). Changes: +14/-5 in 2 file(s)

Files: validation/self-quote-args.c (+7/-0), validation/test-suite (+7/-5)
--------------------------------------------------------------------------------

[df281cefca96] 2017-12-16 16:21:45 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: allow default args from environment for test commands

During testing it's sometimes useful to force some default arguments
for all commands. An example of this is using '-m32' which essentially
allow to run the tessuite on an 64bit machine as-if run a 32-bit one.

Allow this by using the environment variable 'SPARSE_TEST_ARGS' to
hole default arguments for the test commands.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+2/-1)
--------------------------------------------------------------------------------

[090110476823] 2017-12-16 16:21:45 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: process extra options without exec

Commit 399c43889 (testsuite: get options from env too) allowed
the testsuite to takes extra options from the environment but
did it in a crude way involving exec.

Change this by using 'set --' instead of doing an 'exec'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+4/-7)
--------------------------------------------------------------------------------

[b42541e16476] 2017-12-16 16:21:45 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: respect command line's quotes & whitespaces

Currently the testsuite use 'eval echo $cmd' to expand
the name of the test file to be given on the command line.

This has the annoying consequence to go a bit too far in
the expansion of variables and to destroy any quotes and
whitespaces escaping that would have done.

Fix this by doing the eval later, when effectively executing
the command.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/self-quote-args.c (+0/-1), validation/test-suite (+7/-5)
--------------------------------------------------------------------------------

[5fec039b49c1] 2017-12-13 14:24:01 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add test case for quoting of command's arguments

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/self-quote-args.c (+8/-0)
--------------------------------------------------------------------------------

[7f1011b311e9] 2017-12-13 12:01:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: accept 'sparse -D M...'

Till now, sparse was unneedlessly strict in what it accepted in
'-D' options. More specifically, it doesn't accept:
1) separated '-D' and the macro definition, like:
	sparse -D MACRO[=definition] ...
2) a space between the '-D' and the macro name, like:
	sparse '-D MACRO[=definition] ...

Case 1) is clearly accepted by GCC, clang and should be
accepted for a POSIX's c99. Case 2's status is less clear
but is also accepted by GCC and clang (leaving any validation
to the corresponding internal #define).

Fix this by accepting separated command line argument for '-D'
and the macro (and removing the check that rejected the macro
part if it started with a space).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+8/-4), validation/preprocessor/cli-D-arg.c (+0/-1)
--------------------------------------------------------------------------------

[35d525808846] 2017-12-13 12:01:49 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for 'sparse -D M...'

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/preprocessor/cli-D-arg.c (+13/-0)
--------------------------------------------------------------------------------

[497ea18b4550] 2017-12-10 18:20:40 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge remote-tracking branch 'worktree/testsuite-next'

Some fixes & improvements to the testsuite; mainly:
- allow to run the testsuite on all the tests of a subdir
- teach 'format' to directly append to the testcase
- validate the 'check-...' tags

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1), validation/cond-address.c (+1/-1), validation/cond-err-expand.c (+1/-1), validation/fp-ops.c (+1/-1), validation/fp2i-cast.c (+1/-1), ... and 9 more
--------------------------------------------------------------------------------

[0b49d57d362f] 2017-12-08 13:55:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add support for 'format -a'

The 'format' command create the information needed for the testcase
from the input file and output this on stdout. The developper must
then add this to the input file.

Let's do this automatically by adding an option '-a' to the 'format'
command to directly append the infos to the input file.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+5/-0)
--------------------------------------------------------------------------------

[91ae85c67464] 2017-12-08 13:55:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: default to shift in the getopt loop

The getopt loop used to bear by default and only some
options had to explicitly call 'shift' and 'continue'
to process further elements.

Change this to a 'normal' loop, shifting the next arg by default
and breaking of the loop when needed.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+1/-9)
--------------------------------------------------------------------------------

[ca1f89a7fad1] 2017-12-08 13:55:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: allow to test only a subdir

During development, it is very useful to be able to run only
some of the tests, maybe a whole class.

Help this by allowing to run the testsuite on only a subdir
of the 'validation/' directory.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+17/-5)
--------------------------------------------------------------------------------

[1af475f2ef8f] 2017-12-08 13:55:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: change do_usage text

The text for the testsuite usage used 'none' as if it was an
option/keyword while it only meant the absence of arguments.

Make the text clearer by removing the 'none' and being explicit
about the absence of arguments.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+7/-7)
--------------------------------------------------------------------------------

[54f49cdcd8c4] 2017-12-08 13:55:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: move no-arg out of the getopt loop

This is a preparatory step to allow to run only a part
of the testsuite (a subdir).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+5/-6)
--------------------------------------------------------------------------------

[4f960ec3f4d5] 2017-12-08 13:55:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: move do_test_suite out of the getopt loop

This is a preparatory step to allow to run only a part
of the testsuite (a subdir).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+1/-2)
--------------------------------------------------------------------------------

[881679750173] 2017-12-08 13:55:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: early return in getopt loop

This is a preparatory step to allow to run only a part
of the testsuite (a subdir).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+4/-0)
--------------------------------------------------------------------------------

[c34baae31b31] 2017-12-08 13:55:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: validate the 'check-...' tags

Making a typo in one of the 'check-...' tags can make
a testcase useless and thus incapable of detecting a regression.

Add some validation to these tags in order to detect wrong
tags.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+12/-0)
--------------------------------------------------------------------------------

[3ed200372956] 2017-12-08 13:55:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: fix invalid 'check-...' tags

A few testcases had typos in their 'check-...' tags or
the tag was plainly invalid.

Fix them in accordance to the doc.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/cond-address.c (+1/-1), validation/cond-err-expand.c (+1/-1), validation/nested-declarator.c (+2/-2), validation/nested-declarator2.c (+2/-2), validation/optim/canonical-cmp.c (+1/-1), ... and 3 more
--------------------------------------------------------------------------------

[836885ffc5c4] 2017-12-08 13:55:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: reset 'quiet' at the start of each testcase

The flag 'quiet' is used to quiets unwanted error messages,
for example for testcases known to fail, but this flag is reset
too late so that the beginning of the next testcases will run
with the value for the previous case.

Fix this by reseting the flag at the begining of each testcase.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+1/-1)
--------------------------------------------------------------------------------

[d1a5d1da0dd9] 2017-12-08 13:55:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add & use warning()

Allow this new helper to indicate wich file trigger the
warning and replace the existing call to 'echo "warning: ...'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+9/-1)
--------------------------------------------------------------------------------

[9b08666540f4] 2017-12-08 13:55:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: move verbose/error() before get_tag_value()

So, we can use them inside get_tag_value().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+19/-17)
--------------------------------------------------------------------------------

[2a2b2cbc3d23] 2017-12-08 13:55:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: remove old ugly pattern syntax

It was too ugly (and a bit longish).

Remove it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+0/-32)
--------------------------------------------------------------------------------

[431103167d42] 2017-12-08 13:55:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: convert to the new pattern syntax

The old one is too ugly and has to die.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/fp2i-cast.c (+1/-1)
--------------------------------------------------------------------------------

[1019e411d218] 2017-12-08 13:55:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: fix a few more incorrect check-commands

The exact syntax for commands is:
	'check-command: ' <command> <args>...
and the command itself must *not* be prefixed with './'.

Fix the last three that had it wrong.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/fp-ops.c (+1/-1), validation/option-parsing-00.c (+1/-1), validation/option-parsing-01.c (+1/-1)
--------------------------------------------------------------------------------

[97662ff3c2a1] 2017-12-08 13:55:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: make the '%.t' rule depends on PROGRAMS too

The testsuite can be run on a specific testcase directly
via the Makefile via a 'validation/%.t' pattern rule but
this rule had no dependency on the programs being tested
and thus could be run on a previous version.

Fix this by adding the needed dependencies.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[fc13b6e14e65] 2017-12-08 11:29:14 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: add missing degenerate() for logical not

Expressions involving the logical-not '!' does not
call degenerate().

Since the result type is always 'int' and thus independent
of the expression being negated, this has no effect on the
type-checking but the linearization is wrong.
For example, code like:
	int foo(void)
	{
		if (!arr) return 1;
		return 0;
	}
generates:
	foo:
		load        %r6 <- 0[arr]
		seteq.32    %r7 <- VOID, $0
		ret.32      %r7
The 'load' being obviously wrong.

Fix this by adding the missing degenerate().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-0), validation/linear/degen-log-not.c (+0/-1)
--------------------------------------------------------------------------------

[1a17b93361a9] 2017-12-07 17:44:50 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases linearization of degenerated arrays/functions

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/degen-array.c (+31/-0), validation/linear/degen-function.c (+38/-0), validation/linear/degen-log-not.c (+41/-0)
--------------------------------------------------------------------------------

[913471cdaccb] 2017-12-07 17:44:50 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add more testcases for using addresses in conditionals

and unify the existing ones.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/Waddress-array.c (+25/-0), validation/Waddress-function.c (+17/-0), validation/Waddress-weak.c (+25/-0), validation/Waddress.c (+110/-0), validation/cond-address-array.c (+0/-26), ... and 1 more
--------------------------------------------------------------------------------

[8d781d16644e] 2017-12-06 11:18:32 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: build sparse-llvm on i686s too.

In commit "f1e4ba13d (build: disable sparse-llvm on non-x86)",
we wanted to disable the build of sparse-llvm on non-x86 archs
but the pattern used also excluded machines like 'i686'.

Fix this by using the pattern 'i[3456]86' instead.

Fixes: f1e4ba13d1499407a72349b50052ae818c8d8553
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[9c188dcb35c0] 2017-11-20 11:25:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: fix: remove unneeded './' before commands

Some testcases have their command specified as './<command name>'
but the './' part is unneeded as all commands are first prefixed
with '../' before being run.

Furthermore, the presence of these './' inhibit simple
filtering of the disabled commands.

Fix this by stripping the './' where it was used.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/backend/degenerate-ptr.c (+1/-1), validation/backend/function-ptr-xtype.c (+1/-1), validation/backend/label-as-value.c (+1/-1), validation/backend/load-global.c (+1/-1), validation/backend/pointer-add.c (+1/-1), ... and 8 more
--------------------------------------------------------------------------------

[25dbd228c114] 2017-11-18 14:03:26 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support of floating-point specific arithmetic ops

Floating-point arithmetic is quite different from the
arithmetic on integers or the one of real numbers.
In particular, most transformations, simplifications that can
be done on integers are invalid when done on floats.
For example:
- associativity doesn't hold
- distributivity doesn't hold
- comparison is tricky & complex
This is because (among others things):
- limited precision, rounding everywhere
- presence of signed zeroes
- presence of infinities
- presence of NaNs (signaling or quiet)
- presence of numbers without inverse
- several kind of exceptions.

Since they don't follow the same rules as their integer
counterpart, better to give them a specific opcode
instead of having to test the type of the operands at
each manipulation.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.md (+35/-11), cse.c (+14/-0), linearize.c (+15/-4), linearize.h (+7/-0), opcode.c (+8/-0), ... and 3 more
--------------------------------------------------------------------------------

[1c182507c398] 2017-11-18 13:54:54 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix support of floating-point compare

Comparision of floating-point values can't be done
like for integral values because of the possibility to have
NaNs which can't be ordered with normal values or even between
themselves.
The real difference appears once there is any "reasoning"
done with the result of the comparison. For example, once NaNs
are taken in account: "!(a < b)" and "(a >= b)" are not the same.

In fact the usual comparison operators must be reinterpreted
as implicitely first testing if any of the operand is a Nan
and return 'false' if it is the case. Thus "a < b" becomes
"!isnan(a) && !isnan(b) && (a < b)".
If we need to negate the comparison we get "!(a < b)" which
naturally becomes "isnan(a) || isnan(b) || (a >= b)".

We thus need two sets of operators for comparison of floats:
one for the "ordered" values (only true if neither operand
is a Nan) and one for the "values" (also true if either
operand is a NaN). A negation of the comparison switch from one
of the set to the other.

So, introduce another set of instructions for the comparison
of floats.

Note: the C standard requires that:
	*) "x == x" is false if x is a NaN,
	*) "x != x" is true  if x is a NaN,
and this is coherent with "x != x" <-> "!(x == x)".

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.md (+55/-1), linearize.c (+19/-2), linearize.h (+18/-0), liveness.c (+1/-0), opcode.c (+28/-10), ... and 4 more
--------------------------------------------------------------------------------

[1fb139520881] 2017-11-18 11:37:35 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for boolean negation on float

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/bool-float.c (+9/-0)
--------------------------------------------------------------------------------

[94d286e85e8a] 2017-11-18 11:37:35 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix linearize_inc_dec() with floats

Using the pre or post increment or decrement operator on
floating-point values mix the addition of a floating-point
value with an *integral* constant 1 or -1.

Fix this by checking if we're dealing with fp or not and using
the proper fp constants (1.0 or -1.0) if it is the case.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+16/-2), validation/inc-dec-float.c (+13/-0)
--------------------------------------------------------------------------------

[c0229b5ce357] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: only compare void pointers

LLVM use a stricter type system for its IR than sparse does.
In the present case, sparse allow to compare pointers regardless
of their types.

This create LLVM errors if we try to simply translate, instruction
by instruction, sparse's compare instructions to LLVM ones.

Fix this by casting all pointers to void *, before comparing them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+4/-0)
--------------------------------------------------------------------------------

[c786446be008] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: add support for float initializer

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+3/-0)
--------------------------------------------------------------------------------

[160bc02e60d2] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: warn instead of assert on global inits

Currently, sparse-llvm can't emit the needed code for
all initializers and when it's the case it stop abruptly
with an assert(0).

This is kinda useless.

Somehow fix this by issuing a warning instead and try to
continue gracefully.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+6/-1)
--------------------------------------------------------------------------------

[8efcfb3b33c1] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: gracefully catch impossible type/value

Until now, in sparse-llvm, an assert(0) was used each time
something which was not yet handled was encountered.

This is doubly annoying because:
- the assert gave no info about the cause
- it also hide possible further issuses.

Fix this by:
- removing the asserts
- use a warnng explaining what's at hand
- try to continue with the following instructions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+9/-2)
--------------------------------------------------------------------------------

[0b37c9aa8bc7] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: give names easier to debug

LLVM automatically add an numeric suffix for names
automatically created. So, if intermediate names must
be created for a pseudo whose name was, for example, "%R4",
these new names will be "%R41", "%R42".

This is quite annoying because we can't make the distinction
between these names and the original names, (maybe of some other
pseudos whose names were "%R41" & "%R42).

Change this by adding a "." at the end of each name, as this will
then allow to see what the original name was.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+3/-3), validation/backend/call-variadic.c (+3/-3)
--------------------------------------------------------------------------------

[a410611d7af9] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix creation of sparsec's tmp files

It seems the intention was to create the tmp files with
the suffixes but the files are create without the suffixes
(while the filename that is used later is with the suffixes).

In all case the non-suffixed file that is created by the
mktemp command is never removed and after a while these
files begin to pile-up. Better to remove them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparsec (+2/-2)
--------------------------------------------------------------------------------

[44054dd8ad89] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: cleanup of output_[ptr]cast()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+12/-27)
--------------------------------------------------------------------------------

[c91ae5884b22] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: add support for cast from floats

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+9/-1), validation/backend/cast.c (+0/-2)
--------------------------------------------------------------------------------

[f80fd84cabc0] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: add support for OP_FPCAST

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+21/-1), validation/backend/cast.c (+3/-2)
--------------------------------------------------------------------------------

[c253791f87fb] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix type of bitfields

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+2/-0)
--------------------------------------------------------------------------------

[23246ed6db3c] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix get value from non-anonymous symbol

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+2/-9), validation/backend/load-global.c (+21/-0), validation/backend/string-value.c (+21/-0)
--------------------------------------------------------------------------------

[6877ef587143] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix get value from initialized symbol

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+13/-14)
--------------------------------------------------------------------------------

[1b41788fcad5] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: add support for restricted types

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+1/-0)
--------------------------------------------------------------------------------

[d7b0e39b2cfd] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix mutated OP_[PTR]CAST

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+4/-6)
--------------------------------------------------------------------------------

[40bfd90b89f5] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix mutated OP_PHISOURCE

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+1/-1)
--------------------------------------------------------------------------------

[04e01309bf81] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix mutated OP_SWITCH

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+1/-1)
--------------------------------------------------------------------------------

[060543567b80] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix mutated OP_SEL

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+3/-3)
--------------------------------------------------------------------------------

[ccce42643d82] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix mutated OP_RET

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+1/-3)
--------------------------------------------------------------------------------

[0f1700e896ed] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix mutating function pointer

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+27/-6), validation/backend/function-ptr-xtype.c (+37/-0)
--------------------------------------------------------------------------------

[880cd2465e6f] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: take care of degenerated rvalues

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+12/-2), validation/backend/degenerate-ptr.c (+0/-1), validation/backend/function-ptr.c (+0/-1), validation/backend/pointer-param.c (+0/-1), validation/backend/symaddr.c (+0/-1)
--------------------------------------------------------------------------------

[5bd565dd77ec] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix variadic calls with constants

The linearized code, sparse's IR, have no use of C's complex type
system. Those types are checked in previous phases and the pseudos
doesn't have a type directly attached to them as all the needed
typing info info are conveyed by the instructions.
In particular, PSEUDO_VAL (used for integer and address constants)
are completely typeless.

There is a problem with this when calling a variadic function
with a constant argument as in this case there is no type in the
function prototype (for the variadic part, of course) and there is
no defining instructions holding the type of the argument.

Fiw this by using the type of the arguments explicitly given
in the OP_CALL instructions.

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+5/-1), validation/backend/call-variadic.c (+0/-1)
--------------------------------------------------------------------------------

[f48b9566eba1] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: add testcase for calling variadic functions

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/backend/call-variadic.c (+28/-0)
--------------------------------------------------------------------------------

[5ee9e7bf1cb3] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: add small script to test LLVM generated bytecode

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm-dis (+15/-0), validation/test-suite (+1/-1)
--------------------------------------------------------------------------------

[410e2ee59d57] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: let pseudo_to_value() directly use the type

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+21/-21)
--------------------------------------------------------------------------------

[cec2a1d03f10] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: add test case pointer compare with cast

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/backend/pointer-cmp.c (+3/-0)
--------------------------------------------------------------------------------

[0f753a946fed] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: make value_to_ivalue() more flexible

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+10/-5), validation/backend/shift-special.c (+13/-0)
--------------------------------------------------------------------------------

[2fb8e679d470] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: make value_to_pvalue() more flexible

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+12/-3)
--------------------------------------------------------------------------------

[55144532db34] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix OP_SWITCH has no target

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+1/-3), validation/backend/switch.c (+248/-0)
--------------------------------------------------------------------------------

[c3badcbc66e9] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: add support for OP_SWITCH with a range

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+7/-10)
--------------------------------------------------------------------------------

[44b6e0af8ad2] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: give a name to all values

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+20/-13)
--------------------------------------------------------------------------------

[71ab51e282fa] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: make pseudo_name() more flexible

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+6/-11)
--------------------------------------------------------------------------------

[14359f484bb9] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix type of switch constants

In sparse-llvm, the type of switch constants are hardcoded
to 'i32'.

Fix this by using the right type as given by the instruction.

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+1/-1)
--------------------------------------------------------------------------------

[822c08b58bc6] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: variadic functions are not being marked as such

It appears that when a function is compiled, its variadic flag is not
being set in LLVM so LLVM complains when at call sites variable
arguments are passed.

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Originally-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+1/-1)
--------------------------------------------------------------------------------

[2333d1ab660f] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: adjust OP_RET's type

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+1/-0), validation/backend/pointer-sub.c (+0/-1)
--------------------------------------------------------------------------------

[2d002eb75bfb] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: give correct type to binops

Pointer arithmetic and/or simplification can mixup pointer
and integer types.

Fix this by adding casts before all non-floating point binops
and adjust the result type if needed to match the instructio.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+30/-0), validation/backend/pointer-add.c (+54/-0), validation/backend/pointer-sub.c (+18/-0), validation/backend/symaddr.c (+8/-0)
--------------------------------------------------------------------------------

[accf7112191b] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix type in comparison with an address constant

Since sparse's constant are typeless comparing a pointer with
an address constant lack correct type information.

Fix this by casting the constant to the same type as the LHS.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+1/-2), validation/backend/compare-with-null.c (+12/-0)
--------------------------------------------------------------------------------

[f8f27931b9b1] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix pointer/float mixup in comparisons

In output_op_compare() everything that is not of interger
type is treated as floats. Pointers disagree.

Fix this by rearranging the code and treat pointers like integers
as required for LLVM's icmp.

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+15/-2), validation/backend/pointer-cmp.c (+9/-0)
--------------------------------------------------------------------------------

[d9e64b95ca17] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: ignore OP_INLINED_CALL

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+0/-1)
--------------------------------------------------------------------------------

[91158ceb5f1c] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: add support for OP_SETVAL with labels

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+3/-0), validation/backend/label-as-value.c (+13/-0)
--------------------------------------------------------------------------------

[3065391a5fa4] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: add support for OP_SETVAL with floats

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+18/-1), validation/backend/setval.c (+7/-0)
--------------------------------------------------------------------------------

[21b280128510] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: add support for OP_NEG

sparse-llvm has not yet support for OP_NEG and stop on an assert
if one is encountered.

Fix this by invoking the appropriate LLVMBuild[F]Neg().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+15/-2)
--------------------------------------------------------------------------------

[17f4ee591da5] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: add test cases for degenerated pointers

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/backend/degenerate-ptr.c (+73/-0)
--------------------------------------------------------------------------------

[4bdb815f9d15] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: add test cases for arrays passed as argument

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/backend/function-ptr.c (+146/-3)
--------------------------------------------------------------------------------

[922389c710ce] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: add test cases for pointers passed as argument

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/backend/pointer-param.c (+43/-0)
--------------------------------------------------------------------------------

[b6eb6410bc6f] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: add test cases for symbol's address

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/backend/symaddr.c (+63/-0)
--------------------------------------------------------------------------------

[163f2aab9dd3] 2017-11-17 10:04:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix output_op_[ptr]cast()

OP_PTRCASTs can't always be directly translated into LLVM bitcasts and
OP_[S]CASTs can't always be translated into LLVM's trunc/sext/zext
because integer to pointer and pointer to integer must be handled too.

Fix this in output_op_ptrcast() & output_op_cast() by issuing
LLVMBuildIntToPtr/PtrToInt when appropriate.

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+35/-5)
--------------------------------------------------------------------------------

[e39241c956b8] 2017-11-17 10:04:36 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix output_op_store() which modify its operand

In sparse-llvm the field 'priv' of a pseudo is used to store
the corresponding LLVMValueRef. This field is normaly assigned
when processing the instruction that produces the speudo.

In output_op_store(), the field insn->target->priv is overwritten
by the LLVMValueRef returned by LLVMBuildStore().
It's unclear what this return value is:
- this corrupts the pseudo, making it unusable in subsequent
  instructions.
- there is no reason to change this field anyway.

Fix this by removing the assignment to insn->target->priv
in output_op_store().

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+2/-4), validation/backend/store-x2.c (+16/-0)
--------------------------------------------------------------------------------

[36fdd6e4ee4a] 2017-11-17 10:04:36 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix translation of PSEUDO_VALs into a ValueRefs

In sparse-llvm there is the assumption that a PSEUDO_VAL is always
of integer type. But this is not always the case: constant pointers,
like NULL, are also of the PSEUDO_VAL kind.

Fix this by adding a helper 'val_to_value()' and using the
instruction's type where this pseudo is used as the type of the value.

Note: while this patch improve the situation, like for example for the
test cases added here, it's still not correct because now we're making
the assumption that 'insn->type' is the type we need for the pseudo.
This is often true, but certainly not always.
For example this is not true for:
- OP_STORE/OP_LOAD's insn->src
- OP_SET{EQ,...}'s   insn->src[12]
- probably some  others ones
- in general, obviously, for any instructions where the target has
  a different type than the operands.

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+30/-1), validation/backend/constant-pointer.c (+24/-0), validation/backend/type-constant.c (+23/-0)
--------------------------------------------------------------------------------

[1b78178a9bcc] 2017-11-17 10:04:36 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix test of floating-point type

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+17/-25)
--------------------------------------------------------------------------------

[b40d36377622] 2017-11-17 10:04:36 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: extract get_sym_value() from pseudo_to_value()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+53/-47)
--------------------------------------------------------------------------------

[0b7f992f9032] 2017-11-17 10:04:36 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: avoid useless temp variable

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+2/-5)
--------------------------------------------------------------------------------

[bece687cee41] 2017-11-17 10:04:36 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: give a name to call's return values

Currently, a name is given to the result of instruction like
binops, compares, ... but not to function calls.

Functionally, it doesn't change anything but those names are
useful by easing reading while debugging, reading the generated
code, ...

Fix this by giving a name to OP_CALL's result too.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+6/-1)
--------------------------------------------------------------------------------

[cd5ff951c78b] 2017-11-17 10:04:36 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: give arguments a name

Arguments, like all LLVMValues, are given a default name
but these name are simply '%0', '%1', ... and are thus not
very readable.

Fix this by giving them an explicit name 'ARG1', ... to
match the names used in sparse's linearized code.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+12/-0)
--------------------------------------------------------------------------------

[673dd5dd0404] 2017-11-17 10:04:36 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: use pseudo_list_size() instead of open coding it

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+1/-4)
--------------------------------------------------------------------------------

[663774f1b9d6] 2017-11-17 10:04:36 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: reduce scope of 'bb_nr'

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+1/-2)
--------------------------------------------------------------------------------

[bc8e6cfa0941] 2017-11-17 10:04:36 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: remove unneeded function::type

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+3/-3)
--------------------------------------------------------------------------------

[e1a592b92dee] 2017-11-17 10:04:36 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: remove unneeded 'generation'

It's not needed here since there is no recursive access to BBs.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+2/-11)
--------------------------------------------------------------------------------

[a83534465005] 2017-11-17 10:04:36 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: remove unneeded arg 'module'

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+37/-37)
--------------------------------------------------------------------------------

[8fd641539ce4] 2017-11-17 10:04:36 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support for wider type in switch-case

Currently the different cases of a switch-statement, or more
exactly the 'struct multijmp' that hold the value of these cases
excepted only value of 'int' type. Trying to use a wider value
results in the value being truncated but any integer value should
be valid.

Fix this by unsigned 'long long' to hold these values.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+4/-4), linearize.h (+1/-1), validation/switch-long.c (+47/-0)
--------------------------------------------------------------------------------

[674b8c241569] 2017-11-17 10:04:36 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add doc about sparse's instructions/IR

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.md (+293/-0)
--------------------------------------------------------------------------------

[08890dcd7cc7] 2017-11-17 07:45:02 +0800
Author: Logan Gunthorpe <logang@deltatee.com>
Subject: add __builtin functions for isinf_sign, isfinite and isnan

These bultins are defined by in gcc since 4.4. They are also now
used by the isinf, isfinite and isnan macros. So using them with a
newer gcc causes 'undefined identifier' errors.

Add the builtin definitions and some validation checks for these
functions.

Signed-off-by: Logan Gunthorpe <logang@deltatee.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+3/-0), validation/builtin_inf.c (+3/-0)
--------------------------------------------------------------------------------

[dc8526ff0792] 2017-11-16 21:14:14 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: give a type to OP_SWITCHs

For consistency and for sparse-LLVM which needs it,
give them a type too.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+3/-2)
--------------------------------------------------------------------------------

[0e5ac8650004] 2017-11-16 21:14:14 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: give a type to OP_SELs, always

Currently, when a phi-node is converted into a OP_SEL
this instruction is given a size but not a type but when
created directly it is given a type.

For consistency and for sparse-LLVM which needs it,
give them always a type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[5b2155fd2394] 2017-11-16 21:14:14 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: give a type to OP_PHISOURCEs

Currently, OP_PHISOURCEs are given a size but not a type.

For consistency and for sparse-LLVM which need it,
give them a type too.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+1/-1), linearize.c (+7/-9), linearize.h (+1/-1), memops.c (+1/-1)
--------------------------------------------------------------------------------

[4d15929201e0] 2017-11-16 21:13:54 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: give a type to all function arguments

The linearized code, sparse's IR, have no use of C's complex type
system. Those types are checked in previous phases and the pseudos
doesn't have a type directly attached to them as all the needed
typing info info are conveyed by the instructions.
In particular, PSEUDO_VAL (used for integer and address constants)
are completely typeless.

There is a problem with this when calling a variadic function
with a constant argument as in this case there is no type in the
function prototype (for the variadic part, of course) and there is
no defining instructions holding the type of the argument.

Possible but rejected solutions are:
* give a full type to all pseudos
  This is silly as, for example 'int 0' and 'unsigned int 0'
  are, really, the same constants.
* give simply a size to all pseudos
  This seems to be simple enough but *currently* it negatively
  impacts CSE (maybe because of some others deficiencies in
  the type system, especially for casts).
* give a type to all function arguments via a new instruction
  that would mimic argument passing (OP_ARG or OP_PUSH).
  This solution is interesting, especially as it gives a placeholder
  for real argument passing at code generation time, but:
  0) they can be added, if needed, when some code generation
     will be done.
  1) it creates a superfluous instruction for every argument
     of every function call
  2) these instructions are essentially copy instructions in
     disguise.

So, since the problem only exist for constants used in variadic
arguments (and currently, it's only a problem for sparse-llvm),
the solution selected is to add to OP_CALLs a list holding the
type of all arguments. More exactly, it reuses the field .fntype
which was used to store the type of the function, and changes
it to a list holding the function type *and* the type of all
effective arguments.

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+7/-6), linearize.h (+1/-1), validation/call-variadic.c (+23/-0)
--------------------------------------------------------------------------------

[8376a70ce36e] 2017-11-16 20:37:00 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: inlined calls should not block BB packing

OP_INLINED_CALL are there only as a sort of annotation
for debugging purpose.
Their presence should thus not block the packing of
basic blocks.

Fix this by ignoring OP_INLINED_CALL when trying to pack
a basic block.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+1/-0), validation/call-inlined.c (+1/-5), validation/optim/call-inlined.c (+30/-0)
--------------------------------------------------------------------------------

[c0428dfe3164] 2017-11-16 20:37:00 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix usage of inlined calls

OP_INLINED_CALL are there only as a sort of annotation
for debugging purpose. It is thus wrong to associate
pseudo's usage to them (even if the pseudo are the arguments
of the function now inlined).

Fix this by removing the use_pseudo() for each arguments.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+1/-1), validation/call-inlined.c (+58/-0)
--------------------------------------------------------------------------------

[1bd55a66066a] 2017-11-16 20:37:00 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add is_signed_type()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: compile-i386.c (+2/-12), show-parse.c (+1/-10), symbol.h (+9/-0)
--------------------------------------------------------------------------------

[6e71cf2020ff] 2017-11-16 20:37:00 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: canonicalize compare instructions

Currently only commutative instructions are canonicalized
(the "simpler" operands, often a constant, is forced, if present
to be in the second operand). This improve CSE (more cases are
considered as equivalent) and help to reduce the number of "pattern"
to be handled at simplification.

Do this also for compare instructions since in thsi case we can
swap the order of the operands if at the same time we also swap
the 'direction' on the comparison.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: opcode.c (+10/-10), opcode.h (+1/-0), simplify.c (+16/-4), validation/optim/canonical-cmp.c (+124/-0)
--------------------------------------------------------------------------------

[4750ad6f4d4c] 2017-11-16 20:37:00 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: canonicalize binops before simplification

Currently, canonicalization of binops (more specifically
insuring that the operands of binops are in canonical order)
is only done after simplify_binop(). But the goal of
canonicalization is to limit the number of cases/patterns
we need to check/handle during ... simplification.
So canonicalization need to be done before simplification.

Fix this by moving (this part of) canonicalization before
doing simplification.

Note 1: the motivation of this patch is to prepare code for
        the canonicalization of compare instructions

Note 2: this patch allow now some simplification of ...
        the simplification code (simplify_binop()), this
	will be done in a later serie.

Note 3: this patch changes slightly the cost of the CSE/
	simplification, positively or negatively, depending
	on the ration of simplification/canonicalization
	that can be done.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+9/-11)
--------------------------------------------------------------------------------

[bf9785053a6e] 2017-11-16 20:37:00 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use opcode table for compare_opcode()

At the same time, change also the name of the function.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+1/-25)
--------------------------------------------------------------------------------

[d0d5529e95d8] 2017-11-16 20:37:00 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add table to "negate" some opcode

Some optimizations transform an instruction opcode
into another. For example, it may be needed to know
the opcode corresponding to the negation of a comparison.

This patch make this easy and flexible by adding a table
for the relation between opcodes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), linearize.h (+3/-0), opcode.c (+36/-0), opcode.h (+9/-0)
--------------------------------------------------------------------------------

[3f3a12589b20] 2017-11-16 20:36:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: don't output value of anonymous symbol's pointer

The value of this pointer is of no use unless you're
using a debugger (or just to see if two things are
identical or not) and it's presence produces noise
when comparing the output of two runs for testing.

Change this by issuing it only if 'verbose' is set.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+2/-2)
--------------------------------------------------------------------------------

[37a824078ff8] 2017-11-16 20:36:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: show OP_PHI without VOID

As the normal result of branch simplification OP_PHI
can have some VOID in their phi_list, sometimes lots of them.
These list can't be simplified, comacted or so because the
address of the pseudos is used for the pseudo tracking.
But it's annoying that these VOID are displayed by
show_instruction(), it make things sometimes hard to read.

Chnage this by ommiting to display them (when not verbose).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+2/-0)
--------------------------------------------------------------------------------

[5e733ee23392] 2017-11-13 22:20:29 +0800
Author: Christopher Li <sparse@chrisli.org>
Subject: sparse-llvm: use pseudo->size to select llvm integer type

Now constant pseudo has size saved in pseudo->size.
Use that size to select proper integer type for sparse-llvm.

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: sparse-llvm.c (+13/-8)
--------------------------------------------------------------------------------

[16d44cca4a36] 2017-11-13 17:07:48 +0800
Author: Christopher Li <sparse@chrisli.org>
Subject: Give the constant pseudo value a size

Currently value pseudo does not have size.
This create a problem pointed out by Dibyendu.
When using LLVM, calling varidic function with
constant value, there is no where to find the
size.

Linus give out two suggestions. One is give pseudo
a size. The other one is the push instruction.
This is the implemnation of the first suggestion.

The model is actual very simple. The pseudo is
exactly as before if you are not looking at the size.
There is a size at create time, which tag alone with
it.

I might not get all the type and cast of the constant
right, we can fix it later if we found some case I did
not cover.

Testign done:

- Test suite passed.
- Kernel compile get the exact same output as the RC5
  at similar time.

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Suggested-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: flow.c (+1/-1), linearize.c (+13/-10), linearize.h (+6/-2), memops.c (+1/-1), simplify.c (+10/-10)
--------------------------------------------------------------------------------

[d1748be71e0c] 2017-11-13 14:17:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'testcases-bugs', 'testcases-bugs-optim' and 'testcases-mem2reg' into tip

[Auto-summary] Adds/updates 35 test(s). Changes: +799/-0 in 35 file(s)

Files: validation/linear/builtin_unreachable.c (+31/-0), validation/linear/inline-return.c (+24/-0), validation/mem2reg/address-used00.c (+19/-0), validation/mem2reg/broken-phi02.c (+28/-0), validation/mem2reg/broken-phi03.c (+29/-0), ... and 30 more
--------------------------------------------------------------------------------

[2eb0abcbe35d] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for missing conversion to select

This may seems as an missing optimization problem but in truth,
the root cause is a problem with SSA conversion.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/missing-select.c (+24/-0)
--------------------------------------------------------------------------------

[ee0b647dcda8] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test cases for canonicalization of boolean expressions

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/bool-neq0.c (+12/-0)
--------------------------------------------------------------------------------

[6e3ab84b12b2] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for mem2reg/SSA conversion

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/mem2reg/address-used00.c (+19/-0), validation/mem2reg/broken-phi02.c (+28/-0), validation/mem2reg/broken-phi03.c (+29/-0), validation/mem2reg/cond-expr.c (+13/-0), validation/mem2reg/cond-expr5.c (+18/-0), ... and 23 more
--------------------------------------------------------------------------------

[dad2d3a77f19] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for superfluous cast with volatiles

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/cast-volatile.c (+14/-0)
--------------------------------------------------------------------------------

[fac99b8c7132] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test cases for simplification of equivalent to 'x == 0' or 'x != 0'

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/bool-eq0.c (+12/-0), validation/optim/bool-ne0.c (+12/-0)
--------------------------------------------------------------------------------

[22eaf158a163] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for return & inline

The linearization of 'return' statements must correctly take
in account some implementation details of the inlining.

As such, it deserves its own testcase.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/inline-return.c (+24/-0)
--------------------------------------------------------------------------------

[d768e0f674ed] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for pre-processor extra tokens warning

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/preprocessor/extra-token.c (+15/-0)
--------------------------------------------------------------------------------

[b3dc605badcd] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test cases for canonicalization of mul chains

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/canonical-mul.c (+24/-0)
--------------------------------------------------------------------------------

[49c9826c0fd5] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for __builtin_unreachable()

__builtin_unreachable()'s semantic has consequences on the CFG
and this should be taken in account for:
* checking for undefined variables
* checking when control reaches end of non-void function
* context checking
* ...

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/builtin_unreachable.c (+31/-0)
--------------------------------------------------------------------------------

[1dfaa8e70adb] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for compound literals

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/compound-literal00.c (+18/-0), validation/compound-literal01.c (+27/-0)
--------------------------------------------------------------------------------

[425aca24c35c] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test cases for canonicalization of add/sub chains

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/canonical-add.c (+55/-0)
--------------------------------------------------------------------------------

[4a51733e789d] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for missed overflow detection

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/overflow.c (+19/-0)
--------------------------------------------------------------------------------

[658d1ab51228] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for bad layout of bool in bitfields

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/bitfield-bool-layout.c (+26/-0)
--------------------------------------------------------------------------------

[950bebdedb12] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case using sizeof on incomplete type

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/sizeof-incomplete-type.c (+27/-0)
--------------------------------------------------------------------------------

[91c13302fff0] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case storage specifier in struct member

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/storage-struct-member.c (+20/-0)
--------------------------------------------------------------------------------

[9fdb475e7e8d] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case bitfields in K&R decl

Reported-by: Lance Richardson <lrichard@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/bitfield-kr.c (+14/-0)
--------------------------------------------------------------------------------

[f051e3418598] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for incomplete type

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/missing-return.c (+20/-0)
--------------------------------------------------------------------------------

[b3b642eb3eff] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for conditionally undefined var

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/var-undef-partial.c (+21/-0)
--------------------------------------------------------------------------------

[d3936a687de4] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for memory to register problem

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/stray-phisrc.c (+25/-0)
--------------------------------------------------------------------------------

[5dab1f97a535] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for VLA sizeof

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/vla-sizeof.c (+37/-0)
--------------------------------------------------------------------------------

[fd978b5ae72d] 2017-11-13 14:16:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for using multiple input files

GCC can be called with several input files in a single invocation
but these files are processed individually.

There is so no reasons to warn about a symbol being already defined
in a previous file.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/multi-input.c (+11/-0)
--------------------------------------------------------------------------------

[1f6cd6fe94fc] 2017-11-13 14:16:10 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'dump-ir' into tip

[Auto-summary] Modifies 4 source files: lib.c, linearize.c, test-linearize.c and 1 more. Updates header lib.h. Adds/updates 3 test(s). Updates documentation. Changes: +257/-76 in 11 file(s)

Files: Documentation/options.md (+29/-0), cgcc (+2/-1), lib.c (+185/-61), lib.h (+18/-1), linearize.c (+7/-5), ... and 6 more
--------------------------------------------------------------------------------

[555217d63d01] 2017-11-13 12:48:48 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dump-ir: activate -fdump-ir=mem2reg

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+2/-0)
--------------------------------------------------------------------------------

[ec0916182554] 2017-11-13 12:48:48 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dump-ir: make it more flexible

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/options.md (+11/-0), lib.c (+62/-8), lib.h (+1/-1), linearize.c (+1/-1), sparse.1 (+0/-6), ... and 3 more
--------------------------------------------------------------------------------

[8a1c335f1210] 2017-11-13 12:48:48 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dump-ir: rename -fdump-linearize to -fdump-ir

as it will be used for dumping the IR not only just after
linearization but after other passes too.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+1/-1), lib.c (+4/-4), lib.h (+1/-1), linearize.c (+1/-1), sparse.1 (+1/-1), ... and 3 more
--------------------------------------------------------------------------------

[383015dbad37] 2017-11-13 12:48:48 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dump-ir: saner use of fdump_linearize

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+1/-4), test-linearize.c (+2/-0), test-unssa.c (+2/-0)
--------------------------------------------------------------------------------

[b1f6b9740bd8] 2017-11-13 12:48:45 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dump-ir: allow to skip the optimization pass(es)

For experimenting with some optimization and the linearization
process, it's useful to see the raw result, without any kind
of optimization.

This patch test PASS_OPTIM (-foptim-{enable,disable}) to see
if the whole optimization process can be skipped.

Note: ideally, this should be coupled with -O0 but this
      could create problems with the 'sparse' tools when used
      on file wit an optimization level of 0 (since the sparse
      tools depends on the optimization for the context checking
      to be accurate and in general diagnostics also need
      at least basic optimization).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+2/-0)
--------------------------------------------------------------------------------

[092e22f01df4] 2017-11-12 10:11:48 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dump-ir: activate/deactive pass 'mem2reg'

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+2/-1)
--------------------------------------------------------------------------------

[a5f0d96243ac] 2017-11-12 10:11:48 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dump-ir: allow to specify the passes to execute via cli's options

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/options.md (+18/-0), cgcc (+1/-0), lib.c (+34/-0), lib.h (+1/-0)
--------------------------------------------------------------------------------

[e7a9d67e1834] 2017-11-12 10:11:48 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dump-ir: add testcase for option parsing corner case

[Auto-summary] Adds/updates 2 test(s). Changes: +10/-0 in 2 file(s)

Files: validation/option-parsing-00.c (+5/-0), validation/option-parsing-01.c (+5/-0)
--------------------------------------------------------------------------------

[5d7a65b06e8f] 2017-11-11 22:41:04 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'volatile-loads-are-side-effects', 'fix-volatile-simplification', 'struct-asm-ops', 'restricted-pointers', 'fix-f2i-casts', 'symaddr-description', 'flush-stdout' and 'diet-simple' into tip

[Auto-summary] Modifies 13 source files: allocate.c, compile-i386.c, evaluate.c and 10 more. Updates 7 headers. Adds/updates 9 test(s). Changes: +552/-193 in 30 file(s)

Files: allocate.c (+1/-1), allocate.h (+2/-1), compile-i386.c (+1/-1), evaluate.c (+35/-49), expand.c (+5/-2), ... and 25 more
--------------------------------------------------------------------------------

[9831e680492e] 2017-11-11 17:00:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: volatile stores must not be simplified

kill_dominated_stores() simplify away redundant stores.
Nice but volatile stores are never redundant and must
never be simplified away.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: memops.c (+5/-1), validation/memops-volatile.c (+0/-1)
--------------------------------------------------------------------------------

[884802fca5b5] 2017-11-11 16:58:04 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for bogus volatile simplification

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/memops-volatile.c (+6/-10)
--------------------------------------------------------------------------------

[b13979b4bca9] 2017-11-11 16:50:09 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: flush stdout when warning

This is much needed for tools like test-linearize
which output on stderr & stdout and without this patch
error messages and normal output are out-of-sync.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-0)
--------------------------------------------------------------------------------

[100a9d46320d] 2017-11-11 16:46:29 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix description setval & symaddr

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+1/-1)
--------------------------------------------------------------------------------

[9ac232c8c0d6] 2017-11-11 15:29:42 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'constexpr-shorter-name', 'testsuite-clean', 'make-cleanup', 'graph-cleanup' and 'cgcc-cleanup' into tip

[Auto-summary] Modifies graph.c. Adds/updates 27 test(s). Updates documentation. Modifies build system. Changes: +445/-347 in 33 file(s)

Files: .gitignore (+1/-2), Documentation/test-suite (+20/-13), Makefile (+163/-161), cgcc (+6/-0), graph.c (+2/-0), ... and 28 more
--------------------------------------------------------------------------------

[f531c014b215] 2017-11-11 14:16:35 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix 'simplification' of float-to-int casts

Currently, simplify_cast() don't really take floating-points
in account and happily simplify away a float-to-int cast
if both types have the same size.

Fix this by not touching such casts.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-0), validation/cast-kinds.c (+8/-4), validation/fp2i-cast.c (+30/-0)
--------------------------------------------------------------------------------

[b2c17f52baa4] 2017-11-11 12:55:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: define MOD_ACCESS for (MOD_ASSIGNED | MOD_ADDRESSABLE)

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expand.c (+1/-1), parse.c (+1/-1), symbol.h (+2/-2)
--------------------------------------------------------------------------------

[9d58bbdf7865] 2017-11-11 08:56:52 +0800
Author: Christopher Li <sparse@chrisli.org>
Subject: Makefile: provide CFLAGS for command line override.

Avoid assign to CFLAGS in Makefile.
Rename BASIC_CFLAGS to COMMON_CFLAGS.
Use PKG_CFLAGS to store external package related cflags.

V4: As point out by Luc, sparse-llvm.sc is missing the
$(LLVM_CFLAGS).

Signed-off-by: Christopher Li <sparse@chrisli.org>
Acked-by: Jeff Layton <jlayton@kernel.org>

Files: Makefile (+9/-9)
--------------------------------------------------------------------------------

[a2011cb2a0a5] 2017-11-10 18:13:08 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: volatile loads are side-effects too

Some branch simplifications are only valid if the branch is free
of side-effects. The check is done in flow.c:bb_has_side_effects()
but currently deosn't take in account the fact that a volatile load
is also a side-effect.

Fix this by adding the appropriate check.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+7/-0), validation/optim/volatile-side-effect.c (+13/-0)
--------------------------------------------------------------------------------

[b336899ff94f] 2017-11-10 10:56:53 +0100
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: Makefile: use locally built sparse in the selfcheck target

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[8f45a555d122] 2017-11-10 10:45:50 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: let -fno-strict-aliasing be a mandatory flag

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+6/-1)
--------------------------------------------------------------------------------

[89f501fcc5be] 2017-11-10 10:29:05 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: add rule to run a single test

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+2/-0)
--------------------------------------------------------------------------------

[d7b09b53a505] 2017-11-10 10:29:05 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: use a single space before assignments

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+2/-2)
--------------------------------------------------------------------------------

[49622dcf20cd] 2017-11-10 10:29:05 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: reorg & add comment

No functionnal changes here, only shuffling a few lines around,
adding separators and adding a few comments

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+9/-8)
--------------------------------------------------------------------------------

[8fe0934ad951] 2017-11-10 10:26:35 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: avoid foreach

(g)make foreach can be quite handy but it also make
Makefiles much less declarative and thus harder to read.

Avoid them by adding the few needed assignments & dependencies.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+11/-9)
--------------------------------------------------------------------------------

[081679882c3f] 2017-11-10 10:21:54 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: add *.o to clean-check pattern

.o files are also created in the validation directory
(currently only tmp.o, for sparse-llvm/sparsec testing).

Aso remove them during make clean-check.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0)
--------------------------------------------------------------------------------

[eae1d3b88df7] 2017-11-10 10:21:54 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: simplify clean pattern

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+3/-7)
--------------------------------------------------------------------------------

[211cf0e64791] 2017-11-10 10:21:54 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: simplify quiet commands

The current mechanism for the quiet commands, what's
hiding the true command and emitting instead things like:
	CC      target.o
is, IMO, somehow unneedlessly sophisticated and this doesn't help
to understand what's happening and to adapt things when needed.

Change this by using simple 'echo' commands and make's '@' to
display the short command and hiding the long one.

Warning: There is a small change in behaviour with this:
  previously, when displaying the non-quiet commands with
  'make V=1' the quiet ones were not emitted. Now, with this
  patch, the short/quiet command is emitted in both case.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+12/-13)
--------------------------------------------------------------------------------

[13ceb0dd87ff] 2017-11-10 10:21:54 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: let quiet commands use less indentation

Now it does the same as done in the kernel: 2 + 8.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+8/-8)
--------------------------------------------------------------------------------

[335a2465f0a4] 2017-11-10 10:21:54 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: remove unused QUIET_INST_SH

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+0/-1)
--------------------------------------------------------------------------------

[3b7d5e200ac6] 2017-11-10 10:21:49 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: use standard rules for install

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+14/-21)
--------------------------------------------------------------------------------

[c1cec55e8930] 2017-11-10 10:14:23 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: allow the name 'local.mk' to be configurable via the environment

So people who like this file to be a hidden one or to be an
out-of-tree file or simply who don't like the name, can choose
whatever suits them the best.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: .gitignore (+1/-0), Makefile (+2/-1)
--------------------------------------------------------------------------------

[ce9a5fe45798] 2017-11-10 10:14:23 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: use one line per item

This help to minimize merge conflicts.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+43/-8)
--------------------------------------------------------------------------------

[71a0a6da8e57] 2017-11-10 10:14:23 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: remove the dist rule since unused

The last .tar.gz was for v0.5.0 in 2014.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+0/-7)
--------------------------------------------------------------------------------

[9d3877ca5114] 2017-11-10 10:14:23 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: normalize rules

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+2/-2)
--------------------------------------------------------------------------------

[5bba026c82a5] 2017-11-10 10:14:20 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: remove rule for shared lib, it's unused

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+3/-15)
--------------------------------------------------------------------------------

[dee06ccbfd8d] 2017-11-10 10:13:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: make clean targets quieter

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+3/-2)
--------------------------------------------------------------------------------

[414c4b9becbe] 2017-11-10 10:13:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: move clean & clean-check together

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+3/-3)
--------------------------------------------------------------------------------

[20845299406b] 2017-11-10 10:13:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: remove references to unexisting pre-process.h

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: .gitignore (+0/-1), Makefile (+1/-1)
--------------------------------------------------------------------------------

[e5720a014861] 2017-11-10 10:13:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: add note about overwritable vars

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+3/-0)
--------------------------------------------------------------------------------

[5844e1713cf6] 2017-11-10 10:13:37 +0100
Author: Uwe Kleine-König <uwe@kleine-koenig.org>
Subject: build: only generate version.h when needed

This way version.h isn't generated when running $(make clean) but only
when lib.c is about to be compiled.

This simplifies packaging for Debian because the package building programs
abort when there are additional files after $(make clean).

Signed-off-by: Uwe Kleine-König <uwe@kleine-koenig.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+14/-8)
--------------------------------------------------------------------------------

[325817fe36ec] 2017-11-10 10:13:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: move tests near their use

No functional changes here, just moving things around.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+41/-38)
--------------------------------------------------------------------------------

[821a41c11dff] 2017-11-10 10:13:34 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: CHECKER_FLAGS=-Wno-vla for all targets

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-3)
--------------------------------------------------------------------------------

[6e68bf5a4716] 2017-11-10 10:12:08 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: reuse rule for ALL_OBJS

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+2/-3)
--------------------------------------------------------------------------------

[a61d5601be73] 2017-11-10 10:10:31 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: no need to use wildcards for generated dependencies

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+3/-4)
--------------------------------------------------------------------------------

[8baf95a19a0a] 2017-11-10 10:10:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: use $LIBS directly in the dependency list

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+2/-2)
--------------------------------------------------------------------------------

[f10ec90ea5bd] 2017-11-10 10:09:07 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: avoid rule-specific CFLAGS

Those are not evil but it's for consistency with the remaining.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[09a92a1c46fc] 2017-11-10 10:06:39 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: allow CFLAGS & friends from command line

This allow distros or devs to override the default CFLAGS,
CPPFLAGS, LDFLAGS, ...

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+3/-3)
--------------------------------------------------------------------------------

[348f65918f06] 2017-11-10 10:05:44 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: allow target-specific CFLAGS, CPPFLAGS, LDFLAGS & LDLIBS

This a preparatory step to allow these flags to be overriden
from the command line.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+11/-8)
--------------------------------------------------------------------------------

[82ca8bebea51] 2017-11-10 09:56:47 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: use '-ldlibs' instead of '_EXTRA_OBJS'

Some of the programs need to link with some external libraries.
For some reasons, these libraries are specified via variables named:
"<target>_EXTRA_OBJS".

Use the '-ldlibs' prefix instead to better reflect the real use.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+4/-4)
--------------------------------------------------------------------------------

[8c6b675aec6d] 2017-11-10 09:53:20 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: use '-objs' instead of '_EXTRA_DEPS'

Some programs are composed of several source files other than the
main one. These files need then to be added at linking time.
These extra file are currently specified using variables named
"<program-name>_EXTRA_DEPS" but the way these variables are used
make that they can only hold .o files (or .a ones) and are not
some kind of generic dependencie.

Make this explicit by using the suffix '-objs' instead.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+6/-6)
--------------------------------------------------------------------------------

[7316dd328344] 2017-11-10 01:44:19 +0800
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: Makefile: use locally built sparse in the selfcheck target

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Acked-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[ffe9f9fef003] 2017-11-08 21:42:55 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support for C11's _Atomic as type qualifier

This only add the parsing and checks as a type qualifier;
there is no operational semantic associated with it.

Note: this only support _Atomic as *type qualifier*, not
      as a *type specifier* (partly because there an
      ambiguity on how to parse '_Atomic' when followed
      by an open parenthesis (can be valid as qualifier
      and as specifier)).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: gdbhelpers (+3/-0), ident-list.h (+1/-1), parse.c (+13/-0), show-parse.c (+1/-0), symbol.h (+2/-1), ... and 2 more
--------------------------------------------------------------------------------

[35db0f18f815] 2017-11-08 21:41:34 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: associate MOD_RESTRICT with restrict-qualified variables

Note: there is still no semantic associated with 'restrict'
      but this is a preparatory step.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: gdbhelpers (+3/-0), parse.c (+11/-5), show-parse.c (+1/-0), symbol.h (+2/-1), validation/optim/restrict.c (+73/-0), ... and 3 more
--------------------------------------------------------------------------------

[095dc58e5cda] 2017-11-08 21:37:30 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: define MOD_QUALIFIER for (MOD_CONST | MOD_VOLATILE)

This is slightly shorter (and thus may avoid long lines) and
facilitate the introduction of MOD_RETRICT in a later patch.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-1), expand.c (+1/-1), parse.c (+1/-1), symbol.h (+3/-2)
--------------------------------------------------------------------------------

[f29a889bdf5e] 2017-11-08 21:30:43 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove redundancy in MOD_STORAGE

MOD_TOPLEVEL & MOD_INLINE are already include in MOD_STORAGE
so there is no need to repeat them in MOD_IGNORE & elsewhere
where MOD_STORAGE is used.

Change this by removing the redundant MOD_TOPLEVEL & MOD_INLINE.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-1), symbol.h (+1/-1)
--------------------------------------------------------------------------------

[69027ca89eee] 2017-11-08 21:21:50 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: reorganize the definition of the modifiers

Now they are grouped a bit more logically.

Note: MOD_ASSIGNED & MOD_ADDRESSABLE are not type modifiers
      but properties of the symbol. As such they should be
      moved to struct symbol. However, as they should be
      correctly propagated to the symbol components if any,
      better to leave them as is.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+32/-33)
--------------------------------------------------------------------------------

[1d7a1daf87bf] 2017-11-08 21:21:50 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: MOD_ACCESSED is not a type modifier ...

but is used to track which inline functions are
effectively used. So better remove it from the MOD_...
and implement the same functionality via a flag
in struct symbol.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: gdbhelpers (+0/-3), parse.c (+1/-1), show-parse.c (+0/-1), symbol.c (+2/-2), symbol.h (+2/-2)
--------------------------------------------------------------------------------

[6ff8886e898d] 2017-11-08 21:21:50 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove never-used MOD_TYPEDEF

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: gdbhelpers (+0/-3), show-parse.c (+0/-1), symbol.h (+0/-2)
--------------------------------------------------------------------------------

[937d0e545ff0] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add support for 'format -l'

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+13/-1)
--------------------------------------------------------------------------------

[9f7b44c9967d] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add support for 'format -f'

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+12/-2)
--------------------------------------------------------------------------------

[c39d6cae94f8] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: format: strip .c from default name

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+1/-1)
--------------------------------------------------------------------------------

[57c32861aa15] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: format: saner defaults handling

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+5/-10)
--------------------------------------------------------------------------------

[c8ab2db0b25f] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: make do_format() more self-contained

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+27/-3)
--------------------------------------------------------------------------------

[e6a832d72102] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: move up arg_file()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+17/-15)
--------------------------------------------------------------------------------

[8bcf416415ed] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: 'quiet' must be initialized earlier

as it can, for example, be needed via arg_file() -> error()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+1/-0)
--------------------------------------------------------------------------------

[5426e68ffd0f] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add a blank line before format

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+1/-0)
--------------------------------------------------------------------------------

[d9090f3ac39e] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: save screen real estate

Emit the short command witht he same sacing as done
in the kernel: 2 + 8.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+2/-2)
--------------------------------------------------------------------------------

[d5aa4d326b9d] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: allow arch-specific tests

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/test-suite (+5/-0), validation/test-suite (+18/-0)
--------------------------------------------------------------------------------

[893581b46dd9] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: simplify documentation

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/test-suite (+13/-13)
--------------------------------------------------------------------------------

[38bc15c1c147] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: extract disable()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+9/-2)
--------------------------------------------------------------------------------

[3004ed26358f] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: remove useless test-be.c

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-be.c (+0/-46)
--------------------------------------------------------------------------------

[f0888acf8539] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: remove useless selftest

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/testsuite-selfcheck1.c (+0/-10), validation/testsuite-selfcheck2.c (+0/-10), validation/testsuite-selfcheck3.c (+0/-10)
--------------------------------------------------------------------------------

[f021a87ecf34] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: allow --format & --single

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+2/-2)
--------------------------------------------------------------------------------

[399c438894d2] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: get options from env too

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+7/-0)
--------------------------------------------------------------------------------

[56d088ba0b47] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add support for -a|--abort

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+8/-0)
--------------------------------------------------------------------------------

[943e80b278cc] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add support for -q|--quiet

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+15/-2)
--------------------------------------------------------------------------------

[a51fc3d2d395] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: allow to parse several options

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+5/-2)
--------------------------------------------------------------------------------

[86f367f6f6ee] 2017-11-08 10:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: saner handling of 'must_fail'

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+5/-3)
--------------------------------------------------------------------------------

[c3c0e477f649] 2017-11-08 10:51:01 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: check error messages first

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+1/-1)
--------------------------------------------------------------------------------

[11f673d8c382] 2017-11-08 10:51:01 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: clearer result summary

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+9/-4)
--------------------------------------------------------------------------------

[28745e8f29ff] 2017-11-07 17:16:01 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cgcc: teach cgcc about freebsd & netbsd

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+6/-0)
--------------------------------------------------------------------------------

[4832bf4b3fd4] 2017-11-06 06:57:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'cleanup-prototype', 'cleanup-cclass' and 'testcases-return-type' into master

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+0/-2), tokenize.c (+7/-19), validation/bad-return-type.c (+19/-0), validation/incomplete-struct.c (+23/-0), validation/kill-phi-ttsbb.c (+1/-1)
--------------------------------------------------------------------------------

[c3490e701eaa] 2017-11-06 06:01:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: remove unused support for pkgconfig

Sparse being a library was installed as such and with support for
pkgconfig.

However, it seems that sparse is only used for its tools and not
as a library (at least not as an external one) and currently
doesn't offer a stable interface.

For now, remove the support for this, it will be easy enough to
restore it if there is a new need.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: .gitignore (+0/-1), Makefile (+3/-24), sparse.pc.in (+0/-9)
--------------------------------------------------------------------------------

[b6c04d581e6e] 2017-11-06 06:01:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: fix effectiveness of generated dependencies

Commit fb8734e3f "Makefile: clean up and simplify" added blindly
$(LIB_H) as dependency to all .o targets.
This completely defeat the purpose of generated dependencies.

Fix this by removing this unneeded dependency.

Fixes: fb8734e3fa18619277f54f131a9b898ce7171645
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[3ff507b6e9e6] 2017-11-06 06:01:45 +0100
Author: Uwe Kleine-König <uwe@kleine-koenig.org>
Subject: build: pass CPPFLAGS to compiler

Debian packages use CPPFLAGS to pass -D_FORTIFY_SOURCE=2 for hardening.

Originally-by: Uwe Kleine-König <uwe@kleine-koenig.org>
Reviewed-by: Josh Triplett <josh@joshtriplett.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+2/-2)
--------------------------------------------------------------------------------

[8f34ac455a04] 2017-11-06 06:01:39 +0100
Author: Uwe Kleine-König <uwe@kleine-koenig.org>
Subject: build: drop -g from LDFLAGS

-g is a compiler option that is ignored by the linker. So it should be
included in CFLAGS (it already is) but not LDFLAGS.

Signed-off-by: Uwe Kleine-König <uwe@kleine-koenig.org>
Reviewed-by: Josh Triplett <josh@joshtriplett.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+0/-1)
--------------------------------------------------------------------------------

[2de9794815b1] 2017-11-06 06:01:39 +0100
Author: Uwe Kleine-König <uwe@kleine-koenig.org>
Subject: build: drop BASIC_CFLAGS and ALL_CFLAGS

There is no good reason to not use plain CFLAGS for all usages.
This simplifies understanding the Makefile for the casual reader.

Signed-off-by: Uwe Kleine-König <uwe@kleine-koenig.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+7/-9)
--------------------------------------------------------------------------------

[d59398f12641] 2017-11-06 06:01:33 +0100
Author: Uwe Kleine-König <uwe@kleine-koenig.org>
Subject: build: put comment about local.mk to the place where it is included

Signed-off-by: Uwe Kleine-König <uwe@kleine-koenig.org>
Reviewed-by: Josh Triplett <josh@joshtriplett.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+4/-5)
--------------------------------------------------------------------------------

[9fa2857e74d0] 2017-11-05 17:40:08 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'fix-include-eval' of worktree

[Auto-summary] Modifies lib.c. Adds/updates 2 test(s). Changes: +32/-0 in 3 file(s)

Files: lib.c (+14/-0), validation/include-eval.c (+6/-0), validation/include-eval.inc (+12/-0)
--------------------------------------------------------------------------------

[295f6fa9ba94] 2017-11-05 16:40:10 +0100
Author: Uwe Kleine-König <uwe@kleine-koenig.org>
Subject: build: make PREFIX overwritable from the environment

This way I can just use

	env PREFIX=/usr make install

on the command line to install sparse into the system.

Signed-off-by: Uwe Kleine-König <uwe@kleine-koenig.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[c408da27b1a4] 2017-10-19 01:00:27 -0700
Author: Jacob Keller <jacob.e.keller@intel.com>
Subject: sparse: document that -Wbitwise is default

In commit commit 02a886bfa3d9 ("Introduce keyword driven
attribute parsing", 2007-03-08) the -Wbitwise keyword was broken and did
not actually work. Instead, bitwise checks were always enabled.

This was fixed by commit commit 0dfda0d1f0fe ("make -Wbitwise
operational again", 2017-02-18) which allowed -Wbitwise and -Wno-bitwise
to work as expected.

However, since -Wbitwise was enabled for so long, that commit changed
the default of -Wbitwise to be enabled, rather than the documented
"disabled".

Fix the documentation to match, and explain that -Wbitwise is enabled by
default and must be disabled.

Signed-off-by: Jacob Keller <jacob.e.keller@intel.com>
Acked-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: sparse.1 (+2/-2)
--------------------------------------------------------------------------------

[cc58fdcfb856] 2017-10-03 00:44:48 -0400
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix cgcc ELF version for ppc64/pcc64le

Commit e0306fe0 "cgcc: teach cgcc about ppc64[le]" add support
for PPC64 to cgcc by adding the needed options like '-m64' &
'-m{little,big}-endian' and defines likes '-D__PPC64__=1'.

In this commit the defined '-D_CALL_ELF=2' was also added
but the value of 2 is for ELF v2 ABI, normally used for ppc64le,
while the older ELF ABI, normally used for plain ppc64 should use
'-D_CALL_ELF=2'.

Fix this by using the value of 1 or 2 for '_CALL_ELF' depending
if the architecture is ppc64 or ppc64le.

Fixes: e0306fe0b725af6e2e7ff59d7f0d99c96315791a
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Tested-by: Uwe Kleine-König <uwe@kleine-koenig.org>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: cgcc (+2/-3)
--------------------------------------------------------------------------------

[4b7b6b63f606] 2017-10-03 00:40:11 -0400
Author: Uwe Kleine-König <uwe@kleine-koenig.org>
Subject: cgcc: provide __ARM_PCS_VFP for armhf

This fixes:

	$ uname -m
	armv8l
	$ env CHECK=./sparse ./cgcc -no-compile memops.c
	/usr/include/arm-linux-gnueabihf/gnu/stubs.h:7:12: error: unable to open 'gnu/stubs-soft.h'

Signed-off-by: Uwe Kleine-König <uwe@kleine-koenig.org>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: cgcc (+9/-2)
--------------------------------------------------------------------------------

[9afbd4ce7ece] 2017-10-02 23:47:50 -0400
Author: Uwe Kleine-König <uwe@kleine-koenig.org>
Subject: compile-i386: Use SPARSE_VERSION instead of __DATE__

The compile date isn't very informative for a tool, the version is what really
matters. Additionally using __DATE__ makes the build unreprodicible.

Signed-off-by: Uwe Kleine-König <uwe@kleine-koenig.org>
Acked-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: compile-i386.c (+2/-1)
--------------------------------------------------------------------------------

[57efc7462a88] 2017-10-02 23:47:03 -0400
Author: Uwe Kleine-König <uwe@kleine-koenig.org>
Subject: cgcc: teach cgcc about GNU/kFreeBSD

Signed-off-by: Uwe Kleine-König <uwe@kleine-koenig.org>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: cgcc (+3/-0)
--------------------------------------------------------------------------------

[78e2c1087c40] 2017-10-02 23:45:48 -0400
Author: Uwe Kleine-König <uwe@kleine-koenig.org>
Subject: build: remove version.h in clean target

Signed-off-by: Uwe Kleine-König <uwe@kleine-koenig.org>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[ac8071648685] 2017-09-19 08:28:19 -0400
Author: Martin Kepplinger <martink@posteo.de>
Subject: compile-i386: make use of expression_list_size()

Instead of doing it my hand, there is the expression_list_size() API we
can use here.

Signed-off-by: Martin Kepplinger <martink@posteo.de>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: compile-i386.c (+1/-5)
--------------------------------------------------------------------------------

[849b9aa8cf2a] 2017-09-19 05:11:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: graph: do not scan removed instructions

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: graph.c (+2/-0)
--------------------------------------------------------------------------------

[a92189d56fbb] 2017-09-19 05:04:57 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove prototype for unexistant examine_simple_symbol_type()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+0/-1)
--------------------------------------------------------------------------------

[46047a0706e5] 2017-09-19 05:01:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove prototype extern int is_ptr_type()

because the function was already defined as an inline function
in the same header file.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+0/-1)
--------------------------------------------------------------------------------

[1fd525bb8759] 2017-09-19 04:50:18 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cclass: cleanup

The table of charatcer classes: cclass[] used to contain information
about escaped chars but this is no more the case.

Simplify the table by merging sequence of character of same classes
and remove old comment about the escape.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: tokenize.c (+6/-18)
--------------------------------------------------------------------------------

[875ba5e5b588] 2017-09-19 04:49:41 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cclass: char is wide enough

The table for character classes is declared as 'long cclass[]'
but there is no more reasons for such a wide type, 'int', or even
'char' is enough here.

Change this to use 'char' instead of 'long'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: tokenize.c (+1/-1)
--------------------------------------------------------------------------------

[e0239026964b] 2017-09-19 04:22:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: diet: remove unused struct symbol::value

This member seemed to be used for:
- current value of an enum during parsing
- index into the virtual frame
but is currently not used and never set, it's only
displayed in compile-i386 & show_parse (as zero since never
initialized).

Remove it to make struct symbol a bit more light.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: compile-i386.c (+1/-1), show-parse.c (+1/-1), symbol.h (+0/-1)
--------------------------------------------------------------------------------

[706cde1695b0] 2017-09-18 16:01:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for bad return type

add test cases for the diagnostic of:
- void function returning an integer
- int  function returning with a bare 'return'

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/bad-return-type.c (+19/-0)
--------------------------------------------------------------------------------

[f448769d2dca] 2017-09-18 16:01:23 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for incomplete type

Add a test case for the diagnostic of returning an
incomplete type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/incomplete-struct.c (+23/-0)
--------------------------------------------------------------------------------

[c5d7212e5f33] 2017-09-18 16:01:04 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix test case kill-phi-ttsb

The function used in te test case has a return type of 'int'
but has nothing to return.

Fix this by using the correct return type: 'void'

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/kill-phi-ttsbb.c (+1/-1)
--------------------------------------------------------------------------------

[bb5c9a8d7db4] 2017-09-18 12:26:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: missing evaluate with '-include'

Symbols declared or defined in files directly or indirectly
given in the command line and thus processed via sparse()
are always automatically evaluated.
Symbols processed via sparse_initialize(), thus the predefined
ones, are not systematically evaluated, which is normaly fine
as they are just declarations and will be evaluated when needed.

However, if the command line include a file via '-include <file>',
the symbols of this file will also not be evaluated, which is still
fine as long as it's only definitions. But, in the rare and odd cases
where the file should contains a function definition, this function
will not be evaluated and it's expansion and linearization won't happen
as it should have.

Fix this by evaluating the symbols issued from sparse_intialize()
like it is done for sparse().

Reported-by: Jason A. Donenfeld <Jason@zx2c4.com>
Tested-by: Jason A. Donenfeld <Jason@zx2c4.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+14/-0), validation/include-eval.c (+0/-1)
--------------------------------------------------------------------------------

[a85f7de215fa] 2017-09-17 11:42:18 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: missing evaluate with '-include' : add testcase

Reported-by: Jason A. Donenfeld <Jason@zx2c4.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/include-eval.c (+7/-0), validation/include-eval.inc (+12/-0)
--------------------------------------------------------------------------------

[6756731e9d22] 2017-09-17 09:47:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use a specific struct for asm operands

ASM operands have the following syntax:
	[<ident>] "<constraint>" '(' <expr> ')'
For some reasons, during parsing this is stored
as a sequence of 3 expressions. This has some serious
disadvantages though:
- <ident> has not the type of an expression
- it complicates processing when compared to having a specific
  struct for it (need to loop & maintain some state).
- <ident> is optional and stored as a null pointer when not present
  which is annoying, for example, if null pointers are used internally
  in ptr-lists to mark removed pointers.

Fix this by using a specific structure to store the 3 elements
of ASM operands.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+34/-48), expand.c (+3/-0), expression.h (+7/-0), inline.c (+7/-12), linearize.c (+4/-38), ... and 2 more
--------------------------------------------------------------------------------

[2196ac9040a2] 2017-09-16 11:56:05 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: convert to the new patern syntax

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/bitfield-size.c (+3/-3), validation/kill-load.c (+1/-1), validation/kill-store.c (+1/-1), validation/optim/bool-context.c (+1/-1), validation/optim/muldiv-minus-one.c (+1/-1), ... and 3 more
--------------------------------------------------------------------------------

[b4e441675f8f] 2017-09-16 11:54:06 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: obsolete old pattern checking syntax

The old syntax is kept for now to avoid too much conflits
in pending branches.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/test-suite (+0/-4), validation/test-suite (+5/-5)
--------------------------------------------------------------------------------

[4c70989cb77c] 2017-09-16 11:54:04 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: new eq/min/max syntax for pattern checking

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/test-suite (+6/-0), validation/test-suite (+50/-0)
--------------------------------------------------------------------------------

[07aa15fec6c0] 2017-09-16 10:45:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use shorter name for constexpr tests

The name used for these tests, while very correct, are a bit
longuish. They generaly take more than one line on the screen
which is annoying when running the testsuite.

Change this by using shorter names for these tests.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/constexpr-addr-of-static-member.c (+1/-1), validation/constexpr-addr-of-static.c (+1/-1), validation/constexpr-binop.c (+1/-1), validation/constexpr-cast.c (+1/-1), validation/constexpr-compound-literal.c (+1/-1), ... and 9 more
--------------------------------------------------------------------------------

[e82ef9b84727] 2017-09-16 10:40:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: better message for pattern absence/presence

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+7/-6)
--------------------------------------------------------------------------------

[620eed0a3813] 2017-09-16 10:40:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: better message for pattern nbr checking

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+2/-1)
--------------------------------------------------------------------------------

[0ab867b7423c] 2017-09-16 10:40:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: move verbose() & error()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+17/-17)
--------------------------------------------------------------------------------

[ca83186b3bc5] 2017-09-16 10:40:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: allow to test a few cases at once

Sometimes we want to only launch a few tests, not the whole
testsuite. the 'single' option allow to test a single case
but it's too restrictive.

Changes this by allowing arbirary arguments as files to be tested.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+8/-1)
--------------------------------------------------------------------------------

[c00124017a39] 2017-09-16 10:40:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: 'echo -n' may not be interpreted as '-n'

POSIX tell that the interpretation of the '-n' is implementation
independent. So avoid it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+2/-2)
--------------------------------------------------------------------------------

[8e7c25a638aa] 2017-09-14 20:59:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dump-ir: add defines for the compilation passes

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.h (+16/-0)
--------------------------------------------------------------------------------

[fbf903ffecc0] 2017-09-14 18:30:47 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: option: handle switches by table

Currently, the parsing of options is often quite ad-hoc and thus:
- need a lot of code
- is not clear at all

Improve this by making this table driven.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+48/-43)
--------------------------------------------------------------------------------

[2412de935e06] 2017-09-14 18:30:47 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: option: constify match_option()

Until now, match_option() needed a non-const argment and returned
a non-const result. Since it is no more needed, let's use const.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+7/-7)
--------------------------------------------------------------------------------

[dd761bbd09c8] 2017-09-14 18:30:47 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: option: use OPTION_NUMERIC() for handle_switch_fmemcpy_max_count()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+5/-17), sparse.1 (+1/-1)
--------------------------------------------------------------------------------

[f28fb7268ce3] 2017-09-14 18:30:47 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: option: add support for '-<some-option>=unlimited'

For some options with a numerical value, it is sometimes desirable,
when the value is used to limits something, to easily specify we
want to remove any limits.

This patch allow to use 'unlimited' for this by interpreting it as
the maximum value.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+4/-0)
--------------------------------------------------------------------------------

[443142fb7e0f] 2017-09-14 18:27:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: option: add support for options with 'zero is infinity'

For some options with a numerical value, it is sometimes desirable,
to easily specify we want the maximum possible value.

This patch allow to interpret '=0' as meaning the maximum value.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+6/-1)
--------------------------------------------------------------------------------

[dc54f0c9a44c] 2017-09-14 18:12:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: option: extract OPTION_NUMERIC() from handle_switch_fmemcpy_max_count()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+19/-0)
--------------------------------------------------------------------------------

[64f0308da4b5] 2017-09-14 18:12:50 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: option: let handle_simple_switch() handle an array of flags

This was used to handle a single flag but we need something
more compact when we need to handle several flags.

So, adapt this helper so that it now takes an array of flags
instead of a single flag.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+18/-9)
--------------------------------------------------------------------------------

[2ee3305ea8d5] 2017-09-14 18:12:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: option: rename 'struct warning' to 'struct flag'

'struct warning' can be reused for flags other than warnings.

To avoid future confusion, rename it to something more general:
'struct flag' (which in its context, handling of compiler flags,
is clear enough).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+5/-5)
--------------------------------------------------------------------------------

[5e1d94a00cd1] 2017-09-14 18:10:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: option: add helper to parse/match command line options

The goal of this helper is:
- to avoid to have to hardoce the length od the substring
- separate the suffix/option part from the whole argument
  which help for error message.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+20/-14)
--------------------------------------------------------------------------------

[f1e4ba13d149] 2017-09-12 11:43:31 -0400
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: disable sparse-llvm on non-x86

sparse-llvm doesn't have support for targets other than
x86 or x86-64.

Disable sparse-llvm on other archs as it create problems during
build, selftest, ...

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Makefile (+4/-0)
--------------------------------------------------------------------------------

[2093505d7b70] 2017-09-12 01:16:52 -0400
Author: Martin Kepplinger <martink@posteo.de>
Subject: compile-i386.c: fix a memory leak in sort_array()

sort_array() locally allocates a list it. Let's free it before returning
in order to avoid memory to leak.

Signed-off-by: Martin Kepplinger <martink@posteo.de>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: compile-i386.c (+1/-0)
--------------------------------------------------------------------------------

[23a393b1cd48] 2017-08-31 20:38:06 -0400
Author: Al Viro <viro@ZenIV.linux.org.uk>
Subject: Sparse preprocessing bug with zero-arg variadic macros

On Thu, Aug 31, 2017 at 09:54:33PM +0100, Al Viro wrote:
> What a mess...  Note that for non-vararg it *is* the right interpretation
> (with #define A(x) [x] we will have A() interpreted as "empty token sequence
> as the only argument", not "no arguments given").  For vararg case we
> normally do not need to distinguish "not given" and "empty" - the only
> thing that cares is exactly the ,## kludge.  There with
> #define B(x,...) [x,##__VA_ARGS__]
> B(1) and B(1,) yield [1] and [1,] resp.  And for everything other than
> "just ..." we even get it right...
>
> I see what's going on there; will post a fix in a few.

Fix macro argument parsing for (...) case

Nasty corner case for the sake of ,##__VA_ARGS__ perversion - for something
like #define A(x,...) [x,##__VA_ARGS] we want A(1) to expand to [1] and
A(1,) - to [1,].  In other words, "no vararg given" and "vararg empty" are
different and need to be distinguished.  Unfortunately, in case when there
was nothing but vararg we got it wrong - #define A(...) ,##__VA_ARGS ended
up with A() interpreted as "one empty argument" (as it would in non-vararg
case) rather than "zero arguments".

Reported-by: Josh Poimboeuf <jpoimboe@redhat.com>
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: pre-process.c (+3/-1), validation/preprocessor/preprocessor23.c (+4/-0)
--------------------------------------------------------------------------------

[958c11c35d98] 2017-08-28 21:30:38 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: Merge remote-tracking branch 'luc/constexpr-v4' into master

[Auto-summary] Modifies 5 source files: builtin.c, evaluate.c, expand.c and 2 more. Updates 2 headers. Adds/updates 15 test(s). Changes: +649/-93 in 23 file(s)

Files: builtin.c (+22/-4), evaluate.c (+152/-54), expand.c (+1/-1), expression.c (+18/-30), expression.h (+66/-4), ... and 18 more
--------------------------------------------------------------------------------

[9151ef493c72] 2017-08-20 11:12:59 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: gcc attr: add nonstring warn_if_not_aligned

Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: gcc-attr-list.h (+2/-0)
--------------------------------------------------------------------------------

[720994a58105] 2017-08-17 21:33:54 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Sparse v0.5.1

Not a candidate anymore, it's the real thing!

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[f28217d3ad1b] 2017-08-17 20:40:30 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: Merge remote-tracking branch 'luc/master'

Signed-off-by: Christopher Li <sparse@chrisli.org>

--------------------------------------------------------------------------------

[889026d88d8d] 2017-08-17 11:24:59 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: Sparse 0.5.1

Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[90859bb4e3f9] 2017-08-11 18:17:41 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Bump sparse's version to -rc5

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[64c9129b5bee] 2017-08-11 16:24:13 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Remove single-store shortcut

Current sparse code doesn't handle very gracefully
code with undefined pseudos. These can occurs, of
course because the dev has not initialize them,
maybe by error, but they can also occurs when they
are only set (and used) in a single path or even worse,
hen initiializing a bitfield.

The origin of the problem is the single store shortcut
in simplify_one_symbol() which doesn't take in account
the (absence of) dominance when loads exist without
stores.

Fix this by removing this single-store shortcut and leave
all the work for the general case which handle this
situation quite well (and/but set those variables to 0).

Warning: this change impact the performance (but not too much)

Note: This patch will also avoid internal infinite loops
      occuring when processing undefined vars present
      during the SSA construction.
Note: This patch will not avoid all similar problems
      because they can also be created after the SSA
      construction, for example when processing code
      that really is unreachable (then, typically, some
      of the involved pseudos are, in fact, not defined).
      It shouldn't be a problem since the code is
      unreachable. But if we process the code anyway
      (possibly because we simply don't know that the
      code is unreachable) then we create the same situation
      with the same consequences.

Acked-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+2/-37), validation/infinite-loop0.c (+0/-1)
--------------------------------------------------------------------------------

[bc2e3dd6cd9c] 2017-08-11 10:51:12 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: Merge remote-tracking branch 'luc/remove-singlestore-shortcut'

Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Documentation/test-suite (+4/-0), flow.c (+2/-37), validation/infinite-loop0.c (+11/-0), validation/test-suite (+7/-0)
--------------------------------------------------------------------------------

[08c90b01cf00] 2017-08-10 22:46:47 -0400
Author: Randy Dunlap <rdunlap@infradead.org>
Subject: documentation: update email reference link

gmane.org was shut down for awhile, then bought by someone else,
and is now being rebuilt. Links to it are not reliable for now,
so add a link to marc.info for the same email message.

Signed-off-by: Randy Dunlap <rdunlap@infradead.org>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Documentation/sparse.txt (+1/-1)
--------------------------------------------------------------------------------

[52ac17499e48] 2017-08-10 22:46:47 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: test-inspect: Detect gtk3 then gtk2 package

This fix a bug that test-inspect crash on Ubuntu 16.04 TLS
updated vesion of gtk2. gtk3 does not seem to have this
problem. Detect and use gtk3 if exists.

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Makefile (+14/-7)
--------------------------------------------------------------------------------

[38f3ca6768df] 2017-08-10 22:46:47 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: test-inspect: handle special case iter==NULL

GtkTreeView has this special case that iter==NULL means the
root node.

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: ast-model.c (+2/-1)
--------------------------------------------------------------------------------

[817082c250a1] 2017-08-10 22:46:47 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: Documents: project ideas

Adding project ideas to improve sparse.

Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Documentation/project-ideas.md (+52/-0)
--------------------------------------------------------------------------------

[daff8f8f61ea] 2017-08-10 22:46:44 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: Adding document for sparse patch submit process

Reference to the linux kernel patches submitting process
and difference to sparse.

Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Documentation/submitting-patches.md (+21/-0)
--------------------------------------------------------------------------------

[5b247b1d091f] 2017-08-09 21:56:31 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: Adding gcc attribute noipa etc

Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: gcc-attr-list.h (+2/-0)
--------------------------------------------------------------------------------

[c3db8218a6d1] 2017-08-09 21:56:31 -0400
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: Makefile: pass -Wno-vla to sparse while checking pre-process.c

Introduce a $(CHECKER_FLAGS) variable to allow adding flags, using
target specific variable assignments, to specific $(CHECKER) command
invocations. In particular, in a new pre-process.cs target, include
'-Wno-vla' in the flags while checking pre-process.c.

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Makefile (+4/-1)
--------------------------------------------------------------------------------

[2927c4a4f9b1] 2017-08-09 21:56:31 -0400
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: lib: workaround the 'redeclared with different type' errors

The 'selfcheck' make target issues sparse errors for function symbols
'error_die' and 'die', like so:

       CHECK    lib.c
  lib.c:194:6: error: symbol 'error_die' redeclared with different type \
	(originally declared at lib.h:98) - different modifiers
  lib.c:203:6: error: symbol 'die' redeclared with different type \
	(originally declared at lib.h:94) - different modifiers

This is caused by the 'noreturn' attribute being treated similar to a
type qualifier and insisting that, not only the declaration and the
definition of the function have the 'noreturn', but that they have the
attribute in the same position.

In order to suppress the error, move the attribute(s) to the beginning
of the declaration, in the header file, and add an 'noreturn' attribute
at the beginning of the definition (in lib.c).

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+2/-0), lib.h (+7/-2)
--------------------------------------------------------------------------------

[b1bcf2a5b9f4] 2017-08-09 21:56:31 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: fix warnings report by selfcheck

Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: ast-model.c (+1/-1), ast-view.c (+2/-1), lib.h (+1/-0)
--------------------------------------------------------------------------------

[9cee3e1148da] 2017-08-09 21:56:31 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: Adding _Pragma()

This will make the selfcheck target reduce a lot of error on
test-inspect.c.  The gtk header file use _Pragma().

Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+1/-0)
--------------------------------------------------------------------------------

[1d9cfb92a7b3] 2017-08-09 21:56:31 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: Makefile: add selfcheck target

"make selfcheck" will invoke sparse to check its own source code.
It is different than the "make C=1" in linux kernel because
sparse executable need to be compiled first.

"make <filename>.sc" will invoke the sparse to check specific C source
file <filename>.c

For example: "make parse.sc"

V2:

As pointer out by Ramsay Jones, in cygwin the check need to be
invoked by cgcc to have some platform specific macro defined.

Change the checker program to control by $(CHECKER)

Add $(PROGRAM)_EXTRA_DEPS into selfcheck

Signed-off-By: Christopher Li <sparse@chrisli.org>

Files: Makefile (+12/-2)
--------------------------------------------------------------------------------

[fb8734e3fa18] 2017-08-09 21:56:31 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: Makefile: clean up and simplify

- For invoke shell command, use immediate evaluation to avoid
  invoke more than once.
- Adding header file dependency to all object files. Remove the
  hand specify header file dependency.
- Change c2xml to target specific CFLAGS, this allow c2xml using
  the common pattern rules.
- Ramsay Jones point out that LIBXML_CFLAGS need to be put into
  if HAVE_LIBXML condition. Otherwise make will spew error on
  system that does not have libxml

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-By: Christopher Li <sparse@chrisli.org>

Files: Makefile (+8/-10)
--------------------------------------------------------------------------------

[36b6ed7efeab] 2017-08-09 21:56:31 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: Add test case for the wine dead loop bug

Michael Stefaniuc report that sparse deadloop on one of the
wine source file. The minimal test case to reproduced the
deadloop has been add to validation as "kill-unreachable-phi.c".

Reported-by: Michael Stefaniuc <mstefani@mykolab.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/kill-unreachable-phi.c (+27/-0)
--------------------------------------------------------------------------------

[0ea412176283] 2017-08-09 21:55:31 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: Merge remote-tracking branch 'luc/fix-type-bad-cond-expr-v2'

Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: evaluate.c (+12/-0), expand.c (+30/-0), expression.h (+1/-0), validation/cond-err-expand.c (+27/-0)
--------------------------------------------------------------------------------

[ba961686ad20] 2017-08-09 21:55:04 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: Merge remote-tracking branch 'luc/fix-nested-pseudo-users-deletion-v5'

Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: ptrlist.c (+1/-1), ptrlist.h (+14/-1), simplify.c (+3/-2)
--------------------------------------------------------------------------------

[2943072ce2ba] 2017-08-09 21:53:58 -0400
Author: Christopher Li <sparse@chrisli.org>
Subject: Merge remote-tracking branch 'luc/fix-fuzzy-crashes-v3'

Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: cse.c (+2/-0), flow.c (+18/-20), linearize.c (+11/-6), memops.c (+2/-0), simplify.c (+9/-0), ... and 8 more
--------------------------------------------------------------------------------

[d9ff34f2e0d5] 2017-08-09 21:30:32 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add support for commands with timeout

Tests taking a huge or infinite amout of time is
a problem for the testsuite. Furthermore, it's most
often the sign of a problem somewhere.

Fix this by adding some support to use an optional
timeout for each testcase command.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/test-suite (+4/-0), validation/infinite-loop0.c (+12/-0), validation/test-suite (+7/-0)
--------------------------------------------------------------------------------

[faad58bc8499] 2017-08-08 03:46:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: mark pseudo users as deleted instead of removing them

This will fix the (rare) problems with deletion while doing
nested ptrlist walking that occurs when doing recursive
kill_instruction() - remove_usage() - kill_instruction()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+3/-2)
--------------------------------------------------------------------------------

[10686f1fe396] 2017-08-08 03:46:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: avoid iteration on NULL entries

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+4/-0)
--------------------------------------------------------------------------------

[dc41c3ea48bd] 2017-08-04 21:53:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: add MARK_CURRENT_DELETED

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+8/-0)
--------------------------------------------------------------------------------

[8f57edd01665] 2017-08-04 21:53:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: adjust ptr_list_size for the new ->rm field

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.c (+1/-1)
--------------------------------------------------------------------------------

[6a240e34b11c] 2017-08-04 21:53:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: add a counter for the number of removed elemnets

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+2/-1)
--------------------------------------------------------------------------------

[be35da05f38d] 2017-08-04 15:49:49 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: give a type to bad cond expr with known condition

Conditional expressions whose second & third operands
have non-compatible types are not conform to the C standard
and sparse emit a warning for them and return the expression
as being erroneous. In consequence, such expressions are not
given a type. This, in turn, makes that some further processing
cannot be done (correctly).

It seems that neither GCC nor clang emit a warning when
there is a type mismatch but the condition is a constant.

In the case we're interested here (the slow compilation of a file)
the operation that cannot be done is the expansion its operands.
This, in turn and among other things, makes that builtins like
__builtin_constant_p() are not evaluated with disatrous consequence
for the amount of work done in the next phases.

Fix this by giving to conditional expressions with constant
condition the same type as the operand selected by the conditional
(but keeping the warning) as GCC & clang seems to do.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+12/-0), validation/cond-err-expand.c (+27/-0)
--------------------------------------------------------------------------------

[69e12d779f77] 2017-08-04 15:49:16 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: take comma expr in account for constant value

It's often the case that we simply need the expr's truth value.

To get the value of an expression or simply if we need to know
if it's a constant value we can use some functions like
get_expression_value() or const_expression_value() depending
on the type of warning needed if the expression is not constant
(for various definition of constant).

However none of these functions take in account the fact that
a comma expression can also have a value known at compile time.

In order to not introduce unwanted change elsewheer in the code,
introduce a new function expr_truth_value() which never warn
but will return -1 if the expr have no known boolean value.

Note: the whole set of functions should be unified to take comma
      expressions in account when needed.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expand.c (+30/-0), expression.h (+1/-0)
--------------------------------------------------------------------------------

[0c4c998690e5] 2017-07-31 22:21:59 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix crash with sym->bb_target == NULL

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+4/-1), validation/crash-bb_target.c (+10/-0)
--------------------------------------------------------------------------------

[c02686f9f149] 2017-07-31 22:21:59 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix some crashes in add_dominators()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: memops.c (+2/-0), validation/crash-add-doms.c (+22/-0)
--------------------------------------------------------------------------------

[e2635465a229] 2017-07-31 22:21:59 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix crash in rewrite_branch()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+1/-1), validation/crash-rewrite-branch.c (+24/-0)
--------------------------------------------------------------------------------

[8daa5eacec82] 2017-07-31 22:21:59 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix crash when ep->active is NULL

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+7/-2), validation/crash-ep-active.c (+12/-0)
--------------------------------------------------------------------------------

[c7dd24480716] 2017-07-31 22:21:25 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix BB dependencies on phi-nodes

Simplification of BBs (via try_to_siplify_bb() or
simplify_branch_branch()) can only be done under
some conditions:
- the removed/bypassed BB is free of side-effects
- the removed/bypassed BB doesn't define some pseudos
  needed later.
This last check is efficiently done by bb_depends_on()
using liveness info. However, there is no liveness
done on OP_PHI thus the dependencies involving OP_PHI
are missing, resulting in illegal simplifications.

Fix this by explicitly adding the missing dependencies.

Supersedes: 852801f8b966407544326cd1c485f9bc7681a2e6
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+15/-16)
--------------------------------------------------------------------------------

[0900bf5f8b92] 2017-07-31 22:12:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix infinite simplification loops

Each time a parent is removed from a BB there is
the possibility that the BB become unreachable.
This in turn can create cycles of dead BBs which
can the create inifinite loops during the
simplification process.

Fix this by setting the flag REPEAT_CFG_CLEANUP when
a branch is rewritten, this will in turn trigger
a call to kill_unreachable_bbs() which will break
these loops.

Reported-by: Michael Stefaniuc <mstefani@mykolab.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+2/-1), validation/infinite-loop02.c (+11/-0), validation/infinite-loop03.c (+16/-0)
--------------------------------------------------------------------------------

[d254b816c4b6] 2017-07-31 17:25:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix ptrlist corruption while killing unreachable BBs

In commit (51cfbc90a5 "fix: kill unreachable BBs after killing a child")
kill_unreachable_bbs() was called during simplification in order
to avoid creating fake cycles between phis and issuing bogus
"crazy programmer" warnings.

However, simplification is done via cse.c:clean_up_insns()
which is looping over all BBs while kill_unreachable_bbs()
loops over all BBs *and* can delete some of them which may
corrupt the looping in clean_up_insns().

Fix this by:
1) refuse to emit the "crazy programmer" warning if there
   is a potential dead BB
2) move kill_unreachable_bbs() in the main cleanup loop
   which will avoid nested ep->bbs loop.

Note: this solution is preferable to some others because
      the "crazy programmer" condition happens very rarely.
      It this thus better to delay this check than to call
      kill_unreachable_bbs() preventively.

Note: the reproducer is one with very broken syntax but nothing
      forbid the same situation to happen with a valid program.

Fixes: 51cfbc90a5e1462fcd624a1598ecd985a508a5d6
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cse.c (+2/-0), flow.c (+0/-2), linearize.c (+0/-3), simplify.c (+9/-0), validation/crash-ptrlist.c (+23/-0), ... and 1 more
--------------------------------------------------------------------------------

[fa71b7ac0594] 2017-07-13 23:57:09 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: Adding gcc attribute no_gccisr

Signed-off-By: Christopher Li <sparse@chrisli.org>

Files: gcc-attr-list.h (+1/-0)
--------------------------------------------------------------------------------

[ec3f72e98179] 2017-07-04 08:24:40 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: bump sparse's version to 0.5.1-rc4

Signed-of-By: Christopher Li <sparse@chrisli.org>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[feff6319efa0] 2017-07-04 07:53:19 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: Add full list of gcc attribute

This will greatly reduce the "unknown attribute" warning.

Signed-off-By: Christopher Li <sparse@chrisli.org>

Files: gcc-attr-list.h (+204/-0), parse.c (+10/-104)
--------------------------------------------------------------------------------

[8ae29ee0451a] 2017-07-04 07:52:59 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: Let create_symbol check for previous same symbol

Avoid create a new one if same symbol exists.

Signed-off-By: Christopher Li <sparse@chrisli.org>

Files: parse.c (+4/-2), symbol.c (+12/-3), token.h (+1/-1), tokenize.c (+2/-2)
--------------------------------------------------------------------------------

[6f9e2fc82dc2] 2017-06-29 07:01:17 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: diet: remove unused struct symbol::arg_count

It's not used, it's never set and .. it seems has never been used.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+0/-1)
--------------------------------------------------------------------------------

[3e2d956284e2] 2017-06-29 07:01:17 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: diet: remove unused struct scope::token

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: scope.h (+0/-1)
--------------------------------------------------------------------------------

[338b94b8cd14] 2017-06-29 07:01:17 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: diet: use smaller LIST_NODE_NR (29 -> 13)

Currently the size of the array used for ptrlist is 29.
However, some inspection shows that the mean size of ptrlists
is much smaller: around 2.5 - 5 only. This means that most memory
allocated for ptrlists are never used.

Change this by changing the size to the conservative value of 13.
With this value, on some test programs, memory used for ptrlists
is only 43% - 48% smaller or 24% - 28% for the total memory.
This difference in memory consumption allow also to win some time:
5 - 7% in the conditions used for the test but YMMV.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+1/-1)
--------------------------------------------------------------------------------

[66c0f1330859] 2017-06-29 07:01:17 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use long for all mem stats

The 32bit 4G limit is not so easily reached but still
it's easy to flirt with 500M+, even with a moderatly big
program.

Avoid any possible overflow and use unsigned long as
they cost nothing here.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: allocate.c (+1/-1), allocate.h (+2/-1)
--------------------------------------------------------------------------------

[d8925f125ee8] 2017-06-23 17:13:17 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: Adding ignored attribute optimize

It was used in kvm/vmx.c

Signed-of-By: Christopher Li <sparse@chrisli.org>

Files: parse.c (+4/-2), validation/attr-optimize.c (+16/-0)
--------------------------------------------------------------------------------

[a6fbbbf01a1c] 2017-06-21 15:30:04 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bump sparse's version to -rc3

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[8ff29ae4526a] 2017-06-21 14:23:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cgcc: teach cgcc about arm

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+5/-0)
--------------------------------------------------------------------------------

[e0306fe0b725] 2017-06-21 14:23:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cgcc: teach cgcc about ppc64[le]

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+10/-0)
--------------------------------------------------------------------------------

[49d56b6969d2] 2017-06-21 14:22:35 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cgcc: teach cgcc about arm64

This is needed to use sparse on the git tree on an arm64
machine (where a bug in the __builtin_bswapXX() expansion
was discovered).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+5/-0)
--------------------------------------------------------------------------------

[7ef3df201b51] 2017-06-21 11:28:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse about __BYTE_ORDER__ & __ORDER_{BIG,LITTLE}_ENDIAN__

Some macros, structures definitions, ... are endianness specific.
This is generaly done with the help of some header files but these
headers often need information from the compiler via the macro
__BYTE_ORDER__, itself being defined to __ORDER_BIG_ENDIAN__ or
__ORDER_LITTLE_ENDIAN__.

Without these defines, sparse's pre-processor may interpret things
differently than the compiler would do which may hide errors or
warn on code that is compiled out.

Fix this by letting sparse predefine these macros like compilers do.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+6/-0), validation/endian-big.c (+3/-0), validation/endian-little.c (+3/-0)
--------------------------------------------------------------------------------

[a94597eb2852] 2017-06-21 11:28:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse about __{BIG,LITTLE}_ENDIAN__

Some macros, structures definitions, ... are endianness specific.
This is generaly done with the help of some header files but these
headers often need information from the compiler via the macros
__BIG_ENDIAN__ / __LITTLE_ENDIAN__.

Without these defines, sparse's pre-processor may interpret things
differently than the compiler would do which may hide errors or
warn on code that is compiled out.

Fix this by letting sparse predefine these macros like compilers do.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+3/-0), validation/endian-big.c (+11/-0), validation/endian-little.c (+11/-0)
--------------------------------------------------------------------------------

[398907b40bc9] 2017-06-21 11:28:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse about -m{big,little}-endian

Some macros, structures definitions, ... are endianness specific.
This is generaly done with the help of some header files but these
headers often need information from the compiler which then need
to be endian-aware.

In order to not interpret things differently than the compiler
would, sparse thus also need to be endian-aware, even more so
given that sparse must cover all archs and their variants.

Give this information to sparse with two flags:
-mbig-endian/-mlittle-endian, and by default use
the endianness of the platform used to compile sparse.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+14/-1), lib.h (+1/-0)
--------------------------------------------------------------------------------

[cd33f157c25d] 2017-06-21 11:28:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dissect: use built_in_ident() instead of MK_IDENT()

The motivation for this patch was to allow sparse to be
compiled with clang which doesn't like static initialization
of flexible array members which is used in MK_IDENT().

But also, there is no enough good justifications here for not
creating the identifiers the normal way with built_in_ident().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Oleg Nesterov <oleg@redhat.com>

Files: dissect.h (+0/-11), test-dissect.c (+3/-3)
--------------------------------------------------------------------------------

[9e34da46b99e] 2017-06-21 11:28:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: __builtin_bswap{16,32,64}() constantness

When expanding those builtins, we directly excludes a non-constant
arg (via the expression expansion cost) and the to retrieve the
value we use const_expression_value().

But const_expression_value() is to be used for expressions that
qualify as 'integer constant expression' as per the C standard.
However we want to be able to use this builtin with all integer
expressions having a known value at compile time, even those
not qualified as true 'integer constant expression'.

Fix this by using get_expression_value_silent() instead of
const_expression_value().

Note: this bug was found by testing sparse on the git tree
      on ARM64.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Christopher Li <sparse@chrisli.org>

Files: builtin.c (+3/-1), validation/builtin-bswap-constant.c (+6/-0)
--------------------------------------------------------------------------------

[657ea654866b] 2017-06-21 11:28:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add fallback for missing __builtin_bswapXX()

Older version of GCC (or clang) or some other compilers
doesn't support the __builtin_bswap{16,32,64)().

Provides a fallback for them.

Note: this patch allow the testsuite to run successfully on openbsd
      (its installed compiler is based on GCC 4.2).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+4/-3), compat/bswap.h (+54/-0)
--------------------------------------------------------------------------------

[852801f8b966] 2017-06-21 11:28:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: try_to_simplify_bb eargerness

The simplification done by try_to_simplify_bb() (essentially
trying to bypass a basic block containing a conditional branch
if the branch is controlled by an OP_PHI when the corresponding
OP_PHISRC is a constant) can only be done if some conditions
are met:
1) The basic block doesn't have some side effects (in which case
   it must not be bypassed). Checked by bb_has_side_effects().
2) There may be some pseudos defined in the basic block but no
   basic blocks may depend on them. Checked by bb_depends_on().

The second condition is efficiently checked using liveness
information. However, there is no liveness information done
for OP_PHI/OP_PHISRC. So if the basic block contains some
other OP_PHI than the controlling one, there will surely be
some other BB depending on it but this will not be reflected
in the liveness info and bb_depends_on() can then wrongly
report that no dependencies exist.

Fix this by adding an extra check, verifiying that no other
OP_PHI are defined in the BB and avoiding the simplification
otherwise.

Reported-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+27/-0), validation/crazy03.c (+33/-0)
--------------------------------------------------------------------------------

[d79853389f55] 2017-06-21 11:28:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix OP_PHI usage in try_to_simplify_bb() only when non-bogus

Currently, sparse method of conversion to SSA form, doesn't
place phi-nodes at the dominance frontier but often place them
'lower' where the corresponding 'value' is needed.
This, in itself create all sort of problems. One of these
problems is that it is then quite common for an OP_PHI
to contains less 'sources' than it has parents. This is wrong
has phi-nodes represent the 'join' a value can have from each
of the incoming paths/parents.

This situation can't be given a sensible semantic and any
attempt to try some optimization involving the phi-nodes and
their sources are bound to fail.

Temporary workaround this in try_to_simplify_bb() by simply
checking if the number of parents and the number of phi-sources
match and avoid to make this simplification if they don't.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+9/-29)
--------------------------------------------------------------------------------

[57d04233adb1] 2017-06-15 21:16:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: add missing examine in evaluate_dereference()

sparse use lazy type evaluation. This evaluation is done
via the examine_*() functions, which we must insure
to have been called when type information is needed.

However, it seems that this is not done for expressions
with multiple level of dereferencing. There is (at least)
two symptoms:
1) When the inner expression is complex and contains a
   typeof: a bogus error message is issued, either
   "error: internal error: bad type in derived(11)" or
   "error: cannot dereference this type", sometimes followed
   by another bogus "warning: unknown expression (...)".
2) This one is only visible with test-linearize but happen
   even on a plain double deref: the result of the inner
   deref is typeless.
Obviously the first symptom is a consequence of the second one.

Fix this by adding a call to examine_symbol_type() at the
beginning of evaluate_dereference().

Note: This fixes all the 17 "cannot dereference" and 19
   "internal error" present on the Linux kernel while using
   sparse on a x86-64 allyesconfig (most coming from the call
   of rcu_dereference_sched() in cpufreq_update_util()).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+2/-0), validation/badtype5.c (+18/-0), validation/linear/missing-insn-size.c (+19/-0)
--------------------------------------------------------------------------------

[bcfe020ed939] 2017-06-15 10:03:49 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support for -fmemcpy-max-count

By default, sparse will warn if memcpy() (or memset(),
copy_from_user(), copy_to_user()) is called with a very large
static byte-count.

But the limit is currently fixed at 100000, which may be fine
for some uses but not for others. For example, this value is
too low for sparse to be used on the git tree where, for example,
some array used to sort the index is cleared with memset().

Change this by making the limit configurable via a new flag:
-fmemcpy-max-count.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+1/-1), lib.c (+18/-0), lib.h (+1/-0), sparse.1 (+9/-0), sparse.c (+1/-2)
--------------------------------------------------------------------------------

[6081052837c1] 2017-06-15 10:03:49 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support for -Wmemcpy-max-count

sparse will warn if memcpy() (or memset(), copy_from_user(),
copy_to_user()) is called with a very large static byte-count.

But this warning is given unconditionaly while there are projects
where this warning may not be not desired.

Change this by making this warning conditional on a new warning
flag: -W[no-]memcpy-max-count

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+1/-1), lib.c (+2/-0), lib.h (+1/-0), sparse.1 (+8/-0), sparse.c (+2/-1)
--------------------------------------------------------------------------------

[d33fdf2c0ad3] 2017-06-15 10:03:49 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: memcpy()'s byte count is unsigned

The checker part of sparse does some checking on memcpy(),
memset(), copy_{from,to}_user() byte count and warn if the
value is known to be too large. The comparison is done with
signed numbers and it also warns if the value is negative.

However these functions take an unsigned byte count (size_t)
and so the value can't really be negative.

Additionaly, the number of bits used by sparse internally may not
be the same as the one used for the target's size_t. So sparse's
check against negative value may not be the same as checking if
the target's value would be so-large-than-the-upper-bit-is-set.

Change this by removing the test for negative values and simply
do an unsigned compare.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse.c (+3/-3)
--------------------------------------------------------------------------------

[13e3bd1f96cd] 2017-06-15 10:03:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cgcc: filter-out '-fdump-linearize[=...]'

This was forgotten when adding this option.

Reported-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+1/-0)
--------------------------------------------------------------------------------

[fbaefae6a74d] 2017-06-15 10:02:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cgcc: add missing warning names to check_only_option()

The missing ones were:
* init-cstring
* override-init-all
* sizeof-bool
* unknown-attribute

Reported-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+1/-1)
--------------------------------------------------------------------------------

[36dca0079fcd] 2017-06-15 10:02:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cgcc: alphasort warning names in check_only_option()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+1/-1)
--------------------------------------------------------------------------------

[b65e40c2e39b] 2017-06-15 10:02:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: keep the warnings table alphabetically sorted

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-1)
--------------------------------------------------------------------------------

[c794a36b3c25] 2017-06-14 05:51:21 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'quiets-bool-cast-restricted-v3', 'error-vs-warnings-v2', 'implicit-int', 'cgcc-darwin' and 'more-builtin-decls' into rc2

[Auto-summary] Modifies 15 source files: allocate.c, char.c, evaluate.c and 12 more. Updates 5 headers. Adds/updates 47 test(s). Modifies build system. Changes: +1228/-224 in 70 file(s)

Files: Makefile (+1/-0), allocate.c (+8/-0), allocate.h (+13/-0), cgcc (+3/-0), char.c (+2/-2), ... and 65 more
--------------------------------------------------------------------------------

[88c8ec845a32] 2017-06-13 13:38:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Add more declarations for more builtin functions

Those are used by GCC testsuite.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+44/-0)
--------------------------------------------------------------------------------

[cb14de58097d] 2017-06-10 16:10:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: finer control over error vs. warnings

Currently, once an error is issued, warnings are no more
issued, only others errors are.

It make sense as once an error is encountered things can
be left in an incoherent state and could cause lots of
useless warnings because of this incoherence.
However, it's also quite annoying as even unrelated warnings
are so silenced and potential bugs stay thus hidden.

Fix this by:
- use a specific flag for this: 'has_error'
- make the distinction between the current phase and some previous
  phases (but for now we only care about parsing vs evaluation)
- if an error has been issued in a previous phase (at parsing)
  warnings are suppressed for the current phase and all future
  phases
- if an error is issued in the current phase (evaluation) the
  flag is reset after each functions/symbols

For example, with this patch, a typing error in function fa()
will not suppress warnings for function fb(), while a parsing
error will still inhibit all further warnings.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-0), lib.c (+5/-2), lib.h (+4/-0)
--------------------------------------------------------------------------------

[ac0636468531] 2017-06-10 16:00:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use NULL instead of 0 in testcases.

Sparse, normally emit a warning when 0 is used when a pointer
is expected but here these warnings were not emitted because
errors occured before these warnings have been emitted and
sparse doesn't emit any warnings as soon as an error has been
encountered.

However, there is some changes coming regarding how previous
errors inhibit warnings and with these changes these warnings
"0 instead of NULL" will now be emitted.

Prevent to have to emit these warning by using NULL instead of 0,
as it should always be.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/function-redecl.c (+3/-3)
--------------------------------------------------------------------------------

[7120da3d4f04] 2017-06-08 03:38:56 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ret-void: warn for implicit type

Currently, no warning is given for symbols for which no
type is explicitely given. But for functions we received
a pointless warning like here under if the returned type
is effectively an int:
	warning: incorrect type in return expression (invalid types)
	    expected incomplete type
	    got int

Fix this by issuing the warning.
Also give an implicit type of int, as required by C89, to
avoid pointless warning about the expected incomplete type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+9/-0), validation/alias-mixed.c (+1/-1), validation/badtype2.c (+1/-0), validation/implicit-ret-type.c (+15/-0), validation/implicit-type.c (+14/-0), ... and 1 more
--------------------------------------------------------------------------------

[999b976d2c1e] 2017-06-08 02:30:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ret-void: add test case for toplevel asm

Top-level asm is parsed as a fake anonymous function.
Obviously this fake function doesn't have a return type
and this create corner cases that need special handling.

For now, just add a test case with a top-leval asm to detect
possible problems in future code changes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/asm-toplevel.c (+7/-0)
--------------------------------------------------------------------------------

[e98057421eea] 2017-05-28 22:24:17 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach cgcc about OSX aka darwin

cgcc knows about a few unix OSes but not yet about OSX/darwin.

Fix this by adding the two needed defines to cgcc's specs.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+3/-0)
--------------------------------------------------------------------------------

[3d5f3e28e7fb] 2017-05-28 21:10:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: avoid fork+execing basename

Some testcase (the ones related to sparse-llvm) are disabled if
the needed support is not present. This is done by checking
the name of the command used by the testcase.

The previous possible presence of './' before the command meant
that the command was checked via the 'basename' command, which
need to ne fork+execed.
Since the './' have now been stripped from all command names
this is no more needed.

Change this by comparing directly the command name.

This speedup the testsuite by another 6%.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+4/-3)
--------------------------------------------------------------------------------

[914904553e9b] 2017-05-28 21:10:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: remove unneeded './' before commands

Some testcase have their command specified as './<command name>'
but the './' part is unneeded as all commands are first prefixed
with '../' before being run.

Furthermore, the possible presence of these './' force the
use of 'basename' when filtering out the disabled commands.

Change this by stripping the './' where is was used.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/backend/arithmetic-ops.c (+1/-1), validation/backend/array.c (+1/-1), validation/backend/bitwise-ops.c (+1/-1), validation/backend/bool-test.c (+1/-1), validation/backend/cast.c (+1/-1), ... and 17 more
--------------------------------------------------------------------------------

[d13daddac876] 2017-05-28 21:10:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: use shell arithmetic instead of fork-execing expr

The tessuite use a few counters to keep track of things.
These counters are incremented via the 'expr' command.

But this command is not a shell builtin and need thus
to be fork+execed which need more CPU ressources than
using some builtin operation.

Change this by doing all the arithmetic via the portable
'$(( ... ))' shell builtin.

This speedup the testsuite by another 10%.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+6/-6)
--------------------------------------------------------------------------------

[cc80cf751ee2] 2017-05-28 21:10:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: grep the output patterns only when needed

For some testcase, it is checked if the output contains or not
some given pattern, or we're checking the number of time a
pattern is present in the output.
This is done with grep and some glue.

But for most testcases there is nothing to check and this
grepping is just wasted CPU cycles.

Fix this by using the already known tags to see if we need to
do this grepping or not.

This speedup the testsuite by another 15%.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+19/-14)
--------------------------------------------------------------------------------

[cb879872644a] 2017-05-28 21:10:25 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: grep the expected output only when needed

Currently the testsuite always try to extract the expected
output from the test case description.
This is done with grep & sed.

But in some case we're not interested to compare the actual
output with the expected one. And in those cases the grep & sed
are just wasted CPU cycles.

Fix this by extracting the expected output only when we know
that it won't be ignored.

This speedup the testsuite by a modest 1%.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+4/-6)
--------------------------------------------------------------------------------

[3d511f88d9d6] 2017-05-28 21:10:25 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: get all tags in once

The test cases contain annotations with the following:
	check-<tagname>[: <value>]
These are extracted with grep & sed but this is done
separately for each tags which means that we need fork+exec
two processes for each possible tags.

Change this by trying to get all the tag+value in once by storing
the result in a variables instead of doing the grep & sed thing
at each time we need to check the tag.

This speedup the testsuite by around 30% for me.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+43/-34)
--------------------------------------------------------------------------------

[88578349140a] 2017-05-19 16:11:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'dump-macros-v2', 'fix-predefined-size', 'fix-bool-context', 'fix-missing-reload', 'fix-insert-branch', 'fix-NULL-type', 'testsuite-clean', 'fix-bitfield-init-v3' and 'fdump-linearize' into tip

* fix missing reload
* fix boolean context for OP_AND_BOOL & OP_OR_BOOL
* fix bitfields implicit zero initializer.
* fix: kill old branch in insert_branch()
* returns the correct type when evaluating NULL
* use internal size for __INT_MAX__ & friends
* testsuite: cleanup result files
* add support for '-fdump-linearize[=only]'
* add support for '-fmem-report'
* add support for '-dD'

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), allocate.c (+8/-0), allocate.h (+13/-0), char.c (+2/-2), evaluate.c (+1/-1), ... and 28 more
--------------------------------------------------------------------------------

[73d53c98dea2] 2017-05-19 13:35:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: let -dD report macro definitions

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+5/-0), validation/empty-file (+0/-0), validation/preprocessor/dump-macros-empty.c (+7/-0), validation/preprocessor/dump-macros-multi.c (+7/-0), validation/preprocessor/dump-macros.c (+18/-0)
--------------------------------------------------------------------------------

[4605e11d7eed] 2017-05-19 13:35:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse how to handle -dD flag

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+16/-0), lib.h (+2/-0)
--------------------------------------------------------------------------------

[88b44ec5fb2e] 2017-05-19 13:16:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix definition of __SCHAR_MAX__ & friends

The predefined macros __SCHAR_MAX__, __SHRT_MAX__, __WCHAR_MAX__ &
__CHAR_BIT__ are defined based on the size of these types on
the machine where sparse was compiled.

But since sparse has flags like -m32/-m64 and it's not unlikely
to have one day a flag like -march=<some arch>, better to use
the used by sparse for these types as stored in 'bits_in_char',
'bits_in_short', ...

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+10/-7)
--------------------------------------------------------------------------------

[e7a977abea38] 2017-05-19 13:12:25 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: avoid to redefine __INT_MAX__ and friends

Since commit 4fae9be00 & 5466cf8f3 ("predefine __INT_MAX__ and friends" &
"predefine __SIZEOF_INT__ & friends"), macros like __INT_MAX__  and
__SIZEOF_POINTER__ are predefine twice.

Fix this by removing the old definition, based on the size of these
types on the machine where sparse was compiled.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+0/-4)
--------------------------------------------------------------------------------

[3d8f3446b66a] 2017-05-19 13:12:25 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix hardcoded size of wide chars

The size of wide chars was hardcoded to 32.

Fix this by using a variable to hold this 'bits_in_wchar',
like done for all others datatypes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: char.c (+2/-2), target.c (+2/-0), target.h (+2/-0)
--------------------------------------------------------------------------------

[9b4e30eb0baf] 2017-05-19 12:23:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse how to dump macro definitions

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.h (+1/-0), pre-process.c (+55/-0)
--------------------------------------------------------------------------------

[13c094f4f9b2] 2017-05-19 12:23:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: define ident_list

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.h (+6/-0)
--------------------------------------------------------------------------------

[4e5bb8cfb75d] 2017-05-19 06:51:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: avoid warning on explicit 'bool <- restricted' casts

Conversion to bool is special in C since this conversion
is essentially the result of the comparison with zero.
As such, some operations which are normally unsafe to
do with restricted types, like casting to an unrestricted
type, are in fact safe to do when converting to bool
and issuing a warning in those case is useless, confusing
and causes people to add useless casts in the code in
order to shut up the warning.

Fix this by catching explicit 'bool <- restricted type' casts
and not emit a warning like for others casts of restricted
type to non-restrictes ones.

Based-on-patch-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+10/-3), validation/bool-cast-bad.c (+0/-1), validation/bool-cast-explicit.c (+0/-4), validation/bool-cast-restricted.c (+11/-2)
--------------------------------------------------------------------------------

[28ba15f4e8ce] 2017-05-19 06:50:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: more tests for implicit 'bool <- restricted' casts

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/bool-cast-restricted.c (+10/-1)
--------------------------------------------------------------------------------

[08958aee2da5] 2017-05-19 05:41:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support for a new flag: -fdump-linearize[=only]

The effect of this flag is to dump the IR just after the
linearization, before any simplification, and to stop
further processing if '=only' is given as argument.

The motivation of this flag is of course for debugging,
to be able to inspect the raw result of the linearization,
undisturbed by an simplification.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+22/-0), lib.h (+1/-0), linearize.c (+6/-0), sparse.1 (+5/-0)
--------------------------------------------------------------------------------

[0e82a031bcc1] 2017-05-19 05:35:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove origval from struct access_data

In struct access_data, the field 'origval' seems to be a
leftower of some previous version and is set but never really used.

Change this by removing this field.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+0/-6)
--------------------------------------------------------------------------------

[ff3b6ef6bb18] 2017-05-19 05:35:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove alignment from struct access_data

In struct access_data, the field 'alignment' is always
the one present in 'result_type' and is thus completely
redundant.

Change this by removing this field.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+1/-2)
--------------------------------------------------------------------------------

[b1672eab399f] 2017-05-19 05:35:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix implicit zero initializer.

The C standard requires that, when initializing an aggregate, all
fieds not explicitly initialized shall be implicity zero-initialized
(more exactly "the same as objects that have static storage duration"
[6.7.9.21]).

Until now sparse didn't did this.
Fix this (when an initializer is present and the object not a scalar)
by first storing zeroes in the whole object before doing the
initialization of each fields explicitly initialized.

Note 1: this patch initialize the *whole* aggregate while the
	standard only requires that existing fields are initialized.
	Thanks to Linus to notice this.
Note 2: this implicit initialization is not needed if all fields are
        explicitly initialized but is done anyway, for the moment.
Note 3: the code simplify nicely when there is a single field that is
        initialized, much less so when there is several ones.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+15/-0), validation/linear/bitfield-init-zero.c (+102/-0), validation/linear/struct-init-full.c (+28/-0), validation/linear/struct-init-partial.c (+41/-0)
--------------------------------------------------------------------------------

[816e13f57644] 2017-05-19 05:35:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for linearize_initializer() of bitfields

In linearize_initializer(), 'ad->bit_size' & 'ad->bit_offset' were
never set, making the correct initialization impossible (a bit_size of
zero being especially bad, resulting in a mask of -1 instead of 0).

This is now fixed since 'bit_size' & 'bit_offset' are taken directly
from 'result_type'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/bitfield-init-mask.c (+27/-0)
--------------------------------------------------------------------------------

[756f80a71537] 2017-05-19 05:35:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove bit_size & bit_offset from struct access_data

In struct access_data, the fields: 'bit_offset', 'bit_size'
are always the ones corresponding to the 'result_type' and
are thus completely redundant.

Change this by removing these fields and directly using
the info from the 'result_type' field.

Note: the motivation for this change is the realization that the
      initialization of bitfields are buggy because 'bit_size'
      is never set for initializers. The bug could be solved by
      initializing 'bit_size' & 'bit_offset' but it is much
      simpler (and feel safer) to simply use the values from
      'result_type'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+8/-8)
--------------------------------------------------------------------------------

[fee3d01d7ac1] 2017-05-19 05:28:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: returns the correct type when evaluating NULL

In evaluate_cast(), the expression '(void*)<some zero constant>',
aka 'NULL', is detected and given the type 'null_ctype',
a special kind of pointer type.
However the returned type is the original one: 'void *'.

This doesn't seem to be intented as in all other cases, the
evaluate_...() functions and ultimately evaluate_expression()
always return the type of the expression.

Fix this by returning the type given to the expression: null_ctype.

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[8c24aa51b70c] 2017-05-19 05:27:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: kill old branch in insert_branch()

insert_branch() is called after an optimization has detected
an opportunity to convert a switch or a conditional branch
into an unconditional branch (for example because the condition
is a constant). It does this by removing the BB's last instruction
and then allocate a new unconditional branch which is added at
the end of the BB. The old instruction is simply discarded.
Since the discarded instruction is one with a condition we must
insure that the associated usage is also removed (for example,
by calling kill_instruction()).

But currently kill_instruction() is called, just after the call
to insert_branch(), only at a single place. The 4 other places where
insert_branch() is called do nothing with the removed instruction
and it's condition's usage. As consequence, instructions that are
dead are not removed since it still wrongly has an user.

Fix this by adding a call to kill_instruction() in insert_branch()
itself (and make the function description more exact).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+0/-1), linearize.c (+2/-1), validation/kill-insert-branch.c (+22/-0)
--------------------------------------------------------------------------------

[066530c94335] 2017-05-15 18:37:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: cleanup result files

When a test succeed, remove all temporary/result files
but leave them for failed tests.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+1/-0)
--------------------------------------------------------------------------------

[cdf306bbb0ef] 2017-05-15 18:33:58 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use -fmem-report to report allocation stats

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.h (+1/-0), sparse-llvm.c (+1/-0), sparse.1 (+5/-0), sparse.c (+2/-0), stats.c (+6/-0), ... and 2 more
--------------------------------------------------------------------------------

[85e298bdb392] 2017-05-15 18:33:11 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse how to handle '-fmem-report'

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+4/-4), lib.h (+2/-0)
--------------------------------------------------------------------------------

[9f58a4035d06] 2017-05-15 18:32:11 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add helper handle_simple_switch()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+19/-0)
--------------------------------------------------------------------------------

[8decd80927fc] 2017-05-15 18:32:11 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add show_allocation_stats()

There exist some function to display the stats from each allocator
(show_<allocator>_alloc()) but these functions need to be
called one by one and deosn't allow to make some totals.

Chnage this by adding show_allocation_stats() which display
(in a more consise way) the stats from every allocator, together
with the totals.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), allocate.h (+1/-0), stats.c (+56/-0)
--------------------------------------------------------------------------------

[863ba0586620] 2017-05-15 18:31:11 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add get_<allocator>_stats()

There exists a function to display the stats from each allocator
but:
1) what it displays is a bit long and fixed
2) it doesn't allow to make totals and stuff.

Change this by adding a function that only collect the stats
from each allocator.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: allocate.c (+8/-0), allocate.h (+12/-0)
--------------------------------------------------------------------------------

[51de1cca1bde] 2017-05-12 12:59:06 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'quiets-bool-cast-restricted-v2', 'keyword-cleanup-v2', 'not-so-crazy-v2' and 'ignore-void-if-convert-v3' into tip

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+2/-0), flow.h (+1/-0), ident-list.h (+18/-59), linearize.c (+4/-1), parse.c (+45/-1), ... and 5 more
--------------------------------------------------------------------------------

[ef822c40aaf9] 2017-05-12 12:58:08 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: keyword: no pre-declaration needed for attribute names

Currently, we have a whole bunch of attribute names whose
identifier is declared with IDENT() in "ident-list.h".

However, these names doesn't need to be so declared as their
identifier is never directly used and are otherwise dynamically
created via parse.c:keyword_table[] and init_parser().

So remove all of them from the "ident-list.h" file.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ident-list.h (+0/-56)
--------------------------------------------------------------------------------

[7308f8cb0841] 2017-05-12 12:58:08 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: keyword: add a comment about NS_TYPEDEF & reserved keywords

There is two ways a keyword can be marked as reserved:
- explicitly, by using IDENT_RESERVED() in "ident-list.h"
- implicitly, by using NS_TYPEDEF as namespace in parse.c::keyword_table

Since the implicit way is not obvious, help to make it more clear
by adding a small comment on top of keyword_table[].

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-0)
--------------------------------------------------------------------------------

[8b3644613a23] 2017-05-12 12:58:08 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: keyword: add more reserved keywords to the test case

The testsuite contains a test case checking if some reserved
keywords are indeed reserved. But this test case contains some
of the reserved keywords.

Change this by adding (most of) all reserved keywords.

Note: one of the reserved keyword not added is '__attribute__'
      because the syntax and our parsing doesn't allow us to
      properly make a test for it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/reserved.c (+135/-39)
--------------------------------------------------------------------------------

[16ae3ac5c5d0] 2017-05-12 12:58:08 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: keyword: explicitly add C99 & C11 keywords

Explicitly add the new keywords introduced by C99 & C11 to
the file "ident-list.h" and insure that they are marked as
reserved (even if not used, so we're future-ready).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ident-list.h (+8/-0), validation/reserved.c (+20/-1)
--------------------------------------------------------------------------------

[fc7e0553e19c] 2017-05-12 12:58:08 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: keyword: regroup the [reserved] keywords

The idents in "ident-list.h" are probably organized mainly
in the chronological order of their addition to the file and
as such a bit dispersed here and there.

Change this by regrouping them in Basic C/C99/C11/GCC extensions/...

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ident-list.h (+10/-4)
--------------------------------------------------------------------------------

[e072a3fd872d] 2017-05-12 12:58:08 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: keyword: add test case for reserved '_Static_assert'

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/reserved.c (+2/-0)
--------------------------------------------------------------------------------

[ce9afab361d3] 2017-05-12 12:54:38 +0200
Author: Lance Richardson <lrichard@redhat.com>
Subject: sparse: add support for _Static_assert

This patch introduces support for the C11 _Static_assert() construct.

Per the N1539 draft standard, the syntax changes for this construct
include:

    declaration:
        <declaration-specifiers> <init-declarator-list>[opt] ;
        <static_assert-declaration>

    struct-declaration:
        <specifier-qualifier-list> <struct-declarator-list>[opt] ;
        <static_assert-declaration>

    static_assert-declaration:
        _Static_assert ( <constant-expression> , <string-literal> ) ;

Signed-off-by: Lance Richardson <lrichard@redhat.com>
Signed-off-by: Chris Li <sparse@chrisli.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ident-list.h (+1/-0), parse.c (+44/-1), validation/static_assert.c (+71/-0)
--------------------------------------------------------------------------------

[cd7015c026dc] 2017-05-12 03:47:41 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix missing reload

In dominates() there is the following comment:
  "We don't think two explicitly different symbols ever alias"
but the corresponding test only check if the storage in the
potentialy dominating instruction is a symbol and if so returns 0
meaning that it can't dominate.

But that's without taking in account that a pointer can point
to this symbol and thus that a store via this symbol can dominate
a store via a pointer.

Fix this by changing the test more in accordance to the comment:
return 0 only if the 2 concerned location correspond to 2 *distinct*
symbols (and thus do not return 0 if one of the location is not a symbol).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+10/-1), validation/alias-distinct.c (+17/-0), validation/alias-mixed.c (+30/-0), validation/alias-same.c (+17/-0)
--------------------------------------------------------------------------------

[6217cd5c1300] 2017-05-12 01:36:07 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix boolean context for OP_AND_BOOL & OP_OR_BOOL

Current simplifications of 'x && 1 --> x' and its dual
'x || 0 --> x' are wrong because the '||' and '&&' operators
demand that their operands are first compared against zero
which then always give a boolean valued result.
For example: '3 && 1' is not equal to '3' but to '1' (or 'true').
The correct simplification is thus 'x && 1 --> x != 0' and
'x || 0 --> x != 0'.

Fix this by always first doing the comparison against zero
before generating the OP_AND_BOOL and OP_OR_BOOL instructions.

Note: of course, we could decide that the semantic of OP_AND_BOOL
      and OP_OR_BOOL is that these ops take care themselves of
      making a boolean context (which was, I think, why these
      ops were created) but then these simplifications cannot be
      done (or when they are done, we need to add the comparison
      against zero).

Fixes: b85ec4bb7f5b1c522d7c71782dbd9cf1c4c49b2f
Fixes: a0886db12307d2633b04ec44342099a2955794a5
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+35/-2), validation/optim/bool-context.c (+12/-0), validation/optim/bool-simplify.c (+6/-2)
--------------------------------------------------------------------------------

[3c223f5d367f] 2017-05-12 00:31:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ignore VOID when trying to if-convert phi-nodes

Simple if-then-else expressions can often be
replaced by an OP_SELECT. This is done in a very
generic way by looking not at the test/if part but
at OP_PHIs which contain exactly 2 values.

An implementation detail makes that the address
of valid OP_PHI's sources must not change, so the
list holding these values must not be repacked and such.
As consequence, when a value need to be removed from the
list this value is simply replaced in the list by a VOID.
These VOIDs must then be ignored when processing OP_PHI's
sources.
But for the if-conversion, these VOID are not ignored
and are thus considered like any other value which in turn
make miss some optimization opportunities.
For example code like:
	int foo(int a)
	{
		if (a)
			return 0;
		else
			return 1;
		return 2;
	}

will be linearized into something like:
	...
	phi.32      %r2 <- %phi1, %phi2, VOID
	ret.32      %r2
where %phi1 & %phi2 correspond to the 'return 0' & 'return 1'
and the VOID correspond to the dead 'return 2'.
This code should be trivially be converted to a select
but is not because the OP_PHI is considered as having 3
elements instead of 2.

Worse, if at some moment we would have a phi list with:
	phi.32      %r2 <- %phi1, VOID
then the optimization would trigger but the corresponding
code make the assumption that the pseudos are the target
of an OP_PHISOURCE instruction, which VOIDs, of course,
are not and a crash should ensue.

Fix this by filtering out these VOIDs before checking the
conditions of the if-conversion.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+35/-6), validation/optim/void-if-convert.c (+19/-0)
--------------------------------------------------------------------------------

[51cfbc90a5e1] 2017-05-12 00:22:05 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: kill unreachable BBs after killing a child

When simplifying a switch into a simple branch all the now
unused children of the current BB must be removed.
If one of these children become now orphaned, it is directly
killed (it will need to be killed soon or later since it is
unreachable).

However, if one of the killed children is the header of a loop
where some variables are updated this may cause problems.
Indeed, by killing the header (which contains the phisrc of
the entry value of the variable) the whole loop may become
unreachable but is not killed yet, OTOH simplification of
the associated OP_PHI may create a cycle which may then be
detected later by simplify_one_memop() which will issue a
"crazy programmer" warning while the programmer was innocent.

This situation can be seen in code like:
	int *p;
	switch (i - i) {	// will be optimized to 0
	case 0:			// will be the simple branch
		return 0;
	case 1:			// will be optimized away
		p = ptr;
		do {		// will be an unreachable loop
			*p++ = 123;
		} while (--i);
	}

Fix this by calling kill_unreachable_bbs() after having
simplified the switch into a branch. This will avoid to
create a cycle with because of the removed phisrc in the
header and as an added benefit will avoid to waste time
trying to simplify BBs that are unreachable.

In addition, it's now useless to call kill_bb() for each
removed switch's children as kill_unreachable_bbs() will
do that too.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+4/-1), validation/crazy02-not-so.c (+22/-0)
--------------------------------------------------------------------------------

[7c40199410fa] 2017-05-12 00:22:04 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: let kill_unreachable_bbs() clear REPEAT_CFG_CLEANUP

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+2/-0)
--------------------------------------------------------------------------------

[917d37ad7681] 2017-05-12 00:22:04 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: introduce REPEAT_CFG_CLEANUP

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.h (+1/-0)
--------------------------------------------------------------------------------

[a6aaa59cec44] 2017-05-11 22:11:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: avoid useless warning for 'bool <- restricted type' conversion

Conversion to bool is special in C since this conversion
is essentially the result of the comparison with zero.
As such, some operations which are normally unsafe to
do with restricted types, like casting to an unrestricted
type, are in fact safe to do when converting to bool
and issuing a warning in those case is useless, confusing
and causes people to add useless casts in the code in
order to shut up the warning.

Fix this by catching such 'bool <- restricted type' conversion
and avoid such warnings.

CC: Al Viro <viro@zeniv.linux.org.uk>
Originally-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+6/-0), validation/bool-cast-bad.c (+0/-3), validation/bool-cast-implicit.c (+0/-3), validation/bool-cast-restricted.c (+25/-0)
--------------------------------------------------------------------------------

[e35efe330c6a] 2017-04-30 02:08:54 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'sent/float-expand-v2', 'sent/fix-kill-ttsb-v2', 'sent/fix-cond-address' and 'careful-concat-user-list' into tip

[Auto-summary] Modifies 4 source files: evaluate.c, flow.c, lib.c and 1 more. Updates 2 headers. Adds/updates 4 test(s). Changes: +156/-5 in 10 file(s)

Files: evaluate.c (+8/-1), flow.c (+31/-2), lib.c (+2/-0), lib.h (+1/-0), linearize.c (+2/-0), ... and 5 more
--------------------------------------------------------------------------------

[9096335b553d] 2017-04-30 01:48:39 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: be more careful with concat_user_list()

In convert_instruction_target(), once all users have been converted
the old user list is concatened to the one of the replacing pseudo.
But this pseudo may be one for which a user list is meaningless,
like PSEUDO_VAL.

While as such it's not a problem, it inhibit the reuse of the users
pointer for other uses.

Fix this by doing the concatenation only if the pseudo can have
an use-list.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+2/-1)
--------------------------------------------------------------------------------

[7a0eaa532f28] 2017-04-01 11:59:16 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix OP_PHI usage in try_to_simplify_bb(), correctly

Patch 11b1a83b1 solved an issue with dangling PSEUDO_PHI
by killing it's use after a branch rewrite.

However, the change didn't took in account the fact that,
even after the branch rewrite, some other paths may exist
where this pseudo was needed.

Fix this by cheking that no such path exist before killing
the (usage of the) pseudo.

Fixes: 11b1a83b1 "fix OP_PHI usage in try_to_simplify_bb()"
Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+29/-1), validation/kill-phi-ttsbb2.c (+40/-0)
--------------------------------------------------------------------------------

[14964df53732] 2017-03-31 13:14:17 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: avoid crash with test-linearize -vv

When verbose is set to 2 or higher, show_instruction()
also display removed instructions. Some of these instructions
can have their associated symbol removed and set to NULL
which will cause a crash with 'test-linearize -vv'.

Fix this by avoiding to dereference symbol's details of
removed instructions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: linearize.c (+2/-0)
--------------------------------------------------------------------------------

[4d963a28d371] 2017-03-31 03:23:38 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: constexpr: flag __builtin_bswap() as constexpr

__builtin_bswap() is used in the kernel in situations like:
	switch (protocol) {
	case htons(ETH_P_IP):
		break;
	}
which requires that the constant is effectively an integer constant,
not an integer constant expression.

Since this builtin, like the others, are not defined by the standard,
let's relax the diagnostic and flag them as integer constant if its
argument is also a constant (simple integer or an expression).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+17/-0), validation/constexpr-pure-builtin.c (+23/-0)
--------------------------------------------------------------------------------

[ad10d3786169] 2017-03-31 03:15:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: give default return type in evaluate_call()

Evaluating the return type of a function is a bit complicated.
For user-defined functions this is done inside evaluate_call()
but for builtin function which have an ->evaluate() method it's
this method that must set it. That's quite easy if the return
type is fixed, like 'int' for example, but less so for genearic
functions or when we simply want to keep the given by the
prototype.

To make things more easy for the last case, set by default
the return type as given by the corresponding symbol (the
prototype thus) *before* calling the evaluate method.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[3cf996e84799] 2017-03-31 02:32:59 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: return an error if too few args

In evaluate_call(), argumenst are evaluated an a diagnostic
is emitted if the number of args is not what is expected.

Good.
However, the processing continues nevertheless.
If too much args were given, this doesn't matter much
but if too few are given we need to check a bit everywhere
for possible NULL args.

Avoid this by returning early an error if there was too few
arguments.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+3/-1)
--------------------------------------------------------------------------------

[826ff0b7e91d] 2017-03-31 02:27:12 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: treat comparisons between types as integer constexpr

The expression parsing code builds an EXPR_COMPARE expression around two
EXPR_TYPE expressions for __builtin_types_compatible_p().

The EXPR_TYPE expressions are tagged as being integer constant expressions
in order to trick the generic comparison evaluation code into flagging the
result as an integer constant expression again.

Avoid this trickery by making evaluate_compare() unconditionally tag a
comparison between types as an integer constant expression.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+9/-4), expression.c (+0/-3), validation/constexpr-types-compatible-p.c (+8/-0)
--------------------------------------------------------------------------------

[b59499db2f1d] 2017-03-31 02:27:12 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: support compound literals as address constants

Toplevel compound literals have got static storage duration
[6.5.2.5(6)].

This implies that
1. their addresses are address constants [6.6(9)] and
2. their initializers must contain constant expressions only
   [6.5.2.5(3), 6.7.8(4)] .

Flag the anonymous symbol created at expression parsing time as having
static storage duration if the compound literal occurs at top level
scope.

Flag the whole expression as being an address constant at evaluation
time if its corresponding anonymous symbol had been previously marked
as having static storage duration.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+2/-0), expression.c (+2/-0), validation/constexpr-compound-literal.c (+19/-0)
--------------------------------------------------------------------------------

[56eeb8871577] 2017-03-31 02:27:12 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: relax some constant expression rules for pointer expressions

The official constraints on constant expressions [6.6] are insanely
strict in that they do not allow some constructs commonly used in the
wild.

Relax them by treating
- address constants cast to different pointer type as address constants
  again,
- address constants cast to arithmetic type as arithmetic constant
  expressions
- conditional expressions whose true and false branches both yield
  address constants as address constants,
- and conditional expressions whose condition is an address constant
  as an constant expression to the extent their true and false branches
  allow.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+27/-2)
--------------------------------------------------------------------------------

[81b640bfe151] 2017-03-31 02:27:12 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: flag builtins constant_p, safe_p and warning as constexprs

Unconditionally flag the expressions
  __builtin_constant_p(),
  __builtin_safe_p(),
  __builtin_warning()
as being integer constant expressions.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+5/-4)
--------------------------------------------------------------------------------

[6ccf80b075d0] 2017-03-31 02:27:12 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: examine constness of __builtin_offsetof at evaluation only

Currently, the determination of a __builtin_offsetof() expressions'
constness flags is done in two steps:
- Several flags are speculatively set at expression parsing time
- and possibly cleared again at evaluation if the member expression
  includes a non-const array index like in
    __builtin_offsetof(struct A, a.b[non_const_foo])

For consistency with other expression types' evaluation, defer the
determination of a __builtin_offsetof() expression's constness to
evaluation time, too.

Furthermore, carry an array index expression's constness flags
through the implicit cast to size_t type.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+6/-2), expression.c (+0/-3), validation/constexpr-offsetof.c (+21/-0)
--------------------------------------------------------------------------------

[722199c0867a] 2017-03-31 02:27:12 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: recognize references to labels as address constants

As an extension, GCC allows labels to be referenced a la
  label1:
  ...

  void *ptr = &&label1;

Tag these label references as being address constants allowing them
to be used as initializers for objects of static storage duration.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expression.c (+1/-0), validation/constexpr-labelref.c (+14/-0)
--------------------------------------------------------------------------------

[a39fedb0d7bf] 2017-03-31 02:27:12 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: recognize string literals as address constants

Introduce support for recognizing string literals as address constants.

Make evaluate_string() unconditionally tag the *-preop wrapped symbol
expression as being an address constant.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-0), validation/constexpr-string.c (+9/-0)
--------------------------------------------------------------------------------

[fa1c8068099c] 2017-03-31 02:27:12 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: recognize members of static compound objects as address constants

According to 6.6(9), the member access operators "." and "->" may be used
in the creation of address constants.

Uses of both operators amount to the creation of EXPR_DEREF expressions
which are eventually fed into evaluate_offset() at evaluation.

Make evaluate_offset() propagate any address constant flag of the object
containing the referenced member to the newly created pointer addition
expression.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+6/-0), validation/constexpr-addr-of-static-member.c (+26/-0)
--------------------------------------------------------------------------------

[950dd57c4e43] 2017-03-31 02:27:12 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: recognize address constants created through pointer arithmetic

An address constant +/- an integer constant expression qualifies as an
address constant again.
Furthermore, the array-subscript operator "[]" may be used in the creation
of address constant.

Handle both cases by making evaluate_ptr_add() check whether an integer
constant expression is added to an address constant and tag the result as
being an address constant again if so.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+7/-0), validation/constexpr-pointer-arith.c (+28/-0)
--------------------------------------------------------------------------------

[f2c8ea249e59] 2017-03-31 02:27:12 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: recognize address constants created through casts

According to 6.6(9), an address constant may get created by casting
an integer constant to pointer type.

Make evaluate_cast() handle this case, that is tag a cast expression
as being an address constant if the target is a integer constant and
the destination is of pointer type.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+7/-0), validation/constexpr-pointer-cast.c (+13/-0)
--------------------------------------------------------------------------------

[8880427d5596] 2017-03-31 02:27:12 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: recognize static objects as address constants

Introduce support for recognizing address constants created either
- explicitly by referencing a static storage duration object by means
  of the unary & operator,
- implicitly by the use of an expression of array or function type.

Initially tag an expression as being an address constant at the primary
expression level, i.e. upon encountering a symbol designating an object of
static storage duration in primary_expression().

Carry the address constant flag over to the *-preop wrapped expression
created by evaluate_symbol_expression().

When dereferencing such a *-preop wrapped expression, make
evaluate_addressof() keep any address constant flag for the unwrapped
expression.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+2/-1), expression.c (+8/-0), validation/constexpr-addr-of-static.c (+36/-0)
--------------------------------------------------------------------------------

[080bef90f575] 2017-03-31 02:27:12 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: check static storage duration objects' intializers' constness

Initializers of static storage duration objects shall be constant
expressions [6.7.8(4)].

Warn if that requirement is not met and the -Wstatic-initializer-not-const
flag has been given on sparse's command line.

Identify static storage duration objects by having either of
MOD_TOPLEVEL or MOD_STATIC set.

Check an initializer's constness at the lowest possible subobject
level, i.e. at the level of the "assignment-expression" production
in [6.7.8].

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+10/-0), lib.c (+2/-0), lib.h (+1/-0), sparse.1 (+9/-0), validation/constexpr-init.c (+60/-0)
--------------------------------------------------------------------------------

[6cdbfb0b6778] 2017-03-31 02:27:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: constexpr: collect storage modifiers of initializers

This is a preparatory step for checking the constness
of initializers of static storage duration objects;

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+7/-6)
--------------------------------------------------------------------------------

[e9b6fdfda435] 2017-03-31 02:27:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: constexpr: rename handle_simple_initializer() to handle_initializer()

This function, with a quite long name, not only handle
simple initializer but also complex ones.

So, rename it to the shorter and more correct form.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+4/-4)
--------------------------------------------------------------------------------

[5aece3c39ccd] 2017-03-31 02:26:36 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: add support for tagging address constants

Address constants [6.6(9)] constitute one of the types of constant
expressions allowed in initializers [6.6(7)] for static storage
duration objects [6.7.8(4)].

Introduce a new flag for tagging expressions which qualify as
being an address constant.

Make sure not to carry over the address constant attribute from
subexpressions for operators that never yield address constants,
i.e.  most arithmetic ones, logical ones etc.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+18/-1), expression.h (+2/-0)
--------------------------------------------------------------------------------

[23a85c504dcf] 2017-03-31 02:19:28 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: add support for tagging arithmetic constant expressions

Arithmetic constant expressions may be either of (6.6(8)):
- integer constant expressions
- floating point constants
or any arithmetic expression build up from them.
Furthermore, casts with arithmetic destination types preserve
arithmetic constness.

Arithmetic constant expressions may be used as initializers for
objects of static storage duration.

Introduce a new constexpr flag : CEF_ACE.

Modify CEF_SET_ICE and CEF_SET_FLOAT to also include that new bit.
Thus, whenever an integer constant expression or a floating point
constant is recognized, it is automatically tagged as an arithmetic
constant expression.

Note that everything has already been set up such that the new flag
propagates nicely from subexpressions to parent expressions at evaluation.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expression.h (+12/-10)
--------------------------------------------------------------------------------

[c352b0d872b5] 2017-03-31 02:14:10 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: examine constness of conditionals at evaluation only

Move the whole calculation of conditional expressions' constness flags
to the evaluation phase such that expressions like

  0 ? __builtin_choose_expr(0, 0, 0) : 0
  0 ? 0 : __builtin_choose_expr(0, 0, 0)

can now be recognized as qualifying as integer constant expressions.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+2/-6), expression.c (+0/-6), validation/constexpr-conditional.c (+34/-0)
--------------------------------------------------------------------------------

[ccd9e3b5c6ab] 2017-03-31 02:14:10 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: examine constness of preops at evaluation only

Move the whole calculation of prefix expressions' constness flags to
the evaluation phase such that expressions like

  -__builtin_choose_expr(0, 0, 0)
  ~__builtin_choose_expr(0, 0, 0)
  !__builtin_choose_expr(0, 0, 0)

can now be recognized as qualifying as integer constant expressions.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+4/-4), expression.c (+0/-3), validation/constexpr-preop.c (+29/-0)
--------------------------------------------------------------------------------

[4a99724da62b] 2017-03-31 02:14:10 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: examine constness of binops and alike at evaluation only

Move the whole calculation of binary operations', compare and logical
expressions' constness flags to the evaluation phase such that expressions
like

  0 + __builtin_choose_expr(0, 0, 0)
  0 < __builtin_choose_expr(0, 0, 0)
  0 && __builtin_choose_expr(0, 0, 0)

can now be recognized as qualifying as integer constant expressions.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+6/-13), expression.c (+0/-3), validation/constexpr-binop.c (+33/-0)
--------------------------------------------------------------------------------

[1b62f0f61f38] 2017-03-31 02:14:10 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: examine constness of casts at evaluation only

Move the whole calculation of cast expressions' constness flags to the
evaluation phase such that expressions like

  (int)__builtin_choose_expr(0, 0, 0)

can now be recognized as qualifying as integer constant expressions.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+29/-8), expression.c (+0/-19), expression.h (+7/-0), validation/constexpr-cast.c (+25/-0)
--------------------------------------------------------------------------------

[2919ca4cd57c] 2017-03-31 02:13:57 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: init flags at expression allocation

Currently, the expression evaluation code explicitly opts out from
constness at evaluation if certain criteria regarding the subexpressions
are not matched.

Instead of this active opt-out, we want to have subexpression constness
attributes to get propagated from child expressions to their parents in
the future.

A prerequisite is that each expression's ->flags is in a defined
state at all times.

Set ->flags to SET_INT or NONE at expression allocation time,
depending if the expression has a type or not
(alloc_const_expression() or alloc_expression()).

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expression.h (+2/-0)
--------------------------------------------------------------------------------

[274c154704db] 2017-03-31 02:13:53 +0200
Author: Nicolai Stange <nicstange@gmail.com>
Subject: constexpr: introduce additional expression constness tracking flags

Even if sparse attempted to verify that initializers for static storage
duration objects are constant expressions [6.7.8(4)] (which it
currently does not), it could not tell reliably.
Example:

  enum { b = 0 };
  static void *c = { (void*)b }; /* disallowed by C99 */

References to enum members are not allowed in address constants [6.6(9)]
and thus, the initializer is not a constant expression at all.

Prepare for a more fine-grained tracking of expression constness in the
sense of C99 [6.4.4, 6.6].

Introduce a broader set of constness tracking flags, resembling the
four types of primary expression constants [6.4.4] (integer, floating,
enumeration, character). Define helper macros to consistently set and
clear these flags as they are not completely independent.

In particular, introduce the following flags for tagging expression constness
at the level of primary expressions:
- CEF_INT: integer constant, i.e. literal
- CEF_FLOAT: floating point constant (former Float_literal flag)
- CEF_ENUM: enumeration constant
- CEF_CHAR: character constant

Introduce the CEF_ICE flag meant for tagging integer constant
expressions. It is equivalent to the former Int_const_expr flag.
Note that CEF_INT, CEF_ENUM and CEF_CHAR flags imply CEF_ICE being set.

Signed-off-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+26/-26), expand.c (+1/-1), expression.c (+38/-24), expression.h (+53/-4)
--------------------------------------------------------------------------------

[5c9411a5c048] 2017-03-27 16:27:46 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix expansion of integers to floats

The test wasn't using is_float_type() and thus missed
SYM_NODE->SUM_BASETYPE::fp_type.

Use is_float_type() now.

Reported-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
CC: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expand.c (+1/-2), validation/cast-constant-to-float.c (+35/-0), validation/cast-constants.c (+357/-0)
--------------------------------------------------------------------------------

[e6f52d5bb67d] 2017-03-27 16:12:27 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix cast to pointer to floating-point

By mistake, a cast to floating-pointer pointer was
created as OP_FPCAST instead of OP_PTRCAST.

Fix this by adding the missing 'else'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+1/-2), validation/fp-vs-ptrcast.c (+13/-0)
--------------------------------------------------------------------------------

[c1a53a868eba] 2017-03-27 16:12:27 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: do not depends on limits.h to test __CHAR_BIT__

This test depends on the header <limits.h> which itself depends
on some macros being defined by the compiler.

Now these macros are predefined (at least the obvious ones)
but it's annoying for the tests to depends on external things
like this header.

Remove this dependence by rewriting the test to use the predefined
macros directly.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/builtin_char_bit.c (+0/-7), validation/preprocessor/predef-char-bit.c (+16/-0)
--------------------------------------------------------------------------------

[369cbea4b376] 2017-03-27 16:11:58 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix test validation/div.c

This test, which test the diagnostics given at the boundary
conditions of division, depends on the header <limits.h> which
itself depends on some macros being defined by the compiler.

Now these macros are predefined (at least the obvious ones)
but it's annoying for the tests to depends on external things
like this header.

Remove this dependence by rewriting the test to use the predefined
macros directly.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/div.c (+12/-10)
--------------------------------------------------------------------------------

[5466cf8f31f8] 2017-03-27 15:20:54 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: predefine __SIZEOF_INT__ & friends

Some tests or some code depends on these macros being predefined
by the compiler.

Predefine them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+10/-0), validation/preprocessor/predef-sizeof.c (+25/-0)
--------------------------------------------------------------------------------

[4fae9be00c88] 2017-03-27 15:20:21 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: predefine __INT_MAX__ and friends

Some tests or some code depends on these macros being predefined
by the compiler.

Predefine them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+18/-5), validation/preprocessor/predef-max.c (+18/-0)
--------------------------------------------------------------------------------

[70d85a2b68ef] 2017-03-27 14:55:10 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix test for cast to bool on 32bit machines

The result implicitely depended on longs and/or pointers
being 64 bit or just bigger than ints.

Fix this by running the test with the -m64 flag.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/bool-cast-explicit.c (+1/-1), validation/bool-cast-implicit.c (+1/-1)
--------------------------------------------------------------------------------

[ecda2093f190] 2017-03-22 18:24:41 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix is_scalar_type()

This helper was introduced to add some warning in conditionals
which must accept arrays and functions as those degenerate as
pointers in this context.

There was some sign of a bug somewhere but it wasn't seen
and as consequence arrays and function type were added to
scalar type (yeah, brown paper bag).

Now that the bug is solved, fix this by removing array and
function type from is_scalar_type().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+0/-2)
--------------------------------------------------------------------------------

[b5867a33b62c] 2017-03-22 18:24:41 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix evaluation of a function or array symbol in conditionals

Functions and arrays degenerate as pointers in most context
but this wasn't done in the case of conditionals.

As a result the value of the conditional after linearization
was invalid.

Fix this by calling degenerate() in evaluate_conditional().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-0), validation/cond-address.c (+14/-0)
--------------------------------------------------------------------------------

[4480ef07d118] 2017-03-22 18:24:41 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: warn if testing the address of an array

Testing the address of an array is quite suspicious:
it's most probably the sign of an error somewhere.
Furthermore, such uses always evaluate to true.

So, add a warning about such use (but only if -Waddress was given).

Files: evaluate.c (+3/-0), validation/cond-address-array.c (+26/-0)
--------------------------------------------------------------------------------

[eccfa2c15c5c] 2017-03-22 18:24:41 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add is_array_type()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+7/-0)
--------------------------------------------------------------------------------

[7b6694c40b33] 2017-03-22 18:24:41 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: warn if testing the address of a function

Testing the address of a function is quite suspicious:
it's most probably the sign of an error somewhere.
Furthermore, such uses always evaluate to true.

So, add a warning about such use (but only if -Waddress was given).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+4/-1), validation/cond-address-function.c (+18/-0)
--------------------------------------------------------------------------------

[e4a026a56afb] 2017-03-22 18:24:41 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add is_func_type()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+7/-0)
--------------------------------------------------------------------------------

[c9fec04c98b7] 2017-03-22 18:22:53 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse about -Waddress

This is used by GCC to report suspicious use of addresses.

So, reuse the same name for same or similar use.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+2/-0), lib.h (+1/-0)
--------------------------------------------------------------------------------

[97ebb3459439] 2017-03-06 12:30:36 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use VOID instead of directly using &void_pseudo

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[bdeaed12f958] 2017-03-06 08:56:19 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: move 'extern with initializer' validation after the validate method

Before the call to the method external_decl::validate_decl()
there is another validation done which check if the declaration
linkage is not external, otherwise an error is issued and the
'extern' is removed from the declaration.

While also valid for C99 for-loop initializer, this is less
desirable because in this context, 'extern' is invalid anyway
and removing it from the declaration make it imposible to issue
a diagnostic about it.

Fix this by moving the 'extern with initializer' check after the
call to validate_decl() method, where it is always pertinent and
so allowing process_for_loop_decl() to make its own diagnostic.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: parse.c (+5/-4), validation/c99-for-loop-decl.c (+1/-1)
--------------------------------------------------------------------------------

[44632081a3b5] 2017-03-06 08:51:22 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: check the storage of C99 for-loop initializers

In C99, it is valid to declare a variable inside a
for-loop initializer but only when the storage is local
(automatic or register). Until now this was not enforced.

Fix this, when parsing declarations in a for-loop context,
by calling external_decl() with a validate method doing the
appropriate check of the storage.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: parse.c (+12/-1), validation/c99-for-loop-decl.c (+0/-1)
--------------------------------------------------------------------------------

[d4b88ffd878c] 2017-03-06 08:49:15 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add an optional validation method to external_declaration()

After parsing and validation, the symbols in the declaration
are added to the list given in argument, *if* they are not extern
symbols. The symbols that are extern are them not added to the list.

This is what is needed for usual declarations but ignoring extern
symbols make it impossible to emit a diagnostic in less usual
situation.

This is motivated by the validation of variable declaration inside
a for-loop initializer, which is valid in C99 but only for variable
with local storage.

The change consists in adding to external_declaration() an optional
callback 'validate_decl()' which, if present (non-null), is called
just before adding the declaration to the list.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+1/-1), parse.c (+7/-3), parse.h (+2/-1)
--------------------------------------------------------------------------------

[b3e3bc46550a] 2017-03-06 08:48:35 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test cases for storage of c99 for-loop declarations

Variable declared inside a C99 for-loop must have register
or automatic storage; static & extern storage are invalid.
These test cases verify that we warns if it is not the case.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/c99-for-loop-decl.c (+23/-0)
--------------------------------------------------------------------------------

[9af83dd11730] 2017-03-06 08:48:03 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for scope of C99 for-loop declarations

Insure that variable declared inside a C99 for-loop
have their scope restricted to this loop.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/c99-for-loop-decl.c (+18/-0)
--------------------------------------------------------------------------------

[fdd39251681b] 2017-03-06 08:47:52 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: replace test for c99 for-loop initializers

This test is to insure that a for-loop with C99-style initializer
linearize correctly: the same as a C89-style one (modulo any effect
on the scope of the variables). For example that code like:
	for (int = 0; i < 10; i++)
		do_stuff(i);
is linearized the same as  code like:
	int i;
	for (i = 0; i < 10; i++)
		do_stuff(i);

A test for this already exist in the testsuite:
	0e91f878 ("validation: Check C99 for loop variables")
which show the correctness of the fix::
	ed73fd32 ("linearize: Emit C99 declarations correctly")
But this test is an indirect one, using the presence or absence of
warning about context imbalance to show that some part of code is
present or not.

Now that we have the minimal tools to test the output of
test-linearize, use them to replace the test by a direct one.

Note: ideally we would like to show that the C89 & the C99 version
generate the same code but the testsuie deosn't allow this (yet).

Test-case-for: ed73fd32 ("linearize: Emit C99 declarations correctly")
Replaces:      0e91f878 ("validation: Check C99 for loop variables")
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/c99-for-loop.c (+12/-24)
--------------------------------------------------------------------------------

[8ed1b1006d20] 2017-03-06 08:45:58 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unused helper is_branch_goto()

This helper is also made unneeded since the introduction of OP_CBR.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: linearize.h (+0/-4)
--------------------------------------------------------------------------------

[86bcec7afa66] 2017-03-06 08:45:58 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: split OP_BR between unconditional & conditional: OP_CBR

OP_BR instructions exist in two flavours, relatively much
differentiated: conditional & non-conditional. One has an
operand (and thus its usage need to be cared for, must be
handled in liveness analysis, ..) the other has not; one has
two BB target, the other only one.

There is essentially no places in the code where both flavours
are handled the same. Sometimes they both must be handled but
each with their specificities but in most cases only one of
them is concerned and we need to filter out the other one.
In both cases it means that we need to check what kind we're
dealing with.

There is already a problem with this because there is
several ways to test which kind an OP_BR is and they
are not exactly equivalent:
1) testing if insn->cond is NULL
2) testing if one of insn->bb_true or ->bb_false is NULL.
There exist also an helper (is_branch_goto()) which does
the second tests but which is never used.

It appears that the first test should not be used because
in some cases an conditional OP_BR is changed into
a non-conditional one by (amongst others things) setting
it's ->cond to VOID. We should thus always use the seconds
test (which need two compares with NULL).

This could be corrected in several ways (like changing all
the places wheer the first test is used, use the helper
everywhere or never set ->cond to VOID) but the simplest
is to simply split them in two separated instructions:
OP_BR & OP_CBR, especailly given the fact that in most cases
the OP_BR was first selected by a switch (opcode).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: example.c (+2/-0), flow.c (+11/-6), linearize.c (+8/-6), linearize.h (+1/-0), liveness.c (+2/-1), ... and 3 more
--------------------------------------------------------------------------------

[522773d08970] 2017-03-04 00:45:38 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix size of loaded bitfields

Loading a bitfield correctly take in account the offset
of the bitfield inside the whole container integer.
But truncating it to the width of the bitfield is not done
or is done very implicitely (because the correct size is not lost).
For example, with the following code:
	struct bfu {
		unsigned int a:3;
	};
	unsigned int get__bfu_a(struct bfu bf) { return bf.a; }

test-linearize gives as output something like:
	get__bfu_a:
		cast.32     %r2 <- (3) %arg1
		ret.32      %r2

We can notice the (3) in the cast instruction but this is misleading
as %arg1 is not 3bit wide.

Fix this by adding the missing truncating cast.
This will then gives something like:
	get__bfu_a:
		cast.3      %r2 <- (32) %arg1
		cast.32     %r3 <- (3) %r2
		ret.32      %r3

Note the truncation could also be done by a and-mask but the cast
is more logical since we're here only changing size and not doing
some arithmetic operations.

Fixes: 1688f039c ("Re-do memory access linearization.")
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: linearize.c (+3/-1), validation/bitfield-size.c (+41/-0)
--------------------------------------------------------------------------------

[b8c268640114] 2017-03-04 00:45:38 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix usage in simplify_seteq_setne()

The usage was removed before the new operands were used
which can lead to undefined pseudos.

Fix this by moving the call to remove_usage() where
it should always have been: after the call to use_pseudo().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+3/-2)
--------------------------------------------------------------------------------

[ce83abe23b09] 2017-03-04 00:45:38 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ignore whole-range overlapping initializer

When an array is initialized, it may be convenient to first
initialize all entries with some default value via the
'[a ... b]' notation and then override some of these entries
with a non-default value. Unfortunately, this, of course,
is not compatible with the default warning flag '-Woverride-init'.

Fix this by introducing an exception to the usual detection
of overlapping initializers which, only for what concerns this
warning, ignore an '[a ... b]' entry if:
- it is the first one
- it covers the whole range of the array.

If needed, the previous ehaviour can be restored by using a new
warning flag, disabled by default: '-Woverride-init-whole-range'.

Suggested-by: Will Deacon <will.deacon@arm.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: expand.c (+11/-2), lib.c (+1/-0), lib.h (+1/-0), validation/field-override.c (+6/-24)
--------------------------------------------------------------------------------

[7788da8bcf48] 2017-03-04 00:45:38 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix checking of overlapping initializer

The current routine checking if some initializers overlap with each
others only check the offset of the initialierd fields, not taking
in account that array elements can be initialized by range with the
'[a ... b]' notation.

Fix this by changing the check so that now we compare the offset of
the current field with the end of the previous one.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: expand.c (+23/-2), validation/field-override.c (+0/-1)
--------------------------------------------------------------------------------

[6c66b45aa212] 2017-03-04 00:45:38 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: allow to warn on all overlapping initializers

By default, sparse only warns on the first overlapping initialier.

While this may be sensible for most situation, it's not always wanted
to hide those others errors. This is especially annoying when testing.

Change this by introducing a new warning flag '-Woverride-init-all',
disabled by default and whose intented use is sparse's testsuite.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: expand.c (+2/-1), lib.c (+2/-0), lib.h (+1/-0), validation/field-override.c (+33/-1)
--------------------------------------------------------------------------------

[f6ae9c86e4e2] 2017-03-04 00:45:38 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for warnings about overlapping initializers

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/field-override.c (+88/-0)
--------------------------------------------------------------------------------

[ecb47e33d67a] 2017-03-04 00:45:38 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use option: '-Woverride-init'

Sparse warns unconditionally about overlapping initilalizers.

Introduces a warning flag to control this, use the same name
as GCC's and enabled it by default.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: expand.c (+3/-0), lib.c (+2/-0), lib.h (+1/-0), validation/Woverride-init-def.c (+14/-0), validation/Woverride-init-no.c (+12/-0), ... and 1 more
--------------------------------------------------------------------------------

[a9432b3336e8] 2017-03-04 00:45:38 +0800
Author: Edward Cree <ecree@solarflare.com>
Subject: Allow casting to a restricted type if !restricted_value

If the operand of a cast to a restricted type is an unrestricted value,
 the cast should not produce a warning, since an equivalent implied cast
 (e.g. in an initialiser) would not do so.

Also adds a test case (bitwise-cast.c) testing implicit and explicit
 conversions of zero and nonzero integers to bitwise type.

Signed-off-by: Edward Cree <ecree@solarflare.com>
Acked-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Tested-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: evaluate.c (+1/-1), validation/bitwise-cast.c (+44/-0)
--------------------------------------------------------------------------------

[0dfda0d1f0fe] 2017-03-04 00:45:38 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: make -Wbitwise operational again

The flag -Wbitwise have no effect since patch 02a886bfa
("Introduce keyword driven attribute parsing"): the corresponding
checks are now always done.

Fix that by reintroducing it in the same way as it was:
ignore the bitwise attribute if the flag is not set.
It's less invasive that checking the flag at each place
an corresponding warning is emitted.
Also, to not perturb the current situation the flag is now
enabled by default.

Reported-by: Edward Cree <ecree@solarflare.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+1/-1), parse.c (+14/-2)
--------------------------------------------------------------------------------

[df57533b37f0] 2017-02-27 16:12:53 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add missing braces around FOR_EACH_PTR loop

Stricto sensu, these braces are not needed but are used
everywhere else around FOR_EACH_PTR and friends loops.
Their lack can also bite you when doing experiments with
the ptrlist macros ...

CC: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: dissect.c (+2/-2)
--------------------------------------------------------------------------------

[95f38ba85df2] 2017-02-27 00:56:37 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix expansion cost of pure functions

Expansion cost of an expression should be a monotonically
increasing function of its sub-expressions.

Here, for the costs of calling a pure function, the costs is
reset to zero (wich is used when the expression expand to
a constant/to test if the expression is a constant or not).

Fix this by setting the cost as the total expansion cost of
all the arguments plus one for the function itself.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: expand.c (+1/-1)
--------------------------------------------------------------------------------

[f5777926bee1] 2017-02-23 08:04:57 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: CSE: avoid hashing removed instructions

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: cse.c (+2/-0)
--------------------------------------------------------------------------------

[5265109dabc7] 2017-02-23 08:04:19 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: CSE: use commutativity to identify equivalent instructions

By definition a commutative operation give the same result if its
operands are exchanged.
CSE can use this property when comparing instructions to find
more equivalent instructions and thus eliminate more of them..

Implement this by special-casing commutative ops in insn_compare().

Note: this come for free when all instructions are properly
canonicalized, which is not yet the case.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: cse.c (+14/-8), validation/optim/cse-commutativity.c (+22/-0)
--------------------------------------------------------------------------------

[60ba2df1de54] 2017-02-23 08:00:54 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: CSE: add test cases for comparisons duality

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/optim/cse-dual-compare.c (+34/-0)
--------------------------------------------------------------------------------

[fbbfc73099d1] 2017-02-16 23:00:06 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify float-to-float casts that doesn't change size

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+2/-0), validation/optim/fpcast-nop.c (+15/-0)
--------------------------------------------------------------------------------

[11b1a83b1967] 2017-02-16 20:43:12 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix OP_PHI usage in try_to_simplify_bb()

In try_to_simplify_bb(), simplification is attempted when a constant
phisrc whose corresponding phi-node control a conditional branch.
In this case, for the path between the phisrc and the conditional
branch, the following OP_PHI is sort of unneeded since the constant
determine which branch will be taken.

If this simplification can be made, it means that the OP_PHI
doesn't depend anymore on the constant phisrc. In fact the OP_PHI's bb
won't be anymore reachable from the constant phisrc's bb.
But currently, the OP_PHI usage is not adjusted and this leads to all
sort of oddities and causes to miss further simplifications.

The situation can be more concretly seen on test-linearize's output,
here an extract of Linux's kernel/futex.c:get_futex_key().
	.L594:
		...
		br          %r1294, .L651, .L656
	.L651:
		phisrc.32   %phi85 <- $1
		br          .L649
	.L656:
		...
		and.64      %r1340 <- %r1339, $1
		phisrc.32   %phi87 <- %r1340
		phi.32      %r1343 <- %phi85, %phi87
		br          %r1343, .L649, .L648

The constant phisrc is %phi85 in .L651, the OP_PHI and the conditional
branch are .L656's last instructions (which have been packed with its
now unique parent which is sign of a problem). One can see that the
OP_PHi seems to depend on %phi85 (it's in its phi_list) but in fact
depends only on %phi87 (.L656 can't be reached from .L651 where %phi85
is defined since after the simplification .L651 directly branches to
one of the .L656's children, here .L649).

The fix consists in adjusting the OP_PHI's usage when the
simplification is made.

On the same code extract we can now see that the situation is more
"normal". In fact the OP_PHI have now been able to be optimized away
together, as well as .L651:
	.L594:
		...
		br          %r1294, .L649, .L656
	.L656:
		...
		and.64      %r1340 <- %r1339, $1
		br          %r1340, .L649, .L648

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: flow.c (+2/-0), validation/kill-phi-ttsbb.c (+28/-0)
--------------------------------------------------------------------------------

[9d88dc64ceef] 2017-02-16 20:43:12 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use kill_instruction() when killing any instructions during CSE

Instructions removed during CSE had their ->bb simply set to NULL
and the usage of their operand was not adjusted.

Fix that by calling kill_instruction().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: cse.c (+1/-6), validation/kill-cse.c (+21/-0)
--------------------------------------------------------------------------------

[75d548d5b14d] 2017-02-16 20:43:11 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use kill_instruction() when killing an OP_PHI during CSE

cse_one_instruction() contains some code to be executed when
an OP_PHI is eliminated. This code is roughly equivalent to
what is done in kill_instruction() for OP_PHI but not complete
since it doesn't recursively try to kill others instructions
which are used only by this OP_PHI.

Fix this and avoid duplicated code by replacing this code by
a call to kill_instruction().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: cse.c (+1/-9)
--------------------------------------------------------------------------------

[700ab906a384] 2017-02-16 20:43:10 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix killing of rewritten loads

OP_LOADs removed by rewrite_load_instruction() had their ->bb simply
set to NULL the usage of its operand was not adjusted.

Fix that by calling kill_instruction().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: flow.c (+1/-1), validation/kill-rewritten-load.c (+16/-0)
--------------------------------------------------------------------------------

[2e9471d51289] 2017-02-16 20:43:10 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add killing of stores

OP_STOREs were ignored by kill_instruction() but if it is force-killed
because the basic block it belong became unreachable then we need to
adjust the usage of its operands.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+7/-0), validation/kill-store.c (+16/-0)
--------------------------------------------------------------------------------

[c3420f1e8ad7] 2017-02-16 20:43:09 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add killing of non-volatile loads

OP_LOADs were ignored by kill_instruction() but there are two cases
were something can or must be done:
1) if the is not a volatile one, it is free of side-effects and can thus
   be optimized away like others instructions.
2) if force-killed then we need to adjust the usage of its operand.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+6/-0), validation/kill-load.c (+17/-0)
--------------------------------------------------------------------------------

[c17cd10a6a94] 2017-02-16 20:43:08 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix killing OP_CALL via pointers

When killing an OP_CALL corresponding to a function pointer
the ->func field needs also to have its usage adjusted.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+2/-0)
--------------------------------------------------------------------------------

[aa07c1187a89] 2017-02-16 20:43:07 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add killing of pure calls

OP_CALL were ignored by kill_instruction() but there are two cases
were something can or must be done:
1) if the function is pure, it is free of side-effects and can thus
   be optimized away like others instructions.
2) if force-killed then we need to adjust the usage of all the arguments.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+11/-0), validation/kill-pure-call.c (+17/-0)
--------------------------------------------------------------------------------

[b25e49741013] 2017-02-16 20:43:07 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: kill_instruction() may need to be forced or not

There is essentially three cases where kill_instruction() is
called:
1) when implicitely removing an instruction via
   kill_use()/remove_usage() once all users of (the target of)
   this instruction have been removed and so this instruction
   become unneeded.
2) when explicitely removing a specific instruction.
3) when explicitely removing all instructions in a basic block
   because it became unreachable.

For 'pure' instructions, like the arithmetic operators, these
three cases can be handled exactly the same but for instructions
having side-effects, special care is needed.
For them case 1) should do nothing while cases 2) & 3) should
remove the instruction and adjust the usage of its operands like
for normal instructions.

To handle this gracefully:
- rename kill_instruction() into kill_insn()
- add a new argument ('force') to kill_insn()
- create kill_instruction() & kill_instruction_force() as inline
  functions calling kill_insn() with 'force' set respectively to 0 & 1.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: flow.c (+1/-2), flow.h (+10/-1), simplify.c (+10/-1)
--------------------------------------------------------------------------------

[97aa4b8f54e6] 2017-02-16 20:43:06 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix killing of otherwise not-handled instructions

The instructions which are otherwise not handled in
kill_instruction() were simply ignored  but they must
still have their ->bb set to NULL.

Fix this by separating the default case from OP_ENTRY,
the only kind that must be ignored in all circonstances.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+3/-1)
--------------------------------------------------------------------------------

[5824fd80fd19] 2017-02-16 20:43:06 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unused clear_phi()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+0/-10)
--------------------------------------------------------------------------------

[d67ab454db04] 2017-02-16 20:43:05 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix clear_phi(), replace it by kill_instruction()

clear_phi() only replaces a phi-node's sources by VOID
without adjusting the usage of these sources.
As such it can't be used for cleaning things before
removing an OP_PHI.

Fix this by replacing calls to clear_phi() by calls
to kill_instruction().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+3/-3)
--------------------------------------------------------------------------------

[a01240e7e357] 2017-02-16 20:43:04 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix killing of OP_PHIs

OP_PHIs were killed by calling clear_phi() but this function
only replaces the phi node's sources by VOID without adjusting
the usage of these sources.

Fix this by instead calling kill_use() on each of the sources
via the newly created helper kill_use_list().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+1/-1), validation/kill-phi-node.c (+9/-0)
--------------------------------------------------------------------------------

[3d17b5930d6a] 2017-02-16 20:43:04 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add helper kill_use_list()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+10/-0)
--------------------------------------------------------------------------------

[1d6968118116] 2017-02-16 20:43:03 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add killing of OP_PHISOURCEs

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+3/-0), validation/kill-phisrc.c (+21/-0)
--------------------------------------------------------------------------------

[f3e9e7da079b] 2017-02-16 20:43:01 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add killing of OP_SLICEs

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+1/-0), validation/kill-slice.c (+19/-0)
--------------------------------------------------------------------------------

[c365ba654b1b] 2017-02-16 10:23:59 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix show-parse()'s labels

show_statement() sometimes displays BBs as "L0x0" because
it uses the symbol::bb_target field which is never set when
show_statement() is usefull (before or during linearization).

Fix this by using the address of the underlaying symbol like
done when displaying others BBs (for example for the label at
the beginning of a BB).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: show-parse.c (+3/-3)
--------------------------------------------------------------------------------

[d3b8edaee289] 2017-02-16 10:23:24 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unused field 'goto_bb' in struct statement

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: parse.h (+0/-4)
--------------------------------------------------------------------------------

[014d2b01bcb8] 2017-02-16 10:22:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unused field 'multijmp' in struct statement

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: parse.h (+0/-5)
--------------------------------------------------------------------------------

[23d8ff0a7c88] 2017-02-16 10:22:22 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cleanup: there is no 'struct phi' to allocate

This wasn't removed when the 'struct phi' was replaced
(commit 6e4960a3: "Remove "struct phi", replace with instruction that generates a pseudo.")

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: allocate.h (+0/-1)
--------------------------------------------------------------------------------

[d2a7009a78ef] 2017-02-13 09:38:18 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: quieter error reporting for 'known-to-fail'

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/test-suite (+2/-0)
--------------------------------------------------------------------------------

[ee43fc784e52] 2017-02-13 09:38:18 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: allow quieter error reporting

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/test-suite (+2/-2)
--------------------------------------------------------------------------------

[2ecb7f894226] 2017-02-13 09:38:17 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: get 'check-known-to-fail' earlier

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/test-suite (+4/-4)
--------------------------------------------------------------------------------

[d9ddbba2bfeb] 2017-02-13 09:38:16 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: use 'error' instead of 'info' for successful tests known to fail

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/test-suite (+1/-1)
--------------------------------------------------------------------------------

[ca3b42a46e7b] 2017-02-13 09:38:15 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: check the nbr of times a pattern should be present

Complement the 'check-output-contains/excludes' tags to also
be able to specify the number of times a given pattern should
occurs in the output.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Documentation/test-suite (+4/-0), validation/test-suite (+28/-0)
--------------------------------------------------------------------------------

[3be53df1165c] 2017-02-13 09:38:14 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add some selfchecking

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/testsuite-selfcheck1.c (+10/-0), validation/testsuite-selfcheck2.c (+10/-0), validation/testsuite-selfcheck3.c (+10/-0)
--------------------------------------------------------------------------------

[f832788b65c9] 2017-02-13 09:38:13 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: check patterns presence or absence in output

Currently the test suite always check the exit value and the output
of the command used for the test. This is fine and allow use to catch
the most common situations:
- failure or crash (via the exit value)
- (un)expected output (like when testing the result of the preprocessor)
- (un)expected errors & warnings (like when testing sparse's warnings)

But sometimes, we're not interested in the output as such because it
can't be compared textually to some reference. This occurs systematically
when testing the output of test-linearize or test-unssa which emits
labels names which are in fact pointer values and which exact output
is very sensitive to any change in processing order, optimizations, ...
But useful tests can be easily made by just checking for the presence
or absence of some identifiers, or more generally some patterns.

This patch allow to do that by adding support for two  new tags
(check-output-contains & check-output-excludes), telling to test suite
to verifiy that the given patterns are effectively present ot absent
from the output of the tested file.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Documentation/test-suite (+10/-0), validation/test-suite (+52/-0)
--------------------------------------------------------------------------------

[fbe84decbcab] 2017-02-13 09:38:12 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: allow to launch the test suite from the project root dir

The test suite must be run from the validation/ dir
which is sometimes slightly annoying.

Change that by letting the script to first do a cd to
the validation dir.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/test-suite (+2/-0)
--------------------------------------------------------------------------------

[2958bb18c166] 2017-02-13 09:38:12 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: report as error tests known to fail but which succeed

Such situation may simply show that what was tested is now fixed
and that it's juste the test annotation which need to be adapted,
but can be a sign that something else is broken.

Reporting the exact result (failure/success, known-to-fail/expect-to-succeed)
make the testsuite more useful and allow to use more efficiently
git-bisect or other automated testing tools.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/test-suite (+21/-8)
--------------------------------------------------------------------------------

[9ab8a6a72c38] 2017-02-13 09:38:11 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add tag to ignore the output/error

Currently the test suite always check the exit value and the output
of the command used for the test. This is fine and allow use to catch
the most common situations:
- failure or crash (via the exit value)
- (un)expected output (like when testing the result of the preprocessor)
- (un)expected errors & warnings (like when testing sparse's warnings)

But sometimes, we're not interested in the output or the output (as is)
is simply not meaningful for the test or can't be compared textually
to some reference.

This patch add two new tags (check-output-ignore & check-error-ignore),
telling to test suite to ignore the content of stdout or stderr when
testing this file.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Documentation/test-suite (+6/-0), validation/test-suite (+2/-0)
--------------------------------------------------------------------------------

[5df193d18298] 2017-02-13 09:38:10 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add a simple test for -Wenum-mismatch

A nice feature
No tests existed for it
Create one now.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/enum-mismatch.c (+19/-0)
--------------------------------------------------------------------------------

[f934189b99ee] 2017-02-13 09:38:08 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: simplify the ioc-typecheck case

The test was relatively convoluted and it wasn't very clear what
was the problem and waht was tested.

The real problem is simply a problem about a non-constant
expression in an array designator.

Simplify the test to clearly show that.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/ioc-typecheck.c (+3/-9)
--------------------------------------------------------------------------------

[cac6d8d34ba6] 2017-02-13 09:38:05 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: make tests known to fail effectively fail

These tests must fail because some errors which should
be detected are not.
But the test suite lack to see that because those tests
don't have the check-error-start/end section.

Add such a section (with madeup error message) so that the
testsuite now properly see and report the failure.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/badtype1.c (+4/-0), validation/struct-ns2.c (+6/-0)
--------------------------------------------------------------------------------

[d8098a73cffc] 2017-02-13 09:37:52 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: give a proper name to the 'binary-constant' test

The template for this test was visibly copied from another one
and totally irrelevant to what is tested.

Give it another name, briefly describing the subject of the test.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/binary-constant.c (+1/-1)
--------------------------------------------------------------------------------

[9a00fd8a315d] 2017-02-13 09:37:48 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: expand __builtin_bswap*() with constant args

Things are greatly simplified now that such builtins can have a
prototype: the args and result are already evaluated, the
arguments number and their type are already checked, etc.

Based-on-patch-by: Christopher Li <sparse@chrisli.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: builtin.c (+30/-0), lib.c (+3/-32), lib.h (+5/-0), validation/builtin-args-checking.c (+45/-0), validation/{builtin-constant-eval.c => builtin-bswap-constant.c} (+1/-1), ... and 1 more
--------------------------------------------------------------------------------

[f8cd31e76191] 2017-02-13 09:37:42 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: let identical symbols share their evaluate/expand methods

So far, builtin functions which had some evaluate/expand method
couldn't also have a prototype because the declaration of the
prototype and the definition of the builtin with its method would
each have their own symbol and only one of them will be seen, the
last one, the one for the prototype.
This also meant that the evaluate/expand methods had to take care
to set the correct types for they argumenst & results, which is fine
for some generic builtins like __builtin_constant_p() but much less
practical for the ones like __builtin_bswap{16,32,64}().

Fix this by letting symbols with same name share their methods.

Originally-by: Christopher Li <sparse@chrisli.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: parse.c (+3/-1)
--------------------------------------------------------------------------------

[ddc7005bbe5a] 2017-02-13 09:37:34 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: move evaluation & expansion of builtins in a separate file

No functional changes, just move some code around and rename
'eval_init_table[]' to 'builtins_table[]'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Makefile (+1/-0), builtin.c (+210/-0), expand.c (+1/-23), expand.h (+34/-0), symbol.c (+1/-159), ... and 1 more
--------------------------------------------------------------------------------

[5cefe205883d] 2017-02-13 09:34:46 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support for LLP64 arch

There was recently on the mailing list some questions
and a need to support LLP64 model.

This patch add is by adjusting a few size-related variables
under the control of a new flag: -msize-llp64 (ugly name
but we already have we have '-msize-long').

CC: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+27/-7)
--------------------------------------------------------------------------------

[e460239ea1bc] 2017-02-13 09:34:46 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify '(x || x)' and '(x && x)'

The operators '||' and '&&' being idempotent, the expressions
'(x || x)' and '(x && x)' can be simplified to a test against zero.

Note: they could even be replaced by 'x' itself but only if 'x' is
already a boolean expression/has already been tested against zero.
If it is the case, the redundant test this will be optimized away
in further steps.

For example, test-linearize on the following code:
	int ior(int a) { return a || a; }
emitted the following instructions:
	or-bool.32  %r3 <- %arg1, %arg1
after the patch, it now emits:
	setne.32    %r3 <- %arg1, $0
which is easier to combine with others simplifications.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+4/-4), validation/optim/bool-same-args.c (+12/-0)
--------------------------------------------------------------------------------

[e5f70312b25b] 2017-02-13 09:34:46 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify comparisons followed by an equality test against 0 or 1

Expressions involving equality testing against zero are ubiquitious
and can often be simplified with previous comparisons.

For example, when using test-linearize on the following code:
	_Bool foo(int a) { return !(a < 3); }
the following was emitted:
	setlt.32    %r2 <- %arg1, $3
	seteq.32    %r3 <- %r2, $0
	setne.1     %r4 <- %r3, $0
	ret.1       %r4

but this can be simplified into:
	setge.1     %r4 <- %arg1, $3
	ret.1       %r4

Implement this simplification and add associated test cases.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+65/-0), validation/optim/setcc-setcc.c (+19/-0), validation/optim/setcc-seteq.c (+13/-0), validation/optim/setcc-setne.c (+13/-0)
--------------------------------------------------------------------------------

[77ec9f360da2] 2017-02-13 09:34:46 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add warning option '-Wtautological-compare'

Now that we optimize away expressions like 'x == x' or 'x < x',
also add a warning for it (but disabled by default).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+2/-0), lib.h (+1/-0), simplify.c (+4/-0), validation/tautological-compare.c (+35/-0)
--------------------------------------------------------------------------------

[38bad4d8816c] 2017-02-13 09:34:46 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify '(x op x)' to '0', '1' or 'x'

Most binops can be simplified when their two operands are
identical. For example '(x ^ x)' can be simplified into '0'.

The cases '(x / x)' and '(x % x)' are not simplified since this
is correct only when x is not zero.
The cases '(x || x)' and '(x && x)' are not simplified because
it's only correct when the operands are booleans/have already
been compared against zero and the linearization don't enforce that.

This patch add the code for these simplifications as well as
their corresponding test cases.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+35/-0), validation/optim/binops-same-args.c (+49/-0)
--------------------------------------------------------------------------------

[a0886db12307] 2017-02-13 09:34:46 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify '(x || 1)' to '1'

There is simplifications for:
	(x && 0) => 0
	(x && 1) => x
	(x || 0) => x
but the fourth case '(x || 1)' is missing.

This patch add the missing simplification and a small test case.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+6/-1), validation/optim/bool-simplify.c (+51/-0)
--------------------------------------------------------------------------------

[5425db10d4d3] 2017-02-13 09:34:46 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify '~(~x)' and '-(-x)' to 'x'

Currently those double operations are not simplified.

This patch add those simplifications and some small test cases.

Note: the 'boolean not': '!(!x)' is not handled by this patch
because this operator is processed differently (it doesn't generate
an unop instruction but directly generates 'seteq' operations).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+17/-0), validation/optim/double-unop.c (+15/-0)
--------------------------------------------------------------------------------

[65aba1978c75] 2017-02-13 09:34:46 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify '(x % 1)' into '0'

For completeness, add the dual simplification 'x * 1 => x'
for modulo: 'x % 1 => 0'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+5/-0), validation/optim/muldiv-by-one.c (+3/-0)
--------------------------------------------------------------------------------

[f4615a44a2ab] 2017-02-13 09:34:46 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify '(x / -1)' to '-x' (but only for signed division)

A previous patch added the simplification for multiply by -1
but we can do the same for the signed divide.

This patch add this simplification
Also add the corresponding test cases.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+2/-0), validation/optim/muldiv-minus-one.c (+5/-0)
--------------------------------------------------------------------------------

[f1252a541ac8] 2017-02-13 09:34:46 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify '(x * -1)' to '-x'

Currently we simplify multiplication by 1 but nothing is
done for multiplication by -1 which is equivalent to the
negation of its first operand.

This patch add this simplification.

Also add small test cases showing the simplification.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+11/-0), validation/optim/muldiv-minus-one.c (+13/-0)
--------------------------------------------------------------------------------

[e6328bea9acb] 2017-02-13 09:34:46 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify '(x / 1)' to 'x'

Currently we simplify multiplication by 1 but nothing
for the similar divide by 1.

This patch add the missing simplification together with
its test cases.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+1/-0), validation/optim/muldiv-by-one.c (+3/-0)
--------------------------------------------------------------------------------

[6c220f73b8be] 2017-02-13 09:34:46 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: move OP_MUL simplification in a separate function

This patch contains no functional changes.
It just moves the code for simplification of OP_MUL{U,S} with
constant operands in its own function in preparation for some
additional simplifications coming in the same serie.

Also add some test cases for the concerned simplifications.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+17/-0), validation/optim/muldiv-by-one.c (+13/-0), validation/optim/muldiv-by-zero.c (+13/-0)
--------------------------------------------------------------------------------

[8d688c9a6ee2] 2017-02-13 09:34:46 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: define __LONG_MAX__ & __SIZEOF_POINTER__

They're part of GCC's common predefined macros and some
code & header files depends on them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+6/-0)
--------------------------------------------------------------------------------

[af67375f340c] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add an helper for common predefined macros

Eventually, most of what GCC predefine (gcc -E -dM)
should be defined here.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+6/-1)
--------------------------------------------------------------------------------

[84e7bd4a455f] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: define __LP64__ & _LP64 if arch_m64 is enabled

They're part of GCC's common predefined macros and some
code & header files depend on them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+2/-0)
--------------------------------------------------------------------------------

[741d343b2578] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix killing OP_SETVAL instructions

Currently, kill_instruction() ignore OP_SETVAL instructions
with the result that some instructions are not optimized away
as expected.

For example, when looking at the output of test-linearize,
the following function:

	static int kill_setval(void)
	{
	l:
		return &&l && 0;
	}

gives the following output:

	kill_setval:
		set.64      %r6 <- .L1
		ret.32      $0

The 'set' instruction is obviously unneeded but nevertheless present.

With the patch, the output is the expected:

	kill_set:
		ret.32      $0

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+1/-0), validation/kill-replaced-insn.c (+7/-0)
--------------------------------------------------------------------------------

[4ea04a3a37c0] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove 'Escape' from token character class

Now that diagnostic on unknown escape sequence
have moved to post-preprocessing phase this is not more used.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Tested-by: Stephen Boyd <sboyd@codeaurora.org>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: tokenize.c (+11/-14)
--------------------------------------------------------------------------------

[f83c2b8f0b5f] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: warn on unknown escapes after preprocessing

Following the C standards conversion of escaped characters
must be done after preprocessing, just before adjacent
string concatenation. This is what is done but escape
sequence were recognized already at tokenization phase
and a warning is given then when an unknonw escape
sequence was encountered.
But there is no reason to give such warning at this
earlier phase, manly because yhere is no reasons
to warn on things which will be discarded during
the preprocessing.

Fix this by moving the diagnostic of unknown escape
sequence together with the escape conversion.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: char.c (+6/-0), tokenize.c (+0/-3), validation/escapes.c (+1/-1), validation/preprocessor/early-escape.c (+0/-1)
--------------------------------------------------------------------------------

[4b81c44868bb] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for wrong early escape conversion

Reported-by: Stephen Boyd <sboyd@codeaurora.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/preprocessor/early-escape.c (+23/-0)
--------------------------------------------------------------------------------

[62504d579978] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unused arg in uses/defs functions

In the liveness analysis, the use/def methods have a
'struct instruction *' argument.
This arg is never used and it's not clear for what it
could be used, what it would represent.

This patch remove this argument from all the concerned
functions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: liveness.c (+15/-15)
--------------------------------------------------------------------------------

[7e9d18754cf8] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: validate expression's type in conditionals

This wasn't done yet, in particular void values was accepted
inside if statements, which lead to strange situations after
linearization.

Implement this simply by calling the newly created is_scalar_type()
in evaluate_conditional() and issuing an appropriate diagnostic
when the check fail.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: evaluate.c (+5/-0), validation/conditional-type.c (+99/-0)
--------------------------------------------------------------------------------

[05adbae426c8] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add helper: is_scalar_type()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: symbol.h (+22/-0)
--------------------------------------------------------------------------------

[d1de74fffc9d] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix conditional context test case with void

The test file for context checking contains a few test cases
with a conditional, mimicking kernels's __cond_lock().
But the macro involved use as condition the return value of
a function, _ca(), which itself returns void ...

Fix the test by giving _ca() a return type of 'int'.

CC: Josh Triplett <josh@joshtriplett.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/context.c (+1/-1)
--------------------------------------------------------------------------------

[c6bbdaf57222] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cleanup kill_instruction()

No functional changes:
- factorize out the '->bb = NULL' and '|= REPEAT_CSE'.
- fall through the switch cases for ternary/bunary/unary ops.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+21/-26)
--------------------------------------------------------------------------------

[66b1f578780f] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: explicitely ignore killing OP_ENTRY

It doesn't change anything, it's more for documentation
purpose.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+4/-0)
--------------------------------------------------------------------------------

[d3bf74f5f137] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix killing OP_COMPUTEDGOTO

Currently kill_instruction() doesn't do anything with the
operands of computed gotos (OP_COMPUTEDGOTO). But when these
instructions are removed we must also remove the operands 'usage'.
Without this some instructions, which provides the select's
operands, are not optimized away as expected.

The fix consists by killing it's operand much like what is done for
conditional branches.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+1/-0), validation/kill-computedgoto.c (+17/-0)
--------------------------------------------------------------------------------

[61c406241c5d] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix killing OP_SELECT

Currently kill_instruction() doesn't do anything with the
operands of select instructions (OP_SELECT). But when these
instructions are removed we must also remove the operands 'usage'.
Without this the instructions which provides the select's
operands are not optimized away as expected.

This patch fixes this by doing for OP_SELECTs the basic
kill_instruction() for ternary instruction, like OP_RANGE.

As an example, when looking at the output of test-linearize,
the following code:

	void foo(int x)
	{
		unsigned int ui;

		ui = x + 1;
		ui = ui ? 0 : 1;
	}

gives this output:

	foo:
		add.32      %r2 <- %arg1, $1
		ret

Since the result of the ?: is never used, the whole code should be
optimized away. The 'select' instruction itself is indeed discarded
but the 'add' is not.

With the patch, the output is much closer to what's expected:

	foo:
		ret

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+1/-0), validation/kill-select.c (+16/-0)
--------------------------------------------------------------------------------

[a903d3a56a9e] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix killing OP_CAST & friends

Currently  kill_instruction() doesn't do anything with the
operands of casts instructions. But when theses instructions
are removed the operands 'usage' must be adjusted and this is
not done and as result the instructions producing the operands
of these casts are not optimized away as expected.

This patch fixes that by killing these casts the same way as others
unary instructions (OP_NOT & OP_NEG).

To illustrate the situation, the output of test-linearize
on the following code:
	extern void __abort(void);
	struct s {
		int elem:3;
	};
	void foo(struct s *x);
	void foo(struct s *x)
	{
		if (x->elem == 0) {
			if (x->elem != 0 && x->elem != 1)
				__abort();
		}
	}

gives this output without the patch:
	foo:
		load.32     %r2 <- 0[%arg1]
		cast.32     %r3 <- (3) %r2
		br          .L1
	.L1:
		ret

Since x->elem can't be at the same time == 0 & != 0, the inner if is never
true and the whole code should have been optimized away.
The 'cast' instruction is obviously not needed but nevertheless present.

With the patch, the output is much closer to what's expected:
	foo:
		load.32     %r2 <- 0[%arg1]
		br          .L1
	.L1:
		ret

Note 1) The 'load' instruction is also dead but it's a separate problem.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+4/-0), validation/kill-casts.c (+22/-0)
--------------------------------------------------------------------------------

[e8cb94f5ecd7] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix killing OP_PHI instructions

Currently kill_instruction() doesn't do anything with the
sources of OP_PHI instructions. But when these instructions
are removed the 'usage' of the associated sources must also
be removed. This is not done and as result the instructions
producing the phi-sources are not optimized away as expected.

This patch fixes that by calling clear_phi() when killing a
phi-instruction.

For example, when looking at the output of test-linearize,
the following function:
	void foo(int a, int *b, unsigned int g);
	void foo(int a, int *b, unsigned int g)
	{
		int d = 0;

		if ((!a || *b) && g)
			d = 16;
		else
			d = 8;
	}

gives this output without the patch:
	foo:
		br          %arg1, .L1, .L2
	.L1:
		phisrc.32   %phi1 <- $1
		br          .L3
	.L2:
		load.32     %r3 <- 0[%arg2]
		phisrc.32   %phi2 <- %r3
		br          .L3
	.L3:
		ret

The 'phisrc' instructions are obviously unneeded but nevertheless present.

With the patch, the output is much closer to what's expected:
	foo:
		br          %arg1, .L3, .L2
	.L2:
		load.32     %r3 <- 0[%arg2]
		br          .L3
	.L3:
		ret

Note 1) The 'load' instruction is also dead and should have been removed
but it's separate problem.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+1/-0), validation/kill-phi-node.c (+18/-0)
--------------------------------------------------------------------------------

[412a61828670] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: kill uses of replaced instructions

When an instruction is replaced by a pseudo, the 'usage' of its
operands should be removed too but it's not the case.

The fix consists in calling kill_use() for each operands after
the pseudo is replaced.
Not all types of instruction are considered, only those which
can be replaced by a pseudo.

The following example illustrate the situation. When looking at
the output of test-linearize, the following function:

	static int kill_add(int a, int b)
	{
		return (a + b) && 0;
	}

without the patch, gives this output:

	kill_add:
		add.32      %r3 <- %arg1, %arg2
		ret.32      $0

The 'add' instruction is obviously unneeded but nevertheless present.

Before any optimization the code was something like:

	kill_add:
		add.32      %r3 <- %arg1, %arg2
		and_bool.32 %r4 <- %r3, $0
		ret.32      %r4

During the simplification phase, the result of the 'and' instruction (%r4)
have been replaced by '0' and the instruction itself is discarded.
But '%r3' usage has not been adjusted and the further phases are not
aware that '%r3' is not needed anymore and so the 'add' instruction is kept
while not needed by anything.

With the patch the 'add' instruction is correctly discarded, giving the
expected output:

	kill_add:
		ret.32      $0

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+20/-0), validation/kill-replaced-insn.c (+54/-0)
--------------------------------------------------------------------------------

[b5e06b1c455c] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix crash while testing between conditional & unconditional OP_BR

It seems that testing for a NULL insn->cond is not the right test,
what must be done is to test if either of ->bb_{true,false} is NULL.

Fixes: 556dbc8d75 ("Update usage chain for dead instructions")
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: simplify.c (+1/-1)
--------------------------------------------------------------------------------

[9cc8f66242b4] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix cast's target type info

commit a0962f7893 ("Fix cast instruction generation") correctly
used the source type instead of the destination type to decide
between OP_CAST & OP_SCAST but at the same time made the choice
between OP_PTRCAST & OP_FPCAST depends on the source's type too,
thus losing all information about the target type (but its size).
In other words, in the code here below:
	int i ;
	...
	(long) i;
	(void*) i;
	(double) i;
	(float) i;
the three first casts generate exactly the same code (for a LP64 arch):
	scast.64   %r.. <- (32) %r..
and the last one will not generate any code at all.

Fix this by using the source type only to determine if the cast is an
OP_CAST or an OP_SCAST but using the target type to determine if the
cast is a cast to a pointer type (OP_PTRCAST), a floating-point type
(OP_FPCAST) or an integer type (OP_CAST or OP_SCAST).

Note: this is still not correct for floating-point to integer cast
as it is needed to know if the destination is a signed or unsigned
integer type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: linearize.c (+2/-2), validation/cast-kinds.c (+387/-0)
--------------------------------------------------------------------------------

[5373460f3062] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: C11: teach sparse about '--std={c11,gnu11}'

Now that support have been added for C11 new syntax we can accept
'--std={c11,gnu11}' no more dying with "Unsupported C dialect" message.
Also adjust __STDC_VERSION__ accordingly and define the few
associated feature macros (__STD_NO_ATOMICS__, ...).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+21/-0), validation/c11-stdc-version.c (+11/-0)
--------------------------------------------------------------------------------

[0f89a2c57648] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: C11: teach sparse about '_Alignas()'

This is quite similar to GCC's 'attribute(aligned(..))' but defined
as a new specifier and also accepting a typename as argument.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: parse.c (+43/-0), validation/c11-alignas.c (+40/-0)
--------------------------------------------------------------------------------

[cb172dce6555] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: C11: teach sparse about '_Alignof()'

This is a new name for GCC's '__alignof()' operator which was
already supported.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: expression.c (+1/-0), ident-list.h (+1/-0), validation/c11-alignof.c (+12/-0)
--------------------------------------------------------------------------------

[8c8c6f82ff62] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: C11: teach sparse about '_Noreturn'

This is mainly a new name for GCC's 'noreturn' attribute but defined
as a new function specifier.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: parse.c (+14/-0), validation/c11-noreturn.c (+9/-0)
--------------------------------------------------------------------------------

[2a67f7fb5935] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: C11: teach sparse about '_Thread_local'

This is simply a new name for GCC's '__thread' which was already
supported.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: parse.c (+1/-0), validation/c11-thread-local.c (+9/-0)
--------------------------------------------------------------------------------

[c0ad591813d8] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix value of label statement

Normaly a label statement is not also an expression but it could be
in GCC's statement expression like : ({ ...; label: <expression>; })

Currently, during linearization sparse discards the return value
of the linearization of the label's sub-statement, thus also
discarding the value of such statement-expressions.

Trivialy fix this by not discarding the return value but returning
it instead, like other statements that also are an expression and
thus have a value.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: linearize.c (+1/-2), validation/label-expr.c (+17/-0)
--------------------------------------------------------------------------------

[5636cd5cbf81] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: missing load simplification

In memops:find_dominating_parents(), the 'load-load optimization'
(see commit cf07903a "Don't bother finding dominating loads if ...")
cause some loads simplification to be missed.
For example, with the following code:
	int foo(int *i, int *j)
	{
		*i = 6;
		*j = 1;

		do {
			if (*i != 6)
				(*i)++;
			(*i)++;
		} while (*i != *j);

		return *j;
	}

test-linearize returns something like:
	foo:
	.L0:
		<entry-point>
		store.32    $6 -> 0[%arg1]
		store.32    $1 -> 0[%arg2]
		br          .L1

	.L1:
		load.32     %r4 <- 0[%arg1]
		setne.32    %r5 <- %r4, $6
		br          %r5, .L4, .L5

	.L4:
		add.32      %r8 <- %r4, $1
		store.32    %r8 -> 0[%arg1]
		br          .L5

	.L5:
		load.32     %r10 <- 0[%arg1]
		add.32      %r11 <- %r10, $1
		store.32    %r11 -> 0[%arg1]
		load.32     %r15 <- 0[%arg2]
		setne.32    %r16 <- %r11, %r15
		br          %r16, .L1, .L6

	.L6:
		ret.32      %r15

where we can notice that the first load in .L5 is not needed,
the value could be retrieved from %r4 and %r8, like:
	@@ -8,15 +8,17 @@
	 .L1:
	 	load.32     %r4 <- 0[%arg1]
	 	setne.32    %r5 <- %r4, $6
	+	phisrc.32   %phi4 <- %r4
	 	br          %r5, .L4, .L5

	 .L4:
	 	add.32      %r8 <- %r4, $1
	 	store.32    %r8 -> 0[%arg1]
	+	phisrc.32   %phi5 <- %r8
	 	br          .L5

	 .L5:
	-	load.32     %r10 <- 0[%arg1]
	+	phi.32      %r10 <- %phi4, %phi5
	 	add.32      %r11 <- %r10, $1
	 	store.32    %r11 -> 0[%arg1]
	 	load.32     %r15 <- 0[%arg2]

The fix essentially consists in reverting commit cf07903a but on
memops.c's version of find_dominating_parents().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: memops.c (+3/-7)
--------------------------------------------------------------------------------

[c8757aa484fb] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix phisrc mixup

In some cases phi sources are all mixed-up.
For example, on the following case:
	static int foo(void)
	{
		int i = 6;
		int j = 1;
		do {
			if (i != 6)
				i++;
			i++;
		} while (i != j);
		return j;
	}

test-linearize returns something like:
	.L0:
		phisrc.32   %phi3(i) <- $6
		phisrc.32   %phi7(i) <- $6
		br          .L1
	.L1:
		phi.32      %r1(i) <- %phi7(i), %phi8(i)
		setne.32    %r2 <- %r1(i), $6
		br          %r2, .L4, .L5
	.L4:
		add.32      %r4 <- %r1(i), $1
		phisrc.32   %phi5(i) <- %r4
		br          .L5
	.L5:
		phi.32      %r5 <- %phi3(i), %phi4(i), %phi5(i)
		add.32      %r6(i) <- %r5, $1
		phisrc.32   %phi4(i) <- %r6(i)
		phisrc.32   %phi8(i) <- %r6(i)
		setne.32    %r8 <- %r6(i), $1
		br          %r8, .L1, .L6
	.L6:
		ret.32      $1

The phi-node in .L5 is odd: .L5 has 2 parents (.L1 & .L4), we thus
expect to have 2 phisrc, one in .L1 and another one in .L4. There is
other oddities with phisrc: the redundant ones in .L0 and .L5.
In fact there is some sort of mixup with the phi & phisrc of .L1
and the ones in .L5 (and investigation showed it doesn't come from
further simplification phase but are already there since the creation
of these phi & phisrc).

The fix essentially consists in a revert of
  (commit cf07903a "Don't bother finding dominating loads if we have to search multiple paths")
which was already partially reverted in
  (commit c040f2e0 "Remove incorrect left-over from (not useful) old load-load dominance trials.")

We then get the more expected:
	.L0:
		phisrc.32   %phi6(i) <- $6
		br          .L1
	.L1:
		phi.32      %r1(i) <- %phi6(i), %phi7(i)
		setne.32    %r2 <- %r1(i), $6
		phisrc.32   %phi3(i) <- %r1(i)
		br          %r2, .L4, .L5
	.L4:
		add.32      %r4 <- %r1(i), $1
		phisrc.32   %phi4(i) <- %r4
		br          .L5
	.L5:
		phi.32      %r5 <- %phi3(i), %phi4(i)
		add.32      %r6(i) <- %r5, $1
		phisrc.32   %phi7(i) <- %r6(i)
		setne.32    %r8 <- %r6(i), $1
		br          %r8, .L1, .L6
	.L6:
		ret.32      $1

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: flow.c (+3/-7)
--------------------------------------------------------------------------------

[c9d08bf0047b] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix superfluous phisrc

In some case more phisrc are created than expected.
For example, on the following code:
	static int foo(int a, int b)
	{
		int i, x = 0;
		switch (a) {
		case  0: i = 0; break;
		case  1: i = 1; break;
		default: i = -1; break;
		}
		if (b)
			x = i;
		return x;
	}

test-linearize returns something like:
	foo:
	.L0:
		<entry-point>
		phisrc.32   %phi2(x) <- $0
		phisrc.32   %phi3(x) <- $0
		phisrc.32   %phi4(x) <- $0
		switch      %arg1, 0 -> .L2, 1 -> .L3, default -> .L4
	.L2:
		phisrc.32   %phi6(i) <- $0
		br          .L1
	.L3:
		phisrc.32   %phi7(i) <- $1
		br          .L1
	.L4:
		phisrc.32   %phi8(i) <- $0xffffffff
		br          .L1
	.L1:
		br          %arg2, .L5, .L6
	.L5:
		phi.32      %r3 <- %phi6(i), %phi7(i), %phi8(i)
		phisrc.32   %phi5(x) <- %r3
		br          .L6
	.L6:
		phi.32      %r4 <- %phi2(x), %phi3(x), %phi4(x), %phi5(x)
		ret.32      %r4

where we can notice that %phi2, %phi3 and %phi4 in .L0 and .L6
are completly redundant, only one of them is needed. This also
violates the usual semantic of phi-nodes: one phi for each parent bb.

There is as much %phi such created as there is cases in the switch
statement and the same problem also occurs with an if-else and 2 %phis.

Whats' happening is the following:
- find_dominating_parents() search dominators for .L6
- try first parent: .L1, find nothing, thus recurses
- .L1 has 3 parents (the three cases): .L2, .L3, .L4
- each of them has .L0 as dominator, it's recorded as such but three times

The problem is fixed by checking the dominators list and refusing to create
more than one phisrc in the same basic block.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: flow.c (+13/-0)
--------------------------------------------------------------------------------

[0ee83ccffa34] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: volatile loads must not be simplified

memops.c:simplify_loads() tries to simplify all loads,
even volatile ones.
For example, on the following code:
	static int foo(volatile int *a, int v)
	{
		*a = v;
		return *a;
	}

test-linearize returns something like:
	foo:
		store.32    %arg2 -> 0[%arg1]
		ret.32      %arg2

while the correct output is more like:
	foo:
		store.32    %arg2 -> 0[%arg1]
		load.32     %r5 <- 0[%arg1]
		ret.32      %r5

The fix is to simply ignore loads with the 'volatile' modifier.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: memops.c (+3/-0), validation/memops-volatile.c (+21/-0)
--------------------------------------------------------------------------------

[d8ce303b14f6] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unssa: update comment about the unneeded copies

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: unssa.c (+4/-0)
--------------------------------------------------------------------------------

[9a492fdd83d7] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unssa: eliminate trivial phisrc copies

A OP_PHISOURCE which is the only user of its operand
can be trivially eliminated. For example, in:
	add	%r6, ...
	...
	phisrc	%rt, %r6
the phisrc can safely be eliminated if no other instruction use %r6.
With this patch it's rewritten as:
	add	%rt, ...
	...

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: unssa.c (+22/-0)
--------------------------------------------------------------------------------

[2e6232a27803] 2017-02-13 09:34:45 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unssa: try to avoid some OP_PHI copies

OP_PHI's target can interfer with it's own source swhen defined
in the same basic block. Such interference can create problem
like the 'swap problem' (which only exist if the phi-node are
'processed' sequentially if they're processed in parallel such
problems don't exist) when phi-nodes are destructed. To avoid
such problems OP_PHI are rewritten as OP_COPY.

if an OP_PHI and it's OP_PHISOURCE are in different basic blocks
no such interference is possible and the copy is not needed.

This patch detect such situation and eliminate these unneeded copies.

Note: during unSSA we're removing the OP_PHI & OP_PHISOURCE
  but we need to use the def-use chains between them. We must
  thus not use kill_instruction() in OP_PHI (this would break
  def-use chains and leave stray OP_PHISOURCE), it's enough
  to set their bb to NULL.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: unssa.c (+32/-0)
--------------------------------------------------------------------------------

[66409e16cd16] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unssa: simplify rewrite of OP_PHISOURCE

Using the fact that each OP_PHISOURCE is used by a single OP_PHI,
it's easier to rewrite OP_PHISOURCE at the same time as their
associated OP_PHI (because we have access to the new pseudo just created).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: unssa.c (+21/-68)
--------------------------------------------------------------------------------

[75c89cd2f73e] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unssa: do not try to update liveness

The unSSA step used to try to maintain the liveness info
while creating the copies but this can't be done so simply
(what is updated is only the liveness for the current bb
while it needs to be done for all concerned bbs).

If/when liveness is needed after this step, it need to be
redone by calling track_pseudo_liveness().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: unssa.c (+0/-3)
--------------------------------------------------------------------------------

[d1d751569d53] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix cast to bool

Section 6.3.1.2 of the C standard requires that cast to bool
to be done differently than casting to others integer types:
    The casted value need to be compared against '0',
    if it compares equal the result is 0, otherwise the result is 1.

But currently, it's treated as the others integer casts: the value is
truncated, keeping only the least significant bit.

For example, when using test-linearize on the following code:
	_Bool foo(int a) { return (_Bool) a; }

this instruction is emitted:
	scast.1     %r2 <- (32) %arg1
while the correct one is:
	setne.1     %r2 <- %arg1, $0

Fix this for explicit and implicit casts.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: evaluate.c (+32/-0), validation/bool-cast-bad.c (+27/-0), validation/bool-cast-explicit.c (+26/-0), validation/bool-cast-implicit.c (+28/-0)
--------------------------------------------------------------------------------

[0c5c53f5b00f] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: remove unneeded OP_COPY support

OP_COPY instructions are only introduced by the 'unSSA' phase
which is not used by sparse-llvm.

Remove the code which tried to handle this.

Cc: Azat Khuzhin <a3at.mail@gmail.com>
Cc: Xi Wang <xi.wang@gmail.com>
Cc: Pekka Enberg <penberg@kernel.org>
Cc: Jeff Garzik <jeff@garzik.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: sparse-llvm.c (+1/-29)
--------------------------------------------------------------------------------

[6aedde496271] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix typing when comparing to a constant

In translation to LLVM, comparisons are processed like usual binary
operations. But contrary to, for example, an addition where the
result type and the type of both operands are all the same, a
comparison always returns an integer result (with boolean values)
which shouldn't depends on the type/size of its operands.

There is currently a bug regarding this when an operand of a
comparison is an integer constant:
    the type of this constant is assumed to be the type of the result
    of the comparison (in sparse's IR, the constants are typeless,
    we thus need to guess/retrieve their type from the context)

For example, with the following C code:
	_Bool foo(int a) { return a != 3; }

After linearization we can have the following very straightforward:
	setne.1    %rd <- %arg1, $3

And we expect the following LLVM IR:
	%rd = icmp ne i32 %0, 3

But what is built is the illegal:
	%rd = icmp ne i32 %0, i1 true
because is constant '3' is translated to 'i1 true' since
'setne.1' result type is boolean (i1 in LLVM parlance).

Fix this by separating the code for comparison from the others
binary operations and using the left-hand side type to interpret
the type of the constant (which is fine because the usual conversion
insure that both types match and there is never a constant on the lhs).

Cc: Azat Khuzhin <a3at.mail@gmail.com>
Cc: Xi Wang <xi.wang@gmail.com>
Cc: Pekka Enberg <penberg@kernel.org>
Cc: Jeff Garzik <jeff@garzik.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: sparse-llvm.c (+32/-17)
--------------------------------------------------------------------------------

[398201cc7fea] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix typing error in compound assignment

A compound assignment like, for example:
	x /= a;
should have the same effect as the operation followed by the
assignment except that the left side should only be evaluated
once. So the statement above (assuming 'x' free of side-effects)
should have the same effect as:
	x = x / a;

In particular, the usual conversions should applied. So, if the
type of 'x' and 'a' is, respectively, 'unsigned int' (32 bit) and
'long' (64 bit), the statement above should be equivalent to:
	x = (unsigned int) ((long) x / a);

But what is really done currently is something like:
	x = x / (unsigned int) a;
In other words, the right-hand side is casted to the same type as the
lhs and the operation is always done with this type, neglecting the
usual conversions and thus forcing the operation to always be done
with the lhs type, here 'unsigned int' instead of 'long'.
For example, with the values:
        unsigned int x = 1;
        long a = -1;

We have:
	x = 1 / (unsigned int) (-1L);
	x = 1 / 0xffffffff;
	x = 0;
instead of the expected:
	x = (unsigned int) ((long)1 / -1L);
	x = (unsigned int) (-1L);
	x = 0xffffffff;

The patch fix this by first calculating the type corresponding to
the usual conversion and then casting the right-hand side to this
type, which is fine since it's a rvalue anyway.
Later steps will then use the rhs type when doing the operation.
On the example above, the cast will be a no-op and the operation will
be done with the correct type:
	x = x / (long) a;
which, at linearization, will become:
	x = (unsigned int) ((long) x / (long) a);
and with unneeded casts optimized away:
	x = (unsigned int) ((long) x / a);
Which will give us the expected result.

If the types where in the other order, the result will also be done
with the correct type:
	long x;
	unsigned int a;
	...
	x /= a;
will become:
	x = x / (long) a;
and, at linearization:
	x = (long) ((long) x / (long) a);
and with unneeded casts optimized away:
	x = (x / (long) a);

Cc: Al Viro <viro@zeniv.linux.org.uk>
Cc: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: evaluate.c (+4/-1), linearize.c (+6/-4), validation/compound-assign-type.c (+15/-0)
--------------------------------------------------------------------------------

[62cab21fe13b] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support for __int128

There is already support for __int128_t & __uint128_t but not yet
for GCC's __int128.

This patch add support for it and a couple of test cases.

Note: it's slightly more tricky that it look because contrary to
'__int128_t', '__int128' is not an exact type (it can still receive
the 'unsigned' or 'signed' specifier).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: parse.c (+10/-0), validation/int128.c (+58/-0)
--------------------------------------------------------------------------------

[45bf23a2fee2] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix missing element in types declaration

In the code doing the parsing of type declaration there is a few
arrays for the each integer size (short, int, long, long long, ...)
The array for the unsigned and explicitely unsigned integer have
entry for 'slllong' & 'ulllong' last element but the one for plain
integer is missing its 'lllong' entry which make sparse crash when
trying to use this type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[2f8f949d9f5a] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: recursive phi_defines cannot happen

The function phi_defines() does the liveness tracking of phi-pseudos
(pseudos in OP_PHIs args). While doing this, the function is
recursively called when the pseudo would be defined by another phi-node;
but this condition is impossible because all phi-pseudos are defined
by OP_PHISOURCE instructions.

This patch remove the recursive call and its associated test.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: liveness.c (+0/-4)
--------------------------------------------------------------------------------

[1a9d0f6d2269] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cgcc should not define non-reserved identifiers

Since the original x86-64 support in cgcc
(commit 0fcbcbf4: "Implement x86-64 support in cgcc")
cgcc define some non-reserved identifiers like i386, x86_64, ...
It should not since these are valid identifiers which could be used
for some variable names.

Current versions of gcc only define those prefixed with a double
underscore and cgcc also define those. So ...

Remove the defines of the non-prefixed ones.

Reported-by: Joe Lawrence <joe.lawrence@redhat.com>
Investigated-by: Joe Lawrence <joe.lawrence@redhat.com>
Originally-From: Linus Torvalds <torvalds@linux-foundation.org>
Tested-by: Joe Lawrence <joe.lawrence@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: cgcc (+4/-4)
--------------------------------------------------------------------------------

[6d972b0e49b3] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Update maintainers in the manpage

The manpage still mentioned Josh Triplett as the maintainer
while Christopher is the maintainer since 2009.

CC: Christopher Li <sparse@chrisli.org>
CC: Josh Triplett <josh@joshtriplett.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Reviewed-by: Josh Triplett <josh@joshtriplett.org>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: sparse.1 (+1/-1)
--------------------------------------------------------------------------------

[e0a5962d74e9] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: some modifiers need to be preserved by 'typeof()'

Currently when we use typeof() all the modifiers from the source
type are ignored and thus not present in the resulting type.

This give all sort of problems. One simple example is:
	const int obj;
	typeof(obj) *ptr;
	*ptr = 0;

We can expect that 'ptr' will have the type 'const int *' and thus
that sparse will warn on the assignment in the last line but it's
not case because 'ptr' has in fact the type 'int *'.

The patch fix this by preserving some of the modifiers when using
typeof().

WARNING: it may be that the old behaviour was so more or less on
  purpose as it provide a way to remove some modifiers by casting
  while still being able to use generic macros. For exmaple, it
  was possible to write the following macro:
	#define noconst(x) (typeof(x))
  and use 'noconst()' as a cast to remove 'const' from types.
  Of course, the problem with this macros is that it remove
  *all* modifiers, not only 'const'.
  With the patch, it won't be possible anymore to do this sort of
  things, which maybe is fine for 'const' but it's why MOD_NOREFREF
  is still dropped as it create problems in the Linew kernel, for example
  in the macro to convert back a percpu variable into a plain one.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: symbol.c (+6/-2), symbol.h (+2/-0), validation/typeof-mods.c (+0/-1)
--------------------------------------------------------------------------------

[548e90093d33] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: test modifiers preserved by 'typeof()'

Note: address space, 'safe' & 'noderef' have their own test file
because they have others issues or need to be handled differently.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/typeof-addresspace.c (+20/-0), validation/typeof-mods.c (+109/-0), validation/typeof-noderef.c (+19/-0), validation/typeof-safe.c (+23/-0)
--------------------------------------------------------------------------------

[8c5fa9ab6b0f] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: test modifiers preserved by '&' operator

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/ptr-inherit.c (+80/-0)
--------------------------------------------------------------------------------

[01f2bb996b81] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use a shorter name for function-pointer-modifier-inheritance.c

The test file name is a bit longish which is annoying in test reports.
Rename it to simply 'function-pointer-inheritance.c'

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/{function-pointer-modifier-inheritance.c => function-pointer-inheritance.c} (+1/-1)
--------------------------------------------------------------------------------

[5e82dd356053] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: simplify test function-pointer-inheritance

The function used had so much args that it was hard
to see what's the difference between them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/function-pointer-modifier-inheritance.c (+2/-11)
--------------------------------------------------------------------------------

[66140b83fec0] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: storage should not be inherited by pointers

Information about storage is needed for objects but once
you take the address of an object, its storage should be
irrelevant for the resulting pointer.

Trying to keep the storage into the pointer's modifiers
(while it will be available in the base type anyway) only
create corner cases later.
An example of the problem it can create is when the pointer
is dereferenced in an inlined function.

Better to simply not put have the storage informations
for the pointer, which is what this patch does.

To better illustrate the situation, suppose you have the
following variable declaration:
	static int var;

var's type should be:
	int static [toplevel] [addressable]

if you take its address the resulting pointer will be of type:
	int static [toplevel] *

while it should simply be:
	int *

Detected-by: Nicolai Stange <nicstange@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: symbol.h (+1/-1), validation/nocast.c (+1/-1)
--------------------------------------------------------------------------------

[6e3d2b3f92b6] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unused field 'multijump' in struct instruction

This field was introduced (I think) for OP_SWITCH but is
not needed anymore as OP_SWITCH has its own entry with a field
fOr multijump list.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: linearize.h (+0/-3)
--------------------------------------------------------------------------------

[5f8681e7ad9a] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: OP_SWITCH should use 'insn->cond' instead of 'insn->target'

show_instruction() uses the field 'target' to display OP_SWITCH
instruction instead of 'cond' like OP_BR does.
It doesn't change anything since these two fields use the same
storage inside struct instruction but better to use the right field
to keep consistent.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[5dd219ef2abf] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: give comparable label's names to basic blocks

test-linearize displays basic block's labels by using
'.L0x' plus the address of the bb struct. This is certainly
convenient as an UID but it has the disadvantage that these
names change at each run and are thus not comparable.

This complicate testing quite a bit.

Let change this by giving a simple sequential number to each bb
and simply display them as: '.L1', '.L2', ...

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: linearize.c (+16/-14), linearize.h (+4/-1), test-unssa.c (+1/-1)
--------------------------------------------------------------------------------

[a721d1598fca] 2017-02-13 09:34:44 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: let "compile" not crash on bools

"compile" & "compile-i386" have never been adapted to use
bits_to_bytes() and crash when processing a bool because
it doesn't find a suffix for 1-bit instructions ('b', 'w', 'l', 'q').

Sprinkling a dozen "bit_to_bytes()" and adjusting a few shifts
would fix it but letting bits_in_bool be equal to 8 is much simpler.

Note: with this patch, "compile" crashes 'only' 25 times when used
on the testsuite files, instead of 27 without it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
CC: Jeff Layton <jlayton@redhat.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: compile.c (+2/-0)
--------------------------------------------------------------------------------

[656336899b25] 2017-02-13 09:34:43 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: make ptrlist walking against robust against empty blocks

Not all macros or function involved in the ptrlist walking
can handle a ptrlist containing some empty blocks.

Fix this by:
- add the proper check & looping to first & last_ptr_list().
- add a safe version of PTR_ENTRY doing the needed check & looping.
- use this safe version for DO_PREPARE() & DO_RESET()

Suggested-by: Linus Torvalds <torvalds@linux-foundation.org>
CC: Dan Carpenter <dan.carpenter@oracle.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Tested-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: ptrlist.h (+26/-3)
--------------------------------------------------------------------------------

[0e91f8781701] 2017-02-13 09:34:43 +0800
Author: Emily Maier <emily@emilymaier.net>
Subject: validation: Check C99 for loop variables

Previously, sparse would generate incorrect code in the presence of a
C99 variable declaration inside the for statement, completely dropping
the code after the end of the for loop. Check that it's now behaving
correctly by entering a context and not leaving it at the end of the
loop.

Signed-off-by: Emily Maier <emily@emilymaier.net>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/c99-for-loop.c (+33/-0)
--------------------------------------------------------------------------------

[2ad59aaa5eae] 2017-02-13 09:34:43 +0800
Author: Daniel Wagner <daniel.wagner@bmw-carit.de>
Subject: parse: Add comment to struct statement

All the other members of the union got a nice comment
what they represent. Let's fix for context as well.

Signed-off-by: Daniel Wagner <daniel.wagner@bmw-carit.de>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: parse.h (+1/-1)
--------------------------------------------------------------------------------

[82c138356247] 2017-02-13 09:34:43 +0800
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: s/mode_t/usage_t/ in report_member()

Cosmetic, fix the typo.

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Acked-by: Lance Richardson <lrichard@redhat.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: dissect.c (+1/-1)
--------------------------------------------------------------------------------

[ba83e861566d] 2017-02-13 09:34:43 +0800
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: teach do_initializer() to handle the nested EXPR_IDENTIFIER's

do_initializer() is very limited/buggy but it was able to parse the kernel
code until ftrace started to use ".a.b = x" rather than ".a = { .b = x }"
in initializers.

Test-case:

	struct O {
		struct I {
			int mem;
		} inn;
		int end;
	} var = {
		.inn.mem = 0,
		0,
	};

before the patch:

	1:8   s def  O
	2:16  s def  I
	6:3   g def  var                              struct O
	6:3   g -w-  var                              struct O
	7:10  s -w-  O.inn                            struct I
	7:10  s -w-  I.*                              struct I
	I.c:7:14: warning: bad expr->type: 25
	8:9   s -w-  O.end                            int

after:

	1:8   s def  O
	2:16  s def  I
	6:3   g def  var                              struct O
	6:3   g -w-  var                              struct O
	7:10  s -w-  O.inn                            struct I
	7:14  s -w-  I.mem                            int
	8:9   s -w-  O.end                            int

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Acked-by: Lance Richardson <lrichard@redhat.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: dissect.c (+12/-7)
--------------------------------------------------------------------------------

[dced7bc871c4] 2017-02-13 09:34:43 +0800
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: teach do_expression() to handle EXPR_OFFSETOF

Starting from a194f3e0 "implement __builtin_offsetof()" sparse handles
offsetof() internally but dissect.c wasn't updated.

Test case:

	struct S { int m; };

	void func(void)
	{
		__builtin_offsetof(struct S, m);
	}

before this patch:

	3:6   g def  func                             void ( ... )
	T.c:5:38: warning: bad expr->type: 30

after:

	3:6   g def  func                             void ( ... )
	1:8   s def  S
	5:38  s ---  S.m                              int

While at it, update my email.

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Acked-by: Lance Richardson <lrichard@redhat.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: dissect.c (+15/-1)
--------------------------------------------------------------------------------

[e54a9b7796b0] 2017-02-13 09:34:43 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case for builtin bswap with constant args

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/builtin-constant-eval.c (+28/-0)
--------------------------------------------------------------------------------

[05655137c5e4] 2017-02-13 09:34:43 +0800
Author: Johannes Berg <johannes@sipsolutions.net>
Subject: implement constant-folding in __builtin_bswap*()

Since gcc does this, it's apparently valid to write

 switch (x) {
 case __builtin_bswap16(12):
   break;
 }

but sparse will flag it as an error today.

The constant folding used to be done in the kernel's htons() and
friends, but due to gcc bugs that isn't done anymore since
commit 7322dd755e7d ("byteswap: try to avoid __builtin_constant_p
gcc bug").

To get rid of the sparse errors on every such instance now, just
add constant folding to __builtin_bswap*() in sparse.

Signed-off-by: Johannes Berg <johannes@sipsolutions.net>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+32/-3), validation/bswap-constant-folding.c (+28/-0)
--------------------------------------------------------------------------------

[28f6f5d2ee03] 2017-02-13 09:34:43 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix discarded label statement

When code contains an unused label, it's not needed to create a new
basic block for the code that follow it but that doesn't mean that
the following code is unreachable.

There is currently a bug related to this when processing a label statement
for a label that is never used: not only the label is ignored (and this
no new basic block is created) but the whol statement is ignored.
In other words the statement directly following an unused label is
simply ignored.

The patch fix this by simply moving the code handling the statement out
of the conditional part processing used labels.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: linearize.c (+1/-1), validation/discarded-label-statement.c (+24/-0)
--------------------------------------------------------------------------------

[bb33d4ecc344] 2017-02-13 09:34:43 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Remove unneeded variable in integer_promotion()

Following some previous simplification done on the function,
the variable 'orig_type' is now always the same as 'type'.

To avoid possible confusion, only use 'type' and remove
the declaration of 'orig_type'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: evaluate.c (+1/-3)
--------------------------------------------------------------------------------

[f25e41f4856b] 2017-02-13 09:34:43 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Warn on unknown attributes instead of throwing errors

GCC creates new attributes quite often, generaly for specific
usages irrelevant to what sparse is used for.
Throwing errors on these create needless noise and annoyance
which is better to avoid.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+2/-0), lib.h (+1/-0), parse.c (+2/-1), validation/Wunknown-attribute-def.c (+9/-0), validation/Wunknown-attribute-no.c (+9/-0), ... and 1 more
--------------------------------------------------------------------------------

[d589636c2475] 2017-02-13 09:34:43 +0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cleanup: remove evaluate_arguments()'s unused argument

Was slightly confusing when reading some code.
Better to remove it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: evaluate.c (+2/-2)
--------------------------------------------------------------------------------

[0a367bdf4b13] 2017-01-27 08:53:08 -0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: make 'ignored_attributes[]' static

And so quiets a warning from sparse about an undeclared symbol
when running on its own code.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[ed73fd32736d] 2017-01-27 08:53:08 -0800
Author: Emily Maier <emily@emilymaier.net>
Subject: linearize: Emit C99 declarations correctly

Variables declared with C99 syntax inside a for statement should be
linearized in the loop top, rather than implicitly inside the loop body.

Signed-off-by: Emily Maier <emily@emilymaier.net>
Reviewed-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Tested-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: linearize.c (+4/-0)
--------------------------------------------------------------------------------

[2b2725ce7008] 2017-01-27 08:53:08 -0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add missing #include "char.h" to char.c

And so quiets a warning from sparse about undeclared
symbols when running on its own code.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: char.c (+1/-0)
--------------------------------------------------------------------------------

[c917c64e0eb6] 2017-01-27 08:53:08 -0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Fix type checking of variadic functions

When doing a type comparison between functions, in the varidicity part,
the base type of these functions (= their return type) is
wrongly used intead of their own type.

Fix this and add some tests showing this and others cases are
now OK

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
CC: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: evaluate.c (+1/-1), validation/function-redecl.c (+62/-0)
--------------------------------------------------------------------------------

[82d573cb15e3] 2017-01-27 08:53:08 -0800
Author: Lance Richardson <lrichard@redhat.com>
Subject: sparse: update __builtin_object_size() prototype

Sparse emits a large number of warnings for the linux kernel source
tree of the form:
    ./arch/x86/include/asm/uaccess.h:735:18: \
        warning: incorrect type in argument 1 (different modifiers)
    ./arch/x86/include/asm/uaccess.h:735:18:    expected void *<noident>
    ./arch/x86/include/asm/uaccess.h:735:18:    got void const *from

Fix by making the first parameter to __builtin_object_size()
type "const void *" instead of "void *", which is consistent with GCC
behavior (the prototype for this builtin in GCC documentation is evidently
incorrect).

Signed-off-by: Lance Richardson <lrichard@redhat.com>
Acked-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+1/-1)
--------------------------------------------------------------------------------

[9208e04972f2] 2017-01-27 08:49:23 -0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix mixup in "Handle SForced in storage_modifiers"

The patch used the wrong enum for the maximum size of the array.

I just noticed now, while doing some merging, that what have been commited
on the master tree is not the patch discussed here.
What have been commited is the same change but with 'CMax' (integer class)
while it was supposed to be 'SMax' (for the array of specifier).
The version on sparse-next is correct though.

Here is a patch fixing this:

Fixes: 1db3b627 ("Handle SForced in storage_modifiers")
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: parse.c (+3/-3)
--------------------------------------------------------------------------------

