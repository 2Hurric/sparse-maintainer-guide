================================================================================
Year: 2005 | Commits: 1540 | Contributors: 50
Insertions: +52248 | Deletions: -23294
================================================================================

[3199700ab667] 2005-12-31 13:13:52 -0800
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Make local declarations be statements of their own

This removes the list of symbols for block statements, and instead makes
a declaration be a statement of its own.

This is necessary to correctly handle the case of mixed statements and
declarations correctly, since the order of declarations and statements
is meaningful.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: compile-i386.c (+3/-1), dissect.c (+3/-1), evaluate.c (+9/-5), expand.c (+17/-16), expression.h (+1/-1), ... and 5 more
--------------------------------------------------------------------------------

[9ec2ac4c8860] 2005-12-31 11:32:36 -0800
Author: Alecs King <alecsk@gmail.com>
Subject: [PATCH] fix sparse warnings

sort.c:192:5: warning: mixing declarations and code
sort.c:234:2: warning: mixing declarations and code

Signed-off-by: Alecs King <alecsk@gmail.com>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: sort.c (+2/-3)
--------------------------------------------------------------------------------

[9ea30e2aea48] 2005-12-31 11:32:36 -0800
Author: Alecs King <alecsk@gmail.com>
Subject: [PATCH] fix a memory leak in pack_ptr_list

Free the last entry when the whole list gets empty.

Signed-off-by: Alecs King <alecsk@gmail.com>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: ptrlist.c (+1/-0)
--------------------------------------------------------------------------------

[c6e90aa8eb9c] 2005-12-20 09:29:32 -0800
Author: Oleg Nesterov <oleg@tv-sign.ru>
Subject: [PATCH] dissect.c

This patch adds dissect.{h,c} files to the sparse distribution.

From dissect.h:

	struct reporter
	{
		void (*r_symdef)(struct symbol*);

		void (*r_symbol)(unsigned mode, struct position*, struct symbol*);
		void (*r_member)(unsigned mode, struct position*, struct symbol*, struct symbol*);
	};

	extern void dissect(struct symbol_list*, struct reporter*);

dissect() walks the output of the sparse_file() and calls reporter's
callbacks.

->r_symdef() is called when the symbol (variable or function) is defined.

->r_symbol() - when the symbol is used in any way. The 'mode' parameter
denotes how this symbol was used. It is a bitmask of possible flags:

	FLAG:		Code example:

	U_R_VAL		return VAR;
	U_W_VAL		VAR = 0;

	U_R_PTR		return *VAR;
	U_W_PTR		*VAR = 0;

	U_R_AOF		const void *... = &VAR;
	U_W_AOF		memset(&VAR, ...);

->r_member() tracks the use of members of structures in the same way.

This patch also adds test-dissect.c, a simple and stupid example. It
prints the 'mode' parameter in a human readable format along with the
storage info, variable's name (or struct_name.member_name), and it's
type.

The 'mode' is dumped as a 3-letter string. The first letter denotes
AOF part, 2-nd - VAL, 3-rd - PTR.

	0			-> '-'
	U_R_xxx			-> 'r'
	U_W_xxx			-> 'w'
	U_R_xxx | U_W_xxx	-> 'm'

Example:
	$ cat -n T.c
	     1  int var;
	     2
	     3  static void func(void)
	     4  {
	     5          int *ptr;
	     6
	     7          ptr = &var;
	     8          *ptr = var;
	     9
	    10          var = *++ptr;
	    11  }

	$ ./test-dissect T.c

	FILE: T.c

	   1:5   g def  var                              int
	   3:13  s def  func                             void (  )( ... )
	   5:6   l def  ptr                              int *
	   7:2   l -w-  ptr                              int *
	   7:9   g m--  var                              int
	   8:3   l --w  ptr                              int *
	   8:9   g -r-  var                              int
	  10:2   g -w-  var                              int
	  10:11  l -mr  ptr                              int *

Note that '*ptr' does not add U_R_VAL flag, this is a feature, not a bug,
even if technically wrong.

dissect() does not check the code for correctness, for example:

	0 = X = Y;

gives this output:

   5:6   g -w-  X                                bad type
   5:10  g -r-  Y                                bad type

Again, X has no U_R_VAL, notabug.

Members of structures usage:

	task_t *tsk;
	tsk->parent->real_parent->pid++;

output:

   7:2   l --r  tsk                              struct task_struct [usertype] *
   7:5   g --r  task_struct.parent               struct task_struct *
   7:13  g --m  task_struct.real_parent          struct task_struct *
   7:26  g -m-  task_struct.pid                  int

dissect() tries to de-anonymize unnamed structures/unions:

     1  struct T {
     2          struct {
     3                  int x, y;
     4          } m;
     5  } t = {
     6          { undeclared }
     7  };

output:

   5:3   g def  t                                struct T
   5:3   g -w-  t                                struct T
   6:2   s -w-  T.m                              struct T:m
   6:4   s -w-  T:m.x                            int
   6:4   g -r-  undeclared                       bad type

When entire struct is overwritten, ->r_member() is called with mem == NULL,
this reported as struct_name.*, example:

	*new_vma = *vma;

output:

2028:5   l --w  new_vma                          struct vm_area_struct *
2028:13  g -w-  vm_area_struct.*                 struct vm_area_struct
2028:13  g -w-  pgprot_t.*                       struct pgprot_t
2028:13  g -w-  rb_node.*                        struct rb_node
2028:13  g -w-  vm_area_struct:shared.*          union vm_area_struct:shared
2028:13  g -w-  vm_area_struct:shared:vm_set.*   struct vm_area_struct:shared:vm_set
2028:13  g -w-  list_head.*                      struct list_head
2028:13  g -w-  raw_prio_tree_node.*             struct raw_prio_tree_node
2028:13  g -w-  list_head.*                      struct list_head
2028:16  l --r  vma                              struct vm_area_struct *

Function calls use U_R_PTR bit:

     5          func();
     6          pf = func;
     7          pf();

   5:2   g --r  func                             void (  )( ... )
   6:2   l -w-  pf                               void ( * )( ... )
   6:7   g r--  func                             void (  )( ... )
   7:2   l --r  pf                               void ( * )( ... )

BUGS:

1. dissect() confuses array-in-container with a pointer:

     3          struct T { int ary[]; } t;
     4
     5          t.ary[0] = 0;

output:

   5:2   l -r-  t     /* BUG, should be -w- */   struct T
   5:3   s -w-  T.ary                            int [0]

2. It can't detect the case when the address is taken only for writing,
eg: *(&i + 1) = 0, so U_W_AOF always implies U_R_AOF.

3. It does not support "flat" initializers without braces:

     3          struct O {
     4                  struct I {
     5                          int x, y;
     6                  } a, b;
     7          };
     8
     9          struct O o1 = { 1, 2, 3 };

buggy output:

   9:11  l -w-  o1                               struct O
   9:18  s -w-  O.a                              struct I
   9:21  s -w-  O.b                              struct I
   9:24  s -w-  O.?                              bad type

This is ok:

    11          struct O o2 = { { 1 }, .b = { .y = 0 } };

  11:11  l -w-  o2                               struct O
  11:18  s -w-  O.a                              struct I
  11:20  s -w-  I.x                              int
  11:30  s -w-  O.b                              struct I
  11:37  s -w-  I.y                              int

4. The implementation is far from perfect. It was really done
in "add some code + printf and see what happens" manner, without
studying the sources first. However I beleive it may be useful
for others, that is why I am posting it.

Signed-off-by: Oleg Nesterov <oleg@tv-sign.ru>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: Makefile (+7/-2), dissect.c (+574/-0), dissect.h (+40/-0), test-dissect.c (+95/-0)
--------------------------------------------------------------------------------

[9d16f0f6e9a6] 2005-12-20 09:29:32 -0800
Author: Oleg Nesterov <oleg@tv-sign.ru>
Subject: [PATCH] introduce __sparse() function

This patch adds __sparse() function for those users which
don't need evaluate.c (see the next patch).

Without this patch it is not possible to link test-dissect
statically, it has to redefine evaluate_symbol_list().

Signed-off-by: Oleg Nesterov <oleg@tv-sign.ru>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: lib.c (+9/-2), lib.h (+1/-0)
--------------------------------------------------------------------------------

[b8aad4c6f9fb] 2005-12-20 09:29:32 -0800
Author: Oleg Nesterov <oleg@tv-sign.ru>
Subject: [PATCH] fix "wrong" NS_STRUCT symbol->pos

NS_STRUCT symbol gets it's ->pos from alloc_symbol(), it
could be called when sparse sees struct's forward declaration.

This patch ensures that ->pos identifies position where this
struct/union is actually defined.

Signed-off-by: Oleg Nesterov <oleg@tv-sign.ru>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: parse.c (+4/-1)
--------------------------------------------------------------------------------

[8bab495ee706] 2005-11-27 17:40:51 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] eliminate elif_ignore, fix handling of unterminated #if

No need to bother with stack; we can just keep # tokens from #if...  and
use _those_ as a stack instead.  struct stream gets a pointer to the
current #if..., checks for #elif/#else/#endif out of place become simple
if (!stream->top_if) and stream->ifndef becomes a pointer to token
instead of an integer (pointer to token in that stack instead of nesting
depth).

We lose elif_ignore[] array, if_nesting and stream->nesting (nothing
cares of those anymore) and get sane handling of unterminated #if for
free - instead of reporting the location of the last #if on depth 0
(very likely - in another file and having an #endif) we can give
location of the #if that really lacks #endif.

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: pre-process.c (+45/-55), token.h (+5/-2)
--------------------------------------------------------------------------------

[d9257d98b4f4] 2005-11-27 17:40:51 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] lookup_macro() should be static

Not used anywhere else.

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: pre-process.c (+1/-1)
--------------------------------------------------------------------------------

[7be06dc237e6] 2005-11-27 17:40:51 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] check for !token in handle_preprocessor_line() should be eof_token(token)

IOW, handling of #<newline> had been broken since way back...

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: pre-process.c (+1/-1)
--------------------------------------------------------------------------------

[ccdfdab9f985] 2005-11-27 17:40:51 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] Doh...

Adding description to testcase is a good thing, but doing that without
checking that testcase is still OK...  preprocess16.c was not - I've
added description under #if 0 in there, but forgot to comment it out.
Funny what a few ' do to tokenizer outside of comment...

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: validation/preprocessor16.c (+2/-0)
--------------------------------------------------------------------------------

[eac4d539b83e] 2005-11-27 17:40:51 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] fixed stream->protect handling

New mechanism: we introduce new fields of struct stream - ifndef and
dirty.  The former is the nesting level of ifndef that currently
protects us, or 0 if there's none.  The latter is a boolean - "do we
ignore new non-empty stuff shows up right now?".

There are five states, more or less matching the old ->constant ones:
 1) nothing - dirty = 0, ->protect = NULL, ->ifndef = 0.
 2) candidate - dirty = 0, ->protect = <ident>, ->ifndef > 0.
 3) checking - dirty = 0, ->protect = <ident>, ->ifndef = 0.
 4) maybe - dirty = 1, ->protect = <ident>, ->ifndef > 0.
 5) not - dirty = 1, ->protect = NULL, ->ifndef = 0.

Rules:
 - any directive except #ifdef, #ifndef, #else, #endif, #<newline> is
   considered dirty.
 - any non-directive (#<not a directive name>...) is considered dirty
 - any tokens in lines that do not begin with # are considered dirty
 - #if[n]def with syntax errors is considered dirty.
 - any nesting errors => stream is non-constant.
 - any dirty material not under ifndef => stream is non-constant.
 - the outermost ifndef at the first time we run into dirty material
   will be the candidate for stream protector.
 - any subsequent dirty material not under ifndef <protector> => stream
   is non-constant.

We start in "nothing".  Transitions:
 - "nothing": dirty material => "not", see ifndef => "candidate"
 - "candidate": dirty material => "maybe", leave that ifndef => "nothing"
 - "maybe": dirty material => "maybe", leave that ifndef => "checking"
 - "checking": dirty material => "not", same ifndef => "maybe
 - "not": they check in, but they don't check out...

Seeing a nesting error (#else/#elif/#endif out of place/order or
unclosed #if...  in the end) gets us to "not", no matter which state we
were in.

That's it.  Implementation is actually pretty simple and
straightforward; it's less scary than the description above.

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: pre-process.c (+46/-44), token.h (+2/-0), validation/preprocessor20.c (+4/-0), validation/preprocessor20.h (+6/-0)
--------------------------------------------------------------------------------

[7b894af8a590] 2005-11-27 17:40:51 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] fixed handling of out-of-place #elif/#else/#endif

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: pre-process.c (+19/-10)
--------------------------------------------------------------------------------

[d14d954b0a2c] 2005-11-27 17:40:51 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] beginning of #include protection rewrite: cleanup

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: pre-process.c (+31/-46), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[3b5cfe659c26] 2005-11-27 17:40:51 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] fix places that didn't free preprocessor line for no reason.

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: pre-process.c (+37/-30), validation/preprocessor19.c (+5/-0)
--------------------------------------------------------------------------------

[e5d21dee95a2] 2005-11-27 17:40:51 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] taking free_preprocessor_line() to caller of ->handler()

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: pre-process.c (+40/-39)
--------------------------------------------------------------------------------

[12c4db74356a] 2005-11-27 17:40:51 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] remove bogus double warning on #define/#undef syntax

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: pre-process.c (+2/-2), validation/preprocessor18.c (+3/-0)
--------------------------------------------------------------------------------

[a5e1e8c5ca4a] 2005-11-27 17:40:51 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] saner handling of #if[n]def syntax errors

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: pre-process.c (+28/-9), validation/preprocessor17.c (+7/-0)
--------------------------------------------------------------------------------

[47909e0f6808] 2005-11-27 17:40:51 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] remove true_nesting, turn if_nesting into a variable

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: pre-process.c (+4/-13)
--------------------------------------------------------------------------------

[aa163fa6869f] 2005-11-27 17:32:24 -0800
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] Fix member offset calculation

member dereferencing didn't examine the parent type, as consequence the
member offset were never calculated.

[ Note: we _used_ to do eager examination of all types whenever we saw a
  pointer, but as of commit 017034ed49eb0c0fdf91a4109faedf389c81fa9b we
  only do it when necessary, and this case had been missed.   - Linus ]

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+1/-0)
--------------------------------------------------------------------------------

[269bcb9b9334] 2005-11-25 16:16:32 -0800
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] avoid a crash caused by the phisrc OP_COPY with a NULL ->def.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: example.c (+1/-1)
--------------------------------------------------------------------------------

[0947976f7481] 2005-11-25 16:16:32 -0800
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] remove old comment

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: unssa.c (+0/-3)
--------------------------------------------------------------------------------

[3ff22243cbc3] 2005-11-25 16:16:32 -0800
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] unssa: update the liveness info.

I'm not 100% sure it is done correctly, but at least it gives
sensible results.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: unssa.c (+20/-0)
--------------------------------------------------------------------------------

[f97e874f2546] 2005-11-25 16:14:12 -0800
Author: Al Viro <viro@ftp.linux.org.uk>
Subject: [PATCH] Made __GNUC__ et.al. weak defines, so that we could override them with -D

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: lib.c (+3/-3)
--------------------------------------------------------------------------------

[883ecae9da46] 2005-11-22 22:41:22 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] noderef is a qualifier

... and should be in MOD_PTRINHERIT

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[50f66bdbdbc3] 2005-11-22 22:41:22 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] shut up the bogus warnings about the #if'ed-out section

Standard requires much more relaxed treatment of the groups that
are #if...'ed out.  We used to generate bogus warnings there; fixed,
testcase added.

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: pre-process.c (+9/-4), validation/preprocessor16.c (+19/-0)
--------------------------------------------------------------------------------

[16427fdb2fc7] 2005-11-22 22:41:22 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] no need to special-case comma after ##

... normal execution will do exactly the same on the next iteration;
case is damn rare (it's _not_ the GNU kludge - there we have ,##) and
it's not worth an extra check.

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: pre-process.c (+0/-2)
--------------------------------------------------------------------------------

[7e58336770b4] 2005-11-22 19:35:07 -0800
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: example: OP_COPY must destroy any old pseudo state

Toto, I have a feeling We're not in SSA land any more.

(Not that it really helps.  The example compiler not only had SSA
assumptions, it also depended on liveness information and insn->def
state, both of which are destroyed by the un-ssa phase.  So this is
really a small bandage around a much larger problem, and doesn't really
fix anything fundamental).

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: example.c (+24/-0)
--------------------------------------------------------------------------------

[3108192d73f1] 2005-11-22 18:55:39 -0800
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Make the "example" compiler use the new unssa() phase

Yeah, this probably breaks the example in a totally _different_ way than
it was broken before ;)

But it's certainly no worse than before. At least not much.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: example.c (+14/-54)
--------------------------------------------------------------------------------

[6690a7f7a4fb] 2005-11-22 18:34:51 -0800
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] Rewrite of unssa().

This is an almost total rewrite of unssa().

It work now in two passs:

 - first all the phi nodes are replaced by a copy of a new temporary to
   the same target as the phi node.
 - then, all the phisrc are replaced by one or several copies to the
   temporaries just created, one for each phi node the phisrc feed.

It now works on my small tests and on the sparse source files and seems
also work well against the kernel sources.

There remains (at least) two problems:
 - I need to update the bb's needs and defines.
 - In some files, a few phisrc remains but they have an empty phi_users
   and shouldn't have any effect.  Maybe they come from dead basic
   blocks?

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: unssa.c (+62/-58)
--------------------------------------------------------------------------------

[ea92e467f57d] 2005-11-22 08:43:02 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] fix of compound literals on inlining

We need to create a copy of cast_type when we are copying a combination
of EXPR_CAST and EXPR_INITIALIZER (i.e. a compound literal).

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: inline.c (+9/-0), validation/inline_compound_literals.c (+18/-0)
--------------------------------------------------------------------------------

[a046c1b92025] 2005-11-22 08:43:02 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] fix treatment of EXPR_COMMA by show_expression()

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: show-parse.c (+8/-1)
--------------------------------------------------------------------------------

[0c08f0a1a8e4] 2005-11-22 08:43:02 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] new flag - Wone-bit-signed-bitfield

Make the warnings about one-bit signed bitfields conditional; default is
the old behaviour

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: lib.c (+2/-0), lib.h (+1/-0), parse.c (+1/-1)
--------------------------------------------------------------------------------

[c3e9659bfaac] 2005-11-22 08:43:02 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] new flag - -Wdecl

Make "should it be static?" warnings conditional on a new flag (-Wdecl);
default is to be quiet.

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+2/-0), lib.c (+2/-0), lib.h (+1/-0)
--------------------------------------------------------------------------------

[2cf627a8ad38] 2005-11-22 08:43:02 -0800
Author: Al Viro <viro@zeniv.linux.org.uk>
Subject: [PATCH] missing builtin - memcmp()

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: lib.c (+1/-0)
--------------------------------------------------------------------------------

[822d3b1a222b] 2005-11-22 08:23:33 -0800
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: When taking the address of a symbol, fix up the pointer type

The "volatile" and "const"'ness of the symbol will become part of the
pointer type, but we don't want to keep around things like "pointer to
unsigned", so strip that part off.

This still keeps other attributes, like "pointer to 'static'". Useful?
Probably not. I'll have to think about it.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+4/-2)
--------------------------------------------------------------------------------

[4c520e1ad243] 2005-11-21 17:55:24 -0800
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] Add a function to translate the SSA form back to normal form.

For now, it use a simple method but which introduces a lot more copies
than necessary. Can be fixed later.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: .gitignore (+1/-0), Makefile (+5/-2), linearize.h (+1/-0), test-unssa.c (+81/-0), unssa.c (+116/-0)
--------------------------------------------------------------------------------

[ca682df2d733] 2005-11-21 17:55:24 -0800
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] Add a new opcode: OP_COPY.

This is needed to translate SSA back to normal form.

Maybe we should split this in two distinct ops: The first ones
correspond to the old OP_PHISOURCE (but if the same phisrc feed several
phi-nodes, we need sevarel distinct copy instruction); at this stage
they are the only instruction that can define a pseudo in multiple
places.  The other ones being the "normal" copies.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: linearize.c (+5/-0), linearize.h (+3/-0)
--------------------------------------------------------------------------------

[b85ec4bb7f5b] 2005-11-20 15:07:19 -0800
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Simplify some more instructions

Constant casts, and some boolean ops with constants.

Files: simplify.c (+28/-2)
--------------------------------------------------------------------------------

[027cbf98ff7a] 2005-11-20 13:47:37 -0800
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Remove totally bogus phi-source liveness thing.

Thanks to Luc Van Oostenryck for pointing out a trivial example of
something that does totally the wrong thing with that code.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: liveness.c (+0/-13)
--------------------------------------------------------------------------------

[464710af3977] 2005-11-19 12:57:57 -0800
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Evaluate expressions fully when doing type comparisons on case statements

When we check the case statement type against the type of the switch
statement it is associated with, we need to make sure that the case
expression has been fully type-evaluated.

It should have happened automatically as we evaluate the switch
statement, but if that has not happened, we'd follow a NULL pointer due
to the unevaluated type.

Thanks to Adrian Bunk for reporting a segfault for reiser4

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+8/-6)
--------------------------------------------------------------------------------

[a415de4790b6] 2005-11-16 17:02:06 -0800
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Fix up stupid thinko in K&R parameter parsing.

We can have multiple parameters declared with the same base declaration.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: parse.c (+26/-22)
--------------------------------------------------------------------------------

[c0d6cdd45edf] 2005-11-16 14:32:15 -0800
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Re-name "error()" function to "sparse_error()"

Mitesh Shah (and others) report that broken libc's will have their own
"error()" that the sparse naming clashes with.

So use a sed-script to rewrite all the occurrences.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+47/-47), expand.c (+5/-5), expression.c (+4/-4), inline.c (+1/-1), lib.c (+3/-3), ... and 6 more
--------------------------------------------------------------------------------

[617f2d7fd96b] 2005-11-16 14:22:46 -0800
Author: Mitesh Shah <mshah@teja.com>
Subject: [PATCH] skip already evaluated symbols

This avoids evaluating already evaluated symbols.  I think if the symbol
is already evaluated once, there is no change in the conditions so it
should not be evaluated again.  This helps when we are evaluating for
multiple files.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+3/-0), symbol.h (+2/-1)
--------------------------------------------------------------------------------

[3d138c906dc4] 2005-11-16 14:18:25 -0800
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Fix K&R argument scoping

The K&R argument parsing was a quick hack, and horribly buggy.  Because
it used external_declaration() to parse the argument, it bound the name
of the argument at totally the wrong scope.

Noted by Mitsh Shah.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: parse.c (+8/-1)
--------------------------------------------------------------------------------

[0d403a661aa0] 2005-11-16 14:16:48 -0800
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Integer promotion: leave sufficiently large integer types as themselves

No need to turn an "enum" into an "int" if it's already the right size -
the longer we can keep the full type information, the better.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+13/-4)
--------------------------------------------------------------------------------

[eeeeffee439e] 2005-11-03 16:04:03 -0800
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Make switch/case statements check type compatibility

Problem noted by Zach Brown

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+41/-5)
--------------------------------------------------------------------------------

[f49bd999bd27] 2005-11-03 08:31:42 -0800
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Cast all enum values to the final type

The type of an enum is determined by the type of all of its entries,
which means that while we may parse it in one type, it might end up with
another type in the end.  We used to just switch the types around, but
that didn't properly upgrade the actual values to the new type.

The trivial fix is to just keep a list of entries around, and then go
back and cast the values at the end.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: parse.c (+22/-0)
--------------------------------------------------------------------------------

[51d3e72397c1] 2005-11-03 08:17:28 -0800
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Make sure we keep enum values in a sufficiently large type for parsing

We do enum type handling in two passes: one while parsing the values,
and then afterwards we determine the final type that depends on the
range of the results.

Make sure that the intermediate stages keep the intermediate types big
enough to cover the full range.

(The final type-casting is also buggy, but that's a separate issue)

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: parse.c (+17/-2)
--------------------------------------------------------------------------------

[e580bd78a390] 2005-11-02 07:42:53 -0800
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Add ".gitignore" file

[Auto-summary] Modifies: .gitignore. Changes: +17/-0 in 1 file(s)

Files: .gitignore (+17/-0)
--------------------------------------------------------------------------------

[9e90d65e2527] 2005-11-02 07:40:19 -0800
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Handle symbols from "-include" file too

Noted by Mitesh Shah

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: check.c (+1/-1), compile.c (+1/-1), example.c (+1/-1), lib.c (+7/-5), lib.h (+1/-1), ... and 3 more
--------------------------------------------------------------------------------

[fc8a7aa2be7e] 2005-09-30 08:18:24 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Make sure to be more careful about marking symbols assigned

Follow offset and cast expressions down etc, instead of just looking at
the type we assigned.

Files: evaluate.c (+35/-2)
--------------------------------------------------------------------------------

[0a42f4daab1f] 2005-09-26 20:01:45 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Simplify constant array (or structure) dereferences further

This shares more of the code with the regular constant symbol
dereference, and in the process should fix the case of offset zero.

Files: expand.c (+46/-39)
--------------------------------------------------------------------------------

[d2f2887a5d35] 2005-09-26 19:24:11 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Teach dereference expansion to look into constant array dereferences

It's really the same thing as a constant variable.

Files: expand.c (+53/-12)
--------------------------------------------------------------------------------

[c66ae1d7d99d] 2005-09-24 10:41:58 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Do stupid and crappy CSE on casts.

It's better than nothing, but I need to re-do cast linearization some
day.  Right now we squirrell away the whole original type, but the fact
is, we only need to save away a few bits of "type of cast".

We need to know if it's sign-extending, and whether the source or
destination are floating point values.  And the source size, of course.
But we don't really need to know the detailed original type.

Oh, well. This makes at least trivial things look much better.

Files: cse.c (+25/-0)
--------------------------------------------------------------------------------

[32b088d20cc8] 2005-09-24 10:31:14 -0700
Author: Atsushi Nemoto <anemo@mba.ocn.ne.jp>
Subject: [PATCH] handle -G x switch for mips

When I ran make C=1 on linux-mips kernel, I got:

  CHECK   /home/cvs/linux-mips/scripts/mod/empty.c

No such file: 0

If I ran make C=1 V=1, I got:

  sparse -D__linux__ -D__mips__ -D_MIPS_SZLONG=32 -D__PTRDIFF_TYPE__=int
	-D__MIPSEL__ -nostdinc -isystem /usr/lib/gcc/mipsel-linux/3.4.4/include
	-Wp,-MD,scripts/mod/.empty.o.d -nostdinc
	-isystem /usr/lib/gcc/mipsel-linux/3.4.4/include
	-D__KERNEL__ -Iinclude -Iinclude2 -I/home/cvs/linux-mips/include
	-I/home/cvs/linux-mips/scripts/mod -Iscripts/mod -Wall -Wundef
	-Wstrict-prototypes -Wno-trigraphs -fno-strict-aliasing -fno-common
	-ffreestanding -O2 -fomit-frame-pointer -I/home/cvs/linux-mips/
	-I /home/cvs/linux-mips/include/asm/gcc -G 0 -mno-abicalls
	                                        ^^^^
	-fno-pic -pipe -finline-limit=100000 -mabi=32 -march=r3000
	-Wa,-32 -Wa,-march=r3000 -Wa,-mips1
	-I/home/cvs/linux-mips/include/asm-mips/mach-dec
	-Iinclude/asm-mips/mach-dec
	-I/home/cvs/linux-mips/include/asm-mips/mach-generic
	-Iinclude/asm-mips/mach-generic -DKBUILD_BASENAME=empty
	-DKBUILD_MODNAME=empty /home/cvs/linux-mips/scripts/mod/empty.c ;

No such file: 0

It seems sparse is confused by '-G 0' option.

This fixes it.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: lib.c (+9/-0)
--------------------------------------------------------------------------------

[a3f8b120676d] 2005-09-22 15:47:26 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Turn the "incorrect type" error back into a warning

It's usually a wrong pointer type, wrong address space, or similar.

If it's a _really_ wrong type that simply can't be converted to the
right one (like trying to pass a structure instead of a scalar), it
would be an error, but we don'Ã¤know that at this point.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[2660f22e954d] 2005-09-22 11:37:53 -0700
Author: Mitesh Shah <mshah@teja.com>
Subject: [PATCH] replaced warnings with errors.

This replaceq calls to warning() with error() at places where (I think)
the gcc reports an error.  Also added a global variable die_if_error
which is set if there is one or more errors.  If someone wants to stop
processing further, can check for the variable.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+44/-44), expand.c (+4/-4), expression.c (+4/-4), inline.c (+1/-1), lib.c (+5/-3), ... and 4 more
--------------------------------------------------------------------------------

[02888be1a1a5] 2005-09-15 10:42:45 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Add various declarations for more builtin functions

Yeah, this is not the way to do them (we should have _real_ builtin
declarations instead of parsing them to create them), but this is the
simple solution to gcc-aware header files.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: lib.c (+10/-1)
--------------------------------------------------------------------------------

[3ab501cf135b] 2005-09-15 10:31:18 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Make sure that when we define __OPTIMIZE[_SIZE]_ we define it to something

It needs to have a value, since otherwise something like

	#if __OPTIMIZE__ > 1

breaks.

Files: lib.c (+2/-2)
--------------------------------------------------------------------------------

[6aaf20931568] 2005-09-14 13:57:36 -0700
Author: Sam Ravnborg <sam@ravnborg.org>
Subject: [PATCH] add support for -imacros

Gcc has two ways to specify on the commandline files
to be read before processign normal files:

 "-include file" will include file in ordinary way.

 "-imacros file" will include file but do not generate any output

gcc will include files specified with -imacros before files specified
with -include.

This adds some very basic support for -imacros, just duplicating the
code used for -include.

To obtain the real functionality we would have to build a list of
filenames specified, and process all files specifed with -imacros before
files specified with -include.

In -mm a patch is now included that uses -imacros, so applying following
patch will let us stay compatible with kernel source.  The last bit
deletes two references from lib.h that are there for no good reason.

Signed-off-by: Sam Ravnborg <sam@ravnborg.org>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: lib.c (+9/-0), lib.h (+0/-2)
--------------------------------------------------------------------------------

[46668905e465] 2005-09-10 15:33:13 -0700
Author: Alexey Dobriyan <adobriyan@gmail.com>
Subject: [PATCH] sparse: add __GNUC_PATCHLEVEL__

Fix logs flooding on sparc:

include/asm/bug.h:12:46: warning: undefined preprocessor identifier '__GNUC_PATCHLEVEL__'

Files: lib.c (+3/-0)
--------------------------------------------------------------------------------

[6bd4c464c6b0] 2005-09-09 14:07:54 -0700
Author: viro@ZenIV.linux.org.uk <viro@ZenIV.linux.org.uk>
Subject: [PATCH] More address space checking

* generate a warning when we cast _between_ address spaces (e.g.  cast
   from __user to __iomem).

 * optional (on -Wcast-to-as) warning when casting _TO_ address space
   (e.g.  when normal pointer is cast to __iomem one - that caught a lot
   of crap in drivers).  casts from unsigned long are still OK, so's
   cast from 0, so's __force cast, of course.

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+48/-29), lib.c (+2/-0), lib.h (+1/-0)
--------------------------------------------------------------------------------

[f73ca60933f0] 2005-09-09 11:13:56 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Warn about undefined preprocessor symbols at expansion time, not parse time

This means that we can do

	#if defined(TOKEN) && TOKEN > 1

and we will _not_ warn even with -Wundef, since the "TOKEN > 1" test
will never even be expanded if TOKEN isn't defined.

Al Viro gets credit for the algorithm changes, I just did the actual coding.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: expand.c (+8/-0), expression.c (+9/-0), pre-process.c (+1/-3), symbol.c (+1/-0), symbol.h (+2/-0), ... and 1 more
--------------------------------------------------------------------------------

[7a312ea52f7b] 2005-09-09 10:47:42 -0700
Author: viro@ZenIV.linux.org.uk <viro@ZenIV.linux.org.uk>
Subject: [PATCH] Fix address space ordering problem

We used to get "__user void *" wrong - it ended up with address space 0
instead of address space 1.

What happens is actually pretty simple - we get address_space(1) handled
in declaration_specifiers(), which sets ctype->as to 1.  Then we see
"void" and eventually get to

                        ctype->base_type = type;
                }

                check_modifiers(&token->pos, s, ctype->modifiers);
                apply_ctype(token->pos, &thistype, ctype);

with thistype coming from lookup for "void".  And that, of course, has
zero ->as.  Now apply_ctype merrily buggers ctype->as and we have 0...

So AFAICS proper fix for sparse should be to check thistype->as to see
if it really has any intention to change ->as.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: parse.c (+2/-1)
--------------------------------------------------------------------------------

[5240b8c76613] 2005-08-17 12:58:51 -0700
Author: Oleg Nesterov <oleg@tv-sign.ru>
Subject: [PATCH] enum: improve error messages

In case of malformed enum definition:

	enum E {};

the error will be reported from examine_symbol_type(),
this could be very confusing.

Signed-off-by: Oleg Nesterov <oleg@tv-sign.ru>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: parse.c (+3/-1), symbol.c (+0/-5)
--------------------------------------------------------------------------------

[d9adc8fd183e] 2005-08-17 12:58:51 -0700
Author: Oleg Nesterov <oleg@tv-sign.ru>
Subject: [PATCH] enum: fix sparse segfault with incomplete enum

Incomplete enum type has ->ctype.base_type == NULL, so almost any
usage of it segfaults in is_int_type(), example:

	enum E *p;
	*p == 0;

It is not possible (and wrong) to fix only the is_int_type(), we
also need valid ->base_type in integer_promotion, get_sym_type, etc.

This patch also "fixes" false error message:

The code:

	extern enum E e;
	static void *p = &e;

output:
	enum.c:1:13: warning: invalid enum type

Signed-off-by: Oleg Nesterov <oleg@tv-sign.ru>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: parse.c (+7/-1), symbol.c (+1/-1)
--------------------------------------------------------------------------------

[3b75463b4cf2] 2005-08-15 10:43:30 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Make 'cgcc' work at least half-way better

Mark it executable, and use "sparse" instead of "check" by default,
since that's what sparse gets installed as.

Files: cgcc (+1/-1)
--------------------------------------------------------------------------------

[ba1f7076aeb9] 2005-08-15 10:42:39 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Fix parsing of top-level asm statements

This also simplifies the code - don't bother to make it look like a real
function.

Bug pointed out by Oleg Nesterov.

Files: parse.c (+4/-6)
--------------------------------------------------------------------------------

[3ceaafeaea1d] 2005-08-15 10:25:38 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Add __OPTIMIZE[_SIZE]__ predefines

As noted by Arnaldo Carvalho de Melo, some of the glibc header files
expect these to be defined when compiling with optimization.

Files: lib.c (+21/-1), lib.h (+1/-1)
--------------------------------------------------------------------------------

[f357e278306a] 2005-08-15 09:22:49 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Clean up iterator handling

Instead of having a special case for "post_condition == pre_condition",
make a NULL post_condition mean that it's the same as the pre-condition.
That's how while/for loops work anyway.

This avoids the double warnings for conditionals that Oleg Nesterov
noted.

Files: linearize.c (+3/-2), parse.c (+2/-2)
--------------------------------------------------------------------------------

[d0d20047fb01] 2005-08-14 10:58:43 -0700
Author: Oleg Nesterov <oleg@tv-sign.ru>
Subject: [PATCH] de-anonymize typedefs

Code:
	atomic_t v;
	v.xxxx = 0;

without patch:
	warning: no member 'xxxx' in struct <unnamed>

with patch:
	warning: no member 'xxxx' in struct atomic_t

Actually I want this patch because I started the simple libsparse
client, and I don't see the simple way to resolve SYM_STRUCT's
name in typedef case.

Signed-off-by: Oleg Nesterov <oleg@tv-sign.ru>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: parse.c (+6/-2)
--------------------------------------------------------------------------------

[71c2abb49261] 2005-08-11 15:14:53 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: Make delete_last_instruction() use the new undo_ptr_list_last() fn

Not only are we always going to replace the last instruction with
something else, we can't afford to free the ptrlist, because the caller
is usually walking over it in a loop.

Files: lib.h (+1/-1)
--------------------------------------------------------------------------------

[f39e2bb1cd83] 2005-08-11 15:12:04 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: Add 'undo_ptr_list_last()' helper function

It's like 'delete_ptr_list_last()', except it doesn't de-allocate the
ptrlist block that it removes the last entry from.  Useful when you know
you're going to add things back (ie basic block tail rewriting), and
when you can't afford to de-allocate the ptrlist because you're in a
loop.

Files: ptrlist.c (+21/-0), ptrlist.h (+1/-0)
--------------------------------------------------------------------------------

[c8b9ce8f1ef2] 2005-08-06 09:07:50 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Have more bits for "stream number" in "struct pos"

Now that we do multiple files at a time, the stream numbers grow
alarmingly.

Files: lib.h (+2/-2)
--------------------------------------------------------------------------------

[264c923c8bb1] 2005-08-03 18:50:01 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Don't overwrite built-in macros when redefining them.

This means that we may have both an "invisible" macro _and_ a visible
one in scope, so we need to be a bit more careful about lookup.

We always look up the topmost one (either visible or invisible), and if
it's invisible, that means it is undefined (a builtin macro was first
re-defined, and then that redefinition was undefined).

Files: pre-process.c (+19/-5)
--------------------------------------------------------------------------------

[2c36119df5a9] 2005-08-03 18:36:00 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Update the calling interface to "sparse()".

Start off with

	sparse_initialize(argc, argv);

which will return the number of filenames found.  You can then use that,
or just check if *argv is NULL in a loop like

	while (*argv)
		list = sparse(argv);

where you get the declaration list for each file in turn.

Files: check.c (+3/-1), compile-i386.c (+4/-0), compile.c (+13/-12), example.c (+5/-2), lib.c (+40/-28), ... and 10 more
--------------------------------------------------------------------------------

[29d1ef3aac73] 2005-08-03 15:22:51 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Get closer to parsing multiple files correctly.

This actually seems to do some sane things when parsing even complex
multiple files.  In particular, it actually works right when used for
multiple kernel C files together in limited testing.

Files: lib.c (+63/-24), parse.c (+1/-14), parse.h (+1/-1)
--------------------------------------------------------------------------------

[c1d5f8c18c3e] 2005-08-03 15:17:19 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Add function to "protect" allocations from being dropped later

Useful for the initial (shared) token allocations: we do want to drop
the per-file tokens once they aren't needed any more, but we don't want
to protect the shared global token allocations.

Files: allocate.c (+5/-0), allocate.h (+8/-2)
--------------------------------------------------------------------------------

[8cea1f0d96b6] 2005-08-02 20:39:44 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Don't free expressions after preprocessing

It used to be that we only had pre-processor expressions at that point,
but now that we can pre-process multiple files, we end up having
expressions of previous files too, and we mustn't free those..

There aren't enough pre-processor expressions around to be worth
worrying about the memory usage anyway.

Files: pre-process.c (+2/-1)
--------------------------------------------------------------------------------

[972609f0d10e] 2005-08-02 20:34:24 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Add DEBUG mode, which enables various expensive debug options

Right now it only makes 'blob_free()' mprotect(PROT_NONE) the buffer it
free's instead of unmapping it, but that's already quite useful for
figuring out when we've freed up memory that we later end up using after
all.

In particular, the multi-file mode ends up having different lifetime
rules for the various objects, so it introduced some nasty MM bugs.
With -DDEBUG we get some nice SIGSEGV's rather than just strange memory
corruption.

Files: Makefile (+5/-0), compat/mmap-blob.c (+4/-0)
--------------------------------------------------------------------------------

[ac8ce3636d83] 2005-08-02 20:03:51 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Make types have file scope, not global scope

Only actual global variables have global scope.

Files: scope.c (+3/-3), symbol.c (+6/-4)
--------------------------------------------------------------------------------

[1feaae1ecd79] 2005-08-02 17:27:37 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Make "sparse()" handle multiple input files on the command line

Pretty bogus right now, but at least it does more of the argument
parsing, and the infrastructure is there to handle multiple files.

It even works, sometimes.  Mostly not, though - since it will actually
use global scope for global types, and complain about redefinitions of
the same struct when it sees ti in two different compilation units.

Files: lib.c (+65/-48)
--------------------------------------------------------------------------------

[89f32d3da8d2] 2005-08-02 17:23:23 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Make macros have file scope

Also, macros are special: they can be removed out of scope with #undef,
which makes them slightly more interesting when we exit the scope.

Files: scope.c (+11/-1), scope.h (+2/-0), symbol.c (+2/-0)
--------------------------------------------------------------------------------

[d2b60d1311f1] 2005-08-02 17:22:00 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: When dropping all allocations, clear the freelist too

Otherwise we're in trouble when we try to use a "free" entry that
already got its backing store removed.

Files: allocate.c (+1/-0)
--------------------------------------------------------------------------------

[8f284fe35a97] 2005-08-02 16:00:42 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Start work on proper scoping with multiple files

Brought on by a query from Mitesh Shah.  I claimed it should be easy,
let's see if I was full of sh*t (this is just some very early
infrastructure, not the whole thing by any means!)

Files: lib.c (+1/-0), scope.c (+17/-4), scope.h (+8/-6)
--------------------------------------------------------------------------------

[121b8d7d9d8e] 2005-07-11 09:23:29 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Don't warn about "nocast" warnings that only change "const"ness.

Noted by Alexey Dobriyan <adobriyan@gmail.com>

Files: evaluate.c (+20/-4)
--------------------------------------------------------------------------------

[be801aac8762] 2005-07-03 09:49:50 -0700
Author: Linus Torvalds <torvalds@g5.osdl.org>
Subject: Add "__builtin_offsetof()" to work with newer gcc's

It just expands to the normal offsetof definition

Files: lib.c (+1/-0)
--------------------------------------------------------------------------------

[7235b9d6dc6b] 2005-06-30 08:46:43 -0700
Author: Michael S. Tsirkin <mst@mellanox.co.il>
Subject: [PATCH] FAQ: add sparse git repository

No idea whether the bitkeeper repository is still updated.
Add sparse git repository to the FAQ.

Signed-off-by: Michael S. Tsirkin <mst@mellanox.co.il>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: FAQ (+1/-0)
--------------------------------------------------------------------------------

[2cec905cb5d1] 2005-06-27 15:30:03 -0700
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] makes some needlessly global code static

This makes some needlessly global code static so that sparse don't
complain when self checking.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: compile-i386.c (+7/-7), linearize.c (+6/-6), storage.c (+2/-2)
--------------------------------------------------------------------------------

[409eab7c1a8f] 2005-06-27 15:30:03 -0700
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] remove multi-inclusion guard from target.c

This removes the multi-inclusion guard present in target.c (coming, I
suppose, from target.h from which it was copied).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: target.c (+0/-5)
--------------------------------------------------------------------------------

[fbaf5e4bc98b] 2005-06-26 17:21:18 -0700
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] avoid segfault in add_asm_output() after a parse error in asm statement

Avoid deferencing a null pointer in add_asm_output() after a parse error
in asm statement.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[e2559ab1f5d4] 2005-06-26 17:21:18 -0700
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] avoid segafult after parse errors in casts

Avoid deferencing a null pointer after parse errors in casts.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: linearize.c (+3/-0), validation/bad-cast.c (+6/-0)
--------------------------------------------------------------------------------

[0feb9170ed4a] 2005-06-26 17:21:18 -0700
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] avoid segfault after parse errors in assignements

Avoid dereferencing a null pointer after parse errors in assignements.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: linearize.c (+3/-0), validation/bad-assignement.c (+6/-0)
--------------------------------------------------------------------------------

[d225b6dbdd93] 2005-06-26 17:21:18 -0700
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] avoid segfault after parse errors in array designated initializer

Avoid deferencing a null pointer after parse errors in array designated
initializer.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: parse.c (+4/-0), validation/bad-array-designated-initializer.c (+4/-0)
--------------------------------------------------------------------------------

[260a278aefde] 2005-06-26 17:21:18 -0700
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] avoid segfault in check_byte_count()

Avoid deferencing a null pointer in check_byte_count() after parse
errors in the checked function.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: check.c (+2/-0), validation/check_byte_count-ice.c (+6/-0)
--------------------------------------------------------------------------------

[fafb86f96d32] 2005-06-26 17:21:17 -0700
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] avoid segfault in linearize_asm_statement() after a parse error in asm statement

Avoid deferencing a null pointer in linearize_asm_statement() after a
parse error in asm statement.

Note: the problem was already fixed (or was never there) for the
asm_inputs part.  This patch uses the same protection for the output
part: use "".

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[faa939b38600] 2005-06-26 17:21:17 -0700
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] Avoid segfault when code is present after a goto statement

Sparse can segfault when code is present after a goto statement.

The problem arises because after a goto statement (same with break and
continue) ep->active is set to NULL but processing of code present after
this statement can dereference ep->active (alloc_phi()).

The following piece of code reproduce the problem:

	static int foo(int a)
	{
		goto end;
		return a ? : b;

	end:
		return 0;
	}

From what I have tested, the whole "a ? : b;" is needed to reproduce the
problem, with absent true part of the conditional and a undefined second
part; but the problem seems very general.

The following fixes the problem by checking for NULL ep->active, but
I suppose that there is nicer way to solve this problem.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: linearize.c (+2/-2)
--------------------------------------------------------------------------------

[a5213d6e3a43] 2005-06-21 15:19:27 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be more careful about linearizing conditionals

If there were earlier parse errors, we may not have some of the
expressions involved, so just check that first.

Reported by Luc Van Oostenryck.

Files: linearize.c (+7/-3)
--------------------------------------------------------------------------------

[d4a1970223d1] 2005-06-21 09:00:37 -0700
Author: Mika Kukkonen <mikukkon@gmail.com>
Subject: [PATCH] Fix compile warning in symbol.c

This patch adds the same unused int parameter to expand_expect() as in
expand_warning()
to match the required function template. Without this I get the
following warning:

symbol.c:644: warning: initialization from incompatible pointer type

Signed-off-by: Mika Kukkonen <mikukkon@iki.fi>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: symbol.c (+1/-1)
--------------------------------------------------------------------------------

[98346fe1671f] 2005-06-20 15:52:14 -0700
Author: Luc Van Oostenryck <lkml@looxix.net>
Subject: [PATCH] segfault on bad ternary conditional

sparse segfault on the following input:

	static int foo(int a)
	{
		return a ?? 1 : 0;
	}

This adds a new validation file and fixes the segfault.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: linearize.c (+5/-1), validation/bad-ternary-cond.c (+7/-0)
--------------------------------------------------------------------------------

[ce4b69f9e787] 2005-06-20 11:35:08 -0700
Author: Peter Jones <pjones@redhat.com>
Subject: [PATCH] __attribute__ handling for attributes used in the userland

Here's a patch that adds stubs for several attributes used in userland.

This version of the patch includes a warning, which defaults to on, if
you use gcc's "transparent_union" attribute, and has a flag
(-Wno-transparent-union) to turn the warning off.

Files: ident-list.h (+9/-2), lib.c (+2/-0), lib.h (+1/-0), parse.c (+25/-5)
--------------------------------------------------------------------------------

[52decb480315] 2005-06-19 21:22:29 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Initial cut at __builtin_expect() implementation

[Auto-summary] Modifies symbol.c. Changes: +22/-0 in 1 file(s)

Files: symbol.c (+22/-0)
--------------------------------------------------------------------------------

[c7accb8de209] 2005-06-19 21:09:02 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Default to reporting the same GNU C version as the host compiler

This is a bit hacky, but it tends to do what people expect most
of the time.

Files: lib.c (+8/-2)
--------------------------------------------------------------------------------

[5343861e409c] 2005-06-19 21:04:32 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix assignment and conditional expression parsing with no left side.

We used to parse it with a NULL left side, which just doesn't make
any sense. Refuse to recognize it instead.

Files: expression.c (+2/-2)
--------------------------------------------------------------------------------

[cf9816ef7a1f] 2005-06-19 20:55:33 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix SIGSEGV on assignment to bad left side.

Noted by Roland Dreier.

Files: linearize.c (+2/-2)
--------------------------------------------------------------------------------

[02c3a0d2813a] 2005-06-16 21:08:44 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up a few missing base type evaluations

Now that we don't always examine types all the way, we need to examine
stuff when looking at the base type..

Files: evaluate.c (+3/-3)
--------------------------------------------------------------------------------

[017034ed49eb] 2005-06-16 20:24:56 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up type examination.

Examining a pointer should not cause us to examine what it points to.
However, that means that we'll have to be more careful later on when we
look at the base type of a pointer.

Files: evaluate.c (+11/-9), symbol.c (+2/-4), symbol.h (+5/-0)
--------------------------------------------------------------------------------

[ecd2a5fe1cbb] 2005-06-04 17:29:49 -0300
Author: Arnaldo Carvalho de Melo <acme@ghostprotocols.net>
Subject: [LIB] allow changing the gcc version in the defines

Signed-off-by: Arnaldo Carvalho de Melo <acme@ghostprotocols.net>

Files: lib.c (+4/-2), lib.h (+1/-0)
--------------------------------------------------------------------------------

[5085b14f147f] 2005-05-31 02:41:37 -0300
Author: Arnaldo Carvalho de Melo <acme@ghostprotocols.net>
Subject: [IDENT] Add some more attributes

And, like others, ignore it for now.

Signed-off-by: Arnaldo Carvalho de Melo <acme@ghostprotocols.net>

Files: ident-list.h (+4/-0), parse.c (+8/-0)
--------------------------------------------------------------------------------

[877bb40e2f13] 2005-05-19 16:27:40 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't warn about undeclared "main()" function.

It obviously shouldn't be static, but we could add a test for it
having one of the acceptable types if we wanted to. Right now
I don't care enough.

Files: evaluate.c (+2/-0), ident-list.h (+1/-0)
--------------------------------------------------------------------------------

[3ce2538d18c6] 2005-05-19 16:26:25 -0700
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] Fix segfault on non-ANSI function-like declaration for real

The fix by Linus was half-assed, since it wasn't *p that was NULL, but
'p' itself.  Fix it for real this time.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[4cebb70b009a] 2005-05-19 16:10:50 -0700
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] Fix SIGSEGV on unterminated preprocessor conditional

sparse segfaults with the following input:
---
        #ifdef notdef
        oops!
---

The segfault occurs at pre-processor.c:free_preprocessor_line()
because of the extra calls of handle_endif done in do_preproccess()
while trying to do error recoverage.

Fix it by not trying to free the non-existent token line in the
faked endif handling.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: pre-process.c (+2/-0)
--------------------------------------------------------------------------------

[b5529f4bd132] 2005-05-19 15:52:43 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix position reporting on unterminated preprocessor conditional

Luc Van Oostenryck points out that we free all the preprocessor tokens
after processing these days, so that pointing back to them for position
reporting isn't very clever any more.

Fix by just saving the position instead of the token instead.

Files: pre-process.c (+3/-3)
--------------------------------------------------------------------------------

[5213bc46472b] 2005-05-17 16:51:17 -0700
Author: Luc Van Oostenryck <luc.vanoostenryck@looxix.net>
Subject: [PATCH] avoid a crash on bad asm statement

This patch avoid a segfault while printing a warning message about
bad asm statement like:

	void foo(void)
	{
		 asm( "" : "" : "r" (0));
	}

Signed-Off-by: Luc Van Oostenryck <luc.vanostenryck@looxix.net>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+2/-2)
--------------------------------------------------------------------------------

[7732bf5d4421] 2005-05-17 14:19:37 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix SIGSEGV on non-ANSI function-line declarations without a direct name.

Noted by Luc Van Oostenryck.

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[1414cc97e9b8] 2005-04-27 15:37:41 -0700
Author: Dave Jones <davej@redhat.com>
Subject: [PATCH] sparse fix

tokenize.c:682: error: static declaration of âident_hitâ follows non-static decl aration
token.h:50: error: previous declaration of âident_hitâ was here
tokenize.c:682: error: static declaration of âident_missâ follows non-static dec laration
token.h:50: error: previous declaration of âident_missâ was here
make: *** [tokenize.o] Error 1

This seems to do the trick..

Files: token.h (+0/-2)
--------------------------------------------------------------------------------

[f765413f020f] 2005-04-07 21:06:31 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] static declear

This patch add static declare to make sparse happy of checking itself.

Files: evaluate.c (+1/-1), inline.c (+2/-2), lib.c (+14/-14), parse.c (+7/-7), parse.h (+1/-0), ... and 6 more
--------------------------------------------------------------------------------

[47115aa79de6] 2005-04-07 21:06:30 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Give function name in non-ANSI declaration warning.

Suggested by Bernhard Fischer

Files: parse.c (+5/-5)
--------------------------------------------------------------------------------

[f23104e91616] 2005-04-07 21:06:30 -0700
Author: Bernhard Fischer <berny.f@aon.at>
Subject: [PATCH] sparse: add function name to warning

This adds the function name to the warning about 'function with external
linkage has definition'.

This saves me from having to open the file in order to look up the
function name.  When the name is printed, i can quickly grep for
possibly other occurances.

Files: parse.c (+2/-2)
--------------------------------------------------------------------------------

[46b366856e6a] 2005-04-07 21:06:30 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make enum symbols be regular symbols with constant initializers.

This removes SYM_ENUM as a special case for symbol handling, and
makes it possible to follow the types much better.

Files: evaluate.c (+11/-30), parse.c (+19/-6)
--------------------------------------------------------------------------------

[dcb153a697e1] 2005-04-07 21:06:29 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Warn about implicit casts to/from "nocast" types

[Auto-summary] Modifies evaluate.c. Changes: +18/-6 in 1 file(s)

Files: evaluate.c (+18/-6)
--------------------------------------------------------------------------------

[77ac63127dc8] 2005-04-07 21:06:29 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Move the ptrlist macros out of the sparse "lib.[ch]" files.

They rate their own "ptrlist" library status, since they are
definitely potentially useful outside of sparse.

Files: Makefile (+4/-2), lib.c (+0/-212), lib.h (+1/-248), ptrlist.c (+223/-0), ptrlist.h (+259/-0)
--------------------------------------------------------------------------------

[67cb76f7d0c7] 2005-04-07 21:06:29 -0700
Author: Alexey Dobriyan <adobriyan@mail.ru>
Subject: [PATCH] sparse: Makefile trivialities

[Auto-summary] Modifies build system. Changes: +2/-2 in 1 file(s)

Files: Makefile (+2/-2)
--------------------------------------------------------------------------------

[dade688f6551] 2005-04-07 21:06:28 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Handle bad enum expression types gracefully.

[Auto-summary] Modifies parse.c. Changes: +3/-1 in 1 file(s)

Files: parse.c (+3/-1)
--------------------------------------------------------------------------------

[b3f55ef219ce] 2005-04-07 21:06:28 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add support for context checking functions.

You can mark a function as requiring a lock, or requiring being called
without a lock.

Files: check.c (+17/-4), linearize.c (+13/-5), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[ecfc8694efb4] 2005-04-07 21:06:28 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Name static library "libsparse.a" to match shared library naming

Also, if we want to use "-lsparse" to link the thing, that's the
naming pattern we'd want, as pointed out by Jeff

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[6f593900adbe] 2005-04-07 21:06:27 -0700
Author: rmps@joel.ist.utl.pt <rmps@joel.ist.utl.pt>
Subject: [PATCH] : "make clean" doesn't delete libsparse.so

Small patch to also delete libsparse.so (SLIB_FILE) in "clean" target.

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[0bdc502ea7da] 2005-04-07 21:06:27 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't warn about zero-sized "sizeof"

It could be a sparse bug (lacking type evaluation), but the kernel
has zero-sized arrays in valid places, so..

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[926d0b2fd5db] 2005-04-07 21:06:26 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Warn about undeclared identifiers.

[Auto-summary] Modifies evaluate.c. Changes: +10/-0 in 1 file(s)

Files: evaluate.c (+10/-0)
--------------------------------------------------------------------------------

[d21e17adba16] 2005-04-07 21:06:26 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Support building sparse as a shared library.

I chickened out, and the actual programs don't link against
the shared version, but that is easy to do if somebody wants
to (just change the definition of "LIBS" to point to the
shared library instead, and possibly add -rpath to the link
flags).

Files: Makefile (+25/-13)
--------------------------------------------------------------------------------

[0c2211161823] 2005-04-07 21:06:26 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] using 0 as NULL in sparse

This trivial patch remove the warning when I try to compile sparse
in with sparse.

Another warning I did not fix is:
../pre-process.c:554:18: warning: bad constant expression
The offending line is:
	struct arg args[nargs];

Files: cse.c (+3/-3)
--------------------------------------------------------------------------------

[f35a1af19298] 2005-04-07 21:06:25 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Warn about sizeof of zero size.

It's usually indicative of a sparse type-sizing bug rather
than a bug in the checked source.

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[4cb5fcd2c87a] 2005-04-07 21:06:25 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] bogus initializer offsets

This test-case shows a bug in initializer expressions in inlining:

	struct s {
	        unsigned a;
	        unsigned b:1;
	};
	static inline void bar(void)
	{
	        struct s x = {
	                .a = 0,
	                .b = 0,
	        };
	}
	void foo(void)
	{
	        bar();
	        bar();
	}

gives:

	b.c:9:8: warning: invalid access past the end of 'x' (8 8)

The reason is that we start with

EXPR_INITIALIZER:
	EXPR_IDENTIFIER[a]: ea
	EXPR_IDENTIFIER[b]: eb

That's what we have in inline tree.  First call give us new EXPR_INITIALIZER
containing the same EXPR_IDENTIFIER nodes.  Evaluating that gives list with
two expressions - ea and EXPR_POS[4]: eb.  EXPR_POS is actually cannibalized
second EXPR_IDENTIFIER.  Expanding the results doesn't do anything interesting
(yet).

Second call: that's where the things get ugly.  New EXPR_INITIALIZER again,
but now it contains EXPR_POS.  And that gives us EXPR_POS[4]: EXPR_POS[4]: eb.
Oops...  Expanding that will collapse to single offset of 8.  That will be
in the node we'd allocated for the second EXPR_POS, so corruption of the
inline tree won't go any further.  It's more than enough already, though...

Obvious solution would be to always copy EXPR_POS and EXPR_IDENTIFIER when
uninlining.  Trivial patch follows; unless you see a way to do it smarter...

Files: inline.c (+0/-4)
--------------------------------------------------------------------------------

[9ac957d1f727] 2005-04-07 21:06:25 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be more careful about removing implicit casts.

We weren't checking the types properly, only the sizes. That
made us incorrectly ignore implicit casts between integers
and pointers if they just had the right size and sign.

Files: evaluate.c (+32/-16), symbol.h (+4/-0)
--------------------------------------------------------------------------------

[35f3bb9a8832] 2005-04-07 21:06:24 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make sure to re-examine a struct/union/enum type after we did the real definition.

It may have been declared and used as a pointer before.

Files: parse.c (+3/-0)
--------------------------------------------------------------------------------

[1b0210842891] 2005-04-07 21:06:24 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "check" (aka sparse) check arguments to some functions.

Start out with the memset/memcpy/copy_to/from_user byte counts.

Files: check.c (+65/-0), ident-list.h (+4/-0)
--------------------------------------------------------------------------------

[6d7df190cf2a] 2005-04-07 21:06:24 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix typo (duplicate src2 should be src3) in simplify_range

Noted by Jeff Muizelaar

Files: simplify.c (+1/-1)
--------------------------------------------------------------------------------

[a2dfe696891a] 2005-04-07 21:06:23 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove old stale pointer dereference type mess, that could never trigger.

Also, make sure that the node we create gets the signedness
etc specifiers from the pointer.

Files: evaluate.c (+1/-14)
--------------------------------------------------------------------------------

[4c61a55be77d] 2005-04-07 21:06:23 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Export "is_ptr_type()" helper function to others.

[Auto-summary] Modifies evaluate.c. Updates header symbol.h. Changes: +2/-1 in 2 file(s)

Files: evaluate.c (+1/-1), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[711c8a9b1ff5] 2005-04-07 21:06:22 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Avoid SIGSEGV when linearizing bad expressions.

[Auto-summary] Modifies linearize.c. Changes: +1/-1 in 1 file(s)

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[a6c452457ca3] 2005-04-07 21:06:22 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't drop modifier bits from a member dereference.

We do need to take the modifiers from the pointer too, but not
to the point of ignoring the modifiers of the member itself.

Files: evaluate.c (+2/-0)
--------------------------------------------------------------------------------

[50716970e109] 2005-04-07 21:06:22 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use the new per-instruction position information for better error reporting.

[Auto-summary] Modifies 4 source files: check.c, cse.c, flow.c and 1 more. Changes: +9/-9 in 4 file(s)

Files: check.c (+5/-5), cse.c (+1/-1), flow.c (+1/-1), simplify.c (+2/-2)
--------------------------------------------------------------------------------

[b9515cf3d081] 2005-04-07 21:06:21 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make each instruction have a position of its own.

Rather than tying everything to the beginning basic block
position.

This should be able to pinpoint instruction issues much more
exactly and readably.

Files: linearize.c (+6/-0), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[6954ca7089ae] 2005-04-07 21:06:21 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make range check code a bit more readable (and more easily extensible).

[Auto-summary] Modifies simplify.c. Changes: +16/-5 in 1 file(s)

Files: simplify.c (+16/-5)
--------------------------------------------------------------------------------

[4b369282cf9d] 2005-04-07 21:06:21 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add compile-time "range-check" infrastructure to sparse

[Auto-summary] Modifies 10 source files: check.c, evaluate.c, example.c and 7 more. Updates 3 headers. Changes: +120/-18 in 13 file(s)

Files: check.c (+11/-3), evaluate.c (+6/-1), example.c (+3/-1), expand.c (+6/-1), ident-list.h (+1/-0), ... and 8 more
--------------------------------------------------------------------------------

[13299c9883c7] 2005-04-07 21:06:20 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make sure we evaluate pointer comparisons as unsigned.

(As well as unsigned restricted types).

Files: evaluate.c (+5/-1)
--------------------------------------------------------------------------------

[db9eeb6b2842] 2005-04-07 21:06:20 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Shut up informational messages once we've hit the maximum warning count.

Also make errors shut up subsequent warnings.

Files: lib.c (+11/-8)
--------------------------------------------------------------------------------

[6ca9d753eb85] 2005-04-07 21:06:20 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "check" (aka "sparse") check data-dropping casts.

It gives a _lot_ of warnings for the kernel, so it's only enabled
with "verbose" output. But maybe it can be tweaked to the point where
it becomes useful.

Files: check.c (+61/-0)
--------------------------------------------------------------------------------

[7c1b75d0de6b] 2005-04-07 21:06:19 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make simplification remove casts that change neither size nor sign.

[Auto-summary] Modifies simplify.c. Changes: +12/-1 in 1 file(s)

Files: simplify.c (+12/-1)
--------------------------------------------------------------------------------

[caeaf72d34d1] 2005-04-07 21:06:19 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Split OP_CAST into signed, unsigned and FP casts.

Otherwise we lose the information what the target
type is (we only have the bit-size of the target).

Files: linearize.c (+8/-0), linearize.h (+2/-0), liveness.c (+2/-0), simplify.c (+4/-2)
--------------------------------------------------------------------------------

[246ccfb6db7e] 2005-04-07 21:06:18 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify OP_CAST of OP_AND.

We can remove the cast if the AND made it unnecessary.

Files: simplify.c (+21/-7)
--------------------------------------------------------------------------------

[1ad4de9f5f3a] 2005-04-07 21:06:18 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't optimize away casts too early.

It's wrong to optimize away a cast just based on its bitsize.
For one thing, the bit _offset_ also matters. For another, we
do care about potential sign-changes of the cast too.

So call "cast_to()" more aggressively, and make that function
do the proper checks.

Files: evaluate.c (+24/-23)
--------------------------------------------------------------------------------

[42cc4ad2a2b4] 2005-04-07 21:06:18 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Duh. When a function returns VOID, we should _not_ add that to the return register state.

[Auto-summary] Modifies example.c. Changes: +2/-1 in 1 file(s)

Files: example.c (+2/-1)
--------------------------------------------------------------------------------

[c583c7142747] 2005-04-07 21:06:17 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix code generation confusion between OP_ADDR and the value that is contained within.

[Auto-summary] Modifies example.c. Changes: +45/-12 in 1 file(s)

Files: example.c (+45/-12)
--------------------------------------------------------------------------------

[5bfce4ab21c3] 2005-04-07 21:06:17 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make the example code generator do something half-way sane about addresses of local variables.

[Auto-summary] Modifies 2 source files: example.c, linearize.c. Changes: +33/-14 in 2 file(s)

Files: example.c (+32/-14), linearize.c (+1/-0)
--------------------------------------------------------------------------------

[378908b588e2] 2005-04-07 21:06:16 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make constant instruction simplification take the sign of the instruction into account now that we have it.

[Auto-summary] Modifies simplify.c. Changes: +29/-20 in 1 file(s)

Files: simplify.c (+29/-20)
--------------------------------------------------------------------------------

[741bbde94021] 2005-04-07 21:06:16 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Split the binops where signedness matters into unsigned and signed.

This is OP_MUL/OP_DIV/OP_MOD/OP_SHR.

We actually do the constant simplifications still wrong, but
now the information is all there.

Files: cse.c (+10/-6), example.c (+12/-7), linearize.c (+34/-14), linearize.h (+4/-4), simplify.c (+23/-16)
--------------------------------------------------------------------------------

[e031e2cc87a4] 2005-04-07 21:06:16 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make linearizer able to handle assignment ops where the assignment expression needs to be done in a wider type.

We never actually generate those kinds of expression trees
yet, but that's because our expression evaluation is a bit
buggy and will cast them to the target type too soon.

Another of the "Al Viro thinks of things mortal humans do
not" cases.

Files: linearize.c (+50/-41)
--------------------------------------------------------------------------------

[99efcabf79a1] 2005-04-07 21:06:15 -0700
Author: Sam Ravnborg <sam@ravnborg.org>
Subject: [PATCH] make include path handling gcc compatible

Search include paths in same order as gcc does.

In other words search directories specified with -I before system
directories.

This fixes a bug reported by a few persons after the kernel switched
over to use -isystem to specify where to find compiler specific include files.

Sparse now supports the following include path relevant options:
-I dir		Add dir to list of directories to search for. Search dir
		before system dirs. Used for both <> and "" includes.
-I-		Split include path - previous -I dir paths only used for
		include "".
		Also disable searching same dir as input file.
-isystem dir	Add dir first in row of system dirs to search.
-dirafter dir	Add dir in end of system dirs to search.
-nostdinc	Discard all defined system dirs

The -iwithprefix, -iprefix and -iwithprefixbefore options are not not
supported and silently ignored. gcc discourage use of these options.

Files: lib.c (+13/-11), pre-process.c (+151/-41), token.h (+1/-0), tokenize.c (+1/-0)
--------------------------------------------------------------------------------

[423e91dbdcd2] 2005-04-07 21:06:15 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Evaluate asm outputs as assignments.

Needed to get all the MOD_ASSIGNED and "const" warnings right.

Another in the "Al Viro found strange things" series.

Files: evaluate.c (+1/-0)
--------------------------------------------------------------------------------

[9abd3b4737cc] 2005-04-07 21:06:15 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: We didn't mark symbols with their address taken as being properly MOD_ADDRESSABLE.

This made some other parts of sparse think that symbols
were read-only and could be optimized away.

Al's test-cases found this.

Files: evaluate.c (+5/-0)
--------------------------------------------------------------------------------

[fb35900d416c] 2005-04-07 21:06:14 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make expression type enums start at one..

This is what we do for most enums, making it clear
that a zero means "uninitialized", since that easily
happens with our zeroing allocator.

Files: expression.h (+1/-1)
--------------------------------------------------------------------------------

[2235458dce3d] 2005-04-07 21:06:14 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: inlining: don't copy an initializer expression for a symbol that didn't get copied.

Test-case by Sam Ravnborg (inline function with static symbol with
initializer).

Files: inline.c (+2/-1)
--------------------------------------------------------------------------------

[d69224e8d81d] 2005-04-07 21:06:14 -0700
Author: Sam Ravnborg <sam@ravnborg.org>
Subject: [PATCH] sparse: fails to locate stdarg.h

With latest change to kbuild where

	-isystem `gcc -print-file-name=include'

is used to specify where to locate stdarg.h sparse failed to locate
stdarg.h.

This adds support of -isystem to sparse.

Files: lib.c (+6/-0)
--------------------------------------------------------------------------------

[17f5b9646df0] 2005-04-07 21:06:13 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Linearize EXPR_POS initializers more carefully: they can contain sub-initializers.

This really shouldn't be needed, since we should be flattening
the EXPR_INITIALIZER during evaluation, but there's something
missing. However, since flattening cannot handle the range case
(which we don't handle right now in linearization either), we do
 conceptually need this for the generic case anyway.

Files: linearize.c (+2/-4)
--------------------------------------------------------------------------------

[6889bd0f8493] 2005-04-07 21:06:13 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add option "-Wptr-subtraction-blows" to warn about expensive pointer subtractions.

Not only does it generate bad code (that can often be rewritten
to not do that), it also causes gcc to go into horrible contortions,
and Al Viro reports that it can make a factor of 2.5 difference in
kernel build times to have just a few of these in common header
file inline functions.

Files: evaluate.c (+7/-1), lib.c (+2/-0), lib.h (+1/-0)
--------------------------------------------------------------------------------

[9065ccde0367] 2005-04-07 21:06:13 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "check_access()" take the size of the access properly into account.

[Auto-summary] Modifies flow.c. Changes: +2/-2 in 1 file(s)

Files: flow.c (+2/-2)
--------------------------------------------------------------------------------

[17ce3e565218] 2005-04-07 21:06:12 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't do the pointer offset update for a pointer addition in-place.

In case of inline functions we share the expression tree
with the original inline fn, and we mustn't change the
sub-expressions.

Files: evaluate.c (+17/-11)
--------------------------------------------------------------------------------

[4beb074e5e5b] 2005-04-07 21:06:12 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: Don't try to recursively check for an associative insn.

This should only happen for a buggy case anyway, but..

Files: simplify.c (+2/-0)
--------------------------------------------------------------------------------

[2b0d23c4b4f8] 2005-04-07 21:06:12 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add warning for accessing outside of a symbol

This shows that we have some inlining bug where we seem to
be corrupting the offsetting of an array. So right now the
warnings we get in the kernel seem to be bogus, but this
should help find that other bug too, and it doesn't trigger
often enough to be too distracting.

Files: flow.c (+19/-1), flow.h (+1/-0), memops.c (+3/-0)
--------------------------------------------------------------------------------

[7ee44c48fd74] 2005-04-07 21:06:11 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify OP_PTRCAST ops too for now.

Some day we migth do a type-based alias cast, and then we might do
something else, but for now simplification is better than leaving
them in and making analysis harder.

Files: simplify.c (+1/-1)
--------------------------------------------------------------------------------

[f50d00f49945] 2005-04-07 21:06:11 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix array size calculation when the last entry is an EXPR_INDEX.

[Auto-summary] Modifies symbol.c. Changes: +2/-2 in 1 file(s)

Files: symbol.c (+2/-2)
--------------------------------------------------------------------------------

[03aa6219fd8c] 2005-04-07 21:06:11 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make output_insn() tell where it was called from, and avoid doing unnecessary register->sameregister moves.

[Auto-summary] Modifies example.c. Changes: +7/-0 in 1 file(s)

Files: example.c (+7/-0)
--------------------------------------------------------------------------------

[a8b467d262da] 2005-04-07 21:06:10 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "fill_reg" do somewhat the right thing when we take the address of a symbol.

Not quite there..

Files: example.c (+28/-1)
--------------------------------------------------------------------------------

[b65b8dc1302c] 2005-04-07 21:06:10 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. Missed a place where we still tested for "busy" thinking that it meant "contains a pseudo".

[Auto-summary] Modifies example.c. Changes: +1/-1 in 1 file(s)

Files: example.c (+1/-1)
--------------------------------------------------------------------------------

[23ae0366c41a] 2005-04-07 21:06:10 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make the argument storage setup be a bit more accurate.

Take argument type into account (somewhat), and do a first
(broken, but it's a good example) cut at having different
calling conventions for different kinds of functions.

Files: example.c (+33/-10)
--------------------------------------------------------------------------------

[5a9db425bb86] 2005-04-07 21:06:09 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Toplevel symbols are externally addressable only if they aren't static..

[Auto-summary] Modifies symbol.c. Changes: +3/-1 in 1 file(s)

Files: symbol.c (+3/-1)
--------------------------------------------------------------------------------

[24434bb022d7] 2005-04-07 21:06:09 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "reg->busy" mean how many "operands" actually reference this register right now.

Change users that just wanted to test for "empty" to check that
"reg->contains" is NULL instead.

Files: example.c (+53/-26)
--------------------------------------------------------------------------------

[3768319efead] 2005-04-07 21:06:08 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Start moving to a more symbol "struct operand" notion, rather than using static strings.

If we ever want to generate more abstract output (and we do), we
can't just have strings.

Files: example.c (+144/-15)
--------------------------------------------------------------------------------

[68bc3df8cf66] 2005-04-07 21:06:08 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix "address_taken()" function to work at least pitifully with the OP_SYMADDR simplifications.

It's still wrong. Now it just happens to work in most cases.

Files: memops.c (+14/-2)
--------------------------------------------------------------------------------

[e71da876a4a7] 2005-04-07 21:06:08 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Get comparison sizes right.

The _result_ size of a comparison is always just a boolean,
but that isn't the interesting part. What we care about is
what the size of the thing we compare is.

Files: linearize.c (+2/-2)
--------------------------------------------------------------------------------

[6278edfccdbb] 2005-04-07 21:06:07 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Split OP_SETVAL into OP_SETVAL (fp expressions and labels) and OP_SYMADDR (symbol addresses).

They are pretty different. Symbol addresses have special meaning during
various phases, from symbol simplification to CSE.

Files: cse.c (+8/-2), example.c (+2/-2), flow.c (+5/-10), linearize.c (+29/-24), linearize.h (+1/-0), ... and 3 more
--------------------------------------------------------------------------------

[e2c6465a7833] 2005-04-07 21:06:07 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make sure to mark all registers that have already been allocated by a parent as outputs as unavailable as an input register.

The parent won't be able to write two different pseudos to the
same register..

Files: example.c (+28/-0)
--------------------------------------------------------------------------------

[81bfe7e9ee03] 2005-04-07 21:06:07 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: The stack offset is global, not per-bb.

We could make the internal per-bb allocations be
local, though. That would require some more care.

Files: example.c (+5/-6)
--------------------------------------------------------------------------------

[b54b3264cc47] 2005-04-07 21:06:06 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Duh. We marked the wrong register REG_FIXED when we wrote out the outgoing pseudos.

This caused us to then possibly double-allocate that register
later for another pseudo..

Files: example.c (+1/-1)
--------------------------------------------------------------------------------

[8644b59fc616] 2005-04-07 21:06:06 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add some back-of-the-envelope support for asm inputs tied to the outputs.

[Auto-summary] Modifies example.c. Changes: +31/-5 in 1 file(s)

Files: example.c (+31/-5)
--------------------------------------------------------------------------------

[9be6384968d2] 2005-04-07 21:06:06 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do absolutely horrid job of generating code for asms.

I totally botch the constraints handling, but hey, it's just
an example.

Files: example.c (+137/-7)
--------------------------------------------------------------------------------

[0c62759dd20e] 2005-04-07 21:06:05 -0700
Author: santtu.hyrkko@gmail.com <santtu.hyrkko@gmail.com>
Subject: [PATCH] Diff to make sparse not complain about __format_arg__

Another gcc format thing...

Files: ident-list.h (+1/-0), parse.c (+2/-1)
--------------------------------------------------------------------------------

[17ae3e08b94f] 2005-04-07 21:06:05 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use the one-deep CC-cache for OP_SEL too.

[Auto-summary] Modifies example.c. Changes: +30/-21 in 1 file(s)

Files: example.c (+30/-21)
--------------------------------------------------------------------------------

[0aa8746ec975] 2005-04-07 21:06:05 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify conditional on cast-to-larger-size to conditional on original.

[Auto-summary] Modifies simplify.c. Changes: +8/-0 in 1 file(s)

Files: simplify.c (+8/-0)
--------------------------------------------------------------------------------

[3034109abbb6] 2005-04-07 21:06:04 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: If we decide to mark a register as being its own storage, return NULL from find_pseudo_storage().

That way the caller won't bother to move the register to
itself - it sees that it has no separate storage.

Files: example.c (+3/-2)
--------------------------------------------------------------------------------

[7d40555c1fc9] 2005-04-07 21:06:04 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add a one-deep CC-cache for condition code setting and usage.

We could make it deeper if we wanted to combine conditionals,
but one-deep is good enough to catch the common "setXX + brcc"
thing, and thus makes the conditional branches MUCH more readable.

This also moves things around a bit to help organization.

Files: example.c (+218/-123)
--------------------------------------------------------------------------------

[9a3a79c77c72] 2005-04-07 21:06:04 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Verify that output/input asm constraints really look like outputs/inputs.

[Auto-summary] Modifies evaluate.c. Changes: +12/-0 in 1 file(s)

Files: evaluate.c (+12/-0)
--------------------------------------------------------------------------------

[fc3589ce21d6] 2005-04-07 21:06:03 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Save off the asm parameter name too.

The asm_inputs/outputs "expression list" is not really an
expression list any more: it is a list of "triples", where
the first entry is the identifier name, the second one is
the constraint string, and the third one is the expression.

Files: evaluate.c (+55/-25), inline.c (+15/-4), linearize.c (+38/-14), linearize.h (+1/-0), parse.c (+5/-1)
--------------------------------------------------------------------------------

[6c90fbe3f50a] 2005-04-07 21:06:03 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Show asm inputs/outputs as bugus instructions as opposed to comments.

They otherwise get drowned out by the _real_ comments.

Files: example.c (+2/-2)
--------------------------------------------------------------------------------

[e7e35a9e3c25] 2005-04-07 21:06:03 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Start looking at asms in code generation.

Just the infrastructure.

Files: example.c (+40/-1)
--------------------------------------------------------------------------------

[7f3a296bbbea] 2005-04-07 21:06:02 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make asm linearization not drop the constraints.

This also makes the OP_ASM data structures a bit more structured
in order to contain all the required information.

Files: linearize.c (+53/-25), linearize.h (+14/-2), liveness.c (+16/-7)
--------------------------------------------------------------------------------

[7ec6f5462f09] 2005-04-07 21:06:02 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: Do some kind of signed cast too.

[Auto-summary] Modifies example.c. Changes: +8/-5 in 1 file(s)

Files: example.c (+8/-5)
--------------------------------------------------------------------------------

[10a301a2d01b] 2005-04-07 21:06:02 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do slightly better on casts.

In particular, casts to a smaller type doesn't need to do anything.

Files: example.c (+13/-6)
--------------------------------------------------------------------------------

[f95ebd594597] 2005-04-07 21:06:01 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Teach code generator about commutative operations.

It can select the order based on whether one of the sources
is dead, or on the target register choice.

Files: example.c (+63/-6)
--------------------------------------------------------------------------------

[09b7ad17e4ce] 2005-04-07 21:06:01 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. Didn't remember about BINCMP ops when doing the commutative work.

Equality tests are commutative. The others aren't (well, they need
to switch the sense around).

Files: simplify.c (+5/-0)
--------------------------------------------------------------------------------

[8c1eb0637f6e] 2005-04-07 21:06:01 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Teach simplification about associative operators.

[Auto-summary] Modifies simplify.c. Changes: +39/-3 in 1 file(s)

Files: simplify.c (+39/-3)
--------------------------------------------------------------------------------

[a29db2d1bbf4] 2005-04-07 21:06:00 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make commutative operations use a canonical order.

This improves CSE, and simplifies code generation. Keep the
"simpler" argument in "src2".

Files: simplify.c (+40/-1)
--------------------------------------------------------------------------------

[40cccfe62757] 2005-04-07 21:06:00 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Mark the backing store storage dead when marking a pseudo dead.

This allows us to mark a register dead when we load it from dead
backing store.

NOTE! This all sounds nonsensical, but we mark things "dead" _before_
the last use, not after. So dead means not that it's gone, it means
that this use is the last one.

Files: example.c (+25/-19), storage.h (+1/-0)
--------------------------------------------------------------------------------

[95237be67643] 2005-04-07 21:05:59 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "find_pseudo_storage()" return the storage hash entry rather than the storage itself.

I'll want to mark the hash entry dead when marking the pseudo
dead, and this allows me to use the common helper routine.

Files: example.c (+10/-6)
--------------------------------------------------------------------------------

[fd5cac554ee2] 2005-04-07 21:05:59 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Split up the code that finds the underlying storage for a pseudo into a routine of its own.

Cleaner and more readable.

This also allows us to be a lot better at the "generic"
inputs (aka gcc "g" specifier), since it can now just look
up the storage instead of having to load it into a register.

Files: example.c (+71/-44)
--------------------------------------------------------------------------------

[1560cae726db] 2005-04-07 21:05:59 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add storage usage verification phase.

Since we don't actually verify that storage doesn't overlap
when we do code generation, out local heuristics sometimes
do the wrong thing and allocate the same register to two
pseudos. This should catch it.

We do pretty well most of the time, so it's not obvious from
just reading the output. Largely because we try to do parents first,
which means that inputs are usually stable.

Files: storage.c (+52/-2)
--------------------------------------------------------------------------------

[594e014153ed] 2005-04-07 21:05:58 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add support for various arch-specific storage allocation issues:  - argument passign setup  - return value storage  - silly switch register hack.

[Auto-summary] Modifies example.c. Changes: +116/-2 in 1 file(s)

Files: example.c (+116/-2)
--------------------------------------------------------------------------------

[7fc734e0cdde] 2005-04-07 21:05:58 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add the argument pseudos to the "enter" instruction

Not only does it make sense, but the back-end needs to
know what pseudos got allocated ;)

Files: linearize.c (+5/-1), linearize.h (+3/-0)
--------------------------------------------------------------------------------

[72d89f4f92eb] 2005-04-07 21:05:58 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Expose lookup_storage/add_storage to code generator.

We'll want to add architecture-specific storage rules for some
special cases.

Files: storage.c (+2/-2), storage.h (+3/-0)
--------------------------------------------------------------------------------

[5a55018adefe] 2005-04-07 21:05:57 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Sort switch target list

[Auto-summary] Modifies linearize.c. Changes: +27/-0 in 1 file(s)

Files: linearize.c (+27/-0)
--------------------------------------------------------------------------------

[73a2e867127e] 2005-04-07 21:05:57 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Kill off dead pseudos before doing target allocation for casts and loads.

That allows us to re-use the sources if they have died.

Files: example.c (+16/-12)
--------------------------------------------------------------------------------

[816461493f5a] 2005-04-07 21:05:57 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Keep dead pseudos in the register "busy" count, add "dead" count.

This makes it much easier to look at the real state of a register:
 - busy == 0 means no users
 - busy == dead means all users are dead
 - dead != 0 means that we should clean it

Files: example.c (+57/-5)
--------------------------------------------------------------------------------

[07bd7ddc3a3a] 2005-04-07 21:05:56 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add comment on where incoming pseudos come from.

[Auto-summary] Modifies example.c. Changes: +1/-0 in 1 file(s)

Files: example.c (+1/-0)
--------------------------------------------------------------------------------

[6981d7d92930] 2005-04-07 21:05:56 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Generate pseudo-code for OP_SEL.

You know the drill by now. It's not so much correct, as it is
"kind of looks right".

Files: example.c (+18/-0)
--------------------------------------------------------------------------------

[d7f72582a83e] 2005-04-07 21:05:56 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make target register allocation prefer empty registers.

Yeah, yeah, it's still pretty stupid.

Files: example.c (+4/-0)
--------------------------------------------------------------------------------

[5925cd42c163] 2005-04-07 21:05:55 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Generate cheesy "cast" instructions.

No sign extension, no nuffink. My opcode generation gets
worse and worse.

Files: example.c (+23/-0)
--------------------------------------------------------------------------------

[9d0cde9ba65e] 2005-04-07 21:05:55 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add fake OP_CALL code generation.

Just real enough to make it look good.

Files: example.c (+39/-0)
--------------------------------------------------------------------------------

[b44ebb0676e5] 2005-04-07 21:05:55 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be a bit more forgiving about impossible output register situations.

We get those when encountering unimplemented instructions, since
then we'll have bad register contents. Let's just silently ignore
it for now.

Files: example.c (+4/-1)
--------------------------------------------------------------------------------

[03948840092b] 2005-04-07 21:05:54 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Output unimplemented instructions as such, rather than as comments.

This makes them visible even without having to make
the output verbose (and verbose is _really_ verbose
these days).

Files: example.c (+1/-1)
--------------------------------------------------------------------------------

[1d491084450c] 2005-04-07 21:05:54 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up final register flushing, and allow flushing to a temporary new register if one is available.

Use a few symbolic macros to make some of the logic more readable,
and split up the "try to flush" logic into a function of its own.

Files: example.c (+80/-14)
--------------------------------------------------------------------------------

[33c56a457c94] 2005-04-07 21:05:54 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add comment about input storage selection.

[Auto-summary] Modifies example.c. Changes: +7/-0 in 1 file(s)

Files: example.c (+7/-0)
--------------------------------------------------------------------------------

[d83a98eabfe4] 2005-04-07 21:05:53 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When fulfilling the output register requirements, don't be so eager to flush to memory. If we can find the proper target register for the existing pseudo, just turn it into a simple reg-reg move instead.

Also, don't worry about dead pseudos - they don't need
flushing anyway.

Files: example.c (+22/-4)
--------------------------------------------------------------------------------

[88bf1c0b62a8] 2005-04-07 21:05:53 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't kill the same pseudo twice.

Keep the busy count valid.

Files: example.c (+2/-0)
--------------------------------------------------------------------------------

[0f56c21f6291] 2005-04-07 21:05:53 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove pseudos from liveness list when they are defined.

This only matters for phi-nodes, since other kinds of pseudos
should never see any use before their def anyway.

Files: liveness.c (+14/-0)
--------------------------------------------------------------------------------

[6ac724e102aa] 2005-04-07 21:05:52 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Track phi uses in a separate pass from the liveness analysis.

We'll want to have the full phi user list when we do liveness.

Files: liveness.c (+13/-2)
--------------------------------------------------------------------------------

[831c54c8bd82] 2005-04-07 21:05:52 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up linearizer output that got uglified by the show_instruction() changes.

[Auto-summary] Modifies linearize.c. Changes: +3/-4 in 1 file(s)

Files: linearize.c (+3/-4)
--------------------------------------------------------------------------------

[b915ccf4042c] 2005-04-07 21:05:52 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add tons more comments about register state changes to the example output. Very informational.

[Auto-summary] Modifies example.c. Changes: +41/-21 in 1 file(s)

Files: example.c (+41/-21)
--------------------------------------------------------------------------------

[92b590207d37] 2005-04-07 21:05:51 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "remove_pseudo()" return whether it removed a pseudo from the list or not.

[Auto-summary] Updates header linearize.h. Changes: +2/-2 in 1 file(s)

Files: linearize.h (+2/-2)
--------------------------------------------------------------------------------

[105f3530d459] 2005-04-07 21:05:51 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When removing/replacing pointer list entries, return the final count.

The caller want to know how many got removed if they didn't
specify an exact count to begin with.

Files: lib.c (+6/-3), lib.h (+2/-2)
--------------------------------------------------------------------------------

[9ba432199294] 2005-04-07 21:05:51 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: PHI pseudos aren't supposed to show up on the liveness tracking. Make the asserts reflect that.

[Auto-summary] Modifies liveness.c. Changes: +1/-1 in 1 file(s)

Files: liveness.c (+1/-1)
--------------------------------------------------------------------------------

[1eebe8322911] 2005-04-07 21:05:50 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove old pseudos from register list when we redefine one through a phi-node.

[Auto-summary] Modifies example.c. Changes: +17/-0 in 1 file(s)

Files: example.c (+17/-0)
--------------------------------------------------------------------------------

[b796e4b79abb] 2005-04-07 21:05:50 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make pretty helper functions for showing individual instructions and labels. And comments, for that matter.

This eventually allows us to buffer them up, rather than print
them out directly. Which we'll need to do if we want to fix up
frame offsets etc (for register save areas). And other post-
processing.

Also, for comments, make "show_instruction()" return the string
rather than print it out.

Files: example.c (+87/-37), linearize.c (+7/-7), linearize.h (+1/-1)
--------------------------------------------------------------------------------

[0e23efe071d2] 2005-04-07 21:05:50 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't re-use registers for several different output storages.

We used to be lazy and just assume that if a value was in a
register when we exited, we could just use that register. Not
so, since now a register can contain multiple pseudos, that
may all need different output storages.

Files: example.c (+27/-6)
--------------------------------------------------------------------------------

[6556b643f7a8] 2005-04-07 21:05:49 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use the ptr-list tagging for marking pseudos dirty.

Remove hardreg dirty bit, it really is per-pseudo.

Files: example.c (+16/-11)
--------------------------------------------------------------------------------

[c3c27ec32ecf] 2005-04-07 21:05:49 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Support tagged add_ptr_list

[Auto-summary] Modifies lib.c. Updates header lib.h. Changes: +12/-3 in 2 file(s)

Files: lib.c (+3/-1), lib.h (+9/-2)
--------------------------------------------------------------------------------

[edfdf5d1bddd] 2005-04-07 21:05:49 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be smarter about when we need to flush a pseudo.

We can often just re-generate it (from its source, or from
an earlier flush).

Files: example.c (+27/-1)
--------------------------------------------------------------------------------

[86bf4942ef5f] 2005-04-07 21:05:48 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Now that we can have multiple pseudos per reg, we should make "busy" be a counter of non-dead pseudos.

[Auto-summary] Modifies example.c. Changes: +55/-42 in 1 file(s)

Files: example.c (+55/-42)
--------------------------------------------------------------------------------

[dd51633ebee9] 2005-04-07 21:05:48 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Generate some kind of code for OP_RET

[Auto-summary] Modifies example.c. Changes: +15/-0 in 1 file(s)

Files: example.c (+15/-0)
--------------------------------------------------------------------------------

[ff7a53553105] 2005-04-07 21:05:48 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove stale assertion.

Now that we let several pseudos be associated with one hardreg,
it may not be totally empty any more by the writeback phase.

Files: example.c (+0/-1)
--------------------------------------------------------------------------------

[b9abcff2aa65] 2005-04-07 21:05:47 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make the hardreg pseudo pointer be a _list_ of pseudos defined by the hardreg.

We often have more than one pseudo with the same value, notably
when generating a phi source. Use the new list tagging to tag
which ones are dead (and which ones need writeback).

Files: example.c (+59/-36)
--------------------------------------------------------------------------------

[9b7164c565f5] 2005-04-07 21:05:47 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add macros to set/read the pointer list tags.

[Auto-summary] Updates header lib.h. Changes: +9/-0 in 1 file(s)

Files: lib.h (+9/-0)
--------------------------------------------------------------------------------

[c08c251d04d7] 2005-04-07 21:05:47 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Beginning infrastructure for tagged lists.

Right now we verify that low bits are clear when inserting,
and clear them on use.

Files: lib.c (+3/-0), lib.h (+11/-9), sort.c (+3/-3)
--------------------------------------------------------------------------------

[7e726afa56ae] 2005-04-07 21:05:46 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Move remove_pseudo() to linearize.h

[Auto-summary] Modifies liveness.c. Updates header linearize.h. Changes: +4/-5 in 2 file(s)

Files: linearize.h (+4/-0), liveness.c (+0/-5)
--------------------------------------------------------------------------------

[1146117f9f2f] 2005-04-07 21:05:46 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Teach register "allocator" about preferred register targets.

Avoid a few silly reg-reg moves.

Files: example.c (+22/-9)
--------------------------------------------------------------------------------

[b4dcd7de0247] 2005-04-07 21:05:46 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add "stream_name()" helper function, and use it.

Much prettier than "input_streams[x].name", since most
users really don't want to know about the internals of
how the preprocessor lays out its stream tracking.

Files: compile-i386.c (+1/-1), compile.c (+1/-1), evaluate.c (+1/-1), lib.c (+1/-1), linearize.c (+3/-3), ... and 4 more
--------------------------------------------------------------------------------

[fd46a87b9e1d] 2005-04-07 21:05:45 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove stat-based file identity tests.

Replace it with a simple pathname comparison instead.

The pathname check is not only portable (no need for any
compatibility helper functions), but we can do it much
earlier, and thus make the check much cheaper by avoiding
three extra system calls when it triggers (open/fstat/close).

And the pathname test seems to match all the cases anyway.

Files: Makefile (+2/-2), compat-cygwin.c (+1/-6), compat-linux.c (+0/-1), compat-mingw.c (+1/-25), compat-solaris.c (+0/-2), ... and 6 more
--------------------------------------------------------------------------------

[126ff5fb4364] 2005-04-07 21:05:45 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "last_reg" be entry-point global rather than bb-global.

We don't want to always start from the same reg at each bb
entry.

Files: example.c (+17/-15)
--------------------------------------------------------------------------------

[346edcb8b1f8] 2005-04-07 21:05:45 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove some stale (and very confusing) register instantiation.

[Auto-summary] Modifies example.c. Changes: +1/-1 in 1 file(s)

Files: example.c (+1/-1)
--------------------------------------------------------------------------------

[45d84a60ee3f] 2005-04-07 21:05:44 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add a few more hard registers, and let things live a bit longer.

Our binops are destructive, but maybe we should try to copy
the destroyed register if it's still live.

Files: example.c (+30/-6)
--------------------------------------------------------------------------------

[5f3baf5f3df4] 2005-04-07 21:05:44 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. When updatign the liveness calculation, I forgot to update the code that moves "needs" information to the parent.

Now that we only add real needs to the needs list, this
is much simpler.

Files: liveness.c (+6/-8)
--------------------------------------------------------------------------------

[2aa587de0d23] 2005-04-07 21:05:44 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix liveness analysis.

Let's not add the pseudos that the bb defines internally onto
the "needs" list. Rather than removign them later, just avoid
putting them there in the first place.

The special cases end up being argument pseudos (which aren't
really defined by the entry bb) and phi-nodes.

Files: liveness.c (+5/-10)
--------------------------------------------------------------------------------

[784e1e5b85fd] 2005-04-07 21:05:43 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove phi source merging.

It looked good on paper. Not so good when actually trying
to generate code.

Files: cse.c (+1/-17), flow.c (+0/-10), linearize.c (+0/-2)
--------------------------------------------------------------------------------

[d11bce6c9b02] 2005-04-07 21:05:43 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up example storage usage details.

This actually makes some trivial cases come out almost right.

Files: example.c (+6/-5)
--------------------------------------------------------------------------------

[c221527abd86] 2005-04-07 21:05:43 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make storage tracking easier with a debugging "name" for each storage.

[Auto-summary] Modifies storage.c. Updates header storage.h. Changes: +23/-5 in 2 file(s)

Files: storage.c (+22/-4), storage.h (+1/-1)
--------------------------------------------------------------------------------

[542c4e7b26e7] 2005-04-07 21:05:42 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Generate code for conditional branches.

[Auto-summary] Modifies example.c. Changes: +61/-21 in 1 file(s)

Files: example.c (+61/-21)
--------------------------------------------------------------------------------

[cc4cde69798c] 2005-04-07 21:05:42 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove unreachable phi-node storage entries.

[Auto-summary] Modifies storage.c. Changes: +12/-10 in 1 file(s)

Files: storage.c (+12/-10)
--------------------------------------------------------------------------------

[a01ebd7c81e9] 2005-04-07 21:05:41 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: If we don't have any pre-defined incoming storage, select something. If we can try to go for a register, all the better.

[Auto-summary] Modifies example.c. Changes: +12/-1 in 1 file(s)

Files: example.c (+12/-1)
--------------------------------------------------------------------------------

[962279e898a2] 2005-04-07 21:05:41 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove OP_SETVAL after symbol-pseudo simplification.

We can just replace all users with the symbol pseudo
directly.

This means that we can no longer re-do symbol simplification
after CSE, and we need to rely on the generic memop simplification.

Files: linearize.c (+1/-1), simplify.c (+1/-1)
--------------------------------------------------------------------------------

[baceccd23394] 2005-04-07 21:05:41 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make our pitiful code generation a bit less pitiful.

You can kind of start seeing what it's trying to do.

Kind of.

Files: example.c (+173/-15)
--------------------------------------------------------------------------------

[14eb73dd7fb9] 2005-04-07 21:05:40 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Generate "code" for binops.

It ain't pretty, but that's not the aim right now.

Files: example.c (+171/-35)
--------------------------------------------------------------------------------

[382087f40271] 2005-04-07 21:05:40 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do some initial totally ridiculous "code generation" in the example.

And by "totally ridiculous", I mean "do one instruction,
and do it badly".

Files: example.c (+220/-25)
--------------------------------------------------------------------------------

[80759030ba5c] 2005-04-07 21:05:40 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Expose storage allocators to users of the storage code.

[Auto-summary] Modifies storage.c. Updates header storage.h. Changes: +18/-15 in 2 file(s)

Files: storage.c (+0/-15), storage.h (+18/-0)
--------------------------------------------------------------------------------

[7e1561f53b90] 2005-04-07 21:05:39 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix undefined symbol linearization case

Noted by Sam Ravnborg

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[065815d94eb9] 2005-04-07 21:05:39 -0700
Author: Sam Ravnborg <sam@ravnborg.org>
Subject: [PATCH] missing dependency for storage.o

Add dependency on .h files for storage.o

Files: Makefile (+1/-0)
--------------------------------------------------------------------------------

[be25179dcf5b] 2005-04-07 21:05:39 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Slowly, slowly, make the output of "example" slightly more readable.

I dunno if this will ever get anywhere.

Files: example.c (+82/-11)
--------------------------------------------------------------------------------

[a696ed3e5a8e] 2005-04-07 21:05:38 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Expose "show_instruction()" for debugging.

We already did this, we just didn't have a visible prototype.

Files: cse.c (+0/-2), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[fd5de508cae2] 2005-04-07 21:05:38 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "storage" be part of the sparse library, and split out the "example output" program from it.

[Auto-summary] Modifies 2 source files: example.c, storage.c. Updates header storage.h. Modifies build system. Changes: +137/-109 in 4 file(s)

Files: Makefile (+3/-2), example.c (+69/-0), storage.c (+11/-107), storage.h (+54/-0)
--------------------------------------------------------------------------------

[37a29afc774f] 2005-04-07 21:05:38 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Start splitting out generic "storage" handling from example.c

Start by renaming.

Files: example.c => storage.c (+0/-0)
--------------------------------------------------------------------------------

[c2d56200a022] 2005-04-07 21:05:37 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Small cleanups for example storage handling.

Next step: start generating x86-like code for simple
instructions.

Files: example.c (+83/-42)
--------------------------------------------------------------------------------

[67d5655f46c3] 2005-04-07 21:05:37 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Expose "show_bb()" for debugging, and make it do more appropriate white-space.

[Auto-summary] Modifies linearize.c. Updates header linearize.h. Changes: +2/-1 in 2 file(s)

Files: linearize.c (+1/-1), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[d715df003137] 2005-04-07 21:05:37 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow -vv as shorthand for "-v -v" aka "very verbose".

[Auto-summary] Modifies lib.c. Changes: +3/-1 in 1 file(s)

Files: lib.c (+3/-1)
--------------------------------------------------------------------------------

[fa9146d9c798] 2005-04-07 21:05:36 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: CSE may have caused more unreachable bb's, so do a second reachability pass after CSE.

[Auto-summary] Modifies linearize.c. Changes: +1/-0 in 1 file(s)

Files: linearize.c (+1/-0)
--------------------------------------------------------------------------------

[b6fabb1243cc] 2005-04-07 21:05:36 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove unreachable bb's from the list of bb's when we kill them.

[Auto-summary] Modifies flow.c. Changes: +3/-0 in 1 file(s)

Files: flow.c (+3/-0)
--------------------------------------------------------------------------------

[a6679a16ee82] 2005-04-07 21:05:36 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add silly storage handling example.

This one links up the inter-bb usage pseudos to each other
with "storage" structures, which should make it possible to
write a simple code generator that doesn't need to worry
about any global state - all the decisions are local.

There are probably cases where this simply doesn't work, but
I want to try to start generating _some_ code at least.

Files: Makefile (+5/-1), example.c (+307/-0)
--------------------------------------------------------------------------------

[8c08c764f0a0] 2005-04-07 21:05:35 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be more aggressive on PHI-node CSE.

We don't care _where_ a PHI-node is, since the real location
is at the phi sources. So unlike other instructions, we do not
bother with any dominance analysis - we can just combine them
blindly across basic block borders.

It might make sense to totally disconnect the PHI nodes from
the flow graph to make this lack of positional information
even more explicit. That might also allow us to combine more
basic blocks.

Files: cse.c (+10/-3)
--------------------------------------------------------------------------------

[2d8d9bda5918] 2005-04-07 21:05:35 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make OP_PHISOURCE track the OP_PHI instructions that it defines.

This allows us to always see which pseudos are nonlocally affected
by the phi source.

We can only do this after the instruction flow is fixed, together
with the OP_DEATHNOTE phase.

Files: cse.c (+2/-4), lib.h (+2/-0), linearize.c (+9/-4), linearize.h (+4/-0), liveness.c (+16/-1), ... and 1 more
--------------------------------------------------------------------------------

[572561dcb58a] 2005-04-07 21:05:35 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't output code for static/toplevel symbols.

It's cute and useful for debugging, but it ends up doing the wrong
thing, since now CSE and liveness analysis will see the intial values
as the "dynamic" ones, and make the wrong kind of assumptions about
dominating stores etc.

Files: linearize.c (+4/-0)
--------------------------------------------------------------------------------

[7abd3578c5ce] 2005-04-07 21:05:34 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Linearize anonymous symbol initializers when we encounter them,

Also fix the printout of such unnamed symbol pseudos.

Files: linearize.c (+9/-11)
--------------------------------------------------------------------------------

[5a1214494698] 2005-04-07 21:05:34 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't set the base type for __attribute__((__mode__(__DI__))) and friends.

That makes sparse unhappy if the base type has already been set by
other parts of the declaration - it will refuse to mix base types.

Problem reported by Santtu Hyrkkï¿½

Files: parse.c (+0/-4)
--------------------------------------------------------------------------------

[08778dab2167] 2005-04-07 21:05:34 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify constant unops

[Auto-summary] Modifies simplify.c. Changes: +18/-1 in 1 file(s)

Files: simplify.c (+18/-1)
--------------------------------------------------------------------------------

[100329bcbf57] 2005-04-07 21:05:33 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix inlining of STMT_ASM.

Now that we actually save, evaluate and use the asm arguments,
we need to make sure to copy them properly too.

Files: inline.c (+15/-1)
--------------------------------------------------------------------------------

[771f628164f5] 2005-04-07 21:05:33 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When we simplify branches-to-branches, assert that we actually found the right branch.

[Auto-summary] Modifies flow.c. Changes: +8/-5 in 1 file(s)

Files: flow.c (+8/-5)
--------------------------------------------------------------------------------

[6ce70df8a96b] 2005-04-07 21:05:33 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up debug output from warning.

[Auto-summary] Modifies linearize.c. Changes: +1/-1 in 1 file(s)

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[18c447b81ddd] 2005-04-07 21:05:32 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: Mark asms as having side effects, so that we don't short-circuit them.

[Auto-summary] Modifies flow.c. Changes: +8/-0 in 1 file(s)

Files: flow.c (+8/-0)
--------------------------------------------------------------------------------

[f614a4548528] 2005-04-07 21:05:32 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: Fix list_ptr split operation.

We didn't set the back-pointer of the "next" entry properly.
Not a lot of code cares, since most things just walk forward.

Files: lib.c (+8/-5)
--------------------------------------------------------------------------------

[6f033c38cdb0] 2005-04-07 21:05:32 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix silly asm input pseudo linearization.

We used the output list instead of the input list ;)

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[3ef4c49c56b3] 2005-04-07 21:05:31 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Teach liveness analysis about asm pseudo usage.

[Auto-summary] Modifies liveness.c. Changes: +10/-0 in 1 file(s)

Files: liveness.c (+10/-0)
--------------------------------------------------------------------------------

[8d14c3ff8e3c] 2005-04-07 21:05:31 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Linearize inline asm statements

This doesn't actually save the register class information, so
you can't do proper register allocation, but it does all the
input reading and store to outputs.

Still need to teach the liveness analysis about the _usage_ rules.

Files: linearize.c (+81/-3), linearize.h (+6/-0)
--------------------------------------------------------------------------------

[6a576714921a] 2005-04-07 21:05:31 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Evaluate asm statement inputs/outputs and verify them.

[Auto-summary] Modifies evaluate.c. Changes: +60/-2 in 1 file(s)

Files: evaluate.c (+60/-2)
--------------------------------------------------------------------------------

[f68eb72f3208] 2005-04-07 21:05:30 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Now that we actually save off asm info, that showed how we had never actually parsed the string itself properly. Fix it up.

[Auto-summary] Modifies parse.c. Changes: +1/-1 in 1 file(s)

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[5f339344f6d8] 2005-04-07 21:05:30 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Save away (most) of the asm information when parsing inline assembly.

The named parameter thing is still unsupported. And the format we save
things into is for simple saving rather than real usability.

Files: parse.c (+11/-8), parse.h (+6/-0)
--------------------------------------------------------------------------------

[723f56a0d087] 2005-04-07 21:05:30 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Yet another missed "entry" change point.

Umm. The compiler even warned about it, I don't see how I
could miss it. I'm a maroon.

Files: cse.c (+1/-1)
--------------------------------------------------------------------------------

[1367a00f59fd] 2005-04-07 21:05:29 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Much cleaner entrypoint dominance handling: instead of making the entry bb magical, just make the OP_ENTRY instruction act like an OP_CALL from a dominance standpoint: it dominates all non-local memory operations.

This removes yet another special case.

Files: flow.c (+1/-1), memops.c (+0/-7)
--------------------------------------------------------------------------------

[549265119d65] 2005-04-07 21:05:29 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. The "entry instruction" changes missed the check for the entry basic block in memop dominators.

This caused the dominator finding to totally misjudge a lot of
non-local loads as having no dominators (or thinking they were
being completely dominated by a store that just updated them).

Files: memops.c (+1/-1)
--------------------------------------------------------------------------------

[d88ba07266f7] 2005-04-07 21:05:29 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: Now that we track argument pseudo liveness, make sure to not complain about them when they are live when coming into the function.

Only non-arg pseudos are bad.

Files: check.c (+8/-2)
--------------------------------------------------------------------------------

[d6d2b715f5ec] 2005-04-07 21:05:28 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix conditional branch to same target simplification.

We should clear out "insn->cond" when turning it into
an unconditional branch, anything else will confuse us
later (kill_use() will set it to VOID, that's not good
enough).

Move it to simplify.c at the same time.

Files: flow.c (+0/-8), simplify.c (+12/-0)
--------------------------------------------------------------------------------

[f1d79f98cb7f] 2005-04-07 21:05:28 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix flow: we only remove one parent at a time. The same block might be parent of another block several times.

[Auto-summary] Modifies linearize.c. Changes: +1/-1 in 1 file(s)

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[5ed53da90149] 2005-04-07 21:05:28 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix pointer list "pack" operation.

When we packed away the first entry in the list, we didn't
restart properly.

Files: lib.c (+1/-0)
--------------------------------------------------------------------------------

[422bd24978f1] 2005-04-07 21:05:27 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make the "entrypoint" be a special OP_ENTRY instruction instead of a special basic block.

This removes a lot of special cases, since now flow doesn't have any
special BB to worry about. It also gives a clear definition point for
argument pseudos, and thus makes liveness tracking lose a special
case.

Files: check.c (+2/-2), flow.c (+2/-7), linearize.c (+15/-7), linearize.h (+5/-1)
--------------------------------------------------------------------------------

[a2fcb6ce7391] 2005-04-07 21:05:27 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Expose "show_pseudo()" to the world.

We want to use it in almost any debugging schenario, so why not
just admit that.

Files: linearize.c (+1/-1), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[9a85f5e3343a] 2005-04-07 21:05:27 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Track argument pseudo lifetimes too.

This requires that we be able to handle "uses" pseudos without
a defining instruction.

Files: linearize.c (+2/-2), liveness.c (+2/-14)
--------------------------------------------------------------------------------

[b6d2fa5bac3f] 2005-04-07 21:05:26 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add pseudo death-note tracking.

Now that we have full pseudo usage lists, we can also add
deathnotes to pseudos in the instruction stream.

NOTE! We add the deathnote to _before_ the last instruction
that uses that pseudo. That looks a bit strange, but it's
actually what you want: when we traverse the instuctions, we
want to know that the inputs are dead.

Files: flow.h (+2/-0), linearize.c (+7/-0), linearize.h (+1/-0), liveness.c (+124/-58)
--------------------------------------------------------------------------------

[5aad28f0caa7] 2005-04-07 21:05:26 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add INSERT_CURRENT() macro to insert a new entry at the point we are now when traversing a list.

NOTE! If you traverse it forwards, the next entry you'll
see is the current entry, since we do not change where
in the list we are!

Files: lib.c (+14/-0), lib.h (+27/-0)
--------------------------------------------------------------------------------

[3f226e97529c] 2005-04-07 21:05:26 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow anybody to declare their own allocator by making the helper macros available in the "allocate.h" header file.

The declarations stay in "allocate.c" for now, but at least
you _can_ make private allocators now if you want to.

Files: allocate.c (+14/-41), allocate.h (+25/-0)
--------------------------------------------------------------------------------

[853d7d9aed21] 2005-04-07 21:05:25 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up dependencies for allocate.c

[Auto-summary] Modifies build system. Changes: +1/-0 in 1 file(s)

Files: Makefile (+1/-0)
--------------------------------------------------------------------------------

[2035e136c41f] 2005-04-07 21:05:25 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Split out the blob allocator from lib.c into allocate.c.

It's disgusting how intimate lib.c is with all the types,
and this is slowly trying to split things up a bit. Now
the intimate part is in allocate.c, but maybe we can get
to the point where each allocation user just declares its
own allocation strategy, and just uses the generic routines
in allocate.c

Files: Makefile (+3/-2), allocate.c (+149/-0), allocate.h (+46/-0), check.c (+1/-0), compat-cygwin.c (+1/-0), ... and 23 more
--------------------------------------------------------------------------------

[34c0cd11a436] 2005-04-07 21:05:25 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Move declaration of "die()" to lib.h and check its format.

Fix the format errors this exposed.

Files: compat/mmap-blob.c (+2/-2), lib.h (+7/-6), token.h (+0/-1)
--------------------------------------------------------------------------------

[b82a180b5fe4] 2005-04-07 21:05:24 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. OP_SEL simplification tried to kill the wrong pseudo ;)

[Auto-summary] Modifies simplify.c. Changes: +1/-1 in 1 file(s)

Files: simplify.c (+1/-1)
--------------------------------------------------------------------------------

[c08ff7ab5ea4] 2005-04-07 21:05:24 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Walk the basic-block list in reverse order for liveness analysis (this approximates depth-first) rather than in-order (~breadth first).

This hugely speeds up long chains pseudo use.

Files: liveness.c (+2/-2)
--------------------------------------------------------------------------------

[ec8889740d90] 2005-04-07 21:05:24 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be more graceful about missing types and malformed expressions.

[Auto-summary] Modifies 2 source files: expand.c, linearize.c. Changes: +7/-5 in 2 file(s)

Files: expand.c (+1/-1), linearize.c (+6/-4)
--------------------------------------------------------------------------------

[fc2a10fc92d4] 2005-04-07 21:05:23 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow parsing of nested functions.

We don't actually support the crap. Some of it happens to
kind of do the same thing, but we should warn loudly. In
the meantime, it allows more of the gcc testsuit things to
show _real_ problems.

Files: parse.c (+14/-7)
--------------------------------------------------------------------------------

[b034f459a3b0] 2005-04-07 21:05:23 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be more careful with symbol sizes - don't SIGSEGV on undefined stuff.

[Auto-summary] Modifies linearize.c. Changes: +17/-12 in 1 file(s)

Files: linearize.c (+17/-12)
--------------------------------------------------------------------------------

[523863dba2ee] 2005-04-07 21:05:23 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Follow OP_SEL -> OP_BR flow and simplify the branch.

[Auto-summary] Modifies simplify.c. Changes: +23/-0 in 1 file(s)

Files: simplify.c (+23/-0)
--------------------------------------------------------------------------------

[f4838f470381] 2005-04-07 21:05:22 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove OP_SETCC, make OP_SEL bigger instead.

This was originally done so that "struct instruction" would be
smaller, but it has since grown anyway (for the memops), so splitting
OP_SEL into two instructions no longer makes sense, and makes it
harder on CSE.

Files: cse.c (+10/-6), linearize.c (+21/-30), linearize.h (+3/-4), liveness.c (+1/-6), simplify.c (+22/-30)
--------------------------------------------------------------------------------

[7d3d2f57278d] 2005-04-07 21:05:22 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix embarrassing linearized bug with empty iterator post-conditions.

A simple "for (;;)" wouldn't linearize properly.

Files: linearize.c (+6/-9)
--------------------------------------------------------------------------------

[98307d4dea6d] 2005-04-07 21:05:22 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When simplifying memops, follow the whole chain of adds/subs.

This means we find multiple cases faster, but more importantly,
it also means that if the chain is infinite, we can trivially
notice. We used to just notice immediate recursive uses, not the
more complex cases.

Files: simplify.c (+18/-2)
--------------------------------------------------------------------------------

[ac0a6eccafcb] 2005-04-07 21:05:21 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix thinko. If we follow a conditional branch, we should _not_ also try to rewrite the target, since we're now not even going to reach that instruction.

More importantly, rewriting the first conditional branch will
have removed the parent to the second one, so then checking for
"single parent" will _not_ mean that we were it. Quite the reverse.

Files: flow.c (+1/-1)
--------------------------------------------------------------------------------

[95a62d3603ee] 2005-04-07 21:05:21 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Duh! Remove a very very incorrect left-over flow simplification call.

Flow simplification depends on liveness analysis, so we really can't
do it early any more. I'd missed one call to it when I re-organized
things, and this call would totally mess up the flow because it thought
there were no pseudos being defined or used anywhere..

Files: linearize.c (+0/-1)
--------------------------------------------------------------------------------

[e5d6e0a6ccb5] 2005-04-07 21:05:21 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow conditional branch following to trigger more often.

Only phi-simplification needs to limit itself to REG_PSEUDO, the
regular branch simplification can take arbitrary pseudo types.

Also, don't stop after successfully following the true branch:
try the false branch too.

Files: flow.c (+15/-17)
--------------------------------------------------------------------------------

[2b63dc96defe] 2005-04-07 21:05:20 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Implement conditional branch following when simplifying branches.

[Auto-summary] Modifies flow.c. Changes: +50/-5 in 1 file(s)

Files: flow.c (+50/-5)
--------------------------------------------------------------------------------

[9af72d9408e3] 2005-04-07 21:05:20 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Dang. Bitten by that non-canonical phi-list thing again.

phi sources that get deleted have a NULL bb. Live with it.

Files: flow.c (+6/-2)
--------------------------------------------------------------------------------

[50af63920b9c] 2005-04-07 21:05:19 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Split up branch flow simplification a bit in preparation for adding conditional branch following.

[Auto-summary] Modifies flow.c. Changes: +19/-15 in 1 file(s)

Files: flow.c (+19/-15)
--------------------------------------------------------------------------------

[59070f30ecdb] 2005-04-07 21:05:19 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify seteq/setne $0 + conditional branch.

[Auto-summary] Modifies simplify.c. Changes: +37/-3 in 1 file(s)

Files: simplify.c (+37/-3)
--------------------------------------------------------------------------------

[b309c35aaa1c] 2005-04-07 21:05:19 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: A sparse "context" instruction has side effects. Don't allow branch simplification to jump over them.

[Auto-summary] Modifies flow.c. Changes: +1/-0 in 1 file(s)

Files: flow.c (+1/-0)
--------------------------------------------------------------------------------

[3f7c3bf7a3ce] 2005-04-07 21:05:18 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't try to share parenthood fn between phi node removal and regular CSE.

The CSE case is totally different: since both children use the same
pseudos, there can be no question that a common parent wouldn't
have that pseudo live.

Files: cse.c (+15/-1), flow.h (+0/-3), simplify.c (+2/-12)
--------------------------------------------------------------------------------

[9f1e671ad17c] 2005-04-07 21:05:18 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify "setcc + select $0<->$1" into "setne/seteq".

It's a common idiom, keep it in common format.

Files: simplify.c (+29/-7)
--------------------------------------------------------------------------------

[a938a48908ba] 2005-04-07 21:05:18 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do real flow simplification only after liveness analysis.

The "constant conditional" stuff in flow simplification is now
handled by the trivial instruction simplification, so the only
thing that remained was the conditional flow based on following
constant PHI-nodes. And that one can be much more effectively
done after liveness analysis, when we can decide to skip even
non-empty blocks if the target we are skipping to doesn't care
about this particular block.

Files: flow.c (+68/-26), flow.h (+5/-1), linearize.c (+15/-2), liveness.c (+19/-1)
--------------------------------------------------------------------------------

[2e3d4000b541] 2005-04-07 21:05:17 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Move constant switch simplification to the instruction simplification phase.

[Auto-summary] Modifies 2 source files: flow.c, simplify.c. Changes: +27/-37 in 2 file(s)

Files: flow.c (+0/-37), simplify.c (+27/-0)
--------------------------------------------------------------------------------

[d984f00104a6] 2005-04-07 21:05:17 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Cleanup. Move the OP_SEL and OP_BR simplification out into their own functions.

This makes ready for moving the OP_BR phi-following to
the instruction simplification phase.

Files: simplify.c (+29/-18)
--------------------------------------------------------------------------------

[398391154f40] 2005-04-07 21:05:17 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: After doing liveness analysis, remove purely internal defs from def list.

The bb register usage lists are now just the minimal set of pseudos
that are relevant for parents/children.

Files: liveness.c (+16/-0)
--------------------------------------------------------------------------------

[19903f1a69a4] 2005-04-07 21:05:16 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify trivial casts (and handle pointers specially).

This does trivial simplification of casting to the same
typesize. HOWEVER. We split casts up into whether they
cast to a dereferencable pointer type or not, and we don't
simplify pointer casts. This should mean that if we
ever want to do type-based alias analysis, we can still
avoid casted accesses.

(If we do type-based alias analysis, we'll also need to make
a union access do a cast. Which we probably should do anyway).

Files: linearize.c (+25/-1), linearize.h (+1/-0), liveness.c (+1/-0), simplify.c (+19/-0)
--------------------------------------------------------------------------------

[546421fac226] 2005-04-07 21:05:16 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be more forgiving about missing types in linearization.

No need to SIGSEGV just because the program is crap ;)

Files: linearize.c (+22/-12)
--------------------------------------------------------------------------------

[53fab6929714] 2005-04-07 21:05:16 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't go off into infinite loops when some undefined program updates a variable where the only def is the update itself.

Testcase from Alexey Dobriyan

Files: simplify.c (+7/-0)
--------------------------------------------------------------------------------

[1bd5d04ea9c6] 2005-04-07 21:05:15 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Rename "register.c" into "liveness.c". That's what it does.

[Auto-summary] Modifies 2 source files: linearize.c, register.c => liveness.c. Updates header flow.h. Modifies build system. Changes: +7/-7 in 4 file(s)

Files: Makefile (+2/-2), flow.h (+1/-1), linearize.c (+1/-1), register.c => liveness.c (+3/-3)
--------------------------------------------------------------------------------

[12e60e8379af] 2005-04-07 21:05:15 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Associate pseudos with the symbol name whose value they got.

This is purely for debugging. It's only used to show what symbol
a pseudo might be (and I stress "might", since CSE can and does
screw it up) associated with.

Also print out the def list for a basic block when verbose.

It all makes it a bit easier to guess what's up.

Files: flow.c (+2/-0), linearize.c (+15/-3), linearize.h (+1/-0), memops.c (+1/-0)
--------------------------------------------------------------------------------

[d2819bbda2bf] 2005-04-07 21:05:15 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't add phi-nodes to the use/def lists, always add just the nodes they use/def.

[Auto-summary] Modifies register.c. Changes: +24/-6 in 1 file(s)

Files: register.c (+24/-6)
--------------------------------------------------------------------------------

[55a0bc255b47] 2005-04-07 21:05:14 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow multiple levels of verbosity, and print out the _really_ uninteresting parts only with "-v -v". Dead blocks in particular.

Also, don't even put a pseudo on the OP_RET if were a void
function. That makes the liveness analysis happier.

Files: check.c (+3/-0), lib.c (+1/-1), linearize.c (+24/-21)
--------------------------------------------------------------------------------

[0c5a9f95b494] 2005-04-07 21:05:14 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Start tracking cross-basic-block pseudo usage.

This should basically allow us to do register allocation. Or
maybe it's too broken. But the results look reasonable from a
quick manual peek.

Files: linearize.c (+18/-1), linearize.h (+1/-2), register.c (+71/-11)
--------------------------------------------------------------------------------

[89e78a3b4700] 2005-04-07 21:05:14 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Start using instruction sizes properly.

We should drop symbol types by now, and base things on just raw
sizes. Anything else just doesn't work from a CSE standpoint.

Some things may care about actual types later, notably the type-
based alias analysis. Those types still exist in the cast nodes.

Also, make the printout be more readable.

Files: cse.c (+3/-1), flow.c (+6/-8), linearize.c (+212/-197), linearize.h (+3/-3), memops.c (+1/-1), ... and 1 more
--------------------------------------------------------------------------------

[d2cf6de88b22] 2005-04-07 21:05:13 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. Don't try to CSE OP_SEL, at least not until we learn to CSE it together with the OP_SETCC that goes with it ;)

[Auto-summary] Modifies cse.c. Changes: +2/-2 in 1 file(s)

Files: cse.c (+2/-2)
--------------------------------------------------------------------------------

[ebbb9072ce76] 2005-04-07 21:05:13 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't get confused by infinite loops. They happen, and we shouldn't try to follow the branch infinitely.

[Auto-summary] Modifies flow.c. Changes: +6/-1 in 1 file(s)

Files: flow.c (+6/-1)
--------------------------------------------------------------------------------

[b1796144a820] 2005-04-07 21:05:13 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Pair up removals from parents and children properly.

We didn't remove the child pointer when we removed the parent,
which invariably leads to inconsistencies later on.

Files: flow.c (+1/-0)
--------------------------------------------------------------------------------

[b6100a46cce6] 2005-04-07 21:05:12 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remember to kill the use of the conditional if both arms do the same thing.

[Auto-summary] Modifies flow.c. Changes: +1/-0 in 1 file(s)

Files: flow.c (+1/-0)
--------------------------------------------------------------------------------

[726a641eadca] 2005-04-07 21:05:12 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix test for entrypoint. Since we can rewrite branches to it, it's not correct to assume that a bb without parents is the entrypoint.

[Auto-summary] Modifies memops.c. Changes: +5/-1 in 1 file(s)

Files: memops.c (+5/-1)
--------------------------------------------------------------------------------

[ee2e63eb742d] 2005-04-07 21:05:12 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix entrypoint branch rewriting..

[Auto-summary] Modifies flow.c. Changes: +3/-1 in 1 file(s)

Files: flow.c (+3/-1)
--------------------------------------------------------------------------------

[0923bd7ded0b] 2005-04-07 21:05:11 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When replacing OP_SWITCH with OP_BR, make sure to remove all but one child.

[Auto-summary] Modifies linearize.c. Changes: +3/-1 in 1 file(s)

Files: linearize.c (+3/-1)
--------------------------------------------------------------------------------

[2225f90e34bb] 2005-04-07 21:05:11 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add entrypoint pointer to each bb.

Very useful for debugging, since otherwise it's often
impossible to find all the other basic blocks.

Files: linearize.c (+19/-18), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[7882a94f224d] 2005-04-07 21:05:11 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. Fix silly typo. Small but deadly - it broke the counted ptr replace.

Which explains why the flow info was all bad. Duh.

Files: lib.c (+1/-1)
--------------------------------------------------------------------------------

[cd181886e7fe] 2005-04-07 21:05:10 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When turning a conditional branch into an unconditional one, remember to remove one parent..

Let's make sure that the flow information always matches the
instruction.

Files: flow.c (+5/-1)
--------------------------------------------------------------------------------

[438969f32585] 2005-04-07 21:05:10 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up bb merging a bit. Still chasing "the bug".

[Auto-summary] Modifies flow.c. Changes: +5/-9 in 1 file(s)

Files: flow.c (+5/-9)
--------------------------------------------------------------------------------

[f4b2e9f3721f] 2005-04-07 21:05:10 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Check switch and computed goto target lists too when verifying.

And don't remove a parent from a list when "rewrite_parent_brach()"
should already have updated the flow properly.

Files: flow.c (+7/-1)
--------------------------------------------------------------------------------

[9c9b53ee5521] 2005-04-07 21:05:09 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add a flow verification thing.

Let's try to make sure that once I get these flow bugs ironed
out they won't come creeping back in.

Files: flow.c (+64/-0), flow.h (+1/-0), linearize.c (+2/-0)
--------------------------------------------------------------------------------

[c1b6cc7405d2] 2005-04-07 21:05:09 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be more careful when rewriting parent branches.

The act of rewriting a parent branch may change the list of
parents, so...

There are still more bb rewriting bugs hiding, but I'll get
them all and their little dogs too!

Files: flow.c (+9/-7)
--------------------------------------------------------------------------------

[95c240a15d37] 2005-04-07 21:05:09 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remember to pack the pointer list after deleting entries from it.

[Auto-summary] Modifies lib.c. Changes: +3/-1 in 1 file(s)

Files: lib.c (+3/-1)
--------------------------------------------------------------------------------

[64fa258e7391] 2005-04-07 21:05:08 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do CSE over children with trivially common parents.

Hey, it's simple, and it happens.

Files: cse.c (+21/-1)
--------------------------------------------------------------------------------

[e19250992c2b] 2005-04-07 21:05:08 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow CSE to run after bb packing.

...but we can't merge phi-sources after packing. Or rather, we
could, but we'll have to be more careful about not re-ordering
them, which we aren't. Sort it out later.

Files: cse.c (+5/-1), flow.c (+18/-0), lib.h (+1/-1), linearize.c (+5/-6)
--------------------------------------------------------------------------------

[e533ccc8e366] 2005-04-07 21:05:08 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make list-ptr remove/replace take a count.

It will assrt if it can't find that many entries. 

Zero means "all the ones you can find", aka old behaviour.

Files: flow.c (+4/-4), lib.c (+9/-10), lib.h (+2/-2), linearize.c (+1/-1), linearize.h (+5/-5), ... and 1 more
--------------------------------------------------------------------------------

[63949df837a8] 2005-04-07 21:05:07 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Expose the "trivial common parent" logic that we use for phi node re-writing.

We'll want to do it for CSE too.

Files: flow.h (+3/-0), simplify.c (+12/-2)
--------------------------------------------------------------------------------

[073b3c2cca2e] 2005-04-07 21:05:07 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add "memop" simplification phase.

It's a bit more simple-minded than the symbol simplification,
and it can be more costly. So we start off with the (cheap)
symbol simplification algorithm, and then use this new more
generic phase later.

This allows us to remove extra loads (and, in theory, stores,
but the dead store elimination is so simple-minded right now
that it's effectively useless).

Files: Makefile (+2/-1), cse.c (+2/-1), flow.h (+1/-0), memops.c (+195/-0)
--------------------------------------------------------------------------------

[602f6b6c0d41] 2005-04-07 21:05:07 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Leave symbol pseudo usage intact when doing phi-node conversion.

There's actually a reason we leave a bogus usage list for symbol
pseudo's: they are special, and they traverse the list _while_
doing cleanup, and changing the list while they are traversing
it is a bad idea.

Also, symbol pseudos have special usage rules, and know "where"
the usage is in an instruction, so they can (and do) check when
their usage has changed.

Files: flow.c (+3/-1)
--------------------------------------------------------------------------------

[38284a4708cb] 2005-04-07 21:05:06 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: We had a big comment about destroying the use chains. So fix it already.

[Auto-summary] Modifies flow.c. Changes: +1/-10 in 1 file(s)

Files: flow.c (+1/-10)
--------------------------------------------------------------------------------

[895b9648477f] 2005-04-07 21:05:06 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't add the fake parent to the entryblock - we don't need it.

[Auto-summary] Modifies linearize.c. Changes: +0/-3 in 1 file(s)

Files: linearize.c (+0/-3)
--------------------------------------------------------------------------------

[8ce4e40bb907] 2005-04-07 21:05:06 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Expose "dominates()" function for memop domination checking.

And rename the argument.

Files: flow.c (+7/-8), flow.h (+1/-0)
--------------------------------------------------------------------------------

[2c3d706dc9f8] 2005-04-07 21:05:05 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Export the load instruction conversion functions.

And clean up naming while at it ("insn" -> "instruction"). Shorthand
is fine for local things, but when we expose them globally we're
better off typing a few extra characters.

Files: flow.c (+6/-6), flow.h (+3/-0)
--------------------------------------------------------------------------------

[3f72e1fd738b] 2005-04-07 21:05:05 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix check for "local" symbols.

They don't have to be MOD_EXTERN to be visible to others, MOD_TOPLEVEL
does the same thing. So add a MOD_NONLOCAL helper #define to remind us
what we're really after.

Files: flow.c (+2/-2), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[60039668043e] 2005-04-07 21:05:05 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Trying to use the new RECURSE() on any non-trivial list showed a few problems..

[Auto-summary] Updates header lib.h. Changes: +5/-1 in 1 file(s)

Files: lib.h (+5/-1)
--------------------------------------------------------------------------------

[31522eac8c9d] 2005-04-07 21:05:04 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add fancy "RECURSE_PTR_REVERSE()" helper function.

It does what the name kind of suggests: it creates a new recursive
walker starting at where we are now, walking backwards.

Files: lib.h (+16/-0)
--------------------------------------------------------------------------------

[2b37cb869e16] 2005-04-07 21:05:04 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make linearizer use the proper inc/dec operation value.

[Auto-summary] Modifies linearize.c. Changes: +1/-1 in 1 file(s)

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[87900e832ac3] 2005-04-07 21:05:04 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make expression tree have an "op value" for the inc/dec operations.

Needed for pointer inc/dec. These things are all supposed to be
all set by the type evaluation phase, so that later parts don't
need to worry.

Files: evaluate.c (+14/-6), expression.h (+4/-1)
--------------------------------------------------------------------------------

[b52da4273ace] 2005-04-07 21:05:03 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix subtle problem with fn array arguments

We used to (long ago) consider a zero bit_size to be a sign
of the symbol type needing to be examined. However, when I
changed that to use an explicit "examined" flag, I didn't
realize that the function argument degeneration had depended
on that.

So make the function argument degeneration explicitly ask for
re-examination after changing it to a pointer. Otherwise it
ends up being a "zombie pointer" of size 0, which makes for
lots of confusion.

Files: evaluate.c (+1/-0)
--------------------------------------------------------------------------------

[14781fa1f7d3] 2005-04-07 21:05:03 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Nonlocal memops are non-determinedly dominated by the entry.

[Auto-summary] Modifies flow.c. Changes: +3/-0 in 1 file(s)

Files: flow.c (+3/-0)
--------------------------------------------------------------------------------

[b22aa7228d7f] 2005-04-07 21:05:03 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Teach 'memop' simplification about offsetting.

Handle simple constant offsets and fold them into the
memop offset.

Files: simplify.c (+19/-0)
--------------------------------------------------------------------------------

[10c21653c164] 2005-04-07 21:05:02 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify constant subtraction into addition.

We're much better at simplifying addition, so let's try to fix it
up.

Files: simplify.c (+8/-1)
--------------------------------------------------------------------------------

[06242e217c91] 2005-04-07 21:05:02 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be a lot more careful when re-writing branches.

Besides, the code is cleaner now - we can use our helper functions.

Files: flow.c (+3/-11), linearize.h (+6/-0)
--------------------------------------------------------------------------------

[fcf778f11624] 2005-04-07 21:05:02 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix total braino in empty block packing.

[Auto-summary] Modifies flow.c. Changes: +1/-3 in 1 file(s)

Files: flow.c (+1/-3)
--------------------------------------------------------------------------------

[7f802cb4d56c] 2005-04-07 21:05:01 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. Fix pseudo usage for OP_COMPUTEDGOTO.

[Auto-summary] Modifies register.c. Changes: +1/-0 in 1 file(s)

Files: register.c (+1/-0)
--------------------------------------------------------------------------------

[7df3f1466ece] 2005-04-07 21:05:01 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add some more trivial constant simplifications.

[Auto-summary] Modifies simplify.c. Changes: +14/-0 in 1 file(s)

Files: simplify.c (+14/-0)
--------------------------------------------------------------------------------

[ff5cc9636a30] 2005-04-07 21:05:01 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add a semblance of sanity to structure member accesses.

Just a semblance, though.

The rule at this point is that alignment etc doesn't matter (pure
code generation issue), and the only thing that matters is whether
accesses overlap. This probably doesn't get it right either, but
it gets closer.

Files: linearize.c (+37/-50)
--------------------------------------------------------------------------------

[491b00ba350e] 2005-04-07 21:05:00 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Kill long-dead pseudo-reuse code.

We don't have usage counters, we have usage lists these days.

Files: linearize.c (+1/-4), linearize.h (+1/-2)
--------------------------------------------------------------------------------

[a9f0a5fe6aa4] 2005-04-07 21:05:00 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use "has_use_list()" to determine whether to clear it on killing pseudo.

Don't roll your own logic, since this needs to keep in sync with
usage.

Files: flow.c (+4/-6)
--------------------------------------------------------------------------------

[59a346978545] 2005-04-07 21:05:00 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add a final pseudo usage tracking phase, which keeps track of which instructions use which pseudos.

It also verifies the usage, which shows a few bugs in
structure handling.

Files: Makefile (+2/-1), flow.h (+2/-0), linearize.c (+3/-0), linearize.h (+2/-0), register.c (+155/-0)
--------------------------------------------------------------------------------

[a4d8f9e57df4] 2005-04-07 21:04:59 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix pseudo->def on OP_PHI->OP_SEL conversion.

We forgot to set the "def" to point to the new OP_SEL
instruction.

Files: linearize.c (+7/-1)
--------------------------------------------------------------------------------

[fbc2d3f727fb] 2005-04-07 21:04:59 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be more careful about insn->bb pointers.

Make sure to clear them when turning operations into NOP's. And when
doing OP_LOAD->OP_PHI conversion, just re-use the target pseudo,
which means that we don't need to unnecessarily move all the uses
over.

Files: cse.c (+1/-0), flow.c (+1/-5)
--------------------------------------------------------------------------------

[c857a51ea8e8] 2005-04-07 21:04:59 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up "linearize_symbol()" by making the function linearizer (which was the bulk of it) a function of its own.

No code changes, but this gets rid of two levels of indentation.

Files: linearize.c (+65/-59)
--------------------------------------------------------------------------------

[6e78e867f10a] 2005-04-07 21:04:58 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make compile-i386.c get with the program. We don't just use untyped "struct ptr_list **", we use properly typed ones.

[Auto-summary] Modifies compile-i386.c. Changes: +9/-3 in 1 file(s)

Files: compile-i386.c (+9/-3)
--------------------------------------------------------------------------------

[f49eaba11f55] 2005-04-07 21:04:58 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Who says you can't do type-safe function-overloading in C?

You just have to be a bit crazy (*), and use "__typeof__" in
creative ways.

(*) Ok, a _lot_ crazy. But dammit, I want type-safety _and_
convenience, and I'm willing to do a few crazy macros to get
it.

Files: lib.c (+2/-2), lib.h (+18/-5), linearize.h (+5/-5)
--------------------------------------------------------------------------------

[5db15b3d5f34] 2005-04-07 21:04:58 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add some type-safety features to the list pointer operations.

The list pointer traversal macros are very easy to use, but
you can also mis-use them by passing in the wrong pointer type
without the macros having any chance to warn you about it.

Until now.

Files: lib.h (+15/-7), linearize.h (+1/-1)
--------------------------------------------------------------------------------

[846add100c0c] 2005-04-07 21:04:57 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When packing basic blocks, update the instructions bb pointers.

We'll still need them, and leaving them pointing to a bb that
we're killing is not such a great idea.

Files: flow.c (+8/-2)
--------------------------------------------------------------------------------

[05f35ab2b4c7] 2005-04-07 21:04:57 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up the tests for "pseudo has use list", since add/remove has to agree on it or bad things happen.

[Auto-summary] Modifies simplify.c. Updates header linearize.h. Changes: +7/-2 in 2 file(s)

Files: linearize.h (+6/-1), simplify.c (+1/-1)
--------------------------------------------------------------------------------

[01ae1c244967] 2005-04-07 21:04:57 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make the CSE "repeat" logic be more fine-grained than just repeating CSE itself.

In particular, some symbol address simplifications imply that
we should repeat symbol simplification, since things may have
improved.

Files: cse.c (+8/-6), flow.c (+5/-0), flow.h (+3/-0), lib.h (+1/-0), linearize.c (+1/-4), ... and 1 more
--------------------------------------------------------------------------------

[bb708408f097] 2005-04-07 21:04:56 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up OP_STORE kill, and remove the use of the data.

Address gen still not killed, that's a bit more involved.

Files: flow.c (+18/-10), linearize.c (+12/-0)
--------------------------------------------------------------------------------

[c9498575a6c7] 2005-04-07 21:04:56 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Handle killing of usage chains.

When done carefully, this allows us to rewrite pseudo usage,
as long as we make sure to fix up all the usage chains.

In particular, we can now simplify memops and turn an access
of a symbol through a pointer into a direct symbol access.

Files: flow.h (+1/-0), simplify.c (+46/-18)
--------------------------------------------------------------------------------

[8edd7cd402bc] 2005-04-07 21:04:56 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: More undefined symbol handling - don't oops on printout.

[Auto-summary] Modifies linearize.c. Changes: +4/-0 in 1 file(s)

Files: linearize.c (+4/-0)
--------------------------------------------------------------------------------

[a1d5f74a8472] 2005-04-07 21:04:55 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Change linearizer debug output syntax for call instructions.

It now ends up being

	CALL fn, arg, argc, arg
	pseudo <- %retval

for a function that returns a return value.

This is slightly closer to what real assembly would be like,
but more importantly, it removes the only valid use of VOID
pseudos from the printout, so now you can see when something
goes wrong y just grepping for VOID.

This happens in the kernel a lot. Apparently mainly because
of lack of support for inline assembly.

Files: linearize.c (+3/-1)
--------------------------------------------------------------------------------

[dfe38357da1a] 2005-04-07 21:04:55 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Happy Thanksgiving, everybody!

This is a celebration of a nice round ChangeSet number. This
is v1.1000. Woot woot woot!

Files: Makefile (+3/-0)
--------------------------------------------------------------------------------

[bff469fb3839] 2005-04-07 21:04:55 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Handle undefined symbols a bit more gracefully.

[Auto-summary] Modifies linearize.c. Changes: +5/-1 in 1 file(s)

Files: linearize.c (+5/-1)
--------------------------------------------------------------------------------

[3578ab8fd2d9] 2005-04-07 21:04:54 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do early CSE before even doing the symbol simplification.

This allows us to notice when a symbol address usage is
trivially dead, and optimize such a symbol better since
we don't have to worry about the address being used to
access it.

Files: evaluate.c (+0/-1), flow.c (+20/-5), linearize.c (+15/-6), linearize.h (+2/-2)
--------------------------------------------------------------------------------

[46577fc50347] 2005-04-07 21:04:54 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: More instruction kill care, making sure the use chains are emptied, allowing us to kill yet more instructions.

This should get rid of a number of remaining orphan phi-source
instructions.

Files: flow.c (+15/-0), simplify.c (+5/-2)
--------------------------------------------------------------------------------

[9eb3f1e8a155] 2005-04-07 21:04:54 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be more thorough about killing unreachable instructions.

We want to make sure that we kill them properly, so that
any pseudos they depended on or generated are also killed.

Files: flow.c (+6/-0), flow.h (+1/-0), simplify.c (+6/-6)
--------------------------------------------------------------------------------

[ca91540095fd] 2005-04-07 21:04:53 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use cleaned-up ptr list removal for removing basic blocks from child and parent lists.

[Auto-summary] Modifies 2 source files: flow.c, linearize.c. Updates header linearize.h. Changes: +15/-9 in 3 file(s)

Files: flow.c (+9/-0), linearize.c (+1/-9), linearize.h (+5/-0)
--------------------------------------------------------------------------------

[bb9faf844fca] 2005-04-07 21:04:53 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: helper function cleanup: separate delete/replace list entries.

[Auto-summary] Modifies lib.c. Updates header lib.h. Changes: +21/-12 in 2 file(s)

Files: lib.c (+19/-6), lib.h (+2/-6)
--------------------------------------------------------------------------------

[c77fe51e2ae1] 2005-04-07 21:04:53 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Once again, remember that basic blocks may not have any instructions.

[Auto-summary] Modifies flow.c. Changes: +1/-1 in 1 file(s)

Files: flow.c (+1/-1)
--------------------------------------------------------------------------------

[8fb259b19b1d] 2005-04-07 21:04:52 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be a lot more proper about rewriting end branches.

Instead of faking it by doing bad things to the child list,
do it properly. The fake stuff really confused the if-conversion.

Files: linearize.c (+26/-11)
--------------------------------------------------------------------------------

[0b322afa1066] 2005-04-07 21:04:52 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Notice killed phi-sources, and don't bother with them.

This allows us to simplify phi-nodes where all but one of the
sources has been killed.

Files: simplify.c (+4/-1)
--------------------------------------------------------------------------------

[998117a02c73] 2005-04-07 21:04:52 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When killing a basic block, mark all its instructions unreachable.

Also export "kill_bb()", since others want to use it too.

Files: flow.c (+7/-1), flow.h (+2/-0)
--------------------------------------------------------------------------------

[460d63305637] 2005-04-07 21:04:51 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix silly unintentional constant truncation.

0x100000000 isn't really 0, even if it looks that way
if you truncate it to 32-bit before testing ;)

Files: simplify.c (+1/-1)
--------------------------------------------------------------------------------

[29946c577c13] 2005-04-07 21:04:51 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do first-approximation constant binop simplification.

It does the sizes and signs wrong, but so does CSE right now,
so this is more a "here's basically what we should do" thing.

Files: simplify.c (+100/-1)
--------------------------------------------------------------------------------

[56bbb5682265] 2005-04-07 21:04:51 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify constant "conditional" branches and OP_SETCC/OP_SEL instructions.

Also, remove OP_SEL from the "binop" list - it really really isn't,
since it has a third implied input in the OP_SETCC.

Files: linearize.c (+9/-3), linearize.h (+1/-1), simplify.c (+30/-1)
--------------------------------------------------------------------------------

[16fff07164c4] 2005-04-07 21:04:50 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Handle degenerate case of an instruction rewriting itself to be the source of itself.

It happens for silly cases like "int i = i;", and we do not
want to get into an endless loop rewriting the thing over
and over again ;)

Files: flow.c (+2/-0)
--------------------------------------------------------------------------------

[f8c7c2e56a0b] 2005-04-07 21:04:50 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up rewriting a switch into a branch.

And make sure to set the bb on the branch we create.

Files: flow.c (+4/-4), linearize.c (+5/-3), linearize.h (+1/-1)
--------------------------------------------------------------------------------

[13179fc326ca] 2005-04-07 21:04:50 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make phi pseudos be a type of their own.

This makes it easier to verify that they are used only in phi-nodes,
not anywhere else.

Files: linearize.c (+38/-7), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[c09a8c9ea8f3] 2005-04-07 21:04:49 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Start replacing trivial constant ops.

[Auto-summary] Modifies simplify.c. Changes: +25/-3 in 1 file(s)

Files: simplify.c (+25/-3)
--------------------------------------------------------------------------------

[78487a70ab98] 2005-04-07 21:04:49 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Set up infrastructure for doing some constant simplification.

[Auto-summary] Modifies simplify.c. Changes: +52/-6 in 1 file(s)

Files: simplify.c (+52/-6)
--------------------------------------------------------------------------------

[384b8be31a6a] 2005-04-07 21:04:49 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Move instruction simplification to new file "simplify.c".

Also, allow marking a pseudo unused by setting it to VOID,
which just disables further renaming of that use. This is
needed to make phi-source instructions (that can be shared
among multiple phi-nodes thanks to CSE) be collectable.

We used to just mark the phi source dead, but that was
wrong, since _another_ phi node might be using it.

Files: Makefile (+2/-1), cse.c (+18/-193), flow.c (+4/-2), flow.h (+1/-0), simplify.c (+217/-0)
--------------------------------------------------------------------------------

[0cde10b1951b] 2005-04-07 21:04:48 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Another assert - verify bb validity.

[Auto-summary] Modifies cse.c. Changes: +2/-2 in 1 file(s)

Files: cse.c (+2/-2)
--------------------------------------------------------------------------------

[ea33f8c6c66b] 2005-04-07 21:04:48 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Validity-check the pseudo 'use' list.

This is largely how I found all the pseudo rewriting bugs, so
let's just make it the norm. I'm not a huge fan of asserts, but
as long as it's _really_ a "this is a fundamental problem" thing,
rather than a "I'm not handling this case correctly", they're ok.

Files: flow.c (+2/-0)
--------------------------------------------------------------------------------

[39bd51ab2448] 2005-04-07 21:04:48 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up various pseudo usage list issues:  - value pseudos  - clear the list on usage transfer  - don't re-use OP_SWITCH as OP_BR when simplifying.

[Auto-summary] Modifies 2 source files: flow.c, linearize.c. Updates header linearize.h. Changes: +44/-27 in 3 file(s)

Files: flow.c (+13/-24), linearize.c (+28/-1), linearize.h (+3/-2)
--------------------------------------------------------------------------------

[8f3793c417ec] 2005-04-07 21:04:47 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't change instruction pseudo's when nopping them out.

It may be a nice readability thing, but with the usage lists
we really mustn't change a location that may be on a list.

Files: cse.c (+0/-1)
--------------------------------------------------------------------------------

[b09bc678d3a5] 2005-04-07 21:04:47 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Damn. We can't actually sort the phi-node list of phi's now that we keep track of usage notes.

The usage trackign tracks the address of the phi pseudo, so
sorting the list would need to update that too.

This sucks, because it means we can't turn the phi-nodes into
canonical format, and thus not CSE phi-nodes as effectively.

Files: cse.c (+4/-21)
--------------------------------------------------------------------------------

[e192a99cfc4f] 2005-04-07 21:04:47 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add "optimize" flag, and collect the flags into lib.c.

Nothing uses it yet, but it's a good way to test bad
ideas (call it an "optimization", and run diff on the
result with and without).

Files: lib.c (+12/-1), lib.h (+2/-0), pre-process.c (+0/-3), token.h (+0/-1)
--------------------------------------------------------------------------------

[b200a9a69e70] 2005-04-07 21:04:46 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. Forgot to add usage of a dominator list pseudo.

This made the phi-source CSE generate garbage, since the information
wasn't updated in the phi list of the user.

Move use_pseudo() to header file, since flow wants to use it too now.

Files: flow.c (+1/-1), linearize.c (+0/-12), linearize.h (+12/-0)
--------------------------------------------------------------------------------

[6e82297e7242] 2005-04-07 21:04:46 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Now that phi sources are just instructions, we can CSE them.

They's _slightly_ special in that they depend on their bb,
so we can only combine them within one basic block, but that's
easily handled by making the bb be part of the hashing and
comparison.

Files: cse.c (+12/-0)
--------------------------------------------------------------------------------

[06942ef25a3f] 2005-04-07 21:04:46 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't print no-ops and unused instructions unless verbose.

[Auto-summary] Modifies linearize.c. Changes: +12/-6 in 1 file(s)

Files: linearize.c (+12/-6)
--------------------------------------------------------------------------------

[6330e6081fab] 2005-04-07 21:04:45 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't bother showing symbols that have been successfully removed by the linearizer.

[Auto-summary] Modifies linearize.c. Changes: +4/-0 in 1 file(s)

Files: linearize.c (+4/-0)
--------------------------------------------------------------------------------

[3c3084e898b3] 2005-04-07 21:04:45 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When checking for a single parent, allow duplicates.

They happen with branch rewriting, and checking for them
is cheap.

Files: flow.c (+13/-5)
--------------------------------------------------------------------------------

[00495899ea79] 2005-04-07 21:04:45 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't show killed basic blocks.

They just clutter up the output, and makes it harder to see bugs.

Files: linearize.c (+2/-0)
--------------------------------------------------------------------------------

[a72e8491ba82] 2005-04-07 21:04:44 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't silently delete unnecessary phi_nodes that were generated by "return".

Without it, CSE won't see that the phi sources are dead.

(Alternatively we should kill the phi sources early)

Files: linearize.c (+0/-1)
--------------------------------------------------------------------------------

[e8c4c42deb77] 2005-04-07 21:04:44 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clear phi list when killing a phi-node instruction

[Auto-summary] Modifies cse.c. Changes: +3/-1 in 1 file(s)

Files: cse.c (+3/-1)
--------------------------------------------------------------------------------

[c484f3f7f5c6] 2005-04-07 21:04:44 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. Clean up some left-overs from phi removal.

The "half-way" point was making the phi be an instruction,
and some of that half-way stuff remained.

Files: cse.c (+10/-8), flow.c (+4/-3), linearize.c (+8/-8)
--------------------------------------------------------------------------------

[6e4960a358f3] 2005-04-07 21:04:43 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove "struct phi", replace with instruction that generates a pseudo.

The instruction contains everything "struct phi" had, namely
source bb and pseudo. And generating a new pseudo means that
we not only have the pointer to the instruction that defines
the phi-node (in pseudo->def), we also end up with automatic
phi-node usage tracking (pseudo->users).

The changes may look large, but almost all of this is just
direct search-and-replace of the old phi-node usage.

Files: cse.c (+27/-24), flow.c (+27/-37), lib.c (+0/-2), lib.h (+3/-4), linearize.c (+43/-44), ... and 1 more
--------------------------------------------------------------------------------

[0c24763b8e78] 2005-04-07 21:04:43 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clear a phinode list that is all empty, so that we don't need to check it later.

[Auto-summary] Modifies flow.c. Changes: +1/-0 in 1 file(s)

Files: flow.c (+1/-0)
--------------------------------------------------------------------------------

[e4fb90fb0c66] 2005-04-07 21:04:43 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Teach basic block packing about deleted phi-nodes and no-ops.

If a basic block is a source of phi-nodes, but they have all
been cleared, we can just ignore them. Similarly, if a basic
block is only a series of no-ops followed by a branch, we can
still do the branch rewrite.

Files: flow.c (+24/-7)
--------------------------------------------------------------------------------

[ffd3283cdce6] 2005-04-07 21:04:42 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do if-conversion.

We can turn trivial phi-nodes into OP_SEL instructions instead,
and generally improve code flow.

This doesn't remove the empty blocks this results in yet, so
it's not quite as dramatic as it could be, but it does the hard
work. Empty block removal is trivial.

Files: cse.c (+101/-0), linearize.c (+23/-1), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[a3c3332eef37] 2005-04-07 21:04:42 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Re-do CSE if we did a phi-node simplification.

[Auto-summary] Modifies cse.c. Changes: +11/-12 in 1 file(s)

Files: cse.c (+11/-12)
--------------------------------------------------------------------------------

[91766f956daf] 2005-04-07 21:04:42 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: We need to pack the phi-list even if we simplify the phi instruction.

[Auto-summary] Modifies cse.c. Changes: +3/-2 in 1 file(s)

Files: cse.c (+3/-2)
--------------------------------------------------------------------------------

[76b1ba754f31] 2005-04-07 21:04:41 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make phi-node normalization (part of CSE) do trivial simplification.

[Auto-summary] Modifies cse.c. Changes: +17/-2 in 1 file(s)

Files: cse.c (+17/-2)
--------------------------------------------------------------------------------

[a90d8406a080] 2005-04-07 21:04:41 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do "flow" simplification earlier (separate from packing).

This does branches-to-branches and trivial dead basicblock
removal before CSE (so that CSE can do a better job).

Files: flow.c (+8/-5), flow.h (+1/-1), linearize.c (+3/-7)
--------------------------------------------------------------------------------

[a30aff3d7cfc] 2005-04-07 21:04:41 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "test-lexing" use sparse() infrastructure.

All donw now, methinks.

Files: test-lexing.c (+2/-31)
--------------------------------------------------------------------------------

[95e9f97b9d68] 2005-04-07 21:04:40 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "compile" use the sparse() helper function too.

It did some extra work to get the filename for the output,
so it needed some more care.

Files: compile.c (+6/-55)
--------------------------------------------------------------------------------

[9c70e36c9083] 2005-04-07 21:04:40 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up test-parsing too.

[Auto-summary] Modifies test-parsing.c. Changes: +1/-41 in 1 file(s)

Files: test-parsing.c (+1/-41)
--------------------------------------------------------------------------------

[8b66cf7adc0b] 2005-04-07 21:04:40 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Update test-linearize.c to the new world order.

[Auto-summary] Modifies test-linearize.c. Changes: +1/-51 in 1 file(s)

Files: test-linearize.c (+1/-51)
--------------------------------------------------------------------------------

[1342c13017e5] 2005-04-07 21:04:39 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make the new "sparse()" interface even more painfully obvious.

Make "obfuscate" use it too, and remove the old stale code.

Files: check.c (+2/-4), obfuscate.c (+10/-91)
--------------------------------------------------------------------------------

[f2255803cb7d] 2005-04-07 21:04:39 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Move all of the setup code to one single "sparse()" helper function.

Let's just face the fact that nobody actually wants to care about
command line switches, builtins etc. Put it all in lib.c and make
it easy to use.

Files: check.c (+1/-85), lib.c (+89/-0), lib.h (+1/-0)
--------------------------------------------------------------------------------

[4bc5efbeaf8d] 2005-04-07 21:04:39 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make bb->pos a bit more accurate.

This makes it a lot easier to match up the flow with the
source.

Files: linearize.c (+6/-0)
--------------------------------------------------------------------------------

[294c7f866d03] 2005-04-07 21:04:38 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. Don't try to CSE the dead instructions.

[Auto-summary] Modifies cse.c. Changes: +2/-0 in 1 file(s)

Files: cse.c (+2/-0)
--------------------------------------------------------------------------------

[ec0abd07637b] 2005-04-07 21:04:38 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Kill trivially dead instructions

That is - simple instructions with no users.

Files: cse.c (+55/-0), linearize.c (+2/-0)
--------------------------------------------------------------------------------

[3c6c27fe1515] 2005-04-07 21:04:38 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make the "cse nop" a bit more informative

Show the source that the thing was replaced with.

Files: cse.c (+1/-0), linearize.c (+1/-1)
--------------------------------------------------------------------------------

[29cc9c0d4c96] 2005-04-07 21:04:37 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make CSE convert instructions to OP_NOP

Instead of using the "convert_load_insn()" that converts them to
OP_LNOP's, which ends up confusing instruction printout horribly.

Files: cse.c (+2/-2), flow.c (+5/-1), flow.h (+1/-1), linearize.c (+3/-0), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[c715712d2cab] 2005-04-07 21:04:37 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix cse.c dependencies.

[Auto-summary] Modifies build system. Changes: +1/-0 in 1 file(s)

Files: Makefile (+1/-0)
--------------------------------------------------------------------------------

[3cbf846f9e4e] 2005-04-07 21:04:37 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add simple-stupid dominance testing for CSE.

This makes us able to CSE stuff where one subexpression
directly dominates another.

But we still don't do any fancy code motion in the non-
dominance case.

Files: cse.c (+32/-2), flow.c (+1/-1), flow.h (+2/-0)
--------------------------------------------------------------------------------

[7f7110e11351] 2005-04-07 21:04:36 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow the C99/C++ mixed variable declaration syntax.

Currently we warn unconditionally about it.

Files: parse.c (+10/-7), parse.h (+0/-1)
--------------------------------------------------------------------------------

[4d132bc09f66] 2005-04-07 21:04:36 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Pack the phi-list after removing duplicates.

[Auto-summary] Modifies cse.c. Changes: +3/-0 in 1 file(s)

Files: cse.c (+3/-0)
--------------------------------------------------------------------------------

[1cad98cde3dc] 2005-04-07 21:04:36 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add pack_ptr_list() helper function.

It removes empty list blocks from the list. If you remove
list entries, you should pack the list afterwards to make
sure that there aren't any empty blocks that may upset the
list walker functions.

Files: lib.c (+37/-0), lib.h (+4/-0)
--------------------------------------------------------------------------------

[fe8df476cce2] 2005-04-07 21:04:35 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add initial CSE pass

It ain't very smart yet, but give it time.

In particular, right now it gathers information for the
whole function, but it only does the actual replacement
if the instructions are in the same basic block.

Files: Makefile (+1/-1), cse.c (+291/-0), flow.c (+2/-11), flow.h (+3/-0), linearize.c (+7/-1)
--------------------------------------------------------------------------------

[34038a899aa2] 2005-04-07 21:04:35 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Merge http://sparse-mw.bkbits.net:8080/janitorial into ppc970.osdl.org:/home/torvalds/BK/sparse

[Auto-summary] Modifies 14 source files: check.c, evaluate.c, expand.c and 11 more. Updates 3 headers. Modifies build system. Changes: +835/-748 in 18 file(s)

Files: Makefile (+3/-2), check.c (+1/-1), evaluate.c (+1/-1), expand.c (+3/-1), expression.c (+1/-1), ... and 13 more
--------------------------------------------------------------------------------

[1bfc2554c948] 2005-04-07 21:04:35 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When expanding a constant short conditional, make sure to handle the case where the result is the conditional.

[Auto-summary] Modifies expand.c. Changes: +2/-0 in 1 file(s)

Files: expand.c (+2/-0)
--------------------------------------------------------------------------------

[3234fa5b22dd] 2005-04-07 21:04:34 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Update copyright notices a bit.

[Auto-summary] Modifies 12 source files: check.c, evaluate.c, expand.c and 9 more. Changes: +12/-12 in 12 file(s)

Files: check.c (+1/-1), evaluate.c (+1/-1), expand.c (+1/-1), expression.c (+1/-1), inline.c (+1/-1), ... and 7 more
--------------------------------------------------------------------------------

[09bb548060e8] 2005-04-07 21:04:34 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: If all our dominators are the same pseudo, just use it.

Even if the phi-nodes come from different basic blocks.
It just doesn't matter at that point.

Files: flow.c (+17/-14)
--------------------------------------------------------------------------------

[0de2ae2ec481] 2005-04-07 21:04:34 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Revert the last load dominator change.

I realized that the case where I really wanted to do this optimization
is actually the case where this case can never trigger: when there is
only one assignment to a symbol, we've gone the easy way and replaced
all the loads without actually doing any dominator work at all.

That implies that if we want to find dominating tests, we'd better do
so separately rather than during the load dominance phase.

Cset exclude: torvalds@ppc970.osdl.org|ChangeSet|20041116234705|05860

Files: flow.c (+4/-21)
--------------------------------------------------------------------------------

[a25eb46654bc] 2005-04-07 21:04:33 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: If we find an exclusive dominating load, see if we can follow it further.

In particular, we could check if the loaded value then gets used in a test,
so that the test ends up dominating the instruction..

This just adds the hooks. We don't actually try to find any test instructions.

Files: flow.c (+21/-4)
--------------------------------------------------------------------------------

[c040f2e0eedc] 2005-04-07 21:04:33 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove incorrect left-over from (not useful) old load-load dominance trials.

[Auto-summary] Modifies flow.c. Changes: +0/-2 in 1 file(s)

Files: flow.c (+0/-2)
--------------------------------------------------------------------------------

[1a5c1064ecea] 2005-04-07 21:04:33 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Move flow analysis out of "linearize.c" and into new "flow.c"

Small files are good. Now "linearize" really just contains the
code that does a straightforward linearization of the tree, and
flow.c contains the stuff that tries to analyse the result.

Files: Makefile (+3/-2), flow.c (+783/-0), flow.h (+8/-0), lib.h (+4/-0), linearize.c (+4/-772), ... and 1 more
--------------------------------------------------------------------------------

[54d8de05ad9b] 2005-04-07 21:04:32 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "value_pseudo()" always return the same pseudo for the same value.

This allows us to compare values by comparing the pseudo.
Which will make CSE easier - no need to ever go into the
pseudo to see if they are similar.

Files: linearize.c (+14/-1)
--------------------------------------------------------------------------------

[0dee66eda0e1] 2005-04-07 21:04:32 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: try_to_simplify_phi() needs to skip killed phi entries.

[Auto-summary] Modifies linearize.c. Changes: +2/-0 in 1 file(s)

Files: linearize.c (+2/-0)
--------------------------------------------------------------------------------

[ef2348207853] 2005-04-07 21:04:32 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: If we have a phi-list of identical entries, collapse it to just one entry.

[Auto-summary] Modifies linearize.c. Changes: +38/-21 in 1 file(s)

Files: linearize.c (+38/-21)
--------------------------------------------------------------------------------

[97b9e5844ae2] 2005-04-07 21:04:31 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Factor out the OP_LOAD -> OP_PHI rewrite into a separate function.

Small functions are good.

Files: linearize.c (+31/-23)
--------------------------------------------------------------------------------

[cf07903a1f67] 2005-04-07 21:04:31 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't bother finding dominating loads if we have to search multiple paths.

They only help us if there is one absolute dominant load.

Files: linearize.c (+9/-3)
--------------------------------------------------------------------------------

[0d0e765e5d8c] 2005-04-07 21:04:31 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Ignore uninteresting load-load dominance when converting loads.

We're only interested in _total_ load dominance.

Files: linearize.c (+7/-1)
--------------------------------------------------------------------------------

[f6e1744364df] 2005-04-07 21:04:30 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: check.c:   Teach check that "-" is stdin. cgcc:   Teach cgcc that "-" is a file.

[Auto-summary] Modifies check.c. Changes: +11/-4 in 2 file(s)

Files: cgcc (+3/-0), check.c (+8/-4)
--------------------------------------------------------------------------------

[bb5e4621a9f6] 2005-04-07 21:04:30 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do load conversion in reverse order of linearized output, since this is slightly more likely to catch loads dominating loads, and thus potentially avoiding some phi nodes.

This still leaves the problem of partial load domination,
which generates silly phi nodes that aren't necessary. That
is a separate (independent) issue that just shows up more
when we find more load dominators.

Files: linearize.c (+2/-2)
--------------------------------------------------------------------------------

[184dbe28ce53] 2005-04-07 21:04:30 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix partial dominance case in same basic block as load.

[Auto-summary] Modifies linearize.c. Changes: +7/-0 in 1 file(s)

Files: linearize.c (+7/-0)
--------------------------------------------------------------------------------

[b6ec79f761fa] 2005-04-07 21:04:29 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify switches on compile-time constant values.

It happens. Deal with it gracefully, and turn it into
the proper jump.

Files: linearize.c (+51/-0), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[167d346e65b6] 2005-04-07 21:04:29 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make helper function to kill basic blocks.

We use this whenever we've either noticed that a basic
block isn't reachable, or we've merged it into a parent
(either by rewriting a single branch, of by concatenating
it into the parent).

Files: linearize.c (+12/-7)
--------------------------------------------------------------------------------

[433084e90e8e] 2005-04-07 21:04:29 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify multi-jump branches to branches.

[Auto-summary] Modifies linearize.c. Changes: +13/-2 in 1 file(s)

Files: linearize.c (+13/-2)
--------------------------------------------------------------------------------

[39335215aa93] 2005-04-07 21:04:28 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add helper function to insert a label at the current position.

We can optimize it a bit if we already had a label there, and
share it. Of course, we've often already forced a new block
by virtue of having used the label target earlier, but hey, this
is a simple early bb simplification.

Files: linearize.c (+26/-7)
--------------------------------------------------------------------------------

[b486c4df99ad] 2005-04-07 21:04:28 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Now that we unconditionally add a "default" case to the switch instruction, the active block is dead afterwards. Finish it off.

[Auto-summary] Modifies linearize.c. Changes: +1/-0 in 1 file(s)

Files: linearize.c (+1/-0)
--------------------------------------------------------------------------------

[ae26d442993e] 2005-04-07 21:04:28 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Mark unreachable bb's so that you can tell at a glance in the linearizer output.

Remove all their instruction, parent and children lists.

Files: linearize.c (+5/-0)
--------------------------------------------------------------------------------

[2e288c588461] 2005-04-07 21:04:27 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add the default fallthrough case in switch statement linearization.

Morten pointed out that it was missing ;)

Files: linearize.c (+13/-3)
--------------------------------------------------------------------------------

[37330b38da35] 2005-04-07 21:04:27 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Duh. Local symbols that have their address taken need to check for function calls when doing dead store removal.

[Auto-summary] Modifies linearize.c. Changes: +6/-1 in 1 file(s)

Files: linearize.c (+6/-1)
--------------------------------------------------------------------------------

[806e2938282e] 2005-04-07 21:04:27 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do some more block merging (follow branches).

[Auto-summary] Modifies linearize.c. Changes: +71/-9 in 1 file(s)

Files: linearize.c (+71/-9)
--------------------------------------------------------------------------------

[598c9d5ae1f1] 2005-04-07 21:04:26 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do some initial basic block packing and remove BB_REACHABLE flag.

Trivial basic block merging. I should do switch and branch
following too. Maybe next.

Files: linearize.c (+98/-5), linearize.h (+1/-9)
--------------------------------------------------------------------------------

[1e6052b8750e] 2005-04-07 21:04:26 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove OP_MOV and copy_pseudo.

They only made sense with the original (broken) pseudo
liveness analysis.

Files: linearize.c (+3/-27), linearize.h (+0/-1)
--------------------------------------------------------------------------------

[5ac72c955286] 2005-04-07 21:04:26 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do simple killing of dead stores.

It's really not very smart, but it does trivial killing of
stores to dead symbols.

Files: linearize.c (+108/-7)
--------------------------------------------------------------------------------

[3e7aa82fde61] 2005-04-07 21:04:25 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Show phi source information, so that it's more obvious which basic blocks generate pseudos that end up being used for phi nodes.

It impacts mergeability.

Files: linearize.c (+7/-0)
--------------------------------------------------------------------------------

[c820face9ab2] 2005-04-07 21:04:25 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up pseudo and bb usage handling.

We really don't care about all bb usage, only about the phi-nodes
that use bb's. All the other usage is pretty obvious from the
flow graph, no need to add them to the list (and if we _only_ add
phi-nodes, then it becomes easier to check whether a bb needs to
be saved due to phi-node issues).

The pseudo usage has nothing to do with an instruction, so don't
mix in the instruction into it.

Files: linearize.c (+40/-55), linearize.h (+1/-2)
--------------------------------------------------------------------------------

[bd22de5c2ea9] 2005-04-07 21:04:25 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: More dominator fixes.

This makes the searching more efficient, and checks full
dominance properly from the end rather than the beginning.

Files: linearize.c (+19/-18)
--------------------------------------------------------------------------------

[e8766cdd2287] 2005-04-07 21:04:24 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix __typeof__ size evaluation.

[Auto-summary] Modifies symbol.c. Changes: +1/-0 in 1 file(s)

Files: symbol.c (+1/-0)
--------------------------------------------------------------------------------

[9200bb82431e] 2005-04-07 21:04:24 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove debugging output that I'd mistakenly left in.

[Auto-summary] Modifies linearize.c. Changes: +0/-2 in 1 file(s)

Files: linearize.c (+0/-2)
--------------------------------------------------------------------------------

[5714d484a866] 2005-04-07 21:04:24 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do symbol dominance checks for all used symbols.

Non-local symbols need more care. Function calls and pointer
accesses can obviously clash with them, so we're less likely
to find good domination. But every little piece helps.

Files: linearize.c (+77/-38), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[100e19374a3a] 2005-04-07 21:04:23 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make sure we register bb usage when rewriting a branch.

[Auto-summary] Modifies linearize.c. Changes: +1/-1 in 1 file(s)

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[fe2fe8d3e8b6] 2005-04-07 21:04:23 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove the phi node rewriting.

We'll get back here at some point, but this one
probably only makes sense for something that actually
emits real instructions.

Files: linearize.c (+0/-48)
--------------------------------------------------------------------------------

[bc0f4688c6d5] 2005-04-07 21:04:23 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add basic block usage list to bb.

We'll need this to efficiently rewrite bb's.

Files: linearize.c (+35/-17), linearize.h (+2/-0)
--------------------------------------------------------------------------------

[a407395b0649] 2005-04-07 21:04:22 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove the horrid iterators.

Instead of having magic iterators over the last instruction
of a basic block, we just add a list of "children" to each
basic block.

This removes all the packing logic, because it needs to be
totally rewritten to work with the new iterators.

Files: check.c (+2/-4), lib.c (+0/-166), lib.h (+0/-58), linearize.c (+27/-100), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[21b2bb3c77f6] 2005-04-07 21:04:22 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Undo braindamage.

Duh. They really were different types. One was a list of pointers to pseudos,
the other is just a list of pseudos.

Cset exclude: torvalds@ppc970.osdl.org|ChangeSet|20041112172911|52083

Files: linearize.c (+1/-1), linearize.h (+2/-1)
--------------------------------------------------------------------------------

[41aa7864e15d] 2005-04-07 21:04:22 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Duplicate type removal..

Use "pseudo_list" rather than "pseudo_ptr_list" type.

Files: linearize.c (+1/-1), linearize.h (+1/-2)
--------------------------------------------------------------------------------

[b22bcff68746] 2005-04-07 21:04:21 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When we find a load without a dominator, turn it into a zero.

It is either a linearizer bug, undefined behaviour, or more
commonly, an initial store to a bitfield structure.

Files: linearize.c (+4/-2)
--------------------------------------------------------------------------------

[ede95390f505] 2005-04-07 21:04:21 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow loads to dominate loads.

If it means that we find a dominator more quickly, good for us.

Also, add note about the dubious instruction re-write thing when
we change the OP_LOAD into an OP_PHI.

Files: linearize.c (+18/-2)
--------------------------------------------------------------------------------

[901011cf3df3] 2005-04-07 21:04:21 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. Off-by-one error in finding dominating basic blocks.

A basic block can dominate itself, and we checked the generation
count too early, so we missed it.

Files: linearize.c (+3/-3)
--------------------------------------------------------------------------------

[56c7750a6a66] 2005-04-07 21:04:20 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Duh. Add usage information to the phi-nodes that we generate when turning a OP_LOAD into an OP_PHI.

Otherwise we'll not update the phi-node properly if the source
of the phi gets simplified further.

Files: linearize.c (+3/-1)
--------------------------------------------------------------------------------

[00dc0d1ff244] 2005-04-07 21:04:20 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Show large integers as hex.

This makes things like masks etc more readable.

Files: linearize.c (+7/-2)
--------------------------------------------------------------------------------

[2744e0248305] 2005-04-07 21:04:20 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up bitfield accesses, and disable the phi-node dups for now.

The phi-node expansion makes the result look a bit more like
real assembly language, but until we have register allocation
it also bloats things and that makes it harder to read. And
the code can't handle the more complex placement of phi-nodes
that we have these days.

Files: linearize.c (+4/-2)
--------------------------------------------------------------------------------

[c96863ac4cf6] 2005-04-07 21:04:19 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do a first pass at making symbols into pseudos.

This looks for dominating stores and the whole enchilada.

It's likely buggy as hell.

Files: linearize.c (+134/-39), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[ea291f91c990] 2005-04-07 21:04:19 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do some very rough (stupid) symbol access optimizations.

We just look when a store dominates a load, and replace
the load with the source of the dominating store.

It would even be useful, but we give up at basic block
borders. Retard, I tell you.

Files: linearize.c (+95/-16), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[41452c950e3d] 2005-04-07 21:04:19 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Duh. Fix sense of restricted assignment check.

We used to complain about binops that were not restricted,
and accept assignments that were not ok.

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[3451bba63ee2] 2005-04-07 21:04:18 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "translation_unit()" do symbol evaluation too.

Not only do all users want it, the list of used symbols
is not stable until after the tree has been evaluated.

Files: check.c (+4/-5), compile.c (+3/-3), evaluate.c (+14/-3), expression.h (+1/-2), obfuscate.c (+3/-4), ... and 6 more
--------------------------------------------------------------------------------

[ec2a1efb2af9] 2005-04-07 21:04:18 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When showing symbol pseudos, show the symbol pointer too, not just the name.

The uniqueness of a symbol is in its pointer, not its name. But the
name is often the most important part for readability, so we want to
show both.

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[53dd3aef83e9] 2005-04-07 21:04:18 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up handling of "return" target, aka the exitpoint of a compound statement.

[Auto-summary] Modifies linearize.c. Changes: +3/-6 in 1 file(s)

Files: linearize.c (+3/-6)
--------------------------------------------------------------------------------

[d5272695b464] 2005-04-07 21:04:17 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up restricted type assignment checking.

Noted by Anton Altaparmakov who is clearly better at testing
than I am. This got broken by the assignment evaluation re-org.

Files: evaluate.c (+16/-6)
--------------------------------------------------------------------------------

[e400f53db853] 2005-04-07 21:04:17 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Replace OP_LOAD/OP_STORE with OP_LNOP/OP_SNOP when making them irrelevant.

This shows an interesting (?) bug with uninlining, where we seem to
go through the same symbol twice, resulting in complaints about symbols
used in strange ways (because we see an instruction that we have already
NOP'ped out, using a symbol).

I'm not convinced this is a bug yet - it might just be that we really
_can_ reach the same symbol twice. But I _think_ it means our uninliner
may have problems.

Files: linearize.c (+8/-2), linearize.h (+2/-0)
--------------------------------------------------------------------------------

[ebfb06871dcc] 2005-04-07 21:04:17 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make the linearizer only try to do power-of-2 "native" stores.

This still allows partial stores, but only for even bytes and
powers-of-two.

Files: linearize.c (+2/-0)
--------------------------------------------------------------------------------

[0d7ff6af486a] 2005-04-07 21:04:16 -0700
Author: Linus Torvalds <torvalds@tove.osdl.org>
Subject: Duh. Fix micro-optimization.

[Auto-summary] Modifies tokenize.c. Changes: +2/-1 in 1 file(s)

Files: tokenize.c (+2/-1)
--------------------------------------------------------------------------------

[202e206837b9] 2005-04-07 21:04:16 -0700
Author: Linus Torvalds <torvalds@tove.osdl.org>
Subject: Since we only use the freelist for small aligned entries, optimize for them.

This cuts down another 10% on the test-case from
hell.

Files: lib.c (+6/-2)
--------------------------------------------------------------------------------

[cf28080aff88] 2005-04-07 21:04:16 -0700
Author: Linus Torvalds <torvalds@tove.osdl.org>
Subject: Optimize "create_hashed_ident()".

memcmp() tends to be optimized for all the wrong
cases, so do the obvious expansion which allows the
compiler to do the right thing.

Files: tokenize.c (+11/-1)
--------------------------------------------------------------------------------

[4d383e597688] 2005-04-07 21:04:15 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Avoid costly bitfield updates in tokenization.

We can keep the stream position in "expanded format", and
only pack it down to the tighter "struct position" format
when necessary. That makes a number of updates much simpler.

Files: tokenize.c (+48/-56)
--------------------------------------------------------------------------------

[855b4cd252fb] 2005-04-07 21:04:15 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Merge tove:BK/sparse into ppc970.osdl.org:/home/torvalds/BK/sparse

[Auto-summary] Modifies tokenize.c. Updates header lib.h. Changes: +12/-6 in 2 file(s)

Files: lib.h (+2/-2), tokenize.c (+10/-4)
--------------------------------------------------------------------------------

[97a48462f36b] 2005-04-07 21:04:15 -0700
Author: Linus Torvalds <torvalds@tove.osdl.org>
Subject: Uninline "nextchar()", and optimize.

This is the hottest function by far, and we're
better off looking up the (few) special cases
in an array than doing a switch-statement.

Files: tokenize.c (+10/-4)
--------------------------------------------------------------------------------

[82e54f31d502] 2005-04-07 21:04:14 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Free more token memory for re-use

It now re-uses the '#' token for all preprocessor lines,
and the 'define' token itself (even though it obviously
can't free the tokens from the definition).

This makes the 2004 IOCC entry a non-issue memory-wise.
Now I just need to speed up the parser. Sixteen seconds
on pre-processing is not acceptable..

Files: pre-process.c (+2/-0)
--------------------------------------------------------------------------------

[63c38b866407] 2005-04-07 21:04:14 -0700
Author: Linus Torvalds <torvalds@tove.osdl.org>
Subject: Move "pos.pos" to be the top bits of the word.

This means that we can do the (very common) pos.pos++
without having to load/add/mask/store.

Files: lib.h (+2/-2)
--------------------------------------------------------------------------------

[ca4f2d52e803] 2005-04-07 21:04:14 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make the pre-processor free the tokens that never make it into the token stream.

Most preprocessor lines are unused after handling, with the
notable exception of a #define. And regular tokens that get
skipped due to being in a region that is inside a false #if
case are also obvious fodder for this.

This shrinks the memory usage by a factor of five on some
particularly nasty code in the 2004 IOCCC.

Files: pre-process.c (+26/-15)
--------------------------------------------------------------------------------

[5f5fbdbbfe2d] 2005-04-07 21:04:13 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add support for freeing constant-sized allocations.

This is useful for tokens. They are nice and small and constant-sized,
and there are millions and millions of them, so re-using them when we
can actually matters.

Files: lib.c (+26/-0), lib.h (+1/-0)
--------------------------------------------------------------------------------

[0161959ea824] 2005-04-07 21:04:13 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Honor pre-processor conditionals even when they don't match within a stream.

We still warn about them, but we act as if it was ok.

The "vik2" IOCCC-2004 entry does some nasty preprocessor stuff on
purpose. We parse it all right, but because we refused to honor #if
statements that are terminated in another stream, we didn't get the
output Daniel Vik intended.

Files: pre-process.c (+6/-10)
--------------------------------------------------------------------------------

[867565094cbb] 2005-04-07 21:04:13 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Prettier debug printout - fix missing \n

[Auto-summary] Modifies linearize.c. Changes: +1/-1 in 1 file(s)

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[377b14ca2e44] 2005-04-07 21:04:12 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make it easier to see what replaced instructions.

We turn the source VOID instead of the target, which
helps us see what used to be there. And show the symbol
usage instructions in the debug output again.

Files: linearize.c (+23/-14)
--------------------------------------------------------------------------------

[f0ed5526844a] 2005-04-07 21:04:12 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Breep! Fix one millionth inlining bug

Duh. We did a "dup_expression()" instead of a "copy_exprssion"
for the sub-expressions of EXPR_INDEX and EXPR_IDENTIFIER. As
a result, we never actually replaced any symbols in there..

Files: inline.c (+2/-2)
--------------------------------------------------------------------------------

[5bea3d93cc1d] 2005-04-07 21:04:12 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove deathnotes

They don't really buy us anything, and while generating them
is easy, keeping them up-to-date is not.

Also, don't print out the killed OP_LOAD/OP_STORE instructions
that we voided by making the target be VOID.

Files: linearize.c (+9/-62), linearize.h (+0/-1)
--------------------------------------------------------------------------------

[7784133edfc8] 2005-04-07 21:04:11 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Sanity-check the instructions we walk over when replacing pseudos.

Just because it's a good idea.

Files: linearize.c (+7/-5)
--------------------------------------------------------------------------------

[3522585d3325] 2005-04-07 21:04:11 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make the pseudo usage list be a list of pointers to the pseudos, not the instructions that use them.

That makes replacing a pseudo trivial: just walk the
list, and overwrite the thing we have a pointer to.

We also take advantage of the fact that symbol pseudos
only exist in the "address" part of memory load, so
if we know the pointer to the pseudo, we can calculate
the pointer to the instruction.

This makes the symbol pseudo replacement a lot more
effective.

Files: linearize.c (+62/-71), linearize.h (+4/-3)
--------------------------------------------------------------------------------

[55a6868e2daa] 2005-04-07 21:04:11 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When adding a list entry, we sometimes want the address we added the entry to. Add support for that.

[Auto-summary] Modifies lib.c. Updates header lib.h. Changes: +6/-3 in 2 file(s)

Files: lib.c (+5/-2), lib.h (+1/-1)
--------------------------------------------------------------------------------

[7b09b87124b4] 2005-04-07 21:04:10 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do a very stupid single-store usage simplification.

We really don't do very well: we should _replace_ all the
pseudo's, but that would require us to find where in the
instruction it is used (or, alternatively, make the usage
note contain a pointer to the pseudo pointer).

Files: linearize.c (+76/-0)
--------------------------------------------------------------------------------

[29088097776b] 2005-04-07 21:04:10 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add "argument pseudo" for incoming arguments to a function.

This still leaves varargs wrong, but we'll get to that eventually.

Files: linearize.c (+31/-1), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[b6fc9847baa0] 2005-04-07 21:04:10 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make our "__builtin_va_arg()" thing a bit closer to real.

It's still _wrong_, but it's now something that could be right,
depending on how arguments are passed.

This makes the local symbol usage look sane (otherwise, any
varargs function ends up having totally nonsensical symbol
usage, since a vararg is just initialized with a constant
zero).

Files: lib.c (+1/-1)
--------------------------------------------------------------------------------

[c49c4e95cba7] 2005-04-07 21:04:09 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make initializers use the proper symbol pseudo.

Otherwise the initializer ends up being done through
a pointer, and we lose out on usage notes for local
symbols.

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[fcab2b13d958] 2005-04-07 21:04:09 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Show usage notes for symbols.

We add a per-symbol pseudo, and just track them that way.

Files: inline.c (+1/-0), lib.h (+3/-0), linearize.c (+21/-3), linearize.h (+0/-2), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[0540f921e972] 2005-04-07 21:04:09 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add a few missing pseudo usage-notes

[Auto-summary] Modifies linearize.c. Changes: +2/-0 in 1 file(s)

Files: linearize.c (+2/-0)
--------------------------------------------------------------------------------

[03bfc54e26e0] 2005-04-07 21:04:08 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Each pseudo has its "def" pointer, they now also have "use" pointers.

Well, at least part of the use pointers. I probably missed some uses.

Files: linearize.c (+24/-0), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[5d4363ca7e99] 2005-04-07 21:04:08 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use the new value pseudos instead of add_const_value()

[Auto-summary] Modifies linearize.c. Changes: +5/-12 in 1 file(s)

Files: linearize.c (+5/-12)
--------------------------------------------------------------------------------

[6a5db3c9e965] 2005-04-07 21:04:08 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove EXPR_BITFIELD entirely.

I used to think I needed it. That's no longer the case: we just
follow the "bit_offset" in the type information.

There may be cases where we inadvertently cast the information
away, and those places will break now, but that's a bug really,
not an excuse for EXPR_BITFIELD.

Files: compile-i386.c (+0/-10), evaluate.c (+4/-14), expand.c (+0/-3), expression.h (+0/-6), linearize.c (+2/-11), ... and 1 more
--------------------------------------------------------------------------------

[3590d4291b58] 2005-04-07 21:04:07 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Pack basic blocks only after phi node operations.

The basic block packing may remove blocks that are unreachable,
but that are the source of a phi-node. That confuses the phi
node simplification code, and the simple solution is to just
delay the packing.

That's doubly true, since branch following in phi node simplification
may actually result in unreachable basic blocks that should be
packed away.

Files: linearize.c (+3/-1)
--------------------------------------------------------------------------------

[dd34f5b9c4e3] 2005-04-07 21:04:07 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up phi node simplification for new pseudos.

Since constant pseudos don't have def's, we'd SIGSEGV
trying to figure out what the instruction that defined
them was.

The branch following still doesn't actually work, since
the lack of definition for the constant pseudos also means
that the phi-node source block logic doesn't work right
(the "empty" source block has been removed), but that's
a separate problem.

Files: linearize.c (+40/-23)
--------------------------------------------------------------------------------

[09229712fc14] 2005-04-07 21:04:07 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify "copy_pseudo()"

Non-regular pseudo's don't need to be explicitly copied, just
re-use it directly.

Files: linearize.c (+3/-0)
--------------------------------------------------------------------------------

[5d1634a893d9] 2005-04-07 21:04:06 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Introduce "value pseudos" and implicit deathnotes.

A "value pseudo" is a pseudo that just has a constant value
at any particular time. Instead of allocating a real pseudo
for it, and associating the pseudo with an expression, the
pseudo itself is directly associated with the value.

Also remove a few explicit death-notes: branches and calls
always kill their arguments, so make that implicit rather
than waste time addign explicit notes.

Files: linearize.c (+63/-43), linearize.h (+14/-4)
--------------------------------------------------------------------------------

[0ae65a358b22] 2005-04-07 21:04:06 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: misc pseudo cleanups

- better printout of void/NULL pseudos for debugging
 - symbol pseudos don't have deathnotes, nor do they
   have register numbers nor usage or def notes.
 - a void function does not return a pseudo.

Files: linearize.c (+16/-6)
--------------------------------------------------------------------------------

[bf5865ccb4c8] 2005-04-07 21:04:06 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use the symbol pseudo concept for call targets too.

Much prettier, and simpler.

Files: linearize.c (+14/-5)
--------------------------------------------------------------------------------

[6d34d0b4fb4f] 2005-04-07 21:04:05 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow "pseudo-pseudos", which are a temporary symbol reference.

This simplifies stuff that wants to allow either a calculated
expression pseudo, or a symbol. Use one of the pseudo-pseudos
for the symbol, and pass that one around.

First use: the address.

Files: linearize.c (+44/-20), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[93d4388292ec] 2005-04-07 21:04:05 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use direct symbol accesses for all symbols, not just locals.

Local symbols _are_ special, but not here. We'll turn them into
pseudos later.

Files: linearize.c (+2/-15)
--------------------------------------------------------------------------------

[fbcfc20d35d4] 2005-04-07 21:04:05 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add usage refcounting to pseudos to make deathnotes come out right.

The memory access initialization would keep a cache of "original value
of the memory access" which means that we only do one read of a field
even if it's an update of a bitfield. But that means that the usage of
the pseudo in question needs refcounting.

Files: linearize.c (+13/-7), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[1688f039c804] 2005-04-07 21:04:04 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Re-do memory access linearization.

This generates a "struct access_data" structure, which contains all
the offsetting/symbol information for the access, and which makes
things like bitfields and read-modify-writes all use the same basic
information.

Files: linearize.c (+211/-104), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[47f53396a1d6] 2005-04-07 21:04:04 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: If two implied casts end up undoing each other, just remove them.

This happens for implied cast simplification.

Currently only a binary not will be simplified, but it's conceptually
right for things like "char a,b,c; c = a+b;" too, where we should end
up simplifying away the thing across a binop too..). Some day..

Files: evaluate.c (+8/-0)
--------------------------------------------------------------------------------

[087362e1942b] 2005-04-07 21:04:04 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Separate explicit and implied casts.

This also makes our evaluation simplification only happen
for the implied ones. If you put an explicit cast somewhere,
it does _not_ get combined with an implied one.

Files: compile-i386.c (+1/-0), evaluate.c (+3/-2), expand.c (+1/-0), expression.h (+1/-0), inline.c (+1/-0), ... and 2 more
--------------------------------------------------------------------------------

[4b6c2e63d342] 2005-04-07 21:04:03 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify implied casts.

In particular, casting a binary not-expression is simplified to
the not-expression of the cast. This avoids the problem with
the implicit expansion of bitwise types to "int" when doing a
not-operation.

Also, a cast of a cast can be simplified to just a cast.

Files: evaluate.c (+36/-1)
--------------------------------------------------------------------------------

[5a627ec02342] 2005-04-07 21:04:03 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't do assignment replacement at type evaluation time.

We can evaluate the types of the read-modify-write assignments
easily enough as-is. And the linearizer is better at doing the
expansion of the assignment.

Files: evaluate.c (+43/-113), linearize.c (+20/-0)
--------------------------------------------------------------------------------

[38b7537ad3a8] 2005-04-07 21:04:03 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Only straight assignments are confusing in conditionals.

Don't warn for "if (a <<= 1)" or similar: it's not a potential
typo for "a == 1".

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[15925729194f] 2005-04-07 21:04:02 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't bother masking the value we store into a bitfield.

Since we started doing careful bitfield casts, we now mask
the value at the cast in front of the assignment, so doing
it inside the assignment is unnecessary.

Files: linearize.c (+3/-7)
--------------------------------------------------------------------------------

[59241b44f3c5] 2005-04-07 21:04:02 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't warn about assignments in iterator conditionals.

They're just too hard to avoid and keep the code clean.

Files: evaluate.c (+8/-8)
--------------------------------------------------------------------------------

[c90353b9b1be] 2005-04-07 21:04:02 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove expansion of "short" conditionals at evaluation time.

Yes, it's a special case, but it's a special case that is easily
handled in the linearizer, and we generate much nicer blocks if
we handle it there.

Files: evaluate.c (+25/-58), linearize.c (+65/-13)
--------------------------------------------------------------------------------

[7e4ccde59288] 2005-04-07 21:04:01 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't change conditionals upon evaluation.

Al used to do this simplification where we change FP conditionals
into a compare with 0.0. But we are still sharing expressions, and
we shouldn't do that.

Files: evaluate.c (+7/-34)
--------------------------------------------------------------------------------

[15fd73484635] 2005-04-07 21:04:01 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Using a preprocessor symbol makes it non-weak.

This causes us to warn if somebody tries to re-define a
symbol that has already been used, even if it was originally
non-weak.

Noted by Morten Welinder

Files: pre-process.c (+11/-3)
--------------------------------------------------------------------------------

[0970f9e7d36a] 2005-04-07 21:04:01 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make #ifdef/#ifndef/defined() all use the same helper function.

"token_defined(token)" does it all.

Files: pre-process.c (+11/-14)
--------------------------------------------------------------------------------

[d46dd6cbc11b] 2005-04-07 21:04:00 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Merge troll.com:/scratch/welinder/linus-sparse into troll.com:/scratch/welinder/cgcc

[Auto-summary] Modifies 18 source files: check.c, compile-i386.c, compile.c and 15 more. Updates 7 headers. Adds/updates 6 test(s). Changes: +1381/-704 in 31 file(s)

Files: check.c (+83/-6), compile-i386.c (+15/-25), compile.c (+9/-5), evaluate.c (+131/-125), expand.c (+94/-27), ... and 26 more
--------------------------------------------------------------------------------

[c34eaa18d4a0] 2005-04-07 21:04:00 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use linearize_ptr_list() to avoid internal knowledge about the list implementation in linearize.c

[Auto-summary] Modifies linearize.c. Changes: +10/-9 in 1 file(s)

Files: linearize.c (+10/-9)
--------------------------------------------------------------------------------

[482d91221ae7] 2005-04-07 21:04:00 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add "linearize_ptr_list()" to turn a pointer list into an array.

Useful for getting the first 'n' entries off a list.

Files: lib.c (+29/-0), lib.h (+1/-0)
--------------------------------------------------------------------------------

[65695dcbd64a] 2005-04-07 21:03:59 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use "weak_define" for __SIZE_TYPE__ and __STDC__

Header files and/or cgcc may define them to something else,
and we don't want to complain about it.

Files: lib.c (+2/-3)
--------------------------------------------------------------------------------

[47a029dcd378] 2005-04-07 21:03:59 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add "weak" defines

They work like weak symbols: they get used if nobody defines
anything else for them, and re-defining them doesn't cause a
warning.

Files: pre-process.c (+18/-1), symbol.h (+1/-1)
--------------------------------------------------------------------------------

[d9fcf85a0229] 2005-04-07 21:03:59 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When re-defining a symbol, let the new definition shine through.

Don't just complain. It may be wrogn to redefine, but if people
do it, use the most recent one.

Files: pre-process.c (+2/-0)
--------------------------------------------------------------------------------

[5cf22b3e5d33] 2005-04-07 21:03:58 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] linearize bitfield initializer

Here is the simple patch to linearize bit field initializer.
It don't try to optimized it.  Ideally the bit field
initializer can be combined. It don't have to use and/or mask.

I am a lazy baster.

[ Ed: Turkeys around the world, rejoice.  Lazy basters are the best
  kind.  Damn, that thing _hurts_. ]

Files: linearize.c (+12/-10)
--------------------------------------------------------------------------------

[3936598aac90] 2005-04-07 21:03:58 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: Fix up dropped bit check

We need to ignore the bits that weren't valid
in the old type.

Files: expand.c (+11/-6)
--------------------------------------------------------------------------------

[db5cb961ca47] 2005-04-07 21:03:58 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: enums, bitfields and nodes pick up their signedness from the base type.

This fixes some code that checks the sign of the node
instead of on the base type.

Files: evaluate.c (+0/-1), parse.c (+0/-3), symbol.c (+11/-1), symbol.h (+5/-2)
--------------------------------------------------------------------------------

[9ef8887a549f] 2005-04-07 21:03:57 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make the cast truncation warning a bit more readable.

Show the old value with as many bits as it had originally,
not with the full - possibly sign-extended - set of bits.

Files: expand.c (+3/-1)
--------------------------------------------------------------------------------

[f79fda6aeab4] 2005-04-07 21:03:57 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make casts warn if they drop bits from constant values.

Is this a valid warning? I suspect we may want to make it conditional.
But it does point out some half-way suspicious code in the kernel (of
the "it works, but maybe it wasn't really robust" variety).

Files: expand.c (+10/-3)
--------------------------------------------------------------------------------

[a84e9f4655d6] 2005-04-07 21:03:57 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Set the bit_offset in the SYM_BITFIELD entry too, not just the actual node.

The type should be valid even if somebody peels off the node
information.

Files: symbol.c (+1/-0)
--------------------------------------------------------------------------------

[19da63710dc5] 2005-04-07 21:03:56 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove "fieldwidth" member of struct symbol

It's always the same as bit_size now, and having it just confuses
things.

We now check whether we have examined a type by looking at the
"examined" bitfield, which allows us to set bit_size in the early
parsing phase.

Files: compile-i386.c (+1/-3), evaluate.c (+4/-10), parse.c (+8/-11), show-parse.c (+2/-4), symbol.c (+5/-10), ... and 1 more
--------------------------------------------------------------------------------

[ee00a48feb91] 2005-04-07 21:03:56 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make bitfield assignment type evaluation aware of the bit offset.

This means that we really always see the full type on assignment,
including bit size and bit position.

Files: evaluate.c (+2/-0)
--------------------------------------------------------------------------------

[7b2c0dd68438] 2005-04-07 21:03:56 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up structure bitfield placement.

The change in bitfield symbol bit_size means that structure
placement needs to get the size of the base type by walking
it explicitly.

Files: symbol.c (+10/-1)
--------------------------------------------------------------------------------

[d2a83ca97c6f] 2005-04-07 21:03:55 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Check integer/FP promotion early in compatible_assignment_types()

Since "type_difference()" considers all integers interchangeable,
we need to do the int/FP promotion checks _before_ we decide that
the types are identical.

Files: evaluate.c (+6/-6)
--------------------------------------------------------------------------------

[26fc30e19060] 2005-04-07 21:03:55 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Examine bitfield symbols properly.

They have their fieldwidth as their bit_size. They do
end up getting promoted to their base type on most usage,
but that doesn't change their fundamental properties.

Files: symbol.c (+1/-1)
--------------------------------------------------------------------------------

[94b01672560d] 2005-04-07 21:03:55 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] Linearize initializer

Here is a tentative patch to do initializer linearizations properly. 

While I am learning the new initializer tree.  I think the current way
of initializing does not handle the bit field member correctly.  I can't
tell from the initializer tree that a member is a bit field.  Do I miss
some thing?

[ Linus' note: "expr->ctype" should have the type of the individual assignment (and
  thus the bitfield), but maybe I'm wrong.

  So check that first, but if I'm full of sh*t, we probably need to make
  the offset be a bit-offset in the EXPR_POS thing, and add a size field
  too.  ]

Anyway, here is the patch works for non bit field.

Files: linearize.c (+60/-39)
--------------------------------------------------------------------------------

[f30f4471a147] 2005-04-07 21:03:54 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't generate invalid phi-nodes.

We'd generate crapola phi-nodes if we hit a nonreachable return.

Also, don't assume all bb's have instructions.

Files: linearize.c (+2/-2)
--------------------------------------------------------------------------------

[0e79cf73857f] 2005-04-07 21:03:54 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove stale EXPR_ASSIGNMENT binop linearization.

The expression evaluation phase has already done all
the expansion of the special assignment operators, and
we only have a regular assignment left.

Files: linearize.c (+0/-17)
--------------------------------------------------------------------------------

[0c75d4b5b0df] 2005-04-07 21:03:54 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do silly phi-node "expansion" as the last phase of the linearized tree.

This just copies all the phi node information into the
source of the phi node, so that the linearized thing looks
a bit more like "real" assembly language. It's likely
bogus in many ways, but I want to make a pretty-printer
for the linearized output, and this will make it much
much easier to do.

Files: linearize.c (+63/-0), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[ea8cf8a9d7c3] 2005-04-07 21:03:53 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Prevent buffer overrun in show_string.

[Auto-summary] Modifies tokenize.c. Changes: +1/-1 in 1 file(s)

Files: tokenize.c (+1/-1)
--------------------------------------------------------------------------------

[1bdbd8e624f8] 2005-04-07 21:03:53 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use proper ptrdiff_t printf argument.

Let's make like modern man, and use C99.

Files: tokenize.c (+1/-1)
--------------------------------------------------------------------------------

[59db9e9fa898] 2005-04-07 21:03:53 -0700
Author: fzago@systemfabricworks.com <fzago@systemfabricworks.com>
Subject: [PATCH] __builtin_frame_address

Adds support for __builtin_frame_address and fixes the prototype of
__builtin_return_address (according to 

http://gcc.gnu.org/onlinedocs/gcc-3.4.2/gcc/Return-Address.html#index-_005f_005fbuiltin_005freturn_005faddress-1773)

Files: lib.c (+2/-1)
--------------------------------------------------------------------------------

[3b98a8d38eff] 2005-04-07 21:03:52 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add deathnotes for block statement nodes and void casts.

[Auto-summary] Modifies linearize.c. Changes: +8/-2 in 1 file(s)

Files: linearize.c (+8/-2)
--------------------------------------------------------------------------------

[9bcb9fc87dd4] 2005-04-07 21:03:52 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove remnants of two-expression x ? : y handling..

We turn it into a proper (tmp = x, tmp ? tmp : y) at evaluation
time, so later phases never have to worry about the issue. But
some of the old code lingered.

Files: compile-i386.c (+3/-10), expand.c (+0/-1), linearize.c (+8/-16), show-parse.c (+0/-2)
--------------------------------------------------------------------------------

[d9e8839d6411] 2005-04-07 21:03:52 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add deathnotes for the pseudo's we use.

It's a hell of a lot easier to add them when generating the
linearized output than it is to go back and analyse them later.

We know when we throw values away, so just note it.

NOTE NOTE NOTE! This is only a rough first draft. Not complete.

Files: linearize.c (+76/-18), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[9de85187a055] 2005-04-07 21:03:51 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix show-linearize symbol SETVAL output.

Silly code didn't break out after showing an identifier name.

Files: linearize.c (+8/-5)
--------------------------------------------------------------------------------

[2859650d2aa6] 2005-04-07 21:03:51 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make lock context warnings a bit more readable.

[Auto-summary] Modifies check.c. Changes: +5/-5 in 1 file(s)

Files: check.c (+5/-5)
--------------------------------------------------------------------------------

[f4dc67f56d40] 2005-04-07 21:03:51 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make sure to examine restricted types too.

[Auto-summary] Modifies symbol.c. Changes: +3/-0 in 1 file(s)

Files: symbol.c (+3/-0)
--------------------------------------------------------------------------------

[9fb615407dca] 2005-04-07 21:03:50 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use 'bad_type' instead of NULL when something bad happens in type evaluation.

This avoids a lot of special cases later on, and makes the
error messages more readable anyway.

We re-use the old "bad_enum_ctype" for this, and just make
it more generic (and rename it).

Files: evaluate.c (+1/-1), parse.c (+6/-6), show-parse.c (+1/-0), symbol.c (+4/-6), symbol.h (+4/-7)
--------------------------------------------------------------------------------

[5e766f5dc9e9] 2005-04-07 21:03:50 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Implement a C99-like _Bool type.

Right now it's a strange kind of single-bit integer. As
a result, you cannot do a "sizeof" on it. Dunno what the
real C99 semantics should be, and don't much care yet.

Files: symbol.c (+2/-1), target.c (+1/-0), target.h (+1/-0)
--------------------------------------------------------------------------------

[05a7acd2314b] 2005-04-07 21:03:50 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up integer promotion so that it works on all integer types < int.

This will be needed for C99 _Bool.

Files: evaluate.c (+17/-11)
--------------------------------------------------------------------------------

[c72032ad3b37] 2005-04-07 21:03:49 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add comment on what caused type examination recursion.

.. so that it doesn't end up being an issue later.

Files: symbol.c (+6/-0)
--------------------------------------------------------------------------------

[528bd73b5ac0] 2005-04-07 21:03:49 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Merge http://sparse-mw.bkbits.net:8080/janitorial into ppc970.osdl.org:/home/torvalds/BK/sparse

[Auto-summary] Modifies symbol.c. Changes: +70/-53 in 1 file(s)

Files: symbol.c (+70/-53)
--------------------------------------------------------------------------------

[c54dde80030b] 2005-04-07 21:03:49 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up symbol examination some more.

The structure recursion avoidance turns out to be buggy. While
chasing down that particular confusion, I cleaned up symbol
examination some more, and fixed the problem that caused me
to believe that the recursion avoidace was necessary.

Files: symbol.c (+70/-53)
--------------------------------------------------------------------------------

[f2d2f94ae354] 2005-04-07 21:03:48 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Merge troll.com:/scratch/welinder/linus-sparse into troll.com:/scratch/welinder/janitorial

[Auto-summary] Modifies tokenize.c. Changes: +15/-4 in 1 file(s)

Files: tokenize.c (+15/-4)
--------------------------------------------------------------------------------

[fa778d405e99] 2005-04-07 21:03:48 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't recurse on struct/union symbol examine, if the struct has a member that points to the same type.

This triggered because we now examine behind pointers too,
but it could also have trigger on malformed C programs.

Files: symbol.c (+1/-0)
--------------------------------------------------------------------------------

[5d4f5a0436a7] 2005-04-07 21:03:48 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't generate invalid statements when encountering a case statement which is not in switch scope.

[Auto-summary] Modifies parse.c. Changes: +1/-0 in 1 file(s)

Files: parse.c (+1/-0)
--------------------------------------------------------------------------------

[9c472d8b81c9] 2005-04-07 21:03:47 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Allow longer number tokens (up to 4095 characters) and catch violations instead of crashing.

[Auto-summary] Modifies tokenize.c. Changes: +15/-4 in 1 file(s)

Files: tokenize.c (+15/-4)
--------------------------------------------------------------------------------

[bc49cbc5d4ba] 2005-04-07 21:03:47 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be more forgiving about bad 'goto' statement linearization.

No need to SIGSEGV.

Files: linearize.c (+4/-1)
--------------------------------------------------------------------------------

[a89fb02dce4c] 2005-04-07 21:03:47 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do base_type examination in common code in examine_symbol_type().

Also, check it for enums. This should also make sure that we handle
"typeof" properly in all cases.

Files: symbol.c (+14/-16)
--------------------------------------------------------------------------------

[1b872b551177] 2005-04-07 21:03:46 -0700
Author: Ralf.Wildenhues@gmx.de <Ralf.Wildenhues@gmx.de>
Subject: [PATCH] More validation tests

badtype2 segfaults on buggy code (similar to last one, now badtype1),
badtype3 similarly,

builtin_safe1 uses __builtin_safe_p.  sparse does not consider pure and
const attributes here yet (which might be considered worthwhile),

varargs1 gives a bogus warning on valid code.

Generally, it's a good idea to just throw a bunch of C files at sparse
to find more problems like this.  The gcc testsuite is a good example
(where typical problem cases are small already), and, in fact, produces
twenty-some core files.

Files: validation/badtype1.c (+1/-0), validation/badtype2.c (+10/-0), validation/badtype3.c (+10/-0), validation/builtin_safe1.c (+26/-0), validation/struct-size1.c (+17/-0), ... and 1 more
--------------------------------------------------------------------------------

[561beaedd34c] 2005-04-07 21:03:46 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When re-evaluating the type of a function agument (because it was implicitly converted from a FN/ARRAY to a PTR), clear the bit_size first.

Otherwise the type evaluation thinks we have already evaluated the
type, and returns without doing anything.

Files: evaluate.c (+1/-0)
--------------------------------------------------------------------------------

[338ea032ecbf] 2005-04-07 21:03:46 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Increase identifier hash size

Looks like the kernel regularly has 10,000+ identifiers
in a compilation unit. So make sparse have 16k hash buckets,
since the identifier hash find/create is at the top of the
profiles..

Files: tokenize.c (+3/-2)
--------------------------------------------------------------------------------

[9757c88125d3] 2005-04-07 21:03:45 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix cost of a simplified int/fp binop expression.

The cost of constants is 0. It matters now that we use this
cost for __builtin_const_p().

Files: expand.c (+2/-2)
--------------------------------------------------------------------------------

[5014c89a89d2] 2005-04-07 21:03:45 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Implement __builtin_safe_p() to match __builtin_constant_p.

While __builtin_constant_p() tells you whether an expression is
constant, __builtin_safe_p() tells you whether it has side effects.

NOTE! A "safe" expression can still access pointers and generally
cause SIGSEGV and chaos. But it's useful to check whether a macro
argument can safely be used multiple times, for example.

Suggested use something like

	#define MY_MACRO(a) do { \
		__builtin_warning(!__builtin_safe_p(a), "Macro argument with side effects"); \
		... use 'a' multiple times ...

which does the obvious thing.

Files: expand.c (+19/-3), symbol.c (+10/-26), symbol.h (+4/-1)
--------------------------------------------------------------------------------

[a3f02e417b82] 2005-04-07 21:03:45 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Now that we don't do array sizing at symbol eval time any more, simplify evaluate_initializer().

This just removes the code that was only there to track the
array size.

Files: evaluate.c (+28/-34)
--------------------------------------------------------------------------------

[80018ed401b8] 2005-04-07 21:03:44 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow zero-sized array initializers.

[Auto-summary] Modifies symbol.c. Changes: +1/-2 in 1 file(s)

Files: symbol.c (+1/-2)
--------------------------------------------------------------------------------

[9728066d4849] 2005-04-07 21:03:44 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't SIGSEGV on NULL pseudo_t's when showing bad instructions.

It makes debugging much easier when the debugging output actually
works even when there are buggy instructions ;)

Files: linearize.c (+28/-20)
--------------------------------------------------------------------------------

[a53ac6219a0b] 2005-04-07 21:03:44 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do array sizing at "examine_symbol_type()" time.

Don't do it during symbol evaluation - at that point it's
already too late.

This also cleans up examine_symbol_type() a lot.

Files: evaluate.c (+2/-10), symbol.c (+78/-25)
--------------------------------------------------------------------------------

[68b59f23014d] 2005-04-07 21:03:43 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make context count warning be controllable with "-Wcontext" flag.

It defaults to off, for now.

Files: check.c (+4/-2), lib.c (+2/-0), lib.h (+1/-2)
--------------------------------------------------------------------------------

[96f1aa2cca69] 2005-04-07 21:03:43 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make context attributes additive.

This way we can have multiple of them, and they
add up correctly.

Files: parse.c (+4/-4)
--------------------------------------------------------------------------------

[8636398d88f2] 2005-04-07 21:03:43 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Start "linearizing" initializers.

It's really pretty fake, but we used to ignore initializers
completely, so this is certainly better than that. Now we at
least linearize all the sub-expressions, and we do a kind
of fake assignment.

Files: linearize.c (+96/-22), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[7ee86f4f19f3] 2005-04-07 21:03:42 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Break out STMT_COMPOUND linearization into a function of its own.

This is in preparation for linearizing initializers properly..

Files: linearize.c (+32/-27)
--------------------------------------------------------------------------------

[6605aed58f4c] 2005-04-07 21:03:42 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix inlining: we didn't copy the switch case symbol list.

Oops. It never mattered before, because the linearized end
result wasn't really used. Now that we check for context,
it does matter. Big way.

Files: inline.c (+3/-0)
--------------------------------------------------------------------------------

[a7d018323860] 2005-04-07 21:03:42 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do some trivial statement simplification.

Turn a trivial STMT_COMPOUND into its single statement. And if,
as a result, we can turn a EXPR_STATEMENT of a STMT_EXPRESSION
into it's simple expression, all the better.

Files: expand.c (+52/-18)
--------------------------------------------------------------------------------

[57e63cc7baeb] 2005-04-07 21:03:41 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "show_bb()" show the source location of the basic blocks

[Auto-summary] Modifies linearize.c. Changes: +3/-1 in 1 file(s)

Files: linearize.c (+3/-1)
--------------------------------------------------------------------------------

[123b6ea58c2a] 2005-04-07 21:03:41 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove 'pos' argument from "add_one_insn()".

It wasn't used anyway, and we don't want to do positions
on a per-instruction basis. We have them per-bb now, which
is saner (even if the positions themselves may not be quite
right ;)

Files: linearize.c (+17/-18)
--------------------------------------------------------------------------------

[e74d668a8bc6] 2005-04-07 21:03:41 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Output context change markers when linearizing function calls.

This means that we get the context change right when we call
functions that change context.

Files: linearize.c (+17/-0)
--------------------------------------------------------------------------------

[cf299d813d44] 2005-04-07 21:03:40 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use the in_context/out_context information in the context balance checking.

A function with an in_context of -1 will not be checked.

Files: check.c (+17/-15)
--------------------------------------------------------------------------------

[62997b8e331e] 2005-04-07 21:03:40 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Replace context/contextmask (never used) with in_context/out_context.

It's a way of telling the checker what the input context count is
expected to be, and what the output context should be.

For example, a function that is expected to be called with a spinlock
held, and releases that lock, could have an in_context of 1, and an
out_context of 0.

Files: evaluate.c (+1/-27), parse.c (+11/-18), show-parse.c (+1/-1), symbol.c (+2/-2), symbol.h (+1/-1)
--------------------------------------------------------------------------------

[a3633e9c07ae] 2005-04-07 21:03:40 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Associate each pseudo with the instruction that defines it.

This allows us to get rid of the loop that searches for the def
of a pseudo when simplifying <phi+br> blocks.

Files: linearize.c (+25/-23), linearize.h (+3/-0)
--------------------------------------------------------------------------------

[9a22ed36e183] 2005-04-07 21:03:39 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify <phi+br> basic blocks.

We go through each of the sources of the <phi> node,
and see if that is a constant, and if so, we can make
the source branch directly to the target without
going through the <phi+br> node.

Files: linearize.c (+79/-0)
--------------------------------------------------------------------------------

[bc236d83cb0c] 2005-04-07 21:03:39 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make context imbalance checker print out slightly better positional information using the new bb->pos field.

[Auto-summary] Modifies check.c. Changes: +16/-12 in 1 file(s)

Files: check.c (+16/-12)
--------------------------------------------------------------------------------

[bc4c5afb8a8c] 2005-04-07 21:03:39 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add "struct position" to basic blocks, and give it some half-way sane value.

This makes it easier to tell people where a linearizer
event happened. It won't be exact, but at least it will
be _somewhere_ closer than just saying "it was in this
function".

Files: linearize.c (+18/-17), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[738fe3b7388b] 2005-04-07 21:03:38 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Duh. It's ok to not have any instructions in a bb.

[Auto-summary] Modifies check.c. Changes: +2/-0 in 1 file(s)

Files: check.c (+2/-0)
--------------------------------------------------------------------------------

[1b71fb3a43dc] 2005-04-07 21:03:38 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Copy STMT_INTERNAL properly when inlining

(In practice, it should always be a constant, so it did the
right thing. But maybe it becomes that only after expansion
at the inlining site..)

Files: inline.c (+1/-0)
--------------------------------------------------------------------------------

[f9344b85c8b0] 2005-04-07 21:03:38 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Get rid of the old "iterate()" interfaces.

Use FOR_EACH_PTR() instead, or the much fancier iterators
for basic blocks.

Files: check.c (+14/-10), compile-i386.c (+12/-13), compile.c (+9/-5), lib.c (+0/-19), lib.h (+0/-19), ... and 5 more
--------------------------------------------------------------------------------

[92324d8f32c6] 2005-04-07 21:03:38 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "check" (aka "sparse") check for context imbalance.

We just walk the linearizer instruction web, and check
that the entry context matches the exit context(s).

Files: check.c (+64/-1)
--------------------------------------------------------------------------------

[93f1ca29e4cf] 2005-04-07 21:03:37 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add an internal sparse "context" statement type.

It just ends up propagating the expression to the linearizer,
which creates an internal "context" instruction for it.

Files: evaluate.c (+3/-0), expand.c (+3/-0), ident-list.h (+3/-0), linearize.c (+23/-1), linearize.h (+7/-0), ... and 3 more
--------------------------------------------------------------------------------

[a154193c75f3] 2005-04-07 21:03:37 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up declarator sym->ident handling.

Since bind_symbol() now sets it, we don't need to set it by
hand any more.

Also, we really don't need to pass a pointer to a symbol
pointer in the declarator parsing functions, since they
never change it, and depend on it being set anyway. Might
as well just pass in the direct pointer to the symbol
instead.

Files: parse.c (+14/-24)
--------------------------------------------------------------------------------

[42a74cdbd860] 2005-04-07 21:03:36 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "bind_symbol()" also set sym->ident.

This way we're guaranteed to have all bound symbols with
proper idents, which wasn't true before (at least the
preprocessor macro code didn't set the identifier).

Files: symbol.c (+3/-1)
--------------------------------------------------------------------------------

[d16c7a0d4290] 2005-04-07 21:03:36 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add __sizeof_ptr__ that looks at a pointer expression and returns the size of the underlying object.

This is different from "sizeof(*expr)" for arrays, where
the array would degenerate to a pointer to one member, and
thus "sizeof(*expr)" gives the size of one entry in the
array.

Why do this? It's useful for things like

   #define memset(a,b,c) ({ \
        (void) __builtin_warning(__sizeof_ptr__(a) > 1, __sizeof_ptr__(a) != (c), "check memset size"); \
        memset(a, b, c); })

where we really want to check the size of the object we're
doing the "memset()" on, but the regular sizeof() just doesn't
cut it.

Files: evaluate.c (+70/-29), expand.c (+1/-0), expression.c (+47/-31), expression.h (+1/-0), inline.c (+1/-0), ... and 1 more
--------------------------------------------------------------------------------

[915a15922645] 2005-04-07 21:03:36 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Mark more identifiers reserved.

Also, add "__sizeof_ptr__" identifier for new addition..

Files: ident-list.h (+7/-6)
--------------------------------------------------------------------------------

[4259631697e2] 2005-04-07 21:03:35 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Merge troll.com:/scratch/welinder/linus-sparse into troll.com:/scratch/welinder/cgcc

[Auto-summary] Modifies 3 source files: check.c, lib.c, test-linearize.c. Updates header lib.h. Changes: +29/-15 in 4 file(s)

Files: check.c (+5/-9), lib.c (+18/-1), lib.h (+1/-0), test-linearize.c (+5/-5)
--------------------------------------------------------------------------------

[db91d72b1a13] 2005-04-07 21:03:35 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Merge troll.com:/scratch/welinder/linus-sparse into troll.com:/scratch/welinder/cgcc

[Auto-summary] Modifies 2 source files: parse.c, show-parse.c. Changes: +44/-18 in 2 file(s)

Files: parse.c (+26/-13), show-parse.c (+18/-5)
--------------------------------------------------------------------------------

[79bfac6d70f2] 2005-04-07 21:03:35 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: test-linearize.c:   Simplify using declare_builtin_functions. lib.h:   declare declare_builtin_functions. lib.c:   New declare_builtin_functions extracted from check.c   Fix __builtin_ffs prototype.   Define __SIZE_TYPE__ only conditionally to allow it to be overwritten   from command line by cgcc.   Add __builtin_va_alist and __builtin_va_arg_incr stubs. check.c:   Move builtin declarations to lib.c

[Auto-summary] Modifies 3 source files: check.c, lib.c, test-linearize.c. Updates header lib.h. Changes: +26/-14 in 4 file(s)

Files: check.c (+2/-8), lib.c (+18/-1), lib.h (+1/-0), test-linearize.c (+5/-5)
--------------------------------------------------------------------------------

[ba3cbdd69ec8] 2005-04-07 21:03:35 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Merge troll.com:/scratch/welinder/linus-sparse into troll.com:/scratch/welinder/janitorial

[Auto-summary] Modifies 2 source files: parse.c, show-parse.c. Changes: +44/-18 in 2 file(s)

Files: parse.c (+26/-13), show-parse.c (+18/-5)
--------------------------------------------------------------------------------

[2784d98613ef] 2005-04-07 21:03:34 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up "enum" base types.

We should only look at the value range if not all value
types agree.

Files: parse.c (+26/-13)
--------------------------------------------------------------------------------

[47e4922079f7] 2005-04-07 21:03:34 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Show the base-type for an enum in "show_typename()".

Since our enum's can have strange types, we should show them.

Files: show-parse.c (+1/-1)
--------------------------------------------------------------------------------

[2e67bb572647] 2005-04-07 21:03:34 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix symbol_debug() symbol type print-out.

It got corrupted when we added more symbol types and moved
things around.

Files: show-parse.c (+17/-4)
--------------------------------------------------------------------------------

[14db8c95287f] 2005-04-07 21:03:33 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Reorganize integer and floating point defines into specs.

[Auto-summary] Modifies: cgcc. Changes: +25/-23 in 1 file(s)

Files: cgcc (+25/-23)
--------------------------------------------------------------------------------

[d1d2f9d0116e] 2005-04-07 21:03:33 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Don't add declarations when -E is used.

[Auto-summary] Modifies check.c. Changes: +11/-9 in 1 file(s)

Files: check.c (+11/-9)
--------------------------------------------------------------------------------

[744bd80a0bc4] 2005-04-07 21:03:33 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Handle __func__, __FUNCTION__ and __PRETTY_FUNCTION__ the same way, and give them a real string.

This means that __func__ actually works as a constant string,
not as a pseudo-symbol, which is wrong. But hey, sue me.

Files: evaluate.c (+1/-1), expression.c (+59/-0), ident-list.h (+2/-0), lib.c (+0/-5), parse.c (+3/-26), ... and 1 more
--------------------------------------------------------------------------------

[30fbaa8a02f8] 2005-04-07 21:03:32 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Handle bad strings gracefully.

We should never see a TOKEN_STRING of size 0, since
we always add the final '\0' to the string. But bugs
happen, and we'd rather see the problem than a SIGSEGV.

Files: tokenize.c (+2/-0)
--------------------------------------------------------------------------------

[a17b6c494fd8] 2005-04-07 21:03:32 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be a bit nicer about showing string constants.

We've converted them to anonymous symbols of type "array of char"
earlier, but we don't actually want to _show_ them as symbols,
we want to show them as the string.

Files: show-parse.c (+4/-0)
--------------------------------------------------------------------------------

[d3720ccc2302] 2005-04-07 21:03:32 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make 'make install' check the target install directory.

Instead of just silently creating it, make the thing tell
the user to create it and add the directory to the PATH.

Andrew didn't even _have_ a ~/bin. He may not be the only
person with that strange deficiency.

Files: Makefile (+10/-1)
--------------------------------------------------------------------------------

[0f294b33a6c6] 2005-04-07 21:03:31 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: lib.c:   Handle -U. cgcc:   Teach cgcc about "-v".   Teach cgcc not to run compiler when "-E" is seen.   Add define for __SIZE_TYPE__.

[Auto-summary] Modifies lib.c. Changes: +38/-6 in 2 file(s)

Files: cgcc (+26/-4), lib.c (+12/-2)
--------------------------------------------------------------------------------

[3bc7425b7a1e] 2005-04-07 21:03:31 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Merge troll.com:/scratch/welinder/linus-sparse into troll.com:/scratch/welinder/janitorial

[Auto-summary] Modifies lib.c. Changes: +6/-1 in 1 file(s)

Files: lib.c (+6/-1)
--------------------------------------------------------------------------------

[90277b7cb7b0] 2005-04-07 21:03:31 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Merge http://sparse-mw.bkbits.net:8080/janitorial into ppc970.osdl.org:/home/torvalds/BK/sparse

[Auto-summary] Modifies parse.c. Changes: +1/-1 in 1 file(s)

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[bcb8e17ecdb2] 2005-04-07 21:03:30 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Add __FUNCTION__ and __PRETTY_FUNCTION__ defines.

[Auto-summary] Modifies lib.c. Changes: +6/-1 in 1 file(s)

Files: lib.c (+6/-1)
--------------------------------------------------------------------------------

[d5b45cace4f8] 2005-04-07 21:03:30 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Add -no-compile

[Auto-summary] Modifies: cgcc. Changes: +33/-20 in 1 file(s)

Files: cgcc (+33/-20)
--------------------------------------------------------------------------------

[565664565497] 2005-04-07 21:03:30 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Handle asm __volatile variant too. Will someone please dispatch a firing squad to gcc HQ?

[Auto-summary] Modifies parse.c. Changes: +1/-1 in 1 file(s)

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[593a9f8db63c] 2005-04-07 21:03:29 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Introduce the notion of "reserved" identifiers.

The only thing they do is to refuse to bind to the regular
C namespaces (NS_TYPEDEF | NS_STRUCT | NS_LABEL | NS_SYMBOL)
with a warning.

You can mark any identifier you want reserved by just setting
ident->reserved = 1. Sparse won't care.

Files: ident-list.h (+44/-18), symbol.c (+9/-4), symbol.h (+1/-1), token.h (+2/-1)
--------------------------------------------------------------------------------

[cf2bde63a650] 2005-04-07 21:03:29 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Handle predefines for integer types, floating point types, and system in cgcc.

[Auto-summary] Modifies lib.c. Changes: +146/-7 in 2 file(s)

Files: cgcc (+146/-1), lib.c (+0/-6)
--------------------------------------------------------------------------------

[d0fe40624f3d] 2005-04-07 21:03:29 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Merge http://sparse-mw.bkbits.net:8080/janitorial into ppc970.osdl.org:/home/torvalds/BK/sparse

[Auto-summary] Modifies lib.c. Changes: +1/-1 in 1 file(s)

Files: lib.c (+1/-1)
--------------------------------------------------------------------------------

[12dc7e4bb89a] 2005-04-07 21:03:28 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] graceful handling of old-style array initializers

The current gcc initializer code is too permissive, AFAICS - [0][0] 1
will be rejected by gcc too, so we shouldn't consider it "broken gcc syntax".

There was another bug in there -
                *ep = NULL;
                token = initializer(ep, token);
                if (!expr)
                        break;
                add_expression(list, expr);
would not catch the case when we have e.g. .foo = <bad expression> and we
end up with list polluted by EXPR_IDENTIFIER with NULL ->ident_expression.

Should be if (!*ep) instead.

This also cleans it up by splitting the list handling case up from the
loop, and making the single initializer parsing a function of its own.

Files: parse.c (+45/-31)
--------------------------------------------------------------------------------

[34af6836056a] 2005-04-07 21:03:28 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Rename -Wundefined-preprocessor-symbol to -Wundef to match gcc.

[Auto-summary] Modifies lib.c. Changes: +1/-1 in 1 file(s)

Files: lib.c (+1/-1)
--------------------------------------------------------------------------------

[e95028ed6a5b] 2005-04-07 21:03:28 -0700
Author: David Mosberger <davidm@napali.hpl.hp.com>
Subject: [PATCH] trivial sparse patch - ignore model attribute

Teach sparse to ignore the "model" (aka "__model__") attribute used by
ia64 linux.

Signed-off-by: davidm@hpl.hp.com
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: ident-list.h (+1/-1), parse.c (+3/-0)
--------------------------------------------------------------------------------

[6b4b39fc0b8c] 2005-04-07 21:03:27 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Warn about old-style gcc named initializers, suggesting C99 usage.

Most of the kernel ones have long since been converted. This might
help convert the last few hold-outs.

Files: parse.c (+12/-4)
--------------------------------------------------------------------------------

[10c418978d06] 2005-04-07 21:03:27 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Merge bk://sparse-mw@sparse-mw.bkbits.net/solaris into troll.com:/scratch/welinder/solaris

[Auto-summary] Modifies 5 source files: compat-linux.c, compat-solaris.c, compat/id-files-stat.c and 2 more. Modifies build system. Changes: +89/-49 in 6 file(s)

Files: Makefile (+6/-0), compat-linux.c (+3/-49), compat-solaris.c (+34/-0), compat/id-files-stat.c (+7/-0), compat/mmap-blob.c (+33/-0), ... and 1 more
--------------------------------------------------------------------------------

[7a52af572ba9] 2005-04-07 21:03:27 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Add compatibility file for solaris.

[Auto-summary] Modifies 5 source files: compat-linux.c, compat-solaris.c, compat/id-files-stat.c and 2 more. Modifies build system. Changes: +89/-49 in 6 file(s)

Files: Makefile (+6/-0), compat-linux.c (+3/-49), compat-solaris.c (+34/-0), compat/id-files-stat.c (+7/-0), compat/mmap-blob.c (+33/-0), ... and 1 more
--------------------------------------------------------------------------------

[bd657dfca927] 2005-04-07 21:03:26 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: We actually _can_ have multiple initializers at offset zero.

It's not an error, it just is pretty rare. It happens when there
are bitfields that are all at byte offset zero, and we need to
allocate a new EXPR_POS when we offset these bitfields due to
them being inside a nested initializer.

Files: expand.c (+6/-2)
--------------------------------------------------------------------------------

[4250a6355c2a] 2005-04-07 21:03:26 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be more lenient in placement of 'asm("reg")' variable hard-register specifiers.

They now parse the same way as __attribute__ node-specifiers. This
simplifies the code, and makes sparse not care about random gcc
rules for exactly where one or the other can be placed.

Files: parse.c (+17/-13)
--------------------------------------------------------------------------------

[dec7c920ee33] 2005-04-07 21:03:26 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] testcase for two-argument ?:

[Auto-summary] Adds/updates 1 test(s). Changes: +11/-0 in 1 file(s)

Files: validation/cond_expr.c (+11/-0)
--------------------------------------------------------------------------------

[3f9dcfb9cc71] 2005-04-07 21:03:26 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] two-arguments ?:

Instead of trying to handle two- and three-argument ?: in the same code,
have evaluate_expression() turn the expression 'v1 ? : v2' into its
equivalent of '(temp_var = v1, temp_var ? temp_var : v2)' and use the
normal logics to deal with the results.

Files: evaluate.c (+59/-23)
--------------------------------------------------------------------------------

[e3f66d29bd11] 2005-04-07 21:03:25 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] #if expression handling cleanups

- handling of "unexpanded identifiers should be replaced with 0" is
   moved to pre-process.c and done on token replacement level
 - warning about such replacement made conditional
 - expand() and expand_one_symbol() return int now - it's "is the first
   token completely expanded now" (simplifies the life in #if handling,
   etc.)
 - crud removed from evaluate.c and expand.c

Files: evaluate.c (+0/-4), expand.c (+0/-11), lib.c (+2/-0), lib.h (+1/-0), pre-process.c (+24/-22)
--------------------------------------------------------------------------------

[b598c1d75a9c] 2005-04-07 21:03:25 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] enum handling

a) we allow enum have an equivalent type other than int (it is kept in
   ->ctype.base_type for SYM_ENUM types).  Code adjusted.

b) enum declaration parsing tries to determine the equivalent type; if
   such type does not exist we set it to &bad_enum_ctype and
   examine_symbol_type() generates a warning when it meets such beast.
   The rules for equivalent type follow:

	1) if all members have the same bitwise type, it is the
	   equivalent type of enum.
	2) if all members have integer types and there is a single
	   integer type capable of representing all their values, we pick
	   the first such type (in the same ordering that is used for e.g.
	   integer constants). 
	3) anything else => bad_enum_ctype.

c) enum is compatible with its equivalent type. 

d) it is an error to have implied initializer for a member following
   that of bitwise type.

There are still issues with float in enums, but since gcc would choke on
those unconditionally, we can be sure that there's no instances in any
code we could deal with (unless we start playing with Plan 9 codebase,
and that would require more work in other places - float enum is not the
only C extension in there).  Separate patch...

Files: evaluate.c (+33/-6), parse.c (+99/-6), symbol.c (+15/-5), symbol.h (+7/-3)
--------------------------------------------------------------------------------

[2f41db312c29] 2005-04-07 21:03:25 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Automerge

[Auto-summary] Modifies symbol.c. Updates header symbol.h. Modifies build system. Changes: +21/-8 in 3 file(s)

Files: Makefile (+1/-1), symbol.c (+19/-6), symbol.h (+1/-1)
--------------------------------------------------------------------------------

[fca17a5e7fa3] 2005-04-07 21:03:24 -0700
Author: welinder@anemone.rentec.com <welinder@anemone.rentec.com>
Subject: Ignore test-sort binary.

[Auto-summary] No file changes detected.

--------------------------------------------------------------------------------

[c65d719b26da] 2005-04-07 21:03:24 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add new "compat.h" header file to lib dependencies list.

Noted by Chris Wedgwood.

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[671999280089] 2005-04-07 21:03:24 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix structure size calculation for structures with unsized arrays.

Such a structure does not have its size padded up by the alignment,
since arrays of such structures are meaningless anyway.

Files: symbol.c (+19/-6), symbol.h (+1/-1)
--------------------------------------------------------------------------------

[ac763443663d] 2005-04-07 21:03:23 -0700
Author: welinder@anemone.rentec.com <welinder@anemone.rentec.com>
Subject: New BitKeeper file ``test-sort.c''

[Auto-summary] Modifies test-sort.c. Modifies build system. Changes: +48/-0 in 2 file(s)

Files: Makefile (+3/-0), test-sort.c (+45/-0)
--------------------------------------------------------------------------------

[1c849c0c3a50] 2005-04-07 21:03:23 -0700
Author: welinder@anemone.rentec.com <welinder@anemone.rentec.com>
Subject: Make sure sort does not degenerate.

[Auto-summary] Modifies 2 source files: expand.c, sort.c. Changes: +264/-76 in 2 file(s)

Files: expand.c (+8/-8), sort.c (+256/-68)
--------------------------------------------------------------------------------

[705c7094486e] 2005-04-07 21:03:23 -0700
Author: welinder@anemone.rentec.com <welinder@anemone.rentec.com>
Subject: This file uses NULL, so include stdlib.h

[Auto-summary] Updates header lib.h. Changes: +3/-0 in 1 file(s)

Files: lib.h (+3/-0)
--------------------------------------------------------------------------------

[68bf91832fcd] 2005-04-07 21:03:22 -0700
Author: mshah@teja.com <mshah@teja.com>
Subject: [PATCH] fix compat-cygwin.c

mingw works fine, but cygwin needs <sys/stat.h> for stat structure
definition.

Files: compat-cygwin.c (+2/-1)
--------------------------------------------------------------------------------

[0b992c5bbe7e] 2005-04-07 21:03:22 -0700
Author: mshah@teja.com <mshah@teja.com>
Subject: [PATCH] WinGW/CygWin compatibility support

First cut at CygWin/MinGW compat support.

Currently, for mingw, I am using windows API to identify the files
uniquely, which is somewhat heavy because I have to open both the files
simultaneously to compare the indices, will replace it to a lighter
version later if I find out how to do that.

Files: compat-cygwin.c (+43/-0), compat-mingw.c (+60/-0)
--------------------------------------------------------------------------------

[3f5a1da9cced] 2005-04-07 21:03:22 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add system-specific compatibility functions to make up for various system deficiencies.

This makes sparse easier to port to silly things like
MinGW or Solaris. In particular:

 - strtold() is a C99 thing, not everybody has it
 - MinGW has problems with mmap(MAP_ANONYMOUS) and doesn't zero it.
 - st_ino/st_dev is POSIX identity testing, not supported by MinGW

Files: Makefile (+3/-1), compat-linux.c (+53/-0), compat.h (+31/-0), expression.c (+1/-2), lib.c (+0/-19), ... and 2 more
--------------------------------------------------------------------------------

[fd59b219733d] 2005-04-07 21:03:21 -0700
Author: pj@ludd.ltu.se <pj@ludd.ltu.se>
Subject: [PATCH] Use $(CC) everywhere in Makefile.

This changes the sparse Makefile to use $(CC) (which is already defined
at the top) instead of using gcc directly.  That makes it possible to
use "make CC=/long/path/bin/gcc".

Files: Makefile (+6/-6)
--------------------------------------------------------------------------------

[f2a405d6a82e] 2005-04-07 21:03:21 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't SIGSEGV on bad cast expressions.

[Auto-summary] Modifies evaluate.c. Changes: +3/-0 in 1 file(s)

Files: evaluate.c (+3/-0)
--------------------------------------------------------------------------------

[a4b0017bc233] 2005-04-07 21:03:21 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make enumerated constants have the type of the constant they got initialized with.

This is not how standard C works. 'enum's are normally
just integers. Tough.

Files: evaluate.c (+1/-1), parse.c (+5/-2)
--------------------------------------------------------------------------------

[822c8ef92fc6] 2005-04-07 21:03:20 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use the list sorter to sort the EXPR_INITIALIZER lists.

This should mean that the initializers are nicely sorted
in ascending order, which makes it possible to check for
duplicates and just in general is a good idea. We also need
the sorted order to emit the dang things, after all.

Files: expand.c (+32/-0)
--------------------------------------------------------------------------------

[e7ff626d8bf6] 2005-04-07 21:03:20 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add sort_list() function that kind of works like qsort, but is just different enough to be confusing.

Thank you, thank you, I'll be here all week. Please remember
to tip your waitresses.

Files: Makefile (+3/-1), lib.h (+1/-0), sort.c (+101/-0)
--------------------------------------------------------------------------------

[fc22d9ef8c95] 2005-04-07 21:03:20 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do the EXPR_POS simplification breadth first, not depth first.

Otherwise the inner levels get the wrong offsets, because they
haven't added up the depth of the outer ones yet.

Files: expand.c (+4/-4)
--------------------------------------------------------------------------------

[354b9c6abedb] 2005-04-07 21:03:19 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify EXPR_INITIALIZER that is nested inside a simple EXPR_POS.

We move the offset from EXPR_POS into each of the EXPR_INITIALIZER
entries - they should all have an EXPR_POS themselves, except for
one potential zero-offset one (which we turn into an EXPR_POS by
re-using the now unused nested EXPR_INITIALIZER).

Files: expand.c (+32/-6)
--------------------------------------------------------------------------------

[3bc2090670ba] 2005-04-07 21:03:19 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix index expression conversion to EXPR_POS.

The EXPR_INDEX "to" thing is the last entry, while EXPR_POS
wants the number of entries (to+1 - from). Off-by-one error
resulted.

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[0413d55a5877] 2005-04-07 21:03:19 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify nested EXPR_POS expressions.

They happen with the new

	struct xxx x = { .a.b[10].c = val; }

syntax.

Files: expand.c (+25/-1)
--------------------------------------------------------------------------------

[51d406d9b6be] 2005-04-07 21:03:18 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make sure EXPR_POS expressions have the right type.

[Auto-summary] Modifies evaluate.c. Changes: +2/-0 in 1 file(s)

Files: evaluate.c (+2/-0)
--------------------------------------------------------------------------------

[780e9a96de1f] 2005-04-07 21:03:18 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow 'show_position_expr()' to survive lack of type information.

Again, this allows us to continue past errors.

Files: show-parse.c (+4/-1)
--------------------------------------------------------------------------------

[f452fc19a367] 2005-04-07 21:03:18 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: For functions that lack a type, print out error rather than SIGSEGV.

Obviously we should have just exited earlier, but this allows us to
survive past errors.

Files: expand.c (+4/-0)
--------------------------------------------------------------------------------

[230cb70a242f] 2005-04-07 21:03:18 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow EXPR_POS subexpressions in initializer evaluation.

That just happens when an initializer has already been
evaluated once before, and the other positional expressions
have been convered to EXPR_POS.

Nothing more to do.

Files: evaluate.c (+7/-0)
--------------------------------------------------------------------------------

[3c83edc32120] 2005-04-07 21:03:17 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Totally re-do how we build up the initializer tree: make the positional markers be hierarchical rather than a flat list.

This makes the data structure a bit more complex, but it simplifies
some of the code, and makes it possible to evaluate complex initializers
without going insane.

In particular, we how support

	struct xxxx var = {
		.a.b[10] = 1;
	};

which we couldn't handle at all before (it had to
be written as

	struct xxxx var = {
		.a = {
			.b = { [10] = 1; }
		}
	}

or similar.

The new code changes all array indexes and structure members
to EXPR_POS expressions offset from the "outer" scope (either
start of the symbol, or an outer EXPR_POS).

Files: compile-i386.c (+1/-1), evaluate.c (+142/-77), expression.h (+6/-3), inline.c (+16/-4), parse.c (+14/-7), ... and 1 more
--------------------------------------------------------------------------------

[9fc06545c294] 2005-04-07 21:03:17 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Print out the proper filename on open failure.

Pointed out by Mitesh shah <mshah@teja.com>

Files: compile.c (+1/-1), obfuscate.c (+1/-1), test-parsing.c (+1/-1)
--------------------------------------------------------------------------------

[ed1532054c8c] 2005-04-07 21:03:17 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix handling if "-I" switch.

The "char **next" argument is confusing. It is in fact the pointer
to the _current_ argument.

Files: lib.c (+23/-7)
--------------------------------------------------------------------------------

[043e47c5825e] 2005-04-07 21:03:16 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Parse "nested" named or index initializers.

This just parses them, we don't actually handle them correctly
afterwards. One step at a time.

Files: parse.c (+11/-3)
--------------------------------------------------------------------------------

[5c7eceef35bc] 2005-04-07 21:03:16 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Make blob_alloc and blob_free functions in order to hide caddr_t issues and to get error checks.

[Auto-summary] Modifies lib.c. Changes: +16/-2 in 1 file(s)

Files: lib.c (+16/-2)
--------------------------------------------------------------------------------

[90722deb4409] 2005-04-07 21:03:16 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Teach cgcc about -Wbitwise and -Wtypesign.

[Auto-summary] Modifies: cgcc. Changes: +1/-1 in 1 file(s)

Files: cgcc (+1/-1)
--------------------------------------------------------------------------------

[b89216fe2192] 2005-04-07 21:03:15 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add "-Wtypesign" command line option.

This enables the type sign warnings. They don't seem to be
all that valid most of the time, so an explicit warning knob
seems to be called for.

Files: evaluate.c (+18/-7), lib.c (+3/-1), lib.h (+1/-0)
--------------------------------------------------------------------------------

[8be526d647aa] 2005-04-07 21:03:15 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Improve sign warnings a bit.

We always warn about clashing _explicit_ signs.

We don't warn about non-explicitly signed "char". 

The non-explicitly signed other types are still under
consideration, but for now we warn about them with a
different warning message.

Files: evaluate.c (+15/-12)
--------------------------------------------------------------------------------

[4342dcd4f26a] 2005-04-07 21:03:15 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Fix replace_by_integer.

[Auto-summary] Modifies pre-process.c. Changes: +2/-2 in 1 file(s)

Files: pre-process.c (+2/-2)
--------------------------------------------------------------------------------

[9b867048e7e0] 2005-04-07 21:03:14 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Complain about type differences in signedness.

We've got a fair number of these in the kernel, because
gcc historically hasn't checked it right, so lots of small
problems have crept in. But gcc-4 will check, and we really
should clean it up.

Make the warning string a bit more readable for the sign-only
difference case. NOTE! We're very anal about these things because
we check for _explicit_ signedness differences too. That might
be overkill, of course.

Files: evaluate.c (+6/-3)
--------------------------------------------------------------------------------

[7ed82b96bafe] 2005-04-07 21:03:14 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add "__builtin_warning()" builtin.

Print out a user-supplied sparse warning, possibly conditional.

Ie:
	__builtin_warning("This should warn");
	__builtin_warning([typeof(x)] == [int], "'x' is an integer");

Any C expression can be used for a conditional (or set of conditionals,
they all have to be true for the warning to trigger), but something is
considered "true" only for a non-zero compile-time integer constant.

Files: symbol.c (+57/-1)
--------------------------------------------------------------------------------

[b2e84b707e18] 2005-04-07 21:03:14 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Getting the type of a symbol (and checking behind SYM_NODE) is so common that we might as well make it a proper operation.

[Auto-summary] Updates header symbol.h. Changes: +4/-8 in 1 file(s)

Files: symbol.h (+4/-8)
--------------------------------------------------------------------------------

[275b874950f0] 2005-04-07 21:03:13 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] recovery from typeof on expression with bad type

A typeof on expression with bad type will result in segfault in
examine_symbol_type() when we get to SYM_TYPEOF case in switch.

void a(void)
{
        typeof(*1) a;
        a ? 1 : 0;
}

Files: symbol.c (+2/-2)
--------------------------------------------------------------------------------

[384363a35e68] 2005-04-07 21:03:13 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix conditional expression evaluation buglets

- make sure we convert the true expression in the tree,
   not just in our local copy
 - fix restricted binop checks (too much cut-and-paste)

Files: evaluate.c (+8/-7)
--------------------------------------------------------------------------------

[3894814ff6a2] 2005-04-07 21:03:13 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix shift size check and make warning more readable.

We used to trigger the size check only when shifting constant
values by a constant value. Which is obviously bogus - we should
check the shift amount even for a non-const left side.

Noticed by Eric Sesterhenn

Files: expand.c (+13/-9)
--------------------------------------------------------------------------------

[02bf020c0a5b] 2005-04-07 21:03:12 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] trivial ansi-c declear

Caught by checking sparse with itself.

Files: pre-process.c (+1/-1)
--------------------------------------------------------------------------------

[44f9f07e8346] 2005-04-07 21:03:12 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Morten made us almost -Wwrite-strings clean. Go the extra mile.

The only remaining place was the magic constant "0" "1" number
token generated by "defined(xxx)". And since we never actually
modify number tokens (which would have broken that code anyway),
let's just make that const'ness explicit.

Files: Makefile (+1/-1), pre-process.c (+6/-4), token.h (+1/-1)
--------------------------------------------------------------------------------

[6a9a969e7198] 2005-04-07 21:03:12 -0700
Author: welinder@darter.rentec.com <welinder@darter.rentec.com>
Subject: Janitorial trivialities.

[Auto-summary] Modifies 6 source files: check.c, compile-i386.c, linearize.c and 3 more. Changes: +10/-10 in 6 file(s)

Files: check.c (+1/-1), compile-i386.c (+5/-5), linearize.c (+1/-1), pre-process.c (+1/-1), show-parse.c (+1/-1), ... and 1 more
--------------------------------------------------------------------------------

[364d3159a9db] 2005-04-07 21:03:12 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up format string buglet found by the compiler.

[Auto-summary] Modifies expand.c. Changes: +1/-1 in 1 file(s)

Files: expand.c (+1/-1)
--------------------------------------------------------------------------------

[f336cf3c5e0b] 2005-04-07 21:03:11 -0700
Author: welinder@darter.rentec.com <welinder@darter.rentec.com>
Subject: Many files:   warn->warning   error->error_die   new error lib.h:   warn->warning   error->error_die   new error   Add gcc format checking to warning/error/...

[Auto-summary] Modifies 13 source files: compile-i386.c, evaluate.c, expand.c and 10 more. Updates header lib.h. Changes: +226/-200 in 14 file(s)

Files: compile-i386.c (+10/-10), evaluate.c (+49/-49), expand.c (+12/-12), expression.c (+10/-10), inline.c (+5/-5), ... and 9 more
--------------------------------------------------------------------------------

[ee1d2b7ef68e] 2005-04-07 21:03:11 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: symbol.h, symbol.c:   Add s(char|short|int|long|longlong)_ctype. show-parse.c:   Print "signed" as part of the type names when needed. parse.c:   Add separate ctypes for signed char, short, int, long, and long long.   Make ctype_integer pick the explicitly signed type as needed.

[Auto-summary] Modifies 3 source files: parse.c, show-parse.c, symbol.c. Updates header symbol.h. Changes: +67/-45 in 4 file(s)

Files: parse.c (+19/-11), show-parse.c (+5/-0), symbol.c (+38/-29), symbol.h (+5/-5)
--------------------------------------------------------------------------------

[0467f900aa39] 2005-04-07 21:03:11 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Reinstate non-ANSI warning for "int foo () { }". Warn for "int foo (...);".

[Auto-summary] Modifies parse.c. Changes: +12/-2 in 1 file(s)

Files: parse.c (+12/-2)
--------------------------------------------------------------------------------

[81e2da3300e7] 2005-04-07 21:03:10 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: More "union" trouble: don't look at ctype for non-NS_SYMBOL.

NS_PREPROCESSOR doesn't have any sym->ctype at all.

Files: symbol.c (+1/-1)
--------------------------------------------------------------------------------

[96af54198ab5] 2005-04-07 21:03:10 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Move symbol "used" flag out from SYM_NODE union.

It's also used by SYM_MACRO preprocessor symbols (the
regular "lookup_symbol()" sets it), and thus it has to
be shared, not in a private part of a union.

Files: symbol.h (+1/-1)
--------------------------------------------------------------------------------

[c0fe9d2f204b] 2005-04-07 21:03:10 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Sanitize base type declarations some more.

Make "label_type" be a real ctype, rather than an uninitialized
mess.

Files: show-parse.c (+1/-0), symbol.c (+42/-41), symbol.h (+2/-2)
--------------------------------------------------------------------------------

[df7cd6f2c0ff] 2005-04-07 21:03:09 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: We need to initialize the type of the fundamental base types.

It _used_ to be initialized to zero (SYM_BASETYPE) automatically,
but Chris added SYM_PREPROCESSOR at the beginning, without realizing
that there was a magic reason for SYM_BASETYPE being zero.

Rather than just re-instate the magic, let's just do the sane thing
instead and initialize the base types properly.

Files: symbol.c (+1/-0)
--------------------------------------------------------------------------------

[1c288bed82c9] 2005-04-07 21:03:09 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove "match_string_ident" now that nothing uses it.

It may well come back as a debugging and prototyping thing,
but I'd rather remove it and have to re-introduce it, than
have people use that stupid interface just "because it's there".

Sparse is very good at hashing identifiers and making them
all unique. So you really should never need to match by
string, you can just compare "struct ident" pointers directly.

Thanks to Chris for getting rid of the users.

Files: parse.h (+0/-1), pre-process.c (+0/-10)
--------------------------------------------------------------------------------

[ca36c90780e9] 2005-04-07 21:03:09 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] make preprocesser command a symbol

This all started with I want to remove match_string_ident in preprocessor.
I decide that I don't want to search a pointer in the list. There is faster
way which is register a symbol with a new name space which contain the
handler.

This changes:
1) changed name of NS_PRECESSOR to NS_MACRO and give it a new meaning
   for preprocessor command.  Now NS_MACRO means a macro name, and the
   new NS_PREPROCESSOR means a preprocessor command.

2) The ctype and preprocessor can put into one union.  They are on
   different name space so they _should_ never collapse.  I did that and
   made struct symbol 8 bytes smaller.  Nothing blew up for me so it
   must be correct ;)

And a question:
3) When to initialize the preprocessor command symbol. Should we make
   it part of the init_symbol or let the caller(check.c) initialize it?
   Do we want to remove the preprocessor command afterwords?

Files: pre-process.c (+17/-12), symbol.c (+4/-1), symbol.h (+32/-25), tokenize.c (+1/-1)
--------------------------------------------------------------------------------

[e54f26d605b8] 2005-04-07 21:03:08 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Poison deleted ptr-list entries.

Our current PREPARE_PTR_LIST/RESET_PTR_LIST implementation
has a bug: if we ever hit a block of pointers where every
single pointer has been deleted, it doesn't understand to
skip over it, and instead uses the first (deleted) entry.

This at least causes a nice SIGSEGV rather than random
behaviour. I'll have to think about how to do the PTR list
traversal fix nicely.

Files: lib.h (+1/-0)
--------------------------------------------------------------------------------

[b8763ba0cdd3] 2005-04-07 21:03:08 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] Use more simple/fast iterators

Here is the second step to get ride of the old list iterator using
the new infrastructure.

Files: lib.c (+5/-7), lib.h (+3/-3), linearize.c (+9/-16)
--------------------------------------------------------------------------------

[5b0dca0c51ac] 2005-04-07 21:03:08 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add DELETE_CURRENT_PTR and REPLACE_CURRENT_PTR.

[Auto-summary] Updates header lib.h. Changes: +16/-0 in 1 file(s)

Files: lib.h (+16/-0)
--------------------------------------------------------------------------------

[dd9cfb98ae58] 2005-04-07 21:03:07 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make END_FOR_EACH_PTR[_REVERSE] take the ptr name as an argument.

..and switch us entirely over to the new naming scheme.

All the nasty work of going through the users thanks to Chris Li.

Files: compile-i386.c (+15/-15), evaluate.c (+6/-6), expand.c (+4/-4), inline.c (+9/-9), lib.c (+1/-1), ... and 6 more
--------------------------------------------------------------------------------

[ff94b4aa37ed] 2005-04-07 21:03:07 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Re-organize list access macros for easier expansion.

This prepares for the next stage, which is to make sure
that we can name nested FOR_EACH_PTR() levels.

Files: lib.h (+62/-40)
--------------------------------------------------------------------------------

[0511e6b9ca5d] 2005-04-07 21:03:07 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix "compile-i386.c" incestuous list internal knowledge.

Use the existing access macro instead.

Files: compile-i386.c (+1/-1)
--------------------------------------------------------------------------------

[e3511c13dc6c] 2005-04-07 21:03:06 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use the fast/simple list iterators in cases where we don't modify the list.

Pointed out by Chris Li.

Files: linearize.c (+5/-7)
--------------------------------------------------------------------------------

[8d1dfef236cd] 2005-04-07 21:03:06 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Mark the "entry" point in a function, and update it when packing blocks.

The entrypoint doesn't necessarily end up being the first
basic block in the list of blocks after we have packed them.

Files: linearize.c (+19/-7), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[b7f9dc314cdc] 2005-04-07 21:03:06 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix silly "first_basic_block()" typo

Noticed by Chris Li.

Files: lib.h (+1/-1)
--------------------------------------------------------------------------------

[032f492af0ac] 2005-04-07 21:03:05 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] __attribute__((bitwise))

Handling of __attribute__((bitwise)) in a way that should be easy to extend
afterwards.   Example of use:

typedef __u32 __attribute__((bitwise)) __le32;

That will create a new 32bit type that will be assignment-incompatible with
anything else.  The set of allowed operations is restricted to bitwise ones,
the only allowed constant is 0 right now.  Forced casts are allowed, so is
cast from type to itself and cast to void.  Any other cast will give a warning.

Checks are triggered by -Wbitwise in command line; if it's not there,
attribute will be silently ignored.

Files: evaluate.c (+144/-18), ident-list.h (+1/-0), lib.c (+3/-1), lib.h (+1/-0), parse.c (+21/-6), ... and 2 more
--------------------------------------------------------------------------------

[48e449e62268] 2005-04-07 21:03:05 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] parser.c cleanup

* handling of bitfields taken to a helper function.
* reading and handling list of attributes taken to a helper function.
* caller became readable...

Files: parse.c (+64/-57)
--------------------------------------------------------------------------------

[e00efc8507b4] 2005-04-07 21:03:05 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] evaluate_sign() typo

The unary operation allowed for integers but not for floats is ~, not % ;-)

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[ee33e420fcfc] 2005-04-07 21:03:05 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] uninlining inline functions

When we take the address of an inline function or otherwise refusing to
inline it, we need to output the now non-inline function properly.

What we do is
	a) keeping body and symbol list of inlined function in new fields
	b) when expanding inlined call use these fields
	c) when evaluating the function itself (which happens if sparse
decides that it can't be [always] inlined) uninline the sucker.  I.e.
create ->stmt and ->symbol_list by copying the ->inline_stmt and
->inline_symbol_list same as we would do while expanding a call.

That guarantees that we won't run into trouble with inlined calls coming
afterwards - evaluation doesn't mangle ->inline_stmt anymore.

Files: evaluate.c (+15/-5), inline.c (+19/-5), parse.c (+9/-3), parse.h (+1/-0), symbol.h (+2/-0)
--------------------------------------------------------------------------------

[f703d3fbccc9] 2005-04-07 21:03:04 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] more on fixing dependency

I hit some SEGV turn out to dependency related.

Files: Makefile (+3/-0)
--------------------------------------------------------------------------------

[163c1e44db7c] 2005-04-07 21:03:04 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add dependancy information for the new ident-list.h

[Auto-summary] Modifies build system. Changes: +2/-1 in 1 file(s)

Files: Makefile (+2/-1)
--------------------------------------------------------------------------------

[5854ea8719ca] 2005-04-07 21:03:04 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] avoid matching idents with string compares

Identifiers are unique objects, so we can just compare the pointers
directly, if we just set up the identifiers first.

Identifier setup simplified as suggested by Linus.

Files: ident-list.h (+38/-0), parse.c (+40/-40), symbol.c (+6/-51), symbol.h (+3/-32)
--------------------------------------------------------------------------------

[93d2f1e1ec83] 2005-04-07 21:03:03 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Merge troll.com:/scratch/welinder/linus-sparse into troll.com:/scratch/welinder/sparse-for-linus

[Auto-summary] Modifies 2 source files: pre-process.c, symbol.c. Changes: +3/-4 in 2 file(s)

Files: pre-process.c (+1/-1), symbol.c (+2/-3)
--------------------------------------------------------------------------------

[9bb04b38e415] 2005-04-07 21:03:03 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up silly typo that caused __builtin_constant_p not to work on FP constants.

It's kind of redundant to check for integer constants twice. "Just
to make sure" doesn't cut it ;)

Noted by Morten Welinder <terra@gnome.org>

Files: symbol.c (+1/-1)
--------------------------------------------------------------------------------

[d83c2cb73289] 2005-04-07 21:03:03 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: symbol.c:   Make eval_init_table static. pre-process.c:   Fix match_string_ident.

[Auto-summary] Modifies 2 source files: pre-process.c, symbol.c. Changes: +3/-4 in 2 file(s)

Files: pre-process.c (+1/-1), symbol.c (+2/-3)
--------------------------------------------------------------------------------

[60fed9f35cb4] 2005-04-07 21:03:02 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Make sure to handle TOKEN_STREAMEND even inside a false conditional.

[Auto-summary] Modifies pre-process.c. Changes: +15/-11 in 1 file(s)

Files: pre-process.c (+15/-11)
--------------------------------------------------------------------------------

[2eaf2ea385dd] 2005-04-07 21:03:02 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Make elif_ignore also keep track of whether we have seen #else. Check for unterminated #if on a per-stream basis. Check for #else after #else or #elif. Check for unmatched #else/#elif/#endif on a per-stream basis.

[Auto-summary] Modifies pre-process.c. Changes: +42/-30 in 1 file(s)

Files: pre-process.c (+42/-30)
--------------------------------------------------------------------------------

[8385b6378b56] 2005-04-07 21:03:02 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Encountering #warning or #error at the wrong spot means that the file is not constant.  Not that it really matters, but still...

[Auto-summary] Modifies pre-process.c. Changes: +4/-0 in 1 file(s)

Files: pre-process.c (+4/-0)
--------------------------------------------------------------------------------

[2508352d281a] 2005-04-07 21:03:01 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Fix #warning for lines that end up with precisely 1024 characters.

[Auto-summary] Modifies pre-process.c. Changes: +1/-1 in 1 file(s)

Files: pre-process.c (+1/-1)
--------------------------------------------------------------------------------

[c0e3726a0f88] 2005-04-07 21:03:01 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Merge troll.com:/scratch/welinder/linus-sparse into troll.com:/scratch/welinder/sparse-for-linus

[Auto-summary] Modifies 10 source files: check.c, compile.c, lib.c and 7 more. Updates header token.h. Changes: +111/-50 in 11 file(s)

Files: check.c (+2/-2), compile.c (+1/-1), lib.c (+28/-4), obfuscate.c (+1/-1), pre-process.c (+65/-32), ... and 6 more
--------------------------------------------------------------------------------

[2e34026cba4b] 2005-04-07 21:03:01 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "-nostdinc" command line flag actually work.

Also add some infrastructure to make it easier to add new
random command line options.

Files: lib.c (+28/-4)
--------------------------------------------------------------------------------

[80b880d61d0c] 2005-04-07 21:03:00 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "next_path" be per-stream for better "include_next".

Maybe this makes us gcc-compatible. Maybe it doesn't.

Files: check.c (+2/-2), compile.c (+1/-1), obfuscate.c (+1/-1), pre-process.c (+11/-16), symbol.c (+1/-1), ... and 5 more
--------------------------------------------------------------------------------

[f2c8ee908205] 2005-04-07 21:03:00 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Implement "include_next"

It's trivial now with the re-organized include path handling.

Files: pre-process.c (+19/-7)
--------------------------------------------------------------------------------

[2aff72414a34] 2005-04-07 21:03:00 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Re-organize search path handling.

This is a cunning plan to make "include_next" work. This
is just the infrastructure. Actual include_next handling
in the next patch.

Files: pre-process.c (+49/-23)
--------------------------------------------------------------------------------

[7a32449b174c] 2005-04-07 21:02:59 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: __const in addition to const and __const__.  Sigh. From Dave Jones <davej@redhat.com>.

[Auto-summary] Modifies parse.c. Changes: +1/-0 in 1 file(s)

Files: parse.c (+1/-0)
--------------------------------------------------------------------------------

[47af53173db5] 2005-04-07 21:02:59 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Merge http://sparse-mw.bkbits.net:8080/for-linus into ppc970.osdl.org:/home/torvalds/BK/sparse

[Auto-summary] Modifies parse.c. Changes: +9/-2 in 1 file(s)

Files: parse.c (+9/-2)
--------------------------------------------------------------------------------

[9c0a8e67f730] 2005-04-07 21:02:59 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: pre-process.c:   Fix file-is-const for #define, #undef, C-code inside   the #ifndef.   Make it easy to debug file-is-const. tokenize.c:   Fix check for identical-file. token.h:   Introduce symbolic names for the stream->constant states   and comment those states.

[Auto-summary] Modifies 2 source files: pre-process.c, tokenize.c. Updates header token.h. Changes: +75/-36 in 3 file(s)

Files: pre-process.c (+53/-24), token.h (+9/-1), tokenize.c (+13/-11)
--------------------------------------------------------------------------------

[2243505b708f] 2005-04-07 21:02:59 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Improve error reporting for bad K&R function parameter declarations.

Complain about extraneous bogus declarations, and make
a better warning for missing ones.

Files: parse.c (+9/-2)
--------------------------------------------------------------------------------

[23ff06e17c29] 2005-04-07 21:02:58 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Merge troll.com:/scratch/welinder/linus-sparse into troll.com:/scratch/welinder/sparse-for-linus

[Auto-summary] Modifies parse.c. Changes: +30/-17 in 1 file(s)

Files: parse.c (+30/-17)
--------------------------------------------------------------------------------

[24945d604b9f] 2005-04-07 21:02:58 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops - when parsing a K&R function, we started at the wrong point.

My silly test file was a bit _too_ simple, and missed the
fact that the parser would have missed the first token in
the function body ;)

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[b586d0062bd2] 2005-04-07 21:02:58 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Since we allow K&R declarations, allow empty ones too.

We used to require the "void" thing, but if we parse
K&R we can no longer do that. So just silently allow
an empty parameter type list.

Files: parse.c (+3/-0)
--------------------------------------------------------------------------------

[2a07edfe82b0] 2005-04-07 21:02:57 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Merge troll.com:/scratch/welinder/linus-sparse into troll.com:/scratch/welinder/sparse-for-linus

[Auto-summary] Modifies parse.c. Changes: +44/-5 in 1 file(s)

Files: parse.c (+44/-5)
--------------------------------------------------------------------------------

[d0a93901213a] 2005-04-07 21:02:57 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Improve K&R name matching.

I didn't even realize that K&R allowed the declaration of the
types to be in a different order than the arguments themselves.

Anyway, that's easy to handle, although we should probably also
check that we don't declare some name that doesn't exist.

Files: parse.c (+11/-13)
--------------------------------------------------------------------------------

[1fe6ff68f5c3] 2005-04-07 21:02:57 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Final part of K&R functions - integer promotions

char/short types promote to "int" in K&R function declarations.

Files: parse.c (+16/-4)
--------------------------------------------------------------------------------

[88d8be35f90d] 2005-04-07 21:02:56 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Merge troll.com:/scratch/welinder/linus-sparse into troll.com:/scratch/welinder/sparse-for-linus

[Auto-summary] Modifies expand.c. Changes: +16/-15 in 1 file(s)

Files: expand.c (+16/-15)
--------------------------------------------------------------------------------

[664ce74c18e7] 2005-04-07 21:02:56 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Apply the K&R parse ctypes to the argument list.

Hey, this is still wrong. A "char" should be promoted
to "int" etc, and we don't do that. So it's kind of
half-K&R, half-ANSI.

Files: parse.c (+22/-4)
--------------------------------------------------------------------------------

[4c41772a1bad] 2005-04-07 21:02:56 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Parse K&R function declarations.

HOWEVER! We don't actually go and apply the types to the
arguments yet, so this is purely a "parse only" fix. To
actually make K&R functions work, we'd need to match up
the re-declared arguments against the argument list.

All the information is there now, though. Somebody more
interestedin K&R could fix it up.

Files: parse.c (+26/-5)
--------------------------------------------------------------------------------

[1e63c72f4a11] 2005-04-07 21:02:55 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Unnamed bitfields should not affect structure and union alignment.

[Auto-summary] Modifies symbol.c. Changes: +14/-5 in 1 file(s)

Files: symbol.c (+14/-5)
--------------------------------------------------------------------------------

[63b97425cc58] 2005-04-07 21:02:55 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Split "side effects" from "might take an exception" costs.

A "might take an exception" expression may not be re-ordered very
much wrt other expressions, but it _can_ be dropped entirely if it
is part of an expression that has no other effect.

In contrast, a real side effect obviously can't be dropped.

Files: expand.c (+16/-15)
--------------------------------------------------------------------------------

[dab9123fd20e] 2005-04-07 21:02:55 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Tests for structure namespace issues.

[Auto-summary] Adds/updates 2 test(s). Changes: +31/-0 in 2 file(s)

Files: validation/struct-ns1.c (+17/-0), validation/struct-ns2.c (+14/-0)
--------------------------------------------------------------------------------

[1b8cd968ba55] 2005-04-07 21:02:54 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: First cut at getting local structure ns handling right.

[Auto-summary] Modifies parse.c. Changes: +16/-2 in 1 file(s)

Files: parse.c (+16/-2)
--------------------------------------------------------------------------------

[e75268597ef0] 2005-04-07 21:02:54 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Merge troll.com:/scratch/welinder/linus-sparse into troll.com:/scratch/welinder/sparse-for-linus

[Auto-summary] Modifies 2 source files: evaluate.c, parse.c. Modifies build system. Changes: +3/-3 in 3 file(s)

Files: Makefile (+1/-1), evaluate.c (+1/-1), parse.c (+1/-1)
--------------------------------------------------------------------------------

[6706ece1bc9a] 2005-04-07 21:02:54 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow "extern" void declarations.

They are used by the Linux kernel for referring to assembler
symbols without a type (you can obviously only take the address
of such a symbol, not use it for anything else).

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[35df1d7008c7] 2005-04-07 21:02:54 -0700
Author: Linus Torvalds <torvalds@tove.osdl.org>
Subject: Check the right type in "alignof" evaluation.

[Auto-summary] Modifies evaluate.c. Changes: +1/-1 in 1 file(s)

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[c958e135fbb9] 2005-04-07 21:02:53 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Put enums in the same namespace as unions and structs. Check tags when naming tagged types.

This catches things like...

enum Foo { FOO };
struct Foo x;

Files: parse.c (+6/-4), symbol.h (+4/-5)
--------------------------------------------------------------------------------

[3f880e048e6a] 2005-04-07 21:02:53 -0700
Author: Linus Torvalds <torvalds@tove.osdl.org>
Subject: Don't strip the binary when installing.

When we don't have bugs all the time, we can strip it
again, but for now it just makes debugging harder.

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[cb3431cf6ba1] 2005-04-07 21:02:53 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: fix layout of zero-width bitfields.

[Auto-summary] Modifies symbol.c. Changes: +9/-6 in 1 file(s)

Files: symbol.c (+9/-6)
--------------------------------------------------------------------------------

[7fde376573db] 2005-04-07 21:02:52 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Disallow sizeof/alignof/typeof on bitfields.

[Auto-summary] Modifies 2 source files: evaluate.c, symbol.c. Updates header symbol.h. Changes: +14/-3 in 3 file(s)

Files: evaluate.c (+4/-2), symbol.c (+2/-0), symbol.h (+8/-1)
--------------------------------------------------------------------------------

[2746e07865f9] 2005-04-07 21:02:52 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make array dereference build the right evaluation tree.

When dereferencing an array, it degenerates into a pointer
to the first entry of the array. We did all that correctly
from a type standpoint, but we didn't actually do the
"addressof" operation on the tree itself.

This fixes up the tree properly.

Problem noticed by Chris Li.

Files: evaluate.c (+8/-0)
--------------------------------------------------------------------------------

[8cac32587e28] 2005-04-07 21:02:52 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add proper dependencies on compile.h

Chris Wedgwood pointed these out.

Files: Makefile (+2/-2)
--------------------------------------------------------------------------------

[6254f6ea7c56] 2005-04-07 21:02:51 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Check for illegal modifier combinations only after we have accepted them in the first place.

[Auto-summary] Modifies parse.c. Changes: +1/-1 in 1 file(s)

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[f0adea9f49de] 2005-04-07 21:02:51 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Fix assignment to bitfields.  (From Christopher Li.)

[Auto-summary] Modifies linearize.c. Changes: +3/-2 in 1 file(s)

Files: linearize.c (+3/-2)
--------------------------------------------------------------------------------

[34686eac3ebc] 2005-04-07 21:02:51 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Teach cgcc about flags that are for sparse only.

[Auto-summary] Modifies: cgcc. Changes: +31/-10 in 1 file(s)

Files: cgcc (+31/-10)
--------------------------------------------------------------------------------

[cf874564fd4c] 2005-04-07 21:02:50 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Handle __func__ correctly as a variable and not a #define. With help from Christopher Li <sparse@chrisli.org>.

[Auto-summary] Modifies 3 source files: lib.c, parse.c, symbol.c. Updates header symbol.h. Changes: +31/-2 in 4 file(s)

Files: lib.c (+0/-1), parse.c (+28/-1), symbol.c (+2/-0), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[736cbc34dda3] 2005-04-07 21:02:50 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Mondane cleanups at the level of typos.

[Auto-summary] Modifies 2 source files: parse.c, symbol.c. Updates header parse.h. Changes: +8/-8 in 3 file(s)

Files: parse.c (+4/-4), parse.h (+2/-2), symbol.c (+2/-2)
--------------------------------------------------------------------------------

[cbb4be32c7ea] 2005-04-07 21:02:50 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Introduce -Wdefault-bitfield-sign and only warn when asked for.

[Auto-summary] Modifies 2 source files: lib.c, parse.c. Updates header lib.h. Changes: +38/-1 in 3 file(s)

Files: lib.c (+35/-0), lib.h (+1/-0), parse.c (+2/-1)
--------------------------------------------------------------------------------

[0007ec484917] 2005-04-07 21:02:49 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: parse.c:   Get the right signedness (which broke when the code moved here).

[Auto-summary] Modifies parse.c. Changes: +4/-3 in 1 file(s)

Files: parse.c (+4/-3)
--------------------------------------------------------------------------------

[3f5c0e0df19b] 2005-04-07 21:02:49 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Merge troll.com:/scratch/welinder/linus-sparse into troll.com:/scratch/welinder/sparse-for-linus

[Auto-summary] Modifies 2 source files: evaluate.c, inline.c. Changes: +132/-41 in 2 file(s)

Files: evaluate.c (+120/-37), inline.c (+12/-4)
--------------------------------------------------------------------------------

[ab78cd230b72] 2005-04-07 21:02:49 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] better recovery from type errors in EXPR_COMMA

Don't bail out if left argument of , has type error - we can continue
just fine at that point.  Reduces cascades of bogus warnings and allows
to catch real ones in the right argument. 

Signed-off-by: Al Viro <viro@parcelfarce.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+1/-2)
--------------------------------------------------------------------------------

[a1287371d9d1] 2005-04-07 21:02:48 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] cast constraint checks

Unless the cast is to void, both argument and result should be
scalars.  Checks added.

Signed-off-by: Al Viro <viro@parcelfarce.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+30/-7)
--------------------------------------------------------------------------------

[4dac7a7cd9c2] 2005-04-07 21:02:48 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] <op>= handling

<op>= handling.  Basically, we rewrite
	*p += v
into
	(temp = p, *temp = *temp + v)
and similar for bitfield lvalues.

evaluate_assignment() adjusted accordingly.

Signed-off-by: Al Viro <viro@parcelfarce.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+69/-16)
--------------------------------------------------------------------------------

[c0d5017c3249] 2005-04-07 21:02:48 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] evaluate_statement() fixes

1) Eliminate double evaluate_conditional() on loop condition -
we get the same reference both in ->iterator_post_condition and
->iterator_pre_condition and evaluate_statement() didn't take that
into account.
	2) In handling of if() do not bail if evaluate_conditional()
had failed - that way we'll catch what there is to catch in ->if_true
and ->if_false (their evaluation doesn't depend on type errors in
condition) _and_ won't get noise from linearizer confused by unevaluated
statements.
	3) In <expr>; do not try to degenerate the expression if
evaluate_expression() had failed - again, less noise that way.

Signed-off-by: Al Viro <viro@parcelfarce.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+20/-10)
--------------------------------------------------------------------------------

[8d045ee61c9c] 2005-04-07 21:02:47 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: evaluate.c:   Ignore MOD_EXPLICITLY_SIGNED for type comparisons.

[Auto-summary] Modifies evaluate.c. Changes: +3/-1 in 1 file(s)

Files: evaluate.c (+3/-1)
--------------------------------------------------------------------------------

[0f5cdc423ee1] 2005-04-07 21:02:47 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] casts are not lvalues

Signed-off-by: Al Viro <viro@parcelfarce.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+0/-2)
--------------------------------------------------------------------------------

[97e2d44b4455] 2005-04-07 21:02:47 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Don't complain over sign problems with unnamed bitfields.

[Auto-summary] Modifies 2 source files: parse.c, symbol.c. Changes: +17/-14 in 2 file(s)

Files: parse.c (+17/-1), symbol.c (+0/-13)
--------------------------------------------------------------------------------

[4322eac12717] 2005-04-07 21:02:47 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] inline declaration getting clobbered by expansion

When we copy the body of inlined function, we leave more nodes shared
than we should - they might be mangled by evaluation of copy.  Fixed.

Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: inline.c (+12/-4)
--------------------------------------------------------------------------------

[b66e356864b2] 2005-04-07 21:02:46 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix nonterminated ident matching.

Found by Dave Jones and 'valgrind'.

Files: parse.c (+2/-2)
--------------------------------------------------------------------------------

[ecfd47f09315] 2005-04-07 21:02:46 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Fix merge issue with Al's stuff.

[Auto-summary] Modifies parse.c. Changes: +5/-5 in 1 file(s)

Files: parse.c (+5/-5)
--------------------------------------------------------------------------------

[807f74466b07] 2005-04-07 21:02:46 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Cset exclude: welinder@troll.com|ChangeSet|20040812190944|57264 Cset exclude: welinder@troll.com|ChangeSet|20040812190029|57250 Cset exclude: welinder@troll.com|ChangeSet|20040812184608|57271 Cset exclude: welinder@troll.com|ChangeSet|20040812175907|57697 Cset exclude: welinder@troll.com|ChangeSet|20040812160921|53242

[Auto-summary] Modifies 2 source files: expand.c, lib.c. Updates header lib.h. Changes: +7/-74 in 3 file(s)

Files: expand.c (+1/-3), lib.c (+6/-67), lib.h (+0/-4)
--------------------------------------------------------------------------------

[577c02176ceb] 2005-04-07 21:02:45 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Merge

[Auto-summary] Modifies 7 source files: evaluate.c, expand.c, inline.c and 4 more. Updates 3 headers. Changes: +139/-14 in 10 file(s)

Files: evaluate.c (+77/-11), expand.c (+3/-0), expression.h (+6/-0), inline.c (+7/-0), linearize.c (+22/-0), ... and 5 more
--------------------------------------------------------------------------------

[f8034e0d1321] 2005-04-07 21:02:45 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] teach show_special() to handle tokens introduced by evaluate_comparison()

Fix handling of replaced comparisons in expression.  We are handling
unsigned comparisons by replacing the expr->op with new special values
(SPECIAL_UNSIGNED_{LT,GT,LTE,GTE}) which works fine, but confuses the
hell out of show_special().  As the result, test-linearize simply
segfaults on any code that contains unsigned comparison. 

This patch fixes that by teaching show_special() to handle these guys
and making sure that tokenizer doesn't get confused (it uses the same
set of strings to recognize punctuators). 

Signed-off-by: Al Viro <viro@parcelfarce.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: token.h (+3/-2), tokenize.c (+1/-1)
--------------------------------------------------------------------------------

[d77cf76c6941] 2005-04-07 21:02:45 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] handling of non-lvalue compound objects

Handling of non-lvalue compound objects:

We introduce a new primitive - EXPR_SLICE.  Meaning is "that many bits
from that offset in that non-lvalue struct or union".  It is used when
we try to get a member out of a non-lvalue struct or union (subsequent .<field>
just narrow the slice).  And as far as scalar, struct and union fields count,
that's it.  The only subtle point is handling of array fields.  And there
I'm doing what C99 requires - they *do* decay to real, honest pointers,
causing a copy of object to memory if needed.  We get an anonymous object
that lives until the next sequence point; optimizer is certainly free to
get rid of it completely if it can make do with the value we'd copied there.

Note that you _are_ allowed to say
        foo().a[1] = 0;
It doesn't make sense, since the value you've assigned will be immediately
lost (and any optimizer will turn that into f()), but it is legitimate and 
it avoids a *lot* of PITA in describing semantics.

It covers only array decay - any other member of non-lvalue struct or union
is *not* an lvalue and in
	struct foo {int x; int y[2];};
	struct foo a(void);
        ...
	a().x = 0;              /* not allowed, non-lvalue */
	a().y[0] = 1;           /* allowed, but pointless */
you will get an error from the first assignment, but not from the second
one.

Signed-off-by: Al Viro <viro@parcelfarce.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+76/-10), expand.c (+3/-0), expression.h (+6/-0), inline.c (+7/-0), linearize.c (+22/-0), ... and 2 more
--------------------------------------------------------------------------------

[39b4e8860c0e] 2005-04-07 21:02:44 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: lib.c:   Muck with solaris predefines to suit solaris libc.

[Auto-summary] Modifies lib.c. Changes: +9/-1 in 1 file(s)

Files: lib.c (+9/-1)
--------------------------------------------------------------------------------

[404a8fc03803] 2005-04-07 21:02:44 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] fix double warnings in inline calls

Fix double warnings on type mismatch in inline arguments; once we'd got
a warning, cast the damn thing and be done with that. 

Signed-off-by: Al Viro <viro@parcelfarce.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[19bd5892d966] 2005-04-07 21:02:44 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] attributes on bitfields

Bitfields in structure declarations can have attributes; teach
parser to handle them.

Signed-off-by: Al Viro <viro@parcelfarce.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@osdl.org>

Files: parse.c (+5/-0)
--------------------------------------------------------------------------------

[bee26f7c2e95] 2005-04-07 21:02:43 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: lib.c:   Linux/Solaris split.  Keep it minimal for now.

[Auto-summary] Modifies lib.c. Changes: +26/-5 in 1 file(s)

Files: lib.c (+26/-5)
--------------------------------------------------------------------------------

[d8f1064cb3ec] 2005-04-07 21:02:43 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: expand.c:   Don't complain over undefined preprocessor symbols that start   with an underscore.   This helps quiet a gazillion errors with _cplusplus and others   used by solaris' system headers.   This change may or may not be approapriate on a glibc system.

[Auto-summary] Modifies expand.c. Changes: +3/-1 in 1 file(s)

Files: expand.c (+3/-1)
--------------------------------------------------------------------------------

[cbac665ddaec] 2005-04-07 21:02:43 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: check.c:   Use __SIZE_TYPE__   Define __builtin_alloca. lib.c:   Pre-define __SIZE_TYPE__

[Auto-summary] Modifies 2 source files: check.c, lib.c. Changes: +8/-2 in 2 file(s)

Files: check.c (+3/-2), lib.c (+5/-0)
--------------------------------------------------------------------------------

[6aef65c2b367] 2005-04-07 21:02:42 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: lib.c:   Add __unix__ and variants to create_builtin_stream.

[Auto-summary] Modifies lib.c. Changes: +4/-1 in 1 file(s)

Files: lib.c (+4/-1)
--------------------------------------------------------------------------------

[14cc09a4c7f7] 2005-04-07 21:02:42 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: lib.c, lib.h:   Under __sun__, implement a strtold.

[Auto-summary] Modifies lib.c. Updates header lib.h. Changes: +36/-0 in 2 file(s)

Files: lib.c (+32/-0), lib.h (+4/-0)
--------------------------------------------------------------------------------

[c873994b241a] 2005-04-07 21:02:42 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: parse.c:   Don't clear MOD_EXPLICITLY_SIGNED in indirect.\ symbol.c:   Add modifier MOD_EXPLICITLY_SIGNED to all versions of "signed".   check for integer bitfields that are just "int foo : 42". symbol.h:   Define MOD_EXPLICITLY_SIGNED.   This will be used to distinguish "int" and "signed int". show-parse.c:   Show MOD_EXPLICITLY_SIGNED as "[explicitly-signed]".

[Auto-summary] Modifies 3 source files: parse.c, show-parse.c, symbol.c. Updates header symbol.h. Changes: +12/-5 in 4 file(s)

Files: parse.c (+1/-1), show-parse.c (+1/-1), symbol.c (+9/-3), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[75ad263012f6] 2005-04-07 21:02:41 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: parse.c:   Move bitfield parsing into struct/union parsing where it belongs.   Sanity check bitfield widths.

[Auto-summary] Modifies parse.c. Changes: +27/-11 in 1 file(s)

Files: parse.c (+27/-11)
--------------------------------------------------------------------------------

[1f6e86b5454c] 2005-04-07 21:02:41 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: symbol.c:   Check for signed one-bit bitfields.

[Auto-summary] Modifies symbol.c. Changes: +10/-1 in 1 file(s)

Files: symbol.c (+10/-1)
--------------------------------------------------------------------------------

[926a23d2e74e] 2005-04-07 21:02:41 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: parse.c:   Handle __noreturn__ as noreturn (==ignore).

[Auto-summary] Modifies parse.c. Changes: +2/-1 in 1 file(s)

Files: parse.c (+2/-1)
--------------------------------------------------------------------------------

[76689626f527] 2005-04-07 21:02:41 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: parse.c:   Disallow "void" parameters and "void" variables.

[Auto-summary] Modifies parse.c. Changes: +8/-3 in 1 file(s)

Files: parse.c (+8/-3)
--------------------------------------------------------------------------------

[faf80555fca0] 2005-04-07 21:02:40 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: parse.c:   Check that "signed", "unsigned", "long", ... only occur where they may.   Notably not as "signed double" or "long struct { ... }".

[Auto-summary] Modifies parse.c. Changes: +30/-0 in 1 file(s)

Files: parse.c (+30/-0)
--------------------------------------------------------------------------------

[cf5114a103cc] 2005-04-07 21:02:40 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: pre-process.c, lib.c:   Never call isdigit/isspace on type char, use unsigned char only.

[Auto-summary] Modifies 2 source files: lib.c, pre-process.c. Changes: +2/-2 in 2 file(s)

Files: lib.c (+1/-1), pre-process.c (+1/-1)
--------------------------------------------------------------------------------

[81a6bc94e277] 2005-04-07 21:02:40 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: parse.c:   Check for multiple storage classes such as "static extern".

[Auto-summary] Modifies parse.c. Changes: +7/-1 in 1 file(s)

Files: parse.c (+7/-1)
--------------------------------------------------------------------------------

[2a9cbc29a0a8] 2005-04-07 21:02:39 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: lib.c:   Handle -MF foo, -MQ foo, and -MT foo.

[Auto-summary] Modifies lib.c. Changes: +11/-0 in 1 file(s)

Files: lib.c (+11/-0)
--------------------------------------------------------------------------------

[4acd15d1cce7] 2005-04-07 21:02:39 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: expand.c:   Handle integer overflow in unary minus.

[Auto-summary] Modifies expand.c. Changes: +11/-2 in 1 file(s)

Files: expand.c (+11/-2)
--------------------------------------------------------------------------------

[3d75606ad756] 2005-04-07 21:02:39 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: pre-process.c:   Gnome needs lots of -Ipath -- just up the limit a whole lot.

[Auto-summary] Modifies pre-process.c. Changes: +1/-1 in 1 file(s)

Files: pre-process.c (+1/-1)
--------------------------------------------------------------------------------

[bb9b7d06ff12] 2005-04-07 21:02:38 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: Wrapper to run check and gcc in series.

[Auto-summary] Modifies: cgcc. Changes: +22/-0 in 1 file(s)

Files: cgcc (+22/-0)
--------------------------------------------------------------------------------

[ba4cf7e14abe] 2005-04-07 21:02:38 -0700
Author: welinder@troll.com <welinder@troll.com>
Subject: config:   MW prefs.

[Auto-summary] No file changes detected.

--------------------------------------------------------------------------------

[38f0b639adeb] 2005-04-07 21:02:38 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add "__word__" mode attribute and fix __QI__.

Lack of __word__ noted by Dave Jones.

Files: parse.c (+7/-1)
--------------------------------------------------------------------------------

[8fae62236344] 2005-04-07 21:02:38 -0700
Author: Chris Wedgwood <cw@f00f.org>
Subject: [PATCH] sparse --- Makefile dependancy fix for check.o

check.o doesn't have LIB_H dep, trival fix below.  with this you can:

	make clean
	bk -r clean
	make -j install

and it works as expected

Files: Makefile (+1/-0)
--------------------------------------------------------------------------------

[7198299a38d1] 2005-04-07 21:02:37 -0700
Author: terra@gnome.org <terra@gnome.org>
Subject: [PATCH] Silently ignore __attribute__((visibility("hidden")))

This would be handy.  ("visibility" is a linkage directive.)

Files: parse.c (+2/-0)
--------------------------------------------------------------------------------

[f1270ebe48c3] 2005-04-07 21:02:37 -0700
Author: terra@gnome.org <terra@gnome.org>
Subject: [PATCH] "signed unsigned", "short long", "double x : 4", "int y : 1 : 2"

Don't allow nonsensical type descriptions like

       signed unsigned x;
       short long x;
       double x : 4;
       int y : 1 : 2;

Files: evaluate.c (+0/-9), parse.c (+18/-7), symbol.h (+9/-0)
--------------------------------------------------------------------------------

[de5ea8167966] 2005-04-07 21:02:36 -0700
Author: terra@gnome.org <terra@gnome.org>
Subject: [PATCH] simplify_float_binop

Another case of prematurely loading floating point values.

Files: expand.c (+5/-3)
--------------------------------------------------------------------------------

[f439331f2501] 2005-04-07 21:02:36 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] Avoid recursive inline function expansion

Ideally we should probably allocate an error code for recursive expand,
so the caller can know that the inline did not expand at all.

But the evaluate_symbol_call don't care about that so I just make it
reutrn 0.

Files: inline.c (+5/-0), symbol.h (+2/-1)
--------------------------------------------------------------------------------

[467ba842a51d] 2005-04-07 21:02:36 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up the worst regcache thinko's.

In particular:
 - we should only test (and not mark busy) the things a
   register aliases when we allocate it. This bug kept
   us from using %edx, because when we used %eax, we
   bogusly marked the 64-bit combination %eax:%edx as
   being busy, and refused to use %edx later.
 - "get_reg_value()" should take a regclass, so that we
   can allocate a new reg from a valid class.

Files: compile-i386.c (+31/-28)
--------------------------------------------------------------------------------

[70fc3dbe669d] 2005-04-07 21:02:35 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add the proper accessor functions to turn a 32-bit reg into a 16-bit one, and into the "high byte" version.

[Auto-summary] Modifies compile-i386.c. Changes: +2/-0 in 1 file(s)

Files: compile-i386.c (+2/-0)
--------------------------------------------------------------------------------

[50e1e8adb088] 2005-04-07 21:02:35 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "emit_conditional_test()" use register caches.

[Auto-summary] Modifies compile-i386.c. Changes: +5/-2 in 1 file(s)

Files: compile-i386.c (+5/-2)
--------------------------------------------------------------------------------

[50f15c801dba] 2005-04-07 21:02:35 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Improve "emit_move()" handling.

If we are loading something into a register, and another
register has that value already cached, used the cached
register value.

Files: compile-i386.c (+34/-6)
--------------------------------------------------------------------------------

[407472d12d61] 2005-04-07 21:02:34 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Mark an inline symbol accessed when taking its address.

(And ignore the ACCESSED bit when comparing types)

Files: evaluate.c (+2/-1)
--------------------------------------------------------------------------------

[b417529f2d00] 2005-04-07 21:02:34 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make binops use the new register tracking in compile-i386.c

[Auto-summary] Modifies compile-i386.c. Changes: +13/-33 in 1 file(s)

Files: compile-i386.c (+13/-33)
--------------------------------------------------------------------------------

[0cea77f15b2f] 2005-04-07 21:02:34 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do some rudimentary register content tracking.

This still does just mainly EXPR_SELECT, since that
is what I'm familiar with. It's also extremely lazy
about invalidating register content info, since any
code that hasn't been moved to the new format won't
do things properly.

Very much a work-in-progress, designed to eventually
allow us to generate some kind of half-readable code
from the SSA form.

Files: compile-i386.c (+116/-34)
--------------------------------------------------------------------------------

[2862612260c2] 2005-04-07 21:02:34 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Start infrastructure for more dynamic register allocation.

Instead of using fixed register names, we keep track of
busy registers, and allocate them as needed.

Also changed EXPR_SELECT to actually use this.

Files: compile-i386.c (+112/-14)
--------------------------------------------------------------------------------

[3027e1c365f4] 2005-04-07 21:02:33 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add "bitmap.h" for some simple bitmap ops

[Auto-summary] Updates header bitmap.h. Modifies build system. Changes: +52/-1 in 2 file(s)

Files: Makefile (+1/-1), bitmap.h (+51/-0)
--------------------------------------------------------------------------------

[90cb7bdb0e1a] 2005-04-07 21:02:33 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Let compile-i386 know about more registers.

We don't actually _use_ any of them yet, but this lists them,
and adds the information about which register conflicts with
which register (eg %al conflicts with %eax, but not with %ah)

Files: compile-i386.c (+54/-56)
--------------------------------------------------------------------------------

[9fbbb55433f8] 2005-04-07 21:02:33 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify the interface between compile.c and the actual code emitter. Don't make the code emission have to know about symbol lists etc.

Thus the code emitter can do whatever it wants to do to
the symbols as they are encountered, as part of the main loop
rather than as a separate phase afterwards. Straightforward.

Files: compile-i386.c (+4/-11), compile.c (+4/-5), compile.h (+8/-0)
--------------------------------------------------------------------------------

[f033394b4a72] 2005-04-07 21:02:32 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Create a valid linearization of EXPR_SELECT.

Since the "struct instruction" format doesn't allow for
all the data a select needs, we create two pseudo-instructions
instead, and generate a select as a combination of the two:
OP_SETCC + OP_SEL.

We should possibly do the same thing for conditional branches.

Files: linearize.c (+17/-1), linearize.h (+3/-0)
--------------------------------------------------------------------------------

[e40ca10a3cfd] 2005-04-07 21:02:32 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make compile-i386.c create pseudo-code for the logical binops.

It gets them wrong right now: we can't just use "and" and "or",
we need to convert to canonical logical form (0/1) too.

But it's documentation.

Files: compile-i386.c (+8/-0)
--------------------------------------------------------------------------------

[6a3ec70c8299] 2005-04-07 21:02:32 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Teach compile-i386.c to emit select instructions.

They are valid now that we have a EXPR_SELECT type for
safe conditionals.

Files: compile-i386.c (+31/-1)
--------------------------------------------------------------------------------

[e85cba9207cf] 2005-04-07 21:02:31 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. Must expand conditional expression before checking it for constantness.

"constantness" is probably not a word.

Files: expand.c (+3/-2)
--------------------------------------------------------------------------------

[a9a6e2542510] 2005-04-07 21:02:31 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: EXPR_SAFELOGICAL is unnecessary. It ends up being the same as EXPR_BINOP.

Make linearize.h show the right ops for the logical (as opposed to
binary) and/or EXPR_BINOP.

Files: compile-i386.c (+0/-1), evaluate.c (+0/-1), expand.c (+1/-2), expression.h (+0/-1), linearize.c (+5/-3), ... and 2 more
--------------------------------------------------------------------------------

[6c1e80b75871] 2005-04-07 21:02:31 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make expression expansion calculate the "cost" of the expression.

This is just a very high-level cost, mainly distinguishing
between "safe" and "unsafe" operations, so that we can
determine if we can turn a C conditional into a select
statement, or a logical op into one without short-ciruiting.

Files: compile-i386.c (+1/-0), evaluate.c (+1/-0), expand.c (+177/-125), expression.h (+1/-0), linearize.c (+19/-0), ... and 4 more
--------------------------------------------------------------------------------

[c3b6ccf01b43] 2005-04-07 21:02:30 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add "select" expression.

It's the same as a regular C conditional, except you could
evaluate both sides first. Right now we treat it exactly
the same as an EXPR_CONDITIONAL.

Files: compile-i386.c (+1/-0), evaluate.c (+1/-0), expand.c (+1/-0), expression.h (+2/-0), inline.c (+1/-0), ... and 2 more
--------------------------------------------------------------------------------

[8e039e099e7a] 2005-04-07 21:02:30 -0700
Author: Jeff Garzik <jgarzik@pobox.com>
Subject: [be] fix amazingly stupid conditional expression handling

By virtue of attempting to be too smart, the conditional expression
handling ("x ? foo : bar") would evaluate both 'foo' and 'bar', and
then use the cmov instruction to determine the result, avoiding a
branch in the process.

Unfortunately this only makes sense for simple things (EXPR_VALUE,
EXPR_SYMBOL) and is quite wrong for everything else.

Changed so that 'if' statements and conditional expressions use
largely the same code.

Files: compile-i386.c (+69/-61)
--------------------------------------------------------------------------------

[73d7949fc59a] 2005-04-07 21:02:30 -0700
Author: Jeff Garzik <jgarzik@pobox.com>
Subject: [be] minor fixes

* Mostly revert function call stack frame construction
  ("correctly generate push* instruction")
* Add comment regarding ABI-dictated function call argument size
* Clamp function call arg size to 32-bit minimum.  This will copy
  the correct value to the stack at the correct alignment, but
  (SECURITY/FIXME) will also copy extra bits (24 bits for an
  8-bit value, 16 bits for a 16-bit value).
* Add EXPR_FVALUE to the 'unhandled' portion of the master
  emit-expression 'switch' statement.

Files: compile-i386.c (+13/-1)
--------------------------------------------------------------------------------

[646a9bdf2be3] 2005-04-07 21:02:30 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Merge bk://kernel.bkbits.net/jgarzik/sparse.be into ppc970.osdl.org:/home/torvalds/BK/sparse

[Auto-summary] Modifies 2 source files: inline.c, linearize.c. Changes: +11/-7 in 2 file(s)

Files: inline.c (+2/-6), linearize.c (+9/-1)
--------------------------------------------------------------------------------

[1997b4c9ef9b] 2005-04-07 21:02:29 -0700
Author: Jeff Garzik <jgarzik@pobox.com>
Subject: [be] fix some of the brokenness related to non-32-bit variables

Assumptions that values are 32-bit still remain in places, but
some simple test cases involving 8-bit and 16-bit variables
seem much more sane now.

Files: compile-i386.c (+37/-23)
--------------------------------------------------------------------------------

[289b1a3f9638] 2005-04-07 21:02:29 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify the trivial direct "indirect" goto.

Goto's of the form "goto *&&label" might actually end up
happening as part of constant folding. And even if they
don't, this is the RightThing(tm) to do.

Files: linearize.c (+9/-1)
--------------------------------------------------------------------------------

[c7dd99043340] 2005-04-07 21:02:29 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Copy the whole symbol when creating a copy for inlining.

I really don't know why we didn't do this before. Not
copying all fields is a bug, but maybe there was a reason
that isn't immediately obvious. If so, maybe we'd comment
on it next time.

Files: inline.c (+2/-6)
--------------------------------------------------------------------------------

[e73f52c044b5] 2005-04-07 21:02:28 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix symbol copy on inlining.

Stupid stupid bugs. This makes inlining work a lot better.

Files: inline.c (+2/-0)
--------------------------------------------------------------------------------

[0e55e7a5f68c] 2005-04-07 21:02:28 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Teach linearizer about computed goto's.

We need to emit an OP_COMPUTEDGOTO instruction with a
full list of potential targets.

Files: lib.c (+3/-0), linearize.c (+44/-2), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[8f776eb5f893] 2005-04-07 21:02:28 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Keep track of computed target label lists per-function.

Associate them with each computed goto, and copy them properly
when inlining.

Files: expression.c (+6/-1), inline.c (+1/-0), parse.c (+16/-0), parse.h (+6/-0)
--------------------------------------------------------------------------------

[2c8642d05066] 2005-04-07 21:02:27 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Handle preprocessor "# <nr> <file>" the same as #line <nr> <file>".

This is the format gcc will output the line information in, for example.

We still don't actually _use_ the information, and perhaps never will,
but at least we'll silently ignore it rather than complain.

Files: pre-process.c (+9/-2)
--------------------------------------------------------------------------------

[c014b26fbf34] 2005-04-07 21:02:27 -0700
Author: terra@gnome.org <terra@gnome.org>
Subject: [PATCH] #line

Stuff from bison contains #line directives.  This makes sparse ignore
such lines.  This helps but doesn't exactly make sparse happy over such
.c files.

(Ignoring isn't quite right because, arguably, later error messages should
refer to the file from which the c code was generated, not from the c code
itself.)

Files: pre-process.c (+9/-0)
--------------------------------------------------------------------------------

[05de9d16bfcc] 2005-04-07 21:02:27 -0700
Author: Alexey Dobriyan <adobriyan@mail.ru>
Subject: [PATCH] Generate correct push* instruction.

Pay attention to size of function arguments when pushing them to stack.

Generate "pushb" for char, "pushw" for short, ...

[ Linus' note: this is likely "wrong". In a real x86 compiler, we'd
  expand the width of the argument to 32 bits regardless, but from
  a demonstration standpoint this is better ]

Files: compile-i386.c (+1/-2)
--------------------------------------------------------------------------------

[5d356994901a] 2005-04-07 21:02:26 -0700
Author: Alexey Dobriyan <adobriyan@mail.ru>
Subject: [PATCH] Simplify mnemonic generation for mov* instructions.

We already have a function that adds correct {b,w,l,q} suffix.

Files: compile-i386.c (+7/-23)
--------------------------------------------------------------------------------

[1f3e80df98d6] 2005-04-07 21:02:26 -0700
Author: Alexey Dobriyan <adobriyan@mail.ru>
Subject: [PATCH] Print instruction's suffix in a human-readable form.

{'b', 'w', 'l', 'q'} instead of {ascii 8, ascii 16, ' ', '@'}

Files: compile-i386.c (+1/-1)
--------------------------------------------------------------------------------

[15c729dd5fca] 2005-04-07 21:02:26 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify testing for "is it a string?" by just checking the expression type before it has been expanded in evaluation.

No need to first expand it, and then check whether it was a
string by looking at the resulting type mess.

Files: evaluate.c (+2/-2)
--------------------------------------------------------------------------------

[d3c7a17dabc7] 2005-04-07 21:02:25 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't evaluate a string initializer until _after_ we've verified that it is a string expression.

We can't evaluate initializers as expressions in general.

This also simplifies the test for string, since before
the string has been evaluated, we can just check for it
being an EXPR_STRING.

Files: evaluate.c (+2/-3)
--------------------------------------------------------------------------------

[ea2918d44184] 2005-04-07 21:02:25 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. Stupid typo fix for string type comparison.

And clean up the test for "char" type while at it.

Files: evaluate.c (+7/-5)
--------------------------------------------------------------------------------

[4cccafc05782] 2005-04-07 21:02:25 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix some more special cases in string initializers.

[Auto-summary] Modifies evaluate.c. Changes: +27/-10 in 1 file(s)

Files: evaluate.c (+27/-10)
--------------------------------------------------------------------------------

[564b555b2253] 2005-04-07 21:02:25 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow array initializers to be arrays themselves.

This allows us to do

	char a[] = { 'a', "bc" };

and C99 things like

	int i = sizeof (char[]) { "hello" };

Files: evaluate.c (+14/-2)
--------------------------------------------------------------------------------

[3cbd300235d6] 2005-04-07 21:02:24 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make sizeof understand the C99 "sizeof typed initializer" syntax.

Also fix the type return of initializer evaluation, so that we
get the right size in the right place.

Add the necessary lines to parse the thing too.

Files: evaluate.c (+14/-9), expression.c (+12/-1)
--------------------------------------------------------------------------------

[07636c9f3a02] 2005-04-07 21:02:24 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "compile" assert more readable.

Quite frankly, anybody who uses assert() should be shot. It's
a fundamentally broken thing.

Files: compile-i386.c (+1/-1)
--------------------------------------------------------------------------------

[2d12566a7cc3] 2005-04-07 21:02:24 -0700
Author: terra@gnome.org <terra@gnome.org>
Subject: [PATCH] "-o foo" and "-I foo"

sparse mishandles "-I foo" (note the space between the option and the
filename) and "-o foo" (no special handling at all) which can lead it to
open the wrong file. 

In particular, this will happen if the option is specified after the .c
file. 

Teach sparse about these options.

Files: lib.c (+17/-2)
--------------------------------------------------------------------------------

[58898e5e6e6b] 2005-04-07 21:02:23 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: With no input files, the checker would SIGSEGV.

Noted by Morten Welinder.

Files: check.c (+3/-0)
--------------------------------------------------------------------------------

[c04cf7881e0d] 2005-04-07 21:02:23 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make the lazy pointer evaluation marker explicit.

This makes things a bit more readable, and also, if the lazy
evaluation is never actually done, we still en dup with a valid
type (the lazy marker is a special, but valid, "void *" type).

Files: evaluate.c (+5/-5), symbol.c (+4/-1), symbol.h (+1/-1)
--------------------------------------------------------------------------------

[65f275594a84] 2005-04-07 21:02:23 -0700
Author: terra@gnome.org <terra@gnome.org>
Subject: [PATCH] Fix FP comparison type

The FP compare expression has a boolean result, but an obvious oversight
made us not actually mark it as such, and instead just always warn about
the types.

This fixes that, and also makes the operator type warnings a bit more
readable.

Files: evaluate.c (+19/-1)
--------------------------------------------------------------------------------

[1c8c7d7237cf] 2005-04-07 21:02:22 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: simplify_int_binop: split signed and unsigned operations and handle signed division overflow.

Noted by Morten Welinder.

Files: expand.c (+83/-15)
--------------------------------------------------------------------------------

[18a9841f175c] 2005-04-07 21:02:22 -0700
Author: terra@gnome.org <terra@gnome.org>
Subject: [PATCH] simplify_float_cmp

simplify_float_cmp loads the two values before it checks that they
really are values.  (Whereas simplify_float_preop loads after.)

Loading random bit patterns in floating point registers is known to make
Alphas rather upset.

Files: expand.c (+3/-1)
--------------------------------------------------------------------------------

[177833aa3d71] 2005-04-07 21:02:22 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify "typeof" handling.

This also makes it use more of the regular code.

Files: symbol.c (+4/-16)
--------------------------------------------------------------------------------

[0e211b6c5219] 2005-04-07 21:02:21 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] strip modifiers and address space in "typeof()"

This basically makes "typeof" just return the _storage_ type
information, not the node information on how to access it.

This not only matches gcc behaviour wrt const/volatile etc,
but also makes it a lot easier to use "typeof" with different
address spaces.

Files: symbol.c (+21/-2)
--------------------------------------------------------------------------------

[20adf96e0de9] 2005-04-07 21:02:21 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove premature tree optimization on member accesses.

When the member offset was zero, we didn't create a subnode
to calculate the member address, since we already had it: it
is the same as the structure address.

However, while that is a valid optimization from a value
standpoint, it screws up the type system, since it overwrites
the structure pointer type with the member type, and thus
loses that step in the chain. This bites us later, when we
try to figure out what the tree means.

Just remove the optimization.

Files: evaluate.c (+15/-10)
--------------------------------------------------------------------------------

[51b707a09b3e] 2005-04-07 21:02:21 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix linearization of for-loops.

We can't just linearize pre-condition/post-condition separately,
since they can be the same thing (and have internal labels that
can't just be re-used).

Files: linearize.c (+6/-8)
--------------------------------------------------------------------------------

[5dfa9880efa5] 2005-04-07 21:02:21 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Better error message about _which_ label has already been bound.

It's "continue" and "break". It appears that we don't copy
them properly somewhere when inlining functions with loops.

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[64afe0527c65] 2005-04-07 21:02:20 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Ok, enable linearization in "check" (aka sparse)

This gets us much better coverage, since this means
the kernel will run the linearization pass when we
sparse it.

Some strange "label already bound" warnings show up,
but other than that we look to be doing ok.

Files: check.c (+2/-0)
--------------------------------------------------------------------------------

[85ffec16a4da] 2005-04-07 21:02:20 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't die on unknown expressions at linearization time.

Just warn and continue. Much better test coverage this way.

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[ce3555c9e9d9] 2005-04-07 21:02:20 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Linearize EXPR_LABEL as a value, the same as other constants.

[Auto-summary] Modifies linearize.c. Changes: +1/-1 in 1 file(s)

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[3b722765efd5] 2005-04-07 21:02:19 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: The type of a label is the type of the statement it labels.

This matters for statement expressions where the last
statement in the compound statement is a label statement.

Files: evaluate.c (+1/-2)
--------------------------------------------------------------------------------

[6f85a97d293d] 2005-04-07 21:02:19 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix some linearization warning strings.

Running linearization on the kernel shows these..

Files: linearize.c (+2/-2)
--------------------------------------------------------------------------------

[f2e5ae1ec8c2] 2005-04-07 21:02:19 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: A statement expression has type "void" if the last statement didn't have a type.

This allows us to properly handle

	a ? void : ({ ... })

which we silently punted on before.

Files: evaluate.c (+2/-0)
--------------------------------------------------------------------------------

[4310086d1d9c] 2005-04-07 21:02:18 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix silly typo in new fp->integer constant conversion.

[Auto-summary] Modifies expand.c. Changes: +1/-1 in 1 file(s)

Files: expand.c (+1/-1)
--------------------------------------------------------------------------------

[82eb99ac40a6] 2005-04-07 21:02:18 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] VLA warnings sanitized.

in examine_array_type() we forgot to mark the sucker with "been there, got
nothing, don't try again" if array_size didn't expand to constant.  Fixed.

Files: symbol.c (+1/-1)
--------------------------------------------------------------------------------

[9c2ebe3f27f1] 2005-04-07 21:02:18 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] FP handling

FP handling added, everything straightforward by now.

Files: evaluate.c (+115/-23), expand.c (+159/-39), expression.c (+25/-15), expression.h (+4/-0), inline.c (+1/-0), ... and 3 more
--------------------------------------------------------------------------------

[07bc6f3abd6f] 2005-04-07 21:02:18 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] evaluate_conditional() prepared for FP

preparation for FP - we will be replacing conversions from FP to boolean
with explicit foo != 0.0 and !foo with foo == 0.0; that way a bunch of places
won't have to think of FP at all and uses of FP in boolean contexts are
rare enough to warrant that.  So we switch evaluate_conditional() to getting
a struct expression **, which will allow such rewriting.

Files: evaluate.c (+9/-9)
--------------------------------------------------------------------------------

[bdc32ab8bb14] 2005-04-07 21:02:17 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] arithmetic cleanups (preparation to FP)

a) arithmetic-handling code in evaluate.c cleaned up
b) % is _not_ allowed on floating point arguments - it's int-only.

Files: evaluate.c (+12/-18)
--------------------------------------------------------------------------------

[9ac75b297a95] 2005-04-07 21:02:17 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] boolean in constant expressions done right

x && y is x ? (y != 0) : 0, not x ? y : 0.  simplify_logical() ended up
with e.g. 2 && 2 being simplified to 2, which is not a good idea.

Files: expand.c (+1/-1)
--------------------------------------------------------------------------------

[5b1132531e90] 2005-04-07 21:02:17 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] comparison operations fix

simplify_int_binop() was completely broken for comparisons - there the
signedness of (converted) arguments can not be obtained from type of
result.  IOW, we had all comparisons in constant expressions done as
signed ones.
	Fixed by introducing new primitives for unsigned versions of
comparions (SPECIAL_UNSIGNED_LT, etc.) and remapping in evaluate_compare()
once we know the types.  That also fixes similar mess in compile-i386 and
linearize.

Files: compile-i386.c (+12/-17), evaluate.c (+15/-0), expand.c (+31/-7), linearize.c (+8/-0), linearize.h (+5/-1), ... and 1 more
--------------------------------------------------------------------------------

[5023b2c4d6c1] 2005-04-07 21:02:16 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] unary type fix

unary +, - and ~ should do integer promotion.

Files: evaluate.c (+22/-1)
--------------------------------------------------------------------------------

[86a911cd6355] 2005-04-07 21:02:16 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] shift type fix

shifts do not do usual arithmetic conversions; they do integer promotion
on both arguments, but that's it.

Files: evaluate.c (+26/-1)
--------------------------------------------------------------------------------

[890cec88e59d] 2005-04-07 21:02:16 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] bigger_int_type() fix

bigger_int_type() did the wrong thing if it got T1 and unsigned T2 with
sizeof(T1) == sizeof(T2) and rank(T1) > rank(T2).  It used to give
unsigned T1 instead of correct unsigned T2.  Fixed.

Files: evaluate.c (+22/-8)
--------------------------------------------------------------------------------

[c1eacc13077d] 2005-04-07 21:02:15 -0700
Author: Alexander Viro <viro@www.linux.org.uk>
Subject: [PATCH] integer promotion fixes

a) integer promotion logics taken into a separate function
b) unsigned full-sized bitfields are converted to unsigned, not int

Files: evaluate.c (+27/-24)
--------------------------------------------------------------------------------

[c8dea6fdd862] 2005-04-07 21:02:15 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make #include handling do the right thing for absolute paths.

We used to try to use the search path for them, which just
doesn't work (it happened to work just by mistake in the common
case of an empty path base component, but not in general).

Files: pre-process.c (+8/-0)
--------------------------------------------------------------------------------

[993e5fedef0b] 2005-04-07 21:02:15 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Handle tokenized include-filename with angle brackets.

[Auto-summary] Modifies pre-process.c. Changes: +4/-0 in 1 file(s)

Files: pre-process.c (+4/-0)
--------------------------------------------------------------------------------

[32a28759a8b4] 2005-04-07 21:02:14 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Move the check for assignment to "const" to the evaluation phase.

Also remember to do it for the increment and decrement operations.

Files: evaluate.c (+10/-4), expand.c (+0/-6)
--------------------------------------------------------------------------------

[0bef08867e59] 2005-04-07 21:02:14 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Warn about assignments to 'const' types.

[Auto-summary] Modifies expand.c. Changes: +6/-0 in 1 file(s)

Files: expand.c (+6/-0)
--------------------------------------------------------------------------------

[2f07fcbc2b06] 2005-04-07 21:02:14 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Warn about missing ';' at end of declaration.

[Auto-summary] Modifies parse.c. Changes: +3/-1 in 1 file(s)

Files: parse.c (+3/-1)
--------------------------------------------------------------------------------

[7601387b02d9] 2005-04-07 21:02:14 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: C99 says strings should be up to 4095 bytes.

Also, while we're here, be more careful about the
exact limits, and concatenation: we want to have
the ending NUL character even when we concatenate
too much.

Files: expression.c (+6/-5), token.h (+1/-1), tokenize.c (+1/-1)
--------------------------------------------------------------------------------

[4e7324ae9b18] 2005-04-07 21:02:13 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't allow string concatenation to overflow MAX_STRING.

[Auto-summary] Modifies 2 source files: expression.c, tokenize.c. Updates header token.h. Changes: +11/-2 in 3 file(s)

Files: expression.c (+9/-0), token.h (+2/-0), tokenize.c (+0/-2)
--------------------------------------------------------------------------------

[866a7884ea2e] 2005-04-07 21:02:13 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] misc small updates

Add a few more predefined symbols, and handle "[argname]" syntax for
named inline assembler arguments.

Files: check.c (+9/-0), parse.c (+4/-0)
--------------------------------------------------------------------------------

[327997cc3031] 2005-04-07 21:02:13 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] speed up (and fix corner case in) tokenizer

This makes our own specialized version of "ctype.h"-like character
classes, which has the extra magic classes we need to look up things
like "can this character be the second character of a special token".

Also fix a corner case in ## handling (## shouldn't glue / with / or /
with *).

Files: token.h (+1/-3), tokenize.c (+66/-44)
--------------------------------------------------------------------------------

[a33b9a16e804] 2005-04-07 21:02:12 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up "alignof" handling.

Stephen Hemminger got the basic parsing right, but understanding
the sparse type system takes some work, so this should finish the
thing up.

Files: evaluate.c (+6/-12)
--------------------------------------------------------------------------------

[a1ec3c79c0f6] 2005-04-07 21:02:12 -0700
Author: Stephen Hemminger <shemminger@osdl.org>
Subject: [PATCH] teach sparse about __alignof__

This teaches sparse what __alignof__ really means, instead of just using
the same code as "__sizeof__"

It gets rid of the warnings in ebtables that does:
	struct ebt_entries {
...
	char data[0] __attribute__ ((aligned (__alignof__(struct ebt_replace)));
	};
Which caused warning because sparse was evaluating __alignof__ as the same as sizeof,
and sizeof was 57 (ie non-power of 2).

This is just based on the existing code and a peek at the data
structures in expression and symbol.

Files: compile-i386.c (+1/-0), evaluate.c (+24/-0), expand.c (+1/-0), expression.c (+22/-11), expression.h (+1/-0), ... and 2 more
--------------------------------------------------------------------------------

[8c09d0e48d3a] 2005-04-07 21:02:12 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: The base type of an enum is "int".

[Auto-summary] Modifies parse.c. Changes: +1/-0 in 1 file(s)

Files: parse.c (+1/-0)
--------------------------------------------------------------------------------

[f5d172803293] 2005-04-07 21:02:11 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: The value of a token that gets defined on the command line defaults to the string "1", not the empty string.

[Auto-summary] Modifies lib.c. Changes: +1/-1 in 1 file(s)

Files: lib.c (+1/-1)
--------------------------------------------------------------------------------

[b124babbaf00] 2005-04-07 21:02:11 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make sparse accept strings up to 2kB in length.

[Auto-summary] Modifies tokenize.c. Changes: +9/-7 in 1 file(s)

Files: tokenize.c (+9/-7)
--------------------------------------------------------------------------------

[ea0f073ef8f5] 2005-04-07 21:02:11 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Special evaluation rules for function argument types: arrays and function types in arguments silently degenerate into pointers. Get this right both for regular functions and for inline function expansion.

[Auto-summary] Modifies evaluate.c. Changes: +36/-6 in 1 file(s)

Files: evaluate.c (+36/-6)
--------------------------------------------------------------------------------

[d1c5d455a114] 2005-04-07 21:02:11 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Check for duplicate symbol info after having evaluated the symbol - since symbol evaluation may end up changing some of the information we will be comparing.

[Auto-summary] Modifies check.c. Changes: +1/-1 in 1 file(s)

Files: check.c (+1/-1)
--------------------------------------------------------------------------------

[65cd063b8aec] 2005-04-07 21:02:10 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Handle EXPR_INDEX when copying expressions.

Easy enough to do, since these things don't change: just
return the original one.

Files: inline.c (+2/-0)
--------------------------------------------------------------------------------

[dc4240e8b621] 2005-04-07 21:02:10 -0700
Author: Chris Wedgwood <cw@f00f.org>
Subject: [PATCH] small sparse additions

Three small hunks:
 - new builtin used on ia64 (__builtin_ffs())
 - new attribute on ia64 (syscall_linkage)
 - drop the -C from the install line, most people have a recent install
   which dosn't have this...

Files: Makefile (+1/-1), check.c (+1/-0), parse.c (+2/-0)
--------------------------------------------------------------------------------

[da6d44fd6192] 2005-04-07 21:02:10 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] Update get_number_value()

This updates the type semantics of "get_number_value()" to C99 semantics
rather than the previous gcc/C90 type expansion semantics.

Now regular decimal integers (without suffixes) that are too big to fit
in "long" expand to "long long" rather than "unsigned long".

It also uses "strtoull()" rather than open-coding the conversion.

Files: expression.c (+94/-80)
--------------------------------------------------------------------------------

[2d0659ec1e30] 2005-04-07 21:02:09 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix integer/pointer errors in sparse.

Shown by running sparse on itself.

Files: compile-i386.c (+9/-9), evaluate.c (+4/-4)
--------------------------------------------------------------------------------

[86e0d88b0f44] 2005-04-07 21:02:09 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Warn about plain integer conversion to NULL pointer.

It tends to be a sign of type confusion. Yes, it's valid
C. And yes, some misguided people think it's the only true
C. But they are wrong.

NULL is "((void *)0)", and dammit, we should get a warning
if we use an integer as a pointer, or NULL as an integer.

Files: evaluate.c (+5/-2)
--------------------------------------------------------------------------------

[9bdf2dddb300] 2005-04-07 21:02:09 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use 'is_null_ptr()' helper instead of open-coding the check in various places.

[Auto-summary] Modifies evaluate.c. Changes: +9/-9 in 1 file(s)

Files: evaluate.c (+9/-9)
--------------------------------------------------------------------------------

[29ec7fb14dfd] 2005-04-07 21:02:08 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: If int/long are the same size, an int that overflows into unsigned stays as an (unsigned) int. Otherwise it becomes a long.

[Auto-summary] Modifies expression.c. Changes: +2/-3 in 1 file(s)

Files: expression.c (+2/-3)
--------------------------------------------------------------------------------

[cf87096e8b6f] 2005-04-07 21:02:08 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow scalar initializers - they act largely like arrays of size 1.

[Auto-summary] Modifies evaluate.c. Changes: +11/-3 in 1 file(s)

Files: evaluate.c (+11/-3)
--------------------------------------------------------------------------------

[b51e0b88410c] 2005-04-07 21:02:08 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow void returns in void functions.

It seems to be accepted C++/C99, and makes a certain amount
of sense. After all, the expression type matches the function
type.

Files: evaluate.c (+4/-6)
--------------------------------------------------------------------------------

[69c6e2d638d9] 2005-04-07 21:02:07 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Macroize lr_binop_expression() helper function.

This function was the top performance offender in sparse.

We really want it inlined, since all it really does is
to do an indirect call or two, and if inlined that call
turns into a direct call.

Making it a macro allows us to pass in the operation
comparison as code rather than as a list of integers,
which again allows the compiler to do a much better
job.

Files: expression.c (+85/-49)
--------------------------------------------------------------------------------

[51a66e1ca810] 2005-04-07 21:02:07 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] trivial optimization for tokenizer

We have no reason to try any combinations unless the second character is
a punctuation one; that kills a fairly expensive (and fruitless) search
for most of special tokens - they tend to be
	a) one-character
	b) followed by a space, letter or digit.

That optimization alone gives about 8% speed-up - not too lousy for what
essentially is a one-liner.

Files: tokenize.c (+12/-10)
--------------------------------------------------------------------------------

[669244d22464] 2005-04-07 21:02:07 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] lazy-copy macro expansion in pre-processing

This is almost a total rewrite of the macro expansion.  It now does
lazy-copy or the arguments, with the realization that if an argument
only shows up once in the macro expansion (quite common), we don't need
to allocate a new copy of the argument token stream, we can just insert
it as-is.

I hope it's reasonably clean and readable; review would be obviously welcome.

Files: pre-process.c (+574/-374), token.h (+17/-0), validation/preprocessor12.c (+7/-0), validation/preprocessor13.c (+7/-0), validation/preprocessor14.c (+7/-0), ... and 1 more
--------------------------------------------------------------------------------

[87ce1691126e] 2005-04-07 21:02:07 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] line-splicing fixes in sparse

Ugh.  Line-splicing was badly b0rken and overcomplicated to boot.

Moved to nextchar(), nextchar() split into fast inlined version and full
(non-inline) one it falls back on.

See comments in the testcases below

Files: tokenize.c (+93/-21), validation/phase2/backslash (+62/-0)
--------------------------------------------------------------------------------

[758eba2b81cc] 2005-04-07 21:02:06 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] comments handling fix in sparse

If we get a newline in the middle of a comment, stream->pos.newline
is set and remains set.  In effect, newlines in the middle of multiline
comments drift to its end.  This is wrong - e.g.

	#define A /* foo
	*/ B

is 100% legitimate - since every comment is treated as if replaced with
single space, the above is equivalent to

	#define A B

Current code treats it as

	#define A
	B

which is bogus.  Fix is trivial - we simply should restore ->newline we had
at the beginning of comment once we finish skipping it.

BTW, I'm starting to put new testcases into subdirectories - by translation
phase (multibyte character mapping == phase 1, line-splicing == phase 2,
tokenizer == phase 3, macro-expansion == phase 4, remapping from source
charset to execution charset == phase 5, merging adjacent string constants
== phase 6, conversion of tokens from preprocessor to compiler ones and
translation proper == phase 7, linking == phase 8).  We obviously don't
have many of those (no multibyte handling, source and execution charsets
are identical and having no backend we obviously do not link anything),
but it's easier to keep track of what's what in the tests that way.  We
already have way too many preprocessor<n>.c in there and going for saner
names will only create confusion between preprocessor and parser tests.

I'm not moving existing testcases - that's just for new ones...

Files: tokenize.c (+6/-1), validation/phase3/comments (+9/-0)
--------------------------------------------------------------------------------

[dbcef7760a47] 2005-04-07 21:02:06 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Warn about unhandled expression and statement types in inlining.

Add a few cases for expressions, that showed the things we didn't
handle right.

Files: inline.c (+28/-5)
--------------------------------------------------------------------------------

[8793aa636355] 2005-04-07 21:02:06 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] saner handling of argument lists

This does two things:
	a) get C99 varargs to use the same mechanism as gcc ones use - all
we need is to internally convert final ... in the list to ident[__VA_ARGS__]
and set its ->next to &variable_argument.  After that we don't need any
special-casing for them.
	b) take parsing the argument list in a separate function and does
it with all sanity checks; normally it ends up with fewer tests than old
variant.

Files: pre-process.c (+83/-25), validation/preprocessor11.c (+10/-0)
--------------------------------------------------------------------------------

[7e18e251c72d] 2005-04-07 21:02:05 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] sparse cleanups of handle_define()

On top of previous patch, takes handling of macros body into a separate
function and cleans it up.  No changes of behaviour (same tests).

Files: pre-process.c (+66/-61)
--------------------------------------------------------------------------------

[2821582af8b4] 2005-04-07 21:02:05 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] more sparse fixes (body parsing, beginning of ## handling)

> 	1) no ## in the beginning or end of body. [6.10.3.3(1)]
> It's a warning, recovery consists in dropping them at #define time.

Fixed in the patch I'm testing, and I was wrong about proper recovery -
better ignore the entire definition than go on with mangled one.

> 	2) ## that comes from argument does *not* have a special meaning;
> only one from the body does. [6.10.3.3(3)]

Fixed.

> 	3) assuming left-to-right order of evaluation for ## (we are free
> to choose any [6.10.3.3(3)] and left-to-right is much easier when we get
> to merging tokens), if ## immediately follows another ## it can be treated
> as not having a special meaning (it will be merged with whatever precedes
> the first one and even if result of merge will be "##", it won't have a
> special meaning).  IOW, in
> 	a ## b ## ## c ## ## ## d
> the 1st, 2nd, 4th and 6th ## will concatenate; 3rd and 5th ones will be
> merge arguments and won't merge anything themselves.

Fixed.  The rest is not - it will be a separate patch.  BTW, there's another
couple of bugs - see preprocessor9.c and preprocessor10.c for the stuff that
triggers them.

Parsing of macro bodies should be OK by now; the only missing check is
"the only place where __VA_ARGS__ can occur is in the body of macro with
argument list ending on ellipsis" and that will be dealt with later.

We get three new kinds of tokens - TOKEN_QUOTED_ARGUMENT (unexpanded arguments
next to ##), TOKEN_STR_ARGUMENT (#<argument>) and TOKEN_CONCAT (concatenation
operator).  When we go through the body of macro at #define time, we
	a) decide which ## will be operators there (see (3) above) and set
the type of those to TOKEN_CONCAT; retokenize() is looking for that
token_type() now instead of doing match_op().
	b) collapse OP[#] IDENT[argument] to a single token -
STR_ARGUMENT[argnum].  expand_arguments() looks for that token type instead
of messing with match_op() + check that the next one is an argument.
	c) mark the rest of arguments either as QUOTED_ARGUMENT or
MACRO_ARGUMENT, depending on whether they have a concatenation as neighbor
or not; expand_arguments() looks for that to decide if expand_one_arg()
should do expansion when subsitituting (instead of messing with checking
neighbors).

	All that stuff is done in one pass and comes pretty much for free -
see handle_define() for details.  And we get a nice payoff at expansion
time for that (will get more when we get to collecting the information on
arguments uses).

preprocessor{8,9,10}.c added; the first one shows the stuff fixed by
now; other two are still not handled correctly.

I don't see any regression - neither on validation/* stuff nor on full
kernel build.

Files: pre-process.c (+80/-54), token.h (+3/-0), validation/preprocessor10.c (+13/-0), validation/preprocessor8.c (+16/-0), validation/preprocessor9.c (+10/-0)
--------------------------------------------------------------------------------

[76bcdc63f8e4] 2005-04-07 21:02:05 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make sure we don't silently accept an empty expression following unary expressions.

[Auto-summary] Modifies expression.c. Changes: +12/-2 in 1 file(s)

Files: expression.c (+12/-2)
--------------------------------------------------------------------------------

[5a7c76825c8b] 2005-04-07 21:02:04 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Shrink "struct token" by moving "noexpand" into the position flags.

This makes it take one bit (which we can just steal from the line
number), instead of four bytes.

Files: lib.h (+2/-1), pre-process.c (+4/-4), token.h (+0/-1), tokenize.c (+1/-0)
--------------------------------------------------------------------------------

[d3217ff05115] 2005-04-07 21:02:04 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. Al forgot to handle the new TOKEN_UNTAINT in token comparison.

[Auto-summary] Modifies pre-process.c. Changes: +1/-0 in 1 file(s)

Files: pre-process.c (+1/-0)
--------------------------------------------------------------------------------

[a38e6db49e94] 2005-04-07 21:02:04 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] Fix preprocessor expansion anti-recursion properly

We taint identifiers when we are done with argument expansion; we
untaint them when scan gets through the "untaint" token we leave right
after the body of macro; we mark tokens noexpand in three situations:
	1) when we copy a token marked noexpand;
	2) when we get to expanding a token and see that its identifier is
currently tainted;
	3) when we scan for closing ) and see an identifier token with
currently tainted identifier.

That makes sure that by the time we get past the expanded body (and
untaint the left-hand side of macro), all tokens bearing that identifier
will be seen and marked noexpand.

There is more elegant variant (it's practically straight from text of
standard - set noexpand only in dup_token() and make it
	if (token_type(token) == TOKEN_IDENT)
		alloc->noexpand = token->noexpand | token->ident->tainted;
which is as close as to transliteration of 6.10.3.4(2) as it gets), but
before we can go for it, we need to sort out another problem - order of
expansion/copying for arguments.

So for now here's an equivalent heavier variant with a wart ((3) above)
that works even with current expand_arguments() and when that gets sorted
out we'll be able to get anti-recursion logics absolutely straightforward.

And yes, it does preprocessor1.c correctly; it even get much subtler
preprocessor7.c right.

Files: pre-process.c (+95/-68), token.h (+3/-1), tokenize.c (+1/-0), validation/preprocessor7.c (+5/-0)
--------------------------------------------------------------------------------

[65c3d3670f13] 2005-04-07 21:02:04 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Ok, this handles all token types in token comparison, so the preprocessor "redefine" check should now be exact.

Call me anal.

Files: pre-process.c (+23/-10)
--------------------------------------------------------------------------------

[ddd390ac9dbc] 2005-04-07 21:02:03 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be a bit better about comparing token lists.

[Auto-summary] Modifies pre-process.c. Changes: +29/-1 in 1 file(s)

Files: pre-process.c (+29/-1)
--------------------------------------------------------------------------------

[22f2df9c75df] 2005-04-07 21:02:03 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use the proper wrapper to access token types.

That's what everybody else does too.

Files: pre-process.c (+1/-1)
--------------------------------------------------------------------------------

[87c310de375e] 2005-04-07 21:02:03 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix equality testing for macro re-definition.

We just move the arglist re-write up to before
the equality test, so that we have rewritten
the expansion in both the new and the old version.

Otherwise we'd get spurious differences due to
the rewriting and thus incorrect warnings.

Files: pre-process.c (+13/-13)
--------------------------------------------------------------------------------

[625b39274679] 2005-04-07 21:02:02 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] cleanup of macro arguments handling

Trivial observation: we don't have to check every bloody identifier in
the body of macro and see if it's a formal argument _every_ _time_ _we_
_do_ _substitution_. 

New token type: TOKEN_MACRO_ARGUMENT, with token->argnum as its data.
Occurs only in bodies of macros with arguments. 

handle_define() goes through the body, checks which identifier tokens
are arguments (using the same arg_number() we used to do on every
expansion) and turns those into TOKEN_MACRO_ARGUMENT ones.

expand_arguments() simply checks for TOKEN_MACRO_ARGUMENT.

expand_one_argument() doesn't need arglist argument anymore - it gets
argument number from token->argnum.

Files: pre-process.c (+19/-7), token.h (+2/-0)
--------------------------------------------------------------------------------

[1e2ba6fecb82] 2005-04-07 21:02:02 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Introduce a "incomplete type" rather than leaving the base type as NULL when no type is specified.

Traditional C makes the incomplete type be "int".

Files: parse.c (+12/-2), show-parse.c (+1/-0), symbol.c (+2/-2), symbol.h (+2/-1)
--------------------------------------------------------------------------------

[2d820a057bbe] 2005-04-07 21:02:02 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Avoid crashing on bad type information in type_difference().

Just inform the caller.

Files: evaluate.c (+4/-0)
--------------------------------------------------------------------------------

[bce9c9d793a7] 2005-04-07 21:02:01 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow underscores in integer constants for readability.

Thus 0x1234_5678 is a valid constant, as is 100_000_ul.

The parser doesn't care where they are.

Files: expression.c (+8/-2)
--------------------------------------------------------------------------------

[fee71ab2c463] 2005-04-07 21:02:01 -0700
Author: David S. Miller <davem@redhat.com>
Subject: [PATCH] More mode attribute recognition

The non-underscore mode attribute strings should be understood
as well, this is actually used by some of the math emulation
library headers.

Files: parse.c (+8/-4)
--------------------------------------------------------------------------------

[5952f60c0453] 2005-04-07 21:02:01 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Now that we do the proper (simplified) C99 number token handling, we can simplify ## too. The previous code was only needed because the tokenizer split things up too much.

[Auto-summary] Modifies pre-process.c. Changes: +1/-7 in 1 file(s)

Files: pre-process.c (+1/-7)
--------------------------------------------------------------------------------

[1694b992f183] 2005-04-07 21:02:01 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove TOKEN_FP vs TOKEN_INTEGER distinction, and make numbers be just TOKEN_NUMBER.

This matches how tokenization is supposed to be done, and simplifies
the code.

Expression evaluation changed to cope with the new rules.

Files: expression.c (+30/-24), pre-process.c (+10/-30), token.h (+2/-4), tokenize.c (+42/-105)
--------------------------------------------------------------------------------

[930f205a62cd] 2005-04-07 21:02:00 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Start fixing pp-number tokenization.

Al points out that C99 says that a pp-number token is

        pp-number:
                digit
                . digit
                pp-number digit
                pp-number identifier-nodigit
                pp-number e sign
                pp-number E sign
                pp-number p sign
                pp-number P sign
                pp-number .

This handles the (ambiguous) case of it starting with a '.'.

We'll do the rest next.

Files: tokenize.c (+7/-4)
--------------------------------------------------------------------------------

[8d180a68d6c6] 2005-04-07 21:02:00 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: This should largely fix token pasting.

It's not perfect now either, but it makes a hell of a lot more
sense now, and gets all the kernel cases I've tested right. Which
is actually saying quite a lot, since the kernel uses things that
are arguably not standard (the token fragments it pastes are not
valid tokens on their own, and I think that may be borderline in
ANSI - who knows).

It still doesn't do the _really_ strange cases, ie trying to
paste 

	a ## 0.e10

and expecting that to become "a0" "." "e10" is just not going
to happen. I think that's undefined behaviour anyway.

Files: pre-process.c (+70/-49)
--------------------------------------------------------------------------------

[a34e893c4eaa] 2005-04-07 21:02:00 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make the token pasting validation thing actually valid

[Auto-summary] Adds/updates 1 test(s). Changes: +2/-0 in 1 file(s)

Files: validation/preprocessor6.c (+2/-0)
--------------------------------------------------------------------------------

[861db9bf07c3] 2005-04-07 21:01:59 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use "-O" to compile sparse, to make the compiler warn more.

Fix a few "might be uninitialized" warnings (some might even
be valid).

Files: Makefile (+1/-1), lib.c (+1/-1), linearize.c (+5/-4), symbol.c (+3/-2)
--------------------------------------------------------------------------------

[49597a9a3328] 2005-04-07 21:01:59 -0700
Author: David S. Miller <davem@redhat.com>
Subject: [PATCH] Add __builtin_trap()

We use this thing on Sparc.  Make sparse understand it.

Files: check.c (+1/-0)
--------------------------------------------------------------------------------

[a1a3078a1308] 2005-04-07 21:01:59 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make sure data allocations are properly aligned.

This screwed up sparse on sparc64.

Files: lib.c (+1/-2)
--------------------------------------------------------------------------------

[2b1d47469a17] 2005-04-07 21:01:59 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove __i386__ define, since people (including me) are using it on lots of non-x86 code.

[Auto-summary] Modifies lib.c. Changes: +0/-1 in 1 file(s)

Files: lib.c (+0/-1)
--------------------------------------------------------------------------------

[fbaeab90cb7f] 2005-04-07 21:01:58 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do a better job of tracking array node attributes

[Auto-summary] Modifies evaluate.c. Changes: +21/-8 in 1 file(s)

Files: evaluate.c (+21/-8)
--------------------------------------------------------------------------------

[7816e4c4a2db] 2005-04-07 21:01:58 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow casting of user pointers to "unsigned long".

It's reasonably common to do special pointer arithmetic
in unsigned long, and making people force the cast just
adds noise.

Files: evaluate.c (+10/-1)
--------------------------------------------------------------------------------

[d04fb8f51c76] 2005-04-07 21:01:58 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Warn about casts that remove address space information.

You can always cast to "void" (it's ok to throw away the
address space if you throw away everything else too ;),
and you can force the cast with the "force" attribute.

Files: evaluate.c (+34/-0)
--------------------------------------------------------------------------------

[56b381e32d58] 2005-04-07 21:01:57 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add "force" type attribute.

This will allow us to force certain type casts that would
be otherwise illegal (changing address space, for one).

Files: evaluate.c (+1/-1), parse.c (+4/-0), show-parse.c (+3/-1), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[e473804b0ada] 2005-04-07 21:01:57 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't get confused about "void *" nodes.

We'd incorrectly test the right type of a compatible
pointer expression for "void *" without dropping off
the node information.

This allows us to fix a casting bug, where we used
to drop the node information at the cast.

Files: evaluate.c (+3/-3), expression.c (+1/-1)
--------------------------------------------------------------------------------

[8bd91e0cbba1] 2005-04-07 21:01:57 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: The "original definition" part of the redefined warning is an informational part of a previous warning, don't count it as a separate warning.

[Auto-summary] Modifies pre-process.c. Changes: +1/-1 in 1 file(s)

Files: pre-process.c (+1/-1)
--------------------------------------------------------------------------------

[71adee9f012c] 2005-04-07 21:01:56 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove empty definition of "cond_syscall()".

We did this in the first place just because sparse wasn't
originally able to parse standalone inline assembly. But
that sparse deficiency has since been fixed, so now the
empty define just results in doubly-defined warnings instead.

Files: lib.c (+0/-1)
--------------------------------------------------------------------------------

[be27233b3110] 2005-04-07 21:01:56 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use new "info()" function for the type warning information.

This (and the previous one) suggested by Sam Ravnborg <sam@ravnborg.org>

Files: evaluate.c (+2/-2)
--------------------------------------------------------------------------------

[8fa23ccfe298] 2005-04-07 21:01:56 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add "info()" for informational messages, to go together with a warning.

Change the order of the printout to match how gcc prints out
warnings.

Files: lib.c (+12/-4), lib.h (+1/-0)
--------------------------------------------------------------------------------

[4a2d1dab0056] 2005-04-07 21:01:55 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make sparse sources themselves be sparse-clean.

This actually showed a bug ("assignment in conditional")
in evaluate.c.

Files: compile-i386.c (+3/-1), evaluate.c (+1/-1), lib.c (+1/-1), linearize.c (+7/-7)
--------------------------------------------------------------------------------

[5b2bdde02ffa] 2005-04-07 21:01:55 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove bogus overly permissive type-comparisons.

We used to do bad things about pointers to arrays, and
as a result sparse had a bogus "pointers to arrays
degenerate to pointers to the array entry" special case
in the type equality checking.

However, it's not true that a pointer to an array is
type-equivalent with the pointer to an entry. Now that
we do degenerate arrays correctly, we should remove the
bogus special case.

Files: evaluate.c (+0/-5)
--------------------------------------------------------------------------------

[bd79e5018c56] 2005-04-07 21:01:55 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When dereferencing an array, we need to pick up the attributes of the original array node too. This is _not_ true of a pointer.

Example: a dereferencing a volatile array gets a
volatile member. But dereferencing a volatile pointer
does not result in a volatile type.

Files: evaluate.c (+7/-3)
--------------------------------------------------------------------------------

[c05ce7231424] 2005-04-07 21:01:55 -0700
Author: Jeff Garzik <jgarzik@pobox.com>
Subject: [PATCH] mention list and bk repo in the FAQ

[Auto-summary] Updates documentation. Changes: +9/-0 in 1 file(s)

Files: FAQ (+9/-0)
--------------------------------------------------------------------------------

[51924e9a562a] 2005-04-07 21:01:54 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Degenerate the final expression of a statement expression.

[Auto-summary] Modifies evaluate.c. Changes: +7/-3 in 1 file(s)

Files: evaluate.c (+7/-3)
--------------------------------------------------------------------------------

[1604e925e5a0] 2005-04-07 21:01:54 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: User-defined types can mix with storage specifiers, so don't allow just qualifiers.

[Auto-summary] Modifies parse.c. Changes: +0/-1 in 1 file(s)

Files: parse.c (+0/-1)
--------------------------------------------------------------------------------

[83161bea0550] 2005-04-07 21:01:54 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add attribute mode "__QI__"

[Auto-summary] Modifies parse.c. Changes: +6/-1 in 1 file(s)

Files: parse.c (+6/-1)
--------------------------------------------------------------------------------

[92b37ffffc06] 2005-04-07 21:01:53 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: __builtin_memset() returns a "void *"

[Auto-summary] Modifies check.c. Changes: +2/-2 in 1 file(s)

Files: check.c (+2/-2)
--------------------------------------------------------------------------------

[a7c7dfd6bc74] 2005-04-07 21:01:53 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make sure user-defined types don't mix with other type specifiers.

[Auto-summary] Modifies 2 source files: evaluate.c, parse.c. Updates header symbol.h. Changes: +10/-1 in 3 file(s)

Files: evaluate.c (+1/-1), parse.c (+7/-0), symbol.h (+2/-0)
--------------------------------------------------------------------------------

[05766405881a] 2005-04-07 21:01:53 -0700
Author: Alexander Viro <viro@parcelfarce.linux.theplanet.co.uk>
Subject: [PATCH] more fun with sparse

This adds __builtin_memset(), __builtin_stdarg_start() and recognition
of __attribute__((pure)) and __attribute__((always_inline))?

Another thing that is probably worth doing is shifting add_pre_buffer()
of #define __i386__ 1 to target.c, seeing that it is obviouslty
target-dependent ;-)

Files: check.c (+1/-0), lib.c (+1/-0), parse.c (+4/-0)
--------------------------------------------------------------------------------

[e9f0183614a9] 2005-04-07 21:01:52 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: That last type optimization was wrong.

We do need to generate the degenerate pointer when we encounter
an array.

Cset exclude: torvalds@ppc970.osdl.org|ChangeSet|20040528192422|18153

Files: evaluate.c (+0/-2)
--------------------------------------------------------------------------------

[7762a7f0a774] 2005-04-07 21:01:52 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Don't unnecessarily create a new ctype in degenerate() if we already had one.

[Auto-summary] Modifies evaluate.c. Changes: +2/-0 in 1 file(s)

Files: evaluate.c (+2/-0)
--------------------------------------------------------------------------------

[ec073e81044e] 2005-04-07 21:01:52 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Duh. When I split up degenerate() and evaluate_addressof(), I forgot to put the expression simplification into degenerate.

Clean up calling conventions of "evaluate_addressof()" at the
same time, since we no longer call it in strange ways.

Files: evaluate.c (+8/-2)
--------------------------------------------------------------------------------

[808bc04a965a] 2005-04-07 21:01:52 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be more careful about "evaluate_dereference()".

In particular, this should get the size of the result right,
regardless of whether it was through a regular pointer, an
array dereference, or a pointer-to-array.

Files: evaluate.c (+17/-14)
--------------------------------------------------------------------------------

[ba2804ad0fcf] 2005-04-07 21:01:51 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix "addressof" of arrays.

The pointer-to-array does not degenerate until _use_, and
we need to make sure that "&" on an array actually generates
a pointer-to-array, not the degerate pointer-to-entry.

Of course, it usually degenerates later on, but not always.

Files: evaluate.c (+29/-19)
--------------------------------------------------------------------------------

[0daea9fb8417] 2005-04-07 21:01:51 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use "show_ident()" to show symbol names.

Trying to do it by hand just causes problems with
NULL names etc.

Files: evaluate.c (+1/-2)
--------------------------------------------------------------------------------

[50733876be7a] 2005-04-07 21:01:51 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Ok, now that we get pointers-to-arrays right, stop playing games with the string type. It's a static array of chars.

[Auto-summary] Modifies evaluate.c. Changes: +1/-1 in 1 file(s)

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[3b5071d6f739] 2005-04-07 21:01:50 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make 'degenerate()' handle bad types gracefully

[Auto-summary] Modifies evaluate.c. Changes: +2/-0 in 1 file(s)

Files: evaluate.c (+2/-0)
--------------------------------------------------------------------------------

[43ba543e6ff7] 2005-04-07 21:01:50 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make sure we degenerate arrays and functions when doing pointer differences and pointer casting.

[Auto-summary] Modifies evaluate.c. Changes: +5/-1 in 1 file(s)

Files: evaluate.c (+5/-1)
--------------------------------------------------------------------------------

[770c9890d21e] 2005-04-07 21:01:50 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow for more permissive pointer difference calculations.

The base types do have to be the same size, though.

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[68e8bbaabfd9] 2005-04-07 21:01:50 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix pointer add: use the correct bit_size for the thing we point to.

Also fix the expression tree on the degenerate array
expression dereferences.

Files: evaluate.c (+14/-2)
--------------------------------------------------------------------------------

[f738f8f68120] 2005-04-07 21:01:49 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Be more careful about evaluating a dereference of a pointer-to-array.

We shouldn't just generate a new array type, which
would degenerate into another pointer-to-array.

We should generate a pointer-to-entry.

Files: evaluate.c (+26/-18)
--------------------------------------------------------------------------------

[e21083740054] 2005-04-07 21:01:49 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. When dereferencing something, we sure shouldn't take the new type from the old _node_.

That old node goes away, and it's the _pointer_ that
determines the new type. Well duh!

Files: evaluate.c (+7/-5)
--------------------------------------------------------------------------------

[9b6da6e7b11a] 2005-04-07 21:01:49 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix (and simplify) array and function degeneration into pointers

We need to fix up the expression tree while we're at it.

Files: evaluate.c (+16/-45)
--------------------------------------------------------------------------------

[6661d85c0c2b] 2005-04-07 21:01:48 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: More nasty tests from Al.

[Auto-summary] Adds/updates 1 test(s). Changes: +9/-0 in 1 file(s)

Files: validation/noderef.c (+9/-0)
--------------------------------------------------------------------------------

[64ff4ad1b6fd] 2005-04-07 21:01:48 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Do a proper job of generating the pointer type for addressof()

This hopefully fixes some cases where we just got terminally
confused.

Files: evaluate.c (+7/-2)
--------------------------------------------------------------------------------

[c5551996acf6] 2005-04-07 21:01:48 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up evaluate_member_dereference() to take advantage of the lazy address type generation.

[Auto-summary] Modifies evaluate.c. Changes: +7/-6 in 1 file(s)

Files: evaluate.c (+7/-6)
--------------------------------------------------------------------------------

[0bde264e56a0] 2005-04-07 21:01:47 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: "a->b" is just shorthand for "(*a).b".

So let's make that explicit in the parse tree, and avoid
carrying the special cases around further. This makes the
evaluation phase only have one case to worry about.

Files: evaluate.c (+5/-21), expression.c (+9/-2)
--------------------------------------------------------------------------------

[5984a5036597] 2005-04-07 21:01:47 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: More "noderef" validation examples

[Auto-summary] Adds/updates 1 test(s). Changes: +6/-0 in 1 file(s)

Files: validation/noderef.c (+6/-0)
--------------------------------------------------------------------------------

[2fceb5891090] 2005-04-07 21:01:47 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: More examples from Al showing us being lazy on types.

This time we (again) have a bug where we optimize
the case of a zero member offset, and we get the
type wrong.

Files: validation/noderef.c (+10/-0)
--------------------------------------------------------------------------------

[f4baf9f7cfa7] 2005-04-07 21:01:47 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "value is so big" warning print the constant.

This makes it a lot easier to see what's up.

Files: expression.c (+5/-3)
--------------------------------------------------------------------------------

[0317c2a5cba0] 2005-04-07 21:01:46 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix "address_of" type evaluation and clean up the code.

Make the lazy and incomplete type evaluation of a symbol
expression explicit, so that address_of can fix it up
when it needs to, instead of having address_of trying
hard to work around the (unknown) incompleteness.

Files: evaluate.c (+13/-7)
--------------------------------------------------------------------------------

[56ea0d3a62f9] 2005-04-07 21:01:46 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add a type conversion validation test. This verifies that we're doing the proper integer promotions for normal integer binary operations.

[Auto-summary] Adds/updates 1 test(s). Changes: +4/-0 in 1 file(s)

Files: validation/typeconvert.c (+4/-0)
--------------------------------------------------------------------------------

[93c174b6a74e] 2005-04-07 21:01:46 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add more "noderef" validation tests.

[Auto-summary] Adds/updates 1 test(s). Changes: +9/-1 in 1 file(s)

Files: validation/noderef.c (+9/-1)
--------------------------------------------------------------------------------

[c8a0a0db0278] 2005-04-07 21:01:45 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Members don't just get the address space from the parent, they need to get the modifiers too.

[Auto-summary] Modifies evaluate.c. Changes: +9/-5 in 1 file(s)

Files: evaluate.c (+9/-5)
--------------------------------------------------------------------------------

[e418ea9f3fa8] 2005-04-07 21:01:45 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make "create_pointer()" not drop the address space and modifiers from intermediate nodes that it traverses.

[Auto-summary] Modifies evaluate.c. Changes: +8/-2 in 1 file(s)

Files: evaluate.c (+8/-2)
--------------------------------------------------------------------------------

[89ba812d740b] 2005-04-07 21:01:45 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix type declaration parsing for multiple variables in the same declaration.  Noticed by Al Viro.

Parsing something like

	int i, __user *p;

used to fail.

This also cleans up some users that expanded "declarator()"
by hand.

Files: parse.c (+5/-7)
--------------------------------------------------------------------------------

[04c2f8daba23] 2005-04-07 21:01:44 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix integer type conversion: types smaller than an "int" always convert to "int". Also make bitfields be considered integers.

Without this

	(char) 127 + (char) 127 + (char) 2

used to be calculated as all "char", and result in 0. That's not
how C works.

Files: evaluate.c (+13/-6)
--------------------------------------------------------------------------------

[2e308d17a4da] 2005-04-07 21:01:44 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix test-linearize with symbols that have no code to show.

[Auto-summary] Modifies test-linearize.c. Changes: +2/-1 in 1 file(s)

Files: test-linearize.c (+2/-1)
--------------------------------------------------------------------------------

[8f8b666e4f0b] 2005-04-07 21:01:44 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up modifier parsing, don't leave stale modifier values in pointer-to-pointer situations.

[Auto-summary] Modifies parse.c. Changes: +1/-0 in 1 file(s)

Files: parse.c (+1/-0)
--------------------------------------------------------------------------------

[71d669b724e7] 2005-04-07 21:01:44 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Merge bk://kernel.bkbits.net/jgarzik/sparse.be into ppc970.osdl.org:/home/torvalds/BK/sparse

[Auto-summary] Modifies 2 source files: linearize.c, test-linearize.c. Updates header linearize.h. Changes: +14/-7 in 3 file(s)

Files: linearize.c (+8/-5), linearize.h (+2/-1), test-linearize.c (+4/-1)
--------------------------------------------------------------------------------

[2bf8a7440c73] 2005-04-07 21:01:43 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add another test-case from Al.

[Auto-summary] Adds/updates 1 test(s). Changes: +9/-0 in 1 file(s)

Files: validation/noderef.c (+9/-0)
--------------------------------------------------------------------------------

[9465af87f4da] 2005-04-07 21:01:43 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: Generalize linearize_symbol()

Allow it to be used by multiple callers.

Files: linearize.c (+8/-5), linearize.h (+2/-1), test-linearize.c (+4/-1)
--------------------------------------------------------------------------------

[84a199fe2b74] 2005-04-07 21:01:43 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When evaluating a member dereference off a structure pointer, we need to convert the resulting member pointer to the same address space as the structure pointer itself.

This still does not fix the bug, since "create_pointer"
will peel off the node information, and thus undo what
we're trying to achieve, but that's a separate bug.

Files: evaluate.c (+12/-0)
--------------------------------------------------------------------------------

[7925d5203a63] 2005-04-07 21:01:42 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add a few test-cases that Al Viro noted.

[Auto-summary] Adds/updates 2 test(s). Changes: +34/-0 in 2 file(s)

Files: validation/bitfields.c (+18/-0), validation/struct-as.c (+16/-0)
--------------------------------------------------------------------------------

[56d6c239e86e] 2005-04-07 21:01:42 -0700
Author: Dave Jones <davej@redhat.com>
Subject: Ignore alias attributes Prevents tons of attribute 'alias': unknown attribute warnings during a kernel build.

[Auto-summary] Modifies parse.c. Changes: +2/-0 in 1 file(s)

Files: parse.c (+2/-0)
--------------------------------------------------------------------------------

[84be88725a2b] 2005-04-07 21:01:42 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Allow top-level inline asms

We parse them as a anonymous function with just an asm statement.

Files: parse.c (+57/-19)
--------------------------------------------------------------------------------

[5de8bc07fe36] 2005-04-07 21:01:42 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Accept "__attribute" in addition to "__attribute__".

gcc does.

Files: symbol.c (+1/-1)
--------------------------------------------------------------------------------

[297522047f3d] 2005-04-07 21:01:41 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: When we miss the type information, warn about it instead of crashing.

[Auto-summary] Modifies evaluate.c. Changes: +4/-0 in 1 file(s)

Files: evaluate.c (+4/-0)
--------------------------------------------------------------------------------

[1ff960b29aac] 2005-04-07 21:01:41 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Initialize C type system after parsing the command line arguments.

This makes "-m64" actually work.

Files: check.c (+3/-1), compile.c (+3/-0), expand.c (+1/-1), obfuscate.c (+3/-0), symbol.c (+5/-1), ... and 4 more
--------------------------------------------------------------------------------

[b103bc3b5324] 2005-04-07 21:01:40 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Now that BITS_IN_XXXX aren't defined contstants any more, rename them lower cased to match standard C naming rules.

[Auto-summary] Modifies 8 source files: compile-i386.c, evaluate.c, expression.c and 5 more. Updates header target.h. Changes: +82/-82 in 9 file(s)

Files: compile-i386.c (+4/-4), evaluate.c (+7/-7), expression.c (+6/-6), lib.c (+4/-4), parse.c (+1/-1), ... and 4 more
--------------------------------------------------------------------------------

[17015f7f121e] 2005-04-07 21:01:40 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add handling for "-m64" to tell us to use 64-bit mode.

[Auto-summary] Modifies lib.c. Changes: +13/-0 in 1 file(s)

Files: lib.c (+13/-0)
--------------------------------------------------------------------------------

[ddaa4fc95836] 2005-04-07 21:01:40 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use variables for target data structure information, instead of hardcoding it at compile time. This allows us to do "cross-checks" much more easily.

[Auto-summary] Modifies 2 source files: symbol.c, target.c. Updates header target.h. Modifies build system. Changes: +95/-45 in 4 file(s)

Files: Makefile (+1/-1), symbol.c (+28/-27), target.c (+49/-0), target.h (+17/-17)
--------------------------------------------------------------------------------

[7195dddfaafa] 2005-04-07 21:01:40 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] Fix "return" target handling

This fixes the linearization of "return", to use the proper symbol
target that the front end has already set up for it:

 - linearize_statement(), case "STMT_COMPOUND" needs to create a label
   at the _end_ (aftre doing the linearization of all the other stuff) if
   "stmt->ret" is non-NULL.

 - STMT_RETURN needs to move the return expression to the return variable,
   and goto the return label.

Files: lib.h (+12/-0), linearize.c (+38/-10), linearize.h (+3/-1), symbol.h (+4/-2)
--------------------------------------------------------------------------------

[b6f2b825158a] 2005-04-07 21:01:39 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] linearization bug fix and bitfield handling

- Bug fix for linearizion. Most the sparse source source
  can be feed to linearize without crash.
  One exception is the compile-i386.c, which contain
  type error due to sparse don't understand the assert
  macro yet.

- bit field was added to pass the test.

Files: lib.c (+6/-4), linearize.c (+83/-22)
--------------------------------------------------------------------------------

[4f973d1fd74a] 2005-04-07 21:01:39 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: Make the builtin functions be more type-correct, to allow all the regular function sanity checks to be run.

Remove duplicate symbol_call evaluation for direct
function calls, and move it to after all the sanity
checks.

Files: evaluate.c (+4/-8), symbol.c (+3/-1)
--------------------------------------------------------------------------------

[347a96fec774] 2005-04-07 21:01:39 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Oops. Fix the preprocessor handling of "..." arguments.

This has been broken since day one, but since most uses
were to things that could happily live with just the
first argument in the list, we never noticed.

Files: pre-process.c (+1/-0)
--------------------------------------------------------------------------------

[3bbfc67f9860] 2005-04-07 21:01:38 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: Accept "void *" for array assignments too.

We can't really assign to an array, but we can have
"array" arguments to functions etc that will degenerate
into pointers, and NULL is a valid initializer for those.

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[0ba206db573f] 2005-04-07 21:01:38 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: Make type equality comparisons more generous.

Make it realize that a pointer to an array is
compatible with a pointer to an entry in the array.

Files: evaluate.c (+40/-18)
--------------------------------------------------------------------------------

[28912f5aa031] 2005-04-07 21:01:38 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Revert ptr-to-array type demotion. It's wrong.

Cset exclude: torvalds@ppc970.osdl.org|ChangeSet|20040419183423|24692

Files: parse.c (+0/-12)
--------------------------------------------------------------------------------

[55f8ab0f142f] 2005-04-07 21:01:38 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up pointer-to-array type declarations.

Arrays are not first-class citizens in the C type
system, and a pointer to an array gets demoted to
just a pointer to the first entry.

Files: parse.c (+12/-0)
--------------------------------------------------------------------------------

[7e75fc14968a] 2005-04-07 21:01:37 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Merge evo:BK/sparse into ppc970.osdl.org:/home/torvalds/BK/sparse

[Auto-summary] Modifies 2 source files: parse.c, symbol.c. Changes: +9/-11 in 2 file(s)

Files: parse.c (+3/-5), symbol.c (+6/-6)
--------------------------------------------------------------------------------

[62e541910017] 2005-04-07 21:01:37 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] linearize conditional expressions

- add conditional expression linearization
 - fix a silly typo.

It seems that most of the expression and statement work is done.  The
initialize expression is still missing, which looks very complicated.

Files: lib.h (+1/-1), linearize.c (+27/-18)
--------------------------------------------------------------------------------

[04c29e8c3657] 2005-04-07 21:01:37 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: Fix up typename parsing.

We should not allow multiple type specifiers, even
of the same time (we used to silently accept "int int x;").

Files: parse.c (+3/-5), symbol.c (+6/-6)
--------------------------------------------------------------------------------

[86c405cf6f27] 2005-04-07 21:01:36 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix pointer addition

We should multiply with the size of the object we point to,
not the size of the pointer ;)

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[ad7f4a5b3ae4] 2005-04-07 21:01:36 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove special cases in addressof/member dereferece evaluation.

This fixes a lot of strange cases that we just got wrong.

Files: evaluate.c (+9/-22)
--------------------------------------------------------------------------------

[6c37a60bf226] 2005-04-07 21:01:36 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make arrays degenerate into pointers properly.

[Auto-summary] Modifies evaluate.c. Changes: +4/-1 in 1 file(s)

Files: evaluate.c (+4/-1)
--------------------------------------------------------------------------------

[e4e7b4901371] 2005-04-07 21:01:36 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Top-level symbols are always addressable, since they are visible to the linker.

This fixes the issue where we might otherwise believe
that they are constant when nobody assigns to them.

Files: symbol.c (+1/-1)
--------------------------------------------------------------------------------

[de1b64148c03] 2005-04-07 21:01:35 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Mark increment/decrements as assignments.

[Auto-summary] Modifies evaluate.c. Changes: +4/-0 in 1 file(s)

Files: evaluate.c (+4/-0)
--------------------------------------------------------------------------------

[ccaffae4f655] 2005-04-07 21:01:35 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: Fix up safe expression tests

Handle missing conditionals, and unary negation.

Files: evaluate.c (+5/-0)
--------------------------------------------------------------------------------

[98f14350c265] 2005-04-07 21:01:35 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Introduce "safe" pointer expressions.

These are defined to never be NULL or nontrapping, and could
help code generation, but right now only cause a warning if
they are tested in a conditional.

Files: evaluate.c (+28/-10), parse.c (+4/-0), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[25f8da1914f6] 2005-04-07 21:01:34 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] More linearizion fun

- add pre/post op and assign add etc.
 - change the call instruction have a list of arguments.
 - change the pseudo_t to be struct pseudo_t *, prepare
   for adding stuff to pseudo_t.

Files: lib.c (+2/-0), lib.h (+1/-1), linearize.c (+121/-124), linearize.h (+22/-22)
--------------------------------------------------------------------------------

[36e42c3abe2e] 2005-04-07 21:01:34 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] pack basic blocks

I figured out that I can unify the two case that need to merge the basic
block.  By doing that we avoid the need to modify the phi instructions. 

I also changed some macros in lib.h into inline functions for better
type checking.

Files: lib.h (+43/-9), linearize.c (+33/-38)
--------------------------------------------------------------------------------

[6af6fb881bcc] 2005-04-07 21:01:34 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: Fix up pointer creation..

Remember to give it the right size, address space and modifiers.

Files: evaluate.c (+8/-2)
--------------------------------------------------------------------------------

[08ed271cb3b9] 2005-04-07 21:01:34 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: Be more careful about type generation in dereferences.

We now need to get the right type to make the fixed addressof-
operator do the right thing (I may revisit this - I might delay
the type fixup until after I see the addressof, but for now this
should get us closer to being correct).

Files: evaluate.c (+38/-21)
--------------------------------------------------------------------------------

[de5bda5a9243] 2005-04-07 21:01:33 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Simplify and fix up "addressof" evaluation.

It should _always_ just remove the dereference operator,
nothing else.

Files: evaluate.c (+10/-21)
--------------------------------------------------------------------------------

[890e3893b6ee] 2005-04-07 21:01:33 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add a note about bogus warnings we can get.

There's some bug in the code that should fix

	&xx[0]

to be the same as "xx", because a zero-offset
dereference has a special (broken) optimization.

I'm too tired to find the bug, so add the
comment so that nobody else ends up being confused
about it.

Files: expand.c (+8/-0)
--------------------------------------------------------------------------------

[1ea2f5092767] 2005-04-07 21:01:33 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make the "noderef" attribute work right.

We should check the type of the resulting expression
and not worry about how that expression came about.

Files: expand.c (+4/-3)
--------------------------------------------------------------------------------

[3fa9388c747e] 2005-04-07 21:01:32 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] make sparse recognise assembler naming (register and symbol names)

[Auto-summary] Modifies parse.c. Changes: +9/-0 in 1 file(s)

Files: parse.c (+9/-0)
--------------------------------------------------------------------------------

[de3268a2df13] 2005-04-07 21:01:32 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] more op-codes

This is another small step.  It adds binary ops, compare ops and ret.

The classic recursive Fibonacci numbers function should be working.

Files: linearize.c (+80/-11), linearize.h (+17/-8)
--------------------------------------------------------------------------------

[015f2c6d1c74] 2005-04-07 21:01:32 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] condition branch simplification

Here is the updated version of the patch.

I tried to do as well on the iterator flattening as the old code, but
then realized that the end result will be about as complex as what was
there from before.  So instead I wrote a simple pass to stitch the basic
blocks together.  It does two things: ff it is an empty block with a
goto, it transfers the outgoing edge directly to the target.  And if the
only parent ends with a goto, it combines the block with the parent. 

There is also dead code elimination.  So I removed the previous entry
point hack for while loops.  There is no need for that any more, and the
end result is that we generate very compact basic blocks, often better
than the previous approach did.

The extra pass can almost certainly be reused for other back end passes.

I also did:
 - add some lib functions to delete a point from the ptr_list while
   iterating.
 - Ignore labels which are not used
 - some minor bug fixing to the previous patch

Know problem:
 - it doesn't deal with phi correctly, I need to redo the phi base
   on Tommy's suggestion.

Files: lib.c (+204/-0), lib.h (+110/-0), linearize.c (+347/-244), linearize.h (+97/-13), symbol.h (+0/-1)
--------------------------------------------------------------------------------

[e79ea0da8b23] 2005-04-07 21:01:31 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix linearization of unconditional iterator.

Also print out linearization better, and fix up address
generation error cases.

Files: linearize.c (+19/-6)
--------------------------------------------------------------------------------

[4339ecb12e64] 2005-04-07 21:01:31 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up some __attribute__() parsing.

This fixes a context attribute without mask/value expression,
and does a first pass at parsing the gcc __mode__ attribute.

Files: parse.c (+31/-1)
--------------------------------------------------------------------------------

[ba7791a2c8bf] 2005-04-07 21:01:31 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix up iterator reachability code for linearization.

Make the pre-condition target symbol generation be
dependent on pre-condition reachability.

Fix up entry-point handling for the case where there
was no label inside the iterator and the iterator was
not reachable.

Files: linearize.c (+11/-5)
--------------------------------------------------------------------------------

[a5bf03586c7a] 2005-04-07 21:01:30 -0700
Author: Christopher Li <sparse@chrisli.org>
Subject: [PATCH] PATCH: remove dead while loop

This improves the dead code eliminate for iterators that begin in an
unreachable section (eg a "while" statement inside a "if (0)").

The idea is that have a decoy entrypoint for those while loops.  On copy
the basic block back only if there is C level label was found inside the
block.

It is tempting that left the dead code elimination and constant
propagation to the some back end pass.

Files: lib.h (+6/-0), linearize.c (+16/-0), linearize.h (+3/-0)
--------------------------------------------------------------------------------

[214912ea0d1a] 2005-04-07 21:01:30 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up type expression syntax.

We now require square brackets around the type, to avoid
any confusion with casts or variable declarations:

	if ([typeof(x)] == [int])
		...

Files: expression.c (+9/-2)
--------------------------------------------------------------------------------

[16b4f3946def] 2005-04-07 21:01:30 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Support type equality testing for real.

Export "type_difference()" for type equality testing
in expand.c.

Evaluate the type in a EXPR_TYPE expression.

Files: evaluate.c (+4/-1), expand.c (+17/-1), symbol.h (+2/-0)
--------------------------------------------------------------------------------

[c909930ea7a0] 2005-04-07 21:01:30 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Support C types as first-class citizens, allowing type comparisons etc:

if (typeof(a) == int) {
		...

(although right now I don't actually do the proper comparison
expansion and all comparisons return "true").

Files: compile-i386.c (+3/-0), evaluate.c (+15/-0), expand.c (+15/-0), expression.c (+8/-8), expression.h (+2/-1), ... and 3 more
--------------------------------------------------------------------------------

[d7aeb76801cf] 2005-04-07 21:01:29 -0700
Author: Linus Torvalds <torvalds@evo.osdl.org>
Subject: Warn about users trying to use type names in expressions.

I think I'll allow type expressions at some point, since
it shouldn't actually be all that hard, and would even clean
some stuff up. But for now, we'll just warn about non-C code.

Files: expression.c (+15/-1)
--------------------------------------------------------------------------------

[abae88c8e3ae] 2005-04-07 21:01:29 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Use the "look up multiple namespaces" facility to look up types.

This makes up get the proper nesting characteristics
in case you mix typedefs and regular symbols with the
same name.

Files: expression.h (+4/-2)
--------------------------------------------------------------------------------

[98b73504f18a] 2005-04-07 21:01:29 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make it possible to look up multiple namespaces at once by making the namespace thing a bitmap.

[Auto-summary] Modifies symbol.c. Updates header symbol.h. Changes: +9/-9 in 2 file(s)

Files: symbol.c (+1/-1), symbol.h (+8/-8)
--------------------------------------------------------------------------------

[ca8c93fe8798] 2005-04-07 21:01:28 -0700
Author: Linus Torvalds <torvalds@newtove.osdl.org>
Subject: When warning about function calls, don't assume that we have a named symbol for the call (it could be through a function pointer expression).

[Auto-summary] Modifies evaluate.c. Changes: +2/-4 in 1 file(s)

Files: evaluate.c (+2/-4)
--------------------------------------------------------------------------------

[a4d68b35cce5] 2005-04-07 21:01:28 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix token expansion array overflow.

[Auto-summary] Modifies pre-process.c. Changes: +7/-1 in 1 file(s)

Files: pre-process.c (+7/-1)
--------------------------------------------------------------------------------

[dcda4aecd5ed] 2005-04-07 21:01:28 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Linearize post-ops and casts.

And add a "OP_BADOP" linearization for expressions
that we don't do yet, so that it's easier to see what
is missing..

Files: linearize.c (+41/-1), linearize.h (+6/-1)
--------------------------------------------------------------------------------

[8e3e7f9a8c1a] 2005-04-07 21:01:28 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Linearize function calls. Kind-of.

(Btw - a number of the linearizations are pretty spotty,
and not doing the right thing in the details. It's more 
concept thing).

Files: linearize.c (+77/-0), linearize.h (+3/-0)
--------------------------------------------------------------------------------

[48b2d8bb696a] 2005-04-07 21:01:27 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Remove now-obsolete temporary statement types.

They were only used for the original pre-instruction
linearization.

Files: compile-i386.c (+0/-16), evaluate.c (+0/-7), expand.c (+0/-7), parse.h (+0/-6), show-parse.c (+0/-26)
--------------------------------------------------------------------------------

[69232905ffdb] 2005-04-07 21:01:27 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix another missing dependency.

[Auto-summary] Modifies build system. Changes: +1/-0 in 1 file(s)

Files: Makefile (+1/-0)
--------------------------------------------------------------------------------

[3ff0203e3ed1] 2005-04-07 21:01:27 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Linearize logical ops.

[Auto-summary] Modifies linearize.c. Updates header linearize.h. Changes: +71/-18 in 2 file(s)

Files: linearize.c (+70/-18), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[39bc3fa4bad3] 2005-04-07 21:01:26 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add new IL for expression linearization.

Linearize some simple expressions, the rest we just ignore
for now. This is crapola. I'm really not sure this is the
right way at all, but I don't see any good alternatives.

Files: lib.c (+2/-0), lib.h (+2/-0), linearize.c (+256/-33), linearize.h (+52/-1)
--------------------------------------------------------------------------------

[0e27c2ad2357] 2005-04-07 21:01:26 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Fix dependencies

[Auto-summary] Modifies build system. Changes: +1/-0 in 1 file(s)

Files: Makefile (+1/-0)
--------------------------------------------------------------------------------

[60546523cdf5] 2005-04-07 21:01:26 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add bb "parent" information (ie back-pointers).

This is required for any kind of efficient liveness
analysis.

Files: linearize.c (+34/-8), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[a323e6d3b412] 2005-04-07 21:01:25 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Make a difference between an anonymous label and a named one. For an anonymous one, we can just re-use an existing named one if we're at the same point.

[Auto-summary] Modifies linearize.c. Changes: +21/-7 in 1 file(s)

Files: linearize.c (+21/-7)
--------------------------------------------------------------------------------

[77323e6f59a2] 2005-04-07 21:01:25 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Add helper function to test for ptr list empty.

[Auto-summary] Updates header lib.h. Changes: +3/-0 in 1 file(s)

Files: lib.h (+3/-0)
--------------------------------------------------------------------------------

[bccad350df1a] 2005-04-07 21:01:25 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up linearization, and make the basic blocks be true basic blocks (with all exits at the bottom).

This will simplify some of the analysis.

Files: linearize.c (+22/-10), linearize.h (+8/-0)
--------------------------------------------------------------------------------

[ca15470fe4bd] 2005-04-07 21:01:24 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up linearize conditional branch generation.

This is all preparing to start linearizing expressions
without going crazy. Now the linearization code is a
lot more understandable, and all the basic functions
don't need to return any values (we will need the return
value for the pseudos).

Files: linearize.c (+12/-15)
--------------------------------------------------------------------------------

[420b2849338c] 2005-04-07 21:01:24 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up "linearize()" calling convention even more.

It's almost understandable now.

Files: linearize.c (+81/-78), linearize.h (+1/-0)
--------------------------------------------------------------------------------

[26352a4f0b83] 2005-04-07 21:01:24 -0700
Author: Linus Torvalds <torvalds@ppc970.osdl.org>
Subject: Clean up "linearize()" calling conventions.

[Auto-summary] Modifies linearize.c. Changes: +31/-32 in 1 file(s)

Files: linearize.c (+31/-32)
--------------------------------------------------------------------------------

[346e5e106282] 2005-04-07 21:01:24 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Add basic block "ownership", ie each basic block has a symbol that "owns" it (unless it is entirely statically unreachable).

Use this to do trivial constant conditional folding.

Files: linearize.c (+61/-28), linearize.h (+3/-2)
--------------------------------------------------------------------------------

[18daf55618ba] 2005-04-07 21:01:23 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Fix the "none of the above" case for switch statements.

[Auto-summary] Modifies linearize.c. Changes: +3/-0 in 1 file(s)

Files: linearize.c (+3/-0)
--------------------------------------------------------------------------------

[dcc3d37fdc74] 2005-04-07 21:01:23 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Add proper linearization of switch statements.

[Auto-summary] Modifies 5 source files: compile-i386.c, evaluate.c, expand.c and 2 more. Updates header parse.h. Changes: +74/-3 in 6 file(s)

Files: compile-i386.c (+8/-0), evaluate.c (+2/-0), expand.c (+2/-0), linearize.c (+38/-3), parse.h (+7/-0), ... and 1 more
--------------------------------------------------------------------------------

[80458cde49e9] 2005-04-07 21:01:23 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Fix "add_list_pointer()" to keep things in proper order.

[Auto-summary] Modifies lib.c. Changes: +7/-6 in 1 file(s)

Files: lib.c (+7/-6)
--------------------------------------------------------------------------------

[d15a016c83f1] 2005-04-07 21:01:22 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Improve statement printout to make the result more readable.

[Auto-summary] Modifies 2 source files: linearize.c, show-parse.c. Changes: +7/-7 in 2 file(s)

Files: linearize.c (+2/-2), show-parse.c (+5/-5)
--------------------------------------------------------------------------------

[e90acd374672] 2005-04-07 21:01:22 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Fix "show_symbol_expr_init()" to not crash if the expression isn't an EXPR_INITIALIZER.

Simple initializers are just regular values.

Files: show-parse.c (+1/-1)
--------------------------------------------------------------------------------

[2266666cdb97] 2005-04-07 21:01:22 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Split "STMT_GOTO_BB" into "STMT_CONDTRUE" and "STMT_CONDFALSE".

This lets us get the type of comparison right.

Files: compile-i386.c (+6/-2), evaluate.c (+2/-1), expand.c (+5/-0), linearize.c (+3/-3), parse.h (+2/-1), ... and 1 more
--------------------------------------------------------------------------------

[ca6f609c266d] 2005-04-07 21:01:22 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Linearize iterators, at least a first try at it.

As with labels, this required us to do indirection through
a symbol for branch targets. Now everything is handled that
way, and things look a lot saner.

Files: linearize.c (+75/-3), parse.h (+1/-1), show-parse.c (+3/-3)
--------------------------------------------------------------------------------

[cf48f1fd60f6] 2005-04-07 21:01:21 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Add "goto/label" support for linearization.

This required making the inter-BB trampoline to be done
using indirection through a symbol, rather than as direct
pointers from one BB to another. Fix up code to match.

Avoid a few warnings by handling GOTO_BB in the case
statements.

Files: Makefile (+1/-1), compile-i386.c (+3/-0), evaluate.c (+4/-0), linearize.c (+30/-5), linearize.h (+1/-1), ... and 2 more
--------------------------------------------------------------------------------

[b913ad003c3e] 2005-04-07 21:01:21 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Fix silly "else" case handling bug. If we have an else case, we'd better linearize it in that context, and we'd better make the first "goto" point to the else.

[Auto-summary] Modifies linearize.c. Changes: +2/-1 in 1 file(s)

Files: linearize.c (+2/-1)
--------------------------------------------------------------------------------

[a04d1a1f9b5c] 2005-04-07 21:01:21 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Add real flow control to the basic-block handling.

Right now we only really do trivial if-statements, but the
ideas are all there now.

Files: linearize.c (+51/-2), linearize.h (+1/-0), parse.h (+7/-0), show-parse.c (+7/-1)
--------------------------------------------------------------------------------

[15ecac69e164] 2005-04-07 21:01:20 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Add a "test-linearize" program to test the output of the linearization phase.

[Auto-summary] Modifies test-linearize.c. Modifies build system. Changes: +89/-2 in 2 file(s)

Files: Makefile (+6/-2), test-linearize.c (+83/-0)
--------------------------------------------------------------------------------

[db4a4265c41a] 2005-04-07 21:01:20 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Oops. Fix name clash by renaming the new "copy_ptr_list" to be "concat_ptr_list" (which also is more accurate).

Declare linearize_symbol().

Files: lib.c (+1/-1), lib.h (+3/-3), linearize.c (+2/-2), linearize.h (+2/-0)
--------------------------------------------------------------------------------

[7f2bd1a27e9d] 2005-04-07 21:01:20 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: This add a linearization phase. It's not even close to done yet, but the framework is there.

When we linearize the tree we just generate a list of basic
blocks of statement expressions (and branches between them,
although that "small details" isn't actually done yet ;).

Files: lib.c (+12/-0), lib.h (+11/-0), linearize.c (+110/-0), linearize.h (+27/-0)
--------------------------------------------------------------------------------

[3ffb6bac9871] 2005-04-07 21:01:19 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] get operand size correct on mem->mem copies

[Auto-summary] Modifies compile-i386.c. Changes: +26/-8 in 1 file(s)

Files: compile-i386.c (+26/-8)
--------------------------------------------------------------------------------

[6c7ae6ece4e8] 2005-04-07 21:01:19 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] Fix binops.  We should now get operand size and sign correct.

[Auto-summary] Modifies compile-i386.c. Changes: +114/-22 in 1 file(s)

Files: compile-i386.c (+114/-22)
--------------------------------------------------------------------------------

[c0c28817731c] 2005-04-07 21:01:19 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] fix function name emitted for .size directive

We were using the output of show_ident() without remembering
that that function uses static storage.

Files: compile-i386.c (+1/-0)
--------------------------------------------------------------------------------

[498702a84dae] 2005-04-07 21:01:19 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] Handle 'break' and 'continue' inside loops.

[Auto-summary] Modifies compile-i386.c. Changes: +12/-2 in 1 file(s)

Files: compile-i386.c (+12/-2)
--------------------------------------------------------------------------------

[19209d98da91] 2005-04-07 21:01:18 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] handle 'break' and 'continue' in loop emit code

The loop generator should be correct now; all that remains is to
actually generate the jumps based on the loop label info we now
store in the "loop stack".

Files: compile-i386.c (+53/-18)
--------------------------------------------------------------------------------

[c9630e8363de] 2005-04-07 21:01:18 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] Get most of loops working.

The thing that remains is getting 'break' and 'continue' assigned
to the correct jump targets.

Files: compile-i386.c (+46/-12)
--------------------------------------------------------------------------------

[bfcee9b9d5c5] 2005-04-07 21:01:18 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: Merge kernel.bkbits.net:sparse.be into redhat.com:/garz/repo/sparse.be

[Auto-summary] Modifies compile-i386.c. Changes: +30/-23 in 1 file(s)

Files: compile-i386.c (+30/-23)
--------------------------------------------------------------------------------

[5676df39fce7] 2005-04-07 21:01:17 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Allow variable-sized array size declarations.

This doesn't actually get them _right_, but as long as they
end up being constant when used, we at least silently ignore
them until then.

Files: compile-i386.c (+2/-2), evaluate.c (+6/-6), expand.c (+2/-0), expression.h (+10/-0), parse.c (+1/-4), ... and 3 more
--------------------------------------------------------------------------------

[4cee3478b8f9] 2005-04-07 21:01:17 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: A much-needed stack allocation facelift.

Instead of assuming that all stack objects were 4 bytes in size,
we now properly account for both stack variables (sym->bit_size / 8)
and compiler temporaries (fixed 32 bits).

Function new_pseudo() became stack_alloc(), which takes a number of
bytes to allocate on the stack.

Files: compile-i386.c (+25/-19)
--------------------------------------------------------------------------------

[20c051a6aa36] 2005-04-07 21:01:17 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Fix symbol derefence type information merge.

[Auto-summary] Modifies evaluate.c. Changes: +1/-1 in 1 file(s)

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[85da47e504cd] 2005-04-07 21:01:17 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] rename pseudo_nr to stack_size

More properly describe what the variable represents, and also
prepare for upcoming stack allocation improvements.

Files: compile-i386.c (+9/-8)
--------------------------------------------------------------------------------

[6bee4ed0c1f2] 2005-04-07 21:01:16 -0700
Author: Andries E. Brouwer <Andries.Brouwer@cwi.nl>
Subject: [PATCH] compilation fix for test-parsing.c

An extra semicolon results in an empty statement, causing the
"declaration after statement" problem. 

Newer versions of gcc will silently accept it, but older versions won't.

Files: test-parsing.c (+1/-1)
--------------------------------------------------------------------------------

[06437281c6e5] 2005-04-07 21:01:16 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: Merge redhat.com:/garz/repo/sparse into redhat.com:/garz/repo/sparse.be

[Auto-summary] Modifies 2 source files: check.c, lib.c. Changes: +62/-40 in 2 file(s)

Files: check.c (+1/-0), lib.c (+61/-40)
--------------------------------------------------------------------------------

[54fe34301559] 2005-04-07 21:01:16 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] properly emit switch statements.

Also create helpers for emitted labels (emit_label),
labels based on symbol pointer values (emit_labelsym),
and creating various struct storage types (new_val, new_labelsym).

Use these new helpers where appropriate.

Files: compile-i386.c (+173/-67)
--------------------------------------------------------------------------------

[6a8725b521ac] 2005-04-07 21:01:15 -0700
Author: Arnaldo Carvalho de Melo <acme@conectiva.com.br>
Subject: o move the definition of __CHECKER__ only to check.c

[Auto-summary] Modifies 2 source files: check.c, lib.c. Changes: +1/-1 in 2 file(s)

Files: check.c (+1/-0), lib.c (+0/-1)
--------------------------------------------------------------------------------

[1ff814445ad9] 2005-04-07 21:01:15 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] prefer "mov $0, %eax" to "xor %eax, %eax"

[Auto-summary] Modifies compile-i386.c. Changes: +8/-4 in 1 file(s)

Files: compile-i386.c (+8/-4)
--------------------------------------------------------------------------------

[c17404ab0019] 2005-04-07 21:01:15 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] Store "free() me?" flag in struct storage, where it belongs, rather than as multiple flags in struct atom.  This allows us to eliminate the final arg passed to {insn, emit_move, stor_op_name}.

Also, fix two memory leaks noticed during the cleanup.

Files: compile-i386.c (+64/-66)
--------------------------------------------------------------------------------

[659513c0418d] 2005-04-07 21:01:14 -0700
Author: Arnaldo Carvalho de Melo <acme@conectiva.com.br>
Subject: o split handle_switch, to make it more lib friendly

I.e. a more complex tool will need a different handle_switch,
so make the handling of each switch a function that can be
used by such specialized handle_switch while keeping handle_switch
for simpler tools.

Files: lib.c (+61/-39)
--------------------------------------------------------------------------------

[b9233b60767b] 2005-04-07 21:01:14 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] temporarily ignore size of a callee func call's return value. Now, we just assume it's the ABI size (32 bits) rather than care about the distinction between what we want to return up the parse tree stack (possibly not 32 bits), and what the ABI gives us (32 bits).

Also, add new file validation/test-be.c, to house a growing
collection of basic sanity checks I can run, to help avoid
regressions.

Files: compile-i386.c (+1/-1), validation/test-be.c (+43/-0)
--------------------------------------------------------------------------------

[05904883b31c] 2005-04-07 21:01:14 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] add to-do list compile-i386.c header

[Auto-summary] Modifies compile-i386.c. Changes: +13/-0 in 1 file(s)

Files: compile-i386.c (+13/-0)
--------------------------------------------------------------------------------

[28b6c7f23633] 2005-04-07 21:01:14 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] clean up binop selection.  add support for shift left/right

[Auto-summary] Modifies compile-i386.c. Changes: +14/-14 in 1 file(s)

Files: compile-i386.c (+14/-14)
--------------------------------------------------------------------------------

[9024fa923527] 2005-04-07 21:01:13 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] properly emit "regular preops"

* properly emit '!', '~', '-'
* handle operand size in inc/dec
* simplify EXPR_ACCESS test in x86_address_gen()

Files: compile-i386.c (+38/-26)
--------------------------------------------------------------------------------

[131473047b41] 2005-04-07 21:01:13 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] move existing (non-working) loop code to its own function

[Auto-summary] Modifies compile-i386.c. Changes: +51/-46 in 1 file(s)

Files: compile-i386.c (+51/-46)
--------------------------------------------------------------------------------

[529a1df095e0] 2005-04-07 21:01:13 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] Properly load address de-references.

[Auto-summary] Modifies compile-i386.c. Changes: +23/-7 in 1 file(s)

Files: compile-i386.c (+23/-7)
--------------------------------------------------------------------------------

[6bacf9cda302] 2005-04-07 21:01:12 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] fixes

* remove bogus "toplevel symbol" check I put in.  Needs reworking.
* Don't emit subl/addl %esp stack frame adjustments, if no
  stack frame exists.

Files: compile-i386.c (+16/-10)
--------------------------------------------------------------------------------

[bfcd156953fb] 2005-04-07 21:01:12 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] Don't emit move based on value returned from a function's toplevel STMT_COMPOUND.

If a function returns a value, then the C code must have explicit
'return' statements.  Since we already emit a move when handling
return statements, that eliminates the need to ever emit a move for
the non-'return' case.

Of course, incorrect C code can still omit the return statement, in
which case you're left with a random %eax return value.

Files: compile-i386.c (+3/-10)
--------------------------------------------------------------------------------

[3dc32badefcc] 2005-04-07 21:01:12 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] fix indirect func calls

[Auto-summary] Modifies compile-i386.c. Changes: +1/-1 in 1 file(s)

Files: compile-i386.c (+1/-1)
--------------------------------------------------------------------------------

[8c6fef64d516] 2005-04-07 21:01:12 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] In assignments, don't perform a mem->mem copy (two mov's) when we don't have to.

[Auto-summary] Modifies compile-i386.c. Changes: +16/-1 in 1 file(s)

Files: compile-i386.c (+16/-1)
--------------------------------------------------------------------------------

[a2833a5946e2] 2005-04-07 21:01:11 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] return fixes: move return jump target, emit return value properly

Still needs some work.

Files: compile-i386.c (+8/-5)
--------------------------------------------------------------------------------

[9cae8a7a537c] 2005-04-07 21:01:11 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] emit casts, prettier emit_copy output, fix segfault, smarter val storage.

* fix segfault in emit_symbol_expr_init.  we don't yet properly
  reference toplevel variables.  workaround, print out "FIXME!" and
  create a new pseudo.
* directly inline constants, instead of assigning them stack slots
  as pseudos.
* properly emit cast expressions; quite easy with my type-aware
  emit_move function.  alas, since we assume values will fit into
  a machine register, emit_move is [known-]broken for 64-bit ints.
* make asm comments in pseudo-pseudo copy prettier

Files: compile-i386.c (+47/-38)
--------------------------------------------------------------------------------

[24a480963d1a] 2005-04-07 21:01:11 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Merge bk://kernel.bkbits.net/jgarzik/sparse.hacking into home.osdl.org:/home/torvalds/src/parser

[Auto-summary] Modifies 3 source files: compile-i386.c, compile.c, evaluate.c. Changes: +115/-49 in 3 file(s)

Files: compile-i386.c (+105/-47), compile.c (+4/-1), evaluate.c (+6/-1)
--------------------------------------------------------------------------------

[37bb0bbaa5a0] 2005-04-07 21:01:10 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Merge bk://kernel.bkbits.net/jgarzik/sparse.hacking into home.osdl.org:/home/torvalds/src/parser

[Auto-summary] Modifies compile-i386.c. Changes: +2/-5 in 1 file(s)

Files: compile-i386.c (+2/-5)
--------------------------------------------------------------------------------

[0cc46aba1fb3] 2005-04-07 21:01:10 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] properly emit strings, indirect func calls, and func call return values.

[Auto-summary] Modifies compile-i386.c. Changes: +105/-47 in 1 file(s)

Files: compile-i386.c (+105/-47)
--------------------------------------------------------------------------------

[4dd0c093711f] 2005-04-07 21:01:10 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: Fix lost string initializers, in evaluate_string().

[Auto-summary] Modifies evaluate.c. Changes: +6/-1 in 1 file(s)

Files: evaluate.c (+6/-1)
--------------------------------------------------------------------------------

[6aa0b68d9930] 2005-04-07 21:01:09 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] Kill unused var

[Auto-summary] Modifies compile.c. Changes: +1/-1 in 1 file(s)

Files: compile.c (+1/-1)
--------------------------------------------------------------------------------

[46477d5352ae] 2005-04-07 21:01:09 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: Merge bk://linux-dj.bkbits.net/sparse into redhat.com:/garz/repo/sparse.hacking

[Auto-summary] Modifies compile.c. Changes: +3/-0 in 1 file(s)

Files: compile.c (+3/-0)
--------------------------------------------------------------------------------

[1c94d3f88e42] 2005-04-07 21:01:09 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] Handle 'if' using test/jz insns rather than xor/cmp/je

Suggested by Arjan van de Ven.

Files: compile-i386.c (+2/-5)
--------------------------------------------------------------------------------

[2d53b46c571a] 2005-04-07 21:01:09 -0700
Author: Dave Jones <davej@redhat.com>
Subject: Don't crash if no filename specified

[Auto-summary] Modifies compile.c. Changes: +3/-0 in 1 file(s)

Files: compile.c (+3/-0)
--------------------------------------------------------------------------------

[d1b7e7a4831a] 2005-04-07 21:01:08 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Merge bk://kernel.bkbits.net/acme/sparse.acme into home.osdl.org:/home/torvalds/src/parser

[Auto-summary] Modifies 2 source files: check.c, lib.c. Changes: +2/-2 in 2 file(s)

Files: check.c (+2/-0), lib.c (+0/-2)
--------------------------------------------------------------------------------

[9124d261c021] 2005-04-07 21:01:08 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Merge bk://kernel.bkbits.net/acme/sparse.acme into home.osdl.org:/home/torvalds/src/parser

[Auto-summary] Modifies compile.c. Changes: +8/-37 in 1 file(s)

Files: compile.c (+8/-37)
--------------------------------------------------------------------------------

[982fa30dc521] 2005-04-07 21:01:08 -0700
Author: Arnaldo Carvalho de Melo <acme@parisc.kerneljanitors.org>
Subject: o remove extern __builtin declarations from create_builtin_stream

They alter the generated output, so I think its better to add it just on
check.

Files: check.c (+2/-0), lib.c (+0/-2)
--------------------------------------------------------------------------------

[5609ffebd1d7] 2005-04-07 21:01:07 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] generate code for "x ? 1 : 0" type conditionals

[Auto-summary] Modifies compile-i386.c. Changes: +30/-16 in 1 file(s)

Files: compile-i386.c (+30/-16)
--------------------------------------------------------------------------------

[8b9e8a74d1c4] 2005-04-07 21:01:07 -0700
Author: Arnaldo Carvalho de Melo <acme@parisc.kerneljanitors.org>
Subject: o make compile.c use the generic do_switch and create_builtin_stream

[Auto-summary] Modifies compile.c. Changes: +8/-37 in 1 file(s)

Files: compile.c (+8/-37)
--------------------------------------------------------------------------------

[914e4a95b5c8] 2005-04-07 21:01:07 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] comparison, signedness, and operand size update

* rename emit_move() to emit_copy() (it copies stack slotX -> slotY)
* create a size- and sign-aware emit_move()
* create opbits(), to help determine instruction suffix
  based on memory operand
* update emit_compare() to be operand sign- and size-aware
* update emit_compare() to use SETcc instead of CMOVcc.
  (suggested by Arjan van de Ven)

Files: compile-i386.c (+129/-38)
--------------------------------------------------------------------------------

[7fa7aca7c7ee] 2005-04-07 21:01:07 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Merge bk://kernel.bkbits.net/jgarzik/sparse into home.osdl.org:/home/torvalds/src/parser

[Auto-summary] Modifies compile-i386.c. Changes: +9/-22 in 1 file(s)

Files: compile-i386.c (+9/-22)
--------------------------------------------------------------------------------

[8aee7c59df54] 2005-04-07 21:01:06 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Warn about non-constant case statements.

[Auto-summary] Modifies expand.c. Changes: +10/-2 in 1 file(s)

Files: expand.c (+10/-2)
--------------------------------------------------------------------------------

[d145e6c1a8c5] 2005-04-07 21:01:06 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] comparison expression update:

* fix comparison order.  was using Intel not AT&T order of operands.
* replace nested-if tree of string comparisons with a switch
  on expr->op value.

Files: compile-i386.c (+9/-22)
--------------------------------------------------------------------------------

[021e9837c6a3] 2005-04-07 21:01:06 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [BK] ignore some compile-generated files

[Auto-summary] No file changes detected.

--------------------------------------------------------------------------------

[c95635f1310e] 2005-04-07 21:01:05 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] calculate offset of func args on stack correctly

And remove code warning people it's wrong, as it should no longer be.

Files: compile-i386.c (+5/-23)
--------------------------------------------------------------------------------

[e56db31bb6de] 2005-04-07 21:01:05 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] Convert insn() function to take struct storage arguments, instead of char* arguments.  This uses the previously-added 'atom' instructure.  It also necessitates adding new struct storage types:  STOR_REG (machine register), STOR_VALUE (constant), and STOR_LABEL (label / jump target).

Updated all insn() callers to provide struct storage arguments.

Files: compile-i386.c (+186/-75)
--------------------------------------------------------------------------------

[890dcd116c0a] 2005-04-07 21:01:05 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] Instead of buffering output with a hand-rolled list of text buffers, update code to use a ptr_list of "atoms".  Atoms basically correspond to a single line of assembly.  There are ATOM_TEXT atoms for ASCII text (the only kind of atom currently in use) and ATOM_INSN for instructions.

[Auto-summary] Modifies compile-i386.c. Changes: +92/-7 in 1 file(s)

Files: compile-i386.c (+92/-7)
--------------------------------------------------------------------------------

[221af696b375] 2005-04-07 21:01:05 -0700
Author: Jeff Garzik <jgarzik@redhat.com>
Subject: [be] get return values and jump targets working

[Auto-summary] Modifies compile-i386.c. Changes: +33/-31 in 1 file(s)

Files: compile-i386.c (+33/-31)
--------------------------------------------------------------------------------

[ad6e36a41706] 2005-04-07 21:01:04 -0700
Author: Jeff Garzik <jgarzik@pobox.com>
Subject: [PATCH] "silly sparse x86 backend"

Here's what I have so far.

Comments welcome.  It cannot be considered anywhere near complete, but
it acts like it generates x86 asm for a bunch of small test cases anyway :)

It started out as show-parse.c.  The emit_xxx stuff is what I have
converted from show-parse pseudo-code into x86 code generation.  The 
x86_xxx stuff is the stuff that remains.  FIXMEs abound.

I haven't actually tried to assmble anything yet.  Just studying what
gcc generates, and then what I generate.

A few random notes in closing:

* function-at-a-time

* just does one subl and one addl for stack manipulation, which implies 
that it has to output everything from post-function cleanup pass
(emit_func_post).

* however, x86_xxx stuff (not yet converted) will still print out 
pseudocode.  So your output will look like
	function header
	psuedocode (i.e. stuff not yet handled)
	real x86 code

If you don't see any pseudocode... you may actually be lucky enough to
be able to compile your asm ;-)

Files: Makefile (+11/-5), compile-i386.c (+1452/-0), compile.c (+134/-0)
--------------------------------------------------------------------------------

[a9a94cfd3e49] 2005-04-07 21:01:04 -0700
Author: Jeff Garzik <jgarzik@pobox.com>
Subject: [PATCH] free_ptr_list() lib function

I allocate a pointer list for each function, and free it after I'm done,
using a new function, free_ptr_list().  That's what this patch adds.

Files: lib.c (+17/-0), lib.h (+1/-0)
--------------------------------------------------------------------------------

[783f8bcce048] 2005-04-07 21:01:04 -0700
Author: Arnaldo Carvalho de Melo <acme@parisc.kerneljanitors.org>
Subject: o create create_builtin_stream

Moving the common builtin stream creation to lib.c

Files: check.c (+1/-16), lib.c (+20/-0), lib.h (+2/-0), test-parsing.c (+1/-3)
--------------------------------------------------------------------------------

[795df34616b7] 2005-04-07 21:01:03 -0700
Author: Arnaldo Carvalho de Melo <acme@parisc.kerneljanitors.org>
Subject: o move add_pre_buffer, handle_switch and friends to lib.c

This way we can reuse this thing on the utilities, this time check and
test-parsing are the ones using it.

Files: check.c (+0/-69), lib.c (+73/-1), lib.h (+8/-0), test-parsing.c (+8/-52)
--------------------------------------------------------------------------------

[4622a094643f] 2005-04-07 21:01:03 -0700
Author: Dave Olien <dmo@osdl.org>
Subject: [PATCH] Make sparse understand complex initializers inside expressions

This patch makes a cast expression followed by an initializer list into
a postfix expression that can be dereferenced as a structure or an array.
There are approximately 7 instances of these expressions in the Linux kernel,
that give warnings about "expected lvalue for member dereference".

The approach involved introducing a new "stack-based temporary" symbol
of the same type as the cast expression, and using this as the target
of the initialization expression.  The subsequent array or structure
member dereferences are made to that temporary symbol.

show-parse.c need modification to display a symbol expression with
an initializer list that is NOT in a symbol declaration list.

An example of this form with structure member dereference is:

    typedef struct { long t1; long t2; long t3; } longstruct_t;

    long test;

    int
    main(void)
    {
	int a, b, c;

	test = (longstruct_t){a, b, c}.t3;
	return 0;
    }

An example of this form with array member dereference is:

    typedef int iarray[2];
    int pgp;

    main(void)
    {
	int index;
	int a, b;

	pgp = (iarray){a,b}[index];
    }

Files: evaluate.c (+18/-1), expression.c (+17/-6), show-parse.c (+10/-1)
--------------------------------------------------------------------------------

[33145bbb99c1] 2005-04-07 21:01:03 -0700
Author: Christopher Li <chrisl@vmware.com>
Subject: [PATCH] print out the function which causes errors

This fixes a bug in adding white space in macro expanding, which cause
drivers/atm/ambassador.c complain about include file not found and stop
the make.

The offensive macro is that

  #define UCODE(x) UCODE2(atmsar11.x)
  #define UCODE2(x) #x
  UCODE(start)

It will expand to "atmsar11 . start" instead of "atmsar11.start"

Files: pre-process.c (+7/-7)
--------------------------------------------------------------------------------

[ef904faf89d2] 2005-04-07 21:01:03 -0700
Author: Christopher Li <chrisl@vmware.com>
Subject: [PATCH] support __VA_ARGS__ variable macro arguments

This adds support support for variable macro arguments:

  #define msg(fmt, ...) printf(fmt, __VA_ARGS__)
  #define msg(fmt, arg...) printf(fmt, arg)

make ARCH=um will hit that kind of macros.

Files: pre-process.c (+22/-7), symbol.c (+11/-1), symbol.h (+4/-0)
--------------------------------------------------------------------------------

[a644d4fdb749] 2005-04-07 21:01:02 -0700
Author: Christopher Li <chrisl@vmware.com>
Subject: [PATCH] print out name of function which causes errors

[Auto-summary] Modifies 2 source files: evaluate.c, pre-process.c. Changes: +8/-4 in 2 file(s)

Files: evaluate.c (+6/-3), pre-process.c (+2/-1)
--------------------------------------------------------------------------------

[9cb58fff8a81] 2005-04-07 21:01:02 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Allow DOS-style '\r' characters in the input files.

Complain about non-ASCII behaviour if the sequence isn't
the normal '\r\n'

Files: tokenize.c (+15/-1)
--------------------------------------------------------------------------------

[6e8c9f2d3e0d] 2005-04-07 21:01:02 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Check for NULL pointers after having peeled off the SYM node when checking for type differences

Noted by Christoper Li.

Files: evaluate.c (+6/-0)
--------------------------------------------------------------------------------

[41536e4127f7] 2005-04-07 21:01:01 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Make the default install directory be $(HOME)/bin instead of /usr/local/bin

[Auto-summary] Modifies build system. Changes: +1/-1 in 1 file(s)

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[f1b667d4e39d] 2005-04-07 21:01:01 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Disable premature dead code removal: a block that is unreachable from the top might still be reachable through a label inside of it.

[Auto-summary] Modifies 2 source files: expand.c, show-parse.c. Changes: +11/-4 in 2 file(s)

Files: expand.c (+3/-0), show-parse.c (+8/-4)
--------------------------------------------------------------------------------

[f02b6adcd057] 2005-04-07 21:01:01 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Add a note in the readme about the fact that we now do a five- phase parse: the last phase is the inline function expansion and the tree simplification.

[Auto-summary] Updates documentation. Changes: +2/-1 in 1 file(s)

Files: README (+2/-1)
--------------------------------------------------------------------------------

[5c5cdbc5d478] 2005-04-07 21:01:01 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Update copyright notices to reflect the fact that Transmeta isn't the sole copyright owner these days.

[Auto-summary] Modifies 15 source files: check.c, evaluate.c, expand.c and 12 more. Updates 6 headers. Changes: +24/-3 in 22 file(s)

Files: LICENSE (+3/-3), check.c (+1/-0), evaluate.c (+1/-0), expand.c (+1/-0), expression.c (+1/-0), ... and 17 more
--------------------------------------------------------------------------------

[bdfb7140eaa2] 2005-04-07 21:01:00 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: More conversion from "iterate()" to an explicit FOR_EACH_PTR() loop.

In particular, this cleans up the compound statement return
type handling a lot. It's just a lot more obvious with the
straigth loop, and no indirection through an iterator function.

Files: evaluate.c (+22/-17), scope.c (+5/-2)
--------------------------------------------------------------------------------

[09ff8b4f71fe] 2005-04-07 21:01:00 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Start migrating the last straggling users of the "iterate()" function call interface over to the much more readable FOR_EACH_PTR() approach. No need for silly one-line iterator functions.

[Auto-summary] Modifies expand.c. Changes: +10/-12 in 1 file(s)

Files: expand.c (+10/-12)
--------------------------------------------------------------------------------

[6dfe359777b8] 2005-04-07 21:01:00 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Add a test for '##' handling from the kernel sources, which we get badly wrong (it's used by pcinames.c).

[Auto-summary] Adds/updates 1 test(s). Changes: +25/-0 in 1 file(s)

Files: validation/preprocessor6.c (+25/-0)
--------------------------------------------------------------------------------

[353456dc28f3] 2005-04-07 21:01:00 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Imrpove warning message for failed member name lookup.

[Auto-summary] Modifies evaluate.c. Changes: +9/-1 in 1 file(s)

Files: evaluate.c (+9/-1)
--------------------------------------------------------------------------------

[69fc106c8ef3] 2005-04-07 21:00:59 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Make the tokenizer recognize FP tokens, even if we don't actually handle them correctly later on yet.

[Auto-summary] Modifies 2 source files: expression.c, tokenize.c. Changes: +49/-2 in 2 file(s)

Files: expression.c (+5/-1), tokenize.c (+44/-1)
--------------------------------------------------------------------------------

[7da90b157ff1] 2005-04-07 21:00:59 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Cast evaluation is special: we want to simplify the cast early in order to see NULL pointer expressions immediately.

We want NULL pointers to be visible as such at type check time,
long before we do the full expansion/simplification phase.

A NULL pointer is a weaker type than a normal (void *), since
it has no context or address space associated with it, for example.

Files: evaluate.c (+9/-0), expand.c (+2/-2), expression.h (+4/-0)
--------------------------------------------------------------------------------

[07cb5ff53b8c] 2005-04-07 21:00:59 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Fix degenerate types for array/fn expressions. We used to calculate the ctype right, but we didn't replace the expression correctly. We need to create a new expression that has the proper type _and_ value.

This fixes a lot of bogus warnings in the kernel check.

Files: evaluate.c (+4/-2)
--------------------------------------------------------------------------------

[867a48ac4b54] 2005-04-07 21:00:58 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Add a type checking validation test-case that shows some of the current brokenness in type generation and checking.

Run

	./check validation/type1.c

to see these totally bogus error messages:

	warning: validation/type1.c:23:15: incorrect type in initializer (different base types)
	warning: validation/type1.c:23:15:   expected char const *s
	warning: validation/type1.c:23:15:   got struct hello *arg

This bug causes several bogus warnings in the kernel.

Files: validation/type1.c (+24/-0)
--------------------------------------------------------------------------------

[6e3bed4e8a22] 2005-04-07 21:00:58 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: You can use a typedef as a variable name or a struct/union member name. So instead of considering it "mixing of types", just break the type lookup at that point.

[Auto-summary] Modifies parse.c. Changes: +2/-4 in 1 file(s)

Files: parse.c (+2/-4)
--------------------------------------------------------------------------------

[9e89cc93353b] 2005-04-07 21:00:58 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Fix RESET_PTR_LIST() implementation: we forgot to actually reset the __list##ptr variable, causing bogus failures in the named initializer lookup.

[Auto-summary] Updates header lib.h. Changes: +1/-0 in 1 file(s)

Files: lib.h (+1/-0)
--------------------------------------------------------------------------------

[4e61251e51a9] 2005-04-07 21:00:58 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Make the "unknown named initializer" error message a bit more informative by adding _which_ initializer we had trouble finding.

[Auto-summary] Modifies evaluate.c. Changes: +1/-1 in 1 file(s)

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[6ce4defc3968] 2005-04-07 21:00:57 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Fix up function inlining:  - it only happens at evaluate time  - it akes the new context be the "superset" of    the context of the inliner and inlinee.

[Auto-summary] Modifies 2 source files: evaluate.c, expand.c. Changes: +9/-8 in 2 file(s)

Files: evaluate.c (+9/-5), expand.c (+0/-3)
--------------------------------------------------------------------------------

[1f07cf3927dd] 2005-04-07 21:00:57 -0700
Author: Dave Olien <dmo@osdl.org>
Subject: [PATCH] sparse function pointer arguments now accept void pointers

This patch eliminates warnings of the form:

	incorrect type in argument 1 (different base types)

from code of the form:

	#define VPTR	((void *)1)

	void f( int (g)(void))
	{
	}

	int
	main(void)
	{
		f(VPTR);
		f(0);
	}

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[f04115945169] 2005-04-07 21:00:57 -0700
Author: Dave Olien <dmo@osdl.org>
Subject: [PATCH] sparse conditional expression evaluation fix

This patch eliminates the warning:

	incompatible types in conditional expression (different types)

from conditional expressions involving (void *) in the true or false expressions.
Example code that now evalutes without warning:

	-------------------------------------------------

	#define VPTR ((void *)1)

	int i;

	main(void)
	{
		int *x, *y;

		x = 1 ? &i : VPTR;
		y = 1 ? VPTR : &i;
	}

	-------------------------------------------------

	#define VPTR ((void *)1)

	struct blah {
		int blah_int;
	};

	struct blah *bp;

	main(void)
	{
		struct blah *x, *y;

		x = 1 ? bp : VPTR;
		y = 1 ? VPTR : bp;
	}

	---------------------------------------------

Files: evaluate.c (+8/-2)
--------------------------------------------------------------------------------

[37315604371a] 2005-04-07 21:00:57 -0700
Author: Dave Olien <dmo@osdl.org>
Subject: [PATCH] sparse patch for typeless functions

This fixes two related problems, resulting from the (I think good) decision to
not support the old K&R defaulting of function types to integer.

1. The following C code causes the check program to segment fault.

main(void)
{
	return 1;
}

	The segment fault is in the function "compatible_integer_types"
	because the ltype arument is NULL.  The patch below fixes
	evaluate_return_expression() to deal with the NULL function type
	symbol pointer.

2. This fix also eliminates warnings for function declarations like this:

main(void)
{
	return;
}

	This used to produce the warning:

		warning: m3.c:3:2: return with no return value

an alternative fix would be to insist that function declarations have
SOME type.. a void type at least.

Files: evaluate.c (+2/-2)
--------------------------------------------------------------------------------

[95e1e20937a4] 2005-04-07 21:00:56 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: More preprocessor validation tests from comp.std.c.

One is interesting (preprocessor3.c), and we get it wrong.

Surprise surprise.

Files: validation/preprocessor3.c (+37/-0), validation/preprocessor4.c (+10/-0), validation/preprocessor5.c (+9/-0)
--------------------------------------------------------------------------------

[10e9653b49d8] 2005-04-07 21:00:56 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Add two preprocessor test-cases from comp.std.c.

We actually pass one of them, surprise surprise.

I should add a few more that highlight the known
problems in token pasting etc, but I'm lazy. The
C preprocessor is a bitch.

Files: validation/preprocessor1.c (+14/-0), validation/preprocessor2.c (+15/-0)
--------------------------------------------------------------------------------

[8d121d51b6f8] 2005-04-07 21:00:56 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Split tree evaluation into two phases: the first phase does type evaluation, the second one does value evaluation and inline expansion.

This has the advantage that by the time we do value evaluation
and inline expansion, we have traversed the tree fully once,
which allows us to take advantage of function-global information,
ie we know whether symbols have ever been accessed etc.

Files: Makefile (+1/-1), check.c (+1/-0), evaluate.c (+13/-225), expand.c (+609/-0), expression.h (+2/-0), ... and 3 more
--------------------------------------------------------------------------------

[06231a22afbb] 2005-04-07 21:00:55 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Now that inlining works, make the return handling work properly too, ie make sure that we don't just go to the right place, but that we also assign the return value to the return variable, and we make inline functions evaluate properly to the value.

[Auto-summary] Modifies 3 source files: evaluate.c, parse.c, show-parse.c. Changes: +51/-30 in 3 file(s)

Files: evaluate.c (+6/-2), parse.c (+4/-1), show-parse.c (+41/-27)
--------------------------------------------------------------------------------

[bca6859f6ede] 2005-04-07 21:00:55 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: Oops. The argument symbol initializers got lost on inlining, because we didn't add them to the list of statement symbols.

[Auto-summary] Modifies inline.c. Changes: +1/-0 in 1 file(s)

Files: inline.c (+1/-0)
--------------------------------------------------------------------------------

[8320d062d51e] 2005-04-07 21:00:55 -0700
Author: Linus Torvalds <torvalds@home.osdl.org>
Subject: This makes function inlining largely work correctly. In order to get all the symbol replacement stuff right, we just build a per-function list of all the symbols associated with a function (except for arguments, which are special anyway due to the site-specific initializers).

When we inline, we then create the replacement symbols up front,
which makes it trivial to replace them as needed. This means that
we get all the special symbols (return targets etc) automatically
right.

Also fix a few problems with builtin symbols that were uncovered
by the inliner when running over the kernel sources.

Files: inline.c (+75/-50), parse.c (+23/-2), symbol.c (+3/-1)
--------------------------------------------------------------------------------

[8a4c123b5756] 2005-04-07 21:00:55 -0700
Author: Dave Olien <dmo@osdl.org>
Subject: [PATCH] allow casts as lvalues

This makes sparse accept the gcc "cast as lvalue" extension.

The parse tree ends up being dubious, but from a kernel checking
standpoint this avoids a few unnecessary warnings.

Files: evaluate.c (+2/-0)
--------------------------------------------------------------------------------

[79ebcc247b65] 2005-04-07 21:00:54 -0700
Author: Dave Olien <dmo@osdl.org>
Subject: [PATCH] another minor sparse change adding opnames.

Add more operations to the name list.  Without these additions,
the "and" operator is displayed as a null pointer.

In the original code, the "&" operator was within the name[] array,
but didnt' have a string assigned to it.  So printf() displayed it as
the string "null".  While I was at it, I added other operation names to
the table.

Files: show-parse.c (+2/-1)
--------------------------------------------------------------------------------

[d36c1c2bd4e0] 2005-04-07 21:00:54 -0700
Author: Dave Olien <dmo@osdl.org>
Subject: [PATCH] minor sparse change fixing a typo

This patch fixes a one-character typo in evaluating SPECIAL_OR_ASSIGN.

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[1bcc92138dcd] 2005-04-07 21:00:54 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Do a proper scope allocator, don't use the "bytes" allocator that doesn't have any alignment guarantees.

[Auto-summary] Modifies 2 source files: lib.c, scope.c. Updates header lib.h. Changes: +5/-2 in 3 file(s)

Files: lib.c (+3/-1), lib.h (+1/-0), scope.c (+1/-1)
--------------------------------------------------------------------------------

[f40c00a25222] 2005-04-07 21:00:53 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix case statement inlining. At least partly.

[Auto-summary] Modifies inline.c. Changes: +4/-8 in 1 file(s)

Files: inline.c (+4/-8)
--------------------------------------------------------------------------------

[16d5b4bc2ffe] 2005-04-07 21:00:53 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Flesh out inlining some more.

We still don't copy all symbols correctly, in particular branch
target symbols (ie labels, case targets etc).l

Files: inline.c (+72/-19)
--------------------------------------------------------------------------------

[096f85e4aaca] 2005-04-07 21:00:53 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix a nonchecked (and much too small) nesting level limit.

[Auto-summary] Modifies pre-process.c. Changes: +4/-2 in 1 file(s)

Files: pre-process.c (+4/-2)
--------------------------------------------------------------------------------

[b71b05cdc93e] 2005-04-07 21:00:53 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make it easier to add extra libraries (eg add a "-lefence" thing for allocation checking etc).

[Auto-summary] Modifies build system. Changes: +5/-4 in 1 file(s)

Files: Makefile (+5/-4)
--------------------------------------------------------------------------------

[b020fece6e9b] 2005-04-07 21:00:52 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Clean up function inlining some, and fix the type of the argument symbols that got corrupted by the incorrect partial symbol copy when creating the new argument symbols.

[Auto-summary] Modifies 2 source files: evaluate.c, inline.c. Updates header parse.h. Changes: +80/-62 in 3 file(s)

Files: evaluate.c (+8/-58), inline.c (+71/-4), parse.h (+1/-0)
--------------------------------------------------------------------------------

[6615981184a9] 2005-04-07 21:00:52 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make the statement copying slightly more complete, to get more coverage.

Much still not implemented.

Files: inline.c (+105/-9)
--------------------------------------------------------------------------------

[42ebe65d4fbf] 2005-04-07 21:00:52 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add "-v" flag for verbose mode.

Warn about internal "not implemented yet" kinds of things only
when verbose. These warnings have nothing to do with the sources
we're checking, they're only good for pointing out limitations
of sparse itself.

Files: check.c (+3/-1), inline.c (+2/-1), pre-process.c (+1/-0), token.h (+1/-1)
--------------------------------------------------------------------------------

[33d6edbdc44d] 2005-04-07 21:00:51 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Install the kernel source checker as "sparse" in /usr/local/bin.

Calling it "check" is just too generic a name if we install it
somewhere global.

Files: Makefile (+9/-0)
--------------------------------------------------------------------------------

[faf1db90d395] 2005-04-07 21:00:51 -0700
Author: Dave Olien <dmo@osdl.org>
Subject: [PATCH] sparse type checking on function pointers

This patch fixes type checking on function arguments that are pointers
to functions.  We're supposed to be able to mix functions and function
pointers interchangably.

Files: evaluate.c (+11/-0)
--------------------------------------------------------------------------------

[2e47ece69eb3] 2005-04-07 21:00:51 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add cheesy C++-like "const variable" evaluation. It's not C, but it _should_ be

Make beginnings of a statement copier, to start testing trival
inline function replacement. 

The return symbol replacement doesn't work, but the theory is
there.

NOTE! I'm getting more and more convinced that the symbol replacement
is a bad idea, and is should be doable some other way (ie by looking
up symbols at _evaluation_ time rather than having to switch them around
when inlining).

Files: evaluate.c (+11/-0), inline.c (+30/-2)
--------------------------------------------------------------------------------

[0bd178e42793] 2005-04-07 21:00:51 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Start doing real expression copying for the inliner. We need to replace the symbols encounterd durign an expression copy, and this is the first step showing how.

This doesn't get the multi-level inlining right, we'll get there
some day. Also, it currently complains about subexpressions it can't
copy yet, causing way too much verbosity for the kernel.

Files: inline.c (+108/-2), show-parse.c (+1/-1), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[faccc8f14eab] 2005-04-07 21:00:50 -0700
Author: Ryan Anderson <ryan@michonline.com>
Subject: [PATCH] Use $(CC) consistently throughout the Makefile

This patch makes compilation of sparse use the correct version of gcc
throughout.  (It doesn't seem to have caused any problems, but the
current situation isn't strictly correct, so...)

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[5528ae996c02] 2005-04-07 21:00:50 -0700
Author: Ryan Anderson <ryan@michonline.com>
Subject: [PATCH] Make all the anonymous structures truly anonymous

This patch removes the type-names on the anonymous structures.  This
fixes compilation when using gcc-3.3 (Debian).  Credit for identifying
the fix goes to Arnaldo Carvalho de Melo <acme@conectiva.com.br>.

Files: expression.h (+10/-10), parse.h (+9/-9), symbol.h (+2/-2)
--------------------------------------------------------------------------------

[8642a0b9da3e] 2005-04-07 21:00:50 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Create "inline.c", which contains the function "copy_statement()", used for inlining. Right now the copying is totally broken, since we don't actually do any symbol replacement, but hey, we'll get there some day.

Make "inline_function()" call the new copy_statement() function.

Files: Makefile (+1/-1), evaluate.c (+13/-6), inline.c (+43/-0), parse.h (+1/-0)
--------------------------------------------------------------------------------

[0caa57484e2a] 2005-04-07 21:00:49 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Get rid of "#pragma" lines for now, while still keeping a path to eventually start parsing them.

Basic approach: we'll replace the pragma line with some kind
of internal attribute-looking thing for the front end.

Files: check.c (+1/-0), pre-process.c (+26/-0), show-parse.c (+2/-1), symbol.c (+3/-0), symbol.h (+2/-1)
--------------------------------------------------------------------------------

[13ae3d014537] 2005-04-07 21:00:49 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Cleanup: factor out function body parsing into a function of its own.

Make the argument declaration use a proper iterator loop, instead of
the old "symbol_iterate()" function pointer thing.

Files: parse.c (+34/-24)
--------------------------------------------------------------------------------

[b336a1038767] 2005-04-07 21:00:49 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Start doing inline function expansion.

NOTE! We only expand the arguments right now, we don't actually
do the body of the function itself. It's a start, though.

Files: evaluate.c (+50/-1), show-parse.c (+1/-1)
--------------------------------------------------------------------------------

[a079d8d5037a] 2005-04-07 21:00:49 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Handle more attributes now that we warn about stuff we don't recognize. Most of them we just throw away, but we'll eventually need to properly save away the information in the type.

[Auto-summary] Modifies parse.c. Changes: +25/-3 in 1 file(s)

Files: parse.c (+25/-3)
--------------------------------------------------------------------------------

[fb494df61aed] 2005-04-07 21:00:48 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix type warning.

[Auto-summary] Modifies show-parse.c. Changes: +1/-1 in 1 file(s)

Files: show-parse.c (+1/-1)
--------------------------------------------------------------------------------

[96d59197279d] 2005-04-07 21:00:48 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Peter Jones informs about the gcc "attribute((aligned))" behaviour:

"The compiler automatically sets the alignment for the
	 declared variable or field to the largest alignment which
	 is ever used for any data type on the target machine you
	 are compiling for"

So add the proper define to "target.h" and make it so.

Files: parse.c (+5/-3), show-parse.c (+4/-1), target.h (+5/-0)
--------------------------------------------------------------------------------

[9a13de1b8f55] 2005-04-07 21:00:48 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Give better warnings for attribute mis-parses.

[Auto-summary] Modifies parse.c. Changes: +19/-12 in 1 file(s)

Files: parse.c (+19/-12)
--------------------------------------------------------------------------------

[047821f7db2a] 2005-04-07 21:00:47 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make function returns a bit more realistic

[Auto-summary] Modifies 2 source files: parse.c, show-parse.c. Updates header parse.h. Changes: +52/-10 in 3 file(s)

Files: parse.c (+42/-8), parse.h (+5/-0), show-parse.c (+5/-2)
--------------------------------------------------------------------------------

[32dc632cf37e] 2005-04-07 21:00:47 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Simplify if-statements without even evaluating the false side for compile-time constant conditionals.

This allows inline functions and macros to do "illegal" things,
as long as it's compile-time deterministic that they aren't done.

Files: evaluate.c (+33/-3), parse.h (+0/-1), show-parse.c (+0/-1)
--------------------------------------------------------------------------------

[9f7a01889117] 2005-04-07 21:00:47 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Don't try to give typdefs storage bits.

[Auto-summary] Modifies 2 source files: parse.c, symbol.c. Changes: +8/-1 in 2 file(s)

Files: parse.c (+7/-0), symbol.c (+1/-1)
--------------------------------------------------------------------------------

[78bdeb55cf57] 2005-04-07 21:00:47 -0700
Author: Dave Olien <dmo@osdl.org>
Subject: [PATCH] escape character extension

I added cases for the escape characters that show up in the 2.5.x kernel
sources.

One particular case (\<newline>), is a little more interesting.

This is different from the other cases because the \<newline> character
should never appear in the parsed string.

As a first fix, I've made escapechar() call itself recursively.  One
flaw with this fix is that escapechar() will mark the first character on
the second line of the input string as "escaped":

	/* Mark it as escaped */
	value |= 0x100;

but none of the callers to escapechar() ever use or preserve this
information, so it might as well be dropped altogether or at least
ignored for now.

Files: tokenize.c (+23/-2)
--------------------------------------------------------------------------------

[71a32f859d31] 2005-04-07 21:00:46 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: MOD_TOPLEVEL is storage information, and shouldn't percolate through typedefs.

[Auto-summary] Updates header symbol.h. Changes: +1/-1 in 1 file(s)

Files: symbol.h (+1/-1)
--------------------------------------------------------------------------------

[48e11ec6a059] 2005-04-07 21:00:46 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Define __STDC__ to let sources know we want proper ANSI C prototypes.

[Auto-summary] Modifies check.c. Changes: +1/-0 in 1 file(s)

Files: check.c (+1/-0)
--------------------------------------------------------------------------------

[3b4bc2e86a67] 2005-04-07 21:00:46 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Don't ask about logging, the automatic checkin tools don't like that.

[Auto-summary] No file changes detected.

--------------------------------------------------------------------------------

[53929c981450] 2005-04-07 21:00:46 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Check whether a parameter declaration is a type before trying to parse it as a type.

[Auto-summary] Modifies parse.c. Changes: +4/-0 in 1 file(s)

Files: parse.c (+4/-0)
--------------------------------------------------------------------------------

[a2a8b9030ee0] 2005-04-07 21:00:45 -0700
Author: Ryan Anderson <ryan@michonline.com>
Subject: [PATCH] Get gcc internal header files path from gcc itself

This update (hopefully) will allow 'check' to find the appropriate, gcc-local
include headers (dependent, of course, upon the system it was built on)

It's still a hack, but at least it will work in a few more places.

Files: Makefile (+5/-2), pre-process.c (+2/-2)
--------------------------------------------------------------------------------

[bb5b108c342b] 2005-04-07 21:00:45 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix enums. We can't turn _all_ enums into values, only the actual value symbols, of course.

Make the enum symbols have the SYM_ENUM type, and check that properly
at evaluate time (instead of checking the base type, which will be
an enum for regular enum variables too, of course).

Files: evaluate.c (+2/-1), parse.c (+1/-1)
--------------------------------------------------------------------------------

[a10932174ca4] 2005-04-07 21:00:45 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Parse and evaluate gcc computed goto extensions: label addressing (&&label) and computed goto (goto *expr).

Add label ctype for __label__ identifier. This is still quite broken
(it should create a block-symbol in the NS_LABEL namespace, right now
it creates a regular symbol).

Files: evaluate.c (+4/-0), expression.c (+10/-0), expression.h (+5/-0), parse.c (+8/-5), parse.h (+1/-0), ... and 3 more
--------------------------------------------------------------------------------

[e5b62a635d5a] 2005-04-07 21:00:44 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix include path ordering - check for local paths when given a string name, while <xxxx.h> searches only the path.

[Auto-summary] Modifies pre-process.c. Changes: +16/-16 in 1 file(s)

Files: pre-process.c (+16/-16)
--------------------------------------------------------------------------------

[ea302f98a5df] 2005-04-07 21:00:44 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Print out the rigth filename when an open fails..

[Auto-summary] Modifies check.c. Changes: +1/-1 in 1 file(s)

Files: check.c (+1/-1)
--------------------------------------------------------------------------------

[e076739b4e9e] 2005-04-07 21:00:44 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Merge penguin:src/parser into home.transmeta.com:/home/torvalds/parser

[Auto-summary] Modifies check.c. Changes: +26/-0 in 1 file(s)

Files: check.c (+26/-0)
--------------------------------------------------------------------------------

[8e6e2b4771b6] 2005-04-07 21:00:44 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Add a rudimentary "-E" flag handling to check.c.

[Auto-summary] Modifies check.c. Changes: +26/-0 in 1 file(s)

Files: check.c (+26/-0)
--------------------------------------------------------------------------------

[fd9901595d5a] 2005-04-07 21:00:43 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Define a few more automatic defines that the kernel expects.

Too many kernel files depend on silent compiler magic, for
example "defined(__i386__)" instead of "defined(CONFIG_X86)".

Files: check.c (+2/-0)
--------------------------------------------------------------------------------

[47fda3472065] 2005-04-07 21:00:43 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Gahh... I really need to revisit the expansion recursion avoidance.

In the meantime this fixes some of it. The pre-processor is still a
horrible mess.

Files: pre-process.c (+4/-2)
--------------------------------------------------------------------------------

[28fb2a821860] 2005-04-07 21:00:43 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Stupid pre-processor bug #6981: Don't avoid recursively expanding the arguments, just the macro body. Otherwise a simple

#define A(x) xx(x)
	A(A(x))

would decide that the "inner" A(x) was a recursive expansion.

Files: pre-process.c (+2/-2)
--------------------------------------------------------------------------------

[329a0557d173] 2005-04-07 21:00:43 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Remove the __builtin_constant_p() #define from check.c, since we now handle it natively.

[Auto-summary] Modifies check.c. Changes: +0/-1 in 1 file(s)

Files: check.c (+0/-1)
--------------------------------------------------------------------------------

[e1e2db5bb75e] 2005-04-07 21:00:42 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Fxi up the builtin function evaluation. We really just want to return a success marker for it.

[Auto-summary] Modifies 2 source files: evaluate.c, symbol.c. Updates header symbol.h. Changes: +10/-10 in 3 file(s)

Files: evaluate.c (+6/-6), symbol.c (+3/-3), symbol.h (+1/-1)
--------------------------------------------------------------------------------

[84c9339ec6e5] 2005-04-07 21:00:42 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Add support for evaluating builtin functions at compile time.

This should also do the inline function expansion, but we still
don't do that. For now we just do the "__builtin_constant_p()"
as the only such function. We'll expand the repertoire some day.

Files: evaluate.c (+34/-12), symbol.c (+40/-4), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[920bc36ceb09] 2005-04-07 21:00:42 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Parse C99 style 'for()' statements with variable declarations.

[Auto-summary] Modifies 2 source files: parse.c, show-parse.c. Updates header parse.h. Changes: +25/-10 in 3 file(s)

Files: parse.c (+13/-4), parse.h (+1/-0), show-parse.c (+11/-6)
--------------------------------------------------------------------------------

[884c94a9358d] 2005-04-07 21:00:42 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Clean up for/while/do parsing by separating them out into functions of their own. This will make the C99 'for' syntax handling cleaner.

Make 'statement()' static to parse.c.

Files: parse.c (+71/-54)
--------------------------------------------------------------------------------

[6b459e1b9ac8] 2005-04-07 21:00:41 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Fix silly switch printout bug - the "break" label should obviously be _after_ the switch statements, not before ;-)

[Auto-summary] Modifies show-parse.c. Changes: +2/-1 in 1 file(s)

Files: show-parse.c (+2/-1)
--------------------------------------------------------------------------------

[12937419faf5] 2005-04-07 21:00:41 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make the switch case table printout look prettier and more readable (it's really indexed by the case value, not the label value, so make that part more intuitive)

[Auto-summary] Modifies show-parse.c. Changes: +6/-6 in 1 file(s)

Files: show-parse.c (+6/-6)
--------------------------------------------------------------------------------

[ec69546dc4d1] 2005-04-07 21:00:41 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix switch/case statement show-parse.

[Auto-summary] Modifies 2 source files: parse.c, show-parse.c. Updates header parse.h. Changes: +19/-16 in 3 file(s)

Files: parse.c (+1/-0), parse.h (+1/-0), show-parse.c (+17/-16)
--------------------------------------------------------------------------------

[143649c46781] 2005-04-07 21:00:40 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add current directory to search path.

[Auto-summary] Modifies pre-process.c. Changes: +4/-0 in 1 file(s)

Files: pre-process.c (+4/-0)
--------------------------------------------------------------------------------

[ad845930e3c3] 2005-04-07 21:00:40 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Add a backend generic pointer to the symbol. Not that anything uses it yet, but it's clearly the rigth thing to do.

[Auto-summary] Updates header symbol.h. Changes: +1/-0 in 1 file(s)

Files: symbol.h (+1/-0)
--------------------------------------------------------------------------------

[74a24e2685b5] 2005-04-07 21:00:40 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Show switch statements more sanely, one case at a time, instead of just having the cases magically show up as part of the statement list (which would get _very_ confusing from a nesting standpoint.

[Auto-summary] Modifies show-parse.c. Changes: +40/-10 in 1 file(s)

Files: show-parse.c (+40/-10)
--------------------------------------------------------------------------------

[840183b71338] 2005-04-07 21:00:40 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Add comments about special terator/switch statement symbols.

Add a "case" symbol for the switch statement, to let the
statement keep track of all the cases. This cleans up handling
a lot.

Files: parse.c (+51/-7), parse.h (+1/-1)
--------------------------------------------------------------------------------

[63760cd135dd] 2005-04-07 21:00:39 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Fix naming: "is_void_ptr()" did _not_ test for void pointers, but for NULL pointers (whether marked "void *" or not).

[Auto-summary] Modifies evaluate.c. Changes: +3/-3 in 1 file(s)

Files: evaluate.c (+3/-3)
--------------------------------------------------------------------------------

[c60cf00380bd] 2005-04-07 21:00:39 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make argument type differences show better error messages.

Make function calls check the context of the arguments against
the context of the callee (this is a quick hack).

Files: evaluate.c (+19/-7)
--------------------------------------------------------------------------------

[0e02ecf4e730] 2005-04-07 21:00:39 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Don't define __KERNEL__, since we now automatically get it right by virtue to getting the command line right.

[Auto-summary] Modifies check.c. Changes: +0/-1 in 1 file(s)

Files: check.c (+0/-1)
--------------------------------------------------------------------------------

[b8e6ac28d1bd] 2005-04-07 21:00:39 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Remove old hacks for getting kernel include directories right (for me). The command line options are now powerful enough to say all of this directly, and it's been integrated properly into the kernel build.

[Auto-summary] Modifies check.c. Changes: +0/-5 in 1 file(s)

Files: check.c (+0/-5)
--------------------------------------------------------------------------------

[5ee08e86ffb7] 2005-04-07 21:00:38 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Add pre-defined "builtin" support for some more gcc features that the kernel uses - fake stdarg handling, and buitin memcpy etc.

[Auto-summary] Modifies check.c. Changes: +5/-0 in 1 file(s)

Files: check.c (+5/-0)
--------------------------------------------------------------------------------

[42559238321e] 2005-04-07 21:00:38 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Avoid recursive expansion of tokens by keeping track of expansion parenthood. I desperately tried to avoid expanding the size of a token by using other means, but I couldn't fix the problems that led to.

The pre-processor is still a pile of crud and gets multi-token pasting
quite wrong (and probably other cases too). I should try to find some
test-suite, but I'm afraid of what it would find.

Files: pre-process.c (+38/-29), symbol.h (+0/-1), token.h (+1/-0)
--------------------------------------------------------------------------------

[9381db9433ad] 2005-04-07 21:00:38 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Don't bother with memset() on allocations, the chunking is supposed to guarantee zero memory anyway.

[Auto-summary] Modifies lib.c. Changes: +4/-7 in 1 file(s)

Files: lib.c (+4/-7)
--------------------------------------------------------------------------------

[223d9de8f4e0] 2005-04-07 21:00:38 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Check for duplicate symbol definitions only during declaration, not evaluation. We have nasty recursion issues otherwise.

[Auto-summary] Modifies 2 source files: check.c, evaluate.c. Updates header expression.h. Changes: +3/-3 in 3 file(s)

Files: check.c (+1/-0), evaluate.c (+1/-3), expression.h (+1/-0)
--------------------------------------------------------------------------------

[6fde1694fe67] 2005-04-07 21:00:37 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Add "__volatile" and "__volatile__" for gcc compatibility.

[Auto-summary] Modifies symbol.c. Changes: +2/-0 in 1 file(s)

Files: symbol.c (+2/-0)
--------------------------------------------------------------------------------

[342a4a416e28] 2005-04-07 21:00:37 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Fix (and simplify) handling of "defined()" in the preprocessor.

[Auto-summary] Modifies pre-process.c. Changes: +13/-19 in 1 file(s)

Files: pre-process.c (+13/-19)
--------------------------------------------------------------------------------

[a4fa3e907562] 2005-04-07 21:00:37 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Use the new factored-out include code to do proper include path handling. This also should get relative includes right.

[Auto-summary] Modifies pre-process.c. Changes: +50/-20 in 1 file(s)

Files: pre-process.c (+50/-20)
--------------------------------------------------------------------------------

[529679616e71] 2005-04-07 21:00:36 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Avoid warning. Define "__linux__", since the kernel ACPI headers depend on it.

[Auto-summary] Modifies check.c. Changes: +2/-0 in 1 file(s)

Files: check.c (+2/-0)
--------------------------------------------------------------------------------

[4208f8b2e89c] 2005-04-07 21:00:36 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Factor out the pre-processor include file handling a little bit, preparing for better include-path searching.

[Auto-summary] Modifies pre-process.c. Changes: +30/-17 in 1 file(s)

Files: pre-process.c (+30/-17)
--------------------------------------------------------------------------------

[cd2bb18c786f] 2005-04-07 21:00:36 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Don't warn about signedness for hax/octal constants. They are commonly used for bitfields where we really don't care.

[Auto-summary] Modifies expression.c. Changes: +7/-4 in 1 file(s)

Files: expression.c (+7/-4)
--------------------------------------------------------------------------------

[707f38c31eef] 2005-04-07 21:00:36 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make "check" a bit nicer about checking kernel files:  - define away __extension__  - pre-define "cond_syscall()" so that we don't get the gcc-specific one  - ignore unknown command line options so that we can use the gcc command line

[Auto-summary] Modifies check.c. Changes: +3/-2 in 1 file(s)

Files: check.c (+3/-2)
--------------------------------------------------------------------------------

[ad286dd0a379] 2005-04-07 21:00:35 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make "check" be able to take a "-include xxxx" command line switch.

[Auto-summary] Modifies check.c. Changes: +31/-9 in 1 file(s)

Files: check.c (+31/-9)
--------------------------------------------------------------------------------

[ea5c86f55e19] 2005-04-07 21:00:35 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Don't unnecessarily create position expressions for initializers that have zero offset.

Show initializers without positions properly.

Files: evaluate.c (+15/-5), show-parse.c (+24/-2)
--------------------------------------------------------------------------------

[3e6a86045378] 2005-04-07 21:00:35 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Arrays also degenerate in initializers, _except_ for the special case of

c[] = "string";

which is just shorthand for

	c[] = { 's', ... , '\0' };

and should be handled separately.

Files: evaluate.c (+5/-7)
--------------------------------------------------------------------------------

[e966e1154dd7] 2005-04-07 21:00:35 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make functions degenerate to function pointers, and fix the array degeneration too.

Check function arguments too when matching types.

Make assignment degenerate arrays and functions.

Files: evaluate.c (+41/-12), lib.h (+4/-2)
--------------------------------------------------------------------------------

[61608560eb5d] 2005-04-07 21:00:34 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Show argument types too when debugging symbols

[Auto-summary] Modifies show-parse.c. Changes: +12/-2 in 1 file(s)

Files: show-parse.c (+12/-2)
--------------------------------------------------------------------------------

[5eee86be00b6] 2005-04-07 21:00:34 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make the pre-processor search both 3.2.1 and 3.2.2 gcc header files.

[Auto-summary] Modifies pre-process.c. Changes: +2/-1 in 1 file(s)

Files: pre-process.c (+2/-1)
--------------------------------------------------------------------------------

[110f0b399eb0] 2005-04-07 21:00:34 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: The OSL is actually more readable in its original html (or pdf) format, so note the original location of the OSL license file, and clean up some whitespace issues that are the result of getting the flat-text version of the license.

[Auto-summary] Modifies: LICENSE. Changes: +19/-9 in 1 file(s)

Files: LICENSE (+19/-9)
--------------------------------------------------------------------------------

[7d788108c4b9] 2005-04-07 21:00:33 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make the example clients be under the OSL v1.1 too.

[Auto-summary] Modifies 3 source files: obfuscate.c, test-lexing.c, test-parsing.c. Changes: +9/-3 in 3 file(s)

Files: obfuscate.c (+3/-1), test-lexing.c (+3/-1), test-parsing.c (+3/-1)
--------------------------------------------------------------------------------

[51df763104bf] 2005-04-07 21:00:33 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Start updating the copyright license comments to the OSL, preparing for a public release.

[Auto-summary] Modifies 10 source files: check.c, evaluate.c, expression.c and 7 more. Updates 6 headers. Changes: +60/-18 in 16 file(s)

Files: check.c (+3/-1), evaluate.c (+3/-1), expression.c (+3/-1), expression.h (+3/-1), lib.c (+3/-1), ... and 11 more
--------------------------------------------------------------------------------

[ec781ad9e741] 2005-04-07 21:00:33 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make the library look more like a library, preparing for switch-over to public license.

From Jeff Garzik with modifications.

Files: Makefile (+32/-26)
--------------------------------------------------------------------------------

[a6be54372c56] 2005-04-07 21:00:33 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make the license file be the OSL v1.1 with explanation of front-end/back-end split.

[Auto-summary] Modifies: LICENSE. Changes: +180/-25 in 1 file(s)

Files: LICENSE (+180/-25)
--------------------------------------------------------------------------------

[296b36df80a7] 2005-04-07 21:00:32 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Evaluate initializer entry offsets, and add them back into the initializer expression list as EXPR_POS expressions so that a back-end can DTRT.

Show complex initializers now that we've calculated the offsets
of the expressions.

Files: evaluate.c (+18/-11), expression.h (+7/-0), show-parse.c (+40/-8)
--------------------------------------------------------------------------------

[34a5d7e27857] 2005-04-07 21:00:32 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Fix nested initializer evaluation (we should _not_ evaluate it as an expression, we should let the nested evaluator do that properly.

Make the warnings point more exactly to the sub-expression
that causes problems.

Files: evaluate.c (+4/-12)
--------------------------------------------------------------------------------

[edbc0968949f] 2005-04-07 21:00:32 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Evaluate structure and union initializers, including named ones.

Simplify PTR_LIST traversal, and add a RESET function

Files: evaluate.c (+42/-2), lib.h (+7/-1)
--------------------------------------------------------------------------------

[37c56b2bd1f6] 2005-04-07 21:00:31 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Peter points out that the type masking shifts can overflow if sizeof(long long) == sizeof(long) (and furter if it's also the same size as 'int', all perfectly legal C). Fix it by his suggestion.

[Auto-summary] Modifies expression.c. Changes: +2/-2 in 1 file(s)

Files: expression.c (+2/-2)
--------------------------------------------------------------------------------

[cc46ef1b775f] 2005-04-07 21:00:31 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Evaluate array initializers (type fixing and array index calculations).

[Auto-summary] Modifies 2 source files: evaluate.c, parse.c. Changes: +28/-19 in 2 file(s)

Files: evaluate.c (+26/-18), parse.c (+2/-1)
--------------------------------------------------------------------------------

[89afb737679f] 2005-04-07 21:00:31 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Print out the symbol name when we complain about re-declaring stuff with the wrong types..

[Auto-summary] Modifies evaluate.c. Changes: +2/-1 in 1 file(s)

Files: evaluate.c (+2/-1)
--------------------------------------------------------------------------------

[e682e79e682d] 2005-04-07 21:00:31 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Merge both node and array information at array degrade time.

This fixes the "lost modifier" problem.

Files: evaluate.c (+2/-1), symbol.c (+1/-1)
--------------------------------------------------------------------------------

[9dd90b995bb6] 2005-04-07 21:00:30 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Check for mismatched declarations using the new duplicate declarator stuff.

[Auto-summary] Modifies evaluate.c. Changes: +18/-0 in 1 file(s)

Files: evaluate.c (+18/-0)
--------------------------------------------------------------------------------

[4cf5c5abfa3e] 2005-04-07 21:00:30 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Don't show bad expression types.

[Auto-summary] Modifies show-parse.c. Changes: +1/-1 in 1 file(s)

Files: show-parse.c (+1/-1)
--------------------------------------------------------------------------------

[941fd98d9176] 2005-04-07 21:00:30 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Oops. Bad scoping for iterators and switch() statements. We didn't close the scope properly at the end (we started a new one instead).

Make all non-static functions external.

And always check the declarator against previous symbols when finding
a new symbol. We want to verify that we don't have duplicates.

Files: parse.c (+7/-4), scope.c (+1/-0), symbol.c (+18/-0), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[affb6d1c90f5] 2005-04-07 21:00:30 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Mark all function declarations automatically extern unless they are static.

[Auto-summary] Modifies parse.c. Changes: +9/-1 in 1 file(s)

Files: parse.c (+9/-1)
--------------------------------------------------------------------------------

[d70f36813308] 2005-04-07 21:00:29 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: The C type part and the preprocessor part of a symbol are supposed to be independent and could share the same storage. Right now that doesn't work, so just keep them separate and let "struct symbol" be a bit too large.

Will need to fix this later, there are lots of symbols around.

Files: symbol.h (+25/-23)
--------------------------------------------------------------------------------

[b988b72ee490] 2005-04-07 21:00:29 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Remove unused symbol list. We'll soon re-introduce it in another form, for doing same-id symbol type-checks.

[Auto-summary] Modifies show-parse.c. Updates header symbol.h. Changes: +0/-9 in 2 file(s)

Files: show-parse.c (+0/-8), symbol.h (+0/-1)
--------------------------------------------------------------------------------

[37a1ce6946c7] 2005-04-07 21:00:29 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make arrays properly degenerate even if they are preceded by symbol information.

Make the conditional expression properly degenerate its
operands.

Files: evaluate.c (+45/-34)
--------------------------------------------------------------------------------

[53df43313403] 2005-04-07 21:00:28 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Yeah, well... More typeof() tweaking.

[Auto-summary] Modifies 2 source files: evaluate.c, symbol.c. Changes: +4/-8 in 2 file(s)

Files: evaluate.c (+1/-1), symbol.c (+3/-7)
--------------------------------------------------------------------------------

[4be55be5f099] 2005-04-07 21:00:28 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Clean up silliness.

[Auto-summary] Modifies evaluate.c. Changes: +0/-1 in 1 file(s)

Files: evaluate.c (+0/-1)
--------------------------------------------------------------------------------

[0b48320cef18] 2005-04-07 21:00:28 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Whoops. More "typeof" confusion fixes.

[Auto-summary] Modifies symbol.c. Changes: +8/-7 in 1 file(s)

Files: symbol.c (+8/-7)
--------------------------------------------------------------------------------

[53a0adb26d70] 2005-04-07 21:00:27 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Fix type merging at dereference evaluation time.

Use the existing type merging function.

Files: evaluate.c (+4/-2), symbol.c (+1/-1), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[c906c75fc353] 2005-04-07 21:00:27 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make type warning messages more readable, and realize that bitfields are integers.

[Auto-summary] Modifies evaluate.c. Changes: +9/-17 in 1 file(s)

Files: evaluate.c (+9/-17)
--------------------------------------------------------------------------------

[7eabe30cb8a3] 2005-04-07 21:00:27 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Fix typeof() type evaluation. I hope.

[Auto-summary] Modifies symbol.c. Changes: +23/-3 in 1 file(s)

Files: symbol.c (+23/-3)
--------------------------------------------------------------------------------

[376facc6c4d0] 2005-04-07 21:00:27 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Get member access vs member pointer dereference types right.

[Auto-summary] Modifies evaluate.c. Changes: +9/-5 in 1 file(s)

Files: evaluate.c (+9/-5)
--------------------------------------------------------------------------------

[f227bb2f4220] 2005-04-07 21:00:26 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Ignore MOD_TOPLEVEL and other "internal" modifiers when doing type comparison.

[Auto-summary] Modifies evaluate.c. Changes: +2/-1 in 1 file(s)

Files: evaluate.c (+2/-1)
--------------------------------------------------------------------------------

[204fc9a1a62b] 2005-04-07 21:00:26 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make test-lexer output indentation.

[Auto-summary] Modifies test-lexing.c. Changes: +8/-3 in 1 file(s)

Files: test-lexing.c (+8/-3)
--------------------------------------------------------------------------------

[7474f28020c6] 2005-04-07 21:00:26 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Show expressions with no type as a separate typeless warning.

[Auto-summary] Modifies show-parse.c. Changes: +8/-0 in 1 file(s)

Files: show-parse.c (+8/-0)
--------------------------------------------------------------------------------

[1870c6a4c52f] 2005-04-07 21:00:26 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make string constants evaluate as a proper array dereference.

Make argument type checking say _which_ argument fails the
type check.

Files: evaluate.c (+23/-4)
--------------------------------------------------------------------------------

[e70d8c82896f] 2005-04-07 21:00:25 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: We should _not_ look at the node modifiers/address_space when we dereference it, since those are node-local.

[Auto-summary] Modifies evaluate.c. Changes: +6/-14 in 1 file(s)

Files: evaluate.c (+6/-14)
--------------------------------------------------------------------------------

[bbd57e999052] 2005-04-07 21:00:25 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make symbol addressing do something half-way sane.

[Auto-summary] Modifies 2 source files: show-parse.c, symbol.c. Updates header symbol.h. Changes: +12/-1 in 3 file(s)

Files: show-parse.c (+10/-1), symbol.c (+1/-0), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[631c80ee0e61] 2005-04-07 21:00:25 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Show switch- and case-statements in some half-way sane way. The pseudo-assembler is getting stranger by the minute.

[Auto-summary] Modifies show-parse.c. Changes: +10/-9 in 1 file(s)

Files: show-parse.c (+10/-9)
--------------------------------------------------------------------------------

[55aeb3022d36] 2005-04-07 21:00:25 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Show if/label/asm statements in a saner format.

Parse break-statements inside switch-statements correctly.

Rename break/continue symbols to make switch/iterator statements
have the same naming logic for the break targets.

Files: parse.c (+24/-3), parse.h (+3/-2), show-parse.c (+34/-18)
--------------------------------------------------------------------------------

[ce96e2585847] 2005-04-07 21:00:24 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Show iterators and goto's properly as pseudo-assembler.

[Auto-summary] Modifies 3 source files: parse.c, show-parse.c, symbol.c. Updates header symbol.h. Changes: +47/-42 in 4 file(s)

Files: parse.c (+3/-2), show-parse.c (+38/-38), symbol.c (+3/-1), symbol.h (+3/-1)
--------------------------------------------------------------------------------

[c5dd7c8e714f] 2005-04-07 21:00:24 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Turn 'break'/'continue' statements into goto's with per-iterator anonymous symbols.

Make arrays also gracefully degenerate into "void *".

Files: evaluate.c (+1/-3), parse.c (+34/-10), parse.h (+2/-2), show-parse.c (+5/-9), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[f9aed739613e] 2005-04-07 21:00:24 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Don't warn about dereferences to noderef pointers - we don't know yet if it will end up being a _real_ dereference (it might be undone by the addressof operator).

Make a failed argument evaluation fail the whole call evaluation - to
make sure that if we evaluate a call it will have been totally successful.

Make member dereference expression types get the full modifier state.

Files: evaluate.c (+7/-10)
--------------------------------------------------------------------------------

[d603439515ef] 2005-04-07 21:00:23 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Be much more careful about type evaluation for pointer addition, addressof and derefencing.

[Auto-summary] Modifies evaluate.c. Changes: +22/-14 in 1 file(s)

Files: evaluate.c (+22/-14)
--------------------------------------------------------------------------------

[7d1c59402918] 2005-04-07 21:00:23 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make symbol debugging print out the symbol address too.

[Auto-summary] Modifies show-parse.c. Changes: +3/-2 in 1 file(s)

Files: show-parse.c (+3/-2)
--------------------------------------------------------------------------------

[73ffafe8d93c] 2005-04-07 21:00:23 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Be more careful about checking for compatible pointer assignment types. Handle the automatic assignment from functions to function pointers.

[Auto-summary] Modifies evaluate.c. Changes: +27/-36 in 1 file(s)

Files: evaluate.c (+27/-36)
--------------------------------------------------------------------------------

[09da5ff21eba] 2005-04-07 21:00:22 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Don't make the 'void' type point to itself. It confuses the hell out of the debugging routines.

[Auto-summary] Modifies symbol.c. Changes: +1/-1 in 1 file(s)

Files: symbol.c (+1/-1)
--------------------------------------------------------------------------------

[113e16d5dc8a] 2005-04-07 21:00:22 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Fix up some address space evaluations. This is now already useful for checking kernel sources for address space violations, and has caused a few user/kernel type attributions to start springing up in the linux sources.

[Auto-summary] Modifies evaluate.c. Changes: +18/-6 in 1 file(s)

Files: evaluate.c (+18/-6)
--------------------------------------------------------------------------------

[1c3c2eabee5c] 2005-04-07 21:00:22 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Hardcode "check.c" with enough pre-defines to work with my kernel tree.

[Auto-summary] Modifies check.c. Changes: +13/-0 in 1 file(s)

Files: check.c (+13/-0)
--------------------------------------------------------------------------------

[2af5787110aa] 2005-04-07 21:00:22 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make type difference show size differences differently from the const/volatile modifier differences.

[Auto-summary] Modifies evaluate.c. Changes: +3/-1 in 1 file(s)

Files: evaluate.c (+3/-1)
--------------------------------------------------------------------------------

[4f92a0c83648] 2005-04-07 21:00:21 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Add "debug_symbol()" function that prints out the full symbol information for when type parsing gets too confusing.

[Auto-summary] Modifies show-parse.c. Updates header symbol.h. Changes: +27/-0 in 2 file(s)

Files: show-parse.c (+25/-0), symbol.h (+2/-0)
--------------------------------------------------------------------------------

[31707e9e01fa] 2005-04-07 21:00:21 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make sure that when we parse a pointer type, we properly move the current attributes to the target of the pointer (and clear them for the pointer itself).

[Auto-summary] Modifies parse.c. Changes: +6/-0 in 1 file(s)

Files: parse.c (+6/-0)
--------------------------------------------------------------------------------

[50c89ca0b56c] 2005-04-07 21:00:21 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Ignore sign differences for "same type". Make the type check return a description of the difference in types.

Make "addressof(symbol)" peel off the SYM_NODE, and put
the information in the pointer node instead.

Files: evaluate.c (+51/-37)
--------------------------------------------------------------------------------

[32ebb3c8c745] 2005-04-07 21:00:21 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Fix up type warnings to point to the right position.

Make "addressof" only take addressable arguments.

Files: evaluate.c (+8/-5)
--------------------------------------------------------------------------------

[019b5439328d] 2005-04-07 21:00:20 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix the direct-call case. A call is a direct call if the function expression is a pure symbol name (which will have been evaluated as a dereference of the symbol), where the symbol is of type SYM_FN.

Otherwise it's a function pointer expression and ends up
as an indirect call.

Files: show-parse.c (+18/-6)
--------------------------------------------------------------------------------

[2c2b583edd4e] 2005-04-07 21:00:20 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: This should fix a macro argument expansion problem - we mark the macro expander busy only oevr its own expansion, not the expansion of the arguments. That way the arguments can expand the same token again, without hitting the recursion limiter.

[Auto-summary] Modifies pre-process.c. Changes: +2/-2 in 1 file(s)

Files: pre-process.c (+2/-2)
--------------------------------------------------------------------------------

[b23fc8af8e70] 2005-04-07 21:00:20 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add "check" program that just evaluates the tree and does nothing else. This is useful to get warnings from the parser and type evaluator.

[Auto-summary] Modifies check.c. Modifies build system. Changes: +116/-1 in 2 file(s)

Files: Makefile (+4/-1), check.c (+112/-0)
--------------------------------------------------------------------------------

[80978796514d] 2005-04-07 21:00:20 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Mark inline functions as accessed when they get called. We should really expand them, but this is the stop-gap measure to make them show up on the "used" list.

[Auto-summary] Modifies evaluate.c. Changes: +9/-1 in 1 file(s)

Files: evaluate.c (+9/-1)
--------------------------------------------------------------------------------

[5c5a1976c174] 2005-04-07 21:00:19 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Clean up: mark local stuff 'static', and remove unused function.

Use the "used_list" to build up the symbol tree, so that we
automatically get new symbols that get discovered during
evaluation.

Files: expression.h (+0/-3), test-parsing.c (+6/-12)
--------------------------------------------------------------------------------

[bcf2e43315f7] 2005-04-07 21:00:19 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Mark a symbol as accessed if it's used during evaluation of the tree.

Add inline symbols to the "used_list" if they get marked as accessed.

Files: symbol.c (+19/-0), symbol.h (+6/-0)
--------------------------------------------------------------------------------

[29c908da161e] 2005-04-07 21:00:19 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Don't add inline functions to the top-level parse tree. They'll show up inside the parse tree if they are actually used.

[Auto-summary] Modifies 2 source files: parse.c, symbol.c. Changes: +5/-3 in 2 file(s)

Files: parse.c (+3/-2), symbol.c (+2/-1)
--------------------------------------------------------------------------------

[f5becbb76fbd] 2005-04-07 21:00:18 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make the initializer show routine output a dummy instead of being anal and warning. We want warnings to show real problems, not hide them by being too verbose.

[Auto-summary] Modifies show-parse.c. Changes: +7/-2 in 1 file(s)

Files: show-parse.c (+7/-2)
--------------------------------------------------------------------------------

[93917f1761f5] 2005-04-07 21:00:18 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Add function to show types as strings (instead of just printing them out).

Show (simple) initializers properly.

Files: show-parse.c (+41/-8), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[a808a8996cf0] 2005-04-07 21:00:18 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Fix integer type checking.

Make the type check failure case print out what it got,
and what it expected.

Files: evaluate.c (+6/-0)
--------------------------------------------------------------------------------

[3a7727b1d090] 2005-04-07 21:00:18 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Disable allocation statistics printing for now.

[Auto-summary] Modifies test-parsing.c. Changes: +2/-0 in 1 file(s)

Files: test-parsing.c (+2/-0)
--------------------------------------------------------------------------------

[5903424c06b8] 2005-04-07 21:00:17 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Evaluate and show return statement with proper type promotion.

[Auto-summary] Modifies 2 source files: evaluate.c, show-parse.c. Changes: +50/-9 in 2 file(s)

Files: evaluate.c (+36/-6), show-parse.c (+14/-3)
--------------------------------------------------------------------------------

[fc1da8101b51] 2005-04-07 21:00:17 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix bitfield access code.

[Auto-summary] Modifies show-parse.c. Changes: +2/-7 in 1 file(s)

Files: show-parse.c (+2/-7)
--------------------------------------------------------------------------------

[964c707a29a0] 2005-04-07 21:00:17 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Ehheh! We'd better evaluate the type of the argument declaration list before we use it. Lazy evaluation is all good and well, but it mustn't be so lazy that it doesn't do the work it needs to do ;)

[Auto-summary] Modifies evaluate.c. Changes: +3/-1 in 1 file(s)

Files: evaluate.c (+3/-1)
--------------------------------------------------------------------------------

[20e0646d9239] 2005-04-07 21:00:17 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Show the expression parse tree as a sick kind of assembly language, which bears almost no resemblance to any _sane_ assembly language, but which gives a much better idea of what a back-end might actually do.

It also (since it has to linearize function calls and get argument sizes right
and so on) ends up being a pretty good way to see obvious breakage in the parse
tree. If you can just ignore the strangeness of the "assembly language".

My favourite "instructions":

	[vP]	cmov vT,vA,vB

here vP is a virtual register that acts as a "predicate" for the cmov, and
it will move the value of vA into vT if vP is non-zero, otherwise vB.  It
matches the C expression vT = vP ? vA : vB.

It also has the "notzero" instruction:

	notzero vT,vA

which sets vT to 0/1 depending on whether vA is nonzero/zero. It matches
the C expression vT = !vA.

Think of it as a three-register machine designed for REALLY stupid C compilers ;)

Files: show-parse.c (+147/-69)
--------------------------------------------------------------------------------

[1460a6fb9235] 2005-04-07 21:00:16 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add "target.h" to the list of headers, to make dependencies come out right.

[Auto-summary] Modifies build system. Changes: +1/-1 in 1 file(s)

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[fbd7e42ec801] 2005-04-07 21:00:16 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix up degenerate arrays to handle the string case (which is not an lvalue-array).

Evaluate a unary '+' as a no-op.

Make function argument evaluation actually walk the function argument
declaration list, and check the function argument types.

Files: evaluate.c (+42/-25)
--------------------------------------------------------------------------------

[774d0729c4f4] 2005-04-07 21:00:16 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add macros to walk a list in parallel with another walker.

Add macros to do "FOR_EACH_PTR", walking backwards.

These are some macros from hell, but the _users_ of the macros
look pretty readable, which is all that really matters.

Files: lib.h (+51/-1)
--------------------------------------------------------------------------------

[126da02d7d5b] 2005-04-07 21:00:15 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make statement and expression printouts be more "linearized", and create the proper pseudo-registers for sub-expressions. This changes the printout a lot, but makes it a lot closer to what you'd output internally for a back-end to do the flow graph.

show_statement() and show_expression() now return the pseudo
number for the result of a statement or expression.
    
Pseudo 0 is "void".

Files: parse.h (+2/-2), show-parse.c (+205/-87)
--------------------------------------------------------------------------------

[b6bf7122f731] 2005-04-07 21:00:15 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add nicer iterator for pointer lists - it's a complex macro, but it means that you can iterate over a list inline instead of having to use function pointers.

[Auto-summary] Updates header lib.h. Changes: +21/-0 in 1 file(s)

Files: lib.h (+21/-0)
--------------------------------------------------------------------------------

[33c605dbc91a] 2005-04-07 21:00:15 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Drop the MOD_ATTRIBUTE bit when parsing attributes.

[Auto-summary] Modifies parse.c. Changes: +1/-0 in 1 file(s)

Files: parse.c (+1/-0)
--------------------------------------------------------------------------------

[b7c91670a982] 2005-04-07 21:00:15 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: String initializers are effectively constant, but don't mark them const - we still want to be able to assign them to a regular "char *" without getting a warning.

[Auto-summary] Modifies evaluate.c. Changes: +1/-1 in 1 file(s)

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[cdc75aa27224] 2005-04-07 21:00:14 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: oops. Warn about undefined preprocessor symbol names before we overwrite the expression symbol information with a zero value.

[Auto-summary] Modifies evaluate.c. Changes: +1/-1 in 1 file(s)

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[8f827dfd41fb] 2005-04-07 21:00:14 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add a "preprocessing" flag, so that the expression evaluator can take the semantic differences into account (a undefined symbol behaves differently in a C parse tree than in a preprocessor expression)

[Auto-summary] Modifies 2 source files: evaluate.c, pre-process.c. Updates header token.h. Changes: +13/-2 in 3 file(s)

Files: evaluate.c (+8/-2), pre-process.c (+4/-0), token.h (+1/-0)
--------------------------------------------------------------------------------

[11468a914482] 2005-04-07 21:00:14 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Simplify typedef testing, and don't mess with MOD_EXTERNAL testing on typedefs.

[Auto-summary] Modifies parse.c. Changes: +8/-8 in 1 file(s)

Files: parse.c (+8/-8)
--------------------------------------------------------------------------------

[1ca3c2344cbb] 2005-04-07 21:00:13 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Allow pointers to differ in certain modifier bits. For example, we don't care about 'const' vs 'volatile' in pointer differences. And in assignments, it's ok if the target is more restricted than the source.

[Auto-summary] Modifies evaluate.c. Changes: +23/-10 in 1 file(s)

Files: evaluate.c (+23/-10)
--------------------------------------------------------------------------------

[31ca6c598c12] 2005-04-07 21:00:13 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Re-introduce MOD_ADDRESSABLE handling that got dropped with the symbol evaluation change-over.

[Auto-summary] Modifies evaluate.c. Changes: +7/-0 in 1 file(s)

Files: evaluate.c (+7/-0)
--------------------------------------------------------------------------------

[a325d8a15b23] 2005-04-07 21:00:13 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Put a note about the horrible wrongness in doing the expansion from 'a += b' into 'a = a + b'. It does the right thing for type evaluation (good), but the wrong thing for eventual code generation (double evaluation of any side effects in 'a').

[Auto-summary] Modifies evaluate.c. Changes: +5/-0 in 1 file(s)

Files: evaluate.c (+5/-0)
--------------------------------------------------------------------------------

[05698d1e5a47] 2005-04-07 21:00:13 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Evaluate logical expressions, and short-circuit it.

Make the pre-processor use the expression evaluator, so that
it actually gets all the signed/unsigned comparisons right
etc.

Make logical expressions an expression type of their own.
They have some very special behaviour both type-wise and
evaluation-wise (the short-circuiting thing).

Files: evaluate.c (+38/-68), expression.c (+2/-2), expression.h (+2/-1), show-parse.c (+1/-0)
--------------------------------------------------------------------------------

[6b4b251f9ad4] 2005-04-07 21:00:12 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Clean up and factor out offset add from member dereference.

[Auto-summary] Modifies evaluate.c. Changes: +21/-11 in 1 file(s)

Files: evaluate.c (+21/-11)
--------------------------------------------------------------------------------

[9aac322fe706] 2005-04-07 21:00:12 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Whee.. Arrays of arrays were type-parsed quite wrong. Maybe this fixes it, and maybe it doesn't.

[Auto-summary] Modifies parse.c. Changes: +1/-0 in 1 file(s)

Files: parse.c (+1/-0)
--------------------------------------------------------------------------------

[fe88e935a0f8] 2005-04-07 21:00:12 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Create helper function to verify lvalue'ness.

Make ++/-- check that the argument is an lvalue.

Files: evaluate.c (+64/-21)
--------------------------------------------------------------------------------

[712f630a63f7] 2005-04-07 21:00:12 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Evaluate conditional expressions with the gcc extension (ie 'a ? : b' is equivalent to 'a ? a : b' modulo side effects).

Simplify conditional expressions.

Files: evaluate.c (+30/-21)
--------------------------------------------------------------------------------

[bc5f5ac6db20] 2005-04-07 21:00:11 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Simplify bitops, shifts, and equality checks.

[Auto-summary] Modifies evaluate.c. Changes: +20/-6 in 1 file(s)

Files: evaluate.c (+20/-6)
--------------------------------------------------------------------------------

[824b3a87f4ac] 2005-04-07 21:00:11 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: To make the output more readable, drop the type information when evaluating symbols - the type is there in the dereference, but not in the symbol address expression itself.

This just avoids repetition (the type is never actually used
for anything - the only meaningful thing is the type of the top-
level expression)

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[7fc7700bceff] 2005-04-07 21:00:11 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Handle the case of a degenerate array correctly: we should definitely not dereference the array, we silently turn it into a pointer.

[Auto-summary] Modifies evaluate.c. Changes: +15/-2 in 1 file(s)

Files: evaluate.c (+15/-2)
--------------------------------------------------------------------------------

[1832118a1b60] 2005-04-07 21:00:11 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Simplify more integer constant expressions. Get sign issues right.

[Auto-summary] Modifies evaluate.c. Changes: +55/-9 in 1 file(s)

Files: evaluate.c (+55/-9)
--------------------------------------------------------------------------------

[44682172e79f] 2005-04-07 21:00:10 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Simplify some constant integer operations. Better to do it early and have a smaller tree to work on than to do it late and carry all the crap around until then.

[Auto-summary] Modifies evaluate.c. Changes: +27/-2 in 1 file(s)

Files: evaluate.c (+27/-2)
--------------------------------------------------------------------------------

[d97165e1fe7d] 2005-04-07 21:00:10 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Remove extra '<..>' in pretty-printing of expressions.

[Auto-summary] Modifies show-parse.c. Changes: +1/-2 in 1 file(s)

Files: show-parse.c (+1/-2)
--------------------------------------------------------------------------------

[74f13b5cbf1f] 2005-04-07 21:00:10 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Fix member dereferences to match the new world order.

[Auto-summary] Modifies evaluate.c. Changes: +7/-0 in 1 file(s)

Files: evaluate.c (+7/-0)
--------------------------------------------------------------------------------

[38e0737e903c] 2005-04-07 21:00:10 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Don't bother showing the full type of a symbol in an expression, since we now really consider it just an address.

[Auto-summary] Modifies show-parse.c. Changes: +1/-1 in 1 file(s)

Files: show-parse.c (+1/-1)
--------------------------------------------------------------------------------

[b11b11cca88c] 2005-04-07 21:00:09 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Oops. Dropped symbol modifiers in the symbol evaluation change. And forgot to set "symbol_name" when creating the new deref-expression.

[Auto-summary] Modifies evaluate.c. Changes: +3/-2 in 1 file(s)

Files: evaluate.c (+3/-2)
--------------------------------------------------------------------------------

[5f9ef429f5cf] 2005-04-07 21:00:09 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Verify lvalue'ness on assignment - since we now make symbol evaluation become the dereference of the symbol address, the test for lvalue'ness is trivially to check that the top expression is a dereference.

[Auto-summary] Modifies evaluate.c. Changes: +4/-14 in 1 file(s)

Files: evaluate.c (+4/-14)
--------------------------------------------------------------------------------

[51d392ef668e] 2005-04-07 21:00:09 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Update 'addressof' to work with the new symbol setup.

[Auto-summary] Modifies evaluate.c. Changes: +6/-15 in 1 file(s)

Files: evaluate.c (+6/-15)
--------------------------------------------------------------------------------

[112e133ea8c6] 2005-04-07 21:00:08 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Evaluating a symbol turns into a dereference of the address of the symbol. This also means that '&' works correctly, ie

&c

really evaluates into &(*'symbol c') == 'symbol c', which is
really what we want. The backend will thus always consider
symbol expressions to be nothing but addresses.

Files: evaluate.c (+13/-11), show-parse.c (+2/-9)
--------------------------------------------------------------------------------

[d80b9c793e27] 2005-04-07 21:00:08 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Prepare to collapse '*&' and '&*' combinations.

More preparation to evaluate structure and array initializers.

Files: evaluate.c (+56/-8)
--------------------------------------------------------------------------------

[c3b5091c161c] 2005-04-07 21:00:08 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Clean up expression dereference evaluation. Rename struct/union member dereferences to be explicitly _member_ dereferences (as opposed to simple '*' pointer dereferences).

[Auto-summary] Modifies evaluate.c. Changes: +32/-24 in 1 file(s)

Files: evaluate.c (+32/-24)
--------------------------------------------------------------------------------

[5575747bc9d1] 2005-04-07 21:00:08 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Clean up address-of evaluation, and mark symbols so evaluated as addressable (and warn if they were claimed to be "register").

[Auto-summary] Modifies 2 source files: evaluate.c, show-parse.c. Updates header symbol.h. Changes: +26/-9 in 3 file(s)

Files: evaluate.c (+24/-8), show-parse.c (+1/-1), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[b5b3dfdd3989] 2005-04-07 21:00:07 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make the "obfuscate" backend actually generate a few type descriptions. Nothing interesting yet, though. Oh, well.

[Auto-summary] Modifies obfuscate.c. Changes: +44/-4 in 1 file(s)

Files: obfuscate.c (+44/-4)
--------------------------------------------------------------------------------

[cf476e9c984e] 2005-04-07 21:00:07 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Oops. Missed a place where we added pure symbol declarations (as opposed to definitions) to the top-level symbol list.

[Auto-summary] Modifies parse.c. Changes: +1/-6 in 1 file(s)

Files: parse.c (+1/-6)
--------------------------------------------------------------------------------

[ab2145aecd30] 2005-04-07 21:00:07 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Evaluate simple initializers (ie non-structured ones). They look largely like expressions.

[Auto-summary] Modifies evaluate.c. Changes: +23/-11 in 1 file(s)

Files: evaluate.c (+23/-11)
--------------------------------------------------------------------------------

[9c91febad477] 2005-04-07 21:00:07 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make initializer evaluation have the correct infrastructure. You cannot just evaluate initializers as an expression, since the evaluator needs to know the resultant type ahead of time in order to make sense of it.

We still don't actually fully evaluate them, but at least the
infrastructure is in place now.

Files: evaluate.c (+38/-29)
--------------------------------------------------------------------------------

[504bb50c98a1] 2005-04-07 21:00:06 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Oops. The preprocessor symbol evaluation printed out the wrong name.

Add "obfuscate" as a stupid back-end. It will generate some
really really horrible C output if I get my way.

Don't expose "attribute" for type attributes. Use only the
double-underscore version

Files: Makefile (+4/-1), evaluate.c (+1/-1), obfuscate.c (+80/-0), symbol.c (+2/-0)
--------------------------------------------------------------------------------

[73fa5bd563e8] 2005-04-07 21:00:06 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Prinout of the "inline", "nocast" and "noderef" attributes

[Auto-summary] Modifies show-parse.c. Changes: +2/-1 in 1 file(s)

Files: show-parse.c (+2/-1)
--------------------------------------------------------------------------------

[f52ecbaad6ed] 2005-04-07 21:00:06 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Only add symbol definitions, not declarations, to the result list of the full-file parse.

The declarations simply aren't useful to any back-end: they are
only useful as symbol definitions for the front-end to get the
right types, and they are thus better found through evaluation of
the parse tree than as nodes off the root.

Files: parse.c (+29/-16), symbol.c (+3/-3), symbol.h (+2/-1)
--------------------------------------------------------------------------------

[bf28444a26fb] 2005-04-07 21:00:06 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: evaluate_initializer() is now static to within evaluate.c

[Auto-summary] Updates header expression.h. Changes: +0/-1 in 1 file(s)

Files: expression.h (+0/-1)
--------------------------------------------------------------------------------

[76cb770093ab] 2005-04-07 21:00:05 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Evaluate more SYM_NODE type fallout - we can have pointers to SYM_NODE's created with the '&' operator, and dereferencing those pointers needs to be able to handle it.

Also, evaluate the labeled statement, and make a cast operation
return the type even if it can't parse the type of the cast target
(which is actually not uncommon with initializers that have no
intrisic type until they are cast!).

Files: evaluate.c (+26/-11)
--------------------------------------------------------------------------------

[a754a51a9062] 2005-04-07 21:00:05 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Check address spaces when comparing types. They should match: it makes no sense comparing a kernel pointer with a user pointer.

Print out non-zero address spaces on type debugging.

[ Side note: should "as=0" be a "anonymous address space" and
  always match? Right now it's a unique address space in itself,
  and only special in that all internal symbols are always of
  that address space ]

Files: evaluate.c (+17/-9), show-parse.c (+4/-1)
--------------------------------------------------------------------------------

[d787344efc7a] 2005-04-07 21:00:05 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make structure size calculations handle the case where the structure might have been pre-aligned.

[Auto-summary] Modifies symbol.c. Changes: +3/-3 in 1 file(s)

Files: symbol.c (+3/-3)
--------------------------------------------------------------------------------

[52c719d062a9] 2005-04-07 21:00:05 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Show type names more readably

[Auto-summary] Modifies show-parse.c. Changes: +3/-3 in 1 file(s)

Files: show-parse.c (+3/-3)
--------------------------------------------------------------------------------

[dfc5e22ae78d] 2005-04-07 21:00:04 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make "final type attributes" properly apply the attribute information to the type, instead of throwing it away.

[Auto-summary] Modifies parse.c. Changes: +46/-37 in 1 file(s)

Files: parse.c (+46/-37)
--------------------------------------------------------------------------------

[16b19dea319d] 2005-04-07 21:00:04 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Fix fallout from the change to have the full symbol type in the type expression. Be much more careful about allowing the exact same type in pointer difference expressions.

[Auto-summary] Modifies evaluate.c. Changes: +75/-47 in 1 file(s)

Files: evaluate.c (+75/-47)
--------------------------------------------------------------------------------

[7d16564bf807] 2005-04-07 21:00:04 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Rename the symbol 'type' attribute as a 'context' attribute. That's really more descriptive of what it is, and it avoids confusion with the other uses of "type".

Add "address space" ID to types. It could be segments (yuck!)
or it could be a "kernel" vs "user" thing, hint hint.

Files: evaluate.c (+5/-5), parse.c (+28/-39), symbol.h (+1/-1)
--------------------------------------------------------------------------------

[67c88166eede] 2005-04-07 21:00:03 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add a note in the FAQ about the lack of support for old K&R-style untyped constructs.

[Auto-summary] Updates documentation. Changes: +18/-0 in 1 file(s)

Files: FAQ (+18/-0)
--------------------------------------------------------------------------------

[20a9a2039701] 2005-04-07 21:00:03 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Don't drop SYM_NODE information when evaluating expression types. We need the SYM_NODE stuff for per-node modifier information.

[Auto-summary] Modifies evaluate.c. Changes: +65/-10 in 1 file(s)

Files: evaluate.c (+65/-10)
--------------------------------------------------------------------------------

[dc2daf88b47b] 2005-04-07 21:00:03 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add parsing of "noderef" attribute, and remember to save the alignment gotten from the "aligned()" or "packed" attributes.

[Auto-summary] Modifies parse.c. Updates header symbol.h. Changes: +12/-0 in 2 file(s)

Files: parse.c (+11/-0), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[b1f9e93e9137] 2005-04-07 21:00:03 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Expose scoping to symbol binders - we'll need this to check whether it is a re-definition (ie new declaration in the same scope).

[Auto-summary] Modifies 2 source files: scope.c, symbol.c. Updates header scope.h. Changes: +27/-10 in 3 file(s)

Files: scope.c (+6/-8), scope.h (+11/-1), symbol.c (+10/-1)
--------------------------------------------------------------------------------

[284092b48808] 2005-04-07 21:00:02 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add some limited attribute parsing. "packed", "aligned" and "type".

The last one gives a "context mask" and "context value" to a symbol,
which can be used to verify that the symbol is only used in a certain
context.

Files: evaluate.c (+10/-1), parse.c (+32/-0), parse.h (+2/-0), pre-process.c (+1/-1), symbol.h (+3/-0)
--------------------------------------------------------------------------------

[01b7c455c98d] 2005-04-07 21:00:02 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Get closer to actually looking at type attributes.

[Auto-summary] Modifies parse.c. Changes: +21/-13 in 1 file(s)

Files: parse.c (+21/-13)
--------------------------------------------------------------------------------

[2823bff27b1a] 2005-04-07 21:00:02 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Move symbol alignment into the "ctype" part of the symbol, so that type parsing gets access to it.

[Auto-summary] Modifies 3 source files: evaluate.c, show-parse.c, symbol.c. Updates header symbol.h. Changes: +31/-30 in 4 file(s)

Files: evaluate.c (+3/-4), show-parse.c (+2/-2), symbol.c (+21/-20), symbol.h (+5/-4)
--------------------------------------------------------------------------------

[731d979ea2e8] 2005-04-07 21:00:01 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Prepare attribute parsing for future work.

[Auto-summary] Modifies parse.c. Changes: +5/-3 in 1 file(s)

Files: parse.c (+5/-3)
--------------------------------------------------------------------------------

[575d754f1db4] 2005-04-07 21:00:01 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Oops. Move type definition to top of function, instead of having that C++ syntax extension that gcc-3.2 so silently accepts.

[Auto-summary] Modifies lib.c. Changes: +1/-1 in 1 file(s)

Files: lib.c (+1/-1)
--------------------------------------------------------------------------------

[919f829252fa] 2005-04-07 21:00:01 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Change the copyright to Transmeta Corp, that's likely to be the real one when it goes out the door.

[Auto-summary] Modifies 11 source files: evaluate.c, expression.c, lib.c and 8 more. Updates 6 headers. Changes: +17/-17 in 17 file(s)

Files: evaluate.c (+1/-1), expression.c (+1/-1), expression.h (+1/-1), lib.c (+1/-1), lib.h (+1/-1), ... and 12 more
--------------------------------------------------------------------------------

[70a399adbec9] 2005-04-07 21:00:01 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Put a note in the README about the lazy type evaluation.

[Auto-summary] Updates documentation. Changes: +16/-5 in 1 file(s)

Files: README (+16/-5)
--------------------------------------------------------------------------------

[f742f8e5af17] 2005-04-07 21:00:00 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make conditional expressions handle compatible pointers.

Evaluate array size when evaluating a initializer.

Files: evaluate.c (+58/-7)
--------------------------------------------------------------------------------

[8055ae46488c] 2005-04-07 21:00:00 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make sure unhandled types show up in type expansions.

[Auto-summary] Modifies show-parse.c. Changes: +5/-0 in 1 file(s)

Files: show-parse.c (+5/-0)
--------------------------------------------------------------------------------

[ad5c3b1cde7d] 2005-04-07 21:00:00 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: If 'examine_symbol_type' changes the symbol type due to lazy 'typeof' evaluation, update the original type to match the new one.

[Auto-summary] Modifies 2 source files: evaluate.c, symbol.c. Changes: +5/-2 in 2 file(s)

Files: evaluate.c (+2/-0), symbol.c (+3/-2)
--------------------------------------------------------------------------------

[52529deaae75] 2005-04-07 21:00:00 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Change the evaluate functions to return the type of the result (or NULL) rather than just 1 (or 0).

Make "examine_symbol_type()" follow 'typeof's, and return the result.

Files: evaluate.c (+118/-128), expression.h (+4/-4), symbol.c (+18/-11), symbol.h (+1/-1)
--------------------------------------------------------------------------------

[125e408d04a5] 2005-04-07 20:59:59 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Evaluate more expression types: conditional expressions, statement expressions, post-op expressions.

Move some of the evaluation functions from test-parsing.c to evaluate.c

Files: evaluate.c (+145/-22), expression.h (+5/-0), test-parsing.c (+4/-58)
--------------------------------------------------------------------------------

[911597aae0b8] 2005-04-07 20:59:59 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Save enough information at parse time to make "typeof" work with lazy evaluation of expressions.

[Auto-summary] Modifies parse.c. Updates header symbol.h. Changes: +5/-4 in 2 file(s)

Files: parse.c (+4/-4), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[0d07c78e2b75] 2005-04-07 20:59:59 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Drop debugging message.

[Auto-summary] Modifies lib.c. Changes: +0/-1 in 1 file(s)

Files: lib.c (+0/-1)
--------------------------------------------------------------------------------

[2e38db982acc] 2005-04-07 20:59:58 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Oops. Initializer casts didn't actually save the result.

[Auto-summary] Modifies expression.c. Changes: +1/-1 in 1 file(s)

Files: expression.c (+1/-1)
--------------------------------------------------------------------------------

[9311b66142f4] 2005-04-07 20:59:58 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Show symbol types in a more C-like fashion, to avoid confusion.

[Auto-summary] Modifies show-parse.c. Changes: +88/-43 in 1 file(s)

Files: show-parse.c (+88/-43)
--------------------------------------------------------------------------------

[9eba418e643e] 2005-04-07 20:59:58 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix modifiers for pointer types. Bug hidden by not very readable type printouts.

[Auto-summary] Modifies parse.c. Changes: +2/-2 in 1 file(s)

Files: parse.c (+2/-2)
--------------------------------------------------------------------------------

[1f7bfc909be2] 2005-04-07 20:59:58 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Do a better job of type checking at assignment time.

[Auto-summary] Modifies evaluate.c. Changes: +26/-2 in 1 file(s)

Files: evaluate.c (+26/-2)
--------------------------------------------------------------------------------

[878cca8d2fa2] 2005-04-07 20:59:57 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make the parser discard the tokens after having parsed the whole file. We no longer hold any pointers to them in expression or symbol structures.

Make the blob allocator use mmap/munmap for allocations,
to catch illegal uses of memory after free more easily.
    
Make the chunk size be 32kB instead of 8kB.

Files: lib.c (+15/-9), parse.c (+2/-0)
--------------------------------------------------------------------------------

[46fad7332eaf] 2005-04-07 20:59:57 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Update comment about NS_LABEL scoping behaviour, now that it is fixed.

[Auto-summary] Modifies parse.c. Changes: +3/-3 in 1 file(s)

Files: parse.c (+3/-3)
--------------------------------------------------------------------------------

[91234dcb89f1] 2005-04-07 20:59:57 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Separate scopes for blocks and functions. Function scopes are a proper superset of block scopes: function scopes are created by a new function, block scopes by compound statements and statement expressions.

Make labels use function scope.

Files: parse.c (+2/-2), scope.c (+34/-8), scope.h (+4/-0), show-parse.c (+1/-1)
--------------------------------------------------------------------------------

[214ade542027] 2005-04-07 20:59:56 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make labels be symbols in their own namespace (NS_LABEL).

This still gets the nesting scope wrong, though. Labels
should use function scope, not block scope.

Files: parse.c (+12/-2), parse.h (+3/-3), show-parse.c (+10/-5), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[89ca8a623968] 2005-04-07 20:59:56 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Remove last user of "struct token" from "struct expression".

Now constant expressions (strings, integers and fp constants)
are evaluated at parse-time into the proper EXPR_xxx type.

Remove "struct token" from "struct statement", which really only
wanted to know the position. So replace it with "struct position".

Files: evaluate.c (+9/-110), expression.c (+95/-4), expression.h (+1/-5), parse.c (+5/-4), parse.h (+1/-1), ... and 1 more
--------------------------------------------------------------------------------

[9dfc1770c773] 2005-04-07 20:59:56 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Parse array initializer index specifiers:

int test[] = {
		[0...3] = 5,
		[4...6] = 3
	};

Files: parse.c (+24/-0)
--------------------------------------------------------------------------------

[79ac96f9acb6] 2005-04-07 20:59:56 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Evaluate assignments:  - expand combinations ('a += b' => 'a = a + b')  - check resulting types

Rename 'MINUS' and 'TIMES' as 'SUB' and 'MUL' in assignments.

Files: evaluate.c (+97/-8), expression.c (+4/-3), token.h (+2/-2)
--------------------------------------------------------------------------------

[10572801b6c9] 2005-04-07 20:59:55 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Evaluate initializers separately. We'll need this to handle type discovery (initializers are not independent expressions).

[Auto-summary] Modifies 2 source files: evaluate.c, test-parsing.c. Updates header expression.h. Changes: +17/-1 in 3 file(s)

Files: evaluate.c (+15/-0), expression.h (+1/-0), test-parsing.c (+1/-1)
--------------------------------------------------------------------------------

[75a5a885519b] 2005-04-07 20:59:55 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make structure/union declaration printout prettier.

[Auto-summary] Modifies show-parse.c. Changes: +0/-2 in 1 file(s)

Files: show-parse.c (+0/-2)
--------------------------------------------------------------------------------

[bdc6803647b8] 2005-04-07 20:59:55 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Parse initializers properly. We parsed them before, but we didn't add them to the parse tree. We now do.

[Auto-summary] Modifies 5 source files: evaluate.c, expression.c, parse.c and 2 more. Updates 2 headers. Changes: +82/-32 in 7 file(s)

Files: evaluate.c (+11/-0), expression.c (+1/-1), expression.h (+12/-1), parse.c (+30/-25), show-parse.c (+25/-5), ... and 2 more
--------------------------------------------------------------------------------

[9d2258c5def3] 2005-04-07 20:59:55 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Start doing constant strings right: do proper concatenation of strings, and evaluate their type to be arrays of char rather than just a pointer.

[Auto-summary] Modifies 4 source files: evaluate.c, expression.c, show-parse.c and 1 more. Updates 2 headers. Changes: +91/-23 in 6 file(s)

Files: evaluate.c (+29/-2), expression.c (+35/-6), expression.h (+4/-0), show-parse.c (+3/-0), token.h (+1/-0), ... and 1 more
--------------------------------------------------------------------------------

[c6555e8346cc] 2005-04-07 20:59:54 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: A structure member is just an identifier, not a random token.

[Auto-summary] Modifies 3 source files: evaluate.c, expression.c, show-parse.c. Updates header expression.h. Changes: +6/-6 in 4 file(s)

Files: evaluate.c (+3/-3), expression.c (+1/-1), expression.h (+1/-1), show-parse.c (+1/-1)
--------------------------------------------------------------------------------

[7d109870a358] 2005-04-07 20:59:54 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Introduce a "struct position", and have the different types refer to it, instead of having everybody have pointers to "struct token" only because they wanted to have the position.

Fix array addition type degeneration.

Files: evaluate.c (+33/-30), expression.c (+29/-26), expression.h (+11/-5), lib.c (+9/-17), lib.h (+11/-2), ... and 8 more
--------------------------------------------------------------------------------

[f81c64db7f16] 2005-04-07 20:59:54 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Don't die on excessive warnings, just print a warning and stop complaining. In many cases we want to go on and print out the parse tree to figure out why it warned (at least for now it's more likely to be due to some bug in the parse tree rather than in the sources that got parsed).

[Auto-summary] Modifies lib.c. Changes: +9/-2 in 1 file(s)

Files: lib.c (+9/-2)
--------------------------------------------------------------------------------

[641038268c50] 2005-04-07 20:59:54 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make arrays properly degenerate into pointer expressions when adding an integer to them.

Make '->' work on arrays as well as pointers.

Files: evaluate.c (+15/-3)
--------------------------------------------------------------------------------

[4824d434d5ee] 2005-04-07 20:59:53 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add support for tokenizing a pre-allocated string instead of a file.

Use the new string tokenization to handle some simple command
line switches like -Dxxxx=yyyy - by simply adding lines to a
buffer that is tokenized and inserted before the actual file.

Files: test-parsing.c (+49/-0), token.h (+3/-1), tokenize.c (+61/-35)
--------------------------------------------------------------------------------

[24131a1b9dd4] 2005-04-07 20:59:53 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix up the 'value is so large it is XXXX' message in the presense of partial (but insufficient for the size) type suffixes. Also, fix the decimal special case in case the user already had 'l' or 'll' suffixes but needed an extra 'u'.

[Auto-summary] Modifies evaluate.c. Changes: +7/-7 in 1 file(s)

Files: evaluate.c (+7/-7)
--------------------------------------------------------------------------------

[2ca23c6cb2f8] 2005-04-07 20:59:53 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Zero out the high bits when casting constants to a smaller type, so that a EXPR_VALUE expression never contains extra bits that won't be used. It's just less confusing that way (but realize that we always keep the value unsigned, even if the _type_ is signed).

[Auto-summary] Modifies evaluate.c. Updates header expression.h. Changes: +9/-4 in 2 file(s)

Files: evaluate.c (+8/-3), expression.h (+1/-1)
--------------------------------------------------------------------------------

[883e0c2829dc] 2005-04-07 20:59:53 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix up integer constants to match magic rule: a normal decimal integer that is too long to fit in an 'int' will be promoted to 'long' even if it were to fit in 'unsigned int'. But hex and octal numbers stay as 'unsigned int' if they fit.

In other words, on a 32-bit architecture with a 32-bit long,
the constant '2147483648' gets implicitly converted first to
'long' because it doesn't fit in an 'int', and then to 'unsigned
long' because it doesn't fit in a 'long' either.

But the hex constant 0x80000000 (which has the same value),
will get converted to just an 'unsigned int'. Whee.

Files: evaluate.c (+21/-7)
--------------------------------------------------------------------------------

[90ee2e0821ce] 2005-04-07 20:59:52 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Take note of modifiers at the end of integer constants, ie 1ULL is of type "unsigned long long".

Make type casts of constant expression values be constant
expression values themselves.

Files: evaluate.c (+96/-7)
--------------------------------------------------------------------------------

[9aba912e5abc] 2005-04-07 20:59:52 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Mark the ctype "int" explicitly signed (and not just signed by virtue of not being marked unsigned).

[Auto-summary] Modifies symbol.c. Changes: +1/-1 in 1 file(s)

Files: symbol.c (+1/-1)
--------------------------------------------------------------------------------

[c9da103bd39a] 2005-04-07 20:59:52 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Rename "promot()" to "cast_to()", since we sometimes use it to demote types.

Make assignment cast the assignment expression to the target
type.

Files: evaluate.c (+8/-3)
--------------------------------------------------------------------------------

[ca9a0d503e91] 2005-04-07 20:59:52 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Fix array size problem: if the array is unsized (-1), then the size of the array is also unsized.

[Auto-summary] Modifies symbol.c. Updates header symbol.h. Changes: +3/-1 in 2 file(s)

Files: symbol.c (+2/-0), symbol.h (+1/-1)
--------------------------------------------------------------------------------

[3adee9e1582d] 2005-04-07 20:59:51 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Ahh.. Functions can also degenerate into pointer types, kind of like arrays.

[Auto-summary] Modifies evaluate.c. Changes: +1/-1 in 1 file(s)

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[67f3b8fdeceb] 2005-04-07 20:59:51 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Show more statement types.

[Auto-summary] Modifies show-parse.c. Changes: +23/-2 in 1 file(s)

Files: show-parse.c (+23/-2)
--------------------------------------------------------------------------------

[ed01686184c8] 2005-04-07 20:59:51 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Evaluate pointer subtractions correctly: handle the valid 'ptr - int' case by passing it on to the pointer add handler.

Fix nested declarations (in particular, pointer-to-function
and pointer-to-array declarations). I hope this concludes
our series of stupid type parsing bugs.

Files: evaluate.c (+12/-11), parse.c (+15/-9), show-parse.c (+8/-5)
--------------------------------------------------------------------------------

[d921f6525ee1] 2005-04-07 20:59:51 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Evaluate (ptr - ptr).  Do the sizeof scaling for (ptr + int) expressions.

[Auto-summary] Modifies evaluate.c. Updates header target.h. Changes: +89/-2 in 2 file(s)

Files: evaluate.c (+88/-2), target.h (+1/-0)
--------------------------------------------------------------------------------

[12b34a780b68] 2005-04-07 20:59:50 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Evaluate a lot more binop types: pointer addition, logical operations, compares etc. Soem FIXME!s here still..

[Auto-summary] Modifies evaluate.c. Changes: +105/-26 in 1 file(s)

Files: evaluate.c (+105/-26)
--------------------------------------------------------------------------------

[7b4b7868e436] 2005-04-07 20:59:50 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Handle 'enum' as 'int' for integer promotion.

Make expr->type be a 'enum expression_type' for nicer
compiler messages.

Files: evaluate.c (+19/-2), expression.h (+2/-1)
--------------------------------------------------------------------------------

[18e3c840d93a] 2005-04-07 20:59:50 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Use the same bitfield packing that gcc does. It was much simpler than my original one anyway.

[Auto-summary] Modifies symbol.c. Changes: +46/-45 in 1 file(s)

Files: symbol.c (+46/-45)
--------------------------------------------------------------------------------

[a9b6800b866e] 2005-04-07 20:59:50 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Evaluate bitfields into bitfield expressions.

Optimize away an offset of 0 in a structure reference.

Files: evaluate.c (+25/-12), expression.h (+6/-0), show-parse.c (+5/-1)
--------------------------------------------------------------------------------

[cfd8c66684fc] 2005-04-07 20:59:49 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Add bitfield type examination and printout.

Make the structure/union packing know about bitfields.

Files: show-parse.c (+2/-0), symbol.c (+60/-5)
--------------------------------------------------------------------------------

[c61c829ae993] 2005-04-07 20:59:49 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix postop and cast evaluators, that returned success when they failed and caused problems upstream because of that.

Add back compare expressions to the list of expressions that the
pre-processor can evaluate. They got dropped by mistake when they
were split up from the regular binop expressions.

Correctly handle functions with a void argument list. We shouldn't
parse them as a single argument without any associated symbol name ;)

Files: evaluate.c (+8/-3), parse.c (+4/-1)
--------------------------------------------------------------------------------

[c37b806b9ac7] 2005-04-07 20:59:49 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Give comma expressions and comparison expressions different types, even though they parse like other binops: they have different semantic type behaviour, and should be evaluated separately.

Show bitfield symbol types.

Files: evaluate.c (+55/-5), expression.c (+13/-13), expression.h (+3/-1), show-parse.c (+7/-0)
--------------------------------------------------------------------------------

[90710c4bafaf] 2005-04-07 20:59:49 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make a function call point an expression type of its own, and make the arguments use a proper argument list instead of being a comma-expression (which has totally different type semantics).

Evaluate assignments and function calls (and their arguments).

Show function calls in the debug info.

Files: evaluate.c (+63/-0), expression.c (+18/-3), expression.h (+20/-4), lib.c (+13/-0), lib.h (+17/-0), ... and 3 more
--------------------------------------------------------------------------------

[c45a5bde1a5d] 2005-04-07 20:59:48 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Print out array sizes correctly.

[Auto-summary] Modifies show-parse.c. Changes: +1/-5 in 1 file(s)

Files: show-parse.c (+1/-5)
--------------------------------------------------------------------------------

[55e9b0efa2c4] 2005-04-07 20:59:48 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Evaluate structure and union member dereferences (turn them into plain derefences with a byte offset).

[Auto-summary] Modifies evaluate.c. Changes: +81/-0 in 1 file(s)

Files: evaluate.c (+81/-0)
--------------------------------------------------------------------------------

[feb86da650d4] 2005-04-07 20:59:48 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix structure debug printouts after the type changeover.

[Auto-summary] Modifies show-parse.c. Changes: +2/-2 in 1 file(s)

Files: show-parse.c (+2/-2)
--------------------------------------------------------------------------------

[ad4dd337f423] 2005-04-07 20:59:47 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add a generic internal pointer type (void *)

[Auto-summary] Modifies symbol.c. Updates header symbol.h. Changes: +4/-2 in 2 file(s)

Files: symbol.c (+3/-1), symbol.h (+1/-1)
--------------------------------------------------------------------------------

[6093c190f23c] 2005-04-07 20:59:47 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add tree evaluation to a few more statement types (iterators, switch and case-statements).

Handle varying functions.

Files: parse.c (+9/-8), show-parse.c (+2/-0), symbol.h (+1/-1), test-parsing.c (+16/-0)
--------------------------------------------------------------------------------

[38795344d7b0] 2005-04-07 20:59:47 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Fix indirect type parsing (functions, arrays, bitfields). Update users to match.

Examine array type sizes.

Evaluate 'sizeof()', and realize that you can dereference arrays
as well as pointers.

Files: evaluate.c (+25/-1), parse.c (+22/-25), show-parse.c (+23/-3), symbol.c (+24/-38), symbol.h (+2/-0), ... and 2 more
--------------------------------------------------------------------------------

[ada22defe982] 2005-04-07 20:59:47 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make the 'void' type also be part of the new world order of types.

[Auto-summary] Modifies 2 source files: parse.c, symbol.c. Changes: +3/-10 in 2 file(s)

Files: parse.c (+0/-2), symbol.c (+3/-8)
--------------------------------------------------------------------------------

[24169a3b97d7] 2005-04-07 20:59:46 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make 'show_type()' just show the type, while 'show_symbol()' shows not just the type but also things like the definition of the structure or function that is associated with the symbol.

[Auto-summary] Modifies show-parse.c. Changes: +21/-5 in 1 file(s)

Files: show-parse.c (+21/-5)
--------------------------------------------------------------------------------

[8bb77b3c4c98] 2005-04-07 20:59:46 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Fix typename parsing (incorrect ctype usage), and correct handling of 'long' and 'long long' types. Fix cast parsing and evaluate casts.

[Auto-summary] Modifies 4 source files: evaluate.c, expression.c, parse.c and 1 more. Changes: +30/-26 in 4 file(s)

Files: evaluate.c (+5/-0), expression.c (+3/-1), parse.c (+4/-2), show-parse.c (+18/-23)
--------------------------------------------------------------------------------

[ea3907e1228b] 2005-04-07 20:59:46 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Oops. When adding the basic C types, I forgot the most fundamental ones: 'int' and 'unsigned int'.

[Auto-summary] Modifies symbol.c. Changes: +3/-1 in 1 file(s)

Files: symbol.c (+3/-1)
--------------------------------------------------------------------------------

[4fd2962a5ff6] 2005-04-07 20:59:46 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Clean up type handling in a big way. Don't leave those dangling anonymous "int_type" types with magic modifiers, but turn all types into explicit C types.

[Auto-summary] Modifies 5 source files: evaluate.c, parse.c, pre-process.c and 2 more. Updates 2 headers. Changes: +168/-110 in 7 file(s)

Files: evaluate.c (+6/-15), parse.c (+56/-7), parse.h (+3/-0), pre-process.c (+1/-1), show-parse.c (+70/-75), ... and 2 more
--------------------------------------------------------------------------------

[1c5968beb66f] 2005-04-07 20:59:45 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Evaluate pre-op expression types.

[Auto-summary] Modifies evaluate.c. Changes: +30/-1 in 1 file(s)

Files: evaluate.c (+30/-1)
--------------------------------------------------------------------------------

[50693db0e535] 2005-04-07 20:59:45 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Start doing type evaluation for binops - integer promotion rules etc. Add a function call expression type. Make expression type evaluation return a success/failure value.

[Auto-summary] Modifies 4 source files: evaluate.c, expression.c, show-parse.c and 1 more. Updates 2 headers. Changes: +128/-36 in 6 file(s)

Files: evaluate.c (+109/-25), expression.c (+11/-6), expression.h (+2/-1), show-parse.c (+3/-4), symbol.c (+2/-0), ... and 1 more
--------------------------------------------------------------------------------

[5d9eaa3804ab] 2005-04-07 20:59:45 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Prepare for proper integer types on constants.

[Auto-summary] Modifies evaluate.c. Changes: +10/-20 in 1 file(s)

Files: evaluate.c (+10/-20)
--------------------------------------------------------------------------------

[07eb1d52c06c] 2005-04-07 20:59:45 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Handle __LINE__ and __FILE__ in pre-processor.

[Auto-summary] Modifies pre-process.c. Changes: +24/-0 in 1 file(s)

Files: pre-process.c (+24/-0)
--------------------------------------------------------------------------------

[727afd6233aa] 2005-04-07 20:59:44 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make the includepath be an array of "const char *"

[Auto-summary] Modifies pre-process.c. Updates header token.h. Changes: +2/-4 in 2 file(s)

Files: pre-process.c (+2/-2), token.h (+0/-2)
--------------------------------------------------------------------------------

[ef62291202fc] 2005-04-07 20:59:44 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add building of the normal built-in C types (as opposed to the abstract types that type parser already knows about).

Make constant string expressions have some almost-proper type.

Files: evaluate.c (+7/-4), symbol.c (+40/-0), symbol.h (+6/-0)
--------------------------------------------------------------------------------

[da7f6d4fe8d6] 2005-04-07 20:59:44 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add preprocessor directives to manipulate the include path.

[Auto-summary] Modifies 3 source files: pre-process.c, test-lexing.c, test-parsing.c. Changes: +51/-28 in 3 file(s)

Files: pre-process.c (+51/-0), test-lexing.c (+0/-14), test-parsing.c (+0/-14)
--------------------------------------------------------------------------------

[f91ec2f57693] 2005-04-07 20:59:43 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Handle undefined identifiers "gracefully", and improve printout of for-loops.

[Auto-summary] Modifies 2 source files: evaluate.c, show-parse.c. Changes: +10/-8 in 2 file(s)

Files: evaluate.c (+4/-0), show-parse.c (+6/-8)
--------------------------------------------------------------------------------

[e6c8a27f1a95] 2005-04-07 20:59:43 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Evaluate character constants.

[Auto-summary] Modifies evaluate.c. Changes: +6/-0 in 1 file(s)

Files: evaluate.c (+6/-0)
--------------------------------------------------------------------------------

[cbcc6775410d] 2005-04-07 20:59:43 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Start "evaluating" expression trees. That is, evaluate the types of the expressions, and turn constant expressions (enums and constant tokens) into "value expressions" - their actual values.

[Auto-summary] Modifies 3 source files: evaluate.c, show-parse.c, test-parsing.c. Updates header expression.h. Changes: +120/-2 in 4 file(s)

Files: evaluate.c (+65/-0), expression.h (+5/-0), show-parse.c (+3/-1), test-parsing.c (+47/-1)
--------------------------------------------------------------------------------

[500701ebdda7] 2005-04-07 20:59:43 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix the union size calculation thing that I broke earlier. The size of a union is the size of its largest member, not the last member ;)

[Auto-summary] Modifies symbol.c. Changes: +10/-1 in 1 file(s)

Files: symbol.c (+10/-1)
--------------------------------------------------------------------------------

[b8e2af970504] 2005-04-07 20:59:42 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Handle 'enum' type sizing and alignment

[Auto-summary] Modifies symbol.c. Updates header target.h. Changes: +12/-0 in 2 file(s)

Files: symbol.c (+6/-0), target.h (+6/-0)
--------------------------------------------------------------------------------

[db4589ae583b] 2005-04-07 20:59:42 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Replace for/while/do-while loops with a generic internal 'iterator' representation so that the parse tree doesn't have to care.

[Auto-summary] Modifies 2 source files: parse.c, show-parse.c. Updates header parse.h. Changes: +103/-41 in 3 file(s)

Files: parse.c (+50/-11), parse.h (+9/-6), show-parse.c (+44/-24)
--------------------------------------------------------------------------------

[b15a8ebf5ab3] 2005-04-07 20:59:42 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Handle 'void' type sizing and bad sizeof's.

[Auto-summary] Modifies 2 source files: evaluate.c, symbol.c. Changes: +15/-2 in 2 file(s)

Files: evaluate.c (+4/-0), symbol.c (+11/-2)
--------------------------------------------------------------------------------

[80a9c3fc712e] 2005-04-07 20:59:42 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Start doing "sizeof" evaluation.

[Auto-summary] Modifies evaluate.c. Changes: +7/-0 in 1 file(s)

Files: evaluate.c (+7/-0)
--------------------------------------------------------------------------------

[1a815fa995d1] 2005-04-07 20:59:41 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make array parsing use the proper constant evaluation function that is already used by enums and the pre- processor.

Make type size/alignment handle arrays too.

Files: parse.c (+6/-7), symbol.c (+39/-48)
--------------------------------------------------------------------------------

[61dfa0129b87] 2005-04-07 20:59:41 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Split the compile time constant evaluation up into evaluate.c instead of keeping it in pre-process.c.

Add the proper dependencies

Files: Makefile (+2/-1), evaluate.c (+109/-0), pre-process.c (+1/-91)
--------------------------------------------------------------------------------

[e6b18f888d6f] 2005-04-07 20:59:41 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Add debug output to show union/struct member sizes, alignments and offsets.

[Auto-summary] Modifies show-parse.c. Changes: +1/-1 in 1 file(s)

Files: show-parse.c (+1/-1)
--------------------------------------------------------------------------------

[510f939a5a71] 2005-04-07 20:59:41 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Add type size and alignment information to 'struct symbol'.

Add 'target.h' to describe size of target-dependent types.

Add parsing of size information to gather the size for simple
types, pointers and structures/unions.

Files: parse.c (+1/-1), show-parse.c (+3/-2), symbol.c (+132/-0), symbol.h (+8/-1), target.h (+30/-0)
--------------------------------------------------------------------------------

[dd70c1f2ceb6] 2005-04-07 20:59:40 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Move expression data structures to "expression.h", they got left behind in "parse.h" when the files were split.

[Auto-summary] Modifies 2 source files: lib.c, pre-process.c. Updates 2 headers. Changes: +43/-41 in 4 file(s)

Files: expression.h (+41/-0), lib.c (+1/-0), parse.h (+0/-41), pre-process.c (+1/-0)
--------------------------------------------------------------------------------

[6a9acf2316de] 2005-04-07 20:59:40 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Uhuh. Fix stupid thinko in insertion of macro expansion.

Make the stringifier stop at argument separators.

Files: pre-process.c (+3/-4)
--------------------------------------------------------------------------------

[eec2bf2a02bb] 2005-04-07 20:59:40 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Remove unused variable

[Auto-summary] Modifies pre-process.c. Changes: +0/-1 in 1 file(s)

Files: pre-process.c (+0/-1)
--------------------------------------------------------------------------------

[c2d021e2f355] 2005-04-07 20:59:40 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Don't expand arguments that are preceded by '#' or preceded or followed by '##' (ANSI C - Appending A ï¿½12.3)

[Auto-summary] Modifies pre-process.c. Changes: +6/-3 in 1 file(s)

Files: pre-process.c (+6/-3)
--------------------------------------------------------------------------------

[5d61a948bbbd] 2005-04-07 20:59:39 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix stringify that got broken by other changes

[Auto-summary] Modifies pre-process.c. Changes: +0/-1 in 1 file(s)

Files: pre-process.c (+0/-1)
--------------------------------------------------------------------------------

[f983c19d1df5] 2005-04-07 20:59:39 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Teach ## expansion about the magic gcc behaviour: x ## arg goes away entirely if 'arg' is empty.

[Auto-summary] Modifies pre-process.c. Changes: +24/-0 in 1 file(s)

Files: pre-process.c (+24/-0)
--------------------------------------------------------------------------------

[6339a225b130] 2005-04-07 20:59:39 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Always accept \' and \" token escapes in strings/char constants, even if they don't make any sense. 'Cause that's what the standard says.

[Auto-summary] Modifies tokenize.c. Changes: +4/-0 in 1 file(s)

Files: tokenize.c (+4/-0)
--------------------------------------------------------------------------------

[f611dbc59b4f] 2005-04-07 20:59:39 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Like other type definitions, typedefs too can have multiple type entries, ie

typedef struct type type_t, *typep_t;

and we shouldn't just expect one.

Files: parse.c (+11/-7), test-parsing.c (+3/-0)
--------------------------------------------------------------------------------

[79fd1e999b90] 2005-04-07 20:59:38 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Oops, I got the "typeof" parsing wrong. It always needs parentheses around the thing we check the type of.

[Auto-summary] Modifies parse.c. Changes: +12/-7 in 1 file(s)

Files: parse.c (+12/-7)
--------------------------------------------------------------------------------

[306d32b423ca] 2005-04-07 20:59:38 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: After talking to Eric Raymond and Jeff Garzik, the current license front-runner is the OSL v1.1 ("Open Software License") together with a note on what is derivative and what is not.

Update the FAQ/LICENSE file to reflect that.

Files: FAQ (+6/-6), LICENSE (+7/-5)
--------------------------------------------------------------------------------

[724d653f51ea] 2005-04-07 20:59:38 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Parse type qualifiers properly instead of re-using the declaration specifiers parsing (which is a proper superset of the much more limited parsing that we wanted at this point).

Parse void and ellipsis arguments in function argument lists.

Parse named structure member initializers.

Files: parse.c (+57/-14), symbol.h (+1/-0), test-lexing.c (+1/-0), test-parsing.c (+1/-0)
--------------------------------------------------------------------------------

[3b5ffd7a0743] 2005-04-07 20:59:37 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix recursive expansion of preprocessor macros.

[Auto-summary] Modifies pre-process.c. Changes: +47/-50 in 1 file(s)

Files: pre-process.c (+47/-50)
--------------------------------------------------------------------------------

[ba8d5a1651ab] 2005-04-07 20:59:37 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Handle '#' properly (well, _more_ properly) in macro expansion.

[Auto-summary] Modifies pre-process.c. Changes: +28/-9 in 1 file(s)

Files: pre-process.c (+28/-9)
--------------------------------------------------------------------------------

[d4497997c970] 2005-04-07 20:59:37 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix showing of tokens - whitespace messed up.

[Auto-summary] Modifies pre-process.c. Changes: +4/-2 in 1 file(s)

Files: pre-process.c (+4/-2)
--------------------------------------------------------------------------------

[f1031b2694b3] 2005-04-07 20:59:37 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Remove global argument/arglist pointers, and pass them properly as arguments in the functions involved instead.

[Auto-summary] Modifies pre-process.c. Changes: +24/-11 in 1 file(s)

Files: pre-process.c (+24/-11)
--------------------------------------------------------------------------------

[6b4f333047a7] 2005-04-07 20:59:36 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make the naming in expand_arguments() match the others

[Auto-summary] Modifies pre-process.c. Changes: +2/-2 in 1 file(s)

Files: pre-process.c (+2/-2)
--------------------------------------------------------------------------------

[40c1647b14da] 2005-04-07 20:59:36 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Move includepath[] array out of pre-processor, since we want to change it from the callers..

[Auto-summary] Modifies 3 source files: pre-process.c, test-lexing.c, test-parsing.c. Updates header token.h. Changes: +49/-12 in 4 file(s)

Files: pre-process.c (+1/-9), test-lexing.c (+13/-0), test-parsing.c (+33/-3), token.h (+2/-0)
--------------------------------------------------------------------------------

[82db0b8674c0] 2005-04-07 20:59:36 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix up more stupidities in the type parsing. It might even be getting close to right now.

[Auto-summary] Modifies 3 source files: lib.c, parse.c, show-parse.c. Changes: +75/-49 in 3 file(s)

Files: lib.c (+1/-1), parse.c (+43/-38), show-parse.c (+31/-10)
--------------------------------------------------------------------------------

[b92fd48511f4] 2005-04-07 20:59:36 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix confusion between symbol types and modifier bit-names.

Show more detail about nested types.

Files: parse.c (+20/-24), show-parse.c (+44/-17), symbol.c (+26/-26), symbol.h (+24/-24)
--------------------------------------------------------------------------------

[eb82e3870282] 2005-04-07 20:59:35 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add dependencies for new files

[Auto-summary] Modifies build system. Changes: +2/-0 in 1 file(s)

Files: Makefile (+2/-0)
--------------------------------------------------------------------------------

[70b8ae0e7d40] 2005-04-07 20:59:35 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Oops. Remove empty printf that causes warnings.

[Auto-summary] Modifies show-parse.c. Changes: +0/-1 in 1 file(s)

Files: show-parse.c (+0/-1)
--------------------------------------------------------------------------------

[e57c3e455e4a] 2005-04-07 20:59:35 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make storage class specifiers move correctly up the chain of type definitions (they always go to the outernmost entry).

Make type and symbol printout a lot prettier, and more
C-like.

Files: parse.c (+8/-6), show-parse.c (+10/-8), symbol.c (+3/-0), symbol.h (+2/-0)
--------------------------------------------------------------------------------

[5bc9d5ec00b1] 2005-04-07 20:59:35 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Parse enum declarations, and associate the enum's with the proper values.

Make macro re-declaration legal if the new and old
values match.

Files: expression.h (+3/-0), parse.c (+24/-3), pre-process.c (+29/-9), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[513117bdcb4c] 2005-04-07 20:59:34 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Split up the printout functions into a file of their own.

Parse trees, symbols and expressions are now printed out
in show-parse.c instead of cluttering up the main parsing
files.

Files: Makefile (+4/-1), parse.c (+0/-155), show-parse.c (+313/-0), symbol.c (+0/-124)
--------------------------------------------------------------------------------

[64813fc70ff5] 2005-04-07 20:59:34 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Split up the expression parsing in "parse.c" into a file of its own - expression.c.

[Auto-summary] Modifies 2 source files: expression.c, parse.c. Updates header expression.h. Modifies build system. Changes: +398/-348 in 4 file(s)

Files: Makefile (+2/-2), expression.c (+347/-0), expression.h (+44/-0), parse.c (+5/-346)
--------------------------------------------------------------------------------

[a037a64f9f31] 2005-04-07 20:59:34 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Oops, looked at the wrong type for union/struct/enum/typeof cases.

When showing user-defined types, print the struct/union/enum
name rather than just "typedef"

Files: parse.c (+8/-6), symbol.c (+2/-0)
--------------------------------------------------------------------------------

[a8971acb6cbf] 2005-04-07 20:59:34 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add copyright statements and file comments. Add a FAQ, README, and placeholder LICENSE file.

[Auto-summary] Modifies 8 source files: lib.c, parse.c, pre-process.c and 5 more. Updates 5 headers. Updates documentation. Changes: +235/-11 in 16 file(s)

Files: FAQ (+68/-0), LICENSE (+31/-0), README (+72/-0), lib.c (+3/-1), lib.h (+7/-2), ... and 11 more
--------------------------------------------------------------------------------

[f1d060b1cf8e] 2005-04-07 20:59:33 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Show for/while/do statements in debugging. Make symbol type debugging slightly less verbose.

[Auto-summary] Modifies 2 source files: parse.c, symbol.c. Changes: +28/-6 in 2 file(s)

Files: parse.c (+28/-5), symbol.c (+0/-1)
--------------------------------------------------------------------------------

[5a58f1f8e5ca] 2005-04-07 20:59:33 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Fix constant expression parsing (a constant expression can contain conditionals, but _not_ assignment expressions)

[Auto-summary] Modifies 2 source files: parse.c, pre-process.c. Changes: +20/-17 in 2 file(s)

Files: parse.c (+18/-15), pre-process.c (+2/-2)
--------------------------------------------------------------------------------

[59c2caf60ac4] 2005-04-07 20:59:33 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: More simplification and fixing of type parsing

[Auto-summary] Modifies parse.c. Changes: +7/-8 in 1 file(s)

Files: parse.c (+7/-8)
--------------------------------------------------------------------------------

[c8a1d4481bdc] 2005-04-07 20:59:32 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: More expression parsing simplifications.

[Auto-summary] Modifies parse.c. Changes: +30/-29 in 1 file(s)

Files: parse.c (+30/-29)
--------------------------------------------------------------------------------

[185e65d5f69c] 2005-04-07 20:59:32 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Ok, move closer to a proper type parser. It's still way too confused and ugly, but it will slowly be getting there. I think.

[Auto-summary] Modifies 3 source files: parse.c, symbol.c, test-parsing.c. Updates header symbol.h. Changes: +116/-97 in 4 file(s)

Files: parse.c (+91/-75), symbol.c (+18/-20), symbol.h (+6/-2), test-parsing.c (+1/-0)
--------------------------------------------------------------------------------

[4f7b4e2caf00] 2005-04-07 20:59:32 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: It's ok to have an empty type declaration with no identifier.

Make statement debugging show "break" statements too.

Files: parse.c (+13/-6)
--------------------------------------------------------------------------------

[0cea268c1baf] 2005-04-07 20:59:32 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make iterators take a helper datum, and tell the callback whether the entry is the first or last.

Make printouts prettier by using the new iterator functionality.

Files: lib.c (+9/-3), lib.h (+7/-5), parse.c (+38/-46), parse.h (+1/-1), scope.c (+2/-2), ... and 3 more
--------------------------------------------------------------------------------

[638f14d0e9e0] 2005-04-07 20:59:31 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Better warning for undeclared identifiers

[Auto-summary] Modifies parse.c. Changes: +1/-1 in 1 file(s)

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[549a7c90da23] 2005-04-07 20:59:31 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Bind symbols when declared. Bind arguments to functions.

Fix up function argument list to use a proper symbol list.

Files: parse.c (+51/-19), parse.h (+3/-1), pre-process.c (+4/-4), symbol.c (+7/-1), symbol.h (+3/-1)
--------------------------------------------------------------------------------

[904f38b41f4d] 2005-04-07 20:59:31 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix dependencies again, after again having been bitten by me being lazy and not doing it right.

[Auto-summary] Modifies build system. Changes: +6/-3 in 1 file(s)

Files: Makefile (+6/-3)
--------------------------------------------------------------------------------

[0474cdb18bbe] 2005-04-07 20:59:31 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add symbol scoping for proper parsing.

[Auto-summary] Modifies 3 source files: parse.c, scope.c, symbol.c. Updates 2 headers. Modifies build system. Changes: +76/-6 in 6 file(s)

Files: Makefile (+2/-2), parse.c (+9/-4), scope.c (+47/-0), scope.h (+14/-0), symbol.c (+3/-0), ... and 1 more
--------------------------------------------------------------------------------

[15f971e49f7b] 2005-04-07 20:59:30 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Parse __alignof__ (although right now it ends up parsing as a EXPR_SIZEOF with the token being "alignof").

Remove stale debug printouts.

Files: parse.c (+3/-1), pre-process.c (+0/-3), symbol.c (+4/-0), symbol.h (+3/-0), tokenize.c (+1/-5)
--------------------------------------------------------------------------------

[6e13b4d9828b] 2005-04-07 20:59:30 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make listop functions keep the lists in chronological order

[Auto-summary] Modifies lib.c. Updates header lib.h. Changes: +19/-7 in 2 file(s)

Files: lib.c (+16/-5), lib.h (+3/-2)
--------------------------------------------------------------------------------

[068652dffb79] 2005-04-07 20:59:30 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: First cut at retokenization (ie 'a ## b') in macro expansion.

[Auto-summary] Modifies pre-process.c. Changes: +101/-0 in 1 file(s)

Files: pre-process.c (+101/-0)
--------------------------------------------------------------------------------

[f313ee801589] 2005-04-07 20:59:30 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix up whitespace for token expansion to make printout prettier.

[Auto-summary] Modifies pre-process.c. Changes: +1/-0 in 1 file(s)

Files: pre-process.c (+1/-0)
--------------------------------------------------------------------------------

[c96f97790a6c] 2005-04-07 20:59:29 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix up warnings by adding includes and the proper prototypes.

[Auto-summary] Modifies 3 source files: parse.c, symbol.c, test-lexing.c. Updates header parse.h. Changes: +7/-8 in 4 file(s)

Files: parse.c (+1/-1), parse.h (+3/-0), symbol.c (+2/-7), test-lexing.c (+1/-0)
--------------------------------------------------------------------------------

[a6fbd0bb6699] 2005-04-07 20:59:29 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Print out statement parse trees so that we can verify that the parse is right.

[Auto-summary] Modifies 2 source files: parse.c, symbol.c. Updates header symbol.h. Changes: +78/-8 in 3 file(s)

Files: parse.c (+67/-3), symbol.c (+9/-3), symbol.h (+2/-2)
--------------------------------------------------------------------------------

[6b6ce5ca1dd6] 2005-04-07 20:59:29 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Avoid re-tokenizing header files that are protected by #ifndef X ... #endif X if X is already defined. This avoids doing unnecessary work on duplicate includes.

[Auto-summary] Modifies 3 source files: pre-process.c, test-lexing.c, tokenize.c. Updates header token.h. Changes: +53/-12 in 4 file(s)

Files: pre-process.c (+26/-3), test-lexing.c (+1/-0), token.h (+2/-1), tokenize.c (+24/-8)
--------------------------------------------------------------------------------

[9c8eaec54d3f] 2005-04-07 20:59:29 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Start tracking whether a stream may be constant or not. Very experimental.

[Auto-summary] Modifies pre-process.c. Changes: +40/-24 in 1 file(s)

Files: pre-process.c (+40/-24)
--------------------------------------------------------------------------------

[2398db910969] 2005-04-07 20:59:28 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make the tokenizer insert begin/end tokens at stream boundaries, so that the pre-processor might some day track them.

For now, make the pre-processor just mask them out of the stream.

Files: pre-process.c (+12/-3), symbol.c (+1/-1), token.h (+11/-1), tokenize.c (+41/-8)
--------------------------------------------------------------------------------

[2edd2ccf82c7] 2005-04-07 20:59:28 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Clean up makefile, add more dependencies.

[Auto-summary] Modifies build system. Changes: +12/-9 in 1 file(s)

Files: Makefile (+12/-9)
--------------------------------------------------------------------------------

[611b19ae7a2f] 2005-04-07 20:59:28 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Re-name the "action" thing as something saner - it's now a "stream".

Our pre-processor token allocator has different initialization needs
from the one in tokenize.c - don't try to share them.

Files: pre-process.c (+13/-3), token.h (+0/-2), tokenize.c (+128/-126)
--------------------------------------------------------------------------------

[616e161c24a6] 2005-04-07 20:59:27 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix fd leak in tokenization.

[Auto-summary] Modifies 3 source files: pre-process.c, test-lexing.c, test-parsing.c. Changes: +3/-0 in 3 file(s)

Files: pre-process.c (+1/-0), test-lexing.c (+1/-0), test-parsing.c (+1/-0)
--------------------------------------------------------------------------------

[8100d7038c8c] 2005-04-07 20:59:27 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Tokenization drops whitespace, but there is one area where it is meaningful in parsing: at preprocessor macro definition time, where the whitespace between the macro name and the potentially following '(' determines whether the macro takes arguments or not.

Make tokenization save off one bit of whitespace (in addition to the
one bit of newline that it already saves off).

Files: parse.c (+1/-0), pre-process.c (+7/-2), test-lexing.c (+5/-3), token.h (+3/-2), tokenize.c (+10/-1)
--------------------------------------------------------------------------------

[c11059ba1cf4] 2005-04-07 20:59:27 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Since we're making much more progress now, allow more warnings.

[Auto-summary] Modifies lib.c. Changes: +1/-1 in 1 file(s)

Files: lib.c (+1/-1)
--------------------------------------------------------------------------------

[c5f98cf195c7] 2005-04-07 20:59:27 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: This gets us up and parsing through a lot of the regular header files:  - Notice loudly if one of out list walkers end up looping.  - Fix the 'defined(x)' case for preprocessor conditionals.  - Add the internal gcc headers to the search path.  - Fix '#else' mixup with '#elif'

[Auto-summary] Modifies pre-process.c. Changes: +15/-7 in 1 file(s)

Files: pre-process.c (+15/-7)
--------------------------------------------------------------------------------

[bf2427a647e3] 2005-04-07 20:59:26 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Do preprocessor macro argument substitution.

[Auto-summary] Modifies pre-process.c. Changes: +72/-1 in 1 file(s)

Files: pre-process.c (+72/-1)
--------------------------------------------------------------------------------

[1273afcd6042] 2005-04-07 20:59:26 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make preprocessor expansion a hell of a lot more readable by splitting it up into several smaller functions.

[Auto-summary] Modifies pre-process.c. Changes: +35/-25 in 1 file(s)

Files: pre-process.c (+35/-25)
--------------------------------------------------------------------------------

[9fd8b08fe5ba] 2005-04-07 20:59:26 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Parse the incoming argument list for macro expansion.

[Auto-summary] Modifies pre-process.c. Updates header token.h. Changes: +33/-4 in 2 file(s)

Files: pre-process.c (+28/-2), token.h (+5/-2)
--------------------------------------------------------------------------------

[6fa17a65272b] 2005-04-07 20:59:26 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Don't be overly verbose when clearing an allocator.

[Auto-summary] Modifies lib.c. Changes: +0/-1 in 1 file(s)

Files: lib.c (+0/-1)
--------------------------------------------------------------------------------

[a298430ea802] 2005-04-07 20:59:25 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add scaffolding for argument handling of macros. Very preliminary.

[Auto-summary] Modifies pre-process.c. Updates header symbol.h. Changes: +29/-9 in 2 file(s)

Files: pre-process.c (+28/-9), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[c639eea3a17e] 2005-04-07 20:59:25 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Clear allocation statistics when clearing an allocator.

[Auto-summary] Modifies lib.c. Changes: +3/-0 in 1 file(s)

Files: lib.c (+3/-0)
--------------------------------------------------------------------------------

[025e893c8a08] 2005-04-07 20:59:25 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make the preprocessor use the C parser, and then evaluate preprocessor expressions by just walking the parse tree.

We de-allocate all the C preprocessor expressions at the end, before
we actually start doing the real C parsing. There is no history.

Files: Makefile (+2/-2), pre-process.c (+132/-113)
--------------------------------------------------------------------------------

[3982aeffa6d2] 2005-04-07 20:59:25 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Declare 'alloc_token()' for use in the pre-processor (which creates some tokens on the fly: "defined xxxx", "A ## B", "#A" etc)

[Auto-summary] Updates header token.h. Changes: +2/-0 in 1 file(s)

Files: token.h (+2/-0)
--------------------------------------------------------------------------------

[e94aa8a0001e] 2005-04-07 20:59:24 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Whitespace and comment fixes for testers

[Auto-summary] Modifies 2 source files: test-lexing.c, test-parsing.c. Changes: +10/-0 in 2 file(s)

Files: test-lexing.c (+1/-0), test-parsing.c (+9/-0)
--------------------------------------------------------------------------------

[ca8141026e71] 2005-04-07 20:59:24 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Create function to clear out the existing allocations. The preprocessor creates expression trees for its own conditional expressions, and they are not used after preprocessing.

[Auto-summary] Modifies lib.c. Updates header lib.h. Changes: +8/-1 in 2 file(s)

Files: lib.c (+6/-0), lib.h (+2/-1)
--------------------------------------------------------------------------------

[f9d206d60eec] 2005-04-07 20:59:24 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Properly expand tokens on #if/#elif/#include preprocessor lines

[Auto-summary] Modifies pre-process.c. Changes: +55/-34 in 1 file(s)

Files: pre-process.c (+55/-34)
--------------------------------------------------------------------------------

[730b9cd0c1f3] 2005-04-07 20:59:24 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Argh, fix the pre-processor expression parsing warning to warn at the right point.

[Auto-summary] Modifies pre-process.c. Changes: +3/-3 in 1 file(s)

Files: pre-process.c (+3/-3)
--------------------------------------------------------------------------------

[127a883c59e5] 2005-04-07 20:59:23 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make preprocessor errors more readable, to help adding the right expression parsing.

[Auto-summary] Modifies 2 source files: pre-process.c, tokenize.c. Changes: +4/-1 in 2 file(s)

Files: pre-process.c (+1/-1), tokenize.c (+3/-0)
--------------------------------------------------------------------------------

[b253c6d50a95] 2005-04-07 20:59:23 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Do proper recursive expansion, with the right avoidance of infinite self-expansions.

In particular

	#define A a B
	#define B b C
	#define C c A
	A

should result in 'a b c A' since 'A' won't be recursively expanded.

Files: pre-process.c (+30/-10)
--------------------------------------------------------------------------------

[baf5d53939b6] 2005-04-07 20:59:23 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix stream naming on include - we need to allocate stable storage for it instead of passing around a pointer to a static buffer that will change.

[Auto-summary] Modifies pre-process.c. Changes: +5/-2 in 1 file(s)

Files: pre-process.c (+5/-2)
--------------------------------------------------------------------------------

[969f0fd5fb07] 2005-04-07 20:59:23 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix 'elif' semantics: if we've ever seen a previous if that matched, we can't just switch from a false region to a true region. Use a "elif_ignore[]" stack to keep track of our elif nesting behaviour.

[Auto-summary] Modifies pre-process.c. Changes: +12/-10 in 1 file(s)

Files: pre-process.c (+12/-10)
--------------------------------------------------------------------------------

[ffb1b184fbf0] 2005-04-07 20:59:22 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Move some common parsing routines to "lib", so thatthe preprocessor and the "real" parser can share them.

Add some  initial preprocessor expression parsing.

Files: lib.c (+40/-0), lib.h (+4/-0), parse.c (+1/-25), pre-process.c (+124/-1), tokenize.c (+3/-29)
--------------------------------------------------------------------------------

[1dc135a3294a] 2005-04-07 20:59:22 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: When tokenizing integers, make the first character in the token string specify the type. Both octal and hex digits have to start with a '0', so change that to an 'o' for octal, and an 'x' for hex. That way we won't have to make that decision in multiple places.

[Auto-summary] Modifies tokenize.c. Changes: +16/-3 in 1 file(s)

Files: tokenize.c (+16/-3)
--------------------------------------------------------------------------------

[d88f111acc0a] 2005-04-07 20:59:22 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Teach the preprocessing pass to handle 'include' and 'elif'.

[Auto-summary] Modifies 4 source files: pre-process.c, test-lexing.c, test-parsing.c and 1 more. Updates header token.h. Changes: +109/-12 in 5 file(s)

Files: pre-process.c (+97/-2), test-lexing.c (+4/-4), test-parsing.c (+1/-1), token.h (+1/-1), tokenize.c (+6/-4)
--------------------------------------------------------------------------------

[8dc3933e6db4] 2005-04-07 20:59:22 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Do much more pre-processing work: support #ifdef/#else/#endif sanely and efficiently, including proper nesting.

Add 'undef'/'error'/'warning' support.

Files: lib.c (+24/-8), lib.h (+10/-5), pre-process.c (+196/-21), token.h (+0/-1)
--------------------------------------------------------------------------------

[a8324a93b4a3] 2005-04-07 20:59:21 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Avoid using named initializers for anonymous union entries, since some versions of gcc don't handle it right. They were just explicitly initialized to zero anyway, so we can just drop the initializer.

[Auto-summary] Modifies parse.c. Changes: +2/-2 in 1 file(s)

Files: parse.c (+2/-2)
--------------------------------------------------------------------------------

[82599b4ccfec] 2005-04-07 20:59:21 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Preprocessor symbol handling: handle simple cases of #define and symbol expansion (ie no argument-handling yet).

Mark the EOF token as being on a new line, to make preprocessing simpler.

Files: Makefile (+2/-2), pre-process.c (+83/-8), symbol.h (+15/-7), tokenize.c (+1/-0)
--------------------------------------------------------------------------------

[2540f9d534d3] 2005-04-07 20:59:21 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add initial preprocessor pass (doesn't actually do much)

Make tokens know about newlines

Files: Makefile (+4/-4), lib.c (+11/-0), parse.c (+0/-10), pre-process.c (+51/-0), test-lexing.c (+1/-0), ... and 3 more
--------------------------------------------------------------------------------

[ac3017e7f376] 2005-04-07 20:59:21 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Implement space-efficient allocator for small data structures. We do not want any allocation overhead when some of the data structures average a length of 2.8 bytes (integer constant tokens).

Fix up integer constant token parsing (don't try to evaluate them
at parse-time, we just lose information that way).

Files: lib.c (+81/-12), lib.h (+5/-3), test-lexing.c (+2/-2), test-parsing.c (+2/-0), token.h (+4/-4), ... and 1 more
--------------------------------------------------------------------------------

[14030f19b5b4] 2005-04-07 20:59:20 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make 'struct token' smaller (it's way too common).

Make the token stream end with an endless loop of 'end_token_entry'.

Files: parse.c (+19/-24), token.h (+22/-6), tokenize.c (+14/-4)
--------------------------------------------------------------------------------

[5196e756b49c] 2005-04-07 20:59:20 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix cast parsing. Add parsing of gcc typeof/attribute stuff. Parse the conditional expression ( x ? y : z ) and gcc statement expressions. Fix complex typenames. Add some rudimentary parsing of inline asms.

This parses most of a kernel "sched.c" with all header files. It still gets
some declarations wrong, though (in particular, it accepts type specifiers
in the pointer declaration that should only accept type _qualifiers_).

Files: parse.c (+182/-53), parse.h (+11/-0), symbol.c (+31/-5), symbol.h (+16/-4)
--------------------------------------------------------------------------------

[384be0b5bfe4] 2005-04-07 20:59:20 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Tokenize integer constants with "u" and "l" specifiers (drop them for now).

Fix three-character special token (... <<= >>=) tokenization

Files: token.h (+1/-1), tokenize.c (+17/-11)
--------------------------------------------------------------------------------

[9abdc01f8a81] 2005-04-07 20:59:20 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add allocators for statistics

[Auto-summary] Modifies 5 source files: lib.c, parse.c, symbol.c and 2 more. Updates header list.h => lib.h. Changes: +51/-27 in 6 file(s)

Files: lib.c (+24/-1), list.h => lib.h (+11/-0), parse.c (+3/-10), symbol.c (+2/-6), test-parsing.c (+7/-0), ... and 1 more
--------------------------------------------------------------------------------

[ba6259f106bb] 2005-04-07 20:59:19 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add parsing for 'for', 'while', 'do', 'goto' and label statements.

[Auto-summary] Modifies 2 source files: parse.c, symbol.c. Updates 2 headers. Changes: +74/-2 in 4 file(s)

Files: parse.c (+48/-1), parse.h (+17/-1), symbol.c (+5/-0), symbol.h (+4/-0)
--------------------------------------------------------------------------------

[08c32daf9934] 2005-04-07 20:59:19 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Parse compound statements, 'break', 'continue', 'default', 'case' and 'switch' statements.

[Auto-summary] Modifies 2 source files: parse.c, symbol.c. Updates 2 headers. Changes: +65/-4 in 4 file(s)

Files: parse.c (+39/-4), parse.h (+14/-0), symbol.c (+7/-0), symbol.h (+5/-0)
--------------------------------------------------------------------------------

[728ce2003864] 2005-04-07 20:59:19 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Parse if-else and return statements

[Auto-summary] Modifies 2 source files: parse.c, symbol.c. Updates 2 headers. Modifies build system. Changes: +51/-20 in 5 file(s)

Files: Makefile (+1/-1), parse.c (+34/-14), parse.h (+8/-4), symbol.c (+4/-0), symbol.h (+4/-1)
--------------------------------------------------------------------------------

[509d3b1118fd] 2005-04-07 20:59:19 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Parse a lot more types (including complex structures and unions and function pointers). Still missing enum initializer parsing, but we fake it for now.

This actually parses the header files, and stumbles only when it starts
seeing its first real statements (it can do expression statements, but
that's about it).

Files: lib.c (+33/-0), list.h (+40/-0), parse.c (+95/-30), parse.h (+7/-3), symbol.c (+14/-27), ... and 2 more
--------------------------------------------------------------------------------

[f0c1d74cf856] 2005-04-07 20:59:18 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Parse enums and structures properly. Name the types nicely.

[Auto-summary] Modifies 2 source files: parse.c, symbol.c. Updates header symbol.h. Changes: +72/-48 in 3 file(s)

Files: parse.c (+66/-44), symbol.c (+5/-3), symbol.h (+1/-1)
--------------------------------------------------------------------------------

[d7b53089c8d7] 2005-04-07 20:59:18 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix up confusion between different typedefs and namespaces.

Make struct/union parsing do the right thing.

Files: parse.c (+62/-40), symbol.c (+23/-18), symbol.h (+17/-4), token.h (+4/-3), tokenize.c (+9/-6)
--------------------------------------------------------------------------------

[44885a47c759] 2005-04-07 20:59:18 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Make lexing tester print out string constants properly.

Make string constants contain the final '\0' at the end.

Files: test-lexing.c (+6/-13), tokenize.c (+4/-3)
--------------------------------------------------------------------------------

[f88d8a0c2843] 2005-04-07 20:59:18 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Parse structure-or-union-specifiers.

This fakes it. We parse it, but we don't generate a parse tree for 
the resulting type yet.

Files: parse.c (+50/-4), symbol.c (+1/-1), symbol.h (+4/-0)
--------------------------------------------------------------------------------

[ad14790f0fc1] 2005-04-07 20:59:17 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Fix warning, missed return value, and add 'struct', 'union' and 'enum' builtin idents.

Re-organize declaration-specifiers for 'struct', 'union' and 'enum'.

Files: parse.c (+24/-23), symbol.h (+7/-0), tokenize.c (+1/-1)
--------------------------------------------------------------------------------

[fe8ebbfbcd9d] 2005-04-07 20:59:17 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Initialize 'struct', 'union' and 'enum' built-ins.

[Auto-summary] Modifies 2 source files: symbol.c, tokenize.c. Updates header token.h. Changes: +55/-25 in 3 file(s)

Files: symbol.c (+9/-1), token.h (+2/-0), tokenize.c (+44/-24)
--------------------------------------------------------------------------------

[a3b3237dadef] 2005-04-07 20:59:17 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Start binding typedefs. More work needed, but this parses correctly:

typedef int a;
	a b = 0;

Use new 'add_symbol()' infrastructure.

Files: parse.c (+67/-15), parse.h (+3/-2), symbol.c (+41/-3), symbol.h (+18/-8), test-parsing.c (+4/-9)
--------------------------------------------------------------------------------

[dbf7bd47a40b] 2005-04-07 20:59:17 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Parse enough of an 'external-declaration' to be able to parse a simple

int main(int argc, char **argv)
	{
	}

program. Whee.

Files: parse.c (+36/-2), symbol.h (+2/-1)
--------------------------------------------------------------------------------

[2d76ef523eb4] 2005-04-07 20:59:16 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Add more type parsing: function and array declarators, function parameter lists etc. It can now parse things like

const volatile int hello(const int (*argc)(void), const char *const* argv);

apparently correctly.

Files: parse.c (+97/-65), parse.h (+2/-0), symbol.c (+46/-8), symbol.h (+13/-10), test-parsing.c (+5/-5), ... and 1 more
--------------------------------------------------------------------------------

[ffa4ddda9501] 2005-04-07 20:59:16 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Parse some type declarators. Much more to go.

[Auto-summary] Modifies parse.c. Changes: +51/-9 in 1 file(s)

Files: parse.c (+51/-9)
--------------------------------------------------------------------------------

[26a54886cb27] 2005-04-07 20:59:16 -0700
Author: Linus Torvalds <torvalds@penguin.transmeta.com>
Subject: Make for more readable "expected xxxx" messages.

Start parsing pointer, array and function types.

Files: parse.c (+115/-19), parse.h (+1/-1), symbol.c (+20/-1), symbol.h (+3/-0), test-parsing.c (+6/-3)
--------------------------------------------------------------------------------

[a61201e9598d] 2005-04-07 20:59:16 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: First cuts at simple type declaration and statement parsing.

[Auto-summary] Modifies 3 source files: parse.c, symbol.c, test-parsing.c. Updates 2 headers. Changes: +261/-27 in 5 file(s)

Files: parse.c (+86/-7), parse.h (+25/-1), symbol.c (+114/-8), symbol.h (+32/-8), test-parsing.c (+4/-3)
--------------------------------------------------------------------------------

[15c00b442bda] 2005-04-07 20:59:15 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Parse assignment expressions too..

[Auto-summary] Modifies parse.c. Changes: +27/-1 in 1 file(s)

Files: parse.c (+27/-1)
--------------------------------------------------------------------------------

[a9400ca17ec9] 2005-04-07 20:59:15 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Start handling minimal semantic information, needed for types.

This adds a layer of symbol information on top of the raw tokens.

Files: Makefile (+3/-2), parse.c (+55/-20), parse.h (+5/-0), symbol.c (+33/-0), symbol.h (+37/-0), ... and 4 more
--------------------------------------------------------------------------------

[24104678556e] 2005-04-07 20:59:15 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Mark local parsing functions 'static'.

Add support for parsing function calls.

Cleanup namespace.

Files: parse.c (+35/-18), test-lexing.c (+1/-1), token.h (+1/-0), tokenize.c (+1/-1)
--------------------------------------------------------------------------------

[4968e7c01bd9] 2005-04-07 20:59:15 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Parse more C expressions.

Namespace handling (and types) still not even started.

Files: Makefile (+6/-4), lib.c (+13/-5), parse.c (+110/-25), parse.h (+8/-2)
--------------------------------------------------------------------------------

[90247bd7671b] 2005-04-07 20:59:14 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Add simple recursive-descent C expression parsing (but we only do the simple binops so far, type parsing is still way off).

Clean up and update tokenization.

Files: Makefile (+9/-2), lib.c (+39/-0), parse.c (+176/-0), parse.h (+24/-0), test-lexing.c (+1/-91), ... and 3 more
--------------------------------------------------------------------------------

[c3cd6a0a38da] 2005-04-07 20:59:14 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Ignore object files and the test app

[Auto-summary] No file changes detected.

--------------------------------------------------------------------------------

[3ece2ef7c0a3] 2005-04-07 20:59:14 -0700
Author: Linus Torvalds <torvalds@home.transmeta.com>
Subject: Yaah. I'm a retard, but I want to at least try to see how hard it is to do a semantic parser that is smaller than gcc is.

Right now this is just the lexer, though, along with a test app to print
the results back out to verify the thing.

Files: Makefile (+10/-0), test-lexing.c (+126/-0), token.h (+108/-0), tokenize.c (+559/-0)
--------------------------------------------------------------------------------

