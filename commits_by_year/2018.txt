================================================================================
Year: 2018 | Commits: 676 | Contributors: 12
Insertions: +37635 | Deletions: -11352
================================================================================

[fa232154d671] 2018-12-29 14:12:43 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: explain cause of 'incorrect type in conditional'

A conditional only make sense on a scalar type. If not, an
error is issued but the message doesn't explain the cause.

Fix this by adding the cause to the error message.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-1), validation/bad-type-twice0.c (+1/-1), validation/conditional-type.c (+8/-8)
--------------------------------------------------------------------------------

[aef334a2ccad] 2018-12-28 18:40:56 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: manpage: fix doc of '-Wcast-from-as'

It seems that the current doc for -Wcast-from-as was cut-and-pasted
but not adjusted correctly.

Fix the wording.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse.1 (+1/-1)
--------------------------------------------------------------------------------

[ddd82b9a3085] 2018-12-26 08:07:42 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Sparse v0.6.0

[Auto-summary] Modifies build system. Changes: +1/-1 in 1 file(s)

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[f379325b2c35] 2018-12-26 08:02:34 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add TODO list.

The Documentation directory contains a 'project ideas' document.
But some of the entries there are outdated, some are questionable
and some more are simply not clear about the problem or the goal.
Some important entries are also missing.

So, remove what's needed to be removed, reformulate unclear
entries and add a bunch of new things that should be done.
Also, rename the file to 'TODO.md' as this express more clearly
the intent of the document.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/TODO.md (+98/-0), Documentation/index.rst (+1/-1), Documentation/project-ideas.md (+0/-51)
--------------------------------------------------------------------------------

[2369d107e245] 2018-12-22 01:17:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: as-name: document that identifiers are OK for address spaces

A previous series allowed to used an indentifier to denotate an
address space but this wasn't documented.

Document it now in the manpage.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse.1 (+4/-3)
--------------------------------------------------------------------------------

[951a3d03869a] 2018-12-22 01:03:16 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: fix list formatting

Sphinx gives a warning on if_convert_phi()'s autodoc because
of some 'unknown indentation' caused by using the wrong marker
('#' instead of '*' or '#.').

Use the right markup: '*'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+3/-2)
--------------------------------------------------------------------------------

[514bd49b9378] 2018-12-21 10:25:53 +0100
Author: Tycho Andersen <tycho@tycho.ws>
Subject: expression.h: update comment to include other cast types

This part of the union is used with other cast types as well,
and also by EXPR_{SIZEOF,PTRSIZEOF,ALIGNOF},
so let's include those in the comment.

Signed-off-by: Tycho Andersen <tycho@tycho.ws>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expression.h (+2/-1)
--------------------------------------------------------------------------------

[aa654d8ef334] 2018-12-21 00:56:25 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove self-assignment of base_type

The parsing of enums contains a self-assignment to base_type.
But this self-assignment doesn't show very clearly that the
variable doesn't need to change and that some compilers complain.

So, replace that self-assignment by a null statement.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[112845e7cc22] 2018-12-21 00:33:05 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove -finline-functions from CFLAGS

By default, sparse is compiled with -finline-functions
but this flag as no effect on the generated code (since
gcc's defaults at -O2 already do automatic inlining).

So, remove this flag.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[320200821d63] 2018-12-21 00:05:49 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unused regno()

The function regno() is unused since a very long time and
replaced by show_pseudo().

So, remove this function.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+0/-8)
--------------------------------------------------------------------------------

[003116e1263d] 2018-12-20 23:49:13 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove redundant check of _Bool bitsize

To test if a type is a variant of _Bool it is useless
to test is_bool_type(x) *and* test if 'x->bit_size == 1'
since the first implies the second.

So, remove the test of the bitsize.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[b19ebd8c84c5] 2018-12-20 08:06:35 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'cleanup'

* small build cleanup related to LLVM
  * build: only need includedir from llvm-config
  * build: check if sparse-llvm needs libc++
* small cleanup
  * remove unneeded declarations in "compat.h"
  * remove unused arg in add_branch()
  * allocate BBs only after initial checks in linearize_short_conditional()

Files: Makefile (+2/-1), compat.h (+0/-2), linearize.c (+7/-5)
--------------------------------------------------------------------------------

[9933b78872f5] 2018-12-20 08:01:59 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'show-type'

* small improvemnets to show_typename()'s outout:
  * strip trailing space
  * don't display '<noident>'
  * do not display base type's redundant specifiers
  * do not let display string_ctype lika a base type 'string'

Files: show-parse.c (+8/-2), validation/bad-type-twice1.c (+1/-1), validation/bitwise-cast-ptr.c (+1/-1), validation/builtin-overflow.c (+36/-36), validation/c11-atomic.c (+3/-3), ... and 8 more
--------------------------------------------------------------------------------

[41c40878c422] 2018-12-19 21:03:55 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'bitwise-ptr'

* warn on casts to/from bitwise pointers

Files: evaluate.c (+19/-0), lib.c (+2/-0), lib.h (+1/-0), sparse.1 (+6/-0), validation/bitwise-cast-ptr.c (+33/-0), ... and 1 more
--------------------------------------------------------------------------------

[6bbd00570d30] 2018-12-19 18:30:10 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: allocate BBs after the guards

In linearize_short_conditional(), the 'merge' BB is directly
allocated at function entry but then some checks can directly
return without ever using this BB.

Move the allocation after the checks have been made.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+3/-1)
--------------------------------------------------------------------------------

[d3f150de0bc7] 2018-12-19 18:30:10 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unused arg in add_branch()

add_branch() has an argument for an expression but this argument
is not used anymore and doesn't seem to be of any possible use.

So, remove this unneeded arg.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+4/-4)
--------------------------------------------------------------------------------

[5fa48c03a4f7] 2018-12-19 18:30:10 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unneeded declarations in "compat.h"

struct stream & struct stat are defined in this file
but were only used for identical_files() which has been
removed years ago.

So, remove these declarations.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: compat.h (+0/-2)
--------------------------------------------------------------------------------

[e870df7a3620] 2018-12-18 22:38:06 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: check if sparse-llvm needs libc++

The output of 'llvm-config --system-libs' is not really complete
as libc++ may be needed but not reported as such by this command.

So, use the output of 'llvm-config --cxxflags' to check this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0)
--------------------------------------------------------------------------------

[65840c61dc7a] 2018-12-18 20:50:57 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: only need includedir from llvm-config

sparse-llvm doesn't need to full output of 'llvm-config --cflags',
it only needs where LLVM's header files can be found.

So, use 'llvm-config --includedir' instead.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[1cf02bb504bd] 2018-12-18 14:36:04 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: VERSION=0.6.0-rc1

I forgot to update the version number in the Makefile.
Here it is now.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[d290b052e19e] 2018-12-17 23:29:15 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: show-parse: remove string_ctype from typenames

Currently, a string_ctype (only used for the declaration of
builtin functions) is displayed as "string", not "char *".

Fix this by removing the entry for string_ctype from typenames[]
which should only contains the name of base types.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: show-parse.c (+0/-1)
--------------------------------------------------------------------------------

[0fe7ebb9cdb4] 2018-12-17 23:29:15 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: show-parse: do not display base type's redundant specifiers

In do_show_type(), builtin_typename() is used to display builtin
(base) types and modifier_string() is used to display modifiers.

However, most base types contains some intrinsic modifiers, the
type specifiers. So, a type like 'unsigned long' is displayed as
'unsigned long [unsigned] [long]'.

Fix this redundancy by not displaying the specifiers when displaying
a base_type (or an enum).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: show-parse.c (+2/-0), validation/bad-type-twice1.c (+1/-1), validation/builtin-overflow.c (+30/-30), validation/cast-bad-00.c (+2/-2), validation/choose_expr.c (+2/-2), ... and 1 more
--------------------------------------------------------------------------------

[87e9f4270a61] 2018-12-17 23:28:56 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: show-parse: don't display null ident in show_typename()

Often show_typename() is used to display a type and the associated
identifier is irrelevant but is displayed nevertheless.

However, when the identifier is itself not present, it is still
displayed as '<noident>', which is just noise and can be confusing.

Fix this by displaying nothing for null identifiers in show_typename().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: show-parse.c (+2/-1), validation/builtin-overflow.c (+6/-6), validation/c11-atomic.c (+3/-3), validation/cast-bad-00.c (+2/-2), validation/choose_expr.c (+2/-2), ... and 5 more
--------------------------------------------------------------------------------

[6002ded74587] 2018-12-17 23:19:34 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add a flag to warn on casts to/from bitwise pointers

Support for 'bitwise' integers is one of the main sparse's extension.

However, casts to or from pointers to bitwise types can be done
without incurring any sort of warnings although such casts can
be as wrong as direct casts to or from bitwise integers themselves.

Add the corresponding warnings and control them by a new flag
-Wbitwise-pointer (defaulting to off as it creates tens of
thousands warnings in the kernel).

CC: Thiebaud Weksteen <tweek@google.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+19/-0), lib.c (+2/-0), lib.h (+1/-0), sparse.1 (+6/-0), validation/bitwise-cast-ptr.c (+1/-2)
--------------------------------------------------------------------------------

[45503a2bb1cb] 2018-12-17 23:19:34 +0100
Author: Thiebaud Weksteen <tweek@google.com>
Subject: Add testcases for bitwise cast on pointer

since it seems that the strict type checking is not done
on pointers to restricted types.

Signed-off-by: Thiebaud Weksteen <tweek@google.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/bitwise-cast-ptr.c (+34/-0), validation/bitwise-cast.c (+6/-0)
--------------------------------------------------------------------------------

[105e0815ee9f] 2018-12-17 22:53:08 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'predefs' into tip

* add predefined macros for __INTMAX_TYPE__, __INT_MAX__, ...

Files: char.c (+2/-2), lib.c (+101/-65), lib.h (+1/-0), machine.h (+83/-0), show-parse.c (+42/-31), ... and 11 more
--------------------------------------------------------------------------------

[23ce05a0a167] 2018-12-17 22:50:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add predefine_min() and use it for __{WCHAR,WINT}_MIN__

wchar_t & wint_t seems to be the only integer types needing
the _MIN__ macros.

Extend predefine_ctype() to handle these and use it to define
__WCHAR_MIN__ & __WINT_MIN__.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+17/-2)
--------------------------------------------------------------------------------

[eadae505b5d1] 2018-12-17 22:50:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add predefine for __CHAR_UNSIGNED__

This macro is needed by <limits.h> to get, among others things,
CHAR_MAX from __SCHAR_MAX__.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+3/-1), machine.h (+6/-0)
--------------------------------------------------------------------------------

[01bd0384f3a1] 2018-12-17 22:50:16 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix the size of long double

The odd one here is, of course i386, with its 80-bit extended floats
taking 12 bytes. Idem for __m68k__.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target.c (+23/-2)
--------------------------------------------------------------------------------

[03a5abff482b] 2018-12-17 22:50:16 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add predefined macros for char{16,32}_t

These types are supposed to be defined the same as
uint_least{8,16}_t. So define them as 'ushort' and 'uint'.

Note: it seems that some archs define char32_t as 'ulong' although
      their 'uint' is 32bit ...

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+2/-0)
--------------------------------------------------------------------------------

[b56185087a19] 2018-12-17 22:50:06 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add predefined macros for [u]int32_t

These are a pain. All LP64 archs use [u]int. Good.
But some LP32 archs use [u]int and some others use [u]long.
Some even use [u]int for some ABI and [u]long for some others
(bare metal).

This really need to be target-specific to be correct.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+2/-0), target.c (+19/-0), target.h (+2/-0), validation/preprocessor/predef.c (+2/-0)
--------------------------------------------------------------------------------

[841a80bb813e] 2018-12-17 21:56:32 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add predefined macros for [u]int64_t

All LP32 archs use [u]llong and all LP64 use [u]long for these
but Darwin which seems to always use [u]llong.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+8/-0), target.c (+6/-0), target.h (+2/-0), validation/preprocessor/predef.c (+2/-0)
--------------------------------------------------------------------------------

[af4d1b73c7f9] 2018-12-17 21:56:32 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add predefined macros for [u]int{8,16}_t

All LP64 & LP32 use [u]char and [u]short for these ones.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+5/-0), validation/preprocessor/predef.c (+4/-0)
--------------------------------------------------------------------------------

[fc68f0d61037] 2018-12-17 21:56:32 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add predefined macros for [u]intmax

Seems to use [u]long for all LP64 archs and [u]llong
and all LP32 ones (but OpenBSD but it seems to not defines
the corresponding macros).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+6/-0), target.c (+2/-0), target.h (+2/-0), validation/preprocessor/predef.c (+2/-0)
--------------------------------------------------------------------------------

[f5eabb34da68] 2018-12-17 21:56:32 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add predefined macros for [u]intptr

Luckily, it seems all archs use for them the same types as
size_t & ssize_t.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+2/-0), validation/preprocessor/predef.c (+2/-0)
--------------------------------------------------------------------------------

[e019565f57e7] 2018-12-17 21:56:32 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add predefined macros for wint_t

This type seems to use 'unsigned int' on all archs but for
Darwin & FreeBSD.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-0), target.c (+4/-0), target.h (+1/-0)
--------------------------------------------------------------------------------

[63d65194edf1] 2018-12-17 21:56:32 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use the type for predefined_max()

[Auto-summary] Modifies lib.c. Changes: +5/-5 in 1 file(s)

Files: lib.c (+5/-5)
--------------------------------------------------------------------------------

[749f0c51d1da] 2018-12-17 21:56:29 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: give a type to wchar

This allows to use predefined_ctype() on wchar_t.

Note: currently __WCHAR_TYPE__ is defined to 'int'
      but this is incorrect on: i386, m68k, ppc32, ...

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: char.c (+2/-2), lib.c (+3/-3), lib.h (+1/-0), symbol.h (+1/-0), target.c (+29/-2), ... and 1 more
--------------------------------------------------------------------------------

[9b2e1eb4be1b] 2018-12-17 02:50:24 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: make predefined_type_size() more generic

This allows to have a single function to output the
size, the type, the maximal value, ...

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+38/-23), validation/preprocessor/predef-unsigned.c (+9/-0), validation/preprocessor/predef.c (+3/-0)
--------------------------------------------------------------------------------

[df93af7da3cb] 2018-12-16 17:58:15 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: show-parse: strip do_show_type()'s trailing space

It's possible that the result of do_show_type() ends with a space.

Strip this unneeded space.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: show-parse.c (+4/-0), validation/enum-mismatch.c (+2/-2)
--------------------------------------------------------------------------------

[55324619d9fd] 2018-12-14 13:58:20 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove duplicates from gcc-attr-list.h

gcc-attr-list.h constains list of 'known' attributes
but some of them are already defined in keyword_table[].

So, remove these duplicated attributes from the list
(including '__default__' which is not duplicated but doesn't
appear to be an attribute).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: gcc-attr-list.h (+0/-9)
--------------------------------------------------------------------------------

[137813ac795c] 2018-12-14 13:57:56 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse about asm inline

GCC's trunk now allows to specifiy 'inline' with asm statements.
This feature has been asked by kernel devs and will most probably
by used for the kernel.

So, teach sparse about this syntax too.

Note: for sparse, there is no semantic associated to this inline
      because sparse doesn't make any size-based inlining decisions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+27/-7), symbol.h (+2/-0), validation/asm-inline.c (+52/-0)
--------------------------------------------------------------------------------

[7f6221f9b4a6] 2018-12-14 00:40:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add builtin_type_suffix()

With this helper, we can easily output constants
with the correct type, like '0x123' for ints, '0x123UL'
for unsigned longs, ....

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: show-parse.c (+42/-31), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[1376b07cf339] 2018-12-14 00:40:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use bits_mask() for predefined_max()

Creating a bit mask using '(1 << n) - 1' is undefined if
n is as big as the width of an int.

Use the safe helper bits_mask() to create the mask/value
for predefined_max().

Note: predefined_max() is currently correct only for signed types.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+2/-1)
--------------------------------------------------------------------------------

[f010d1ae2a19] 2018-12-14 00:40:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: allow optional "_T" suffix to __SIZEOF_XXX__

This allows to be more generic.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+12/-12)
--------------------------------------------------------------------------------

[2527752a81b6] 2018-12-14 00:40:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix '__SIZE_TYPE__' for LLP64

size_t_ctype is set to uint, ulong or ullong, depending on
the architecture (ullong is only used for LLP64).

However, when emitting '__SIZE_TYPE__', it's only compared to ulong
or uint.

Fix this by using an small helper directly using the right
struct symbol * and using builtin_typename() to output the
right type. This way we're guaranteed that '__SIZE_TYPE__'
is kept coherent with the internal type: size_t_ctype.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+7/-10), validation/preprocessor/predef-llp64.c (+0/-1)
--------------------------------------------------------------------------------

[b6f0362baae2] 2018-12-14 00:40:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: test predef macros on LP32/LP64/LLP64

Now these tests should succeed and be meaningful on
all archs.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/preprocessor/predef-char-bit.c (+0/-16), validation/preprocessor/predef-llp64.c (+10/-0), validation/preprocessor/predef-lp32.c (+9/-0), validation/preprocessor/predef-lp64.c (+9/-0), validation/preprocessor/predef-max.c (+0/-18), ... and 2 more
--------------------------------------------------------------------------------

[21308e0ad0de] 2018-12-14 00:40:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: test endianness with __BYTE_ORDER__

The detection of the native endianness is currently done by
testing if __BIG_ENDIAN__ is defined.

However, not all native big endian platforms define this macro.

Test the endianness with __BYTE_ORDER__.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: machine.h (+1/-1)
--------------------------------------------------------------------------------

[d66213e883fd] 2018-12-14 00:40:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Consolidate 'machine detection' into "machine.h"

The file "lib.c' contains some defines and have some #ifdefery
to detect the data model of the native machine (LP32/LP64).
Same for the native endianness.

Move these into "machine.h" where the platform detection is
already done.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-21), machine.h (+23/-0)
--------------------------------------------------------------------------------

[ce50c885b8b0] 2018-12-14 00:40:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add detection of native platform

The underlying type of most builtin types (size_t, int32_t, ...), as
well as their size, the endianness and other parameters are platform
dependent. The minimal is to have these parameters correct on the
native machine.

Use the diffrent predefined macros to detect the native machine.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: machine.h (+54/-0)
--------------------------------------------------------------------------------

[6f9b33b07bb8] 2018-12-12 21:10:11 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'as-named' into tip

* prepare to identify & display the address spaces by name

Files: evaluate.c (+27/-24), parse.c (+40/-9), show-parse.c (+16/-8), symbol.c (+2/-2), symbol.h (+25/-1), ... and 6 more
--------------------------------------------------------------------------------

[4bf8f31e91c8] 2018-12-12 18:48:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: as-named: warn on bad address space

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+7/-7), show-parse.c (+3/-3), symbol.c (+2/-2), symbol.h (+5/-2)
--------------------------------------------------------------------------------

[54c243b16fdf] 2018-12-12 18:48:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: as-name: check for multiple address spaces at parsing time

Warn on non-sensical declarations like:
	int __user __iomem *ptr;
These can be easily be checked at parsing time.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+6/-1)
--------------------------------------------------------------------------------

[2da3f3cdd4b6] 2018-12-12 18:48:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: as-name: allow ident as address_space

Currently, address space 1 is displayed as '<asn:1>' and so on.
Now that address spaces can be displayed by name, the address space
number should just be an implementation detail and it would make
more sense the be able to 'declare' these address space directly
by name, like:
	#define __user attribute((noderef, address_space(__user)))

Since directly using the name instead of an number creates some
problems internally, allow this syntax but for the moment keep
the address space number and use a table to lookup the number
from the name.

References: https://marc.info/?l=linux-sparse&m=153627490128505
Idea-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+26/-8), validation/as-name.c (+17/-0)
--------------------------------------------------------------------------------

[69fce9f7bc6f] 2018-12-12 18:48:49 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: as-name: use idents for address spaces

Currently, address space are identified by an number and
displayed as '<asn:%d>'. It would be more useful to display
a name like the one used in the code: '__user', '__iomem', ....

Prepare this by using an identifier instead of the AS number.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+24/-21), parse.c (+10/-2), show-parse.c (+12/-15), symbol.c (+2/-2), symbol.h (+22/-2)
--------------------------------------------------------------------------------

[0c43faa22682] 2018-12-10 01:03:25 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'fix-non-const-case' into tip

* fix linearization of non-constant switch-cases

Files: linearize.c (+5/-2), validation/linear/non-const-case.c (+37/-0)
--------------------------------------------------------------------------------

[e206ae034802] 2018-12-09 16:39:33 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: as-name: add and use show_as()

Use a function to display the address spaces.
This will allow to display a real name instead of '<asn:1>'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+3/-3), show-parse.c (+12/-1), symbol.h (+1/-0), tokenize.c (+2/-2), validation/Waddress-space-all-attr.c (+12/-12), ... and 3 more
--------------------------------------------------------------------------------

[fff61b26c44a] 2018-12-09 16:39:33 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: multi-buffer for idents

Currently, show_indent() use a single static buffer. It thus
can't be used like: printf("%s %s", show_ident(a), show_ident(b));

Fix this by using multiple buffers like done for show_pseudo()
and others.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: tokenize.c (+5/-1)
--------------------------------------------------------------------------------

[d6d857f2d160] 2018-12-09 16:27:08 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'maintainer' into tip

* manpage: update maintainer info
* manpage: add AUTHORS section

Files: sparse.1 (+15/-2)
--------------------------------------------------------------------------------

[72f2e2189754] 2018-12-09 16:16:50 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'dump-macros'

* fixes for -dD
* add support for -dM

Luc Van Oostenryck (2):
      dump-macro: break the loop at TOKEN_UNTAINT
      dump-macro: simplify processing of whitespace

Ramsay Jones (5):
      pre-process: suppress trailing space when dumping macros
      pre-process: print macros containing # and ## correctly
      pre-process: don't put spaces in macro parameter list
      pre-process: print variable argument macros correctly
      pre-process: add the -dM option to dump macro definitions

Files: lib.c (+32/-9), lib.h (+1/-0), pre-process.c (+20/-7), validation/preprocessor/dump-macros-only.c (+36/-0), validation/preprocessor/dump-macros.c (+16/-0)
--------------------------------------------------------------------------------

[b7f05bc01b1b] 2018-12-09 16:14:16 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: don't allow newlines inside string literals

Sparse allows (but warns about) a bare newline (not preceded by
a backslash) inside a string. Since this is invalid C, it's
probable that a terminating '"' is missing just before the newline.
In this case, allowing the newline implies accepting the following
characters until the next '"' is found, which is most case creates
a lot of irrelevant warnings.

Change this by disallowing newlines inside strings, exactly like
already done for character constants.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: tokenize.c (+3/-3), validation/check_byte_count-ice.c (+1/-1), validation/preprocessor/missing-delim.c (+2/-3)
--------------------------------------------------------------------------------

[ce6087ebfc54] 2018-12-08 23:09:13 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: man: update maintainer info

Update the info about the maintainer.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse.1 (+1/-2)
--------------------------------------------------------------------------------

[20ce574ee823] 2018-12-08 16:58:33 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: man: add AUTHORS section

Add a section about the authors.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse.1 (+5/-0)
--------------------------------------------------------------------------------

[c497a2606b70] 2018-12-08 16:23:46 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: man: add section about reporting bugs

Add a small section about contributing and reporting bugs.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse.1 (+9/-0)
--------------------------------------------------------------------------------

[485700db8ffc] 2018-12-08 16:05:49 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for missing deliminator ' or "

Add a testcase for "Newline in string or character constant" vs.
"missing delimitator" upcoming change.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/preprocessor/missing-delim.c (+18/-0)
--------------------------------------------------------------------------------

[2de2f47f8f7b] 2018-12-06 22:35:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cgcc: use 'i386' for the arch instead of 'i86'

cgcc can be used when cross-compiling if the target architecture
is given with '-target=<arch>'.

However, the name that needs to be given for the i386 arch is 'i86'.

Fix this by changing the name 'i86' into 'i386'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+2/-2)
--------------------------------------------------------------------------------

[648380c13eca] 2018-12-01 02:16:24 +0100
Author: John Levon <levon@movementarian.org>
Subject: Conditionalize 'warning: non-ANSI function ...'

Sparse unconditionally issues warnings about non-ANSI function
declarations & definitions.

However, some environments have large amounts of legacy headers
that are pre-ANSI, and can't easily be changed. These generate
a lot of useless warnings.

Fix this by using the options flags -Wstrict-prototypes &
-Wold-style-definition to conditionalize these warnings.

Signed-off-by: John Levon <levon@movementarian.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+4/-0), lib.h (+2/-0), parse.c (+7/-4), validation/old-style-definition0.c (+14/-0), validation/old-style-definition1.c (+18/-0), ... and 2 more
--------------------------------------------------------------------------------

[a0f34e0fd2a4] 2018-12-01 02:15:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Accept comma-separated list for function declarations.

The declaration of a function without prototype is currently
silently accepted by sparse but a warning is issued for
'old-style' declarations:
	... warning: non-ANSI function declaration ...

However, the difference between these two cases is made by
checking if a ';' directly follow the parentheses. So:
	int foo();
is silently accepted, while a warning is issued for:
	int foo(a) int a;
but also for:
	int foo(), bar();
This last case, while unusual, is not less ANSI than a simple
'int foo();'. It's just detected so because there is no ';'
directly after the first '()'.

Fix this by also using ',' to detect the end of function
declarations and their ANSIness.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[eb35b2e8aa79] 2018-12-01 02:14:10 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Use -Wimplicit-int when warning about missing K&R argument types

In legacy environment, a lot of warnings can be issued about
arguments without an explicit type.

Fix this by contitionalizing such warnings with the flag
-Wimplicit-int, reducing the level of noise in such environment.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+2/-0), lib.h (+1/-0), parse.c (+4/-1), validation/implicit-KR-arg-type0.c (+15/-0)
--------------------------------------------------------------------------------

[6f7aa5e84dac] 2018-12-01 02:12:45 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix implicit K&R argument types

In an old-style function definition, if not explicitly specified,
the type of an argument defaults to 'int'.

Sparse issues an error for such arguments and leaves the type
as 'incomplete'. This can then create a cascade of other warnings.

Fix this by effectively giving the type 'int' to such arguments.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+3/-1), validation/implicit-KR-arg-type1.c (+16/-0)
--------------------------------------------------------------------------------

[d3038d8fce94] 2018-11-29 23:48:21 +0100
Author: John Levon <levon@movementarian.org>
Subject: Ignore #ident directives

Legacy code can be littered with the non-standard "#ident" directive;
ignore it.

Signed-off-by: John Levon <levon@movementarian.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+6/-0), validation/preprocessor/ident-pragma.c (+12/-0), validation/preprocessor/ident.c (+12/-0)
--------------------------------------------------------------------------------

[0e2f8a827571] 2018-11-25 00:13:53 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dump-macro: simplify processing of whitespace

When dumping the macros, two special cases are needed
regarding whitespace:
* just before the macro body
* just after the macro body.
This is caused in parts because some misunderstanding
about the role of TOKEN_UNTAINT.

Happily, things can be simplified, which is what is
done in this patch.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+3/-6)
--------------------------------------------------------------------------------

[104f18af103f] 2018-11-24 18:45:01 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dump-macro: break the loop at TOKEN_UNTAINT

Since EOF are preceded by an UNTAINT, these UNTAINTs
need to be special cased to not print a whitespace and
are otherwise ignored, it make the handling of the
whitespaces slightly simpler to stop the loop not at EOF
but at these UNTAINT.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+1/-3)
--------------------------------------------------------------------------------

[500e7908ab50] 2018-11-24 18:29:01 +0100
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: pre-process: add the -dM option to dump macro definitions

The current -dD option outputs the macro definitions, in addition to the
pre-processed text. In contrast, the -dM option outputs only the macro
definitions.

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+32/-9), lib.h (+1/-0), validation/preprocessor/dump-macros-only.c (+36/-0), validation/preprocessor/dump-macros.c (+6/-0)
--------------------------------------------------------------------------------

[5607ba28a4e6] 2018-11-24 18:29:01 +0100
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: pre-process: print variable argument macros correctly

The dump_macros() function fails to correctly output the definition of
macros that have a variable argument list. For example, the following
macros:

    #define unlocks(...) annotate(unlock_func(__VA_ARGS__))
    #define apply(x,...) x(__VA_ARGS__)

are output like so:

    #define unlocks(__VA_ARGS__) annotate(unlock_func(__VA_ARGS__))
    #define apply(x,__VA_ARGS__) x(__VA_ARGS__)

Add the code necessary to print the ellipsis in the argument list to the
dump_macros() function and add the above macros to the 'dump-macros.c'
test file.

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+10/-1), validation/preprocessor/dump-macros.c (+5/-0)
--------------------------------------------------------------------------------

[ea3b2526d48a] 2018-11-24 18:29:01 +0100
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: pre-process: don't put spaces in macro parameter list

The dump_macros() function adds a ", " separator between the arguments
of a function-like macro. Using a simple "," separator, which aligns the
output with gcc, leads to one less distraction when comparing the output
of sparse and gcc.

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+1/-1), validation/preprocessor/dump-macros.c (+1/-1)
--------------------------------------------------------------------------------

[f32b8b2f6e79] 2018-11-24 18:29:01 +0100
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: pre-process: print macros containing # and ## correctly

The dump_macro() function fails to correctly output the definitions of
macros that contain the string operator '#', the concatenation operator
'##' and any macro parameter in the definition token list. For example,
the following macros:

    #define STRING(x) #x
    #define CONCAT(x,y) x ## y

are output like so:

    #define STRING(x) unhandled token type '21'
    #define CONCAT(x, y) unhandled token type '22'  unhandled token type '23'  unhandled token type '22'

Add the code necessary to handle those token types to the dump_macros()
function and add the above macros to the 'dump-macros.c' test file.

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+7/-0), validation/preprocessor/dump-macros.c (+5/-0)
--------------------------------------------------------------------------------

[756844b2a77d] 2018-11-24 18:03:11 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cgcc: teach about '-x c'

Currently, cgcc only checks input files if their names end with
'.c' or if given as stdout. Other files are explicitly ignored.
This generally corresponds to what is wanted but GCC allows
arbitrary input files if the option '-x <language>' is given.
Some projects use this mechanism, for example to use the C
pre-processor on non-C files.

This fails when cgcc is used as wrapper around sparse + GCC.

Fix this by teaching cgcc about the '-x c' option.

Reported-by: Antonio Ospite <ao2@ao2.it>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+8/-0)
--------------------------------------------------------------------------------

[c118480c756b] 2018-11-24 18:02:35 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cgcc: teach about '-o <file>'

The option '-o', in itself, doesn't need to be handled
specially by cgcc but this option takes an argument and
option arguments need to be ignored by cgcc (otherwise
they can be interpreted and filtered-out by cgcc).

Avoid potential problems with -o's argument by simply
ignoring it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+8/-0)
--------------------------------------------------------------------------------

[7bd25cdec3ff] 2018-11-24 17:57:22 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cgcc: add support to ignore argument(s) of options

cgcc only does a minimal processing and filtering of its
command line and most options are simply forwarded to sparse
and gcc.

However, if one of the ignored options takes an argument that
matches one of the non-ignored options, this argument will be
processed as an option with undesirable effect.

Allow options to specify the number of arguments they're taking
and avoid any processing or filtering of these arguments while
still forwarding them to sparse and gcc.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+9/-2)
--------------------------------------------------------------------------------

[3d41c2d953c1] 2018-11-24 14:01:31 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse about '-x <language>'

Sparse ignores unknown options but then doesn't know if
they have arguments or not. So, if '-x c' is given as option,
sparse will try to process a file named 'c'.

Fix this by teaching sparse about the option '-x' and its argument.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+8/-0)
--------------------------------------------------------------------------------

[21df8a9d5763] 2018-11-24 13:51:24 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse about '-o <file>'

Sparse knows about the '-o' option, parses it but does
nothing with it.

Change this by redirecting stdout to <file> unless <file>
is '-' since sparse (the lib) outputs to stdout by default.
But ignore this flag when sparse is used purely as an checker
since in this case it's not supposed to output to stdout
and would create undesired empty file, possibly erasing the
result of the compiler if one is used before sparse.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+13/-0), lib.h (+1/-0), sparse.c (+3/-0)
--------------------------------------------------------------------------------

[24278007c531] 2018-11-24 13:14:09 +0100
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: pre-process: suppress trailing space when dumping macros

The dump_macro() function outputs a trailing space character for every
macro. This makes comparing the '-dD' output from sparse to the similar
output from gcc somewhat annoying. The space character arises from the
presence of an <untaint> token directly before the <eof> token in the
macro definition token list. The <untaint> token seems to always have
the 'whitespace' flag set, which results in the output of a space in
order to separate it from the current token.

In order to suppress the unwanted space character, check if the next
token is an <untaint> token and, if so, don't print the space.

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+2/-0)
--------------------------------------------------------------------------------

[fdf8252f312a] 2018-11-23 02:45:45 +0100
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: constant: add -Wconstant-suffix warning

Currently, when used on the kernel, sparse issues a bunch
of warnings like:
	warning: constant 0x100000000 is so big it is long

These warning are issued when there is a discrepancy
between the type as indicated by the suffix (or the absence
of a suffix) and the real type as selected by the type
suffix *and* the value of the constant.

Since there is nothing incorrect with this discrepancy,
(no bits are lost) these warnings are more annoying than useful.
So, make them depending on a new warning flag -Wconstant-suffix
and make it off by default.

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+1/-1), expression.c (+1/-1), lib.c (+2/-0), lib.h (+1/-0), sparse.1 (+12/-0), ... and 2 more
--------------------------------------------------------------------------------

[cb777d342188] 2018-11-22 14:49:03 +0100
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: sparsei: add the --[no-]jit options

On the cygwin platform, a 'sparsei' backend test, which uses the llvm
'lli' tool, fails due to a dynamic linking error:

  $ make check
  ...
       TEST    sum from 1 to n (backend/sum.c)
  error: actual output text does not match expected output text.
  error: see backend/sum.c.output.* for further investigation.
  --- backend/sum.c.output.expected	2018-06-03 18:27:11.502760500 +0100
  +++ backend/sum.c.output.got	2018-06-03 18:27:11.307670000 +0100
  @@ -1,2 +0,0 @@
  -15
  -5050
  error: actual error text does not match expected error text.
  error: see backend/sum.c.error.* for further investigation.
  --- backend/sum.c.error.expected	2018-06-03 18:27:11.562997400 +0100
  +++ backend/sum.c.error.got	2018-06-03 18:27:11.481038800 +0100
  @@ -0,0 +1 @@
  +LLVM ERROR: Program used external function 'printf' which could not be resolved!
  error: Actual exit value does not match the expected one.
  error: expected 0, got 1.
  ...
  Out of 288 tests, 277 passed, 11 failed (10 of them are known to fail)
  make: *** [Makefile:236: check] Error 1
  $

Note the 'LLVM ERROR' about the 'printf' external function which could
not be resolved (linked).  On Linux, it seems that the 'lli' tool (JIT
compiler) can resolve the 'printf' symbol, with the help of the dynamic
linker, since the tool itself is linked to the (dynamic) C library.
On windows (hence also on cygwin), the 'lli' tool fails to resolve the
external symbol, since it is not exported from the '.exe'.

The 'lli' tool can be used as an interpreter, so that the JIT compiler
is disabled, which also side-steps this external symbol linking problem.
Add the --[no-]jit options to the 'sparsei' tool, which in turn uses
(or not) the '-force-interpreter' option to 'lli'. In order to fix the
failing test-case, simply pass the '--no-jit' option to 'sparsei'.

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparsei (+19/-1), validation/backend/sum.c (+1/-1)
--------------------------------------------------------------------------------

[885d147cd27d] 2018-11-22 14:49:03 +0100
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: sparsec: use a compatible exception model on cygwin

On the cygwin platform, some of the backend tests fail due to the 'llc'
tool using win32 'structured exception' assembler directives, which the
platform assembler 'as' does not accept:

  $ make check
  ...
       TEST    'hello, world' code generation (backend/hello.c)
  error: actual error text does not match expected error text.
  error: see backend/hello.c.error.* for further investigation.
  --- backend/hello.c.error.expected	2018-06-03 17:14:30.550972400 +0100
  +++ backend/hello.c.error.got	2018-06-03 17:14:30.478731900 +0100
  @@ -0,0 +1,6 @@
  +{standard input}: Assembler messages:
  +{standard input}:14: Error: invalid register for .seh_pushreg
  +{standard input}:14: Error: junk at end of line, first unrecognized character is `5'
  +{standard input}:20: Error: invalid register for .seh_setframe
  +{standard input}:20: Error: missing separator
  +mv: cannot stat '/tmp/tmp.oTA6mS.o': No such file or directory
  ...
  Out of 288 tests, 275 passed, 13 failed (10 of them are known to fail)
  make: *** [Makefile:236: check] Error 1
  $

The exception model used by 'llc' can be changed from the command line
to be one of 'default', 'dwarf', 'sjlj', 'arm' or 'wineh'. In this case
the default is 'wineh' (windows exception handling). The 'sjlj' model is
the older (setjmp,longjmp) stack-based model, which is no longer used on
Linux. The newer 'dwarf' model uses a 'zero cost' table based method.
(The 'arm' model is not relevant here). For more information, see [1].

After some experiments, using small test programs compiled with gcc and
g++, comparing the output of tools like 'nm' and 'objdump', it seems
that cygwin binutils are employing the 'sjlj' model. (Using the 'dwarf'
model on 'llc' also works on simple programs).

In order to fix the test failures, add an '-exception-model=sjlj' option
to the 'llc' invocation when executing sparsec on the cygwin platform.

[1] http://www.hexblog.com/wp-content/uploads/2012/06/Recon-2012-Skochinsky-Compiler-Internals.pdf

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparsec (+11/-1)
--------------------------------------------------------------------------------

[0eb8175d3e9c] 2018-11-20 21:28:42 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix expansion of function designator

The expression corresponding to the function pointer of indirect
call can be arbirarily complex. For example, it can contain a
statement expression or another call, possibly inlined.
These expressions must be expanded to insure that sub-expressions
involving 'sizeof()' or other operators taking a type as argument
(like __builtin_compatible_types_p()) are no more present (because
these expressions always evaluate to a compile-time constant and
so are not expected and thus not handled at linearization time).

However, this is not currently enforced, possibly causing some
failures during linearization with warnings like:
	warning: unknown expression (4 0)
(which correspond to EXPR_TYPE).

Fix this, during the expansion of function calls, by also expanding
the corresponding designator.

References: https://lore.kernel.org/lkml/1542623503-3755-1-git-send-email-yamada.masahiro@socionext.com/
Reported-by: Masahiro Yamada <yamada.masahiro@socionext.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Tested-by: Masahiro Yamada <yamada.masahiro@socionext.com>

Files: expand.c (+2/-0), validation/expand/function-pointer.c (+0/-1)
--------------------------------------------------------------------------------

[af0c93935459] 2018-11-20 03:21:59 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for missing function designator expansion

Add a testcase showing function designator are not expanded.

References: https://lore.kernel.org/lkml/1542623503-3755-1-git-send-email-yamada.masahi>
Reported-by: Masahiro Yamada <yamada.masahiro@socionext.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/expand/function-pointer.c (+23/-0)
--------------------------------------------------------------------------------

[06a45458a361] 2018-11-02 12:32:07 +0100
Author: Ben Dooks <ben.dooks@codethink.co.uk>
Subject: tokenize: check show_string() for NULL pointer

Fix issue where show_string() being passed a NULL pointer by accident.
This only happened during debugging, but would be a useful addition to
the checks in this function.

Signed-off-by: Ben Dooks <ben.dooks@codethink.co.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: tokenize.c (+1/-1)
--------------------------------------------------------------------------------

[c3fc97285416] 2018-10-30 12:42:36 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: add ptr_list_nth_entry()

Usually ptr lists are accessed iteratively via the FOR/END macros
but in few case we may need to access a given element in a list,
like for example when accessing a given argument of a function.

Create an helper doing that instead of open coding it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.c (+22/-0), ptrlist.h (+1/-0)
--------------------------------------------------------------------------------

[36477322d068] 2018-10-26 12:02:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: __attribute__((fallthrough)) can't simply be ignored

Currently, sparse has the attribute 'fallthrough' in its list of
known-but-ignored attributes (like almost every GCC's attributes).

But this attribute is a statement attribute, something which is
currently not supported (it's interpreted as the attribute of an empty
declaration which doesn't play well with -Wdeclaration-after-statement).

Fix this by stopping to consider this attribute as known. This will
allow __has_attribute(fallthrough) to correctly play its role.

Note: a more complete solution will need to parse this statement
      attribute and maybe be able to make the distinction between
      statement attributes, label attributes (also currently ignored),
      and type, function & variable attributes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: gcc-attr-list.h (+0/-1)
--------------------------------------------------------------------------------

[3a53a9e39290] 2018-10-05 03:31:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'fix-enum-type' into tip

[Auto-summary] Modifies parse.c. Updates header symbol.h. Adds/updates 14 test(s). Changes: +405/-64 in 16 file(s)

Files: parse.c (+95/-61), symbol.h (+5/-0), validation/bug-rshift-ub.c (+16/-0), validation/builtin-overflow.c (+1/-1), validation/enum-base-type.c (+29/-0), ... and 11 more
--------------------------------------------------------------------------------

[4686a668048f] 2018-10-05 03:29:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: enum: more specific error message for empty enum

Currently, the error message issued for an empty enum is
"bad enum definition". This is exactly the same message
used when one of the enumerator is invalid.

Fix this by using a specific error message.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-1), validation/enum-invalid.c (+1/-1)
--------------------------------------------------------------------------------

[f2a89f8cadfb] 2018-10-05 03:29:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: enum: default to unsigned

GCC uses an unsigned type for enum's basetype unless one of
the enumerators is negative.

Using 'int' for plain simple enumerators and then using the same
rule as for integer constants (int -> unsigned int -> long -> ...)
should be more natural but doing so creates useless warnings when
using sparse on the kernel code.

So, do the same as GCC:
* uses the smaller type that fits all enumerators,
* uses at least int or unsigned int,
* uses an signed type only if one of the enumerators is negative.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+6/-6), validation/builtin-overflow.c (+1/-1), validation/enum-mismatch.c (+2/-2), validation/enum-sign-gcc.c (+0/-1)
--------------------------------------------------------------------------------

[d39fc24d8281] 2018-10-05 03:29:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: enum: keep enumerators as int if they fit

In Standard C, enumerators have type 'int' and an unspecified
base type. OTOH, GCC (and thus sparse) llows any integer type
(and sparse also more or less allows bitwise types).
After the enum's decalration is parsed, the enumerators are
converted to the underlying type.

Also, GCC (and thus sparse) uses an unsigned type unless one of
the enumerators have a negative value.

This is a problem, though, because when comparing simple integers
with simple enumerators like:
	enum e { OK, ONE, TWO };
the integers will unexpectedly be promoted to unsigned.
GCC avoid these promotions by not converting the enumerators that
fit in an int.

For GCC compatibility, do the same: do not convert enumerators
that fit in an int.

Note: this is somehow hackish but without this some enum usages
      in the kernel give useless warnings with sparse.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+37/-0)
--------------------------------------------------------------------------------

[93e27240be70] 2018-10-05 03:29:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: enum: rewrite bound checking

To determine the base type of enums it is needed to keep
track of the range that the enumerators can take.

However, this tracking seems to be more complex than needed.
It's now simplified like this:
-) a single 'struct range' keep track of the biggest positive
   value and the smallest negative one (if any)
-) the bound checking in itself is then quite similar to
   what was already done:
   *) adjust the bit size if the type is negative
   *) check that the positive bound is in range
   *) if the type is unsigned
	-> check that the negative bound is 0
   *) if the type is signed
	-> check that the negative bound is in range

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+34/-50)
--------------------------------------------------------------------------------

[89e7785477a5] 2018-10-05 03:29:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: enum: warn on bad enums

During the parsing of enum definitions, if some invalid
type combination is reached, the base type is forced to
'bad_ctype'. Good.

However, this is done without a warning and it's only when
the enum is used that some sign of a problem may appear,
with no hint toward the true cause.

Fix this by issuing a warning when the base type becomes invalid
but only if the type of the enumerator is itself not already
set to 'bad_ctype' (since it this case a more specific warning
has already been issued).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+4/-2)
--------------------------------------------------------------------------------

[c7f7ccfcf188] 2018-10-05 03:29:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: enum: warn when mixing different restricted types

Sparse supports enum initializers with bitwise types but
this makes sense only if they are all the same type.

Add a check and issue a warning if an enum is initialized
with different restricted types.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+5/-0), validation/enum-bitwise-bad.c (+20/-0)
--------------------------------------------------------------------------------

[56a8674803a5] 2018-10-05 03:29:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: enum: only warn (once) when mixing bitwiseness

As an extension to the standard C types, parse supports bitwise
types (also called 'restricted') which should in no circonstances
mix with other types.

In the kernel, some enums are defined with such bitwise types
as initializers; the goal being to have slightly more strict enums.
While the semantic of such enums is not very clear, using a mix
of bitwise and not-bitwise initializers completely defeats the
desired stricter typing.

Attract some attention to such mixed initialization by issuing
a single warning for each such declarations.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+7/-0), validation/enum-bitwise-mixed.c (+29/-0)
--------------------------------------------------------------------------------

[f7117d94e5ba] 2018-10-05 03:29:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: enum: use the values to determine the base type

The C standard requires that the type of enum constants is 'int'.
So a constant not representable as an int can't be used as the
initializer of an enum. GCC extend this by using, instead of 'int',
the smallest type that can represent all the values of the enum:
first int, then unsigned int, long, ...
For sparse, we need to take in account the bitwise integers.

However, currently sparse doesn't do this based on the values
but on the type, so if one of the initializer is, for example,
1L, the base type is forced to a size as least as wide as 'long'.

Fix this by removing the call to bigger_enum_type().

Note that this is essentially a revert of commit
"51d3e7239: Make sure we keep enum values in a sufficiently large type for parsing"
which had the remark: "Make sure that the intermediate stages
keep the intermediate types big enough to cover the full range."
But this is not needed as during parsing, the values are kept at
full width and with their original type & value.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-14)
--------------------------------------------------------------------------------

[acc13744b394] 2018-10-05 03:29:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: enum: use the smallest type that fit

The C standard requires that the type of enum constants is 'int'
and let the enum base/compatible type be implementation defined.
For this base type, instead of 'int', GCC uses the smallest type
that can represent all the values of the enum (int, unsigned int,
long, ...)

Sparse has the same logic as GCC but if all the initializers
have the same type, this type is used instead.
This is a sensible choice but often gives differents
result than GCC.

To stay more compatible with GCC, always use the same logic
and thus only keep the common type as base type for restricted
types.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+0/-2), validation/enum-base-type.c (+0/-1), validation/enum-bounds.c (+0/-1), validation/enum-min-size.c (+0/-1)
--------------------------------------------------------------------------------

[604a148a73af] 2018-10-05 03:29:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: enum: fix cast_enum_list()

Sparse want that an enum's enumerators have all the same type.
This is done by first determining the common type and then
calling cast_enum_list() which use cast_value() on each member
to cast them to the common type.

However, cast_value() doesn't create a new expression and doesn't
change the ctype of the target: the target expression is supposed
to have already the right type and it's just the value that is
transfered from the source expression and size adjusted.
It's seems that in cast_enum_list() this has been overlooked
with the result that the value is correctly adjusted but keep
it's original type.

Fix this by updating, for each member, the desired type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-0), validation/enum-same-type.c (+0/-1)
--------------------------------------------------------------------------------

[5afb6e9ffe16] 2018-10-05 03:29:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: enum: add testcase for base & enumerator type

Add various testcases for checking enum's base & enumerator type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/enum-base-type.c (+30/-0), validation/enum-bitwise.c (+19/-0), validation/enum-bounds.c (+25/-0), validation/enum-init-constness.c (+9/-0), validation/enum-invalid.c (+11/-0), ... and 3 more
--------------------------------------------------------------------------------

[1a889a2e2efa] 2018-10-05 03:29:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: enum: add testcase for type of enum members

Members of an enum should all have the same type but
isn't so currently.

Add a testcase for it and mark it as 'known-to-fail'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/enum-same-type.c (+15/-0)
--------------------------------------------------------------------------------

[bff011270111] 2018-10-05 03:29:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: enum: fix UB when rshifting by full width

Shifting by an amount greater or equal than the width
of the type is Undefined Behaviour. In the present case,
when type_is_ok() is called with a type as wide as an
ullong (64 bits here), the bounds are shifted by 64
which is UB and at execution (on x86) the value is simply
unchanged (since the shift is done with the amount modulo 63).

This, of course, doesn't give the expected result and
as consequence valid enums can have an invalid base type
(bad_ctype).

Fix this by doing the shift with a small helper which
return 0 if the amount is equal to the maximum width.

NB. Doing the shift in two steps could also be a solution,
  as maybe some clever trick, but since this code is in
  no way critical performance-wise, the solution here
  has the merit to be very explicit.

Fixes: b598c1d75a9c455c85a894172329941300fcfb9f
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+15/-2), validation/bug-rshift-ub.c (+0/-1)
--------------------------------------------------------------------------------

[a4d38cf8543f] 2018-10-05 03:29:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: enum: add testcase for UB in oversized shift

type_is_ok(), used to calculate the base type of enums,
has a bug related to UB when doing a full width rshift.

Add a testcase for this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/bug-rshift-ub.c (+17/-0)
--------------------------------------------------------------------------------

[cdc6e0ce1b6d] 2018-10-05 03:29:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: is_int_type() returns false for SYM_RESTRICTs

It isn't at all obvious that is_int_type() return false for
restricted/bitwise types. It's even quite counter-intuitive.

So document this.

Note: Fortunately, there isn't a lot of callers and the main
      callers are all in parse.c and are OK. OTOH, the callers
      in sparse-llvm.c are wrong and need another helper.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+5/-0)
--------------------------------------------------------------------------------

[220d83b94922] 2018-09-26 03:34:04 +0200
Author: Vincenzo Frascino <vincenzo.frascino@arm.com>
Subject: print address space number for cast-from-AS warnings

This patch prints the address space number when a warning
"cast removes address space of expression" is triggered.

This makes easier to discriminate in between different address
spaces.

Signed-off-by: Vincenzo Frascino <vincenzo.frascino@arm.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-1), validation/Waddress-space-all-attr.c (+60/-0), validation/Waddress-space-strict.c (+3/-3)
--------------------------------------------------------------------------------

[e5cbdb62b0e3] 2018-09-10 00:55:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ssa: relax what can be promoted

During SSA conversion, it is checked what can be promoted
and what cannot. Obviously, ints, longs, pointers can be
promoted, enums and bitfields can too. Complication arise
with unions and structs. Currently union are only accepted
if they contains integers of the same size. For structs
its even more complicated because we want to convert
simple bitfields. What should be accepted is structs
containing either:
* a single scalar
* only bitfields and only if the total size is < long

However the test was slightly more strict than that:
it dodn't allowed a struct with a total size bigger
than a long. As consequence, on IP32, a struct containing
a single double wasn't promoted.

Fix this by moving the test about the total size and
only if some bitfield was present.

Reported-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ssa.c (+2/-2), validation/mem2reg/init-local32.c (+0/-2)
--------------------------------------------------------------------------------

[6c522d114cef] 2018-09-10 00:54:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: test: make 32-bit version of failed test

The test mem2reg/init-local.c succeeds on 64-bit but fails
on 32-bit.

Duplicate the test, one with -m64 and the other with -m32
and mark this one as known-to-fail.

Reported-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/mem2reg/init-local32.c (+29/-0), validation/mem2reg/{init-local.c => init-local64.c} (+2/-2)
--------------------------------------------------------------------------------

[8f98b88b4594] 2018-09-10 00:54:47 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: test: use integers of different sizes, even on 32-bit

The test optim/cse-size fials on 32-bit because it needs
two integers of different size but uses int & long.
These two types have indeed different sizes on 64-bit
(LP64) but not on 32-bit (ILP32).

Fix this by using short & int.

Reported-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/cse-size.c (+2/-2)
--------------------------------------------------------------------------------

[16517102991c] 2018-09-10 00:54:38 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: test: make test Waddress-space-strict succeed on 32-bit

The test Waddress-space-strict made assumptions about the
relative size of integers & pointers. Since this test was
crafted on a 64-bit machine, the test was running fine for
LP64 but failed on a 32-bit machine (or anything using IP32,
like using the -m32 option).

However, since the test is about conversion of address-spaces,
using integers of different size adds no value, and indeed
brings problems.

Fix this by limiting the conversions to a single integer type,
the one with the same size as pointers on ILP32 & LP64: long.

Reported-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/Waddress-space-strict.c (+7/-26)
--------------------------------------------------------------------------------

[78ce37356fd0] 2018-09-08 16:53:25 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix linearization of non-constant switch-cases

The linearization of switches & cases makes the assumption
that the expressions for the cases are constants (EXPR_VALUE).
So, the corresponding values are dereferenced without checks.

However, if the code uses a non-constant case, this dereference
produces a random value, probably one corresponding to some
pointers belonging to the real type of the expression.

Fix this by checking during linearization the constness of the
expression and ignore the non-constant ones.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+5/-2), validation/linear/non-const-case.c (+0/-1)
--------------------------------------------------------------------------------

[f43d375657f2] 2018-09-08 16:50:32 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for non-constant switch-case

Switches with non-constant cases are currently linearized
using as value the bit pattern present in the expression,
creating more or less random multijmps.

Add a basic testcase to catch this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/non-const-case.c (+38/-0)
--------------------------------------------------------------------------------

[20042e2851a6] 2018-09-06 23:51:38 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'rem-trivial-phi' into tip

* remove more complex phi-nodes

Files: linearize.h (+8/-0), simplify.c (+44/-19), validation/optim/trivial-phis.c (+14/-0)
--------------------------------------------------------------------------------

[895226abc4be] 2018-09-06 23:13:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'missing-return' and 'fix-logical-phi' into tip

* fix linearization/SSA when missing a return
* fix linearization/SSA of (nested) logical expressions

Files: Documentation/dev-options.rst (+1/-0), lib.c (+1/-0), linearize.c (+89/-52), sparse.c (+1/-1), validation/{ => linear}/asm-toplevel.c (+0/-0), ... and 12 more
--------------------------------------------------------------------------------

[4d2a7da9858f] 2018-09-06 02:57:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix linearization of nested logical expr

The linearization of nested logical expressions is not correct
regarding the phi-nodes and their phi-sources. For example, code like:
	extern int a(void); int b(void); int c(void);

	static int foo(void)
	{
		return (a() && b()) && c();
	}

gives (optimized) IR like:
	foo:
		phisrc.32   %phi1 <- $0
		call.32     %r1 <- a
		cbr         %r1, .L4, .L3
	.L4:
		call.32     %r3 <- b
		cbr         %r3, .L2, .L3
	.L2:
		call.32     %r5 <- c
		setne.32    %r7 <- %r5, $0
		phisrc.32   %phi2 <- %r7
		br          .L3
	.L3:
		phi.32      %r8 <- %phi2, %phi1
		ret.32      %r8

The problem can already be seen by the fact that the phi-node in L3
has 2 operands while L3 has 3 parents. There is no phi-value for L4.

The code is OK for non-nested logical expressions: linearize_cond_branch()
takes the sucess/failure BB as argument, generate the code for those
branches and there is a phi-node for each of them. However, with
nested logical expressions, one of the BB will be shared between
the inner and the outer expression. The phisrc will 'cover' one of
the BB but only one of them.

The solution is to add the phi-sources not before but after and add
one for each of the parent BB. This way, it can be guaranteed that
each parent BB has its phisrc, whatever the complexity of the sub-
expressions. With this change, the generated IR becomes:

	foo:
		call.32     %r2 <- a
		phisrc.32   %phi1 <- $0
		cbr         %r2, .L4, .L3
	.L4:
		call.32     %r4 <- b
		phisrc.32   %phi2 <- $0
		cbr         %r4, .L2, .L3
	.L2:
		call.32     %r6 <- c
		setne.32    %r8 <- %r6, $0
		phisrc.32   %phi3 <- %r8
		br          .L3
	.L3:
		phi.32      %r1 <- %phi1, %phi2, %phi3
		ret.32      %r1

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+31/-18), validation/linear/logical-phi0.c (+0/-1), validation/linear/logical.c (+90/-90), validation/linear/phi-order02.c (+0/-1), validation/linear/phi-order03.c (+0/-1)
--------------------------------------------------------------------------------

[39dba5892bba] 2018-09-06 02:57:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add tests for nested logical expr

Nested logical expressions are not correctly linearized.
Add a test for all possible combinations of 2 logical operators.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/logical-phi0.c (+49/-0)
--------------------------------------------------------------------------------

[4d4dc74a9afa] 2018-09-06 02:57:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix ordering of phi-node operand

The linearization of logical '&&' create a phi-node with its
operands in the wrong order relatively to the parent BBs.

Switch the order of the operands for logical '&&'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+2/-2), validation/linear/logical.c (+4/-4), validation/linear/phi-order01.c (+0/-1)
--------------------------------------------------------------------------------

[45c5f24a1769] 2018-09-06 02:56:58 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for wrong ordering in phi-nodes

In valid SSA there is a 1-to-1 correspondance between
each operand of a phi-node and the parents BB.
However, currently, this is not always respected.

Add testcases for the known problems.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/phi-order01.c (+17/-0), validation/linear/phi-order02.c (+17/-0), validation/linear/phi-order03.c (+9/-0), validation/linear/phi-order04.c (+12/-0)
--------------------------------------------------------------------------------

[4885582d162e] 2018-09-06 01:37:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: return nothing only in void functions

Currently, the code for the return is only generated if the
effectively return a type or a value with a size greater than 0.

But this mean that a non-void function with an error in its return
expression is considered as a void function for what the generated
IR is concerned, making things incoherent.

Fix this by using the declared type instead of the type of the
return expression.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+3/-3), validation/linear/missing-return3.c (+0/-1)
--------------------------------------------------------------------------------

[51c6129e93fd] 2018-09-06 01:37:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use a temp var for the return type/symbol

No functional changes, just preparing for the next patch.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+2/-1)
--------------------------------------------------------------------------------

[de710454f956] 2018-09-06 01:37:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use UNDEF for missing returns

If a return statement is missing in the last block, the
generated IR will be invalid because the number of operands
in the exit phi-node will not match the number or parent BBs.

Detect this situation and insert an UNDEF for the missing value.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+8/-0), validation/linear/missing-return0.c (+0/-1), validation/linear/missing-return1.c (+0/-1), validation/linear/missing-return2.c (+0/-1), validation/linear/missing-return4.c (+0/-1), ... and 1 more
--------------------------------------------------------------------------------

[e811962ea0f5] 2018-09-06 01:37:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: extract add_return() from linearize_return()

This will allow to reuse this code to generate valid IR
in the case of a missing return statement.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+16/-11)
--------------------------------------------------------------------------------

[b422403a2bda] 2018-09-06 01:37:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: the return BB is never terminated

After having called linearize_fn_statement(), it is tested
if the active BB is terminated or not. But by construction,
the active BB at this point is never terminated.

So, remove the unneeded test.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+7/-8)
--------------------------------------------------------------------------------

[4bc03f94bb1d] 2018-09-06 01:37:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: there is always an active BB after linearize_fn_statement()

After having called linearize_fn_statement() the active BB
is tested but at this point there is always an active BB as
linearize_fn_statement() always create one.

So, remove this unneeded test.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+2/-2)
--------------------------------------------------------------------------------

[2320a68d4d2b] 2018-09-06 01:37:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: specialize linearize_compound_statement()

linearize_compound_statement() contains code that is only
needed for the body of a function (including an already
inlined function).

To make things conceptually clearer and to facilitate some
incoming changes, remove this conditional part from
linearize_compound_statement(), used for all compound statements,
and move it into a new linearize_fn_statement(), used only
for function's body statements, where it is unconditional.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+16/-10)
--------------------------------------------------------------------------------

[15fa4d60ebba] 2018-09-06 01:37:32 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: topasm: top-level asm is special

Top-level ASM statements are parsed as fake anonymous functions.
Obviously, they have few in common with functions (for example,
they don't have a return type) and mixing the two makes things
more complicated than needed (for example, to detect a top-level
ASM, we had to check that the corresponding symbol (name) had a
null ident).

Avoid potential problems by special casing them and return early
in linearize_fn(). As consequence, they now don't have anymore
an OP_ENTRY as first instructions and can be detected by testing
ep->entry.

Note: It would be more logical to catch them even erlier, in
      linearize_symbol() but they also need an entrypoint and an
      active BB so that we can generate the single statement.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+6/-2), sparse.c (+1/-1), validation/{ => linear}/asm-toplevel.c (+0/-0)
--------------------------------------------------------------------------------

[448a527590b1] 2018-09-05 22:33:08 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use a temp var for function's upper-level statement

No functional changes, just preparing for the next patches.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+3/-2)
--------------------------------------------------------------------------------

[0737609cbddb] 2018-09-05 22:31:09 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for missing return in last block

In this case the phi-node created for the return value
ends up with a missing operand, violating the semantic
of the phi-node: map one value with each predecessor.

Add testcases for these missing returns.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/missing-return0.c (+11/-0), validation/linear/missing-return1.c (+16/-0), validation/linear/missing-return2.c (+12/-0), validation/linear/missing-return3.c (+19/-0), validation/linear/missing-return4.c (+15/-0), ... and 1 more
--------------------------------------------------------------------------------

[6aa0dd51b56f] 2018-09-05 22:27:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add linearization as a pass

If linearize_symbol() is called, it's meaningless to disable
linearization. As such, linearization was not really considered
as a pass. More exactly, there is no '-flinearize...' flag since
-flinearize-enable & -flinearize-disable are both meaningless.

However, -flinearize=last can be very useful for testing. So,
recognize 'linearize' as a pass and leave -flinearize-{en,dis}able
without effect.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/dev-options.rst (+1/-0), lib.c (+1/-0)
--------------------------------------------------------------------------------

[9bcea8b22d8a] 2018-09-01 22:53:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: trivial-phi: directly return the unique value

In trivial_phi(), the fact that the phi-node is trivial or not
is returned as an int and, if trivial, the unique value is
returned via the pointer given as first argument.

But these two results can easily be combined in a single one
by returning the unique value if trivial and NULL otherwise.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+9/-17)
--------------------------------------------------------------------------------

[2da84a231ad0] 2018-09-01 22:53:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: trivial-phi: use a temp var for the real source

By design, all operands of a phi-node are defined by a OP_PHISRC.
So, this phi-source need to be dereferenced to get the real source.

Since this value is used in several tests, use a temoparary variable
for it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+7/-2)
--------------------------------------------------------------------------------

[ef6862deb6e8] 2018-09-01 22:53:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: trivial-phi: early return

Once it has been detected that not all values are the same, nothing
can change this fact. So, the function trivial_phi() can return its
result as soon as this condition is met.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+1/-1)
--------------------------------------------------------------------------------

[21695db595bf] 2018-09-01 22:53:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: trivial-phi: extract trivial_phi() from clean_up_phi()

This will allow us, at a later step, to recursivaely test
the operands.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+22/-3)
--------------------------------------------------------------------------------

[e9c1560304d7] 2018-09-01 22:53:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: trivial-phi: make clean_up_phi() more sequential

Reorganize clean_up_phi() so that the tests in the loop
are more sequential. It functionally identical but will
help to detect other, less trivial, trivial phi-nodes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+5/-4)
--------------------------------------------------------------------------------

[1b2f4d1229fb] 2018-09-01 22:53:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: trivial-phi: add testcase for unneeded trivial phi-nodes

Trivial phi-nodes are phi-nodes having an unique possible outcome.
So, there is nothing to join and the phi-node target can be replaced
by the unique value.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/trivial-phis.c (+15/-0)
--------------------------------------------------------------------------------

[2a07333ec7ff] 2018-09-01 22:53:25 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: move DEF_OPCODE() to header file

as it will be needed before it was defined in simplify.c and
can be useful in other files too.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+8/-0), simplify.c (+0/-7)
--------------------------------------------------------------------------------

[d96da358cfa0] 2018-09-01 22:41:24 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: stricter warning for explicit cast to ulong

sparse issues a warning when user pointers are casted to integer
types except to unsigned longs which are explicitly allowed.
However it may happen that we would like to also be warned
on casts to unsigned long.

Fix this by adding a new warning flag: -Wcast-from-as (to mirrors
-Wcast-to-as) which extends -Waddress-space to all casts that
remove an address space attribute (without using __force).

References: https://lore.kernel.org/lkml/20180628102741.vk6vphfinlj3lvhv@armageddon.cambridge.arm.com/
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+2/-2), lib.c (+2/-0), lib.h (+1/-0), sparse.1 (+9/-0), validation/Waddress-space-strict.c (+56/-0)
--------------------------------------------------------------------------------

[4fd434fd65a4] 2018-09-01 21:45:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'dead-switch' into tip

* fix linearization of unreachable switch + label

Files: ir.c (+52/-3), linearize.c (+6/-5), linearize.h (+6/-0), validation/linear/unreachable-label0.c (+19/-0)
--------------------------------------------------------------------------------

[9059c1e96cba] 2018-09-01 21:45:09 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'has-attribute' into tip

* add support for __has_attribute()

Files: ident-list.h (+1/-0), lib.c (+1/-0), parse.c (+3/-1), pre-process.c (+24/-9), validation/preprocessor/has-attribute.c (+56/-0)
--------------------------------------------------------------------------------

[a8a310fa690e] 2018-09-01 21:42:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: trivial-phi: remove more complex trivial phi-nodes

In a set of related phi-nodes and phi-sources if all phi-sources
but one correspond to the target of one of the phi-sources, then
no phi-nodes is needed and all %phis can be replaced by the unique
source.
For example, code like:
	int test(void);
	int foo(int a)
	{
		while (test())
			a ^= 0;
		return a;
	}

used to produce an IR with a phi-node for 'a', like:
	foo:
		phisrc.32   %phi2(a) <- %arg1
		br          .L4
	.L4:
		phi.32      %r7(a) <- %phi2(a), %phi3(a)
		call.32     %r1 <- test
		cbr         %r1, .L2, .L5
	.L2:
		phisrc.32   %phi3(a) <- %r7(a)
		br          .L4
	.L5:
		ret.32      %r7(a)

but since 'a ^= 0' is a no-op, the value of 'a' is in fact
never mofified. This can be seen in the phi-node where its
second operand (%phi3) is the same as its target (%r7). So
the only possible value for 'a' is the one from the first
operand, its initial value (%arg1).

Once this trivial phi-nodes is removed, the IR is the expected:
	foo:
		br          .L4
	.L4:
		call.32     %r1 <- test
		cbr         %r1, .L4, .L5
	.L5:
		ret.32      %arg1

Removing these trivial phi-nodes will usually trigger other
simplifications, especially those concerning the CFG.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+17/-2), validation/optim/trivial-phis.c (+0/-1)
--------------------------------------------------------------------------------

[a5a8f8b9a1fe] 2018-09-01 08:43:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix linearization of unreachable switch (with reachable label).

An unreachable/inactive switch statement is currently not
linearized. That's nice because it avoids to create useless
instructions.

However, the body of the statement can contain a label which
can be reachable. If so, the resulting IR will contain a branch
to an unexisting BB. Bad.

For example, code like:
	int foo(int a)
	{
		goto label;
		switch(a) {
		default:
	label:
			break;
		}
		return 0;
	}

(which is just a complicated way to write: int foo(int a) { return 0; })

is linearized as:
	foo:
		br          .L1

Fix this by linearizing the statement even if not active.

Note: it seems that none of the other statements are discarded
      if inactive. Good. OTOH, statement expressions can also
      contains (reachable) labels and thus would need the same
      fix (which will need much more work).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+6/-5), validation/linear/unreachable-label0.c (+0/-1)
--------------------------------------------------------------------------------

[86556e1537cb] 2018-09-01 08:43:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add tescase for unreachable label in switch

or more exactly, an unreachable switch statement but containing a
reachable label. This is valid code but is curently wrongly linearized.

So, add a testcase for it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/unreachable-label0.c (+20/-0)
--------------------------------------------------------------------------------

[378ecc473f60] 2018-09-01 08:43:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ir-validate: validate return value

A valid non-void function should not return VOID.
VOID can only be returned if no return statements
have been issued.

Note: even if the expression is erroneous, and thus VOID,
      this returned value would be via a phi-node.
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ir.c (+15/-0)
--------------------------------------------------------------------------------

[d82ff76577aa] 2018-09-01 08:43:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ir-validate: ignore dead phis

Dead phi-nodes should be eliminated early or, even better,
never emitted.

For the moment, ignore them during IR validation since they
make the tests fail despite being no-ops.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ir.c (+3/-0)
--------------------------------------------------------------------------------

[47da866ed767] 2018-09-01 08:42:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ir-validate: add validation branch to dead BB

All branches must target an existing BB.

Validate that it is the case for BR, CBR & SWITCH
(COMPUTEDGOTO is left aside for the moment).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ir.c (+34/-3), linearize.h (+6/-0)
--------------------------------------------------------------------------------

[53480c6b4554] 2018-09-01 08:41:17 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: has-attr: add support for __has_attribute()

Sparse has support for a subset of GCC's large collection of
attributes. It's not easy to know which versions support this
or that attribute. However, since GCC5 there is a good solution
to this problem: the magic macro __has_attribute(<name>)
which evaluates to 1 if <name> is an attribute known to the
compiler and 0 otherwise.

Add support for this __has_attribute() macro by extending the
already existing support for __has_builtin().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ident-list.h (+1/-0), lib.c (+1/-0), pre-process.c (+24/-9), validation/preprocessor/has-attribute.c (+0/-1)
--------------------------------------------------------------------------------

[b77f1a1fdcc4] 2018-09-01 00:58:56 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: has-attr: add __designated_init__ & transparent_union

Attributes can be used with the plain keyword or squeezed
between a pair of double underscrore.

For some reasons, 'designated_init' was not allowed with its
underscores and '__transparent_union__' wasn't without them.

So, allow '__designated_init__' & 'transparent_union'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+2/-0)
--------------------------------------------------------------------------------

[3628ab3f4be5] 2018-09-01 00:58:39 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: has-attr: move 'mode' next to '__mode__'

In the list of keywords '__mode__' was just before the entries for
modes but 'mode' was lost in the middle of some other attributes.

Move 'mode' justbefore '__mode__'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[9fa3241dc90d] 2018-09-01 00:58:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: has-attr: add testcase for __has_attribute()

Add a testcase for the incoming support of __has_attribute().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/preprocessor/has-attribute.c (+57/-0)
--------------------------------------------------------------------------------

[ce2a7be62647] 2018-08-31 00:05:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'opcode' into tip

* consolidate instruction's properties into an opcode table

Files: Documentation/IR.rst (+6/-6), cse.c (+2/-9), flow.h (+1/-0), linearize.c (+2/-6), linearize.h (+0/-119), ... and 5 more
--------------------------------------------------------------------------------

[b814c73f9cef] 2018-08-30 23:58:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'volatile-bitfield' and 'mode-pointer' into tip

* fix: do not optimize away accesses to volatile bitfields
* support mode(__pointer__) and mode(__byte__)

Files: flow.c (+1/-1), linearize.c (+2/-0), linearize.h (+5/-1), memops.c (+2/-2), parse.c (+32/-14), ... and 3 more
--------------------------------------------------------------------------------

[5cf440518858] 2018-08-30 23:52:32 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix missing declarations

The recent SSA commits cause the 'make selfcheck' target to complain:
  $ make selfcheck
    ...
    CHECK   dominate.c
  dominate.c:26:14: warning: symbol 'bank_init' was not declared. Should it be static?
  dominate.c:129:6: warning: symbol 'idf_dump' was not declared. Should it be static?
    ...
    CHECK   ssa.c
  ssa.c:375:6: warning: symbol 'ssa_convert' was not declared. Should it be static?
    ...
  $

Add the missing declarations.

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dominate.c (+1/-1), dominate.h (+4/-0), ssa.c (+1/-0), ssa.h (+2/-0)
--------------------------------------------------------------------------------

[2be8fdea5dc4] 2018-08-26 01:14:15 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add a function to remove deadborn instructions

The values produced by expressions are not always used,
it's normal. However this produce useless code that will
need to be removed, sooner or later.

Currently, this removal of dead instructions is done as
part of the normal instruction simplification where each
kind of instruction are checked if it is used or not and,
if not, the usage is removed from the operands and the
instruction itself is removed. This has several drawbacks:
* this is done at each simplification cycle while it is
  only needed just after linearization
* there is a large overlap between what is needed to correctly
  remove these dead instructions and kill_instruction()
* instructions which are not simplified are forgotten
  for this and thus never removed.

Change this by adding a separate function to remove these
deadborn instructions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.h (+1/-0), simplify.c (+22/-0)
--------------------------------------------------------------------------------

[9dd1abf2b98f] 2018-08-26 01:14:15 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: opcode: add OPF_TARGET

Quite a bit of code needs to know, in one way or another, if a
given instruction produces a result (insn->target) or not.

However, this information is not explicit and when needed it
must be retrieved with correct switch/case statements. These
statements need to be updated when a new instruction is added.

Now that there is a table containing some of the instructions
properties, add to this table a flag telling if the instruction
produces a result or not.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: opcode.c (+2/-1), opcode.def (+82/-82), opcode.h (+4/-1)
--------------------------------------------------------------------------------

[ad118b85b408] 2018-08-26 01:14:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: opcode: add arity info

The arity is a useful property of each opcode.

Add this information to the opcode definitions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: opcode.c (+2/-1), opcode.def (+82/-82), opcode.h (+2/-1)
--------------------------------------------------------------------------------

[a48473a1d02a] 2018-08-26 01:13:24 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: opcode: centralize opcode definition

Opcodes are defined in linearize.c:enum opcode.
The file opcode.c also contains a table with opcodes properties.

Centralize these definitions into a single file: opcode.def that
will then be reused for enum opcode & the table.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+0/-116), opcode.c (+11/-36), opcode.def (+114/-0), opcode.h (+9/-0)
--------------------------------------------------------------------------------

[cf773f6cf67c] 2018-08-25 21:04:11 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: do not optimize away accesses to volatile bitfields

Accesses to volatiles must, of course, not be optimized away.
For this, we need to check to type associated to the memory access.
Currently this is done by checking if the type of the result of
the memops is volatile or not. Usualy, the type of the result is
the same as the one of the access so everything is good but for
bitfields, the memop is not done with the type of the bitfield
itself but to its base type. Since this base type is unrelated
to the access type, it is generaly not marked as volatile even
when the access to the bitfield is volatile.

Fix this by using the true type of the access to set the field
struct instruction::is_volatile.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+2/-2), validation/optim/volatile-bitfield.c (+0/-1)
--------------------------------------------------------------------------------

[418aa1fe4bd9] 2018-08-25 21:04:11 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add a flag for volatile memops

When simplifying memops, it's needed to check if the memops
is a volatile access or not. This is currently done by checking
insn->type->ctype.modifiers & MOD_VOLATILE which is rather long
but also incorrect for bitfields.

Prepare to fix this by adding a flag to struct instruction directly
telling if the access is volatile.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+1/-1), linearize.c (+2/-0), linearize.h (+1/-0), memops.c (+2/-2), simplify.c (+1/-1)
--------------------------------------------------------------------------------

[ff47e3b34d9b] 2018-08-25 20:33:39 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: split memops from unops

The field 'orig_type' is only used for casts while 'offset' is only
used for memops.

Split this in two separated sub-structures so that we can add an
additional field for memops without increasing the total size.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+4/-1)
--------------------------------------------------------------------------------

[b39bf76f9c3b] 2018-08-25 17:57:10 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for accesses to volatile bitfields

Accesses to bitfields must, of course, not be optimized away.
This is currently not the case.

Add a testcase for it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/volatile-bitfield.c (+17/-0)
--------------------------------------------------------------------------------

[b01160b296a2] 2018-08-25 17:20:23 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: symaddr: s/insn->symbol/insn->src/

OP_SYMADDR take a single operand 'symbol' but this instruction
is very much like other unops and using the same operand's name
allow to avoid some special cases.

So, s/symbol/src/ for OP_SYMADDRs.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.rst (+6/-6), cse.c (+2/-9), linearize.c (+2/-6), linearize.h (+0/-3), liveness.c (+1/-4), ... and 1 more
--------------------------------------------------------------------------------

[96f388f0f55c] 2018-08-25 14:55:25 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'ssa' into tip

* do 'classical' SSA conversion (via the iterated dominance frontier).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/dev-options.rst (+8/-0), Makefile (+5/-0), cse.c (+3/-24), dominate.c (+153/-0), dominate.h (+9/-0), ... and 48 more
--------------------------------------------------------------------------------

[d46b7b2f9fc4] 2018-08-25 14:28:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: remove useless test for loop-linearization

This testcase was added a bit too quickly in order to have
minimal testing of loop's linearization.

However, such test just comparing the raw output of test-linearize
is a big PITA because it's so sensible to things like pseudos' name
themselves depending very much on details about the linearization
and simplification. Also, this test didn't really tested anything,
it only allowed to track changes.

Remove it as it has no testing value.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/loop-linearization.c (+0/-136)
--------------------------------------------------------------------------------

[fd43eab36ea0] 2018-08-25 14:25:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'kill-dead-stores' into tip

* fix buggy recursion in kill_dead_stores()
* kill dead stores again after memops simplification is done.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+73/-22), flow.h (+1/-0), memops.c (+12/-0), validation/optim/kill-stores0.c (+34/-0), validation/optim/kill-stores1.c (+48/-0), ... and 2 more
--------------------------------------------------------------------------------

[1a247fec3b59] 2018-08-25 10:22:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add a testcase for enum using a mode

Sparse can apply a mode on plain integer types.

Add a known-to-fail testcase showing the problem.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/enum+mode.c (+18/-0)
--------------------------------------------------------------------------------

[4f340069e34b] 2018-08-25 10:22:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support for mode __byte__

sparse support GCC's modes like __SI__, __DI__, as well as
__word__ & __pointer__ but GCC also supports a mode __byte__.

For completeness, add this mode as an alias for mode __QI__.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+2/-0)
--------------------------------------------------------------------------------

[993d8672ac83] 2018-08-25 10:22:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support for mode __pointer__

sparse support GCC's modes like __SI__, __DI__, and __word__
but GCC also supports a mode __pointer__ which is used by Xen.

Add support for this missing __pointer__ mode.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+17/-1)
--------------------------------------------------------------------------------

[a722c5fe3b32] 2018-08-25 10:22:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: mode keywords don't need MOD_{CHAR,LONG,...}

The keywords for modes (SI, DI, ...) don't need a length modifier
like MOD_CHAR or MOD_LONG as the corresponding type (and thus its
length) is given by the the '.to_mode' method.

Remove these modifiers from the keyword definitions, their presence
while unneeded is confusing.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+12/-12)
--------------------------------------------------------------------------------

[4e420922629a] 2018-08-24 23:48:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove superfluous newline in 'unknown mode attribute' error message

The error message 'unknown mode attribute' is displayed with an
additional newline at the end.

Remove this superfluous newline.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[dc49365a8026] 2018-08-24 08:20:41 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'optim-trunc-or' and 'optim-mask-shift-or' into tip

* simplify TRUNC((x & M') | y, N)
* simplify AND(SHIFT(a | b, S), M)
* simplify TRUNC(SHIFT(a | b, S), N)

Files: simplify.c (+61/-18), validation/optim/and-or-bfs.c (+0/-1), validation/optim/and-or-bfu.c (+0/-1), validation/optim/bitfield-store-loads.c (+0/-1), validation/optim/bitfield-store-loadu.c (+0/-1)
--------------------------------------------------------------------------------

[1d78043467a7] 2018-08-24 08:18:56 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify TRUNC(SHIFT(a | b, S), N)

The simplification of TRUNC(SHIFT(a | b, S), N) can be done by
combining the effective mask corresponding to TRUNC(_, N) with
the one corresponding to SHIFT(_, S).

This allows to also simplify signed bitfields. For example, code like:
	struct s {
		  signed int  :2;
		  signed int f:3;
	};
	int bfs(struct s s, int a)
	{
		s.f = a;
		return s.f;
	}

is now simplified into the minimal:
	bfs:
		trunc.3     %r4 <- (32) %arg2
		sext.32     %r11 <- (3) %r4
		ret.32      %r11

The simplification is done by calling simplify_mask_shift() with
the mask corresponding to TRUNC(_, N).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+6/-0), validation/optim/and-or-bfs.c (+0/-1), validation/optim/bitfield-store-loads.c (+0/-1)
--------------------------------------------------------------------------------

[3f2cbce78f78] 2018-08-24 08:18:36 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify AND(SHIFT(a | b, S), M)

The simplification of AND(SHIFT(a | b, S), M) can be done by combining
the mask M with the effective mask corresponding to SHIFT(_, S).

This instruction pattern is generated when accessing bitfields,
for example, code like:
	struct u {
		unsigned int  :2;
		unsigned int f:3;
	};
	int bfu(struct u s, int a)
	{
		s.f = a;
		return s.f;
	}

is now simplified into the minimal:
	bfu:
		and.32      %r11 <- %arg2, $7
		ret.32      %r11

The simplification is done by introducing a small helper,
simplify_mask_shift(), doing the pattern matching and then calling
simplify_mask_shift_or() with the mask M.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+18/-0), validation/optim/and-or-bfu.c (+0/-1), validation/optim/bitfield-store-loadu.c (+0/-1)
--------------------------------------------------------------------------------

[240c84a3eea0] 2018-08-23 10:04:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: prepare simplification of MASK(SHIFT(a | b, S), M)

Currently the simplification of SHIFT(a | b, S) is done by
calling simplify_mask_or() with an effective mask corresponding
to the shift instruction.

Prepare the simplification of more complex patterns, involving
a combination of masks, by using a small helper, simplify_mask_shift_or(),
for doing the call to simplify_mask_or() with the appropriate mask.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+22/-4)
--------------------------------------------------------------------------------

[f8f80ee849cd] 2018-08-23 10:04:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: extend simplification notation

Add the description for MASK(x, M) & SHIFT(x, S).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+15/-13)
--------------------------------------------------------------------------------

[24e2b3800cc5] 2018-08-22 23:28:07 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify TRUNC((x & M') | y, N)

A N-bit truncate is not much different than ANDing with
a N-bit mask and so some simplifications done for AND can
also be done for TRUNC. For example for code like this:
	char foo(int x, int y) { return (x & 0xffff) | y; }

the mask is unneeded and the function should be equivalent to:
	char foo(int x, int y) { return x | y; }

The simplification in this patch does exactly this, giving:
	foo:
		or.32       %r4 <- %arg1, %arg2
		trunc.8     %r5 <- (32) %r4
		ret.8       %r5

while previously the mask was not optimized away:
	foo:
		and.32      %r2 <- %arg1, $0xffff
		or.32       %r4 <- %r2, %arg2
		trunc.8     %r5 <- (32) %r4
		ret.8       %r5

This simplification is especially important for signed bitfields
because the TRUNC+ZEXT of unsigned bitfields is simplified into
an OP_AND but this is, of course, not the case for the TRUNC+SEXT
of signed bitfields.

Do the simplification by calling simplify_mask_or(), initialy used
for OP_AND, but with the effective mask corresponding to TRUNC(x, N):
$mask(N).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+8/-0), validation/optim/and-or-trunc0.c (+0/-1), validation/optim/and-or-trunc1.c (+0/-1), validation/optim/and-or-trunc2.c (+0/-1), validation/optim/and-or-truncx.c (+0/-1)
--------------------------------------------------------------------------------

[a4ae84a892b6] 2018-08-22 09:27:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'optim-shift-and' and 'optim-bitfield' into tip

[Auto-summary] Modifies simplify.c. Adds/updates 38 test(s). Changes: +723/-45 in 39 file(s)

Files: simplify.c (+95/-45), validation/optim/and-or-bf0.c (+24/-0), validation/optim/and-or-bf1.c (+18/-0), validation/optim/and-or-bf2.c (+27/-0), validation/optim/and-or-bfs.c (+24/-0), ... and 34 more
--------------------------------------------------------------------------------

[3d30b78ec7ef] 2018-08-22 09:26:18 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify ((x & M) << S) when (M << S) == (-1 << S)

The instructions SHL(AND(x, M), S) can be simplified into SHL(x, S)
if (M << S) == (-1 << S).

For example, code like:
	unsigned foo(unsigned x)
	{
		return (x & 0x000fffff) << 12;
	}

is now optimized into:
	foo:
		shl.32      %r3 <- %arg1, $12
		ret.32      %r3

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-0), validation/optim/shl-and1.c (+0/-1)
--------------------------------------------------------------------------------

[cb4bed63e19e] 2018-08-22 09:26:18 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify ((x & M) << S) when (M << S) == 0

The instructions SHL(AND(x, M), S) can be simplified to 0
if (M << S) == 0.

For example code like:
	unsigned foo(unsigned x)
	{
		return (x & 0xfff00000) << 12;
	}

is now simplified into:
	foo:
		ret.32      $0

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+11/-0), validation/optim/shl-and0.c (+0/-1)
--------------------------------------------------------------------------------

[729be196bb86] 2018-08-22 09:26:18 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify ((x & M) >> S) when (M >> S) == (-1 >> S)

The instructions LSR(AND(x, M), S) are already simplified into
AND(LSR(x, S), (M >> S)) but only if AND(x, M) has a single user.

However, if (M >> S) == (-1 >> S), the AND part is redundant and the
whole can always directly be simplified into LSR(x, S).

For example, code like:
	unsigned foo(unsigned x)
	{
		unsigned t = (x & 0xfffff000);
		return ((t >> 12) ^ (x >> 12)) & t;
	}

is now optimized into:
	foo:
		ret.32      $0

because (t >> 12) is simplified into (x >> 12).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-0), validation/optim/lsr-and1.c (+0/-1)
--------------------------------------------------------------------------------

[c68bfab0e487] 2018-08-22 09:26:18 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify ((x & M) >> S) when (M >> S) == 0

The instructions LSR(AND(x, M), S) are already simplified into
AND(LSR(x, S), (M >> S)) but only if AND(x, M) has a single user.

However, if (M >> S) == 0, they can always directly be simplified to 0.
For example code like:
	unsigned foo(unsigned x)
	{
		unsigned t = (x & 0x00000fff);
		return (t >> 12) & t;
	}

is now simplified into:
	foo:
		ret.32      $0

while previously it was:
	foo:
		and.32      %r2 <- %arg1, $0xfff
		lsr.32      %r4 <- %r2, $12
		and.32      %r6 <- %r4, %r2
		ret.32      %r6

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+5/-1), validation/optim/lsr-and0.c (+0/-1)
--------------------------------------------------------------------------------

[8e5ef1b17efc] 2018-08-22 09:26:18 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use an intermediate mask in simplify_shift()

This is to have the code to look as closest as possible to what
is done in simplify_mask_or_and() in preparation to some unification.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+3/-3)
--------------------------------------------------------------------------------

[e65784bc11f8] 2018-08-22 09:26:18 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for {LSR,SHL}(AND(x, M), S) with shared AND(x, M)

The pattern LSR(AND(x, M), S) is already generically simplified into
((x >> S) & (M >> S)) but only if the sub-expression AND(x, M) is not
shared with some other expressions because the simplification modify it.

But for some special cases the expression can be simplified even if
the sub-expression is shared because the simplification doesn't need
to modify this AND(x, M) part.

Add the testcases for LSR and the incoming SHL.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/lsr-and0.c (+14/-0), validation/optim/lsr-and1.c (+19/-0), validation/optim/shl-and0.c (+14/-0), validation/optim/shl-and1.c (+19/-0)
--------------------------------------------------------------------------------

[9feb4b16da63] 2018-08-22 09:25:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify SHL((x & M') | y, S)

The same simplifications done for LSR can be done for SHL
(with the appropriate mask).

For example, code like:
	int foo(int a, int b)
	{
		return ((a & 0xfff00000) | b) << 12;
	}

is now optimized into:
	foo:
		shl.32      %r5 <- %arg2, $12
		ret.32      %r5

while previously it was:
	foo:
		and.32      %r2 <- %arg1, $0xfff00000
		or.32       %r4 <- %r2, %arg2
		shl.32      %r5 <- %r4, $12
		ret.32      %r5

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-0), validation/optim/and-or-shl0.c (+0/-1), validation/optim/and-or-shl1.c (+0/-1), validation/optim/and-or-shl2.c (+0/-1), validation/optim/and-or-shlx.c (+0/-1), ... and 3 more
--------------------------------------------------------------------------------

[03e845221e1d] 2018-08-22 09:25:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify OP((x | C), K) when (C & M) != C

If the effective mask (M) corresponding to OP(_, K) is different
than the combined mask (C & M), then the inner mask (C) can be
replaced by the smaller (C & M), giving:
	OP((x | M'), K) with M' == (C & M).

For example, code like:
	int foo(int x)
	{
		return (x | 0xfffffff0) & 0xfff;
	}

is now simplified into:
	foo:
		or.32       %r2 <- %arg1, $0xff0
		and.32      %r3 <- %r2, $0xfff
		ret.32      %r3

while previously, the constant was not reduced:
	foo:
		or.32       %r2 <- %arg1, $0xfffffff0
		and.32      %r3 <- %r2, $0xfff
		ret.32      %r3

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-0), validation/optim/and-or-constant2.c (+0/-1)
--------------------------------------------------------------------------------

[8ef6a1d0cac7] 2018-08-22 09:25:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify OP((x | C), K) when (C & M) == M

In an expression like OP((x | C), K), if the effective mask (M)
corresponding to OP(_, K) is equal to the combined mask (C & M),
then the OR operation is unneeded and can be replaced by M itself,
giving: OP(M, K).
In mathematical terms:
	0) ((x | C) & M) = ((x & M) | (C & M))
	1) (C & M) = M
	2) ((x & M) | (C & M)) = ((x & M) | M) = M
and so OP((x | C), K) -> OP(M, K).

For example, code like:
	unsigned int foo(int x)
	{
		return (x | 7) & 2;
	}

is now simplified into:
	foo:
		ret.32      $2

which previously was not optimized
	foo:
		or.32       %r2 <- %arg1, $7
		and.32      %r3 <- %r2, $2
		ret.32      %r3

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-0), validation/optim/and-or-constant1.c (+0/-1)
--------------------------------------------------------------------------------

[4bcb69f986bc] 2018-08-22 09:25:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify OP((x | C), K) when (C & M) == 0

In an expression like OP((x | C), K), if the inner constant
(C) and the effective mask (M) corresponding to OP(_, K) are
disjoint ((C & M) == 0), then the OR with the constant is
unneeded and can be optimized away since the constant will be
'cleared' by the mask, giving: OP(x, K)

For example, code like:
	int foo(int x)
	{
		return (x | 0xfffff000) & 0xfff;
	}

is now optimized into:
	foo:
		and.32      %r3 <- %arg1, $0xfff
		ret.32      %r3

while previously the OR mask was not optimized away:
	foo:
		or.32       %r2 <- %arg1, $0xfffff000
		and.32      %r3 <- %r2, $0xfff
		ret.32      %r3

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+9/-0), validation/optim/and-or-bf0.c (+0/-1), validation/optim/and-or-constant0.c (+0/-1)
--------------------------------------------------------------------------------

[05c6fad0435d] 2018-08-22 09:25:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify OP(((x & M') | y), K) when (M' & M) != M'

Currently, in simplify_mask_or_and(), only the cases where
(M' & M) == 0 or (M' & M) == M are simplified. However, if the
combined mask (M' & M) is different than the original inner mask
(M'), this inner mask can be replaced by the smaller combined one,
giving: OP(((x & (M' & M)) | y), K).

For example, code like:
	int foo(int x, int y)
	{
		return (((x & 0xfffffff0) | y) & 0xfff);
	}

is now simplified into:
	foo:
		and.32      %r2 <- %arg1, $0xff0
		or.32       %r4 <- %r2, %arg2
		and.32      %r5 <- %r4, $0xfff
		ret.32      %r5

while previously, the mask was not reduced:
	foo:
		and.32      %r2 <- %arg1, $0xfffffff0
		...

Note: this is not a very effective simplification like directly
      removing an instruction, nevertheless the smaller mask can
      trigger other simplifications and may also be advantageous
      for a subsequent code generation phase.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+5/-0), validation/optim/and-or-bf2.c (+0/-1), validation/optim/and-or-lsr2.c (+0/-1), validation/optim/and-or-mask2.c (+0/-1)
--------------------------------------------------------------------------------

[1bd41ed5f51c] 2018-08-22 09:25:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify OP(((x & M') | y), K) when (M' & M) == M

In an expression like this, if the inner mask (M') 'covers' all the
bits of the effective mask (M) corresponding to OP(_, K), IOW if
(M' & M) == M, then the inner mask (M') is unneeded and can be
optimized away, giving: OP((x | y), K).

For example, with this simplification, code like:
	int foo(int x, int y)
	{
		return (((x & 0x0fffffff) | y) & 0xfff);
	}

is now optimized into the minimal:
	foo:
		or.32       %r4 <- %arg1, %arg2
		and.32      %r5 <- %r4, $0xfff
		ret.32      %r5

while previously, the inner mask was not optimized away:
	foo:
		and.32      %r2 <- %arg1, $0xfffffff
		or.32       %r4 <- %r2, %arg2
		and.32      %r5 <- %r4, $0xfff
		ret.32      %r5

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+8/-0), validation/optim/and-or-bf1.c (+0/-1), validation/optim/and-or-lsr1.c (+0/-1), validation/optim/and-or-mask1.c (+0/-1)
--------------------------------------------------------------------------------

[a82cde96cb4b] 2018-08-22 09:25:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: move opcode test inside simplify_mask_or_and()

Calls to this function are guarded by a test checking
if the operand is defined by an OP_AND.

Move this guard inside the function as this make easier to
handle more opcodes later.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+7/-3)
--------------------------------------------------------------------------------

[8b8a5e5501bb] 2018-08-22 09:25:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: allow simplification of OP(((x & y) | (a & M')), K)

In simplify_mask_or(), two calls to simplify_mask_or_and() are
made: one for each operand of the OR instruction.
These two calls are guarded by a test checking the presence of
the AND instruction. If it is the case for the first operand,
the second operand is never considered for simplification,
even if no simplifications have been made.

Fix this by testing the return value of simplify_and_or_mask()
and let's do the second call if no simplifications could be
done in the first one.

For example, code like:
	int foo(int x, int y, int a)
	{
		return ((a & 0xf000) | (x & y)) & 0x0fff;
	}

was expectedly simplified into:
	foo:
		and.32      %r5 <- %arg1, %arg2
		and.32      %r7 <- %r5, $0xfff
		ret.32      %r7

while the same code with the operands of the OR swapped was not:
	int foo(int x, int y, int a)
	{
		return ((x & y) | (a & 0xf000)) & 0x0fff;
	}

resulted in the non-optimized:
	foo:
		and.32      %r3 <- %arg1, %arg2
		and.32      %r5 <- %arg3, $0xf000
		or.32       %r6 <- %r3, %r5
		and.32      %r7 <- %r6, $0xfff
		ret.32      %r7

but now the simplification can also be done:
	foo:
		and.32      %r3 <- %arg1, %arg2
		and.32      %r7 <- %r3, $0xfff
		ret.32      %r7

Note: it would be simpler to unconditionally do both calls
      but this is unsafe because some of the concerned
      instructions, needed in the second call, could have
      been simplified away in the first one.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+5/-2), validation/optim/and-or-bfx.c (+0/-1), validation/optim/and-or-lsrx.c (+0/-1), validation/optim/and-or-maskx.c (+0/-1)
--------------------------------------------------------------------------------

[6faa3df7a003] 2018-08-22 09:25:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: switch return order in simplify_mask_or_and()

This function used an early return when the test guarding
the simplification failed but this make impossible to add
other ones simplifications.

In preparation for incoming additional simplifications,
negate the test and switch the returns so that the early return
is now a catch-all return when no simplifications can apply.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+5/-6)
--------------------------------------------------------------------------------

[bea53a10f6db] 2018-08-22 09:25:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: document simplify_mask_or() & simplify_mask_or_and()

These function are relatively complex and will be even more.

Add minimal documentation to them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+21/-0)
--------------------------------------------------------------------------------

[bb6d1415822f] 2018-08-22 09:25:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use better names for simplify_mask_or_and() vars

So that the names match the ones used in the comments
describing the simplification.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-3)
--------------------------------------------------------------------------------

[cce0b3b68834] 2018-08-22 09:25:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add simplify_mask_or()

Both sites calling simplify_mask_or_and() do it in exactly the same way.

In order to avoid code duplication and in preparation of incoming
changes, move these calls to a small helper: simplify_mask_or().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+14/-16)
--------------------------------------------------------------------------------

[fcbfef57bef4] 2018-08-22 09:25:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unify simplify_lsr_or() & simplify_and_or_mask()

Doing a LSR(X, S) will drop the S right bits.
So any simplification that can be made when using an AND clearing
the right S bits can also be used on LSR (as if its first operand
would first be implicitly be ANDed with such a mask).

So, in order to not duplicate complex simplifications involving
ANDs & ORs masks, merge these both function in a single one,
using the mask corresponding to the operation.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+23/-33)
--------------------------------------------------------------------------------

[570f17482ec6] 2018-08-22 09:25:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for bitfield & AND/OR simplification

The extraction & insertion of bitfields is made of relatively
complex combinations of SHL/LSR/AND/OR and TRUNC/ZEXT/SEXT.

Add a few testcases showing the effectiveness of their
simplification and to catch possible future regressions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/and-or-bf0.c (+25/-0), validation/optim/and-or-bf1.c (+19/-0), validation/optim/and-or-bf2.c (+28/-0), validation/optim/and-or-bfs.c (+24/-0), validation/optim/and-or-bfu.c (+22/-0), ... and 31 more
--------------------------------------------------------------------------------

[cd554eebc1d6] 2018-08-22 09:25:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for (((x & M') | (y & M'')) & M)

There is a potential problem when the second side of the OR
is simplified away.

Add 2 testcases to catch possible regressions here.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/and-or-crash.c (+5/-0), validation/optim/and-or-mask.c (+18/-0)
--------------------------------------------------------------------------------

[c05b1caa7c81] 2018-08-21 22:16:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add doc for simplification notation

The documention of each simplications is quite dense and
use some implicit conventions for its notation.

Document this notation.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/api.rst (+5/-0), simplify.c (+24/-0)
--------------------------------------------------------------------------------

[16b2b6eb6c83] 2018-08-21 22:16:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: reword doc for replace_pseudo()

The function replace_pseudo() was documented but it wasn't very clear.

Replce the short description by something hopefull clearer.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+1/-1)
--------------------------------------------------------------------------------

[31996b8c7ff1] 2018-08-21 22:16:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: convert existing simplify.c doc into ReST autodoc

Some functions in simplify.c are already documented.

Convert this documentation to sparse's Sphinx based doc system.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+43/-36)
--------------------------------------------------------------------------------

[136cc7ed387b] 2018-08-21 22:16:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: automatically insert the blank line for lists

ReST requires a blank line to start a list.

This is a bit annoying for the internal documentation because
this makes, IMO, things less readable in the code.

Tweak the documentation extraction tool to automatically insert
these blank lines (between a line ending with ':' and the next one
if not empty).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/sphinx/cdoc.py (+3/-0)
--------------------------------------------------------------------------------

[4d1f05ecdfa3] 2018-08-21 22:14:56 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: simplify the creation of the viewlist

Each bloc-comment is entered in the view list as a single multiline
plus a final blank line. This is more complicated than needed and it's
useless to first concatenate these lines to split them directly after.
Also it makes harder to correctly track the line numbers.

Fix this by adding the lines one by one, each with their own lineno.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/sphinx/cdoc.py (+5/-6)
--------------------------------------------------------------------------------

[8a92181a03e1] 2018-08-17 09:25:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'optim-shl-lsr' and 'optim-trunc-trunc' into tip

* add simplification of TRUNC(TRUNC((x))
* add simplification of SHL(LSR(x), S), S)

Files: simplify.c (+7/-2), validation/optim/trunc-trunc.c (+12/-0)
--------------------------------------------------------------------------------

[248c2a6a726a] 2018-08-17 08:51:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify TRUNC(TRUNC(x))

The simplification of ZEXT(ZEXT(x)) was already added but
its dual, TRUNC(TRUNC(x)), was not.

Add it now.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+3/-0), validation/optim/trunc-trunc.c (+0/-1)
--------------------------------------------------------------------------------

[82c3ee9ea906] 2018-08-17 08:51:38 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: reorganize simplification of ZEXT(TRUNC(x))

In preparation for the simplification of TRUNC(TRUNC(x)),
slightly reorganize the code doing the simplification of
ZEXT(TRUNC(x)).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-2)
--------------------------------------------------------------------------------

[3a729e93ba9f] 2018-08-17 08:51:05 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify ((x >> S) << S)

The simplification of ((x << S) >> S) was already added
but its dual was forgotten.

Add it now.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+7/-0), validation/optim/shl-lsr0.c (+0/-1)
--------------------------------------------------------------------------------

[1d5acb58b0a4] 2018-08-17 08:51:05 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: reorganize shift-shift simplification

In preparation of the missing simplification of ((x >> S) << S),
reorganize the existing simplification of ((x << S) >> S).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+8/-6)
--------------------------------------------------------------------------------

[0a24265da5e7] 2018-08-17 08:50:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simpler guard in LSR-SHL simplification

For the simplification of ((x << S) >> S), we can use the fact
there is a single PSEUDO_VAL for each value to simplifiy the
check guarding the simplification.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+1/-3)
--------------------------------------------------------------------------------

[1a7ca17aa6e2] 2018-08-16 22:22:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for TRUNC(TRUNC(x)) simplification

Add the testcase before doing the simplification.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/trunc-trunc.c (+13/-0)
--------------------------------------------------------------------------------

[6489aa6571f5] 2018-08-16 21:49:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for ((x >> S) << S) simplification

Add the testcase before doing the simplification.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/shl-lsr0.c (+15/-0)
--------------------------------------------------------------------------------

[58480f8a688b] 2018-08-16 21:20:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: rename testcase for ((x << S) >> S) simplification

The testcase was named with the wrong operation order
(inner op first instead of outer-first).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/{shl-lsr.c => lsr-shl0.c} (+1/-1)
--------------------------------------------------------------------------------

[ca6fe3cd626d] 2018-08-08 12:22:27 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'fix-inc-dec-size' and 'optim-mask' into tip

* generate integer-wide OP_ADD & OP_SUB in linearize_inc_dec()
* simplify mask instructions & bitfield accesses

Files: linearize.c (+15/-16), simplify.c (+85/-7), validation/linear/bitfield-inc.c (+0/-1), validation/linear/bitfield-size.c (+75/-67), validation/optim/and-lsr.c (+0/-1), ... and 5 more
--------------------------------------------------------------------------------

[fd79461f2abe] 2018-08-08 09:55:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify (x & M) >> S to (x >> S) & (M >> S)

This is especially usefull when simplifying code
accessing bitfields.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+14/-0), validation/optim/and-lsr.c (+0/-1)
--------------------------------------------------------------------------------

[0fa902bbcf33] 2018-08-08 09:55:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify (x << S) >> S into x & (-1 >> S)

This transformation is especially usefull when simplifying code
accessing bitfields or for other masking manipulations.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+11/-0), validation/optim/shift-zext.c (+0/-1), validation/optim/shl-lsr.c (+0/-1), validation/optim/store-load-bitfield.c (+3/-9)
--------------------------------------------------------------------------------

[ed1e163b88d6] 2018-08-08 09:55:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify ((x & M) | y) >> S to (y >> S) when (M >> S) == 0

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+24/-0), validation/optim/mask-lsr.c (+0/-1)
--------------------------------------------------------------------------------

[616b8d3d171e] 2018-08-08 09:55:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify ((x & M') | y ) & M into (y & M) when (M' & M) == 0

This is a common pattern for bitfield simplification.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+23/-0), validation/optim/mask-out.c (+0/-1)
--------------------------------------------------------------------------------

[52b7cd665eb1] 2018-08-08 09:54:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: reorg code for shift-shift simplification

No functional changes, just moving the code around
in preparation for shift-shift simplification.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+10/-5)
--------------------------------------------------------------------------------

[cee726c6e82e] 2018-08-07 15:50:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use multi_users() instead on nbr_users()

Since multi_users() is cheaper than nbr_users(), use
the former when possible.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+3/-3)
--------------------------------------------------------------------------------

[51940ca1bb0a] 2018-08-07 15:50:06 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'fix-logical-extra' into tip

* fix a few bugs related to the linearization of logical expressions
* simplify those logical expressions.

Files: linearize.c (+42/-10), simplify.c (+52/-1), validation/cast-kinds-check.c (+2/-2), validation/cast-weirds.c (+2/-2), validation/linear/bitfield-size.c (+6/-6), ... and 12 more
--------------------------------------------------------------------------------

[80ee1b6fca62] 2018-08-07 14:09:39 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: optim: add a few more testcases for shift & mask

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/shl-lsr.c (+15/-0)
--------------------------------------------------------------------------------

[213ee17897a3] 2018-08-07 14:09:39 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: avoid infinite simplification loops of the second kind

In simplify_one_memop(), addresses with a constant offset
are folded into the load or store operation itself. It's also
checked that this address calculation doesn't create a loop
(this can currently happen when using undefined variables)
as such a loop would create an infinite loop in sparse
simplification phase. Independently of the result of this check,
the offset is effectively folded into the memop.

In such loops there is a mutual dependency between the
loaded value and the address. There is a second kind of
possible infinite loop: one where the mutual dependency is
between the old and the new value of the offset.
Of course, both cases are internal errors and should be
correctly addressed. but it's not the purpose of this patch.

This patch add the detection of this second kind of
infinite loop and, since in this case it doesn't make sense
to try to update the offset, the 'simplification' of
this memop is stopped there (which seems to be a good thing
for the first kind too).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+3/-2)
--------------------------------------------------------------------------------

[5bb2289f3b82] 2018-08-07 13:31:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix bad indentation in linearize_inc_dec()

One of the top declaration had two tabs instead of a single one.

Remove one of the tabs.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[0908755d71ee] 2018-08-07 13:31:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix instruction size & type in linearize_inc_dec()

If the ++ or -- operator is used on a bitfield, the addition or
subtraction is done with the size of the bitfield. So code like:
	struct {
		int f:3;
	} s;
	...
	s->f++;
will generate intermediate code like:
	add.3	%r <- %a, $1

This is not incorrect from the IR point of view but CPUs have
only register-sized instructions, like 'add.32'. So, these
odd-sized instruction have one or two implicit masking/extend
that should better make explicit.

Fix this by casting to and from the base type when these operators
are used on bitfields.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+5/-1), validation/linear/bitfield-inc.c (+0/-1), validation/linear/bitfield-size.c (+75/-67)
--------------------------------------------------------------------------------

[7347750afb89] 2018-08-07 12:18:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: put back the bitfield base type into struct access_data

In commit 48bda7573 ("let struct access_data use a single type"),
the members result_type & source_type have been replaced by an unique
member 'type', mainly because the role of these members and when they
needed to be updated was not clear at all.

Now that the situation is much clearer, the second member, used to
hold the base type of bitfields, can be put back as it avoid
to have to call bitfield_base_type() multiple time.

Put back this member into struct access_data and use when appropriate
(which remove the now unneeded calls to bitfield_base_type()).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+7/-5)
--------------------------------------------------------------------------------

[f8b6997ff58a] 2018-08-07 12:07:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: expand linearize_position() into linearize_initializer()

linearize_position() is a very small function doing the initialization
of EXPR_POS while for the more complex EXPR_INITIALIZER this is done
directly in linearize_initializer().

Having this code in a separate function doesn't bring substantial benefits,
on the contrary it obscure the fact that linearize_initializer() is a
recursive function and make harder the tracking of where struct access_data
are modified.

Expand linearize_position() into its caller, linearize_initializer().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+2/-9)
--------------------------------------------------------------------------------

[6da6517086e5] 2018-08-06 17:43:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: limit the mask used for bitfield insertion

The mask used for bitfield insertion is as big as the integers
used internally by sparse. Elsewhere in the code, constants are
always truncated to the size of the instructions using them.
It's also displaying concerned instructions oddly. For example:
	and.32	%r2 <- %r1, 0xfffffffffffffff0

Fix this by limiting the mask to the size of the instruction.

Fixes: a8e1df573 ("bitfield: extract linearize_bitfield_insert()")
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+2/-1), validation/linear/bitfield-size.c (+6/-6)
--------------------------------------------------------------------------------

[e3a5d3631fc2] 2018-08-06 17:43:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: fix warning position in cast_pseudo()

The function cast_pseudo() can issues warnings about non size-preserving
integer <-> pointer casts. The file:line:column position of these warnings
is taken from the destination type but this position is the one where the
type is declared (or where the symbol associated with this type is defined)
which may or may not be related to the position of the cast.

Fix this by using the current position instead (which should hold the
position of the cast).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+3/-2), validation/cast-kinds-check.c (+2/-2), validation/cast-weirds.c (+2/-2)
--------------------------------------------------------------------------------

[db491ea79222] 2018-08-06 11:47:03 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: boolean conversion of boolean value is a no-op

If an expression is already a boolean (constant) expression,
converting it to a boolean expression is a no-op.

In this case, return early, this avoids to create intermediate
code that will need to be simplified away at some later stage.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+2/-0), validation/optim/bool-simplify.c (+6/-6)
--------------------------------------------------------------------------------

[d1be6899cf42] 2018-08-06 08:53:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify AND(SETCC(x,y), M)

Since the OP_SETCC instructions can only return a 0 or a 1,
a subsequent AND mask can often be heavily simplified.

Simplify the mask value.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+5/-0), validation/optim/setcc-mask.c (+0/-1)
--------------------------------------------------------------------------------

[bf7f95c1e8d8] 2018-08-06 08:53:09 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify TRUNC(SETCC(x,y), N)

Since the OP_SETCC instructions can only return a 0 or a 1,
a truncation won't change the value and the OP_SETCC
can be changed to directly return the extended size.

Remove the unneeded truncate.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-0), validation/optim/setne0-trunc.c (+0/-1)
--------------------------------------------------------------------------------

[5791d659d0db] 2018-08-06 08:51:47 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify SEXT(SETCC(x,y), N)

Since the OP_SETCC instructions can only return a 0 or a 1, a
sign-extension won't change the value if the size is wider than 1.
The OP_SETCC can thus be changed to directly return the extended size.

Remove the unneeded extension.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-0), validation/optim/setne0-sext.c (+0/-1)
--------------------------------------------------------------------------------

[1a5e49c57e65] 2018-08-06 08:51:39 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify ZEXT(SETCC(x,y), N)

Since the OP_SETCC instructions can only return a 0 or a 1,
a zero-extension won't change the value and the OP_SETCC
can be changed to directly return the extended size.

Remove the unneeded extension.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+13/-0), validation/optim/bool-simplify.c (+3/-6), validation/optim/setne0-zext.c (+0/-1), validation/optim/trunc-seteq0.c (+0/-1)
--------------------------------------------------------------------------------

[8457b3c20a2f] 2018-08-06 08:51:36 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify SETNE(TRUNC(x,N),{0,1})

Convert the OP_TRUNC into an OP_AND with the appropriate mask.
This a greater chance to simplify with previous instructions
and to correspond to a register-size operand.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+17/-0), validation/optim/trunc-setne0.c (+0/-1)
--------------------------------------------------------------------------------

[34c4c964d096] 2018-08-06 08:50:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify SETNE(AND(X,1),0) to AND(X,1)

Since the OP_SETCC instructions can only return a 0 or a 1,
a compare-not-equal-zero or compare-equal-1 is a no-op
if the operand have been masked with 1.

Remove the no-op comparison (if the size matches).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+10/-0), validation/optim/mask1-setne0.c (+0/-1)
--------------------------------------------------------------------------------

[5fccf5f5a85d] 2018-08-06 08:50:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify linearize_logical()

The linearized code for logical expressions looks like:
	.Lc
		... condition 1 ...
		cbr	%c, .L1, .L2
	.L1
		%phisrc	%phi1 <- $1
		br	.Lm
	.L2
		... condition 2 ...
		%phisrc	%phi2 <- %r
		br	.Lm
	.Lm
		%phi	%r <- %phi1, %phi2

But .L1 can easily be merged with .Lc:
	.Lc
		... condition 1 ...
		%phisrc	%phi1 <- $1
		cbr	%c, .Lm, .L2
	.L2
		... condition 2 ...
		%phisrc	%phi2 <- %r
		br	.Lm
	.Lm
		%phi	%r <- %phi1, %phi2

Do this simplification which:
* creates less basic blocks & branches
* do at linearization time a simplification not done later.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+14/-27), validation/linear/logical.c (+68/-92)
--------------------------------------------------------------------------------

[c47f18c7699d] 2018-08-06 08:50:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: expand linearize_conditional() into  linearize_logical()

linearize_logical() call linearize_conditional() but needs additional
tests there and generate code more complicated than needed.

Change this by expanding the call to linearize_conditional() and make
the obvious simplification concerning the shortcut expressions 0 & 1.
Also, removes the logical-specific parts in linearize_conditional(),
since there are now unneeded.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+47/-17), validation/linear/logical.c (+111/-127)
--------------------------------------------------------------------------------

[3334fa789234] 2018-08-06 08:50:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix linearize_conditional() for logical ops

The function linearize_conditional(), normaly used for conditionals
(c ? a : b) is also used to linearize the logical ops || and &&.
For conditionals, the type evaluation ensure that both LHS & RHS
have consistent types. However, this is not the case when used for
logical ops. This creates 2 separated but related problems:
* the operands are not compared with 0 as required by the standard
  (6.5.13, 6.5.14).
* both operands can have different, incompatible types and thus
  it's possible to have a phi-node with sources of different,
  incompatible types, which doesn't make sense.

Fix this by:
* add a flag to linearize_conditional() telling if it's used for
  a conditional or for a logical op.
* when used for logical ops:
  * first compare the operands againts zero
  * convert the boolean result to the expression's type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+13/-4), validation/linear/logical.c (+0/-1)
--------------------------------------------------------------------------------

[875235a6801d] 2018-08-06 08:50:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: conditional branches can't accept arbitrary expressions

Conditional branches, or more exactly OP_CBR, can't accept
arbitrary expression as condition. it is required to have
an integer value.

Fix this by adding a comparison against zero.

Files: linearize.c (+1/-1), validation/linear/call-complex-pointer.c (+5/-5), validation/loop-linearization.c (+22/-22), validation/optim/call-inlined.c (+2/-2)
--------------------------------------------------------------------------------

[2de1601e3e8e] 2018-08-06 08:50:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: protect add_convert_to_bool() against bad types / invalid expressions

It's not possible to do a boolean conversion of an expression
if this expression is invalid / has not type / is VOID.

Fix this by returning VOID in these situations.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+2/-0)
--------------------------------------------------------------------------------

[f7940d3f0e7c] 2018-08-06 08:50:24 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix size corruption when simplifing 'x != 0' to 'x'

In commit d329775c2 ("simplify 'x != 0' or 'x == 1' to 'x'")
the comparison was optimized away if the operand's size == 1
but this is only valid if the comparison also has a size == 1.

Fix this by restricting this optimization only when both
the comparison instruction and its operand has a size == 1.

Fixes: d329775c2 ("simplify 'x != 0' or 'x == 1' to 'x'")
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+1/-1)
--------------------------------------------------------------------------------

[c22d39ec3768] 2018-08-04 22:55:24 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'list-optims' (early part) into tip

* add optimized version of some list operations

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+1/-1), linearize.h (+16/-1), liveness.c (+0/-9), ptrlist.c (+110/-0), ptrlist.h (+5/-0), ... and 1 more
--------------------------------------------------------------------------------

[0e872d2941a6] 2018-08-04 22:21:41 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for linearize_logical()

Add some tests in preparation of some bug-fixing and
simplification in linearize_logical()linearize_conditional().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/logical.c (+300/-0), validation/optim/mask1-setne0.c (+29/-0), validation/optim/setcc-mask.c (+19/-0), validation/optim/setne0-sext.c (+10/-0), validation/optim/setne0-trunc.c (+10/-0), ... and 3 more
--------------------------------------------------------------------------------

[8a852bf56850] 2018-07-28 09:09:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'optim-setne' into tip

* some simplifications of OP_SETNE & OP_SETEQ with 0 and 1

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+21/-15), validation/optim/bool-context-fp.c (+2/-4), validation/optim/bool-sext-test.c (+12/-0), validation/optim/bool-simplify2.c (+17/-33), validation/optim/bool-zext-test.c (+12/-0)
--------------------------------------------------------------------------------

[d329775c212c] 2018-07-28 09:07:15 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify 'x != 0' or 'x == 1' to 'x'

These two comparisons are no-ops when the operand is boolean.
Simplify them away.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+8/-0), validation/optim/bool-context-fp.c (+2/-4), validation/optim/bool-simplify2.c (+17/-33)
--------------------------------------------------------------------------------

[dd7cfd8c2817] 2018-07-28 09:07:11 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify SET{EQ,NE}(SEXT(x, N),{0,1})

A sign-extension has no effect on the result of a comparison
with 0 or with 1 when the original size is bigger than 1.

Optimize away the extension.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+5/-1), validation/optim/bool-sext-test.c (+0/-1)
--------------------------------------------------------------------------------

[bc0f5843abbc] 2018-07-28 09:06:47 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify SET{EQ,NE}(ZEXT(x, N),{0,1})

A zero-extension has no effect on the result of a comparison with 0 or 1.

Optimize away the extension.

Note: this simplification was already done but only when the
      original size was 1 but it can be done for all sizes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+7/-10), validation/optim/bool-zext-test.c (+0/-1)
--------------------------------------------------------------------------------

[0df976f9a481] 2018-07-25 22:07:24 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cleanup of simplify_seteq_setne(): remove tmp vars

No functional changes, just remove unneeded temporary variables.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-5)
--------------------------------------------------------------------------------

[0fc8a1eebbb1] 2018-07-25 22:07:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testcase for SET{EQ,NE}([SZ]EXT(x, N),{0,1})'s simplification

Add some basic testcase for these relatively common
simplification opportunities.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/bool-sext-test.c (+13/-0), validation/optim/bool-zext-test.c (+13/-0)
--------------------------------------------------------------------------------

[d0d63eb6c186] 2018-07-25 20:58:09 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'optim-cast' into tip

* several simplifications involving casts and/or bitfields

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+33/-17), linearize.h (+5/-0), simplify.c (+105/-11), unssa.c (+1/-6), validation/linear/bitfield-inc.c (+17/-0), ... and 20 more
--------------------------------------------------------------------------------

[7bd897d35014] 2018-07-25 18:47:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'optim-shift' into tip

* give a correct & sensible warning on negative or over-sized shifts.
* add conservative simplification of such shifts.
* do not optimize the meaningless shift:
  * any shift with a negative count
  * OP_ASRs with an over-sized shift count.
* try to give a correct negative/too-big error message during simplification.
* simplify chains of shifts.
* simplify ZEXT + ASR into ZEXT + LSR

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: bits.h (+61/-0), evaluate.c (+5/-0), expand.c (+41/-11), lib.c (+4/-0), lib.h (+3/-0), ... and 11 more
--------------------------------------------------------------------------------

[081b35e3a3d2] 2018-07-25 18:47:09 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: shift: simplify ASR(ZEXT(X, N), C)

After an OP_ZEXT, it is guaranteed that the sign bit is zero.
So, an arithmetic right-shift following an OP_ZEXT gives the
same result as an logical right-shift which is simpler to handle
and further optimize.

So, when preceded by an OP_ZEXT, replace OP_ASR by OP_LSR.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+10/-0), validation/optim/zext-asr.c (+13/-0)
--------------------------------------------------------------------------------

[52579227fdc1] 2018-07-25 16:36:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: shift: avoid simplification of ASR(LSR(x,0),N)

In most circumstances, the case where the LSR's count is zero
won't happen because it would have been optimized away before.
However there is a very small posibility it would happen:
  at the first run of the simplification loop,
  if the LSR and the ASR are in two different Basic Blocks and
  the ASR's BB is processed before the LSR's BB (rare)

Reported-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+1/-1)
--------------------------------------------------------------------------------

[eb180d9c0f58] 2018-07-25 16:36:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: shift: simplify ASR(LSR(x,N),N')

Since an LSR with an in-range shift count will insert a zero in
the MSB, a subsequent ASR will be equivalent to an LSR of the same
count or equivalently, the combinaison the these two shifts is
equivalent to a single LSR with a shift count equal to the sum
of the two initial counts.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-1), validation/optim/lsr-asr.c (+42/-0)
--------------------------------------------------------------------------------

[e703906715b3] 2018-07-25 16:36:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: shift: simplify LSR(LSR(x,N),N') & friends

A shift of a shift (of the same kind) is equivalent to a single
shitf with a count equal to the sum of the two initial counts.
In addition:
* for LSRs & SHLs, if the sum is >= to the instruction size, then
  the result is zero.
* for ASRs, if the sum is >= to the instruction size, then
  the result is the same as a shift of a count of size - 1.

Implement these simplifications if both shift counts are in range.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+46/-1), validation/optim/shift-shift.c (+149/-0)
--------------------------------------------------------------------------------

[a4fb469ca61a] 2018-07-25 15:17:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add lookup_ptr_list_entry()

For liveness analysis, the ptrlists need to be used as sets. IOW,
before adding a new element, it's needed to check if it doesn't
already belong to the list.

This check is currently done, specifically for pseudos,  using the
list walking macros FOR_EACH_PTR/END_FOR_EACH_PTR.

Add a new generic ptrlist function: lookup_ptr_list_entry() which
test if a given pointer already belong to the list.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+5/-0), liveness.c (+0/-9), ptrlist.c (+21/-0), ptrlist.h (+1/-0)
--------------------------------------------------------------------------------

[16d6357f2172] 2018-07-25 15:17:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add ptr_list_multiple()

When doing IR simplification, to know if an instruction can be
destructively modified, it's needed to know if the pseudo it defines
is used by a single instruction or not. Currently this is done using
ptr_list_size() which needs to walk the whole list.

This walk is relatively costly when the list is long but knowing
if the list contains more than 1 element can often be answered
more cheaply since an answer can be returned as soon as it's
known that the list contains at least 2 elements.

Add the helpers ptr_list_multiple() and multi_users().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+5/-0), ptrlist.c (+21/-0), ptrlist.h (+1/-0), simplify.c (+1/-1)
--------------------------------------------------------------------------------

[979a731fccda] 2018-07-25 15:16:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add ptr_list_empty()

Sometimes we need to know if a list is empty, for example, in
order to determine if a pseudo has some users or not.

Currently, this is done using ptr_list_size(), which always
walks the whole list but the needed answer can be returned as
soon as it's known that the list contains at least one element.

Add the helper ptr_list_empty() and use it for has_users().

This gives a speedup up to 18% on some pathological workloads.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+6/-1), ptrlist.c (+19/-0), ptrlist.h (+2/-0), simplify.c (+1/-1)
--------------------------------------------------------------------------------

[d95d9a999d06] 2018-07-25 11:38:16 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: kill dead OP_FADD & friends

The floating-point binops (OP_FADD, ...) are never simplified.
They are thus absent from simplify_instruction() and as such they are
never removed if dead.

Fix this by adding them to simplify_instruction() but only do
the usual check with dead_insn().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+7/-0)
--------------------------------------------------------------------------------

[b03237b8deef] 2018-07-25 11:38:16 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testcases: missing evaluation of side effects in typeof(VLA)

The argument of the typeof operator is normally not evaluated
but it should be when it involves a VLA.

Add a testcase for this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/eval-typeof-vla.c (+26/-0)
--------------------------------------------------------------------------------

[57d11fc64aeb] 2018-07-25 11:38:06 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testcases: add testcase for missing detection of out-of-bound stores

Apparently, only loads are detected, stores are not.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/check_access-store.c (+21/-0)
--------------------------------------------------------------------------------

[5846f394881c] 2018-07-25 07:30:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add copy_ptr_list()

When an instruction can be replaced by a pseudo, the user list of
this pseudo and the instruction's target must be merged.

Currently this is done by concat_ptr_list() which copy the elements
of one list into the other using add_ptr_list(). This incurs quite
a bit overhead.

Add a new more efficient ptrlist function: copy_ptr_list() which
copy the element by block by looping over both list in parallel.

This gives a speedup up to 26% on some pathological workloads.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+1/-1), ptrlist.c (+49/-0), ptrlist.h (+1/-0)
--------------------------------------------------------------------------------

[0e733d7e130c] 2018-07-24 15:03:18 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use "%Le" to display floats

Floating-point values are displayed using the printf
format "%Lf" but this is the format without exponent
(and with default precision of 6 digit).

However, by its nature, this format is very imprecise.
For example, *all* values smaller than 0.5e-6 are displayed
as "0.000000".

Improve this by using the "%Le" format which always use
an exponent and thus maximize the precision.

Note: ultimately, we should display them exactly, for
      example by using "%La", but this will requires C99.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+2/-2), show-parse.c (+1/-1), validation/fp-ops.c (+1/-1), validation/linear/cast-constant-to-float.c (+3/-3), validation/linear/cast-constants.c (+10/-10), ... and 1 more
--------------------------------------------------------------------------------

[f20ca41c3e13] 2018-07-23 20:24:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: do not optimize over-sized ASRs

Like GCC, we don't want to touch ASRs with an over-sized shift count.

Return as soon as such shifts are detected.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-0)
--------------------------------------------------------------------------------

[5fda776e450c] 2018-07-23 20:24:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: do not optimize negative shifts

Like GCC, we don't want to touch shifts with a negative count.

Return early as soon as a negative value is detected.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-0)
--------------------------------------------------------------------------------

[f6811d732c7d] 2018-07-23 20:24:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: fix warning message for negative or over-sized shifts

In order to preserve shifts with negative count and give a proper
warning for them, we first need to identify when the shift must
be considered as negative. This identification is made complicated
by the fact that PSEUDO_VAL are typeless.

The solution chosen here is to try to first sign extend the shift
count (with the size of an int and the size of the instruction).
If after this extension the count appears as negative it is treated
as such (and this new value replace the old one to avoid to have to
redo this at each simplification run), otherwise it is considered
as unsigned. The only case where a negative count could be wrongly
interpreted as a big unsigned value would be if:
	size target int < instruction's size < size host value
which can't happen for now since sizeof(int) == 4 on all targets
and sizeof(value) is 8.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+18/-5), validation/shift-negative.c (+0/-1), validation/shift-undef.c (+12/-12)
--------------------------------------------------------------------------------

[6123e95d79f0] 2018-07-23 20:24:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: move shift count check in a separate function

No functional changes here.
Just moving code around to prepare the following patch.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+16/-5)
--------------------------------------------------------------------------------

[f22be7c4b6f9] 2018-07-23 20:24:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: add testcases for simplification of negative shifts

Like GCC, we don't want to touch shifts with a negative count.
Add testcases covering this at expansion and simplification time.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/shift-negative.c (+18/-0)
--------------------------------------------------------------------------------

[5a872d61e68a] 2018-07-23 20:24:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: add testcases for simplification of over-sized shifts

Like GCC, we don't want to touch over-sized ASR but over-sized
LSRs & SHLs degenerate to 0.

Add testcases covering all cases.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/shift-big.c (+55/-7)
--------------------------------------------------------------------------------

[c2fcd59e6f08] 2018-07-23 20:24:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bits: add helpers for zero & sign-extension

Zero & sign-extensions are relatively common operations
which are currently open-coded at each use.

Define helpers for doing these operations.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: bits.h (+61/-0), lib.h (+1/-0), symbol.h (+8/-0)
--------------------------------------------------------------------------------

[bb97ff365b6f] 2018-07-23 13:11:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: simplify SEXT(ZEXT(x,N),N')

A sign-extension following a zero-extension can always
be simplified into a single zero-extension since the
intermediate value is guaranted to have a zero sign bit.

Simplify away such instructions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+3/-0), validation/optim/zext-sext.c (+0/-1)
--------------------------------------------------------------------------------

[7da1a1b5051e] 2018-07-23 13:11:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: simplify ZEXT(ZEXT(x,N),N')

A zero-extension following another zero-extension can always
be simplified into a single zero-extension.

Simplify away such instructions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+6/-0), validation/optim/zext-zext.c (+0/-1)
--------------------------------------------------------------------------------

[99b428918d69] 2018-07-23 13:11:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: simplify SEXT(SEXT(x,N),N')

A sign-extension following another sign-extension can always
be simplified into a single sign-extension.

Simplify away such instructions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+5/-0), validation/optim/sext-sext.c (+0/-1)
--------------------------------------------------------------------------------

[5da4e09b4701] 2018-07-23 13:11:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: simplify AND(ZEXT(x,M),N)

An OP_AND with a constant value following a OP_ZEXT can often
be simplified:
* the constant mask can be made smaller
* the whole masking is redundant and can be removed.

Do these two simplifications depending on the initial mask
and the sizes of the instructions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+34/-1), validation/optim/zext-and.c (+0/-1), validation/optim/zext-and1.c (+0/-1)
--------------------------------------------------------------------------------

[780d796a478f] 2018-07-23 13:11:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: simplify [ZS]EXT(AND(x,M),N)

A OP_AND with a constant value followed by a sign or zero-extension
can often be moved after the extension.

This is good because it can trigger the cancellation of the OP[ZS]EXT
with a preceding OP_TRUNC, a common situation with bitfields.

Note: This 'simplification' is less desirable if there is
      no preceding OP_TRUNC, for example, in a sequence like:
		and.32	%t <- %a, $mask
		*ext.64 %r <- %t
      If needed, this can be filtered out at some later stage.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+24/-0), validation/optim/and-extend.c (+0/-1), validation/optim/and-extendx.c (+0/-1), validation/optim/trunc-mask-zext.c (+0/-1)
--------------------------------------------------------------------------------

[45e70ebf4685] 2018-07-23 13:11:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: preserve the sizes of TRUNC(AND(x,M),N)

sparse contains some code to simplify an AND masking
followed by a truncating cast.

However, this simplification is problematic because it
doesn't keep the sizes consistent. For example, code like:
	and.32      %r3 <- %r2, $0x7fff
	trunc.16    %r4 <- (32) %r3
will be discarded with %r3 used in place of %r4.
This is correct in the mathematical sense but %r4 had a size
of 16 while %r3 has a size of 32, so using %r3 in place of %r4
will make the sizes inconsistent with unexpected consequences.

We can more or less fix this by using another transformation
that preserve the sizes:
	trunc.16    %r3 <- (32) %r2
	and.16      %r4 <- %r3, $0x7fff
which in itself doesn't optimize anything but:
1) the mask may be smaller
2) may trigger other simplification with the TRUNC or the AND.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+11/-6), validation/optim/and-trunc.c (+0/-1)
--------------------------------------------------------------------------------

[c1715a15efc6] 2018-07-23 13:11:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: use a switch to handle TRUNC(AND(x,M),N) in simplify_cast()

This is in preparation to handle the other casts: ZEXT & SEXT.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+11/-7)
--------------------------------------------------------------------------------

[a4295a5fce92] 2018-07-23 13:11:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: do not compare sizes, test the opcode

In simplify_cast(), the sizes of the instructions are
compared to test if the cast is a truncating one or not.
But now that we have finer grained cast instructions, this
is not needed as we can simply test if the opcode is OP_TRUNC.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+1/-1)
--------------------------------------------------------------------------------

[a89f2e3f544c] 2018-07-23 13:11:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: fix shift signedness in cast simplification

In commit c64d1972a ("cast: prepare for more cast simplifications")
a unsigned right shift was inadvertently changed to a signed one.

Restore the correct signedness.

Fixes: c64d1972a ("cast: prepare for more cast simplifications")
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-1)
--------------------------------------------------------------------------------

[212b9239abbc] 2018-07-23 13:11:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: simplify [SZ]EXT + TRUNC to a smaller/greater size

An OP_SEXT or a OP_ZEXT followed by a truncate to a size smaller
than the original size is unneeded, the same result can be obtained
by doing the truncate directly on the original value.

Dualy, an OP_SEXT or a OP_ZEXT followed by a truncate to a size greater
than the original size doesn't need the truncate, the same result can be
obtained by doing the extend directly on the original value.

Rearrange the inputs (src & orig_type) to bypass the unneeded operation.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-1), validation/optim/ext-trunc-greater.c (+0/-1), validation/optim/ext-trunc-smaller.c (+0/-1)
--------------------------------------------------------------------------------

[548f00d19561] 2018-07-23 13:11:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: simplify [SZ]EXT + TRUNC to original size

An OP_ZEXT/OP_SEXT following by a OP_TRUNC to the original size is a NOP.

Simplify away such OP_TRUNC.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+10/-0), validation/optim/ext-trunc-same.c (+0/-1)
--------------------------------------------------------------------------------

[a8e1df57346c] 2018-07-23 13:11:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bitfield: extract linearize_bitfield_insert()

linearize_store_gen() is complex because it has to handle
the insertion of bitfields.

Isolate this operation in a separate function in order to
facilitate the incoming changes there.

Files: linearize.c (+19/-11)
--------------------------------------------------------------------------------

[5c02493b916e] 2018-07-23 13:11:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bitfield: extract linearize_bitfield_extract()

linearize_load_gen() is complex because it not only has to do
the loading of a value from some address but it also has to
handle the extraction of bitfields.

Isolate this operation in a separate function in order to
facilitate the incoming changes there.

Files: linearize.c (+14/-6)
--------------------------------------------------------------------------------

[de13e2c39b95] 2018-07-23 13:11:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for casts & bitfield insertion/extraction

There is several difficulties some related to unclear semantic
of our IR instructions and/or type evaluation.

Add testcases trying to cover this area.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/bitfield-inc.c (+17/-0), validation/linear/bitfield-preinc.c (+18/-0), validation/linear/bitfield-store.c (+22/-0), validation/optim/and-extend.c (+28/-0), validation/optim/and-extendx.c (+25/-0), ... and 16 more
--------------------------------------------------------------------------------

[90cc2706010c] 2018-07-23 13:11:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: extract nbr_users() from unssa.c

This small helper was used in unssa.c but is useful elsewhere too.

Move it as an inline function to linearize.h and rename it to
'nbr_users()' since it is close to the existing 'has_users()'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+5/-0), simplify.c (+1/-1), unssa.c (+1/-6)
--------------------------------------------------------------------------------

[68e67287e6f3] 2018-07-23 01:41:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: add -Wshift-count-{negative,overflow}

The warnings about negative or over-sized shift count are
enabled by default.

Add the options to disabled them if desired.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expand.c (+5/-0), lib.c (+4/-0), lib.h (+2/-0), simplify.c (+2/-1), sparse.1 (+12/-0)
--------------------------------------------------------------------------------

[9473e0a28653] 2018-07-23 01:40:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: do not truncate the count when checking it

The function check_shift_count() is used to check the validity
of shift counts but the count is truncated to an (host) int.
This truncated value can thus miss very large (or very negative)
shift count.

Fix this by using the full width shift count when doing the check.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expand.c (+8/-5), validation/shift-undef-long.c (+0/-1)
--------------------------------------------------------------------------------

[efdefb100d08] 2018-07-23 01:40:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: fix evaluation of shift-assign

The right hand side of a shift operation must be of integer type
and do the integer promotion and nothing else. More precisely, the
RHS and the LFS type doesn't need to match.

This is correctly done for plain shifts but not for shift-assigns
where the full usual conversion is wrongly applied.

Fix this by special casing shifts in evaluate_assign_op() and
just apply the integer promotion on the RHS, like done for shifts
in evaluate_binop().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+5/-0)
--------------------------------------------------------------------------------

[4b6723ef4d91] 2018-07-23 01:40:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: fix warning message for negative shift count

The diagnostic emitted when shifting by an negative amount is confusing:
	warning: shift too big (4294967295) for type ...

Change the message to the more informative:
	warning: shift count is negative (-1)

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expand.c (+5/-1), validation/shift-undef.c (+18/-18)
--------------------------------------------------------------------------------

[7792c8509a07] 2018-07-23 01:40:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: use the type width for too big shift

Currently, during simplification, when it's checked if the shift
amount of a shift instruction is in range, it's not the
instruction's size (which is the same as the type's width)
that is used but the 'operand size' as returned by operand_size().

operand_size() is a bit like poor man's Value Range Propagation
or VRP without Propagation, and use the knowledge of previous
instructions to deduce the effective size of the operand.
For example, if the operand is the result of a narrowing cast
or have been ANDed with a known mask, or was a bitfield, the
size returned is the one of the cast or the mask and may be
smaller than its type.

A priori, using more precise knowledge is a good thing but in
the present case it's not because it causes warning for things
that are totally legal, meaningfull and used all the time.
For example, we don't want to warn in the following code:
	struct bf { int u:8; };
	int bf(struct bf *p) { return p->s << 24; }
Another situation where such warnings are not desirable is
when the shift instruction 'is far' from the one defining
the size, for example when the shift occurs in an inline function
and this inline function is called with a smaller type.

So, use the instruction size instead of the effective operand size
when checking the range of a shift instruction.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-2), validation/shift-undef.c (+45/-12)
--------------------------------------------------------------------------------

[9fb59b83b936] 2018-07-23 01:40:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: simplify over-sized OP_SHLs

In the mathematical sense, the result of a left-shift by an
amount bigger than the operand size equals zero.

Do the corresponding simplification.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-0), validation/optim/shift-big.c (+7/-0)
--------------------------------------------------------------------------------

[9ac79ec0a88f] 2018-07-23 01:40:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: simplify over-sized OP_LSRs

In the mathematical sense, the result of LSR by an amount bigger
than the operand size equals zero.

Do the corresponding simplification.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+8/-0), validation/optim/shift-big.c (+27/-0), validation/shift-undef.c (+10/-10)
--------------------------------------------------------------------------------

[c8bc8def3bed] 2018-07-23 01:40:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: reuse simplify_asr() for LSR & SHL

During the simplification phase, ASR instructions are checked
and possibly simplified but LSR & SHL are not.

Rename simplify_asr() into simplify_shift() and do the check
& simplification for LSR & SHL too.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-4), validation/shift-undef.c (+8/-0)
--------------------------------------------------------------------------------

[d4920a58d9e8] 2018-07-23 01:40:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: reorder the tests in simplify_asr()

This is in preparation of some incoming changes here.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+5/-3)
--------------------------------------------------------------------------------

[bfe532a4f10f] 2018-07-23 01:40:10 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: do not simplify over-sized OP_ASR to zero

Currently, arithmetic right shifts with a shift count bigger
than the operand size are simplified to zero.

While this makes a lot of sense for LSR and SHL, for ASR it's
much less so.

Remove the simplification and let the back-end generate the code
for a non-immediate count (which is what GCC do).

Note: Some other options would be:
- reduce the shift count modulo the operand size, like it was
  done previously at expansion time and which correspond to the
  run-time behaviour of several CPUs families (x86[-64], arm64,
  mips, ...) but not all of them (arm, ppc, ...).
- truncate the count to N-1

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+0/-1), validation/shift-undef.c (+2/-0)
--------------------------------------------------------------------------------

[6915fbc00097] 2018-07-22 23:07:16 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: also check shift count of shift-assignment

At expansion time, a diagnostic is emitted for shift with a
bad count in a shift expression but not in a shift-assign.

Fix this by calling the checking function also for shift-assigns.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expand.c (+20/-1), validation/shift-undef.c (+48/-0)
--------------------------------------------------------------------------------

[08ce45dfea0c] 2018-07-22 23:07:16 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: use the base type for shift-too-big warning

Without this, instead of having a warning message like
'shift to big for int', we can have a message like:
'shift to big for int [addressable] x' once we also
check shift expression where only the amount is a constant.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expand.c (+2/-0)
--------------------------------------------------------------------------------

[0b73dee0171a] 2018-07-22 23:07:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: move the check into check_shift_count()

At expansion time, diagnostic about the size of shifts is issued
by an helper check_shift_count() and the condition are checked
before calling this functions.

Move the condition checking inside the helper as it make the
code more readable (and this corresponds to the helper's name).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expand.c (+5/-5)
--------------------------------------------------------------------------------

[411aed021d36] 2018-07-21 16:22:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: don't take the modulo at expand time

Currently, at expansion time, shifts expressions with an
amount corresponding to undefined behaviour (larger or equal
than the type's width or negative) are 'reformed' by reducing
the amount modulo the width.
This correspond in fact to the run-time of several CPUs families
(x86[-64], arm64, mips, ...) but not all of them (arm, ppc, ...).

However, it is desirable for the front-end to not modify the
exacution model, the virtual one given by the C standard, but
also the effective one of the target machine.

Change this, but no more doing the reduction modulo the width
and leaving these expressions as-is (which leave the possibility
to do something else, maybe target-specific, at a latter stage).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expand.c (+2/-5)
--------------------------------------------------------------------------------

[9f739389cc8b] 2018-07-21 16:22:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: do not evaluate negative or over-sized shifts

During simplification, an instruction is evaluated and replaced
by its value when all its operands of an instruction are known
to be constant.

However, for shifts, not all amounts give a well defined result:
* when the amount is larger or equal to the type's width
* when the shift is negative
Thus performing this evaluation can possibly give a different
effect than what would happen if the instruction would be executed
on the target machine.

In one way, this doesn't really matter since it's undefined anyway.
But it is desirable for the simplification to be completly
deterministic.

So, don't perform this evaluation and leave these undefined operations
as they are (which still gives the possibility to handle them later,
depending on some f-options or maybe in a target-dependent way).

Note: this is largely what seems to be done by GCC.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+6/-0)
--------------------------------------------------------------------------------

[5aa92924b10b] 2018-07-21 16:22:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: mark out-of-range OP_{ASR,LSR,SHL} as tainted

Some undefined operations, like shifting by an amount bigger
than the size, should not raise a warning during the optimization
phase because the corresponding warning has already been issued
during the expand phase.

Mark the corresponding instructions as tainted and don't warn if
already tainted.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+19/-0), simplify.c (+2/-1)
--------------------------------------------------------------------------------

[47f8b684d569] 2018-07-21 16:22:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: big-shift: add test for shifts with bad count

The following patches change quite a bit of things regarding
shifts with bad count. Add testcases to ensure everything is
covered and catch possible future regressions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/shift-undef-long.c (+22/-0), validation/shift-undef.c (+73/-0)
--------------------------------------------------------------------------------

[8ed2cd6530fd] 2018-07-13 16:37:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove obsolete comment: /* Dummy pseudo allocator */

The function alloc_pseudo() has a comment saying it's
a dummy allocator but it uses a real allocator since
commit 25f8da191 ("[PATCH] More linearizion fun").

Remove the obsolete comment.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+0/-1)
--------------------------------------------------------------------------------

[0186265cb969] 2018-07-13 16:37:32 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: no need to assign ad->type for EXPR_POS

The field ad->type is assigned in linearize_position() but
this is unneeded since this field will be later overwritten
in linearize_initializer()'s default case.

Remove the assignment.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+0/-1)
--------------------------------------------------------------------------------

[d8beb3b1e0e0] 2018-07-13 16:34:39 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unused struct access_data::pos

The field 'struct position pos' present in struct access_data
is initialized at 2 places but is never used.

Remove this unneeded field.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+0/-4)
--------------------------------------------------------------------------------

[96733d7cbd49] 2018-07-13 16:33:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unused finish_address_gen()

This function is empty since the introduction of struct access_data.

Remove it and its callers.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+0/-10)
--------------------------------------------------------------------------------

[3f06ccfcc0be] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ssa: phi worklist

This patch optimize the very simple implementation of the
phi-node renaming at the end of the SSA conversion.

It avoids the need to rescan the whole function to find the phi-nodes
by using a worklist to put the phi-nodes during the renaming
of non-phi nodes instructions.

This optimization avoids O(n^2) behaviour in some pathological cases.

Note: A lot of optimizations can be done for the renaming.
      For the moment, things are kept as simplest as possible,
      the goal being to have correctness first.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+1/-0), ssa.c (+34/-9), validation/mem2reg/quadra01.c (+0/-1)
--------------------------------------------------------------------------------

[f72c77ccd8af] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ssa: remove unused simplify_symbol_usage()

This patch remove simplify_symbol_usage() and the associated
functions, now unneeded with the new SSA conversion.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+0/-278)
--------------------------------------------------------------------------------

[6dea652c4ac3] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ssa: activate the new SSA conversion

This activate the new SSA conversion that will be used
to replace simplify_symbol_usage() which created invalid
SSA (phi-nodes were placed where the value was needed
instead of where the paths meet, also and partially related,
it was possible for a phi-node to have more operands/sources
than the BB it was in had parents).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: optimize.c (+2/-1), validation/mem2reg/broken-phi02.c (+0/-1), validation/mem2reg/broken-phi03.c (+0/-1), validation/mem2reg/cond-expr5.c (+0/-1), validation/mem2reg/quadra00.c (+0/-1), ... and 6 more
--------------------------------------------------------------------------------

[b9d74dac4b2d] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ssa: phase 3: rename phi-nodes

This implement the last phase of the SSA conversion:
the renaming of the variables defined by a phi-nodes.

In this implementation, this need to be done last because
* we need the know the pseudo of each operands
* we place the phi-source lazily.

The implementation itself is very straight-forward and scan
after all OP_PHIs, create the phi-sources and simply use the
mapping of the preceding phase to lookup their value.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ssa.c (+36/-0)
--------------------------------------------------------------------------------

[362b1cddefc3] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ssa: phase 2: rename load & stores

This implement the second phase of the classical SSA conversion:
the renaming of variables but only for load & stores.

The implementation doesn't use the stack based algorithm (which
is quite hairy and can use a lot of memory) but a simpler solution
where each BB keep track of the symbol-to-pseudo correspondance.

This mapping is also done for phi-nodes (which are semantically
close to loads) but the phi-nodes themselves are not renamed.
This is done so that we can keep track of the unused phi-nodes
and so have semi-pruned SSA.

One thing worth of noticing is that in order to keep the mapping
for phi-nodes it was needed to add a field to OP_PHI instructions
to hold the original symbol pseudo (much like OP_LOAD).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ssa.c (+63/-0)
--------------------------------------------------------------------------------

[816250ccdf82] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ssa: phase 1: phi-nodes placement

This implement the first phase of classical SSA conversion:
the placement of phi-nodes at the dominance frontier.

The implementation is rather straight-forward:
* for each pseudo used to make an access do:
  * reject cases that can't be converted:
	- volatile accesses
	- symbols externally visible
	- complex types that should not be converted
  * scan the concerned instructions and BBs
  * if there is only 1 store the loads may be directly
    converted (if dominated by the store!)
  * if all accesses are in a single BB, then no phi-nodes
    are needed and the accesses can be rewritten easily
  * otherwise we compute the iterated dominance frontier of
    the BBs just scanned and insert the phi-nodes there.
  * finally, some cleanup is done on dead stores

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), linearize.h (+4/-0), ssa.c (+277/-0), ssa.h (+6/-0), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[017a4deba447] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrmap: add type-safe interface

Add the external, type-safe, API for the ptrmap implementation.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrmap.h (+16/-0)
--------------------------------------------------------------------------------

[12ade83c5872] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrmap: core implementation

Sparse currently has a memory efficient implementation for lists
of pointers to some objects.

These are used for 2 different purposes:
- either for a simple set of objects
- either as a sequence (ordered) of objects.

There is also another similar need:
- a map of object (aka: dictionnary, table, ...)

where the only needed operations are:
- add a new element (with it's key)
- lookup an element via it's key
- replace the element corresponding to a key

The implementation done in this patch is a very simple one
based on list of blocks of key-value pairs.

The idea being to later switch to a dynamic structure using
a hash-table as soon as the number of element reach some threshold.
However, these hash-table are only needed for some huge input files
(the current implementation is no worse than walking through
the ptrlists).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), ptrmap.c (+109/-0), ptrmap.h (+12/-0)
--------------------------------------------------------------------------------

[aa4bd0297606] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add insert_phi_node()

This helper is used later during the SSA construction and is,
as its name suggest, used to insert phi-nodes in the
instruction stream.

More exactly, the phi-node will be put at the begining of the
specified BB, just after the others phi-nodes but before
any other instructions, as required for their semantics
(although, it's less important for sparse since each operand
correspond first to a phi-source, so no phi-node directly
depending on themselves in sparse).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+36/-0), linearize.h (+3/-0)
--------------------------------------------------------------------------------

[8cb5317fa016] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add PSEUDO_UNDEF & undef_pseudo()

Processing in the middle-end are much easier if undefined values
have been clearly identified. Once done, we can then make
choices like:
- give some warnings about uninitialized variables
- always initialize them to zero
- allow arbitraly simplification
- ...

Prepare this by declaring a new type of pseudo: PSEUDO_UNDEF
somewhat similar to PSEUDO_VOID.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+9/-0), linearize.h (+3/-1), sparse-llvm.c (+6/-0)
--------------------------------------------------------------------------------

[ea44f850aa68] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add new helper: is_integral_type()

Some optimizations must only be done on integral types:
all kinds of integers and any pointers type.

Add a new helper for this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+18/-0)
--------------------------------------------------------------------------------

[774334f408da] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: idf: add test/debug/example

This patch add a small silly function which dump the iterated
dominance frontier of each individual node in the CFG.

It's just there to show how to use the IDF API.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dominate.c (+27/-0)
--------------------------------------------------------------------------------

[31efe59f647c] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: idf: compute the iterated dominance frontier

Conversion of some IR into SSA form requires to place so called
phi-nodes where different paths for some value meet. It's important,
of course to place these correctly, but it's also important to try
to minimize the number of these phi-nodes. Several algorithms exist
for the placing of these phi-nodes but it can be shown that, for
each variable, it is suffisant to place their phi-nodes on the
dominance frontier of the nodes defining this variable and since
phi-nodes themselves give a new definition, to have the minimal
number of phi-nodes, these phi-nodes must be paced on the iterated
dominance frontier (the transitive closure of the dominance frontier
of the initial defining nodes).

This patch implement what's needed to compute the iterated dominance
frontier of a set of nodes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), dominate.c (+126/-0), dominate.h (+9/-0)
--------------------------------------------------------------------------------

[3bdee1146f67] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sset: add implementation of sparse sets

Sparse set implements set operations like add, remove & test in O(1).
More importantly it also allow to reset the set as a whole in O(1).

It's very handy for a few things.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), sset.c (+28/-0), sset.h (+56/-0)
--------------------------------------------------------------------------------

[f0abb143f3e3] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dom: use domtree for bb_dominates()

The function bb_dominates() do a dominance query
on two BB but do this by walking the CFG tree.
Now that we have the dominance tree, we don't need anymore
to do this walk, we can use the dom tree itself.

This patch just replace the calls bb_dominates() by
domtree_dominates() since they have a slightly different
interface.

Note: in the next version, it'll be better/simpler to rename
      domtree_dominates() by bb_dominates().
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cse.c (+3/-24)
--------------------------------------------------------------------------------

[4786ecebf608] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dom: build the domtree before optimization

Now that can build the dominance tree, let's effectivey
build it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: optimize.c (+3/-0)
--------------------------------------------------------------------------------

[91d965db0a60] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dom: add support for dominance queries

The dominance tree is useless as such, what's matter
is to be able to make queries, to ask if such BB dominates
this other BB.
This patch add an API (domtree_dominates()) to do this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flowgraph.c (+24/-0), flowgraph.h (+4/-0)
--------------------------------------------------------------------------------

[242d55dba4a8] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dom: add some debugging for the dominance tree

So, it's possible to use the flag '-vdomtree' to dump the
domonance tree.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/dev-options.rst (+4/-0), flowgraph.c (+14/-0), lib.c (+2/-0), lib.h (+1/-0)
--------------------------------------------------------------------------------

[787153d14e24] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dom: calculate the dominance tree

Build the CFG's dominance tree and for each BB record:
- the immediate dominator as bb->idom (is null for entry BB).
- the list of immediately dominated BB as bb->doms.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flowgraph.c (+103/-0), flowgraph.h (+1/-0), linearize.h (+4/-0)
--------------------------------------------------------------------------------

[27e588987539] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: graph: add debugging for (reverse) postorder traversal

Just use the flag '-vpostorder' to dump the links once calculated.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/dev-options.rst (+4/-0), flowgraph.c (+13/-0), lib.c (+2/-0), lib.h (+1/-0)
--------------------------------------------------------------------------------

[8cc064e5c87b] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: graph: build the CFG reverse postorder traversal

Do a DFS on the CFG and record the (reverse) postorder.
Use this order for the normal BB traversal (ep->bbs).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), flowgraph.c (+65/-0), flowgraph.h (+8/-0), linearize.h (+4/-1)
--------------------------------------------------------------------------------

[d64adff1bac0] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: remove useless test for loop-linearization

This testcase was added a bit too quickly in order to have
minimal testing of loop's linearization.

However, such test just comparing the raw output of test-linearize
is a big PITA because it's so sensible to things like pseudos' name
themselves depending very much on details about the linearization
and simplification. Also, this test didn't really tested anything,
it only allowed to track changes.

Remove it as it has no testing value.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/loop-linearization.c (+0/-136)
--------------------------------------------------------------------------------

[b8c17466f257] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: improve mem2reg testcases

A few tests are added, some have been renamed to better
refect their purposes. Finally, some checks have been added
or tweaked.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/crash-select.c (+18/-0), validation/{ => mem2reg}/alias-distinct.c (+0/-0), validation/{ => mem2reg}/alias-mixed.c (+0/-0), validation/{ => mem2reg}/alias-same.c (+0/-0), validation/mem2reg/cond-expr.c (+1/-0), ... and 14 more
--------------------------------------------------------------------------------

[11380d396ac9] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add a few more tests catching quadratic behaviour

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/mem2reg/quadra01.c (+27/-0), validation/mem2reg/quadra02.c (+18/-0), validation/repeat.h (+24/-0)
--------------------------------------------------------------------------------

[745c0d82a509] 2018-07-01 00:18:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: reorganize tests for compound literals

Split the existing test in 2 as it contains 2 different cases.
Also move the test to 'linear/' subdir.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/{ => linear}/compound-literal00.c (+0/-0), validation/linear/compound-literal01.c (+18/-0), validation/{compound-literal01.c => linear/compound-literal02.c} (+1/-9)
--------------------------------------------------------------------------------

[13cf4aaeef36] 2018-07-01 00:17:36 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: kds: clarify kill_dead_stores_bb()

There is 4 classes of instructions to consider when killing
the dead stores in a BB :
* LOADs,
* STOREs,
* CALLs (can clobber any non-local var)
* all others
but this is a bit hard to follow when reading the code.

Try to make things a bit clearer by using a switch showing
these 4 cases.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+14/-14)
--------------------------------------------------------------------------------

[302d1089d768] 2018-06-30 23:29:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: kds: fix recursion in kill_dead_stores_bb()

In kill_dead_stores_bb(), after having scanned the current BB,
we may recurse into the parent BBs. But we must do this only if
we're sure that the store there may not be needed in another BB.
In other words, we must do this only if the current BB is the only
child of the parent.

However, if one of the parent has more than one child, instead
of trying the next parent, the function stops there and returns.
Furthermore, the check is done with an open loop instead of using
the helper bb_list_size().

Fix this by using bb_list_size() to check if the parent has only
one child, do the recursion if it is the case and try the next
parent if not.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+2/-5), validation/optim/kill-stores2.c (+0/-1)
--------------------------------------------------------------------------------

[6ad43a13c2e2] 2018-06-30 23:29:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: kds: shortcut for kill_dead_stores()

In kill_dead_stores(), instructions must be scanned backward
in order to check if the store is dead and can be removed.

However, if the corresponding pseudo has a single user,
this user is a store and the it correspond to a local symbol,
then it's not needed to scan, the store can be directly be removed.

This is somehow important for some semi-pathological case where
some BB contains a lot of dead stores because the current way is
annoyingly O(n^2).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+27/-0)
--------------------------------------------------------------------------------

[4723d27700f3] 2018-06-30 23:29:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: kds: kill dead stores after memops simplification

Currently, dead stores are removed after the initial
promotion of symbols to pseudos (simplify_one_symbol()).
But more complex promotions are done later during memops
simplification (simplify_loads()) and dead stores should be
removed there too but aren't.

Fix this by calling kill_dead_stores() after memops
simplification.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: memops.c (+12/-0), validation/optim/kill-stores0.c (+0/-1), validation/optim/kill-stores1.c (+0/-1)
--------------------------------------------------------------------------------

[587340e4f516] 2018-06-30 23:29:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: kds: add interface for kill_dead_stores()

There are several places where it can be usefull to
remove dead stores but the existing function for this is
local to flow.c & doesn't have an interface easy to use.

Change this make a clean interface for this functionality.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+13/-0), flow.h (+1/-0)
--------------------------------------------------------------------------------

[d4623a914bbe] 2018-06-30 23:29:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: kds: rename kill_dead_stores() to kill_dead_stores_bb()

This name beter reflect the function which work on a single BB.
But the true reason for this change is to be able to reuse the
name kill_dead_stores() for a external interface.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+3/-3)
--------------------------------------------------------------------------------

[62ec13695698] 2018-06-30 23:29:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: kds: add explanation to kill_dead_stores()

The function kill_dead_stores() is somehow hard to understand.
Let's add some explanation for it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+14/-0)
--------------------------------------------------------------------------------

[80b345a46809] 2018-06-30 23:29:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: kds: add testcases for kill_dead_stores()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/kill-stores0.c (+35/-0), validation/optim/kill-stores1.c (+49/-0), validation/optim/kill-stores2.c (+18/-0), validation/optim/live-stores0.c (+29/-0)
--------------------------------------------------------------------------------

[6fc095ca97f6] 2018-06-30 20:38:23 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'cse-cast' into tip

* cse: try the next pair instead of keeping the first instruction
* cse: compare casts only by kind a size, not by C type.

Files: cse.c (+18/-12), validation/optim/cse-cmp-next.c (+15/-0)
--------------------------------------------------------------------------------

[7bba241ec621] 2018-06-30 20:36:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: remove dead OP_{SETVAL,SETFVAL,SLICE}

At linearization (and maybe in some other situations), dead
intructions are created. Currently, it's the simplification
phase's job to detect and remove these dead instructions
(cfr. dead_insn()).

However, several intructions, not otherwise concerned by
simplification are never so detected and thus never removed.

Add those instructions to simplify_instruction() and call
dead_insn() on them to remove them if dead.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+9/-0)
--------------------------------------------------------------------------------

[0170c91f27ea] 2018-06-30 20:34:47 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix killing OP_SWITCH

Currently OP_SWITCHes are only handled by default in kill_insn().
In consequence, when killed, OP_SWITCHes leave a fake usage on the
condition.

Fix this by removing the condition's usage when killing an OP_SWITCH.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+1/-0), validation/kill-switch.c (+17/-0)
--------------------------------------------------------------------------------

[f9b3fd61a779] 2018-06-30 20:33:49 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'cast-optim' into tip

* optimize away OP_UTPTR & OP_PTRTU which are nops.

Files: simplify.c (+3/-2), sparse-llvm.c (+4/-0), validation/cast-kinds-check.c (+11/-11), validation/cast-weirds.c (+1/-34), validation/{linear => optim}/cast-kinds.c (+8/-16), ... and 1 more
--------------------------------------------------------------------------------

[a19d607fdac6] 2018-06-30 12:00:54 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cse: let equivalent casts hash & compare identically

Now that cast instructions are more finely grained, it's
not needed to compare the original type of the casts,
only the original size can matter.

So, do not hash & compare the original types but only the
orignal sizes. This allow much more casts instructions to be
CSEed away.

Note: like noted in the code, even the original size shouldn't
      matter as identical sources should implies identical
      original sizes but this can't yet be guaranted.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cse.c (+16/-12)
--------------------------------------------------------------------------------

[3ad464ff247a] 2018-06-29 23:19:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: optimize away casts to/from pointers

Now that all casts to or from a pointer are between a pointer
and a pointer-sized unsigned integer, from an optimization
PoV, they are all no-ops.

So, optimize them away at simplification time.

Note: casts between pointers (OP_PTRCAST) should also be
      optimized away but the original type is used for a
      number a things (for example in check_access()) and
      can't be optimized away so simply (yet).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+3/-2), sparse-llvm.c (+4/-0), validation/optim/cast-kinds.c (+8/-16), validation/optim/cast-nop.c (+18/-0)
--------------------------------------------------------------------------------

[e46af66b3c2b] 2018-06-29 23:19:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: reorganize testcases for cast optimization

validation/linear/* should not contain testcases that are
optimization dependent and validation/*.c should not contain
tests using 'test-linearize', only those using 'sparse'.

Move some cast-related testcases accordingly.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/cast-kinds-check.c (+11/-11), validation/cast-weirds.c (+1/-34), validation/{linear => optim}/cast-kinds.c (+0/-0)
--------------------------------------------------------------------------------

[a3e062b58031] 2018-06-28 18:55:41 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bool: remove OP_{AND,OR}_BOOL instructions

Now that these instructions are not generated anymore,
we can remove all related code, defines and doc.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.rst (+0/-8), cse.c (+1/-3), example.c (+0/-3), linearize.c (+0/-2), linearize.h (+1/-3), ... and 2 more
--------------------------------------------------------------------------------

[22a058c697d3] 2018-06-28 18:55:41 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bool: generate plain OP_{AND,OR} instead of OP_{AND,OR}_BOOL

Now that OP_AND_BOOL and OP_OR_BOOL are always given boolean
operands, they are just a special case of 1 bit OP_AND & OP_OR.

To avoid to have to repeat CSE, simplification patterns, ...
better to generate plain OP_AND & OP_OR instead.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+1/-1), validation/optim/bool-context-fp.c (+4/-4), validation/optim/bool-simplify.c (+25/-0), validation/optim/bool-simplify2.c (+24/-24)
--------------------------------------------------------------------------------

[e124eabaa616] 2018-06-28 18:55:41 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bool: fix missing boolean context for floats

The function add_convert_to_bool() was added to give a
boolean context to logical expressions but did this onl
for integers.

Fix this for floating-point expressions by adding the proper
comparison to 0.0.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+7/-2), validation/optim/bool-context-fp.c (+48/-0)
--------------------------------------------------------------------------------

[6c116f46f480] 2018-06-28 18:55:41 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bool: simplify ZEXT in bool -> int -> bool

Because of C's integer promotion, in code like 'a == 0',
the operand 'a' must be promoted to int. So, if 'a' is
of type 'bool', it results in following linearization:
	zext.32  %t <- (1) %a
	setne.32 %r <- %t, $0

While this promotion is required by the standard at C level,
here, from an operational PoV, the zero-extension is unneeded
since the result will be the same without it.

Change this by simplifying away such zero-extensions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+12/-2), validation/optim/bool-int-bool.c (+12/-0), validation/optim/bool-simplify2.c (+17/-33)
--------------------------------------------------------------------------------

[aaefea2b1e2f] 2018-06-28 18:55:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bool: fix add missing check in simplify_seteq_setne()

In simplify_seteq_setne, the defining instruction of the first
operand is used but this is only meaningful if the pseudo is
a PSEUDO_REG one.

Fix this by adding the missing check.

Fixes: e5f70312b ("simplify comparisons followed by an equality test against 0 or 1")
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-1)
--------------------------------------------------------------------------------

[9d7af9cf6212] 2018-06-28 18:54:58 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bool: add testcase for bool simplification

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/bool-simplify2.c (+247/-0)
--------------------------------------------------------------------------------

[395b4de3d508] 2018-06-28 18:54:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify 'x ^ ~0' to '~x'

This is yet another simple identity with the potential to trigger
more simplifications.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+7/-1), validation/optim/bits-not-zero.c (+8/-0)
--------------------------------------------------------------------------------

[cd1366255259] 2018-06-28 18:54:41 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify 'x & ~0' to 'x'

This is another simple identity with the potential to trigger
more simplifications.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-0), validation/optim/bits-not-zero.c (+7/-0)
--------------------------------------------------------------------------------

[0b9963941148] 2018-06-28 18:54:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify 'x | ~0' to '~0'

This is a simple identity with the potential to trigger
more simplifications.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+8/-1), validation/optim/bits-not-zero.c (+15/-0)
--------------------------------------------------------------------------------

[9f5e91bd0cb0] 2018-06-26 14:09:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add simple testcases for internal infinite loops

The current SSA conversion kinda ignore undefined variables.
Those may then later be detected when they are part of a
LOAD + (ADD|SUB) cycle but they can also create other cycles
which are not detected.

These cycles inhibit (or uselessly complicate) lots of optimizations.
For example, code like:
	and.32	%r2 <- %r1, $1
	and.32	%r3 <- %r2, $1
should be simplified into:
	and.32	%r3 <- %r1, $1
but this simplification would behave horribly with 'cycles' like:
	and.32	%r1 <- %r1, $1

This patch add a testcase for a number a very simple situations
where such cycles can be created.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/infinite-loop01.c (+54/-0)
--------------------------------------------------------------------------------

[1ed0dfb47362] 2018-06-26 14:01:50 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: simplify TRUNC + ZEXT to AND

A truncation followed by a zero-extension to the original size,
which is produced when loading a storing bitfields, is equivalent
to a simple AND masking. Often, this AND can then trigger even
more optimizations.

So, replace TRUNC + ZEXT instructions by the equivalent AND.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+9/-0), validation/{linear => optim}/bitfield-init-zero.c (+4/-8), validation/{ => optim}/bitfield-size.c (+4/-2)
--------------------------------------------------------------------------------

[c3e9c9bb6a40] 2018-06-26 09:15:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cse: move to next comparable instruction

Let's suppose we have a few instructions: A, B, C & D,
all congruent insn_compare()

The current way the CSE is done is:
  The first try will be try_to_cse(A,B). If this succeeds,
  A & B have been merged (AB) and the next try will be done
  with the next instruction:
	try_to_cse(AB,C).
  That's good. However, if it fails, the next try will be:
	try_to_cse(A,C).
  If this one also fails, the next one will be:
	try_to_cse(A,D)
  And if this one also fails, nothing else is done.
In other words, all attempts are done with A. If it happens that
A can't be eliminated (because it doesn't dominate B, C & D and
is not dominated by them), no eliminations are done because the
other pairs, not involving A are never tried.

Ideally, we should try all possible pairs: A-B, A-C & A-D but
also B-C, B-D & C-D. However this is quadratic and can be a bit
costly. An easy & cheap way to improve the current situation is,
in case of failure, to not reuse the original first instruction
but the other one. So instead of testing:
	A-B, A-C, A-D, ...
we will test:
	A-B, B-C, C-D, ...
with the result that an 'bad' instruction can't block anymore
the following pairs.

So, when try_to_cse() fails, do not retry by keeping the first
instructions, but retry using the second one.

In practice, this seems to work fairly well.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cse.c (+2/-0), validation/optim/cse-cmp-next.c (+0/-1)
--------------------------------------------------------------------------------

[4d851248702b] 2018-06-23 16:54:50 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: keep instruction sizes consistent

The last instruction of linearize_load_gen() ensure that
loading a bitfield of size N results in a object of size N.
Also, we require that the usual binops & unops use the same type
on their operand and result. This means that before anything
can be done on the loaded bitfield it must first be sign or zero-
extended in order to match the other operand's size.

The same situation exists when storing a bitfield but there
the extension isn't done. We can thus have some weird code like:
	trunc.9		%r2 <- (32) %r1
	shl.32		%r3 <- %r2, ...
where a bitfield of size 9 is mixed with a 32 bit shift.

Avoid such mixing of size and always zero extend the bitfield
before storing it (since this was the implicitly desired semantic).
The combination TRUNC + ZEXT can then be optimised later into
a simple masking operation.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+11/-1), validation/linear/bitfield-init-zero.c (+15/-11), validation/linear/bitfield-size.c (+174/-0)
--------------------------------------------------------------------------------

[c64d1972a5b7] 2018-06-23 16:14:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: prepare for more cast simplifications

Currently, the only simplification of casts is CAST(AND(X))
but more simplification are possible.

Prepare for additional simplification by unsing a switch-case
for OP_AND instead of the current 'if'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+10/-7)
--------------------------------------------------------------------------------

[8dbdcd3d7b6c] 2018-06-23 16:14:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: merge simplification of constant casts with constant unops

A whole part logic was common and things are simpler now with
TRUNC/ZEXT/SEXT as separated instructions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+12/-23)
--------------------------------------------------------------------------------

[f522f64ff4a9] 2018-06-23 16:14:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: simplify simplify_cast()

The casts that can't or musn't be simplified away are filtered
out in simplify_cast() but now that we have more fine-grained
cast instructions, it's much more convenient to filter them out
already at the previous step, in simplify_instruction()'s switch.

Do this by:
* removing the filtering checks in simplify_cast()
* moving the casts we don't want to simplify out of simplify_cast()
  and letting them just call dead_insn() in the upper level.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-23)
--------------------------------------------------------------------------------

[5d80f2005f30] 2018-06-23 15:29:23 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: new helper: def_opcode()

Getting the opcode corresponding to the instruction defining
a pseudo *if* the psedudo has such an instruction (PSEUDO_REG)
is an common operation in the simplification phase.

Add a helper, def_opcode() to make the code a bit easier to read.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+7/-0)
--------------------------------------------------------------------------------

[1091da3a64c8] 2018-06-23 10:58:21 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cse: add testcase for missed opportunity

In the test the offset is the same for dst & src and thus
it's calculation should be CSEed away but it is not (yet).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/cse-cmp-next.c (+16/-0)
--------------------------------------------------------------------------------

[5c189c40bb2c] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: do not try to linearize illegal casts

Also, do not warn about them because the warnings should
already have been given at evaluation time.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+2/-0)
--------------------------------------------------------------------------------

[718af70ef6ba] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: accept null casts

Without this, casts to the same non-scalar type would be rejected
and replaced by VOID. Not good.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+6/-0)
--------------------------------------------------------------------------------

[01951278a604] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: specialize integer casts

Casts to integer used to be done with only 2 instructions:
OP_CAST & OP_SCAST.

Those are not very convenient as they don't reflect the real
operations that need to be done.
This patch specialize these instructions in:
- OP_TRUNC, for casts to a smaller type
- OP_ZEXT,  for casts that need a zero extension
- OP_SEXT,  for casts that need a sign extension
- Integer-to-integer casts of the same size are considered as
  a NOPs and are, in fact, never emitted.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.rst (+7/-4), cse.c (+4/-4), example.c (+6/-3), linearize.c (+16/-11), linearize.h (+2/-2), ... and 17 more
--------------------------------------------------------------------------------

[bf21036518ac] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: make casts from pointer always size preserving

Currently casts from pointers can be done to any integer type.
However, casts to (or from) pointers are only meaningful if
it preserves the value and thus done between same-sized objects.

To avoid to have to worry about sign/zero extension while doing
casts to pointers it's good to not have to deal with such casts.

Do this by doing first a cast to an unsigned integer of the same size
as a pointer and then, if needed, doing to cast to the final type.
As such we have only to support pointer casts to unsigned integers
of the same size and on the other hand we have the generic
integer-to-interger casts we to support anyway.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.rst (+1/-1), linearize.c (+2/-0), sparse.c (+0/-1), validation/cast-kinds-check.c (+0/-2), validation/linear/cast-kinds.c (+86/-84)
--------------------------------------------------------------------------------

[756b6133e7f6] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: add support for -Wpointer-to-int-cast

It's relatively common to cast a pointer to an unsigned long,
for example to make some bit operations.
It's much less sensical to cast a pointer to an integer smaller
(or bigger) than a pointer is.

So, emit a diagnostic for this, under the control of a new
warning flag: -Wpointer-to-int-cast.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+2/-0), lib.h (+1/-0), linearize.c (+5/-0), validation/cast-kinds-check.c (+1/-1), validation/linear/cast-kinds.c (+1/-1)
--------------------------------------------------------------------------------

[c8fac68af94b] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: specialize cast from pointers

Currently all casts to pointers are processed alike. This is
simple but rather unconvenient in later phases as this
correspond to different operations that obeys to different
rules and which later need extra checks.

Change this by using a specific instructions (OP_UTPTR) for
[unsigned] integer to pointers.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.rst (+8/-2), cse.c (+2/-2), example.c (+2/-0), linearize.c (+7/-0), linearize.h (+1/-0), ... and 8 more
--------------------------------------------------------------------------------

[ff7f001bef9a] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: temporary simplify handling cast to/from void*

Currently pointer casts from/to void are treated as casts
to/from integer. The rationale being that a void pointer can't
anyway be dereferenced.

Allow to continue to do so by using a new 'machine type' for void
pointers which then allow to select the right type of cast:
OP_PTRCAST or OP_[S]CAST.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+15/-4)
--------------------------------------------------------------------------------

[0d19a077e74c] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: make pointer casts always size preserving

Currently casts to pointers can be done from any integer types.
However, casts to (or from) pointers are only meaningful if value
preserving and thus between objects of the same size.

To avoid to have to worry about sign/zero extension while doing
casts to pointers it's good to only have to deal with the value
preserving ones.

Do this by doing first, if needed, a cast an integer of the same
size as a pointer before doing the cast to a pointer.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.rst (+1/-1), linearize.c (+2/-0), validation/cast-weirds.c (+10/-8), validation/linear/cast-kinds.c (+32/-30)
--------------------------------------------------------------------------------

[a1219bf5f756] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: make [u]intptr_ctype alias of [s]size_t_ctype

When processing integers to/from pointers, we would like to have
an integer type which has the same size as a pointer.

Currently, it's always the case for [s]size_t but it's preferable
to have a specific type which will always offer this guarantee,
like [u]intptr_t.

Fix this lazily by defining [u]intptr_ctype to [s]size_t_ctype.

Note: this intptr_t is just internal to sparse and can be different
      from the type choosen by the libc/platform.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+3/-0)
--------------------------------------------------------------------------------

[dc4117c69ef9] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: specialize casts from unsigned to pointers

Currently all casts to pointers are processed alike.
This is simple but rather unconvenient as it correspond to
different operations that obeys to different rules and
which later need extra checks.

Change this by using a specific instructions (OP_UTPTR) for
unsigned integer to pointers.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.rst (+3/-0), cse.c (+2/-0), example.c (+2/-0), lib.c (+2/-0), lib.h (+1/-0), ... and 9 more
--------------------------------------------------------------------------------

[52856c815a19] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: specialize floats to integer conversion

Currently, casts from floats to integers are processed like
integers (or any other type) to integers. This is simple but
rather unconvenient as it correspond to different operations
that obeys to different rules and which later need extra checks.

Change this by directly using specific instructions:
- FCVTU for floats to unsigned integers
- FCVTS for floats to signed integers

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.rst (+6/-0), example.c (+3/-0), linearize.c (+5/-0), linearize.h (+1/-0), simplify.c (+1/-0), ... and 6 more
--------------------------------------------------------------------------------

[55cac5336b14] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: handle NO-OP casts

Some casts, the ones which doesn't change the size or the resulting
'machine type', are no-op.

Directly simplify away such casts.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+8/-0), validation/linear/cast-kinds.c (+15/-0)
--------------------------------------------------------------------------------

[c6d4716f71de] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: specialize FPCAST into [USF]CVTF

Currently, all casts to a floating point type use OP_FPCAST.
This is maybe simple but rather uncovenient as it correspond
to several quite different operations that later need extra
checks.

Change this by directly using different instructions for the
different cases:
- FCVTF for float-float conversions
- UCVTF for unsigned integer to floats
- SCVTF for signed integer to floats
and reject attempts to cast a pointer to a float.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.rst (+9/-3), example.c (+6/-2), linearize.c (+15/-3), linearize.h (+2/-1), simplify.c (+3/-2), ... and 3 more
--------------------------------------------------------------------------------

[d0694a238744] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: prepare finer grained cast instructions

As a first step, add a small function which classify values into
'machine type:
- signed integer
- unsigned integer
- pointer
- floats
and use this to select the appropriate instruction.

Note: this is a preparatory patch and should not yet introduce
      any changes in the generated IR.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+63/-15)
--------------------------------------------------------------------------------

[295c51a487f5] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: force_cast are OK on non-scalar values

We used to warn about casts to or from non-scalar types and only
after we silently accept forced casts.

But, while non-scalar casts are illegal C, in the kernel it's
sometimes needed to use __force on non-scalar types.

Avoid useless warning by checking for non-scalar types after
having checked for forced casts.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+6/-6)
--------------------------------------------------------------------------------

[7e3db4834a81] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: rename evaluate_cast()'s vars with slightly more meaningful names

The current code was using names like 't1', 'class1' & 'as1' for the
type, class & address-space of the *target* and 't2', ... for the
*source*. The name 'target' was also used for the *source* expression.

Change this so:
- the source expression is named 'source'
- the type, class & as are named:
  *) 'stype', 'sclass' & 'sas' for the *source*
  *) 'ttype', 'tclass' & 'tas' for the *target*
  It's maybe not ideal but is much better than 't1', ...

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+48/-48)
--------------------------------------------------------------------------------

[3c9d59f6a535] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: add tests for warnings issued by sparse -v

The sparse command (aka the 'checker') do a number of additional
checks when used with the -v flag (I strongly believes that this
option is rarely used but let me not disgress about it here).
One of these additional checks is about casts.

Add some testcases in order to catch any problems here.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/cast-kinds-check.c (+27/-0)
--------------------------------------------------------------------------------

[f44e0e1a1ea6] 2018-06-23 07:46:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: add testcase for cast to bad typeof

There are special problems when a typeof() expression can't
be evaluated. Catch this here.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/cast-bad-01.c (+13/-0)
--------------------------------------------------------------------------------

[9ab2dd6f368e] 2018-06-23 07:46:39 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: add testcase for bad implicit casts to struct/union

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/cast-bad-00.c (+47/-0)
--------------------------------------------------------------------------------

[86af2a17d267] 2018-06-23 07:46:39 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cast: reorg testcases related to casts

* merge the tests about implicit & explicit casts in a
  single file as there was a lot of redundancy.
* shuffle the tests to linear/ or optim/

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/bool-cast-explicit.c (+0/-22), validation/bool-cast-implicit.c (+0/-25), validation/linear/bool-cast.c (+32/-0), validation/{ => linear}/cast-constant-to-float.c (+0/-0), validation/{ => linear}/cast-constants.c (+0/-0), ... and 4 more
--------------------------------------------------------------------------------

[3e7e84decfeb] 2018-06-23 07:45:16 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'bug-fpcast-constant', 'case-unop', 'replace-pseudo' and 'add-uniop' into tip

Those are the last prep-series for the rework of cast instructions.

Files: ir.c (+1/-5), linearize.c (+6/-5), linearize.h (+9/-5), liveness.c (+1/-8), simplify.c (+24/-27)
--------------------------------------------------------------------------------

[cd762fbdf4e5] 2018-06-23 07:43:54 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ir: case OP_UNOP ... OP_UNOP_END

Now that we have OP_UNOP & OP_UNOP_END, we can convert some long
switch cases by the shorter: case OP_UNOP ... OP_UNOP_END.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ir.c (+1/-5), liveness.c (+1/-8), simplify.c (+2/-12)
--------------------------------------------------------------------------------

[fa70d690d245] 2018-06-23 07:43:54 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ir: define an OP_... range for unops

Some operations are exactly the same for all unops, including casts.
To make things more readable and decrease the amount of churn, create
a range OP_UNOP - OP_UNOP_END like already done for binops.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+9/-5)
--------------------------------------------------------------------------------

[f46413ad4762] 2018-06-23 07:43:54 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add missing entry for OP_FNEG in kill_insn() & validate_insn()

These functions must have an entry for almost all instructions
but OP_FNEG was missing.

Fix this by adding the entry for OP_FNEG.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ir.c (+1/-1), simplify.c (+1/-1)
--------------------------------------------------------------------------------

[5d6793416315] 2018-06-22 22:58:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: rename add_uniop() to add_unop()

Everywhere else in the code and comments 'unop' is used as short
for 'unary op'.

So, use 'unop' also for this function.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+3/-3)
--------------------------------------------------------------------------------

[f352153b1e85] 2018-06-22 22:58:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add_uniop() should take a type, not an expression

The function add_uniop() needs the instruction's type but this
type was given indirectly via an expression. As consequence this
function cannot be used standalone.

Change the function to take the type as argument so that it can
also be used when no expression is available.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+6/-5)
--------------------------------------------------------------------------------

[48d7626d4046] 2018-06-22 22:47:58 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unused arg in simplify_cond_branch()

With the introduction of replace_pseudo(), the old condition
is now unneeded so remove this argument from the function.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+3/-3)
--------------------------------------------------------------------------------

[8688eb7aaf13] 2018-06-22 22:44:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: new helper: replace_pseudo()

Replacing the value of an operand is a relatively common operation
during simplification. Since this operation currently needs two
more primitive operations which must have common arguments, it would
be better to have a helper for it.

Create the helper: replace_pseudo() and use it when possible.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+19/-12)
--------------------------------------------------------------------------------

[26e8c24c4f1c] 2018-06-22 22:42:10 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: avoid useless deref in simplify_cond_branch()

In simplify_cond_branch(), the new condition is given via a pointer but
there is no reasons to use a pointer here.

Pass the new condition directly (and use a more descriptive name for it).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-4)
--------------------------------------------------------------------------------

[91ca9ff50b7f] 2018-06-21 14:07:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix bad fpcast simplification

A integer-to-float cast of a constant is currently simplified away
as if it is an integer-to-integer cast. That's bad.

Fix this by refusing to simplify away any integer-to-float casts
like already done for float-to-integer casts.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-2), validation/optim/fpcast-constant.c (+0/-1)
--------------------------------------------------------------------------------

[42b6bbfcfca2] 2018-06-21 14:07:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for bad fpcast simplification

A integer-to-float cast of a constant is currently simplified away
as if it is an integer-to-integer cast. That's bad.

Create a testcase for it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/fpcast-constant.c (+14/-0)
--------------------------------------------------------------------------------

[d99e1c4b72b2] 2018-06-21 10:12:23 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'ptrlist-cleanup' into tip

This series contains a number of cleanups of the list walking macros.
The main changes are:
* make untagged pointers the normal case
* use structurally equivalent struct for all pointer lists
  to avoid needless casting to and fro struct ptrlist
* simplify PREPARE/NEXT/RESET logic by using common PTR_NEXT()

Files: README (+2/-2), c2xml.c (+2/-2), compile.c (+2/-2), ctags.c (+2/-2), example.c (+10/-10), ... and 14 more
--------------------------------------------------------------------------------

[3da4f16d3182] 2018-06-21 10:06:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: add missing doc for some functions

The documentation was added as a kind of test for sphinx + autodoc.
As such, several variants were used, for example doc entries without
parameter description.

Now that sphinx + autodoc are merged, add the full doc for all functions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.c (+7/-1)
--------------------------------------------------------------------------------

[ee8497c1734e] 2018-06-21 10:06:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: move DO_SPLIT() into DO_INSERT_CURRENT()

DO_SPLIT() has only a single user and don't see to be
usable standalone.

So, merge it into its user, DO_INSERT_CURRENT().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+7/-10)
--------------------------------------------------------------------------------

[8900570707d5] 2018-06-21 10:06:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: make clear what is API and what is implementation.

The list walking macros are quite a bit complex and it's not
very easy to understand what is doen by what.

Help things a little bit here by moving up all the top-level
macros which define the API to be used. This will also help
to document them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+69/-57)
--------------------------------------------------------------------------------

[a90e2c0fce7c] 2018-06-21 10:04:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: keep declaration of head-list-nr together

The list walking macros need to keep some state:
- the head of the list:              head
- the current list 'block':          list
- the current position in the block: nr

Make this clear by keeping their declaration together.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+4/-2)
--------------------------------------------------------------------------------

[e9a15348b778] 2018-06-21 10:04:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: use VRFY_PTR_LIST() for sanity check

DO_FINISH() contains a statement which only purpose is for
sanity check on the argument (for example, some scope switching).

Use VRFY_PTR_LIST() for this whose name is already somehow
self-explaining (and which do some additional type checking).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+1/-1)
--------------------------------------------------------------------------------

[74857d9438d2] 2018-06-21 10:04:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: move semi-private prototypes close to their user

The goal being to help to see what is API and what is not.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+4/-3)
--------------------------------------------------------------------------------

[99be84e2aad9] 2018-06-21 10:04:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: make {first,last}_ptr_list() out-of-line functions

These two functions were inline but are already too big, too
complicated to be inlined.

Make them out-of-line functions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.c (+38/-0), ptrlist.h (+2/-29)
--------------------------------------------------------------------------------

[a4820df25663] 2018-06-21 10:04:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: remove ptr_list_empty()

The name of the function is misleading: it only tests if the
pointer to the list is NULL. But while it's usually enforced
that empty list are NULL (after using PACK_PTR_LIST()), it's
not generally true that empty list are NULL.

Since the macro has a single user anyway, remove the macro
and convert the user to a NULL test since it is the correct
thing to do in this situation.

Note: it used to be that list packing was more enforced that
      it is currently and some list can't be packed.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-1), ptrlist.h (+0/-1)
--------------------------------------------------------------------------------

[cc6123302c4d] 2018-06-21 10:04:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: shorter continuated lines

Most of the list walking macros are multiline and have their
final '\' are unnecessary placed far on the line, at column 88,
which is a bit annoying.

When possible, align the continuations at column 72.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+115/-113)
--------------------------------------------------------------------------------

[fe9b58ea2d0e] 2018-06-21 10:04:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: simplify PREPARE/NEXT

Since PREPARE_PTR_LIST() already returns the first element, it
must do essentially the same checks and loops as NEXT_PTR_LIST().
Ditto for RESET_PTR_LIST().

So, factorize out the common part into PTR_NEXT() and use this for
PREPARE, NEXT & RESET.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+17/-19)
--------------------------------------------------------------------------------

[c5ba266d9746] 2018-06-21 10:04:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: simplify DO_NEXT

The body of this macros is quite complicated, more so than needed.

Simplify it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+7/-11)
--------------------------------------------------------------------------------

[858ee7e8b247] 2018-06-21 10:04:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: simplify loop nesting

Some of the list walking macros use two levels of loop nesting more
than really needed.

Remove them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+7/-17)
--------------------------------------------------------------------------------

[9c9a70fbc68c] 2018-06-21 10:04:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: remove extra ident level

The list walking macros are relatively complex and the code they define
have often 5 or 6 level of nesting.

However, in a few places, a small rewrite of the code can save one
nesting level and this help to make the code more readable.

Make this change and reduce the indentation level.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+31/-34)
--------------------------------------------------------------------------------

[9d34da8ee653] 2018-06-21 10:04:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: remove some unneeded arg from internal macros.

Some macros used internally for the list walking have unneeded arguments.

Remove these unnneded arguments as this help to make the lines shorter
and more readable.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+6/-6)
--------------------------------------------------------------------------------

[4e05bda4bf3d] 2018-06-21 10:04:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: make free_ptr_list() more readable

The macro free_ptr_list() is much longer than 80 columns.

Make it more readable by splitting its long definition in three
separate lines.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+4/-2)
--------------------------------------------------------------------------------

[3beb0f514f5e] 2018-06-21 10:04:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: make add_ptr_list() more readable

The macros add_ptr_list() & add_ptr_list_tag() have a rather complex
and long definition.

Make them more readable by splitting the long definition in three
separate lines, inside a statement expression.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+10/-11)
--------------------------------------------------------------------------------

[3b748f134af8] 2018-06-21 10:04:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: remove now unneeded CHECK_TYPE()

Now that the list walking macros use the real type, extra type
checking is not needed anymore as the normal typechecking done by
the compiler will be enough.

So, remove these unnneded call to CHECK_TYPE().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+0/-3)
--------------------------------------------------------------------------------

[cb647a97c485] 2018-06-21 10:04:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: when possible use the real type of the list

The macros doing the list walking used to be done, not on the declared
list's type but on the concrete & generic type 'struct ptr_list'.
This incurs casting between the real and the generic type.

Now that the declared type matches ... these casts are not needed
anymore and the real declared type can be used instead.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+14/-14)
--------------------------------------------------------------------------------

[8fcbe9f40501] 2018-06-21 10:04:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: let all pointer lists have the same parametrized structure

Currently, all pointer lists have the same concrete structure,
struct ptr_list, which is also used as a generic pointer list.
But they're each declared with a phony type which just allows
to get back the type of the pointer:
	struct <name> { <TYPE> list[0]; };
vs.
	struct ptr_list {
		....
		void * list[NR];
	};

Since the declaration doesn't match the real representation
every operation done on pointer lists must cast forth & back the
list pointer to the generic type. OTOH, type safety is assured
by phony extra statements which are NOP but would produce warnings
if, for example, the type of the list doesn't correspond to
the element to be stored or retrieved.

This patch and the following ones takes another approach where
all pointer lists are declared *and* defined to essentially the
same structure but kinda parametrized with the type of the pointers
to be stored in the list. This has the advantage that most operations
are done on the real types and thus to eliminate all the type checking
statements and most of the casts (the ones remaining are the ones
needed to interface with the generic type used for the functionalities
implemented as functions).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+10/-8)
--------------------------------------------------------------------------------

[6aef068ada2a] 2018-06-21 10:02:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: let sort_list() use the raw pointer

The function sort_list() always strip tag from their entries but:
* there is no a single use of this function with tagged pointers.
* the vast majority of ptrlists doesn't use tagged pointers
* the unsuffixed macro like FOR_EACH_PTR() doesn't strip anymore the
  tag from the entries, only the ones suffixed by _TAG do.
* tags are information attached to the entries, as such they may
  be needed for dping the comparion.

So, be consistent and stop to unneedlessly strip (unexistent) tags
from the pointers. If used on tagged pointers it's always possible
and easy to explicitly strip the tag in teh comparison function.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sort.c (+3/-3)
--------------------------------------------------------------------------------

[b0a2f279e273] 2018-06-21 10:02:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: let {first,last}_ptr_list() return the raw pointer

The functions {first,last}_ptr_list() strip tag from their entries but:
* there is no a single use of these functions on list with tagged pointers.
* the vast majority of ptrlists doesn't use tagged pointers
* the unsuffixed macro like FOR_EACH_PTR() doesn't strip anymore the
  tag from the entries, only the ones suffixed by _TAG do.
* tags are information attached to the entries, as such they may
  be needed when retrieved from the list.

Let do the same for {first,last}_ptr_list() and stop to unneedlessly
strip unexistant tags from the returned entries.

Of course, if needed, the returned entries can always be explicitly
untagged, preferably via an helper.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+2/-2)
--------------------------------------------------------------------------------

[fc0cf5926b13] 2018-06-21 10:02:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: remove the now unneeded FOR_EACH_PTR_NOTAG()

Now that FOR_EACH_PTR() doesn't strip the tag anymore, there
is no more needs for FOR_EACH_PTR_NOTAG() as both do the same.

So convert the few uses to FOR_EACH_PTR() and remove its definition.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: README (+2/-2), c2xml.c (+2/-2), compile.c (+2/-2), ctags.c (+2/-2), example.c (+2/-2), ... and 11 more
--------------------------------------------------------------------------------

[b837ca11382b] 2018-06-21 08:15:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'ir-validate' into tip

This series add validation of the IR.
It is a preparatory step before merging the 'classical SSA'.

Files: Makefile (+1/-0), ir.c (+161/-0), ir.h (+8/-0), lib.c (+6/-4), lib.h (+3/-2), ... and 1 more
--------------------------------------------------------------------------------

[233960fb148c] 2018-06-21 08:14:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add predefines for __INT_WIDTH__ & friends

Recent versions of GCC predefine macros like __INT_WIDTH__ for
the integer types.

Do the same here since some <limits.h> may depends on it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+15/-0)
--------------------------------------------------------------------------------

[e97275d8e5c4] 2018-06-21 07:36:21 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sparsec: simplify & portable use of mktemp

Most manpages for mktemp(1) specify that the 'XXXXXX' part of the
template must be at the end (of course, the GNU's version accept
it anywhere). At least the busybox's version used by Alpine Linux
tries to enforce that and fails in sparse current use of it:
	tmp.XXXXXX.{llvm,o}

OTOH, the llc command can take its input from stdin and so there
is no need to have 2 temp files that need to be distinguished.

Fix the portability problem by feeding llc via stdin, which removes
the need for the first temp file, and using 'tmp.XXXXXX' as template
for the remaining one.

Fixes: a410611d7 "(llvm: fix creation of sparsec's tmp files")
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparsec (+3/-6)
--------------------------------------------------------------------------------

[098a4978bba3] 2018-06-16 13:25:25 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ir-validate: add more validation points

[Auto-summary] Modifies optimize.c. Changes: +7/-0 in 1 file(s)

Files: optimize.c (+7/-0)
--------------------------------------------------------------------------------

[b7c69808487a] 2018-06-16 11:59:24 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ir-validate: add validation of (nbr of) phi operands

This patch verify that every phi-nodes have the same number of
operands as the current BB has parents.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ir.c (+52/-0)
--------------------------------------------------------------------------------

[1332a386f365] 2018-06-16 11:59:07 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ir-validate: validate pseudo's defining instruction

PSEUDO_REGs & PSEUDO_PHIs are defined by some instructions.
This patch validate that each such pseudo have indded a valids
defining instruction.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ir.c (+69/-0)
--------------------------------------------------------------------------------

[c6b637e5660c] 2018-06-16 11:59:02 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ir-validate: add framework for IR validation

To be meaningful, the IR instructions and their relationships
must obey some constraints. This patch add the framework for
doing this kind of validation.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), ir.c (+40/-0), ir.h (+8/-0), lib.c (+2/-0), lib.h (+1/-0), ... and 1 more
--------------------------------------------------------------------------------

[11fa45bd6113] 2018-06-16 06:31:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: keep the debug flags alphabetically sorted

As often the case, the declaration of the debug flags were
done in the order they were added.

But after a while this become messy so keep them now alpha-sorted.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+4/-4), lib.h (+2/-2)
--------------------------------------------------------------------------------

[38a03a5ffc74] 2018-06-16 06:31:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: allow extra/default options to test commands

This allow, for example, to simulate running the testsuite on a 32bit
machine or running the testsuite with some extra debugging flags.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+4/-0)
--------------------------------------------------------------------------------

[1d56c2e9dc70] 2018-06-16 06:31:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: fix missing return

Some non-void functions in the testcases miss a return.

Add the missing return or make the function as returning void.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/call-basic.c (+8/-8), validation/optim/dup-cond0.c (+1/-0)
--------------------------------------------------------------------------------

[5a0840b711e7] 2018-06-16 06:17:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add doc for the -vcompound flag

The -vcompound wasn't documented.
Fix this by adding a very short description for it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Randy Dunlap <rdunlap@infradead.org>

Files: Documentation/dev-options.rst (+4/-0)
--------------------------------------------------------------------------------

[518fd8c131c6] 2018-06-16 06:16:07 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support for -fdiagnostic-prefix[=prefix]

When using sparse it's common to compile a file and directly
run sparse on the same file, like it is done for the kernel.
In this case, error messages from sparse are interspersed with
those from the compiler. It's thus not always easy to know from
which tools they come.

Fix this by allowing to prefix all the diagnostic messages
by some configurable string, by default "sparse". More exactly,
an error message that was emitted like:
	file.c:<line>:<col>: error: this is invalid code
can now be emitted as:
	file.c:<line>:<col>: sparse: error: this is invalid code

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Reviewed-by: Ramsay Jones <ramsay@ramsayjones.plus.com>

Files: cgcc (+1/-1), lib.c (+19/-3), sparse.1 (+6/-0), validation/fdiag-prefix.c (+11/-0)
--------------------------------------------------------------------------------

[a697a21927bd] 2018-06-15 06:43:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: utils: add xasprintf() & xvasprintf()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: utils.c (+30/-0), utils.h (+18/-0)
--------------------------------------------------------------------------------

[c48f6ced23e3] 2018-06-13 05:49:23 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: let FOR_EACH_PTR() ignore tags

Since the introduction of the macro FOR_EACH_PTR_TAG() all the users
of the macros FOR_EACH_PTR() & FOR_EACH_PTR_REVERSE() are only used
for the usual case where no tag is used on the pointers.

It is thus no more needed to strip the tag from these pointers
and internally we can, for these two macros, call the simpler
PTR_ENTRY_NOTAG() instead of PTR_ENTRY_UNTAG().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+2/-2)
--------------------------------------------------------------------------------

[9d04727b5aa5] 2018-06-13 05:49:23 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: make explicit when tagged pointers are used.

Only a few places need list recursions on tagged pointers but currently
they use the same macros as the common case where no tag is used.

Make this very explicit by adding using the macro FOR_EACH_PTR_TAG()
for these few cases.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: example.c (+8/-8), ptrlist.h (+6/-0)
--------------------------------------------------------------------------------

[0c96862dde0f] 2018-06-13 05:49:23 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: rename PTR_ENTRY() to PTR_ENTRY_UNTAG()

The name PTR_ENTRY is used for two closely related things:
1) as a macro which dereference an entry from a list *and*
   take care to strip any tag from this entry
2) a parameter name in a lot of internal prtlist macros which
   will correspond to either PTR_ENTRY_NOTAG() or .. PTR_ENTRY()
This can be quite confusing

Lift the confusion by rename the macro PTR_ENTRY() to PTR_ENTRY_UNTAG()
so that the two uses have now a different name and which self-document
the effect of this macro.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+9/-9), sort.c (+3/-3)
--------------------------------------------------------------------------------

[5fbbd26babac] 2018-06-13 05:49:23 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: add helper PTR_UNTAG()

The macro PTR_ENTRY() need tp strip possible tag from the entry.

Let create a small helper for this 'untagging' operation.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+2/-1)
--------------------------------------------------------------------------------

[320da0d6a1bf] 2018-06-13 05:49:23 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: remove now unneeded add_ptr_list_notag()

Since add_ptr_list_notag() is now simply a define to add_ptr_list()
it's not anymore really needed and can be removed.

Remove add_ptr_list_notag()'s definition and replace its only call
by a call to add_ptr_list().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-1), ptrlist.h (+0/-2)
--------------------------------------------------------------------------------

[2fcbc8059976] 2018-06-13 05:49:23 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: specialize __add_ptr_list() for tag/notag

Currently, the function to add items to ptrlists, __add_ptr_list(),
always combine a 'raw' pointer and a tag.

But the vast majority of list entries have no tag and so just need
to store the raw pointer.

Avoid to do this operation when it's not needed by specializing
this function like this:
- __add_ptr_list() which directly store an untagged or 'cooked' ptr.
- __add_ptr_list_tag() which combine a pointer and a tag and then
  store this 'cooked' pointer by calling __add_ptr_list().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.c (+23/-10), ptrlist.h (+8/-8)
--------------------------------------------------------------------------------

[4ca1ddef1c92] 2018-06-13 05:34:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse about -m16

The boot part of the kernel on x86-64 has to compile code for
real-mode. This is 32bit code and is specified to GCC with '-m16'.

However, sparse hadn't knwoledge of this flag and thus uses the
default LP64 model for it which, of course, can cause false
warnings because of the mismatched sizes.

Fix this by teaching sparse about the -m16 flag by treating it
the same as -m32.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-1)
--------------------------------------------------------------------------------

[b38fb646aac0] 2018-06-12 18:01:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'has-builtin' and 'builtin-predef' into tip

This will merge the following topic branches:

* builtin-dyn:
    Expansion of macros like __FILE__, __DATE__, ... must, contrary
    to usual macros, be done dynamically.
    This series improves support for them:
    - consider them as defined (like GCC do)
    - use table + method for their expansion (avoid useless compares)
    - add support for __INCLUDE_LEVEL__ & __BASE_FILE__

* builtin-predef:
    Add a function: predefine() which allow to directly add
    the definition of a simple macro (without args and with
    a single number or ident as definition).
    Also do the conversion of the concerned predefined macros
    and some cleanups.

* builtin-overflow:
    Add support for builtins doing overflow checking.

* has-builtin:
    Add support for the __has_builtin() macro.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/api.rst (+1/-0), Makefile (+1/-0), builtin.c (+98/-2), ident-list.h (+1/-5), lib.c (+86/-97), ... and 15 more
--------------------------------------------------------------------------------

[7c929e1a969c] 2018-06-12 17:55:11 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: merge declare_builtin_function() with declare_builtins()

declare_builtin_functions() contained only the declaration of 3
(Blackfin specific) builtin functions.

Move these to declare_builtins() where all other builtins are declared.

Note: these builtin are were declared on the condition that '__bfin__'
      was defined and now are unconditionally declared. It's fine,
      the builtins for alpha are also always declared here.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+5/-0), lib.c (+0/-19)
--------------------------------------------------------------------------------

[7304b37ab691] 2018-06-12 17:54:32 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: switch calling order of predefined_macros() & friends

The builtin functions were first declared, then the builtin stream
created and only then the builtin macros were predefined.
But this is essentially the wrong (logical) order.

Change the calling order so:
- first predefine the builtins macros
- create the builtin stream
- declare the builtin functions

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+2/-2)
--------------------------------------------------------------------------------

[9f75c9df0474] 2018-06-11 04:31:04 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'doc-sphinx-ir'

add a small directive for the IR instructions, allowing to:
* have those instructions in the index
* have a nicer presentation of the generated doc thanks
  to not having to use level-4 headings anymore

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.md (+0/-356), Documentation/IR.rst (+411/-0), Documentation/conf.py (+1/-0), Documentation/doc-guide.rst (+4/-0), Documentation/index.rst (+1/-1), ... and 1 more
--------------------------------------------------------------------------------

[12dfe2d5abfa] 2018-06-11 04:30:05 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: API before IR

The sparse API is more important than the details about the IR.
So move the API doc before the IR doc.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/index.rst (+1/-1)
--------------------------------------------------------------------------------

[f3e56ad27536] 2018-06-08 22:07:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: consolidate predefined_macros()

Move all predefined macros to ... predefined_macros()
Neater so, isn't it?

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+56/-56)
--------------------------------------------------------------------------------

[b2b49f3eae10] 2018-06-08 22:07:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: directly predefine builtin macros

Use the newly created predefine() to define the builtin macros.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+45/-38)
--------------------------------------------------------------------------------

[92a63b7b07b3] 2018-06-08 22:07:11 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add predefine()

Builtin macros are defined via the add_pre_buffer() mechanism
which is quite powerful/flexible but for small, simple builtin
macros, it's a bit sad to have to compose a buffer and then
tokenize it when it would be easy to directly define these macros.

Add a new function, predefine(), which allows to directly add
a definition for a simple macro, taking no args and having
a single number or identifier as definition.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.h (+1/-0), pre-process.c (+38/-0)
--------------------------------------------------------------------------------

[a6e80f36afca] 2018-06-08 18:55:02 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add support for __has_builtin()

Sparse has support for a subset of GCC's large collection of builtin
functions. As for GCC, it's not easy to know which builtins are
supported in which versions.

clang has a good solution to this problem: it adds the checking macro
__has_builtin(<name>) which evaluates to 1 if <name> is a builtin
function supported by the compiler and 0 otherwise.
It can be used like:
	#if __has_builtin(__builtin_clz)
	#define clz(x)	__builtin_clz(x)
	#else
	...
	#endif

It's possible or probable that GCC will have this soon too:
	https://gcc.gnu.org/bugzilla/show_bug.cgi?id=66970

Add support for this __has_builtin() macro by extending
the evaluation of preprocessor expressions very much like
it is done to support defined().

Note: Some function-like builtin features, like __builtin_offset(), are
      considered as a kind of keyword/operator and processed as such.
      These are *not* considered as builtins by __has_builtin().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+2/-0), ident-list.h (+1/-0), lib.c (+1/-0), pre-process.c (+37/-0), symbol.h (+1/-0), ... and 1 more
--------------------------------------------------------------------------------

[35b50cdb51b6] 2018-06-08 18:53:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: extract replace_with_bool() from replace_with_defined()

so that it can be reused for similar boolean evaluated macros.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+7/-3)
--------------------------------------------------------------------------------

[da8d67b5bba6] 2018-06-08 18:53:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add support for __builtin_{add,sub,mul}_overflow(), ...

It seems they will be used in the kernel so add them.

Unlike __builtin_uadd_overflow() and friends, these don't take
a fixed type and thus can't simply be declared but need their
own evaluate() method to do the type checking.

Note: of course, no expansion is done on them.
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+71/-0), validation/builtin-overflow.c (+246/-0)
--------------------------------------------------------------------------------

[cab4c232f58e] 2018-06-08 18:53:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: rename arguments_choose() to args_triadic()

argument_choose() did nothing specific to __builtin_chose_expr(),
it simply called eval_args(expr, 3).

Since exactly the same may be needed for other builtins, rename it
to a more generic name making it clear it can be reused.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+2/-2)
--------------------------------------------------------------------------------

[4ab7e953b764] 2018-06-08 18:53:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: declare __builtin_[us]{add,sub,mul}{,l,ll}_overflow()

There may be some needs for them in the kernel so add them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+18/-0)
--------------------------------------------------------------------------------

[552de4433d38] 2018-06-08 18:53:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add builtin types {u,}{int,long,long}_ptr_ctype

These will be needed for __builtin_uadd_overflow() and friends.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+9/-0), symbol.h (+3/-0)
--------------------------------------------------------------------------------

[35f06fa8136d] 2018-06-08 17:14:38 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: extract do_define() from do_handle_define()

So it can be resused to declare builtin macros.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+37/-30)
--------------------------------------------------------------------------------

[2478121abb6b] 2018-06-08 17:14:38 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add testcase for builtin macro expansion

Add a few silly testcases doing some expansion of a builtin macro.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/preprocessor/builtin.c (+17/-0)
--------------------------------------------------------------------------------

[112a6909b850] 2018-06-08 17:07:17 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: utils: convert alloc + copy to {mem,str}dup_alloc()

When possible convert allocation + copy of a memory buffer or
a string to x{mem,str}dup().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+3/-7), tokenize.c (+2/-7)
--------------------------------------------------------------------------------

[4e0624c3b8dd] 2018-06-08 17:07:08 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: utils: add xmemdup() & xstrdup()

Add small helpers for copying a memory buffer or a string
into a newly allocated buffer.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/api.rst (+1/-0), Makefile (+1/-0), lib.h (+1/-0), utils.c (+17/-0), utils.h (+25/-0)
--------------------------------------------------------------------------------

[fb1d00d35713] 2018-06-04 23:24:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dyn-macro: add real support for __BASE_FILE__

There was some support for it but it was just a define
that expanded to the fixed name "base_file.c".

Implement the real thing by saving the input filename
and replacing __BASE_FILE__ by it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+3/-3), lib.h (+2/-0), pre-process.c (+6/-0), validation/preprocessor/base-file.c (+17/-0), validation/preprocessor/base-file.h (+2/-0), ... and 1 more
--------------------------------------------------------------------------------

[432a43b02a9a] 2018-06-04 23:24:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dyn-macro: add support for __INCLUDE_LEVEL__

This macro, which is supported by GCC, wasn't yet by sparse.

Add support for it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+9/-0), validation/preprocessor/dynamic.c (+4/-0), validation/preprocessor/include-level.c (+14/-0), validation/preprocessor/include-level.h (+1/-0)
--------------------------------------------------------------------------------

[2b2e96ab3756] 2018-06-04 23:24:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dyn-macro: use a table to expand __DATE__, __FILE__, ...

GCC consider these macros as being defined, sparse doesn't.
Also sparse uses a sequence of comparisons, one for each of
__DATE__, __FILE__, ..., which is not ideal.

Fix this by defining and using a table to associate to the
corresponding symbol a method doing the expansion.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ident-list.h (+0/-5), pre-process.c (+57/-21), symbol.h (+1/-0), validation/preprocessor/dynamic.c (+0/-1)
--------------------------------------------------------------------------------

[1dd127244b7e] 2018-06-04 23:24:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dyn-macro: add testcase for __LINE__ & friends

GCC considers __LINE__, __FILE__, ... as being defined.
Add a testcase for this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/preprocessor/dynamic.c (+30/-0)
--------------------------------------------------------------------------------

[ed8ab3d9a92e] 2018-06-04 15:53:49 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'label-redef', 'goto-reserved', 'errmsg-builtin-pos', 'fix-builtin-expect' and 'int-const-expr' into tip

[Auto-summary] Modifies 6 source files: builtin.c, evaluate.c, lib.c and 3 more. Updates 2 headers. Adds/updates 13 test(s). Changes: +523/-57 in 21 file(s)

Files: builtin.c (+1/-8), evaluate.c (+33/-1), lib.c (+23/-1), lib.h (+2/-0), linearize.c (+1/-5), ... and 16 more
--------------------------------------------------------------------------------

[879c7363213c] 2018-06-04 15:50:59 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test for integer-const-expr-ness

This use Martin's awesome macro to test if sparse's
notion of integer-const-expr is the same as GCC's.

It test also that the result of this macro is itself a
constant integer expression.

Awesome-macro-by: Martin Uecker <Martin.Uecker@med.uni-goettingen.de>
Test-originally-by: Rasmus Villemoes <linux@rasmusvillemoes.dk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/integer-const-expr.c (+85/-0)
--------------------------------------------------------------------------------

[09e75bb48f7e] 2018-06-01 15:06:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: avoid multiple error message after parsing error

Parsing error triggered by expect() insert bad_token as the
current token. This allows to skip other errors with expect().
So far so good but this token is a fake token which has no
position set, if another parsing error is detected by something
else than expect(), the error message will use the position of
this bad token which will be displayed like:
	builtin:0:0: ...
which is confusing.

Since the concerned error message are secondary ones, the primary
one have been already be repported by expect(), the best is to
simply skip all these secondary error messages.

Do this by creating a new token type (TOKEN_BAD) and use it for
bad_token, then filter error messages based on this token type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+8/-1), token.h (+1/-0)
--------------------------------------------------------------------------------

[573953f358dc] 2018-06-01 15:06:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: give a position to end-of-input

If an error occurs at the end of the input, for example because
a missing terminating ';' or '}', the error message is like:
	builtin:0:0: error: ...
IOW, the stream name & position is not displayed because the
because the current token is eof_token_entry which has no position.
This can be confusing and for sure doesn't point where the error is.

Fix this by giving to eof_token_entry the end-of-stream position.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: tokenize.c (+1/-0), validation/check_byte_count-ice.c (+2/-2), validation/error-at-eof.c (+10/-0)
--------------------------------------------------------------------------------

[cb054f8a7557] 2018-06-01 15:01:59 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix crash on 'goto <reserved word>'

On code like 'goto <some reserved code>', bind_symbol() reports
an error and doesn't bind the label's ident to the goto's label
symbol.

However, at evaluation time, the ident is unconditionally
dereferenced.

Avoid the crash by checking for a null ident before dereferencing it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-1), validation/goto-reserved.c (+12/-0)
--------------------------------------------------------------------------------

[da29278349ab] 2018-06-01 03:27:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix typing of __builtin_expect()

Typewisely, sparse process __builtin_expect() as:
1) returning 'int'
2) taking any type in first & second arg
3) returning exactly its first argument, silently, even
   if this conflicts with 1).
but this doesn't match with how gcc declare it:
	long __builtin_expect(long, long);

Fix this by giving the proper prototype to this builtin
and removing the bogus 'returns an int'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+1/-8), validation/expand/builtin-expect.c (+101/-0)
--------------------------------------------------------------------------------

[ed5dcc156b36] 2018-05-27 18:15:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'vla-sizeof' into tip

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+32/-0), validation/vla-sizeof-ice.c (+19/-0), validation/vla-sizeof0.c (+20/-0), validation/vla-sizeof1.c (+21/-0), validation/vla-sizeof2.c (+21/-0), ... and 2 more
--------------------------------------------------------------------------------

[0062618881aa] 2018-05-27 17:51:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: vla-sizeof: add support for sizeof of VLAs

While sparse can parse VLA, their size were left as
'undeterminated' (-1) and trying to use sizeof on VLAs
resulted in a warning 'error: cannot size the expression'.

Fix this by adding the needing code to evaluate the expressions
corresponding to the sizeof of VLAs.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+32/-0), validation/vla-sizeof-ice.c (+0/-1), validation/vla-sizeof1.c (+0/-1), validation/vla-sizeof2.c (+0/-1), validation/vla-sizeof3.c (+0/-1), ... and 1 more
--------------------------------------------------------------------------------

[f5f2d7167eb6] 2018-05-27 17:51:15 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: vla-sizeof: add test cases

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/vla-sizeof-ice.c (+20/-0), validation/vla-sizeof0.c (+20/-0), validation/vla-sizeof1.c (+22/-0), validation/vla-sizeof2.c (+22/-0), validation/vla-sizeof3.c (+22/-0), ... and 1 more
--------------------------------------------------------------------------------

[bfa07811d74a] 2018-05-26 18:35:46 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: label: avoid multiple definitions

If a label is defined several times, an error is issued about it.
Nevertheless, the label is used as is and once the code is linearized
several BB are created for the same label and this create
inconsistencies. For example, some code will trigger assertion failures
in rewrite_parent_branch().

Avoid the consistencies by ignoring redefined labels.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+6/-3), validation/label-redefined.c (+0/-1)
--------------------------------------------------------------------------------

[8efcdf62178f] 2018-05-26 18:34:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: label: add testcase for label redefinition

Redefined labels create inconsistencies in BB processing.
Add a testcase for it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/label-redefined.c (+18/-0)
--------------------------------------------------------------------------------

[f88da50b475e] 2018-05-26 17:04:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: context: extra warning for __context__() & friends

Statements with an empty expression, like:
	__context__();
or
	__context__(x,);
are silently accepted. Worse, since NULL expressions are usually
ignored because it is assumed they have already been properly
diagnosticated, no warnings of any kind are given at some later
stage.

Fix this by explicitly checking after empty expressions and
emit an error message if needed.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+4/-0), validation/context-stmt.c (+17/-0)
--------------------------------------------------------------------------------

[63369a98d8ee] 2018-05-26 17:04:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: context: stricter syntax for __context__ statement

The expected syntax for the __context__ statement is:
	__context__(<expression>);
or
	__context__(<context>, <expression>);
but originally it was just:
	__context__ <expression>
In other words the parenthesis were not needed and are
still not needed when no context is given.

One problem with the current way to parse these statements is
that very few validation is done. For example, code like:
	__context__;
is silently accepted, as is:
	__context__ a, b;
which is of course not the same as:
	__context__(a,b);
And code like:
	__context__(,1);
results in a confusing error message:
	error: an expression is expected before ')'
	error: Expected ) in expression
	error: got ,

So, given that:
* the kernel has always used the syntax with parenthesis,
* the two arguments form requires the parenthesis and thus
  a function-like syntax
use a more direct, robust and simpl parsing which enforce
the function-like syntax for both forms.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+8/-10), validation/context-stmt.c (+22/-3)
--------------------------------------------------------------------------------

[bf28f6e2b80f] 2018-05-26 17:04:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: context: fix crashes while parsing '__context__;' or '__context__(;'

The expected syntax for the __context__ statement is:
	__context__(<inc/dec value>);
or
	__context__(<context>, <inc/dec value>);

The distinction between the two formats is made by checking if
the expression is a PREOP with '(' as op and with an comma
expression as inner expression.

However, code like:
	__context__;
or
	__context__(;
crashes while trying to test the non-existing expression
(after PREOP or after the comma expression).

Fix this by testing if the expression is non-null before
dereferencing it.

Note: this fix has the merit to directly address the problem
      but doesn't let a diagnostic to be issued for the case
	__context__;
      which is considered as perfectly valid.
      The next patch will take care of this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+3/-1), validation/context-stmt.c (+7/-0)
--------------------------------------------------------------------------------

[02510ae80084] 2018-05-26 17:04:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: context: __context__(...) expect a constant expression

No check are done if the inc/dec value of context statements
is effectively a compile-time integer value: '0' is silently
used if it is not.

Change that by using get_expression_value() when linearizing
context statements (which has the added advantage to also
slightly simplify the code).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+1/-5), validation/context-stmt.c (+19/-0)
--------------------------------------------------------------------------------

[8e9e4da4790a] 2018-05-26 17:04:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: context: fix parsing of attribute 'context'

Currently the parsing of the attribute 'context' is rather
complex and uses a loop which allows 1, 2, 3 or more arguments.
But the the real syntax is only correct for 2 or 3 arguments.

Furthermore the parsing mixes calls to expect() with its own
error reporting. This is a problem because if the error has first
been reported by expect(), the returned token is 'bad_token'
which has no position so you can have error logs like:
	test.c:1:43: error: Expected ( after context attribute
	test.c:1:43: error: got )
	builtin:0:0: error: expected context input/output values
But the 'builtin:0.0' should really be 'test.c:1.43' or, even better,
there shouldn't be a double error reporting.

Fix this by simplifying the parsing and only support 2 or 3 args.
Also, make the error messages slightly more explicit about the
nature of the error.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+13/-32), validation/attr-context.c (+40/-0)
--------------------------------------------------------------------------------

[6b6daa5c5838] 2018-05-26 17:04:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add helper for new parsing errors: unexpected()

Most parsing errors are reported during parsing itself but
sometimes some extra conditions must be checked.
One problem with this is that these extra conditions are not
met because they are the consequence of a primary error which
has already been reported. In this case, it this not desirable
to emit a new error message.

To help with this, add a small function which will emit an
error message followed by the current token but only if the
current token does not originated from a previous parsing error.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+16/-1), lib.h (+2/-0)
--------------------------------------------------------------------------------

[f477cb74ff13] 2018-05-21 03:50:16 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add sphinx domain for IR instruction indexation

The doc for IR instructions used definition lists to structure
the instructions names and their description. This is simple
to write and present well but it doesn't put the instructions'
name in the index.

Fix this by adding a new domain, with a single directive 'op'
which takes the instruction name, inserts an index entry and uses
it for the definition.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.rst (+80/-74), Documentation/conf.py (+1/-0), Documentation/doc-guide.rst (+4/-0), Documentation/sphinx/ir.py (+75/-0)
--------------------------------------------------------------------------------

[943416a74350] 2018-05-21 03:10:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'doc-sphinx' into tip

[Auto-summary] Modifies 7 source files: builtin.c, evaluate.c, expand.c and 4 more. Updates 2 headers. Adds/updates 2 test(s). Updates documentation. Changes: +1387/-258 in 27 file(s)

Files: .gitignore (+1/-0), Documentation/.gitignore (+2/-0), Documentation/Makefile (+26/-0), Documentation/api.rst (+21/-0), Documentation/conf.py (+177/-0), ... and 22 more
--------------------------------------------------------------------------------

[9a6bc349fa1f] 2018-05-21 03:09:17 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: convert IR.md to reST

The doc for IR instructions was written in MarkDown format which
is quite easy and quite close to normal text.
However Markdown has a few limitations:
1) structuration via level-x headings is not nice when rendered
2) it would be nice to have the instructions in the index

So convert this in reStructuredText format as it will
directly solve problme 1) and prepare to solve problem 2)

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.md (+0/-356), Documentation/IR.rst (+405/-0)
--------------------------------------------------------------------------------

[325ffb76f6a0] 2018-05-21 03:06:27 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: autodoc: add autodoc tests in the testsuite

It's certainly worth to have some tests but to not
slow down the testsuite and to not create a dependency
on python this test need to be run explicitely with:
	./test-suite doc/cdoc.cdoc

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/doc/cdoc.cdoc (+177/-0), validation/test-suite (+1/-1)
--------------------------------------------------------------------------------

[a6c549b2e173] 2018-05-21 03:06:27 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: autodoc: document a few more APIs to test multiline

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/api.rst (+10/-0), evaluate.h (+15/-0), expression.h (+16/-2)
--------------------------------------------------------------------------------

[b5b7da4222c1] 2018-05-21 03:06:27 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: autodoc: support muti-line param & return descriptions

Short descriptions are good but sometimes you can't describe
thinsg well enough with a single line.

So, add support for multi-line descriptions.
The additional lines need to be indented with a tab to be
recognized as such.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/sphinx/cdoc.py (+17/-3)
--------------------------------------------------------------------------------

[1e76c0fb8443] 2018-05-21 03:06:27 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: autodoc: add a small cheatsheet for reST markup

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/doc-guide.rst (+119/-0)
--------------------------------------------------------------------------------

[62973b78d4c7] 2018-05-21 02:49:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: autodoc: by default disable syntax highlighting

Syntax highlighting is great for code but by default sphinx
consider literal sections as code and will thus hightlight
every python keyword ('is', 'and', 'or', ...).
It's quite annoying.

So disable default syntax highlighting, real piece of code
can still be nicely hightlight by using a 'code-block':
	.. code-block:: c

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/conf.py (+2/-0)
--------------------------------------------------------------------------------

[0e98fe2adb2d] 2018-05-21 02:49:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: autodoc: doc the doc

Add some documentation about the autodoc support and the
syntax to use for API documentation embedded into the code.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/doc-guide.rst (+32/-0), Documentation/index.rst (+1/-0)
--------------------------------------------------------------------------------

[76068215ca8a] 2018-05-21 02:49:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: autodoc: add markup to argument's references

The syntax for a parameter is '@<name>'. Let also use this when
referencing a parameter name in another section (other parameters
or long description) and mark these references in bold (the same
as the parameters themseelves are presented).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/sphinx/cdoc.py (+7/-0)
--------------------------------------------------------------------------------

[ab8f48ff06c8] 2018-05-21 02:49:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: autodoc: add doc from ptrlist.c

Use the doc added to ptrlist.c as an example/base for
API documentation.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/api.rst (+11/-0), Documentation/index.rst (+1/-0)
--------------------------------------------------------------------------------

[f647b26c75be] 2018-05-21 02:49:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: autodoc: add a sphinx c:autodoc directive for the extracted doc

Add a sphinx extension for the c:autodoc directive which will
extract the doc and inject it into the document tree.

This part is based on Jani Nikula's project: hawkmoth [1]
which has exactly the same goal as this series but which
use clang to parse the C code and extract the bloc-coments.

[1] https://github.com/jnikula/hawkmoth

Based-on-work-by: Jani Nikula <jani@nikula.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/conf.py (+7/-3), Documentation/sphinx/cdoc.py (+49/-0)
--------------------------------------------------------------------------------

[2d70615dc781] 2018-05-21 02:49:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: autodoc: convert extracted doc to reST

The extracted doc can't be used as is by sphinx as it needs
to have some additional annotations.

Convert the extracted doc into a true reST format wich can
directy be used by sphinx.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/sphinx/cdoc.py (+59/-13)
--------------------------------------------------------------------------------

[f274ee39c222] 2018-05-21 02:49:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: autodoc: extract doc from the C files

Add a tool which parse comment from source files and
extract kerneldoc-like documentation from them.

Note: this is rather quite crude, support only generic 'blocs'
      and doc for functions; it has no support for anything else.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: .gitignore (+1/-0), Documentation/sphinx/cdoc.py (+197/-0)
--------------------------------------------------------------------------------

[e86c869e041c] 2018-05-21 02:49:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add structured doc to ptrlist.c

Convert existing API doc in ptrlist.c to a kerneldoc-like
format and document a few more interfaces.

This is in preparation tu support the extraction of API
documention from the source files.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.c (+79/-18)
--------------------------------------------------------------------------------

[5a2aa843532d] 2018-05-21 02:49:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: api: move evaluate interface to its own header file

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+1/-0), evaluate.c (+1/-0), evaluate.h (+13/-0), expand.c (+1/-0), expression.h (+0/-4), ... and 3 more
--------------------------------------------------------------------------------

[f69126d5d45d] 2018-05-21 02:49:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: use reST for manpages

MarkDown is really nice and easy to get something quickly but
for manpages, the rendering is not really nice and lack index entries.

reST has a special syntax for option lists but:
1) not all option syntax are recognized (for example when we use [xyz] to
  to show that xyz is optionnal).
2) when converted to HTML, a table is used for the list but:
  * options that are too long break the presentation
  * unrecognized options break the table
3) the options are also not put in the index

Solve this by using reST with '.. option::' directives.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/Makefile (+1/-1), Documentation/dev-options.md (+0/-42), Documentation/dev-options.rst (+45/-0)
--------------------------------------------------------------------------------

[d22015775e0b] 2018-05-21 02:49:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: format dev-options.md as a man page

The file dev-options.md contains the description for extra
options not useful for sparse itself and its users but well
to sparse's developers and for tools like test-linearize.

Since it's a complement to the main man-page, format it at such.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/.gitignore (+1/-0), Documentation/Makefile (+4/-0), Documentation/conf.py (+1/-0), Documentation/dev-options.md (+16/-8)
--------------------------------------------------------------------------------

[b048f49bd280] 2018-05-21 02:49:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: the testsuite doc in reST

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/index.rst (+1/-0), Documentation/test-suite (+0/-151), Documentation/test-suite.rst (+169/-0)
--------------------------------------------------------------------------------

[dc9a969bdba0] 2018-05-21 02:45:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: move sparse.txt to markdown and rename it

The file 'sparse.txt' contains some explanation about the
differences between the attributes 'nocast' and 'bitwise'.
It's valuable information.

So convert it to markdown syntax and rename it to a more
self-explanatory name.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/index.rst (+7/-0), Documentation/nocast-vs-bitwise.md (+41/-0), Documentation/sparse.txt (+0/-45)
--------------------------------------------------------------------------------

[6f8d77f78558] 2018-05-21 02:45:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: allow .md with py3-sphinx

The current support for markdown source files is fine
for py2-sphinx but not for py3.

Fix it by checking python's version and add the reference
to the mardown parser module accordingly.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/conf.py (+10/-3)
--------------------------------------------------------------------------------

[1b1d5ed1b17e] 2018-05-21 02:45:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: set primary domain to C

This doesn't change much but allows to be a bit more lazy and
write
	.. <directive>::
	.. code-block::
instead od
	.. c:<directive>::
	.. code-block:: c

I understood that this should also show in the index "... (function)"
instead of "... (C function)" but this doesn't seems to be the case.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/conf.py (+3/-0)
--------------------------------------------------------------------------------

[73851f382fb5] 2018-05-21 02:45:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: automatically get the version

Documentation generated by sphinx reference the version of the
project being documented. This version need to be specified via
sphinx's config file.

However, if this version number is simply added there, it's
guaranteed that soon or later it will be out-of-synch with git's
version tag (or the version number present in the Makefile).

Fix this by trying to read the version from git or, if this fails,
from the Makefile.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/conf.py (+3/-3)
--------------------------------------------------------------------------------

[94ee13c22452] 2018-05-21 02:45:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: automatically set the copyright date

Sphinx allow to set the copyright date; I would hate to have
to update this every year, so let generate it automatically.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/conf.py (+2/-1)
--------------------------------------------------------------------------------

[b1c84ac1855e] 2018-05-21 02:45:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add logo

A logo is always nice fot a project, so add one.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/conf.py (+1/-1), Documentation/logo.svg (+94/-0)
--------------------------------------------------------------------------------

[d1b6faa9b410] 2018-05-21 02:45:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add minimal support for sphinx-doc

With this we can generate HTML for the docs in this directory.
For the moment, more as an experiment as anything else, this
doc is available at http://sparse-doc.rtfd.io

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/.gitignore (+1/-0), Documentation/Makefile (+22/-0), Documentation/conf.py (+159/-0), Documentation/index.rst (+28/-0)
--------------------------------------------------------------------------------

[e64084b052c2] 2018-05-21 02:45:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: fix headings

To have proper entris in the index pages, we need to use headings
consistently.

Fix the few headings that used some headings non-consistent with
the others.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/project-ideas.md (+2/-3)
--------------------------------------------------------------------------------

[5d8c8de3262c] 2018-05-21 02:45:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: fix markdown syntax

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/dev-options.md (+11/-11)
--------------------------------------------------------------------------------

[425722d8f548] 2018-05-19 16:08:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: increment the version number suffix it with -dev

So we can't confuse it with the official version.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[14eae5d919db] 2018-05-19 16:07:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'next' into official

Synch with the official tree so that it can easily be
back merged with it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: .gitignore (+1/-2), Documentation/IR.md (+356/-0), Documentation/dev-options.md (+34/-0), Documentation/test-suite (+27/-12), Makefile (+171/-163), ... and 265 more
--------------------------------------------------------------------------------

[a6e061897f4b] 2018-05-06 16:38:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'unop', 'describe-dirty', 'range-syntax', 'old-testcases', 'fix-redef-typedef' and 'fixes' into tip

[Auto-summary] Modifies 9 source files: allocate.c, evaluate.c, graph.c and 6 more. Updates 2 headers. Adds/updates 10 test(s). Modifies build system. Changes: +225/-27 in 22 file(s)

Files: Makefile (+1/-1), allocate.c (+2/-0), evaluate.c (+1/-1), graph.c (+6/-4), linearize.c (+1/-1), ... and 17 more
--------------------------------------------------------------------------------

[1f5c32f43fb1] 2018-05-06 16:38:35 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use function-like syntax for __range__

One of sparse's extension to the C language is an operator
to check ranges. This operator takes 3 operands: the expression
to be checked and the bounds.

The syntax for this operator is such that the operands need to
be a 3-items comma separated expression. This is a bit weird
and doesn't play along very well with macros, for example.

Change the syntax to a 3-arguments function-like operator.

NB. Of course, this will break all existing uses of this
    extension not using parenthesis around the comma
    expression but there doesn't seems to be any.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+4/-1), validation/linear/range-op.c (+31/-0), validation/range-syntax.c (+23/-0)
--------------------------------------------------------------------------------

[31059faedd34] 2018-05-06 16:04:59 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: OP_SYMADDR is simply an unop

Currently OP_SYMADDR are defined the same as OP_SETVAL.
However, OP_SYMADDRs don't need the field 'struct expression *val'
and OP_SETVALs don't need the field 'pseudo_t symbol' which
suggest that those two should be splitted. In fact, OP_SYMADDR,
having just one pseudo as operand and producing one pseudo, is
simply an unary op like OP_NOT, OP_NEG, ...

Change this by letting OP_SYMADDRs use the field 'src' as
the others unops do.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+3/-1)
--------------------------------------------------------------------------------

[7e5769854281] 2018-05-06 01:37:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: remove usage when killing symaddr (part 2)

When killing OP_SYMADDRs, their usage must be removed. Otherwise
fake users remain and this may inhibit some memop conversions.

However, in simplify_instruction() when dead_insn() is called
on OP_SYMADDR the symbol's usage is ignored.

Fix this by adding the missing &insn->symbol to this dead_insn().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+1/-1)
--------------------------------------------------------------------------------

[92365a897554] 2018-05-06 01:37:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: remove usage when killing symaddr (part 1)

When killing OP_SYMADDRs, their usage must be removed. Otherwise
fake users remain and this may inhibit some memop conversions.

Fix this by adding the missing kill_use().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+1/-0)
--------------------------------------------------------------------------------

[053ffd645b98] 2018-05-06 01:37:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix comment about PSEUDO_SYM usage

The comment stated that PSEUDO_SYMs have no usage.

However, PSEUDO_SYMs *have* usage that need to be tracked correctly
(has_use_list() determines what kind of pseudo have or have not
usage/use list).

Fix the comment.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[0f04287d49a9] 2018-05-06 01:37:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix missing checks for deleted instructions

Instructions with a null ->bb are instructions which have
been killed. As such, they must thus always be ignored.

Fix this by adding the missing checks for null ->bb when
looping over all the instructions of a basic block.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: graph.c (+2/-0), sparse.c (+2/-0)
--------------------------------------------------------------------------------

[26688ccf9a4d] 2018-05-06 01:37:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: don't dump pointer value in error message

In evaluate_symbol_type(), an error message is issued
if a SYM_UNINITIALIZED symbol is reached. Good.

However, the error message display the address of the
incriminated symbol which isn't much useful for finding
the origin of the problem.

Fix this by displaying the symbol's typename instead.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+1/-1)
--------------------------------------------------------------------------------

[10d66edae8db] 2018-05-06 01:37:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: alloc: check if size is too big

The allocate functions can take an extra size in arguments
used to allocate some variable extta space at the end of the
allocated structure. In the common case this extra size is zero
and if not it should be relatively small. In all cases the total
size must be smaller than the 'chunking factor' (the size of the
block ued t do these allocations).

However, this total size is not tested and all kinds of interesting
failures can be produced if it is too big.

Fix this by adding a test and die in case of failure.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: allocate.c (+2/-0)
--------------------------------------------------------------------------------

[eb604d160387] 2018-05-06 01:37:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add test case bug expand union

constant_symbol_value() needs several conditions before returning
a valid value.

However not all conditions are always met. One such case occurs when
an union is involved and the value we look after is of a different
type than the initializer.

Add two test cases showing (some of) the problems.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/bug-expand-union0.c (+21/-0), validation/bug-expand-union1.c (+20/-0)
--------------------------------------------------------------------------------

[ebb3a91b0b11] 2018-05-05 18:30:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'no-path-max', 'vcompound' and 'build-x32' into tip

[Auto-summary] Modifies 4 source files: lib.c, parse.c, sparse.c and 1 more. Updates 2 headers. Adds/updates 3 test(s). Updates documentation. Modifies build system. Changes: +240/-17 in 12 file(s)

Files: Documentation/test-suite (+8/-0), Makefile (+6/-2), cgcc (+2/-9), lib.c (+23/-6), lib.h (+1/-0), ... and 7 more
--------------------------------------------------------------------------------

[4e9c8ee467dd] 2018-05-04 20:47:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse about _Floatn and _Floatnx

It seems that some system headers (Debian x32's glibc) use
these types based on GCC's version without checking one of
the '__STDC_IEC_60559_<something>' macro. This, of course,
creates warnings and errors when using sparse on them.

Avoid these errors & warnings by letting sparse know about
these types.

Note: Full support would require changes in the parsing to
      recognize the suffixes for constants ([fF]32, ...),
      the conversion rules between these types and the
      standard ones and probably and most others things,
      all outside the scope of this patch.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Ramsay Jones <ramsay@ramsayjones.plus.com>

Files: parse.c (+5/-0), symbol.c (+14/-0), symbol.h (+3/-0)
--------------------------------------------------------------------------------

[80ba2676e9ff] 2018-05-04 18:55:44 +0200
Author: Randy Dunlap <rdunlap@infradead.org>
Subject: sparse: option to print compound global data symbol info

with help from Linus (many moons ago) and Luc this year.

sparse addition to print all compound/composite global data symbols
with their sizes and alignment.

usage: -vcompound
Example:
  $ sparse -vcompound symbol-sizes.c
  compound-sizes.c:39:17: union un static [toplevel] un: compound size 192, alignment 8
  compound-sizes.c:42:25: struct inventory static [toplevel] inven[100]: compound size 19200, alignment 8
  compound-sizes.c:51:33: struct inventory static [toplevel] [usertype] invent[10]: compound size 1920, alignment 8
  compound-sizes.c:58:25: float static [toplevel] floats[42]: compound size 168, alignment 4
  compound-sizes.c:59:25: double static [toplevel] doubles[84]: compound size 672, alignment 8

and validation:
$ ./test-suite   single compound-sizes.c
     TEST    compound-sizes (compound-sizes.c)
compound-sizes.c passed !

Signed-off-by: Randy Dunlap <rdunlap@infradead.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+2/-0), lib.h (+1/-0), sparse.c (+33/-0), validation/compound-sizes.c (+88/-0)
--------------------------------------------------------------------------------

[13b85df87ae1] 2018-05-04 18:55:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add check-assert

Ideally, the testcases should be universal but it happen than
some of them need to test some specificities or are meaningless
or plainly wrong in some situations. In such cases, these tests
must but ignored.

Currently, the only the only mechanisms a test are:
1) ignoring the tests depending on a tool which cannot be compiled
   (like, for example, those using sparse-llvm when LLVM is not
   installed.
2) some rather corse criteria using the name of the arch used
   to run the tests.

Allow more flexibility by allowing to exclude some tests based on
the success or failure of an arbitrary condition via _Static_assert().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/test-suite (+4/-0), validation/test-suite (+12/-0)
--------------------------------------------------------------------------------

[783893003488] 2018-05-04 18:55:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add check-cp-if

Ideally, the testcases should be universal but it happen than
some of them need to test some specificities or are meaningless
or plainly wrong in some situations. In such cases, these tests
must but ignored.

Currently, the only the only mechanisms a test are:
1) ignoring the tests depending on a tool which cannot be compiled
   (like, for example, those using sparse-llvm when LLVM is not
   installed.
2) some rather corse criteria using the name of the arch used
   to run the tests.

Allow more flexibility by allowing to exclude some tests based on
the evaluation of some pre-processor expression at test-time.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/test-suite (+4/-0), validation/test-suite (+14/-0)
--------------------------------------------------------------------------------

[02a5a7597ea1] 2018-05-04 18:44:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix build on Hurd which doesn't define PATH_MAX

Hurd doesn't define PATH_MAX but is needed by pre-process.c

Allow sparse to build on Hurd by giving it a default value
of 4096.

Note: this solution is not ideal because *if* the path is
      longer than PATH_MAX (and this *can* also happen on
      non-hurd machine) then we have a nice buffer flow
      which will corrupt the stack.
      A better solution will come later.

Reported-by: Uwe Kleine-Knig <uwe@kleine-koenig.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+4/-0)
--------------------------------------------------------------------------------

[4b73dbaec105] 2018-05-01 17:18:22 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: use --dirty with 'git describe'

This can help the developer to realize there was some
uncommited changes in the tree while testing.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[8ddbf2e81579] 2018-05-01 17:11:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: let cgcc use sparse's predefines for i386 & x86-64

Currently, cgcc contains the logic to add predefined symbols
like __INT_MAX or __SIZEOF_POINTER, but:
1) this logic is now completly present in sparse itself
2) cgcc hasn't the logic needed for x86-64-x32 which sparse now has.

So, drop these defines in cgcc and let cgcc simply use the ones
predefined by sparse itself.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Ramsay Jones <ramsay@ramsayjones.plus.com>

Files: cgcc (+2/-9)
--------------------------------------------------------------------------------

[234a9d0cb7d0] 2018-05-01 17:11:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: disable LLVM on x86-64-x32

as currently, some LLVM tests fail on this environment
(llvm doesn't seems to be correct on debian x32, for
example the host triple is set as "x86_64-pc-linux-gnu"
while something like "x86_64-linux-gnux32" is expected
in order to make the difference between the two).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Ramsay Jones <ramsay@ramsayjones.plus.com>

Files: Makefile (+3/-0)
--------------------------------------------------------------------------------

[7a1f08b8338c] 2018-05-01 17:11:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: use 'filter' to do pattern matching inside the Makefile

This is slightly less cumbersome and more direct than using grep.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Ramsay Jones <ramsay@ramsayjones.plus.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[990cd371925f] 2018-05-01 17:11:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: use a variable for $(shell uname -m)

This avoids a second call to uname later but first at all
it's a preparation for more checks done on the arch.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Ramsay Jones <ramsay@ramsayjones.plus.com>

Files: Makefile (+3/-2)
--------------------------------------------------------------------------------

[ee33a893f051] 2018-05-01 17:11:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use also __x86_64 when __x86_64__ is used

Since both __x86_64__ and __x86_64 are valid use both of them to
detect the x86-64 arch and define them both when built on x86-64.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Ramsay Jones <ramsay@ramsayjones.plus.com>

Files: lib.c (+3/-2)
--------------------------------------------------------------------------------

[2b2944497885] 2018-05-01 17:02:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: do not to ignore old preprocessor testcases

validation/{phase2/backslash,phase3/comments} are two ancient
testcases that predate ./test-suite and they are ignored by
the testsuite because they do not have a '.c' extension.

Change this by:
- renaming them with a '.c' extension
- moving them to validation/preprocessor/
- adding the testsuite tags & results to them
- remove comments about their previous status

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/{phase2/backslash => preprocessor/phase2-backslash.c} (+17/-12), validation/{phase3/comments => preprocessor/phase3-comments.c} (+10/-2)
--------------------------------------------------------------------------------

[5c9b0ffbced5] 2018-05-01 16:29:22 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: warn on typedef redefinition

check_duplicates() verifies that symbols are not redefined and
warns if they are.

However, this function is only called at evaluation-time and
then only for symbols corresponding to objects and functions.
So, typedefs can be redefined without any kind of diagnostic.

Fix this by calling check_duplicates() at parsing time on typedefs.

Note: this is C11's semantic or GCC's C89/C99 in non-pedantic mode.

Reported-by: Matthew Wilcox <willy@infradead.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+4/-0), validation/typedef-redef.c (+0/-1)
--------------------------------------------------------------------------------

[79d8848e79f0] 2018-05-01 16:29:22 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: export check_duplicates()

check_duplicates() is local to evaluate.c and only called via
evaluate_symbol_list().

However, typedefs need exactly the same check logic.

So, make check_duplicates() extern so that it can also be used
directly in other files.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-1), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[5ae9f08e7ae1] 2018-05-01 16:29:22 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for typedef redefinition

Currently, sparse doesn't issue a diagnostic when a typedef
is redefined.

Add some testcases for this.

Reported-by: Matthew Wilcox <willy@infradead.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/typedef-redef-c89.c (+13/-0), validation/typedef-redef.c (+14/-0)
--------------------------------------------------------------------------------

[8d5d4cef846d] 2018-05-01 16:29:22 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for array size type difference

Currently, type_difference() ignore array sizes.

Add some testcases for this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/typediff-arraysize.c (+12/-0)
--------------------------------------------------------------------------------

[d06d4f79458d] 2018-05-01 16:29:22 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for enum / int type difference

Currently, type_difference() doesn't make a distinction between
enums & ints.

Add some testcases for this and mark the test as 'known-to-fail'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/typediff-enum.c (+34/-0)
--------------------------------------------------------------------------------

[e517edeb7cac] 2018-05-01 14:09:21 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add a flag -mx32 ILP32 env on 64 bit archs

Currently, we have the -m32 & -m64 flags to force sparse to
behave as a 32 or 64 bit arch, independently of the arch used
to build sparse. Good.

However, on x86-64, '-m32' is there to force the 32 bit instructions
& ABI but there is another flag '-mx32' for the x32 ABI which use the
x86-64 instructions / 64 bit registers but where the pointers and
long ints are 32 bit.

Add the same flag, '-mx32', to support this ABI with the proper size
alignment for pointers and longs and to predefine __ILP32__ as it is
done by 'GCC -mx32'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Ramsay Jones <ramsay@ramsayjones.plus.com>

Files: lib.c (+12/-0)
--------------------------------------------------------------------------------

[08482b36803b] 2018-05-01 13:55:35 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use an enum for ARCH_LP32 & friends

This will just to use the automatic numbering of enums
which slightly simplify patches adding new entries.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Ramsay Jones <ramsay@ramsayjones.plus.com>

Files: lib.c (+5/-3)
--------------------------------------------------------------------------------

[5f8653250bdc] 2018-04-30 17:43:06 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for verifying ABI's integer size & align

It's easy to make some errors or some wrong assumptions
about size and alignment of basic types, certainly so when
taking in account the -m32, -m64 & -msize-llp64 flags and
the default behaviour on different arch & environments.

Try to catch these errors by adding a testcase for the
size & alignment of int, long, long long & void*.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/abi-integer.c (+31/-0)
--------------------------------------------------------------------------------

[b06354707e33] 2018-04-30 17:43:06 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix alignment of 64 bit integers on LLP64

On LLP64 platforms, ointers & long long are 8 bytes width
*and* also aligned to 8 bytes.

However, the alignment was set to only 4 bytes.

Fix this by setting max_in_alignment to 8 for LLP64 too.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-1)
--------------------------------------------------------------------------------

[df8a5fa4dc6b] 2018-04-30 17:43:06 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: default to LP64 for all and only for 64 bit ABIs

Currently sparse assumes LP64 only for x86-64.

This requires to always use the flag '-m64' for the other
64 bit archs like arm64 or ppc64.
There is also another problem on machines using the x32 ABI on
x86_64, which is, of course, not LP64.

So, change this by using LP64 by default if __LP64__ is defined
on the build machine. This will solve the current problem with
x32 but will also give the correct default on all 64 bit archs.

Reported-by: Uwe Kleine-Knig <uwe@kleine-koenig.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-1)
--------------------------------------------------------------------------------

[551b85c8a241] 2018-04-11 20:43:37 +0200
Author: Joey Pabalinas <joeypabalinas@gmail.com>
Subject: sparse: add -Wpointer-arith flag to toggle sizeof(void) warnings

Recent changes to the min()/max() macros in include/linux/kernel.h
have added a lot of noise when compiling the kernel with Sparse checking
enabled. This mostly is due to the *huge* increase in the number of
sizeof(void) warnings, a larger number of which can safely be ignored.

Add the -Wpointer-arith flag to enable/disable these warnings (along
with the warning when applying sizeof to function types as well as
warning about pointer arithmetic on these types exactly like the
GCC -Wpointer-arith flag) on demand; the warning itself has been disabled
by default to reduce the large influx of noise which was inadvertently
added by commit 3c8ba0d61d04ced9f8 (kernel.h: Retain constant expression
output for max()/min()).

Update the manpage to document the new flag and add a validation case
for sizeof(void).

CC: Kees Cook <keescook@chromium.org>
CC: Linus Torvalds <torvalds@linux-foundation.org>
CC: Martin Uecker <Martin.Uecker@med.uni-goettingen.de>
CC: Al Viro <viro@ZenIV.linux.org.uk>
CC: Christopher Li <sparse@chrisli.org>
CC: Joey Pabalinas <joeypabalinas@gmail.com>
CC: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Joey Pabalinas <joeypabalinas@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+4/-2), lib.c (+2/-0), lib.h (+1/-0), sparse.1 (+13/-0), validation/sizeof-void.c (+44/-0)
--------------------------------------------------------------------------------

[8d1fb16c9e5f] 2018-04-11 20:43:37 +0200
Author: Joey Pabalinas <joeypabalinas@gmail.com>
Subject: doc: copy-edit text related to applying sizeof to a _Bool

Clean up the grammar/capitalization of the -Wsizeof-bool sections and
italicize the size (1) so that it is consistent with the surrounding
text.

CC: Al Viro <viro@ZenIV.linux.org.uk>
CC: Christopher Li <sparse@chrisli.org>
CC: Joey Pabalinas <joeypabalinas@gmail.com>
CC: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Joey Pabalinas <joeypabalinas@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-1), sparse.1 (+1/-1), validation/sizeof-bool.c (+1/-1)
--------------------------------------------------------------------------------

[84c592a8186e] 2018-04-11 20:43:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use -Wpointer-arith for tests

In preparation to the upcoming introduction of -Wpointer-arith
uses -Wpointer-arith for tests that will need it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/sizeof-function.c (+1/-1)
--------------------------------------------------------------------------------

[34c827db37e9] 2018-04-04 07:41:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: graph: do not use insn->symbol for memops

In struct instruction, OP_LOAD & OP_STORE are defined like unops
and so the pseudo holding the address should be 'insn->src'.
OTOH, 'insn->symbol' is supposed to be used only for OP_SYMADDR.

However, in graph.c, the field 'symbol' is used for OP_LOAD/STORE's
address. Now, this doesn't matter much as the field 'src' & 'symbol'
are aliased/unioned (together with 'src1', 'cond', ...) but it
can be confusing.

Change this by using the field 'src' for memops here too.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: graph.c (+4/-4)
--------------------------------------------------------------------------------

[4e67727cdc12] 2018-04-04 07:38:04 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix missing handling of OP_FNEG

When introducing OP_FNEG a few cases have been missed
and so OP_FNEG are not always handled when needed.

Fix this by adding the missing 'case OP_FNEG:'

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: liveness.c (+1/-1), simplify.c (+2/-1)
--------------------------------------------------------------------------------

[979043ca8aae] 2018-03-24 20:16:03 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Sparse v0.5.2

Here is version 0.5.2. No changes were needed since -rc1.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[73d0b20055c8] 2018-03-19 20:34:29 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: document the debug flags

The flags -ventry & -vdead were not documented.
Fix this now by adding a small explanation.

Reviewed-by: Randy Dunlap <rdunlap@infradead.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/dev-options.md (+6/-0)
--------------------------------------------------------------------------------

[c44f8d00d046] 2018-03-19 20:34:23 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: options.md is for development

The purpose of the file 'options.md' was rather vague.
Make it now explicit that it's to document options
useful for development.

Reviewed-by: Randy Dunlap <rdunlap@infradead.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/{options.md => dev-options.md} (+3/-4)
--------------------------------------------------------------------------------

[334bae855c8e] 2018-03-18 19:02:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: avoid deadborn loads & stores

During linearization, most kinds of instruction are not generated
if there is no active BB (which mean that these instructions can
never be executed).

However, loads & stores are generated anyway. These dead loads
and stores will then need to be removed which is a bit tricky:
- memops are special and more complex to be removed than
  instructions like 'add' and such.
- these instructions exist in 'phantom basic blocks': a BB
  which has ia null bb->ep and which doesn't belong to then
  entrypoint's ep->bbs. Such blocks are considered as removed
  and are never scanned or anything.

Keep things simple and avoid to generate memops in inactive
basic blocks.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+11/-1)
--------------------------------------------------------------------------------

[1609176c9dbd] 2018-03-18 19:02:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix-return: remove special case for single return

During the linearization of a function, returns are directly
linearized as phi-sources and the exit BB contains the
corresponding phi-node and the unique OP_RET.

There is also a kind of optimization that is done if there is
only a single a return statement and thus a single phi-source:
the phi-source and the phi-node is simply ignored and the
unique value is directly used by the OP_RET instruction.

While this optimization make sense it also has some cons:
- the phi-node and the phi-source are created anyway and will
  need to be removed during cleanup.
- the corresponding optimization need to be done anyway during
  simplification
- it's only a tiny special case which save very litte.

So, keep things simple and generic and leave this sort of
simplification for the cleanup/simplification phase.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+0/-6), validation/linear/degen-function.c (+3/-3), validation/{linear => optim}/inline-return.c (+2/-2)
--------------------------------------------------------------------------------

[a9a56d3994df] 2018-03-18 19:02:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: defer initialization of bb::context

Currently bb::context is intialized (at -1) when the
basic block is allocated.

But this field:
1) is only used when using the sparse tools;
2) when used, it's only quite late in the process;
3) this early initialization prevents us to reuse the space
   of this field for another purpose, earlier in the process.

Change this by initializing this field much later, by the sparse tool
itself, just before needing it.

The real motivation being, of course, to be able to reuse the space
for some other upcoming field.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+0/-1), sparse.c (+1/-0)
--------------------------------------------------------------------------------

[7cd8dc416813] 2018-03-18 19:02:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: alloc: add missing #include "compat.h"

"allocate.h" need to include "compat.h" for the definition of
CHUNK but this header file is only include indirectly, via
other files including "allocate.h".

Fix this by adding "compat.h" in allocate.h

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: allocate.h (+2/-0)
--------------------------------------------------------------------------------

[aa35b472057e] 2018-03-18 19:02:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: small code reorg of add_store()

No functional changes here. Just prepare for upcoming changes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+9/-8)
--------------------------------------------------------------------------------

[16af95f8e0b2] 2018-03-18 19:02:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: extract alloc_phisrc() from alloc_phi()

This give us:
- a clearer name (than alloc_phi())
- more flexibility when we need the instruction and not the pseudo.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+16/-10), linearize.h (+2/-0)
--------------------------------------------------------------------------------

[17e21c075a66] 2018-03-18 19:02:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: show_label: add (and use) show_label()

Add an helper to display labels.
This allow us to:
*) abstract away the details of how to display them
*) gracefully handle abnormal cases of a null label.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+25/-16), linearize.h (+1/-0), test-unssa.c (+1/-1)
--------------------------------------------------------------------------------

[31c169d3590d] 2018-03-18 19:01:01 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add remove_use()

Add an helper to remove the usage of a pseudo like kill_use() do
but without trying to kill (recursively!) the defining instruction
if the usage drop to zero.

This function is meant to be used when it is not yet safe to
kill instructions. If the usage drop to zero, nothing special is
done, the instruction becomes dead and will be eliminated later.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.h (+1/-0), simplify.c (+8/-0)
--------------------------------------------------------------------------------

[1af36e611de4] 2018-03-18 19:00:26 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: make remove_usage() more generic

make_usage() kill the corresponding instruction when the last
user have been removed. This is often desired but not always.

Make a new version __remove_usage() taking a flag telling if
we want to kill the instruction or not.

Correct-naming-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+8/-3)
--------------------------------------------------------------------------------

[5953ebb1f871] 2018-03-17 18:21:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: optim: simplify null select

A select instruction like:
	select	r <- x, 0, x
always gives zero as result but the optimizer doesn't this.

Change this by teaching the optimizer about it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+6/-0), validation/optim/select-zero.c (+16/-0)
--------------------------------------------------------------------------------

[4a036fd55cb4] 2018-03-17 18:21:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add an helper to test the value of a pseudo against zero

Testing the value of a pseudo against zero is relatively
common but it needs to test the type of the pseudo before
testing the value itself.

Add 2 small helpers for this: is_zero() & is_nonzero().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+11/-0)
--------------------------------------------------------------------------------

[0e49c8b5a06e] 2018-03-14 23:19:54 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: optim: fix REPEAT_CFG_CLEANUP

The REPEAT_... flags are used as bitfield but the last one
introduced (by myself): REPEAT_CFG_CLEANUP was wrongly defined
to the next value instead of the next bit.

Fix this by defining it to the right value.
Also change all the definition to use '1 << ...' to clearly
show we expect uniq bit values here.

Fixes: 917d37ad7681c88fc4d8df484f7b10d550190df8
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.h (+3/-3)
--------------------------------------------------------------------------------

[fee392ffe3d6] 2018-03-14 23:19:54 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: optim: load simplification should repeat optimization

convert_load_instrcution() & rewrite_load_instruction() remove
a load instruction and as such should retrigger optimization of
symbols.

Do this by setting REPEAT_SYMBOL_CLEANUP at the end of these
two functions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+5/-1)
--------------------------------------------------------------------------------

[5744e177de56] 2018-03-14 23:19:54 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: optim: pack bb must set REPEAT_CFG

Basic block packing should trigger CFG cleanup, not a rerun
of CSE.

Fix this by setting REPEAT_CFG_CLEANUP pack_basic_blocks()
instead of REPEAT_CSE.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+1/-1)
--------------------------------------------------------------------------------

[826561b4a673] 2018-03-14 23:19:54 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: optim: fix optimization loop's condition

The main inner & outer optimization loop must not only
rerun if some CSE changes occured but must do so if any
change occur.

Insure this by testing any of the REPEAT_... flags as loop condition.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: optimize.c (+2/-2)
--------------------------------------------------------------------------------

[4c1a1cad6180] 2018-03-14 23:19:54 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: optim: no need to kill_unreachable_bbs() after main loop

Now that unreachable BBs are removed after BB packing it's
not needed to try to removed them again after the main loop.

Remove the unneeded call to kill_unreachable_bbs() after the
main optimization loop.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: optimize.c (+0/-1)
--------------------------------------------------------------------------------

[dc0297e9166f] 2018-03-14 23:19:54 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: optim: kill unreachable BBS after CFG simplification

Normal instruction simplification & CSE must not be done
on dead block (otherwise it's possible to have unsound
situations like having an instruction defining its own
operand with possible infinite loops as consequence).
This is insured by the main optimization loop but not after
BB packing or flow simplification.

Fix this by calling kill_unreachabe_bbs() after BB packing
and flow simplification.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: optimize.c (+4/-0), validation/optim/dup-cond0.c (+0/-1), validation/optim/phi-ret.c (+0/-1)
--------------------------------------------------------------------------------

[b3875dcaf628] 2018-03-14 23:19:54 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: optim: add timeout for infinite optim loop tests

Insure that the tests for infinite optimization loops
never goes infinitively by adding a timeout to them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/infinite-loop02.c (+1/-0), validation/infinite-loop03.c (+1/-0)
--------------------------------------------------------------------------------

[8ef30d755e21] 2018-03-14 23:19:41 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: optim: add testcase for internal infinite loop

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/infinite-loop04.c (+18/-0)
--------------------------------------------------------------------------------

[88fbab0c7465] 2018-03-14 16:57:00 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: optim: add some more optimization tests

Add some tests showing missed optimization opportunities.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/dup-cond0.c (+20/-0), validation/optim/phi-ret.c (+22/-0)
--------------------------------------------------------------------------------

[9b69a4bfa543] 2018-03-14 16:29:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cleanup deadborn phi-sources

In simplify_loads(), phisrcs are created in find_dominating_parents()
and are then supposed to be used in rewrite_load_instruction().

However, it may happen (quite often) that find_dominating_parents()
find a dominator for one of the branch, create a phi-source for it,
record it's usage and then doesn't find a dominator in one of other
parent branches. In this case, the function returns early and the
created phisrcs are simply ignored. These phisrcs can't be simplified
away as dead instructions because they still have their usage recorded.

Fix this by explicitly remove these ignored phisrcs.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: memops.c (+5/-0), validation/mem2reg/dead-phisrc.c (+17/-0)
--------------------------------------------------------------------------------

[d2ca9a9ceb2c] 2018-03-11 13:59:32 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix symbol cleanup

REPEAT_SYMBOL_CLEANUP is set when there is changes to the
addressability of a symbol, typically when a OP_SYMADDR is removed.

However, currently most OP_SYMADDRs are 'simplified'/folded into
their use. For example:
	symaddr.64	%r1 <- var
	add.64		%r2 <- %r1, $4
is simplified into:
	add.64		%r2 <- var, $4

One of the bad consequences of this 'simplification' is that
if the 'add' instruction is later optimized away, this correspond
to an effective change to the addressability of the symbol. This
is exactly as if the 'symaddr' has been removed before being so
'simplified', but because the symaddr is not there anymore
there is no change recorded to the addressability to the symbol
and some further optimizations may be missed.

Change that by checking at each time the usage is removed from an
instruction if the corresponding pseudo was a symbol and set
REPEAT_SYMBOL_CLEANUP if it was the case.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-0), validation/optim/address-used01.c (+0/-1)
--------------------------------------------------------------------------------

[b24289d4b62a] 2018-03-11 13:59:08 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix address_taken()

The function address_taken() check that the address of a variable
is not used for anything else than for doing a memory access.
If the function fails, it means that the address can escape and
thus can be used to modify the variable indirectly and the
memop simplification would then be unsafe.

The function do this check by assuming that any uses by an instruction
other than a load or a store can escape the address, which is true.
However it doesn't take in account that if the variable's address is
used, not as the address of a store, but as the value stored, then
this address also escape.

Fix this by adding a check that the use of the variable's address
is effectively done as the address of stores & loads and not as
the value stored by the memop.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: memops.c (+2/-0), validation/mem2reg/address-used00.c (+0/-1), validation/optim/address-used01.c (+19/-0)
--------------------------------------------------------------------------------

[2ae43367d11e] 2018-03-11 13:58:17 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: taint: let check_access() warn just once

The function check_access() verify that memory accesses are not
done out of their bounds. This is good.

However, this function is called at each run of simplify_loads()
which means that the same warning can be given multiple times
which is annoying.

Fix this by using the newly added 'tainted' field to not warn
a second time on this instruction.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+5/-1), validation/check_access-multi.c (+15/-0)
--------------------------------------------------------------------------------

[0c7a7f9634ab] 2018-03-11 03:08:22 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add a field 'tainted' to struct instruction

During the processing, some verification are done and if the
check fails, a warning is normally issued. But some checks are
done at several steps and so the same warning can be give
several time, which is annoying.

Add to instructions a field '.tainted' which will allow to
mark instructions which fail some checks and have already
warned about.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+2/-1)
--------------------------------------------------------------------------------

[6e42c573ee70] 2018-03-11 03:08:22 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: fix problem with double-escaping in patterns

Since the patterns in the testcases are evaluated in the shell
script, the backslash used to escape characters special to the
pattern need itself to be escaped. Theer is a few cases where
it wasn't done so, partly because 'format -l' gave a single
escape in its template.

Fix all occurences neededing this double-escape as well as the
'format -l' template.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/c11-alignas.c (+1/-1), validation/c11-alignof.c (+1/-1), validation/linear/bitfield-expand-deref.c (+2/-2), validation/linear/call-builtin.c (+1/-1), validation/linear/call-casted-pointer.c (+2/-2), ... and 14 more
--------------------------------------------------------------------------------

[7f9145f334c9] 2018-03-11 03:07:26 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix typo for constant addresses

Non-null pointers were discarded and a NULL pointer was used instead.

Fix this by adding the missing 'else'.

Fixes: 18434703507423b58ecefe941438755525ec834a
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+2/-1)
--------------------------------------------------------------------------------

[d1c2f8d3d420] 2018-03-03 16:42:32 -0800
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bump up version to 0.5.2-RC1

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[d909cdf88a3f] 2018-03-03 03:33:03 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: normalize sparse-llvm-dis' output

Depending on some combination of host architecture/LLVM's version/...
the output of llvm-dis may or may not contains the target layout.
Worse it may also contains the target triple that was used to
compile sparse-llvm.

This is a problem for sparse-llvm-dis (which unique purpose is to test
the generated LLVM bytecode) given that the test-system doesn't offer
much flexibility: it only known about line patterns or the whole output
without having the possibility to ignore some lines.

Fix this by filtering out lines begining by 'target ' in the output of
sparse-llvm-dis.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm-dis (+1/-1)
--------------------------------------------------------------------------------

[12e122908c38] 2018-03-02 19:12:39 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: By default disable the warning flag '-Wunknown-attribute'

Generally, we're not interested by those warnings, but we
can always explicitly ask for them if needed.

So make the flag '-Wunknown-attribute' off by default.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-1), validation/Wunknown-attribute-def.c (+0/-4)
--------------------------------------------------------------------------------

[1cd5d64b714e] 2018-03-02 19:12:32 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Revert "Give the constant pseudo value a size"

This reverts commit 9fff86b30747be0a081632269f5aaf6e17bed4a9,
             commit 5e733ee233920149b88698185032b7799b731548,
and          commit 16d44cca4a36a76af8ce548442b6d541fade5e68.
because the corresponding series creates several regressions,
its effects are not well understood and it's not well tested.

The series can come back once these three points are addressed.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+1/-1), linearize.c (+10/-13), linearize.h (+2/-4), memops.c (+1/-1), simplify.c (+10/-10), ... and 1 more
--------------------------------------------------------------------------------

[e207d0df64d8] 2018-03-01 09:07:45 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: IR: let OP_COMPUTEGOTO use .src instead of .target

In struct instruction, .target is normally used to hold
the result. Its value is thus produced/defined by instructions.

However, OP_COMPUTEDGOTO use .target as an input. This
creates slight complications for code, like liveness analysis,
which care about which fields are used and which are defined
by the instructions.

Change this by letting OP_COMPUTEDGOTO use .src for its
operand instead of .target.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.md (+1/-1), linearize.c (+2/-2), liveness.c (+1/-4)
--------------------------------------------------------------------------------

[39c697538115] 2018-03-01 09:07:45 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: IR: let .cond unionize with .src and not .target

In struct instruction, .target is normally used to hold
the result. Its value is thus produced/defined by instructions.
On the contrary, .cond is used as an input value and is
thus used by instructions.

However, these two fields belong to the same union. This
creates slight complications for code, like liveness analysis
which care about which fields are used and which are defined
by the instructions.

Change this by unionizing .cond with .src, .src1 & friends instead
of with .target.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.md (+1/-1), linearize.h (+3/-4), sparse-llvm.c (+1/-1)
--------------------------------------------------------------------------------

[5e7e4bdd97fc] 2018-03-01 09:07:45 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: IR: remove never-generated instructions

Some of the IR instructions have been defined but are
never generated.

Remove them as they have no purposes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.md (+0/-10), example.c (+0/-8), linearize.c (+0/-8), linearize.h (+1/-9), liveness.c (+0/-8)
--------------------------------------------------------------------------------

[29f889c3980d] 2018-03-01 09:07:45 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: IR: remove now unused OP_LNOP & OP_SNOP

No instructions have an opcode set to OP_[LS]NOP anymore
so we can now remove all remaining traces of these opcode.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.md (+0/-6), example.c (+0/-2), flow.c (+1/-3), linearize.c (+2/-4), linearize.h (+0/-2), ... and 2 more
--------------------------------------------------------------------------------

[e72a4b5c11ad] 2018-03-01 09:07:45 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: IR: fix typo in IR doc

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.md (+1/-1)
--------------------------------------------------------------------------------

[caf577bb0eda] 2018-02-27 12:30:27 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add testcase about CSE problem

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/cse-size.c (+18/-0)
--------------------------------------------------------------------------------

[ec8a5d1cd7d1] 2018-02-27 12:30:27 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add testcase for some random crash

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/bug-crash16.c (+11/-0)
--------------------------------------------------------------------------------

[9fff86b30747] 2018-02-27 02:00:51 -0800
Author: Christopher Li <sparse@chrisli.org>
Subject: Fix crash cause by previous pseudo size change

Luc report a crash in test-lineariz.
Originally the size is store in same memory location
as "pseudo.ident". The assumption that no one use ident
for PSEUDO_VAL is not true. This change moves the size
out side of the union of ident.

Reported-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: linearize.h (+3/-5)
--------------------------------------------------------------------------------

[b1bf9d64cc75] 2018-02-24 10:49:15 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unneeded cast in calls to free_ptr_list()

free_ptr_list() is a macro doing the typechecking.
It's thus not only unnneded but counter-productive to
cast its argument to the untyped 'struct ptr_list*'.

Remove these casts.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cse.c (+1/-1), lib.h (+1/-1)
--------------------------------------------------------------------------------

[92fc6dac2eb8] 2018-02-24 10:49:15 +0100
Author: Jann Horn <jannh@google.com>
Subject: fix accesses through incorrect union members

No functional change - ->src1 and ->phi_src are at the same offset and have
the same type.
Discovered and debugged by compiling with "-Dunion=struct" in CFLAGS, which
I originally did because I wanted to easily see in GDB which union fields
I'm supposed to be accessing. Amazingly, running with -Dunion=struct seems
to work pretty well if you patch dup_token() to copy all the union members.

Signed-off-by: Jann Horn <jannh@google.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+2/-2), simplify.c (+5/-5)
--------------------------------------------------------------------------------

[a27bfb381d90] 2018-02-24 10:49:15 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: move the inner optimization loop into the main loop

Moving the inner optimization loop into the main one
help to see the real structure of the optimization logic
and facilitate experiments there and any needed changes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: optimize.c (+12/-19)
--------------------------------------------------------------------------------

[1cd676703c37] 2018-02-24 10:49:15 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: move inner optimization loop into optimize.c

The code for the inner optimization loop was in the same file
than the one for CSE. Now that the CSE have a well defined
interface, we can move this inner loop together with
the main optimization loop in optimize.c

This move make the code better structured and make it easier
to understand the optimization logic and make any experiment
or needed changes to it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cse.c (+0/-36), flow.h (+0/-1), optimize.c (+38/-0)
--------------------------------------------------------------------------------

[e22588735b2e] 2018-02-24 10:49:15 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: move liveness interface to its own header

Currently, the interface for liveness analysis is declared
in the flow.h header file. There is no a real need to move
it to its own file but it's the dual of the previous patch
and help a bit to make the code structure clearer.

Move the prototype for liveness analysis to its own header.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.h (+0/-4), liveness.c (+1/-0), liveness.h (+11/-0), optimize.c (+1/-0)
--------------------------------------------------------------------------------

[6114de42604a] 2018-02-24 10:49:15 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: expose interface to CSE

Now that the CSE have a well defined interface, we can
make it public, which will help us to untangle the CSE
part from the whole optimization logic.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cse.c (+3/-2), cse.h (+11/-0)
--------------------------------------------------------------------------------

[c6399ddb863f] 2018-02-24 10:49:15 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: extract cse_eliminate() from cleanup_and_cse()

Currently, the same function doing the CSE's elimination phase
also contains the inner part of the optimization loop.

Moving the CSE elimination part in a seperate function will
allow to make a clear interface for CSE and move this inner
optimization loop out of the CSE file.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cse.c (+13/-7)
--------------------------------------------------------------------------------

[c5ba883e6ac4] 2018-02-24 10:49:15 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cse: untangle simplification & hashing

Currently, the simplification of individual instructions
is done at the beginnig of the function doing the hashing
for CSE.

Separate the two help a little bit to understand the code
there and making any changes if needed.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cse.c (+6/-8)
--------------------------------------------------------------------------------

[adc4d32ef551] 2018-02-24 10:49:15 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: move the optimization loop in its own file

Once linearized, a few essentials optimizations are done
but the logic of the succession of these optimizations
is open-coded at the end of linearize_fn().

Obviously, this logic have nothing to do with the
linearization and moving it to a separate file will help
to clarify this logic and change it when needed.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), linearize.c (+2/-62), optimize.c (+76/-0), optimize.h (+9/-0)
--------------------------------------------------------------------------------

[08fff567c55a] 2018-02-24 10:49:15 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: rename variable 'optimize' to 'optimize_level'

So that this action name can be used for a function.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+3/-3), lib.h (+1/-1)
--------------------------------------------------------------------------------

[2dca5d4a08f4] 2018-02-24 10:19:04 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: fix typo with 'test-suite format -a'

"append" was used instead of "$append" when formatting
a new test, with the result that the infos for the test
system were always appended to the test fiel, which is
maybe often but not always desirable.

So, add the missing '$' when using the variable.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+1/-1)
--------------------------------------------------------------------------------

[b8ab21653014] 2018-02-24 10:19:04 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: 'amd64' is also ok for sparse-llvm

For sparse-llvm, the only layouts are for x86 architecture,
either 32 or 64bit. So, it's not built for other archs.

This is done by parsing the output of 'uname -m' but only
'i[3456]86' or 'x86' are accepted as pattern while 'amd64'
is also used.

Change the pattern to also accept 'amd64'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[71da77588620] 2018-02-24 00:11:11 -0800
Author: Christopher Li <sparse@chrisli.org>
Subject: Update gcc attribute list

Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: gcc-attr-list.h (+11/-0)
--------------------------------------------------------------------------------

[050a8102bc8b] 2018-02-24 00:05:06 -0800
Author: Randy Dunlap <rdunlap@infradead.org>
Subject: sparse: ignore indirect_branch attribute

Teach sparse about the "indirect_branch" attribute as used in
Linux kernel:
#define __noretpoline __attribute__((indirect_branch("keep")))
and tell sparse to ignore it.

This eliminates over 148K warnings (which also cause the
0day bot to send error reports uselessly).

Or does sparse need to do something with it?

Signed-off-by: Randy Dunlap <rdunlap@infradead.org>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: gcc-attr-list.h (+1/-0)
--------------------------------------------------------------------------------

[a5495762ea92] 2018-02-23 21:59:39 -0800
Author: Christopher Li <sparse@chrisli.org>
Subject: Merge remote-tracking branch 'chrisl/pseudo-sized-value-v2'

Tested-by: Dibyendu Majumdar <mobile@majumdar.org.uk>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: flow.c (+1/-1), linearize.c (+13/-10), linearize.h (+6/-2), memops.c (+1/-1), simplify.c (+10/-10), ... and 1 more
--------------------------------------------------------------------------------

[b8f9557e0834] 2018-02-20 12:35:10 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ban use of 'true' or 'false'

The idea being, of course, to be able for some functions to return
a bool, making clear what's their possible returned values.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: compile-i386.c (+9/-9), evaluate.c (+12/-12), expand.c (+9/-9), flow.c (+7/-8), inline.c (+13/-13), ... and 5 more
--------------------------------------------------------------------------------

[90bf63e97796] 2018-02-20 11:29:24 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: use -MMD for generated dependencies

For the autogenerated dependencies, we're not interested
in the system header files, only the project's ones.

So use the option '-MMD' instead of '-MD'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+2/-2)
--------------------------------------------------------------------------------

[5ef49e0a7de2] 2018-02-20 11:29:24 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: add -MP for generated dependencies

When an header file is removed, or more often when
bisecting or more generaly when we checkout an older
version where some header file didn't exist yet,
we typically have generated .d files containing
dependencies on a non-existing header file. In this
case, make abort and complains about the dependencies
that can't be met.

Avoid this situation by using the '-MP' option so that GCC
can automatically add a dummy rule for those header file.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+2/-2)
--------------------------------------------------------------------------------

[ee4d4dba3e0c] 2018-02-20 11:29:24 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use '%lld' for printing long longs

The used '%Ld' is a non-portable GNU extension (whcih I suppose
predate the standization of '%lld').

Use the standard '%lld' instead.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: compile-i386.c (+2/-2)
--------------------------------------------------------------------------------

[711fb682c570] 2018-02-20 11:29:24 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: no need for signed & unsigned multiplication

Currently, we have OP_MULS & OP_MULU but unless it's full,
widening multiplication both must give exactly the same
result (the world run on 2's complement CPUs now, right?).
Also, the IR doesn't have widening multiplication but
only instruction where both operands and the result have
the same size.

So, since theer is no reasons to keep 2 instructions,
merge OP_MULS & OP_MULU into a single one: OP_MUL.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.md (+2/-5), cse.c (+2/-2), example.c (+2/-3), linearize.c (+4/-5), linearize.h (+1/-1), ... and 4 more
--------------------------------------------------------------------------------

[f46c93967ce3] 2018-02-20 11:29:24 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unsigned multiplication is also associative

Currently, only signed multiplication is considered as associative
but in truth both signed & unsigned are.

So, make unsigned multiplication associative too.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+1/-1)
--------------------------------------------------------------------------------

[d7529936fa7d] 2018-02-17 18:38:50 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add testcases for expansion of FP classification

__builtin_isinf(), isnan() & isnormal() are all special cases
of __builtin_fpclassify().

Add a few cases testing if those are correctly expanded if
when the argument is a constant.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/expand/builtin_fpclassify.c (+26/-0), validation/expand/builtin_isinf.c (+20/-0), validation/expand/builtin_isnan.c (+20/-0), validation/expand/builtin_isnormal.c (+20/-0)
--------------------------------------------------------------------------------

[3e3526ff478e] 2018-02-17 18:38:50 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add testcases for expansion of special FP constants

More specifically: for __builtin_nan(), _huge_val() & _inf()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/expand/builtin_huge_val.c (+39/-0), validation/expand/builtin_nan.c (+23/-0)
--------------------------------------------------------------------------------

[e0693cd68164] 2018-02-17 18:38:50 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add typechecking of isnan(), isinf(), ...

These builtins should accept a single argument of any
floating-point type and should not do the usual promotion
of float to double.

Add the type and argument number check in the builtin's
evaluate method.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+30/-0), validation/builtin-fp-unop.c (+95/-0)
--------------------------------------------------------------------------------

[d2e557a42b55] 2018-02-17 18:38:50 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: extract eval_args() from arguments_choose()

Almost the same code is needed for others builtins, only
with another function name a arguments number.

So, extract this into a generic helper.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+30/-19)
--------------------------------------------------------------------------------

[54985f5b2db3] 2018-02-17 18:38:50 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: make builtins more builtin

Currently, (most) builtin functions are declared like
normal function prototypes. Furthermore, these declarations
are done via the pre-buffer mechanism and thus need to be
tokenized & parsed like normal code.

This is far from being 'builtin' and involves unnneded
processing.

Change this by skipping this pre-buffer phase and directly creating
the appropriate symbol for them.

Note: the correct mechanism to be used to make them really builtin
      is via init_builtins(), used when we have a real semantic
      action for the builtin.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+166/-0), lib.c (+5/-155), symbol.h (+1/-0), validation/builtin-prototype.c (+15/-0)
--------------------------------------------------------------------------------

[f45b7c7caeb2] 2018-02-17 18:38:50 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add ctype for const {void,char} *

These types are needed to declare builtin functions without
passing by the add_pre_buffer()-tokenization-parsing phases.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+7/-0), symbol.h (+2/-0)
--------------------------------------------------------------------------------

[6794d824a8d6] 2018-02-17 18:38:50 +0100
Author: Logan Gunthorpe <logang@deltatee.com>
Subject: add __builtin functions for isinf_sign, isfinite and isnan

These builtins are defined by gcc since 4.4. They are also now
used by the isinf, isfinite and isnan macros. So using them with a
newer gcc causes 'undefined identifier' errors.

Add the builtin definitions and some validation checks for these
functions.

Signed-off-by: Logan Gunthorpe <logang@deltatee.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+3/-0), validation/builtin_inf.c (+3/-0)
--------------------------------------------------------------------------------

[47bc08be942f] 2018-02-17 11:07:25 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: rename base_type() to bitfield_base_type()

In linearize.c, base_type() is not some kind of generic helper
like get_base_type() but is a more specialized thing used for
loads and stores and giving only the base type of bitfields.

Rename this helper to bitfield_base_type() to make this more
self-explained.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+5/-5)
--------------------------------------------------------------------------------

[48bda757364b] 2018-02-17 11:07:25 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: let struct access_data use a single type

'struct access_data' has two members for the type of the access:
'result_type' & 'source_type', the second being the application
of base_type() on the first.

These two names are not very self-explained and are confusing
when trying to know which one must be used for loads vs stores.
Also, the distinction between these two types only exists for
bitfields.

Simplify things by using a single type, and use base_type() when
doing the linearization of bitfield accesses.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+21/-23)
--------------------------------------------------------------------------------

[87d5acde0ae2] 2018-02-17 11:07:15 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use show_pseudo() for OP_SYMADDR's symbol

In show_instruction(), what is done to display OP_SYMADDR's
symbol is very close to what is done to display a PSEUDO_SYM.
In fact, what is done by show_pseudo() is more complete and
more informative.

So simply use show_pseudo() to display this part. This will
also avoid crashes caused by a NULL symbol.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+3/-16)
--------------------------------------------------------------------------------

[ea23b16490c7] 2018-02-17 11:07:15 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: show_pseudo(): protect against NULL ->sym

When displaying a PSEUDO_SYM, the corresponding symbol is
dereferenced but it's possible that this symbol is NULL
when a type error is present.

Fix this by explicitly checking against null ->sym and
emitting "<bad symbol>" if null.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+4/-0)
--------------------------------------------------------------------------------

[6a753aada1b0] 2018-02-17 11:07:06 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: initialize at declaration time

In sym_func_type(), a few variables are initialized
just after they are declared.

Change this to initialize them directly at their
declaration, which is simpler and more idiomatic.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+5/-12)
--------------------------------------------------------------------------------

[8250ba2b1741] 2018-02-17 11:07:06 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: use list_size() to count the numbers of arguments

The function sym_func_type() contains a small loop
which count the number of arguments, one by one.

Do this more simply and more efficiently by using
symbol_list_size().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+2/-7)
--------------------------------------------------------------------------------

[a5b1604864cd] 2018-02-16 09:30:46 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cleanup: remove unused 'struct pseudo_ptr_list'

'struct pseudo_ptr_list' was used to store pseudo usage
but this structure is not used since commit e7fb6e092
(Add instruction to pseudo user tracking).

Remove the leftovers.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+0/-6)
--------------------------------------------------------------------------------

[4c24b77bffc1] 2018-02-16 09:25:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'fix-converted-loads', 'kill-deadborn-loads', 'kill-dead-loads' and 'kill-dead-stores' into tip

Each of these branches contains a fix for the missing removal of
value or address usage when unneeded loads or stores are killed
during symbol simplification.

No conflicts but one of the tests fails in the branches while it
correctly succeed after they are merged (so no code conflict but
a semantic conflict).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+6/-17), flow.h (+5/-5), linearize.h (+10/-0), memops.c (+1/-10), simplify.c (+17/-17), ... and 5 more
--------------------------------------------------------------------------------

[a6dfe0e3b632] 2018-02-16 09:21:10 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: no repetition in unknown attribute warning message

The warning message for unknown attributes is a bit longish and
uses the word 'attribute' twice.

Change the message for something more direct, shorter and without
repetition.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-1), validation/Wunknown-attribute-yes.c (+1/-1)
--------------------------------------------------------------------------------

[bdf0e7cbb34b] 2018-02-15 21:30:09 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: By default disable the warning flag '-Wunknown-attribute'

Generally, we're not interested by those warnings, but we
can always explicitly ask for them if needed.

So make the flag '-Wunknown-attribute' off by default.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-1), validation/Wunknown-attribute-def.c (+0/-4)
--------------------------------------------------------------------------------

[89c9374c08e6] 2018-02-14 12:49:30 -0500
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: missing evaluate with '-include'

Symbols declared or defined in files directly or indirectly
given in the command line and thus processed via sparse()
are always automatically evaluated.
Symbols processed via sparse_initialize(), thus the predefined
ones, are not systematically evaluated, which is normaly fine
as they are just declarations and will be evaluated when needed.

However, if the command line include a file via '-include <file>',
the symbols of this file will also not be evaluated, which is still
fine as long as it's only definitions. But, in the rare and odd cases
where the file should contains a function definition, this function
will not be evaluated and it's expansion and linearization won't happen
as it should have.

Fix this by evaluating the symbols issued from sparse_intialize()
like it is done for sparse().

Reported-by: Jason A. Donenfeld <Jason@zx2c4.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: lib.c (+14/-0), validation/include-eval.c (+0/-1)
--------------------------------------------------------------------------------

[1bb9f3af1a96] 2018-02-14 12:49:27 -0500
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: missing evaluate with '-include' : add testcase

Reported-by: Jason A. Donenfeld <Jason@zx2c4.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/include-eval.c (+7/-0), validation/include-eval.inc (+12/-0)
--------------------------------------------------------------------------------

[da55cba8eadf] 2018-02-14 12:39:39 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: kill dead stores when simplifying symbols

In the initial simplify_symbols() and in simplify_memops()
when a store is simplified away, it's killed via kill_store()
where its ->bb is set to NULL and the usage is removed from
the value. However the usage is not removed from the address.
As consequence, code related to the address calculation
is not optimized away as it should be since the value is
wrongly considered as needed.

Fix this by using kill_instruction_force() to remove these
stores.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+4/-13), memops.c (+1/-10), validation/optim/store-dominated.c (+0/-1)
--------------------------------------------------------------------------------

[f9aa068780da] 2018-02-14 12:39:33 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: kill dead loads

Like others instructions producing a value, OP_LOADs can be dead.

But currently, dead OP_LOAD are not removed as dead_insn() do
for others instructions.

Fix this by checking at simplification time if OP_LOADs are
dead and call kill_instruction() if it is the case.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+5/-1), validation/optim/load-dead.c (+11/-0), validation/optim/load-semi-volatile.c (+25/-0)
--------------------------------------------------------------------------------

[488b3f379e42] 2018-02-14 12:39:19 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix usage of deadborn loads

In some situations, loads and others instructions can be
unreachable already when linearized, for example in code like:
	void foo(int *ptr)
	{
		return;
		*ptr;
	}
Such loads are detected in find_dominating_stores() and must
be discarded. This is done and the load have its opcode set
to OP_LNOP (wich is only useful for debugging) but it's
address is left as being used by the load.

Fix this by removing the address usage.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+1/-1), validation/mem2reg/load-deadborn.c (+9/-0)
--------------------------------------------------------------------------------

[56f6d4dd747a] 2018-02-14 12:37:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix killing of converted loads

Converted loads are dead and can be removed but that
also means that the address usage need to be adjusted
which wasn't done.

Fix this by directly using kill_instruction().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+1/-3), validation/optim/load-converted.c (+0/-1), validation/optim/load-semi-volatile.c (+25/-0)
--------------------------------------------------------------------------------

[154b19b15cec] 2018-02-14 11:41:08 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for converted loads

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/load-converted.c (+15/-0)
--------------------------------------------------------------------------------

[513a6ecf20e6] 2018-02-13 23:38:10 +0100
Author: Randy Dunlap <rdunlap@infradead.org>
Subject: sparse: ignore indirect_branch attribute

Teach sparse about the "indirect_branch" attribute as used in
Linux kernel:
    #define __noretpoline __attribute__((indirect_branch("keep")))
and tell sparse to ignore it.

This eliminates over 148K warnings (which also cause the
0day bot to send error reports uselessly).

Signed-off-by: Randy Dunlap <rdunlap@infradead.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: gcc-attr-list.h (+1/-0)
--------------------------------------------------------------------------------

[f5a6877758aa] 2018-02-13 00:15:29 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: let kill_instruction() report if changes were made

This let us take others actions if no changes have been made
and allow simpler call to this function since its effect on
'repeat_phase' can be directly returned.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.h (+5/-5), simplify.c (+8/-9)
--------------------------------------------------------------------------------

[a407894e929b] 2018-02-13 00:12:57 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use has_users() in dead_insn() too

The same functionality was open-coded here.
Change this by calling the new helper: has_users().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-5)
--------------------------------------------------------------------------------

[2642e04a2739] 2018-02-13 00:12:57 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add helper: has_users()

This is a wrapper around pseudo_user_list_size() which
can directly be used on a pseudo.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+5/-0)
--------------------------------------------------------------------------------

[3fb237b68b96] 2018-02-13 00:06:59 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add helper for pseudo's user-list's size

Add pseudo_user_list_size() instead of having to use
ptr_list_size() with an ugly cast.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+5/-0), simplify.c (+2/-2)
--------------------------------------------------------------------------------

[517c5e6e0d63] 2018-02-11 21:50:06 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for bad killing of dominated stores

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/store-dominated.c (+16/-0)
--------------------------------------------------------------------------------

[fdd1645dc1a8] 2018-02-11 10:16:07 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix missing checks for deleted instructions

Instructions with a null ->bb are instructions which have
been killed. As such, they must thus always be ignored
but it's not always the case.

Fix this by adding a check for null ->bb where there is
some looping over all the instructions of a basic block.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+16/-4), validation/mem2reg/killed-insn.c (+15/-0)
--------------------------------------------------------------------------------

[71205271e3c0] 2018-02-10 14:24:51 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix dead dominator

During simplify_one_symbol(), if possible, loads are replaced by
an OP_PHI and the corresponding OP_PHISOURCE. To simplify things
firther, If all the phisrcs correspond to an unique pseudo (often
because there is only a single phisrc), then it's useless to
create the OP_PHI: the created OP_PHISOURCEs can be removed and
the initial load can be converted to the unique pseudo.

However, if the unique pseudo was never used, the removal of
the OP_PHISOURCEs, done *before* the load conversion, will
kill the defining load (at this point the only user of the
pseudo was the OP_PHISOURCEs) which will then erroneously make
a VOID from the pseudo.

Fix this by doing the load conversion before removing the
unneeded OP_PHISOURCEs.

Files: flow.c (+1/-1), validation/mem2reg/load-dead.c (+0/-1)
--------------------------------------------------------------------------------

[dd566d02ba11] 2018-02-10 12:04:05 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase of dead dominator

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/mem2reg/load-dead.c (+19/-0)
--------------------------------------------------------------------------------

[a695e053a24d] 2018-02-08 12:49:03 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'cse-setfval' and 'extract-eval' into tip

[Auto-summary] Modifies 5 source files: evaluate.c, lib.c, linearize.c and 2 more. Updates header symbol.h. Adds/updates 5 test(s). Updates documentation. Changes: +331/-203 in 14 file(s)

Files: Documentation/data-structures.txt (+54/-53), Documentation/test-suite (+4/-4), evaluate.c (+44/-26), lib.c (+1/-0), linearize.c (+1/-3), ... and 9 more
--------------------------------------------------------------------------------

[047a43fa754c] 2018-02-06 00:01:09 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: extract extract eval_insn() from simplify_constant_binop()

For some optimizations, it's desirable to be able to
directly evaluate constant operations and not to have
to wait a whole simplification cycle or to have to
allocate an new instruction.

So, extract the part dealing exclusively with the
evaluation into a separate function.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+128/-113)
--------------------------------------------------------------------------------

[9fb6070311ea] 2018-02-05 23:41:01 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix examination of bad typeof

When the operand of typeof() is invalid, the corresponding
type is also invalid and can't be used. But currently,
when the corresponding SYM_TYPEOF symbol is examined,
this symbol is then simply returned as is. This, of course,
create problem for subsequent code since an examined type is
not supposed to be a SYM_TYPEOF anymore (one of the symptoms
will be warning about "unknown type 11").

Fix this by changing the SYM_TYPEOF into a SYM_NODE (as it's
expect) but pointing to bad_ctype. So further processing gently
continue and the 'bad_ctype' will do its job when needed.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+3/-1), validation/typeof-bad.c (+17/-0)
--------------------------------------------------------------------------------

[bc1124327960] 2018-02-01 18:15:50 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: always evaluate both operands

When evaluating a binary expression, the evaluation
already stop if the left operand is found erroneous.
The right one is thus not evaluated but it may contain
another error which will only be diagnosticated after the
first one is corrected and the file rechecked.
This is especially annoying when there are several independent
errors in some complex expression since it will need several
cycles of check-edit-recheck to get all errrors out.

Fix this by always evaluating both left & right operands
(and returning NULL if one of them is erroneous).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+9/-9)
--------------------------------------------------------------------------------

[0b30cce1e5fa] 2018-02-01 18:15:17 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: do not report bad types twice

The type 'bad_ctype' is only used after an error has been detected.
Since this error has also been reported, there is no reasons
to issue more errors when a 'bad_ctype' is involved. This allow
to focus on the root cause of the error.

Fix this by checking in bad_expr_type() if one of the operands
is already a 'bad_ctype' and do not issue an diagnostic message
in this case.

Note: the kernel has a bunch of these situations where the
      exact same warning is given several times in a row,
      sometimes as much as a dozen time.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+6/-1), validation/bad-type-twice2.c (+0/-1)
--------------------------------------------------------------------------------

[ad7c788e7a5b] 2018-02-01 18:06:18 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add helpers: valid_expr_type() & valid_subexpr_type()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+11/-0)
--------------------------------------------------------------------------------

[3a8d5ac86818] 2018-02-01 18:05:46 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use valid_type to avoid to warn twice on conditionals

When evaluating a conditional, the expression is first evaluated
and some further verifications and processing are done if
the returned type is not NULL.

However, the returned type can also be 'bad_ctype' and if it is
the case, the additional verifications will just give meaningless
additional warnings.

Fix this by using the new helper valid_type() instead of just
testing for a null ctype.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-1), validation/bad-type-twice1.c (+0/-1)
--------------------------------------------------------------------------------

[c376727487f9] 2018-02-01 17:53:32 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add helper: valid_type()

'bad_type' is used for ... bad types instead of NULL
in order to avoid later lots of null-checking.

Alas NULL is also often used and so we have to check
for NULL and 'bad_ctype' when checking a type's validity.

Add an helper: valid_type() to make the code a bit simpler.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+5/-0)
--------------------------------------------------------------------------------

[58346b848ce3] 2018-02-01 17:52:18 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: early return if null ctype in evaluate_conditional()

This function contains a few tests which must only be done
if the type is valid, same for the final call to degenerate().

Currently this is done by an "if (ctype) { ... }" but this
cause multiple NULL tests, take screen real estate and is
somehow error prone.

Change this by returning as soon as we know the ctype is
invalid since nothing good can be done after it.
This also makes, IMO, the code clearer.

NB: no functional changes here.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+15/-17)
--------------------------------------------------------------------------------

[0687a6f96154] 2018-02-01 15:23:25 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix error in bad conditional

Commit "b5867a33b (fix evaluation of a function or array symbol in conditionals)"
added a missing call to degenerate(epxr) but this must not be done
if the expression is erroneous.

fix this by bypassing the call to degenerate() if the ctype is NULL.

Fixes: b5867a33b62c04811784c6fc233c601a4f2b0841
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+3/-1), validation/bad-type-twice0.c (+0/-1)
--------------------------------------------------------------------------------

[56641060b08a] 2018-02-01 15:23:25 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for duplicated warning about invalid types

Once a invalid type is present in some sub-expression,
every upper level of the expression has an invalid type
but we should only warn about the innermost/root error.

However, this is not currently the case and invalid types
can create duplicated warnings, sometimes even a succession
of such warning.

Add some testcases to catch such situations.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/bad-type-twice0.c (+14/-0), validation/bad-type-twice1.c (+17/-0), validation/bad-type-twice2.c (+19/-0)
--------------------------------------------------------------------------------

[35e71b0279ae] 2018-01-31 19:26:04 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove warning "call with no type"

This warning is issued when trying to linearize a call
expression with a null expr->ctype. However, such null
ctypes are a consequence of earlier errors detected
during evaluation and for which a warning, specific
about the nature of the problem, have already been issued.

In short, this "call with no type" is non-informative
and redundant, so avoid useless noise and remove this
warning.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+1/-3)
--------------------------------------------------------------------------------

[b61bfb16326e] 2018-01-31 17:54:23 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: report type & size on non-power-of-2 pointer subtraction

The option -Wptr-subtraction-blows warns when pointer subtraction
is done and the base size is not a power-of-2.
However, the current message doesn't give much context.

Change this by giving the base type and the size in the warning.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+3/-1), validation/ptr-sub-blows.c (+23/-0)
--------------------------------------------------------------------------------

[1829a899f506] 2018-01-26 08:18:50 +0100
Author: Randy Dunlap <rdunlap@infradead.org>
Subject: lib.c: early return from handle_onoff_switch()

When handling "-Wsparse-all" in handle_onoff_switch(), once all
warning flags have been set, the function can return instead of
checking for "no-" or other option names because they won't be
found. Just return NULL, which is what happens when handling
"-Wsparse-all" anyway.

Signed-off-by: Randy Dunlap <rdunlap@infradead.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-0)
--------------------------------------------------------------------------------

[80996430d843] 2018-01-25 12:33:27 -0800
Author: Randy Dunlap <rdunlap@infradead.org>
Subject: test-suite: handle format with filename.c not existing

In error(), quiet is undefined when the command:
  $ ./test-suite format filename1.c foobar1

is used and filename1.c does not exist. This causes a shell script error:
  ./test-suite: line 147: [: : integer expression expected

because $quiet is undefined in
  [ "$quiet" -ne 1 ] && echo "error: $1"
so the error message is lost.

Just initialize quiet before any command line parsing.

Signed-off-by: Randy Dunlap <rdunlap@infradead.org>
Tested-by: Randy Dunlap <rdunlap@infradead.org>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: validation/test-suite (+1/-0)
--------------------------------------------------------------------------------

[b8ae5d20058b] 2018-01-24 09:32:45 +0100
Author: Randy Dunlap <rdunlap@infradead.org>
Subject: Documentation: editing fixes in test-suite

Fix typos, grammar, punctuation, and spelling in Documentation/test-suite.

Signed-off-by: Randy Dunlap <rdunlap@infradead.org>
Cc: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Cc: Josh Triplett <josh@joshtriplett.org>
Reviewed-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Reviewed-by: Josh Triplett <josh@joshtriplett.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/test-suite (+4/-4)
--------------------------------------------------------------------------------

[55c1cba75a18] 2018-01-23 02:56:44 -0800
Author: Randy Dunlap <rdunlap@infradead.org>
Subject: Documentation: editing fixes in test-suite

Fix typos, grammar, punctuation, and spelling in Documentation/test-suite.

Signed-off-by: Randy Dunlap <rdunlap@infradead.org>
Cc: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Cc: Josh Triplett <josh@joshtriplett.org>
Reviewed-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Reviewed-by: Josh Triplett <josh@joshtriplett.org>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Documentation/test-suite (+4/-4)
--------------------------------------------------------------------------------

[3adc7e495d07] 2018-01-23 02:20:20 -0800
Author: Randy Dunlap <rdunlap@infradead.org>
Subject: Documentation: make data-structures.txt easier to read

Make this file easier to read by removing the name at the beginning
of each line.
Put its source and attribution at the beginning of the file.

Signed-off-by: Randy Dunlap <rdunlap@infradead.org>
Reviewed-by: Josh Triplett <josh@joshtriplett.org>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: Documentation/data-structures.txt (+54/-53)
--------------------------------------------------------------------------------

[73e510c023f1] 2018-01-23 02:19:49 -0800
Author: Randy Dunlap <rdunlap@infradead.org>
Subject: sparse: minor manpage corrections

Fix some man page typos, punctuation, and grammar.

Signed-off-by: Randy Dunlap <rdunlap@infradead.org>
Cc: Josh Triplett <josh@joshtriplett.org>
Reviewed-by: Josh Triplett <josh@joshtriplett.org>
Signed-off-by: Christopher Li <sparse@chrisli.org>

Files: sparse.1 (+4/-4)
--------------------------------------------------------------------------------

[cea7d991f169] 2018-01-21 05:45:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: fix manpage formatting

A '.TP' was missing when describing '-fmem-report'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse.1 (+1/-0)
--------------------------------------------------------------------------------

[82c56f28aac6] 2018-01-21 05:43:49 +0100
Author: Randy Dunlap <rdunlap@infradead.org>
Subject: Documentation: make data-structures.txt easier to read

Make this file easier to read by removing the name at the beginning
of each line.
Put its source and attribution at the beginning of the file.

Signed-off-by: Randy Dunlap <rdunlap@infradead.org>
Reviewed-by: Josh Triplett <josh@joshtriplett.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/data-structures.txt (+54/-53)
--------------------------------------------------------------------------------

[8e647c22c54c] 2018-01-21 05:43:44 +0100
Author: Randy Dunlap <rdunlap@infradead.org>
Subject: sparse: minor manpage corrections

Fix some man page typos, punctuation, and grammar.

Signed-off-by: Randy Dunlap <rdunlap@infradead.org>
Cc: Josh Triplett <josh@joshtriplett.org>
Reviewed-by: Josh Triplett <josh@joshtriplett.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse.1 (+3/-3)
--------------------------------------------------------------------------------

[6b91f6997c7d] 2018-01-16 12:08:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: CSE: support CSE of floating-point literal

Before the introduction of OP_SETFVAL, floating-point were
created via OP_SETVAL whose CSE is done by comparing the
pointer of the corresponding expression without any
interpretation of this pointer.
As consequence, even if two OP_SETVAL have two identical
expressions (value), in most cases the corresponding pointers
are not identical, completly inhibiting the CSE of OP_SETVALs.

Fix the CSE of floating-point literals by directly using
the value given by the new OP_SETFVAL.

Note: to respect some of the subtilities of floating-point,
the equality comparison of two literals is not done on
the floating-point value itself but bit-by-bit on its
binary representation (as such we can continue to make the
distinction between +0.0 & -0.0, handle NaNs, ...).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cse.c (+11/-0), validation/optim/cse-setfval.c (+12/-0)
--------------------------------------------------------------------------------

[030473b77d72] 2018-01-08 14:04:43 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add OP_SETFVAL

OP_SETVAL is used to create floating-point and string
as well as labels-as-values. This multi-purpose aspect
sometimes make things a bit more complicated.

Change this by using a new instruction for the direct
creation of floating-point literals without needing
to have an intermediate EXPR_FVALUE.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.md (+8/-4), linearize.c (+13/-5), linearize.h (+4/-0), liveness.c (+1/-0), simplify.c (+1/-0), ... and 5 more
--------------------------------------------------------------------------------

[1277d44553d3] 2018-01-07 16:09:53 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cleanup: remove declaration of unused merge_phi_sources

The variable definition has been removed in commit:
	784e1e5b8 "Remove phi source merging."
but the declaration has been forgotten.

Remove it now.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.h (+1/-1)
--------------------------------------------------------------------------------

[f0486bd8e2ff] 2018-01-07 16:09:53 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cleanup: remove unused delete_last_basic_block()

Not only it is unused but given how basic blocks are processed
there is no chance it will ever be used.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.h (+0/-5)
--------------------------------------------------------------------------------

[3552e6b48749] 2018-01-07 16:09:53 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cleanup: remove unused & obsolete symbol_is_typename()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+0/-1)
--------------------------------------------------------------------------------

[58a12b842938] 2018-01-07 16:09:53 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cleanup: make some functions static

These functions are clearly meant to be used locally.
Furthermore, some have no prototypes.

Make these functions static and remove the prototype
when one was present.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.h (+0/-1), inline.c (+3/-1), lib.c (+3/-3), lib.h (+0/-2), linearize.c (+6/-6), ... and 2 more
--------------------------------------------------------------------------------

[e742c98f83d4] 2018-01-07 15:55:16 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'fmax-warnings', 'funsigned-char', 'testcase-fix-missing-return', 'type-as-first-class', 'llvm-zero-init' and 'llvm-prototype' into tip

[Auto-summary] Modifies 3 source files: lib.c, sparse-llvm.c, symbol.c. Updates header lib.h. Adds/updates 6 test(s). Changes: +190/-40 in 11 file(s)

Files: lib.c (+16/-3), lib.h (+2/-0), sparse-llvm.c (+25/-35), sparse.1 (+11/-0), symbol.c (+6/-0), ... and 6 more
--------------------------------------------------------------------------------

[88916d069c11] 2018-01-03 04:05:04 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ctags: avoid null deref

Protect the dereference of null base_type.

Reported-by: foobar <foobar@redchan.it>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ctags.c (+1/-1)
--------------------------------------------------------------------------------

[fc3c38266f9a] 2018-01-03 04:05:04 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: give a type to builtin functions

When creating builtin functions via init-builtins(), it shouldn't
really be needed to give them a type because their purpose is only
as a placeholder for the symbol->op->{evaluate,expand,..}. Also,
they should be part of the builtin_scope and never be visible.

However, currently the global scope is the same as the builtin_scope
and these symbols are thus visible via global_scope->symbols where
the missing type can be a problem.

Fix this to giving to the builtin functions which hadn't a type
the same phony type as the other functions had.

Reported-by: foobar <foobar@redchan.it>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+3/-3)
--------------------------------------------------------------------------------

[f4de73d60942] 2018-01-03 02:52:20 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse about '-fmax-warnings'

Currently, sparse stops to emit warnings after the 100th.
This is, of course, to avoid to throw lots of warnings if the
source file has lots of problems but sometimes we want to see
all warnings & errors.

For example, it's useful when testing a new version of
sparse on the kernel since it has a few files with more
than 100 warnings (and so a bad change will be undetected
if it affects warnings only after the 100th).

Let parse the '-fmax-warnings=N' option and limit the
number of warnings accordingly.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+11/-3), lib.h (+1/-0), sparse.1 (+6/-0)
--------------------------------------------------------------------------------

[1e1a172fe5c7] 2018-01-02 18:22:24 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'fix-expand-bitfield-deref', 'fix-fpops-cse', 'null-expr', 'size-unsized-arrays' and 'master' into tip

[Auto-summary] Modifies 6 source files: cse.c, evaluate.c, expression.c and 3 more. Adds/updates 22 test(s). Changes: +543/-18 in 28 file(s)

Files: cse.c (+3/-1), evaluate.c (+6/-1), expression.c (+6/-0), linearize.c (+8/-15), memops.c (+2/-0), ... and 23 more
--------------------------------------------------------------------------------

[be8017fdf5eb] 2018-01-02 17:46:12 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix: dereference null-type

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: memops.c (+2/-0), validation/bug-bad-type.c (+18/-0)
--------------------------------------------------------------------------------

