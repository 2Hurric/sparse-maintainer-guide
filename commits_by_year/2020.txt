================================================================================
Year: 2020 | Commits: 613 | Contributors: 13
Insertions: +28177 | Deletions: -9177
================================================================================

[10283ac0f48d] 2020-12-31 11:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'fix-rem-usage', 'ptrlist-no-mix' and 'diet-bb' into next

* fix rem_usage() when the pseudo has a use list but is not PSEUDO_REG
* ptrlist: avoid mixing reverse and non-reverse macros
* shrink struct basic_block

Files: linearize.h (+5/-7), ptrlist.h (+17/-12), ssa.c (+1/-0)
--------------------------------------------------------------------------------

[f554ff373bfd] 2020-12-29 14:54:25 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix rem_usage()

rem_usage() is used to remove an element from a def-use chain. Optionally,
if the chain become empty, the defining instruction can also be killed.

This optional part is currently be done on all pseudos but only those
having a definition should be concerned.

Fix this by adding a check so that only PSEUDO_REGs and PSEUDO_PHIs are killed.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+1/-1)
--------------------------------------------------------------------------------

[6956d2711272] 2020-12-29 14:54:17 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add helper has_definition()

Add the helper has_definition() to check if the pseudo belong to one
of the pseudo types having a definition: PSEUDO_REG & PSEUDO_PHI.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+5/-0)
--------------------------------------------------------------------------------

[2cf493d1f63f] 2020-12-29 14:44:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: packed: add support for __packed struct

Now that the 'packed' attribute is parsed and propagated into
the type system, adapt the layout of structures.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/TODO.md (+0/-3), parse.c (+4/-1), symbol.c (+9/-3), symbol.h (+1/-0), validation/packed-bitfield0.c (+0/-1), ... and 5 more
--------------------------------------------------------------------------------

[f07a1053a900] 2020-12-29 14:39:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: packed: no out-of-bound access of packed bitfields

There is (at least) 2 ways by which packed bitfields doesn't
follow normal layout/access rules and as consequence can't (always)
be accessed the usual way (load the whole underlying word, then shift
and mask to isolate the bitfield).

At least two different cases are a concern:
1) there is no padding at the end of a bitfield sequence. For example,
   the following struct is only 3 bytes width:
	struct s {
		int f:24;
	} __packed;
   So, trying to access the bitfield by first doing a 32-bit load
   will create an out-of-bound access.

2) a bitfield smaller than one word may need more than one word to be
   accessed. For example, with the following struct
	struct {
		int a:5;
		int f:30;
		int z:5;
	} __packed;
   the bitfield 'f', while smaller than one 32-bit word, can't be accessed
   with a single 32-bit access.

At machine level, these bitfields should be accessed with several, possibly
smaller, loads and their corresponding values reconstructed from these,
making things much more complicated than for non-packed bitfields.

But at IR level, things can be a little more flexible and things can stay
simple by using sub-word or super-word accesses (until these need to
be lowered to be usable at machine level). In other words, the example here
can be safely accessed with respectively a 24-bit and a 40-bit load.
This is what is done in this patch.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+11/-2), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[09fcd53fd308] 2020-12-29 14:39:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: struct-attr: fix: do not ignore struct/union/enum type attributes

GCC's syntax for type attributes is specified as:
    An attribute specifier list may appear as part of a struct,
    union or enum specifier. It may go either immediately after
    the struct, union or enum keyword, or after the closing brace.
    The former syntax is preferred. Where attribute specifiers
    follow the closing brace, they are considered to relate to
    the structure, union or enumerated type defined, not to any
    enclosing declaration the type specifier appears in, and the type
    defined is not complete until after the attribute specifiers.
In the section about type attributes, it's also said:
    You may specify type attributes in an enum, struct or union type
    declaration or definition by placing them immediately after the
    struct, union or enum keyword. A less preferred syntax is to
    place them just past the closing curly brace of the definition.

So, while placing the attribute after the closing curly is not
preferred, it is cleary legal (and it seems to be much more popular
than placing them just after the struct, union or enum keyword).

However, currently sparse doesn't handle this correctly:
- these attributes are parsed in declaration_specifiers() and
  added to the current decl_state
- when the ';' ending the type declaration is reached, the plain
  struct/union/enum is used and the content of the decl_state is
  simply ignored.
- if the declaration is for a variable, then those attributes
  are assigned to the variable (but not to the type).

Fix this by calling handle_attribute() once we have reached the
closing '}' of a struct/union/enum definition and applying these
attributes, if any, directly to the current base type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+2/-0), validation/packed-bitfield3.c (+0/-1), validation/packed-bitfield4.c (+0/-1), validation/type-attribute-align.c (+0/-1), validation/type-attribute-as.c (+0/-1), ... and 1 more
--------------------------------------------------------------------------------

[a565045f5e89] 2020-12-29 14:39:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: struct-attr: fix type attribute like 'struct __attr { ... }'

In a declaration like:
	struct <some attribute> { ... }
the attribute belong to the type but is currently handled as belonging
to the whole declaration.

Fix this by handling such attributes in a local 'decl_state' and
applying them once the closing '}' is reached.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+3/-1)
--------------------------------------------------------------------------------

[0c07b5979739] 2020-12-29 14:39:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: struct-attr: prepare to handle attributes at the end of struct definitions (3)

Type attributes for struct can be placed either just after the
keyword 'struct' or after the '}' ending its definition but this
later case is currently ignored.

Prepare the handling of this by having the 3 following cases in sequence:
1) a tag is present
2) no tag present but is followed by an opening brace
3) neither of these, so it's an error.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+6/-9)
--------------------------------------------------------------------------------

[d9087a616640] 2020-12-29 14:39:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: struct-attr: prepare to handle attributes at the end of struct definitions (2)

Type attributes for struct can be placed either just after the
keyword 'struct' or after the '}' ending its definition but this
later case is currently ignored.

Prepare the handling of this by restructuring the code handling
struct specifiers, namely inverting the condition so that the
function can return early to make next patch's job easier.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+13/-13)
--------------------------------------------------------------------------------

[c2922bf8df23] 2020-12-29 14:39:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: struct-attr: prepare to handle attributes at the end of struct definitions (1)

Type attributes for struct can be placed either just after the
keyword 'struct' or after the '}' ending its definition but this
later case is currently ignored.

Prepare the handling of this by factoring the code common to both
cases in a single place.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+5/-5), validation/parsing/enum-attr.c (+2/-2)
--------------------------------------------------------------------------------

[a9444f64ed60] 2020-12-29 14:39:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: apply_ctype: move up its declaration

apply_ctype() will be needed earlier in the code.
So, move it's prototype up.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+2/-2)
--------------------------------------------------------------------------------

[bb584698495e] 2020-12-29 14:39:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: apply_ctype: reverse the order of arguments

apply_ctype()'s argument order confuse me endlessly as I'm much more
used to have the destination first and the source next (the so called
'assignment order' used for assignments but also in memcpy() and in
many sparse or library functions).

So, change the argument order of apply_ctype() to mimic the order
of memcpy()/assignment, to hopefully reduce my confusion.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+4/-4)
--------------------------------------------------------------------------------

[6b63992aa68c] 2020-12-29 14:39:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: apply_ctype: use self-explanatory argument name

apply_ctype() is used to copy/apply things like modifiers
and address space from one type to another one.
But the names used for the two types are: 'ctype' & 'thistype'
which doesn't help at all to know which one is the 'source' type
and which one is the 'destination' type.

Change this by renaming these arguments to 'src' & 'dst'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+10/-10)
--------------------------------------------------------------------------------

[13696250ed93] 2020-12-29 14:39:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for packed bitfields

Currently, packed bitfields are not handled correctly.

Add some testcases for them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/packed-bitfield0.c (+59/-0), validation/packed-bitfield1.c (+28/-0), validation/packed-bitfield2.c (+16/-0), validation/packed-bitfield3.c (+29/-0), validation/packed-bitfield4.c (+19/-0), ... and 1 more
--------------------------------------------------------------------------------

[29cdbe161a46] 2020-12-29 14:39:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for packed structures

Currently, packed structs are not handled correctly.

Add some testcases for them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/packed-deref0.c (+24/-0), validation/packed-struct.c (+33/-0)
--------------------------------------------------------------------------------

[7d6cdc035082] 2020-12-29 14:39:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for type attributes

Currently, type attributes are not handled correctly.

Add some testcases for them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/type-attribute-align.c (+20/-0), validation/type-attribute-as.c (+34/-0), validation/type-attribute-mod.c (+22/-0), validation/type-attribute-qual.c (+15/-0)
--------------------------------------------------------------------------------

[1d2355e60f36] 2020-12-29 14:39:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for enum attributes

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/parsing/enum-attr.c (+29/-0)
--------------------------------------------------------------------------------

[6d8a3e9551de] 2020-12-29 14:39:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for exotic enum values

There is more than one complexity in the evaluation of enums.

Add a test for enums with 'exotic' values not covered in other tests.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/enum-type-exotic.c (+28/-0)
--------------------------------------------------------------------------------

[0f2eee32cae5] 2020-12-29 14:39:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for dubious enum values

sparse accept any type of integral value for enumerators
but address constants are also accepted, which is 'strange'.

Add a testcase for such 'enums'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/enum-type-dubious.c (+18/-0)
--------------------------------------------------------------------------------

[da9b52ecbc38] 2020-12-27 12:01:46 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ptrlist: avoid mixing reverse and non-reverse macros

The macros used to iterate the ptrlists exist in two kinds:
those to iterate forward direction and those to iterate in the
reverse direction.

Those macros must be used in pair: one for the top of the loop and
one at the end of the loop. However, if we mix them, for example like:
	FOR_EACH_PTR(list, var) {
		...
	} FOR_EACH_PTR_REVERSE(var);

things will still work for lists with a single block (most of them)
but will behave strangely and of course wrongly when reaching the
next block.

So, to avoid future debugging fun, add a unused variable, discarded
at compile time, but with distinct prefix for each direction. This way,
mixing the macros will create a warning at compile time.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.h (+17/-12)
--------------------------------------------------------------------------------

[2272cfe11fc7] 2020-12-27 11:08:00 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: shrink struct BB

Reorganize the members of struct BB, avoiding padding and making better
use of the union, to shrink its size from 104 to 96 bytes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+5/-7), ssa.c (+1/-0)
--------------------------------------------------------------------------------

[1b896707d959] 2020-12-11 14:14:30 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'fix-parsing-testsuite-tags'

* fix parsing of tags used in the testcases

Files: validation/asm-empty-clobber.c (+1/-1), validation/asm-goto-labels.c (+2/-1), validation/test-suite (+2/-2)
--------------------------------------------------------------------------------

[6c10d780aaea] 2020-12-11 14:13:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: fix parsing of tags used in the testcases

In testcases' tags, if a value contains 'check-' then this
value will be used as the tagname instead of the value.

Fix this by adding a bit more context in the regexp used for parsing these.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/asm-empty-clobber.c (+1/-1), validation/asm-goto-labels.c (+2/-1), validation/test-suite (+2/-2)
--------------------------------------------------------------------------------

[72edf4380a05] 2020-12-11 02:58:48 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'kill-asm' and 'next'

* fix killing OP_ASM
* move check_access() to late_warnings()

Files: linearize.c (+6/-0), memops.c (+0/-3), validation/bad-check-access0.c (+31/-0)
--------------------------------------------------------------------------------

[7a9da618ba96] 2020-12-10 00:31:01 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: move check_access() to late_warnings()

check_access() is called at each run of simplify_loads().

However, a bad access can belong to a dead branch and thus a
bad access warning can be issued for code that is not executed,
maybe specifically excluded.

So, move check_access() to late_warnings(), where all optimizations
have been done.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+6/-0), memops.c (+0/-3), validation/bad-check-access0.c (+31/-0)
--------------------------------------------------------------------------------

[d08e3d0b6950] 2020-12-04 17:08:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix killing OP_ASM

Currently OP_ASMs are only handled by default in kill_insn().
In consequence, the usage is not removed from their inputs,
possibly leaving dead pseudos.

Fix this by removing the usage on the input pseudos.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+15/-0)
--------------------------------------------------------------------------------

[a00755aafac2] 2020-12-02 00:09:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'kill-replace' into next

* let replace_with_pseudo() use kill_instruction()
* move rewrite_load_instruction() to memops.c
* replace convert_load_instruction() by replace_with_pseudo()

Files: flow.c (+1/-47), flow.h (+0/-3), memops.c (+44/-2), optimize.c (+1/-0), simplify.c (+3/-18), ... and 2 more
--------------------------------------------------------------------------------

[269d7b9ec7a7] 2020-12-02 00:08:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'fix-kill_dominated_stores' and 'kill-dead-loads' into next

* memops: fix wrong killing of stores partially dominated by a load
* memops: kill dead loads before phi-node conversion

Files: memops.c (+5/-0), validation/memops/kill-dead-loads00.c (+22/-0)
--------------------------------------------------------------------------------

[701ce0cadbd5] 2020-11-29 23:06:59 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: memops: kill dead loads before phi-node conversion

During load simplification it may happen that a load is unused
but if this fact is ignored and the usual conversion to a phi-node
is made, then this value may seem to be needed and can't anymore
be simplified away.

Fix this by removing dead loads during load simplification.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: memops.c (+5/-0), validation/memops/kill-dead-loads00.c (+22/-0)
--------------------------------------------------------------------------------

[9aa51a90505e] 2020-11-28 22:30:36 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix wrong killing of stores partially dominated by a load

When a partial but overlapping load is followed by a store, this
load is not considered as dominating the store. This is a problem
for kill_dominated_stores() because the load will be simply ignored.
For example, in code like:
	union {
		u64 l;
		int i;
	} u;
	int i;

	u.l = x;
	i = u.i;
	u.l = y;

The load will be ignored, then the first store can be ignored too
and the value of 'i' will be undefined (but actually set to 0).

The root of the problem seems to be situated in dominates() where
a load is considered as dominating another memop only if both
correspond to the same 'access' (address and size).

This is probably fine when the other memop is itself a load (because
the value of the first load can't be reused for the second one) but
it's not when the other memop if a store.

So, to be safe, consider different-but-overlapping memops as neither
dominated or non-dominated but as "don't know".

Note: as explained here above, this can *probably* be relaxed when
      both memops are loads but it's not 100% clear to me yet and
      I found no examples where it actually make a difference.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+0/-2), validation/memops/partial-load00.c (+29/-0)
--------------------------------------------------------------------------------

[7624a18d6148] 2020-11-28 11:46:40 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: replace convert_load_instruction() by replace_with_pseudo()

These two functions are now exactly the same, so replace the
first one by the second one.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+1/-6), flow.h (+0/-1), memops.c (+4/-3), ssa.c (+5/-4)
--------------------------------------------------------------------------------

[d50ca778c27e] 2020-11-28 11:46:40 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: memops: move rewrite_load_instruction() here

The function rewrite_load_instruction() is defined in flow.c but:
* is not directly related to 'flow'
* it's only used in memops.c
* needs some change related to simplify_loads().

So, move this code to memops.c

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+0/-41), flow.h (+0/-1), memops.c (+41/-0)
--------------------------------------------------------------------------------

[3a3955b5ecbf] 2020-11-28 11:41:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: make replace_with_pseudo() extern

This function can be useful since it can be useful in other files,
for example in memops.c

So make it extern..

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+1/-1), simplify.h (+2/-0)
--------------------------------------------------------------------------------

[ffa1eb332ea2] 2020-11-28 11:41:17 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: make a header for simplification

The few external functions defined in simplify.h are declared
in flow.h (for historical reasons).

In preparation for some changes, create a specific headers for these.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.h (+0/-1), optimize.c (+1/-0), simplify.c (+1/-0), simplify.h (+8/-0)
--------------------------------------------------------------------------------

[e1e909ac779e] 2020-11-28 11:36:39 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: let replace_with_pseudo() use kill_instruction()

In replace_with_pseudo(), the replaced instruction needs to be killed
and for this contains ts own code.

But this is a duplication of what is already done in kill_instruction().

So, replace this part of the code by a cal to kill_instruction().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+1/-17)
--------------------------------------------------------------------------------

[3bc348f6eea9] 2020-11-28 10:58:14 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'bit-trans' into next

* factorize (x OP1 z) OP2 (y OP1 z) into (x OP2 y) OP1 z
* factorize SHIFT(x, s) OP SHIFT(y, s) into SHIFT((x OP y), s)
* factorize SEL(x, OP(y,z), y) into OP(SEL(x, z, 0), y)
* convert SEL(x & BIT1, BIT2, 0) into SHIFT(x & BIT1, S)

Files: bits.h (+12/-0), simplify.c (+264/-17), validation/optim/fact-add-mul.c (+27/-0), validation/optim/fact-and-ior.c (+27/-0), validation/optim/fact-and-shift.c (+26/-0), ... and 6 more
--------------------------------------------------------------------------------

[cafabc769e77] 2020-11-27 22:19:41 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: convert SEL(x & BIT1, BIT2, 0) into SHIFT(x & BIT1, S)

Convert an expression like:
	(x & (1 << A)) ? (1 << B) : 0
into:
	(x & (1 << A)) << (B - A)
or:
	(x & (1 << A)) >> (A - B)

Suggested-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+15/-0), validation/optim/select-and-shift.c (+0/-1)
--------------------------------------------------------------------------------

[2b77484ed79f] 2020-11-27 22:18:55 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add log base 2 function: log2_exact()

Add log2_exact() to get the base 2 logarithm of a value known
to be a power of 2.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: bits.h (+7/-0)
--------------------------------------------------------------------------------

[9837f19e4fb5] 2020-11-27 22:18:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add helper is_pow2()

Add is_pow2() to test if a pseudo is a power of 2.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+9/-0)
--------------------------------------------------------------------------------

[d722c87f10a9] 2020-11-27 22:18:00 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add helper is_power_of_2()

Add is_power_of_2() to test if a value is a power of 2.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: bits.h (+5/-0)
--------------------------------------------------------------------------------

[2eb69efa7f91] 2020-11-27 22:17:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: factorize SEL(x, OP(y,z), y) into OP(SEL(x, z, 0), y)

'Factorize' and expression like:
	x ? (y | z) : y;
into
	(x ? z : 0) | y;

and some positional variants as well as replacing '|' by '+' or '^'.

Note: it's not very clear if this is really an improvement but it
      allows some very nice simplification of 'bits translations'.
Note: the same can be done for others operations, for example it can
      be done for '&' if '0' (the neuter value for '|', '+' and '^')
      by '~0' (same with '*' and '1').

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+40/-0), validation/optim/fact-select01.c (+0/-1)
--------------------------------------------------------------------------------

[3aaa16eac7f0] 2020-11-27 22:17:09 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testscases for 'bits translation' optimization

Add some testcase related to the simplification of expressions like:
	if (val1 & BIT1)
		val2 |= BIT2;
into
	val2 |= (val1 & BIT1) {SHL/LSR} |BIT2-BIT1|;

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/fact-select01.c (+26/-0), validation/optim/select-and-shift.c (+18/-0)
--------------------------------------------------------------------------------

[90c1d15708d4] 2020-11-27 17:27:07 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: factorize SHIFT(x, s) OP SHIFT(y, s) into SHIFT((x OP y), s)

Factorize bitwise OPs of shifts with identical counts.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+27/-0), validation/optim/fact-and-shift.c (+0/-1), validation/optim/fact-ior-shift.c (+0/-1), validation/optim/fact-xor-shift.c (+0/-1)
--------------------------------------------------------------------------------

[7d385de8172a] 2020-11-27 17:27:07 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: factorize (x OP1 z) OP2 (y OP1 z) into (x OP2 y) OP1 z

Factorize common distributive operations:
	(x * z) + (y * z) --> (x + y) * z
	(x | z) & (y | z) --> (x & y) | z
	(x & z) | (y & z) --> (x | y) & z
	(x & z) ^ (y & z) --> (x ^ y) & z

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+78/-0), validation/optim/fact-add-mul.c (+0/-1), validation/optim/fact-and-ior.c (+0/-1), validation/optim/fact-ior-and.c (+0/-1), validation/optim/fact-xor-and.c (+0/-1)
--------------------------------------------------------------------------------

[6661a9c4d820] 2020-11-27 17:27:07 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: refactor simplify_add() to avoid code duplication

Do some refactoring in simplify_add() to avoid some code
duplication there and better handle generic transforms
that need to be applied on both operands.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+9/-13)
--------------------------------------------------------------------------------

[7e6a070827d2] 2020-11-27 17:27:07 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: refactor simplify_add() to avoid code duplication (preparation)

Do some refactoring in simplify_add() to prepare the next patch
which will avoid some code duplication there.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-5)
--------------------------------------------------------------------------------

[9e6eaf742cb4] 2020-11-27 17:27:07 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add helper replace_binop()

Add an helper to replace a binop OP(a, b) and taking care to
drop the usage of the previous operands.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+17/-0)
--------------------------------------------------------------------------------

[c60a5e93310b] 2020-11-27 17:27:06 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add helper make_insn_pair() & swap_insn()

Add two helpers to create instruction pair OUT(IN(a, b), c).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+31/-0)
--------------------------------------------------------------------------------

[449ab6d6e5db] 2020-11-27 17:27:06 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: reassoc: add helper can_move_to()

When transforming IR expressions, it may happen that we want to
reuse an instruction and move a pseudo into it but that this pseudo
is only defined later.

Add a small help to check this: can_move_to().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+37/-0)
--------------------------------------------------------------------------------

[fbd81ed45d58] 2020-11-27 17:26:40 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testscases for some factorization of distributive operations

Add some testcases for factorizations of:
	(x * z) + (y * z) --> (x + y) * z
	(x | z) & (y | z) --> (x & y) | z
	(x & z) | (y & z) --> (x | y) & z
	(x & z) ^ (y & z) --> (x ^ y) & z
and
	(x << s) | (y << s) --> ((x | y) << s)
	and same for &, ^, LSR and ASR.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/fact-add-mul.c (+28/-0), validation/optim/fact-and-ior.c (+28/-0), validation/optim/fact-and-shift.c (+27/-0), validation/optim/fact-ior-and.c (+28/-0), validation/optim/fact-ior-shift.c (+27/-0), ... and 2 more
--------------------------------------------------------------------------------

[f50c482ebabe] 2020-11-26 22:26:47 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'fix-trivial-phi' into next

* fix trivial_phi() when the target is before the single value

Files: simplify.c (+2/-2), validation/optim/trivial-phi01.c (+20/-0)
--------------------------------------------------------------------------------

[fe9dbeb3d0ab] 2020-11-26 22:25:49 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix trivial_phi() when the target is before the single value

A phi-node is called 'trivial' if it only reference itself and a
single other value. In this case the only possible value for the
phi-node is this single other value which can thus replace the
phi-node.

However, the current code get this slightly wrong when the first
referenced value is itself and not the other value.

Fix this by moving up the test checking if it references itself.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-2), validation/optim/trivial-phi01.c (+20/-0)
--------------------------------------------------------------------------------

[1abdabb5651d] 2020-11-26 22:23:11 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'ir-symaddr' into next

* give a type to OP_SYMADDR

Files: linearize.c (+4/-4)
--------------------------------------------------------------------------------

[540c2c4bf47f] 2020-11-24 01:04:35 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'optim-not' into next

* put PSEUDO_ARGS and PSEUDO_REGs in canonical order too
* simplify (~x {&,|,^} x) --> {0,~0,~0}
* simplify ((x cmp y) {&,|,^} (x !cmp y)) --> {0,1,1}

Files: linearize.h (+2/-2), opcode.h (+10/-0), simplify.c (+108/-10), validation/linear/pointer-arith32.c (+6/-6), validation/linear/pointer-arith64.c (+5/-5), ... and 6 more
--------------------------------------------------------------------------------

[8038d97de3e8] 2020-11-22 18:49:14 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: symaddr: give a type to OP_SYMADDR

Currently, OP_SYMADDRs are given a size but not a type.
But the type is needed for several things, the idea being
that for each instruction producing a pseudo (PSEUDO_REG)
it's possible to:
* retrieve its defining instruction
* retrieve its type via this defining instruction

Fix this by giving to OP_SYMADDRs the type of their symbol.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+4/-4)
--------------------------------------------------------------------------------

[4f10206cc4dc] 2020-11-22 17:15:32 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'cleanup' into next

[Auto-summary] Modifies 2 source files: flow.c, simplify.c. Updates header flow.h. Changes: +8/-21 in 3 file(s)

Files: flow.c (+1/-2), flow.h (+0/-1), simplify.c (+7/-18)
--------------------------------------------------------------------------------

[80777740bcb1] 2020-11-22 17:07:53 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'optim-cgoto' into next

* simplification of computed gotos with 1 or 2 targets

Files: Documentation/IR.rst (+9/-2), cse.c (+9/-0), example.c (+5/-3), ir.c (+1/-0), linearize.c (+6/-0), ... and 7 more
--------------------------------------------------------------------------------

[7f03e99c7e74] 2020-11-22 15:58:07 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: not: simplify ((x cmp y) {&,|,^} (x !cmp y)) --> {0,1,1}

Simplify bitwise operations on a compare and its complement
into 0 (for &) or 1 for (| and ^).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+21/-3), validation/optim/cse-not02.c (+0/-1)
--------------------------------------------------------------------------------

[a49663abcf7f] 2020-11-22 15:58:07 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: not: simplify (~x {&,|,^} x) --> {0,~0,~0}

Simplify bitwise operations on a pseudo and its complement
into 0 (for &) or ~0 for (| and ^).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+63/-3), validation/optim/cse-not01.c (+0/-1)
--------------------------------------------------------------------------------

[8b1d40e3721f] 2020-11-22 15:58:07 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: opcode: add helpers opcode_negate() & opcode_swap()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: opcode.h (+10/-0)
--------------------------------------------------------------------------------

[84f84262a122] 2020-11-22 15:58:05 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: canon: simplify calculation of canonical order

The calculation of the canonical order is currently somehow
complicated.

Fix this by reordering the definition of the different type of
pseudos so that they are already in canonical order and just
comparing the types to determine the order.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+2/-2), simplify.c (+27/-13)
--------------------------------------------------------------------------------

[ef00ea2fa520] 2020-11-22 15:30:17 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: canon: put PSEUDO_REGs in canonical order too

Currently, only binops containing PSEUDO_VAL, SYM or ARG were
put in canonical order. This means that binops containing only
PSEUDO_REGs are not ordered. This is not directly
a problem for CSE because commutativity is taken in account but:
* more combination need to be checked during simplification
* 'anti-commutative' operations like (a > b) & (b < a) are not
  recognized as such.

So, take PSEUDO_REGs in account when checking if operands
are in canonical order.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+3/-0), validation/optim/cse-reg01.c (+0/-1)
--------------------------------------------------------------------------------

[a1c7b6f159cf] 2020-11-22 15:30:16 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: canon: put PSEUDO_ARGs in canonical order too

Currently, only binops containing PSEUDO_VAL or PSEUDO_SYM were
put in canonical order. This means that binops containing only
PSEUDO_ARGs or PSEUDO_REGs are not ordered. This is not directly
a problem for CSE because commutativity is taken in account but:
* more combination need to be checked during simplification
* 'anti-commutative' operations like (a > b) & (b < a) are not
  recognized as such.

So, as a first step, also take PSEUDO_ARGs in account when checking
if operands are in canonical order.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+3/-0), validation/linear/pointer-arith32.c (+6/-6), validation/linear/pointer-arith64.c (+5/-5), validation/optim/cse-arg01.c (+0/-1)
--------------------------------------------------------------------------------

[eda5c718f55a] 2020-11-22 15:30:12 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: not: add testcases for canonicalization & simplification of negations

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/canonical-arg.c (+20/-0), validation/optim/canonical-not.c (+9/-0), validation/optim/cse-arg01.c (+10/-0), validation/optim/cse-not01.c (+12/-0), validation/optim/cse-not02.c (+12/-0), ... and 1 more
--------------------------------------------------------------------------------

[45e0e859a9cf] 2020-11-21 23:05:03 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add a new instruction for label-as-value

Convert OP_SETVAL of a label into a new instruction: OP_LABEL.
There is 2 reasons to do this:
*) there is slightly less checking to be done in later phases
   (since OP_SETVAL can be for labels but also strings)
*) OP_SETVAL is CSEd but this is largely useless because this
   instruction is hashed on the expression's address and these
   are (most) often not shared. With a separate instruction
   for label expressions, their CSE is now OK because the hashing
   is done on the BB.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.rst (+9/-2), cse.c (+9/-0), example.c (+5/-3), ir.c (+1/-0), linearize.c (+6/-0), ... and 5 more
--------------------------------------------------------------------------------

[1221dc1c8c42] 2020-11-21 18:22:11 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify CGOTO(SEL(x, L1, L2)) into CBR x, L1, L2

A computed goto having as operand a select of 2 statically known addresses
(OP_SETVAL/EXPR_LABEL) is equivalent to a simple conditional branch.

Simplify such computed goto into the corresponding OP_CBR

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+22/-0), validation/optim/cgoto02.c (+0/-1)
--------------------------------------------------------------------------------

[7943063c5206] 2020-11-21 18:18:43 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify OP_COMPUTEDGOTO with unique and known target

If the OP_COMPUTEDGOTO's source pseudo is defined by a single
OP_SETVAL/EXPR_LABEL, then the corresponding basic block is the
only possible destination and the computed goto can then be
simplified into a simple branch.

So, convert such computed goto into a simple OP_BR which may
then participate in other flow simplifications.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+30/-0), validation/optim/cgoto01.c (+0/-1)
--------------------------------------------------------------------------------

[15bea3b0bbe7] 2020-11-21 18:15:15 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify kill_insn() of unops and unop-ish instructions

In instructions, the first pseudo operands exist under different
names (.src1, .src, .cond, .phi_src) all aliased to each other.

Use this to simplify unops and others instructions with a single
pseudo operand.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+5/-13)
--------------------------------------------------------------------------------

[a56c36499b68] 2020-11-21 18:05:01 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unneeded REPEAT_SYMBOL_CLEANUP

Since simplify_memops() must be called unconditionally (see [1])
it's useless to set REPEAT_SYMBOL_CLEANUP (at the condition that
REPEAT_CSE is set instead).

So remove it's definition and set REPEAT_CSE instead when needed).

[1] 6b5e7cf5ac39 ("cfg: call simplify_memops() unconditionally.")

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+1/-2), flow.h (+0/-1), simplify.c (+2/-5)
--------------------------------------------------------------------------------

[641cf2c29528] 2020-11-21 17:47:34 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix kill_insn(OP_SETVAL)

When killing OP_SETVAL's, kill_use(&insn->src1) is called to
remove the usage of its first operand but OP_SETVAL has no
such operand.

Fix this by moving the corresponding entry with OP_SETFVAL and
others instruction without operands.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+1/-1)
--------------------------------------------------------------------------------

[d02b99212403] 2020-11-21 14:34:55 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for COMPUTEDGOTO simplification

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/cgoto01.c (+25/-0), validation/optim/cgoto02.c (+18/-0), validation/optim/cse-label.c (+14/-0)
--------------------------------------------------------------------------------

[b59dbdaf3740] 2020-11-19 18:30:53 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'cleanup-postop' and 'cleanup-linearize'

[Auto-summary] Modifies 2 source files: evaluate.c, linearize.c. Changes: +1/-6 in 2 file(s)

Files: evaluate.c (+1/-2), linearize.c (+0/-4)
--------------------------------------------------------------------------------

[50545fb487ca] 2020-11-19 18:30:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'diamond'

* rebuild dominance tree during CFG cleanup
* simplify CBR-CBR on the same condition

Files: flow.c (+106/-0), optimize.c (+8/-2)
--------------------------------------------------------------------------------

[0dbc3bb8bfe0] 2020-11-19 18:08:05 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify unrestricted postop

The '++' and '--' operator used in evaluate_postop() are
'restricted' operators. It's thus unneeded to call restricted_unop()
on them as it will always return '1'.

It's also unneeded to test for TYPE_RESTRICT since it will also be
tested in unrestrict().

So, simply call unrestrict() unconditionally.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-2)
--------------------------------------------------------------------------------

[349ac6d1489f] 2020-11-19 09:18:01 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'unqual'

* unqual: comma expressions should drop qualifiers
* unqual: statement expressions should drop qualifiers

Files: evaluate.c (+4/-2), validation/eval/unqual-comma.c (+12/-0), validation/eval/unqual-postop.c (+23/-0), validation/eval/unqual-stmt-expr.c (+12/-0), validation/eval/unqual02.c (+26/-0)
--------------------------------------------------------------------------------

[fd1491b21759] 2020-11-18 21:57:59 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unqual: statement expressions should drop qualifiers

Statement expressions should be subjected to lvalue-conversion
and thus should drop qualifiers.

Fix this by calling unqualify_type() after array-to-pointer
conversion.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-1), validation/eval/unqual-stmt-expr.c (+0/-1)
--------------------------------------------------------------------------------

[a624f755195c] 2020-11-18 21:57:59 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unqual: comma expressions should drop qualifiers

Comma expressions should be subjected to lvalue-conversion
and thus should drop qualifiers.

Fix this by calling unqualify_type() after array-to-pointer
conversion.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-1), validation/eval/unqual-comma.c (+0/-1)
--------------------------------------------------------------------------------

[847eaf89b449] 2020-11-18 21:57:59 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unqual: unqualify_type() should check for null ctypes

It's possible that the input type is NULL, so add a check for it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+2/-0)
--------------------------------------------------------------------------------

[d1351f69d73d] 2020-11-18 21:57:55 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unqual: add testcases

Add some testcases related to qualifier dropping / lvalue conversion.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/eval/unqual-comma.c (+13/-0), validation/eval/unqual-postop.c (+23/-0), validation/eval/unqual-stmt-expr.c (+13/-0), validation/eval/unqual02.c (+26/-0)
--------------------------------------------------------------------------------

[626c474204e8] 2020-11-18 01:19:06 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: casts should drop qualifiers

Casts should drop qualifiers but Sparse doesn't do this yet.

The fix seems pretty simple: after having evaluated the type of
the cast, if this type is a SYM_NODE and contains qualifiers,
make a copy of the type with the qualifiers removed and use
this copy as the type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+13/-0), validation/eval/unqual-cast.c (+14/-0)
--------------------------------------------------------------------------------

[2fbd5822933c] 2020-11-17 18:25:54 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: linearize: remove unneeded forward declarations

These declarations are not needed, so remove them.

A few of the other ones could/should be removed but
it would need to shuffle some code around.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+0/-4)
--------------------------------------------------------------------------------

[bbb3d7fcbe6d] 2020-11-17 18:06:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'pack-early'

* cfg: remove phi-sources when merging BBs
* cfg: remove phi-nodes when merging BBs
* cfg: add missing REPEAT_CFG_CLEANUP
* cfg: call simplify_memops() unconditionally.
* cfg: early CFG simplification

Files: flow.c (+178/-23), flow.h (+1/-0), linearize.c (+1/-0), memops.c (+2/-0), optimize.c (+6/-3), ... and 13 more
--------------------------------------------------------------------------------

[7cd2ce022575] 2020-11-17 18:04:58 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify CBR-CBR on the same condition

In situations like:
		...
		cbr	<cond>, L1, L2

	L1:		L2:
	...		...

		L3:
		cbr	<cond>, L4, L5

since the conditions are the same and L3 is empty but the CBR,
all branches to L3 in L1 can be changed to branches to L4
(idem with L5 in L2). The same can be done in all BB 'in the
path between L1 and L3', more exactly in all BB dominated by L1,
this guarantee that the changes is only done on the BB where
the conditions match.

Note: This simplification kinda generalizes the current
      simplify_branch_branch() but should itself generalized
      to handle the presence of phi-sources in L3.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+106/-0)
--------------------------------------------------------------------------------

[35b1a31ca12e] 2020-11-17 18:04:58 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: rebuild dominance tree during CFG cleanup

Currently, the dominance tree is build once, just before the
SSA conversion.

However, changes in the CFG potentially changes the dominance
relationships.

So, rebuild the dominance tree after changes to the CFG.

Note: This doesn't seems to significantly affect the performance
      (at least when used on the kernel):
	before			after
	real	 4m15.854s	real	 4m16.95&s
	user	71m11.390s	user	71m29.180s
	sys	28m45.222s	sys	28m46.145s

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: optimize.c (+8/-2)
--------------------------------------------------------------------------------

[28677f8ac6ef] 2020-11-17 18:03:24 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cfg: early CFG simplification

The linearization step sometimes creates a lot of intermediate
basic blocks, often containing just a branch. Their presence often
make things more complicated than needed (more work to do in later
phases, visual clutter when inspection the IR 'by hand') and they
can sometimes, indirectly hinder some optimizations.

Happily, most of them can trivially be optimized away.
So, add a CFG simplification phase running very early and doing:
*) jump threading (eliminate jump to jump)
*) merge single-child/sinle-parents basic blocks.

These changes slightly decrease the number of 'context imbalance'
warnings (32 less on a total of 995 warnings) and the size of
the generated IR (only ~0.4% but this is very significant relatively
to most other simplifications).

They also seem to improve the kernel tests' running time:
	before			after
	real   4m19.261s	real   4m17.548s
	user  72m03.634s	user  71m34.642s
	sys   29m05.573s	sys   29m01.856s
but it's probably just noise.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+78/-0), flow.h (+1/-0), optimize.c (+5/-0), validation/call-inlined.c (+4/-0), validation/expand/builtin_constant_inline0.c (+1/-0), ... and 7 more
--------------------------------------------------------------------------------

[6b5e7cf5ac39] 2020-11-17 18:03:24 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cfg: call simplify_memops() unconditionally.

Currently, in the main optimization loop, simplify_memops()
is only called if REPEAT_SYMBOL_CLEANUP have been set. This
has (at least) two problems:
1) simplify_memops() may itself create other 'symbol cleanup'
   opportunities. That's fine and when it happens REPEAT_SYMBOL_CLEANUP
   is correctly set but this is directly lost because repeat_phase
   is cleared just after. So, loads and stores are not always
   optimized away as they should.
2) Loads & stores are not always done directly on symbols, in
   fact, it often happens that they are done on some PSEUDO_REG.
   Here too, loads and stores are not always optimized away as
   they should.

So, call simplify_memops() unconditionally.

Note: this have only very small effects on the tests' running time:
	  before		after		  after too
	  real	 4m18.001s	real   4m18.655s  real	 4m19.4
	  user	71m32.911s	user  72m02.701s  user	72m06.6
	  sys	29m06.523s	sys   29m01.721s  sys	29m06.8
      which is under the noise I usually have.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: memops.c (+2/-0), optimize.c (+1/-3), validation/optim/memops-missed01.c (+23/-0), validation/optim/memops-missed02.c (+14/-0)
--------------------------------------------------------------------------------

[09474b0a451b] 2020-11-17 18:03:24 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cfg: add missing REPEAT_CFG_CLEANUP

simplify_branch() & insert_branch() convert a conditional branch
into an unconditional one, removing a child which may then
become unreachable.

However, these function doesn't set REPEAT_CFG_CLEANUP and the
unreachable child may not be removed.

Fix this by setting the missing REPEAT_CFG_CLEANUP in these functions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+1/-0), simplify.c (+1/-1)
--------------------------------------------------------------------------------

[5a7a06698fe2] 2020-11-17 18:03:18 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cfg: remove phi-nodes when merging BBs

When merging BBs, it's possible that the top BB feeds one or
several phi-nodes in the bottom BB. Since phi-nodes only make
sense for values incoming from the parent BBs, these phi-nodes
can and should be removed when merging the BBs.

So, when merging BBs, remove these related phi-nodes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+23/-0)
--------------------------------------------------------------------------------

[2fdaca9e7175] 2020-11-17 18:01:39 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cfg: remove phi-sources when merging BBs

When merging two basic blocks, it may happen that both of theses
blocks contain a phi-source for the same phi-node. In this case,
only the phi-source from the bottom BB must be taken in account,
it kinda overwrites the value from the top BB and the phi-source
from the top BB must be ignored, in fact it must be removed.

However, it is not the case and this extra phi-source creates
different kinds of problems. Among other things, it hinders
further simplifications. For example, the following code:

	extern int array[2];
	static inline int stupid_select(int idx)
	{
		if (idx)
			idx = 0;
		return array[idx];
	}
	int select(void)
	{
		int d = stupid_select(-1);
		return d;
	}

should boil down to a simple dereference of the array with
an index of zero, like:
	select:
		load.32     %r8 <- 0[array]
		ret.32      %r8

but currently gives:
	select:
		phisrc.32   %phi3(idx) <- $0xffffffff
		phisrc.32   %phi4(idx) <- $0
		phi.32      %r12(idx) <- %phi3(idx), %phi4(idx)
		sext.64     %r5 <- (32) %r12(idx)
		mul.64      %r6 <- %r5, $4
		add.64      %r7 <- %r6, array
		load.32     %r8 <- 0[%r7]
		ret.32      %r8

This patch takes care of the problem by:
* when merging 2 BBs, check when reaching a phi-source in the bottom BB
* if one is found, look after sibling phi-sources
* remove such sibling if belonging to the top BB.
With this change, the code above gives:
	select:
		phisrc.32   %phi4(idx) <- $0
		phi.32      %r12(idx) <- %phi4(idx)
		sext.64     %r5 <- (32) %r12(idx)
		mul.64      %r6 <- %r5, $4
		add.64      %r7 <- %r6, array
		load.32     %r8 <- 0[%r7]
		ret.32      %r8

which can the be simplified into the expected result.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+42/-0), validation/optim/merge_bbe-adjust_phi.c (+0/-1)
--------------------------------------------------------------------------------

[a6cb714a3903] 2020-11-16 15:31:53 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add header for optimization related documentation

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/api.rst (+1/-0), optimize.c (+6/-2)
--------------------------------------------------------------------------------

[cd5f1d0e1a08] 2020-11-16 15:31:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add some doc to flowgraph.h

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/api.rst (+1/-0), flowgraph.h (+20/-0)
--------------------------------------------------------------------------------

[efecd58e8d15] 2020-11-16 15:31:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: fix extracted autodoc when short description ends with a ?

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/sphinx/cdoc.py (+3/-2)
--------------------------------------------------------------------------------

[a2bff1c35c6d] 2020-11-16 15:31:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add some doc about using NULL or VOID in ptrlists

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ptrlist.c (+12/-0)
--------------------------------------------------------------------------------

[34bd9955394a] 2020-11-16 15:31:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: Sphinx's option ':noindex:' have been renamed into ':noindexentry:'

and instead of keeping the old name for compatibility, no it's rejected.
But well, purity of language is surely much more important than compatibility.
*long deep sigh*

So, use the new name (but it will for sure create problems when using
an older version of Sphinx).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/doc-guide.rst (+1/-1)
--------------------------------------------------------------------------------

[f4d847fc84d4] 2020-11-15 20:34:31 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cfg: extract merge_bb() from pack_basic_blocks()

Extract merge_bb() from pack_basic_blocks() in order to reuse this
part of the code in other simplification/finer grained version of
pack_basic_blocks().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flow.c (+35/-23)
--------------------------------------------------------------------------------

[8f1047988b88] 2020-11-15 20:34:26 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cfg: add testcase for phi-adjusting during BB merge

When merging BBs, phi-sources from the bottom BB should 'overwrite'
the ones from the top BB which should be ignored.

Add a testcase from the incoming fix.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/merge_bbe-adjust_phi.c (+24/-0)
--------------------------------------------------------------------------------

[27696c8a9601] 2020-11-15 20:34:26 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testcase: avoid UNDEF

Reduced testcases (with creduce, of course) often needlessly have
undefined variables. Since these are untouched by the simplification
code and should not be present in source code, they should be avoided
in optimization testcases.

So, defines 'x' to some value other than 0.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/cse-size.c (+3/-2)
--------------------------------------------------------------------------------

[90be5636395a] 2020-11-14 11:20:12 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add header for flow simplification related documentation

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/api.rst (+1/-0), flow.c (+4/-3)
--------------------------------------------------------------------------------

[af3512a6c585] 2020-11-12 01:07:31 +0100
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: linearize: fix a couple of 'selfcheck' warnings

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+2/-0)
--------------------------------------------------------------------------------

[d020cf332099] 2020-11-11 01:41:12 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'debug'

* do not call simplify_instruction() on removed instruction
* add debug helpers: show_insn_bb() & show_insn_entry()

Files: linearize.c (+18/-0), optimize.c (+2/-0), simplify.c (+0/-3)
--------------------------------------------------------------------------------

[984691660981] 2020-11-09 23:53:45 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'optim-cmp' into next

* simplify & canonicalize compares

Files: opcode.c (+2/-1), opcode.def (+82/-82), opcode.h (+6/-2), simplify.c (+199/-41), validation/optim/canonical-cmp.c (+14/-111), ... and 15 more
--------------------------------------------------------------------------------

[55d44f307c12] 2020-11-09 23:51:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'optim-sel' into next

* simplify SEL(SEL(...), ...)
* simplify SEL(x == y, x, y) and friends
* simplify SEL(x, x, x) and SEL(x, 0, x)

Files: simplify.c (+47/-12), validation/optim/call-inlined.c (+2/-9), validation/optim/eqne-select.c (+12/-0), validation/optim/select-constant-cond.c (+10/-0), validation/optim/select-same-args.c (+9/-0), ... and 4 more
--------------------------------------------------------------------------------

[94dbf5cc3a07] 2020-11-09 23:48:14 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix linear_isdigit()'s itype

The merge of the branch with the linear_isdigit() experiment
and the branch giving a type to OP_SETxx's arguments created
a semantic conflict: the compare used for the isidigt() builtin
needed the type too.

Fix this now.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+1/-0)
--------------------------------------------------------------------------------

[b5bbdc9c3835] 2020-11-08 02:31:18 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: select: simplify select(x, x, 0) --> x

The dual simplification select(x, 0, x) --> 0 was already
done but this one was forgotten, so add it now.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-0), validation/optim/call-inlined.c (+2/-9), validation/optim/select-self-zero.c (+1/-0)
--------------------------------------------------------------------------------

[29c405153720] 2020-11-08 02:29:17 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: select: simplify handling of select(x, 0, x) --> 0

This simplification is already handled but explicitly kills it's 2
operands while this is done automatically when killing the instruction.

Also, it uses replace_with_value(0) which needs to recreate the
pseudo for 0 while it's already available via its operands.

So, changes to use replace_with_pseudo() and without the unneeded kills.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-5), validation/optim/select-self-zero.c (+9/-0)
--------------------------------------------------------------------------------

[c60237251a55] 2020-11-08 02:16:26 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cmp: simplify compares and sign/zero extend

Compare instructions with both operands sign or zero-extended
from the same original size are equivalent to a compare of
the original values. If the values were zero-extended, a signed
compare becomes an unsigned one.

Simplify away the sign/zero-extensions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+42/-10), validation/optim/cmp-sext-sext.c (+0/-1), validation/optim/cmp-zext-zext.c (+0/-1)
--------------------------------------------------------------------------------

[cae6fa2f2d5a] 2020-11-08 02:16:24 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cmp: simplify zext(x) cmpu C

An unsigned compare of a zero-extended value against a
constant outside of the original range is statically known.

Simplify to the corresponding 0/1.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-0), validation/optim/cmp-zext-uimm2.c (+0/-1)
--------------------------------------------------------------------------------

[74d99ae4bd80] 2020-11-08 02:16:21 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cmp: simplify zext(x) cmps C

A signed compare of a zero-extended value against a constant
outside of the original range is statically known.

Simplify to the corresponding 0/1.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+14/-0), validation/optim/cmp-zext-simm.c (+0/-1)
--------------------------------------------------------------------------------

[4a5f616407e2] 2020-11-08 02:15:20 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cmp: canonicalize sext(x) cmpu C (with C >= SMAX)

A unsigned compare of a sign-extended value against a value
bigger than the original SMAX is equivalent to a signed
compare against 0.

Canonicalize to the signed compare against 0.

Note: ultimately both forms are just a test of the sign bit.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+12/-0), validation/optim/cmp-sext-uimm.c (+0/-1)
--------------------------------------------------------------------------------

[a1c1b9236d5d] 2020-11-08 02:15:14 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cmp: simplify sext(x) cmps {SMAX,SMIN}

A signed compare of a sign-extended value against a constant
outside of the original range is statically known.

Simplify to the corresponding 0/1.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+14/-0), validation/optim/cmp-sext-simm.c (+0/-1)
--------------------------------------------------------------------------------

[89b98b682930] 2020-11-08 02:14:14 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cmp: simplify zext(x) cmp C --> x cmp C

When doing a compare of a zero-extended value against a constant,
this extension can be dropped and the comparison done on the
original type if the constant is within the original range and
signed compares become the corresponding unsigned one.

Simplify away these sign-extensions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+11/-0), validation/optim/cmp-zext-uimm1.c (+0/-1), validation/optim/cmp-zext.c (+0/-1), validation/optim/zext-cmpu.c (+0/-1)
--------------------------------------------------------------------------------

[36329f5318dc] 2020-11-08 02:14:10 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cmp: simplify sext(x) cmp C --> x cmp C

When doing a compare of a sign-extended value against a constant
the, sign-extension can be dropped and the comparison done on the
original type if the constant is within the original range.

Simplify away these sign-extensions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+24/-0), validation/optim/cmp-sext.c (+0/-1)
--------------------------------------------------------------------------------

[983964c2ff72] 2020-11-08 02:13:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cmp: canonicalize unsigned (x {<=,>} SMAX)

Unsigned <= or > against SMAX are equivalent to testing if the
value is positive or not (when interpreted as a signed number).

Canonicalize to this positive/negative test since it only needs
the constant 0 which make it easier to handle at later steps.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-0), validation/optim/set-uimm3.c (+0/-1)
--------------------------------------------------------------------------------

[2680e82101a6] 2020-11-08 02:13:04 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cmp: canonicalize unsigned compare with UMAX or UMAX-1

Unsigned compares with UMAX (or UMAX-1) are equivalent to
equality tests. These are preferable since it's easier to reason
about them in other simplifications.

So canonicalize these compares to equality tests.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+8/-0), validation/optim/set-uimm2.c (+0/-1)
--------------------------------------------------------------------------------

[4146aecb9917] 2020-11-08 02:12:10 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cmp: simplify unsigned (x {<=,>} UMAX) into {1,0}

These compares are always true or false, so simplify them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+5/-0), validation/optim/set-uimm1.c (+0/-1)
--------------------------------------------------------------------------------

[c355e5ac5dce] 2020-11-08 02:12:06 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cmp: canonicalize unsigned (x {<,>=} C) --> (x {<=,>} C-1)

An unsigned comparison like (x < 3) is equivalent to (x <= 2).
Canonicalize '<' & '>=' to '<=' & '>', such that the smallest
constant is used.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+7/-1), validation/optim/canonical-cmpu.c (+0/-1)
--------------------------------------------------------------------------------

[85c234ab3cde] 2020-11-08 02:12:04 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cmp: use a few helpers for the simplification of compares

The current code for the simplification of compares is quite
simple but also repetitive because everything must be done 4 times,
one for each operations (<,<=,>=,>).

So, add 2 helpers to factor out the details of the common parts.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+32/-20)
--------------------------------------------------------------------------------

[452ea1741e58] 2020-11-08 02:12:01 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cmp: move some code in a separate function: simplify_compare_constant()

simplify_constant_rightside() contains a few simplification
regarding unsigned compares but much more can be done for
unsigned and signed ones.

So, move the current simplification in a separate function.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+43/-31)
--------------------------------------------------------------------------------

[bbcc6abac7af] 2020-11-08 02:11:55 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cmp: add signed/unsigned to opcode table

The opcode table allows to efficiently store some properties of
the IR instructions and the correspondence between some of them.

One of these correspondences the 'signed' / 'unsigned' version
of otherwise identical instructions. This is useful for some
transformation of compare instructions but is not present yet
in the table. So, add this now.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: opcode.c (+2/-1), opcode.def (+82/-82), opcode.h (+6/-2)
--------------------------------------------------------------------------------

[467fce304857] 2020-11-07 22:53:05 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify SEL(x == y, x, y) and friends

If the condition of a select instruction is a equality test of the
select's operands, then the result of the select is always the same as
its second operand. Same for the first operand with an inequality test.

Simplify away these selects.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+12/-0), validation/optim/eqne-select.c (+12/-0)
--------------------------------------------------------------------------------

[940c78544406] 2020-11-07 14:06:18 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add debug helpers: show_insn_bb() & show_insn_entry()

These 2 helpers are just small wrappers around show_instruction()
and show_entry() but can be called even when the instruction is
removed. They're just handy when debugging.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+18/-0)
--------------------------------------------------------------------------------

[c25293e689b0] 2020-11-07 12:29:13 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: select: simplify handling of constant cond or src1 == src2

If the operands of a select instruction are identical, then
this select can be replaced by its operand.
If the condition of a select is a constant, the this select
can be replaced by one of its condition, depending on the
truth value of the condition.

This simplification is already done but:
* when src1 == src2, the condition's value is tested although
  it may not be a constant. It's kinda OK because in all case
  one of the operand will be selected and both are identical
  but it's a bit weird and unclean.
* since the instruction will be replaced, the usage of its
  condition and operands must be removed. This is done here but
  the kill_instruction() inside replace_with_pseudo() take
  already care of this.

So, separate the two cases and simply use replace_with_pseudo()
for both without bothering killing the operands.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+6/-8)
--------------------------------------------------------------------------------

[84bf7462ebc8] 2020-11-07 12:27:49 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: select: simplify SEL(SEL(x, C1, C2), y, z) --> y (with C1, C2 != 0)

If the condition of a select is also a select, with constant
but non-zero operands, then the result of this inner select
is always true and the outer select can be replaced by its
second operand.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+3/-0), validation/optim/select-select-true-true.c (+0/-1)
--------------------------------------------------------------------------------

[93bb38fdbfb1] 2020-11-07 12:19:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: select: simplify SEL(SEL(x, C, 0), C, 0) --> SEL(x, C, 0) == cond

If the condition of a select is also a select, both with the same
arguments: first a non-zero constant, then a zero constant, then
the outer select is equivalent to the inner one and can thus
be replaced by the result of the inner select (which is its own
condition).

Note: this is a special case of:
	SEL(SEL(x, C, 0), y, z) --> SEL(x, y, z)
      and without this patch we'll have:
	t = SEL(x, C, 0)
	r = SEL(t, C, 0)
      simplified into:
	t = SEL(x, C, 0)	// possibly unused now
	r = SEL(x, C, 0)
      but the present patch do
	t = SEL(x, C, 0)
	r = t
      In other words, functionally, the result is the same but
      now the result is taken from the first instruction.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+3/-0)
--------------------------------------------------------------------------------

[7ccaa8a6e88a] 2020-11-07 12:08:31 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: select: simplify SEL(SEL(x, C, 0), y, z) --> SEL(x, y, z) and its dual

If the condition of a select is also a select but with constant
operands, some simplification can be done:
* if the second operand is 0, the original condition can be used,
* idem if the first operand is 0s but the operand must be swapped.

Originally-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+20/-0), validation/optim/select-select-true-false0.c (+0/-1), validation/optim/select-select-true-false1.c (+0/-1)
--------------------------------------------------------------------------------

[e58ddb5678f2] 2020-11-07 11:57:38 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: select: add some testcases for select simplification

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/select-constant-cond.c (+10/-0), validation/optim/select-same-args.c (+9/-0), validation/optim/select-select-true-false0.c (+11/-0), validation/optim/select-select-true-false1.c (+14/-0), validation/optim/select-select-true-true.c (+10/-0)
--------------------------------------------------------------------------------

[17c0dc052483] 2020-11-05 01:59:06 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cmp: add testcases for the simplification of compares

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/canonical-cmpu.c (+16/-0), validation/optim/cmp-sext-sext.c (+18/-0), validation/optim/cmp-sext-simm.c (+30/-0), validation/optim/cmp-sext-uimm.c (+26/-0), validation/optim/cmp-sext.c (+24/-0), ... and 10 more
--------------------------------------------------------------------------------

[ee854cb92c46] 2020-11-02 23:50:08 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cmp: adapt testcase for compares' canonicalization

The current testcase, because it's just checking test-linearize's
output as-is, is very sensitive to small simplification changes.

Fix this by changing the tests into equivalent tests and then just
checking that these tests return '1'. This allows to test only what
really matters for canonicalization and make these tests very robust.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/canonical-cmp.c (+14/-111)
--------------------------------------------------------------------------------

[f680124b794b] 2020-11-01 07:09:11 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'typed-cmp'

* give an explicit type to compare's operands

Files: Documentation/IR.rst (+1/-0), linearize.c (+12/-4), linearize.h (+4/-0), simplify.c (+13/-1), validation/optim/cmp-op-type.c (+18/-0), ... and 2 more
--------------------------------------------------------------------------------

[594c7389969f] 2020-11-01 01:04:16 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: eval_insn: add testcases for incorrect type in OP_SET_*

Because of the lack of type information, compare instruction are
not always handled correctly. So, add some testcases for this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/cmp-op-type.c (+18/-0), validation/optim/cmp-type0.c (+13/-0), validation/optim/cmp-type1.c (+16/-0)
--------------------------------------------------------------------------------

[0c7b00977c88] 2020-11-01 01:04:06 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: linearize __builtin_isdigit()

As an experiment about the linearization of builtins,
try this easy one (and statically expand it if the
argument is constant).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+21/-0), linearize.c (+22/-0), validation/expand/builtin_isdigit.c (+10/-0), validation/linear/builtin_isdigit.c (+12/-0)
--------------------------------------------------------------------------------

[abfaa2dfb4d6] 2020-11-01 01:04:06 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix usage count in linearize_fma()

When linearizing __builtin_fma(), the arguments were just
assigned but the corresponding usage was not tracked.

Fix this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+3/-3), validation/linear/builtin-fma.c (+1/-1)
--------------------------------------------------------------------------------

[7204b60f3756] 2020-11-01 01:04:06 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix init_linearized_builtins()

Hmmm ... the wrong pointer was updated. Fix this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[dc27965726cb] 2020-11-01 00:55:44 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add a new tag: check-output-returns

The current tags check-output-contains/excludes/pattern are
quite powerful and the new check-output-match is easy to use
but it can be even simpler. Indeed, a lot of IR simplifications/
canonicalizations can be tested by checking that the expression
to be tested is equivalent to another one. This is less precise
than some more specific tests but:
* it's a big advantage because it's less sensitive to 'noise'
  like the exact number used by the pseudos or to the results
  of some new simplifications or canonicalizations
* very often, this equivalence is what really matters and not
  the exact transformation.

So, add a new utra-simple-to-use tag: just ask that all functions
of the tests return the same specified value (usually 1):
	check-output-returns: <value>

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/test-suite.rst (+5/-0), validation/optim/testsuite.c (+1/-0), validation/test-suite (+27/-0)
--------------------------------------------------------------------------------

[74ba40fadc42] 2020-11-01 00:55:09 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add a new tag: check-output-match

The current tags check-output-contains/excludes/pattern are
quite powerful, universal, but they often need 'complex' regular
expressions with escaping which make them not so nice to read.

For testing IR results, a very common pattern is:
	this instruction must have this (kind of) operand.

So, make a new tag for this. It does nothing than can't be done
with done with the previous ones, on  the contrary, but is much
simpler to use:
	check-output-match(instruction): operand

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/test-suite.rst (+8/-0), validation/optim/testsuite.c (+12/-0), validation/test-suite (+27/-0)
--------------------------------------------------------------------------------

[c4d63655e576] 2020-11-01 00:40:57 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: do not call simplify_instruction() if already removed

simplify_instruction() is called on every instructions, even
those already removed. It's useless (and annoying when debugging).

So, filter out removed instructions before calling simplify_instruction().

Fixes: c5ba883e6ac47381f8112ed33f22a931a79ac517
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: optimize.c (+2/-0), simplify.c (+0/-3)
--------------------------------------------------------------------------------

[226b62bc2ee4] 2020-11-01 00:40:57 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: eval_insn: give an explicit type to compare's operands

The return type of IR instructions is stored in the field
::type of struct instruction and this struct has no space
to hold the type of the operand(s). This is not a problem
for most instructions because there is an easy way to get
the operands' type. For example, for binops both types
must be the same so they are used interchangeably.

However, for compare instructions both types can be different
and there is no easy way to get the type of the operands.
Currently, this is ignored and creates some errors. It
also blocks simplifications that need this type information.

But compares instructions need only 2 operands, there is
thus one 'slot' left. So, use this slot for the operands' type.
This solves the current errors, allows new simplifications
and has very little impact on existing code. Of course,
this type information needs now to be tracked and adjusted
whenever the operands change or an instruction is changed
into a compare.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.rst (+1/-0), linearize.c (+12/-4), linearize.h (+4/-0), simplify.c (+13/-1), validation/optim/cmp-type0.c (+0/-1), ... and 1 more
--------------------------------------------------------------------------------

[49c98aa3ed1b] 2020-10-27 06:19:25 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'one_use'

* replace nbr_users() & multi_users() by one_use()

Files: linearize.h (+2/-2), simplify.c (+9/-9)
--------------------------------------------------------------------------------

[6803f19583ea] 2020-10-27 06:16:13 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: replace nbr_users() & multi_users() by one_use()

During simplification, we're only interested to know if a pseudo
is used only once or more than once. This can be checked quicker
than getting the exact number of users.

So, replace the last call to nbr_users() and the calls to multi_users()
by a call to one_use() which has a slightly clearer name.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.h (+2/-2), simplify.c (+9/-9)
--------------------------------------------------------------------------------

[e1f9cbaefde9] 2020-10-27 06:10:18 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'cleanup-linearize', 'inline-use', 'inline-def', 'pure-call', 'old-style' and 'kill-dead'

* cleanup linearize_cond_branch()
* OP_INLINE should not use the function symbol
* add testcase for missing inline definition
* fix testing if a OP_CALL's function is pure
* warn on all missing parameter types
* kill dead instructions before any other simplifications

Files: lib.h (+5/-0), linearize.c (+6/-15), parse.c (+9/-1), simplify.c (+8/-49), validation/asm-bad0.c (+1/-1), ... and 5 more
--------------------------------------------------------------------------------

[0d6bb7e11565] 2020-10-26 05:52:42 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: handle more graciously labels with no statement

In C a label must precede a statement. A null statement is OK
but a closing braces is not.

So, catch this situation, emit a warning and continue as if a
null statement was there.

This occurs currently on v5.10-rc1 because of some ifdefery.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+5/-0)
--------------------------------------------------------------------------------

[218bb8a16589] 2020-10-25 13:56:37 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix testing if a OP_CALL's function is pure

kill_instruction() will kill an OP_CALL but only if it's a
forced kill or if the corresponding function is pure.

However, only functions called via a symbol pseudo are so killed.
Those called via a function pointer are not because only symbol
pseudos contain the function type needed to test the presence of
the MOD_PURE modifier.

Fix this by using the function type always available in the
instruction's ::fntypes member.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+3/-3)
--------------------------------------------------------------------------------

[b098088b394c] 2020-10-25 13:55:52 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add helper first_symbol()

This is just a wrapper around first_ptr_list().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.h (+5/-0)
--------------------------------------------------------------------------------

[90b4b36dc834] 2020-10-25 13:50:19 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: kill dead instructions before any other simplifications

Dead instructions are removed when simplify_instruction() is
called but this is done in various places, depending on the kind
of instructions, sometimes after other simplifications.

Change this by using the instruction's flag OPF_TARGET at the very
beginning of simplify_instruction() to test which instructions are
dead and thus can be removed.

Note: OP_CALLs are special here as they're considered as always
      returning a value but only calls to pure functions are
      removed. This is OK since pure functions should always
      return a value.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+5/-46)
--------------------------------------------------------------------------------

[8f7e21cadc21] 2020-10-25 13:30:02 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: OP_CALL should use the full function type

OP_CALL keep a list with the type of the function itself
and of each of its arguments.

However, the function type added to the list is not the complete type
but its base type. So, we can't use the function's modifiers or contexts.

Fix this by storing the complete function type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+0/-2)
--------------------------------------------------------------------------------

[7f33a71b3370] 2020-10-25 13:27:33 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: linearize: OP_INLINE should not use the function symbol

The instruction OP_INLINE is a kind of note or comment, indicating
that the code below it used to be the body of a function which has
now been inlined. The symbol of the original function is displayed
when this instruction is displayed but this symbol should not be
considered as being used by the instruction since there is no
dependency or def-use chain between the two.

So, replace the use_pseudo() by a simple assignment.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+1/-1)
--------------------------------------------------------------------------------

[c09e8239027f] 2020-10-24 23:37:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'optim-setuimm' and 'optim-unop' into next

* simplify and canonicalize unsigned compares
* basic unop simplifications

Files: simplify.c (+78/-5), validation/optim/set-uimm0.c (+14/-0), validation/optim/simplify-neg-add-cte.c (+11/-0), validation/optim/simplify-neg-not.c (+9/-0), validation/optim/simplify-neg-sub.c (+9/-0), ... and 4 more
--------------------------------------------------------------------------------

[19b19d0b8ea8] 2020-10-24 23:37:07 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'fix-llvm-11' into next

* llvm: fix crash with llvm-11 / use real phi-nodes

Files: sparse-llvm.c (+29/-46)
--------------------------------------------------------------------------------

[3b9ae3404df8] 2020-10-24 22:59:10 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unop: simplify ~(-x) --> x - 1

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-0), validation/optim/simplify-not-neg.c (+0/-1)
--------------------------------------------------------------------------------

[4fceb3aa691d] 2020-10-24 22:58:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unop: simplify ~(x ^ C) --> x ^ ~C

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+6/-0), validation/optim/simplify-not-xor-cte.c (+0/-1)
--------------------------------------------------------------------------------

[f96c229c9ae8] 2020-10-24 22:58:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unop: simplify ~(C - x) --> x + ~C

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+6/-0), validation/optim/simplify-not-sub-cte.c (+0/-1)
--------------------------------------------------------------------------------

[70a22c03f856] 2020-10-24 22:58:24 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unop: simplify ~(x + C) --> ~C - x

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+7/-0), validation/optim/simplify-not-add-cte.c (+0/-1)
--------------------------------------------------------------------------------

[f28372ddc5f1] 2020-10-24 22:57:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unop: simplify -(~x) --> x + 1

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-0), validation/optim/simplify-neg-not.c (+0/-1)
--------------------------------------------------------------------------------

[957741516256] 2020-10-24 22:57:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unop: simplify -(x - y) --> y - x

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-0), validation/optim/simplify-neg-sub.c (+0/-1)
--------------------------------------------------------------------------------

[851d925ad7aa] 2020-10-24 22:57:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unop: simplify -(x + C) --> -C - x

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+7/-0), validation/optim/simplify-neg-add-cte.c (+0/-1)
--------------------------------------------------------------------------------

[cea6a6faf6f7] 2020-10-24 22:56:24 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unop: prepare simplify_unop() to handle more cases

Currently, simplify_unop() can only handle the simplification of
-(-x) and ~(~x).

Prepare it to handle more cases.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+10/-5)
--------------------------------------------------------------------------------

[5c5dc0a95fd6] 2020-10-23 17:44:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: canonicalize unsigned compares against 0 or 1

Some unsigned compares against 0 or 1 are equivalent to testing
equality with 0 (x <= 0, x > 0, x < 1, x >= 1).

Canonicalize them to this later, more common form.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+20/-0), validation/optim/set-uimm0.c (+5/-1)
--------------------------------------------------------------------------------

[a80921db90cd] 2020-10-23 17:44:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify unsigned compares against 0

Some unsigned compares against 0 are always true or always false
(x < 0 or x >= 0). Simplify them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+10/-0), validation/optim/set-uimm0.c (+10/-0)
--------------------------------------------------------------------------------

[eedd7112255f] 2020-10-23 01:28:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cleanup linearize_cond_branch()

No functional changes here, just some more consistency:
* systematically use break instead of 'return VOID'
* remove some superfluous curlies
* remove some unneeded blank lines

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+5/-12)
--------------------------------------------------------------------------------

[29aab3ee2f7a] 2020-10-23 01:08:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unop: add testcases for unop simplifications

Add a few testcases for the simplification of unary operations.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/simplify-neg-add-cte.c (+12/-0), validation/optim/simplify-neg-not.c (+10/-0), validation/optim/simplify-neg-sub.c (+10/-0), validation/optim/simplify-not-add-cte.c (+12/-0), validation/optim/simplify-not-neg.c (+10/-0), ... and 2 more
--------------------------------------------------------------------------------

[e83195b56b45] 2020-10-23 00:51:18 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix crash with llvm-11 / use real phi-nodes

sparse-llvm crashes with LLVM-11. From what I can see, it's because
LLVM-11 doesn't like anymore that an instruction is first created
unattached to a basic block (LLVMClearInsertionPosition()) and
inserted at some later step (LLVMInsertIntoBuilder()). Since the
corresponding function still exist I suppose they're working correctly
and sparse-llvm somehow misuse them. I don't know.

However, this functionality is only used to create the alloca
instructions used to simulate the phi-nodes.

So, fix this crash by using real phi instructions for the phi-nodes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+29/-46)
--------------------------------------------------------------------------------

[8a1a0e4c6969] 2020-10-23 00:51:18 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: llvm: fix crash with llvm-11 / use real phi-nodes

sparse-llvm crashes with LLVM-11. From what I can see, it's because
LLVM-11 doesn't like anymore that an instruction is first created
unattached to a basic block (LLVMClearInsertionPosition()) and
inserted at some later step (LLVMInsertIntoBuilder()). Since the
corresponding function still exist I suppose they're working correctly
and sparse-llvm somehow misuse them. I don't know.

However, this functionality is only used to create the alloca
instructions used to simulate the phi-nodes.

So, fix this crash by using real phi instructions for the phi-nodes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse-llvm.c (+29/-46)
--------------------------------------------------------------------------------

[04c3c1e16a2b] 2020-10-22 07:25:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: warn on all missing parameter types

A warning is given for K&R parameters without type declaration
and these parameters are given an implicit type of int to
avoid several problems with false errors in the next stages.

However, this is only done for K&R functions with the optional
parameter type declarations. If the parameters has no type
declaration at all, no diagnostic is given and the type is left
as incomplete. In consequence, a function defined with a typo like
'int foo(oid)' instead of 'int foo(void)' is left undetected
(even with -Wold-style-definition and -Wstrict-prototypes enabled).

Fix this by:
1) adding the type check to declare_argument() so that
   all parameters have a real type.
2) downgrade the diagnostic to a warning for K&R functions.

Fixes: 6f7aa5e84dacec8e27a8d70090bba26a1a1276de
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+9/-1), validation/asm-bad0.c (+1/-1), validation/bad-type-twice0.c (+1/-2), validation/badtype2.c (+1/-0), validation/badtype3.c (+1/-0), ... and 1 more
--------------------------------------------------------------------------------

[c988415e7a89] 2020-10-22 07:04:36 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for missing inline definition

If the address of an inline function is taken, a definition
for this function must be emitted.

However, sparse only do this if this inline function is defined
before it is used.

So add a testcase for this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/inline-definition.c (+30/-0)
--------------------------------------------------------------------------------

[42363a630185] 2020-10-22 07:03:04 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: memops need long offsets

These days, declaring arrays bigger than 2GB or doing pointer
arithmetic with an offset larger than 2^31 is maybe not usual but
certainly not outrageous.

However, currently Sparse silently truncates 32 bits the offsets
of memory accesses.

So, fix this by using 64-bit offsets for memory accesses.
Also, use a signed type since these offsets can be negative.

Note: I had a really nice (real) example for this but the margin
      of this patch is too small for it (and now I've lost it).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+3/-3), linearize.h (+1/-1)
--------------------------------------------------------------------------------

[cfca7b4c6cb4] 2020-10-22 06:42:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'optim-base' into next

* essential OP_ADD & OP_SUB simplifications

Files: opcode.def (+25/-25), opcode.h (+5/-0), simplify.c (+211/-39), validation/optim/canonical-sub-cte.c (+9/-0), validation/optim/reassoc-op-op1.c (+14/-0), ... and 13 more
--------------------------------------------------------------------------------

[10fd1d83ecd9] 2020-10-21 05:27:27 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: optim: fix some testcases related to bitfield manipulation

The patterns used here were based on looser semantic for OP_{SEXT,TRUNC}.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/sext.c (+3/-4), validation/optim/trunc-or-shl.c (+5/-1)
--------------------------------------------------------------------------------

[2d3af347e4a2] 2020-10-20 23:22:38 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'bf-sign' into next

* teach sparse about -funsigned-bitfields
* let plain bitfields default to signed

Files: options.c (+3/-0), options.h (+1/-0), sparse.1 (+6/-0), symbol.c (+2/-2), validation/linear/bitfield-sign-default.c (+13/-0), ... and 5 more
--------------------------------------------------------------------------------

[a02413d4763b] 2020-10-20 22:35:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sub: simplify x + (y - x) --> y

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-0), validation/optim/simplify-same-addl-sub.c (+0/-1)
--------------------------------------------------------------------------------

[7635d5d7501c] 2020-10-20 22:35:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sub: simplify (x - y) + y --> x

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+5/-0), validation/optim/simplify-same-sub-addl.c (+0/-1)
--------------------------------------------------------------------------------

[7a6b487222ab] 2020-10-20 22:35:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sub: simplify x - (y + x) --> -y

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-0), validation/optim/simplify-same-subr-add.c (+0/-1)
--------------------------------------------------------------------------------

[dbe0117ce624] 2020-10-20 22:35:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sub: simplify x - (x + y) --> -y

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-0), validation/optim/simplify-same-subl-add.c (+0/-1)
--------------------------------------------------------------------------------

[43a7dfa578c3] 2020-10-20 22:35:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sub: simplify (x + y) - y --> x

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-0), validation/optim/simplify-same-add-subr.c (+0/-1)
--------------------------------------------------------------------------------

[3644b436dd8b] 2020-10-20 22:35:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sub: simplify (x + y) - x --> y

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+8/-0), validation/optim/simplify-same-add-subl.c (+0/-1)
--------------------------------------------------------------------------------

[623d958c6953] 2020-10-20 22:35:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add: simplify (-x + y) --> (y - x)

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+8/-0), validation/optim/simplify-neg-add.c (+0/-1)
--------------------------------------------------------------------------------

[26a8e420cd5b] 2020-10-20 22:35:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add: simplify (x + -y) --> (x - y)

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+15/-1), validation/optim/simplify-add-neg.c (+0/-1)
--------------------------------------------------------------------------------

[0c8f2a719d30] 2020-10-20 22:35:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sub: simplify (x - -y) --> (x + y)

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+15/-1), validation/optim/simplify-sub-neg.c (+0/-1)
--------------------------------------------------------------------------------

[d0329076fd9e] 2020-10-20 22:35:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sub: simplify (C - y) + D --> eval(C+D) - y

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+20/-0), validation/optim/simplify-cte-sub-addl.c (+0/-1)
--------------------------------------------------------------------------------

[c28f68be15db] 2020-10-20 22:35:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sub: simplify C - (D - z) --> z + eval(C-D)

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+8/-0), validation/optim/simplify-cte-sub-subr.c (+0/-1)
--------------------------------------------------------------------------------

[ee607141242f] 2020-10-20 22:35:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sub: simplify C - (y + D) --> eval(C-D) - y

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+18/-0), validation/optim/simplify-cte-sub-addr.c (+0/-1)
--------------------------------------------------------------------------------

[4afcbe027c4f] 2020-10-20 22:35:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sub: canonicalize (0 - x) into -x

Not really a simplification in itself but it make some other
simplification a little easier (already because there is one
argument less to be matched).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-0), validation/optim/simplify-zero-sub.c (+0/-1)
--------------------------------------------------------------------------------

[3d82d5de0425] 2020-10-20 22:35:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sub: reorganize handling of OP_{ADD,SUB}s with constant rightside

This is a preparatory step for more interesting changes later.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+11/-9)
--------------------------------------------------------------------------------

[f84345753574] 2020-10-20 22:35:41 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: reassoc: simplify (x # C) # K --> x # eval(C # K)

Do this simplification once for all associative binops.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+5/-0), validation/optim/reassoc-op-op1.c (+0/-1)
--------------------------------------------------------------------------------

[249f95bcf505] 2020-10-20 22:35:08 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: constants must be truncated to the operation's size

At expansion phase, when simplified, all constants are truncated
to the size of the operations that generate them.

This should be done during simplification too because:
*) if some constants are sometimes truncated and sometimes
   sign-extended, CSE will miss some opportunities.
*) it's not possible to sign-extend them because it's not
   always known if the constant is used in a signed context or not.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+1/-1), validation/optim/canonical-sub-cte.c (+0/-1)
--------------------------------------------------------------------------------

[e51008eb29cc] 2020-10-20 22:35:08 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add a flag to identify commutative & associative ops

The way how the functions doing the simplification of commutative
or associative binops are called is simple but complicates the
simplification of a specific binop.

Fix this by adding a flag to the opcode table to identify the
commutative and the associative binops and using this flag
to call or not the functions doing the corresponding simplification.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: opcode.def (+25/-25), opcode.h (+5/-0), simplify.c (+46/-23)
--------------------------------------------------------------------------------

[ce5f04a050cb] 2020-10-20 22:35:08 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unop: add helper replace_with_unop()

Some simplifications reduce to transforming a binop into an unop.
Add an helper for making this change easier and more readable.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+14/-0)
--------------------------------------------------------------------------------

[97e6515a7944] 2020-10-20 22:35:08 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unop: add helper eval_unop()

Currently, eval_op() only do the evaluation of binops but unops
need sometimes to be evaluated too.

So, teach eval_op() about OP_NEG & OP_NOT and add a new helper,
eval_unop() for making it easier to use with unops.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+12/-0)
--------------------------------------------------------------------------------

[2bd6dd27dd4d] 2020-10-20 22:35:05 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: extract eval_op() from eval_insn()

eval_insn() can be handy when there is an existing instruction
to evaluate but it can happen that there isn't one, only pseudos.

Allow to reuse the evaluation code by using a new API: eval_op()
extracted from eval_insn() and taking all its input as arguments
(opcode, size, src1 & src2).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+9/-5)
--------------------------------------------------------------------------------

[e54859fe6da3] 2020-10-20 22:34:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: let switch_pseudo() return REPEAT_CSE

It make some uses easier and more compact.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-1)
--------------------------------------------------------------------------------

[9c808cbc7c57] 2020-10-20 22:34:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases about OP_ADD & OP_SUB simplifications

Add some testcases about basic simplifications of additions
and subtractions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/canonical-sub-cte.c (+10/-0), validation/optim/reassoc-op-op1.c (+15/-0), validation/optim/simplify-add-neg.c (+10/-0), validation/optim/simplify-cte-sub-addl.c (+10/-0), validation/optim/simplify-cte-sub-addr.c (+10/-0), ... and 10 more
--------------------------------------------------------------------------------

[7f33e55f0b4b] 2020-10-19 20:46:08 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'builtin-atomic' into next

* fix and complete the evaluation of atomic builtins

Files: builtin.c (+82/-32), predefine.c (+7/-0), symbol.c (+6/-0), symbol.h (+2/-0), validation/builtin-atomic-clear.c (+15/-0), ... and 1 more
--------------------------------------------------------------------------------

[9e8c9fc89934] 2020-10-19 18:07:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add support for remaining atomic builtins

Nothing special for these ones, just plain functions with fixed
types and arity.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+5/-0)
--------------------------------------------------------------------------------

[50917d27ebf9] 2020-10-19 18:07:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add support for __atomic_clear()

The first argument is supposed to be a pointer to a bool, but
of course, a volatile qualified pointer should be accepted too.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+1/-0), validation/builtin-atomic-clear.c (+15/-0)
--------------------------------------------------------------------------------

[08f2b69e8c90] 2020-10-19 18:07:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add builtin type: [volatile] pointer to bool

This builtin type is needed for __atomic_clear()'s prototype.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+3/-0), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[f42e2afa9ed0] 2020-10-19 18:07:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add support for others generic atomic builtins

Reuse the generic method for all these builtins.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+10/-0)
--------------------------------------------------------------------------------

[7cdf84691f33] 2020-10-19 18:07:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add support for __atomic_add_fetch(), ...

Reuse the generic method for all these builtins.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+12/-0)
--------------------------------------------------------------------------------

[cf8f104749f5] 2020-10-19 18:07:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add predefines for __ATOMIC_RELAXED & friends

The __atomic_*() builtins take an int argument to specify the
desired memory ordering. The different admissible values are
predefined by the compiler, so do that too for Sparse.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: predefine.c (+7/-0)
--------------------------------------------------------------------------------

[2220ca2b3264] 2020-10-19 18:07:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: __sync_synchronize() too is variadic

This builtin was marked as taking no argument but is in fact
variadic (like all the __sync_* builtins).

Fix this by marking it as being variadic.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+1/-1)
--------------------------------------------------------------------------------

[707f503d737e] 2020-10-19 18:07:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: fix evaluation of __sync_lock_release

It must use the generic method too.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+1/-1)
--------------------------------------------------------------------------------

[53149d7bd249] 2020-10-19 18:07:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: evaluate __sync_*_fetch*()

Reuse the generic method for all these builtins.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+13/-13), validation/builtin-sync-fetch.c (+24/-0)
--------------------------------------------------------------------------------

[2b75d15ea289] 2020-10-19 18:07:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: make eval_sync_compare_and_swap() more generic

Most __sync_* or __atomic_* builtin functions have one or
more arguments having its real type determined by the first
argument: either the same type (a pointer to an integral type)
or the type of the object it points to.

Currently, only __sync_{bool,val}_compare_and_swap() are handled
but lots of very similar variants would be needed for the others.
So, make it a generic function, able to handle all these builtins.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+32/-17)
--------------------------------------------------------------------------------

[efa1869dd78b] 2020-10-19 03:37:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'warn-address-builtin' into next

[Auto-summary] Modifies evaluate.c. Adds/updates 1 test(s). Changes: +19/-10 in 2 file(s)

Files: evaluate.c (+4/-0), validation/builtin-arith.c (+15/-10)
--------------------------------------------------------------------------------

[6746138ae86a] 2020-10-18 17:45:21 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Sparse v0.6.3

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/release-notes/v0.6.3.rst (+3/-2), Makefile (+1/-1)
--------------------------------------------------------------------------------

[5111ba3b6085] 2020-10-16 22:40:39 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix null pointer deref on return expression with invalid type

If the evaluation of the return expression failed a following test
can dereference the pointer holding the expression's type ...
which is null. Bad.

Fix this by adding the missing null pointer test.

Fixes: 3bc32d46494c404df7905fceaca9156830ff97f1
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-1), validation/crash-undef-in-parens.c (+9/-0)
--------------------------------------------------------------------------------

[e5fcbcae746e] 2020-10-16 16:55:39 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: warn when taking the address of a built-in function

Built-in functions are meant to be expanded by the compiler. As such,
they don't have an address.

So, issue an error when trying take the address of a built-in function.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+4/-0), validation/builtin-arith.c (+15/-10)
--------------------------------------------------------------------------------

[8e2d387944f0] 2020-10-16 16:55:04 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: fix location of error messages

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/builtin-arith.c (+3/-3)
--------------------------------------------------------------------------------

[368fd9cefe6c] 2020-10-14 21:49:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: update TODO list

A few things are now done, remove them from the list,
and add a few things that should be done.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/TODO.md (+21/-8)
--------------------------------------------------------------------------------

[8bbc2898b1e7] 2020-10-14 21:49:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: flex-array: fix typo in warning message

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+1/-1), validation/flex-array-nested.c (+2/-2)
--------------------------------------------------------------------------------

[7680a83e7668] 2020-10-14 17:48:17 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add builtin type for volatile void *

This is the type of most __sync_* or __atomic_* builtins.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+3/-0), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[617e82a88719] 2020-10-14 17:48:17 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add generic .args method

The arity of builtin functions can be retrieved from their prototype.
So, create a generic .args method, doing the evaluation of all
arguments present in the prototype.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+7/-0)
--------------------------------------------------------------------------------

[5192dc1ff23d] 2020-10-12 00:29:05 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Sparse v0.6.3-rc1

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/release-notes/index.rst (+1/-0), Makefile (+1/-1)
--------------------------------------------------------------------------------

[cdd89e72d0b8] 2020-10-12 00:06:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add release notes for incoming v0.6.3

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/release-notes/v0.6.3.rst (+54/-4)
--------------------------------------------------------------------------------

[85db025243f3] 2020-10-11 17:20:10 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'more-builtin' (early part)

* builtin: teach sparse about __builtin_ia32_pause()

Files: target-x86.c (+8/-0)
--------------------------------------------------------------------------------

[f8620c949b50] 2020-10-09 18:24:58 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: teach sparse about __builtin_ia32_pause()

This builtin is used by Open vSwitch, so teach Sparse about it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-x86.c (+8/-0)
--------------------------------------------------------------------------------

[8d5756f55040] 2020-10-09 18:07:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: flex-array: fix location for nesting of flexible members

The warning about the nesting of flexible array members is
given with the location of the outer struct or union but
that is not very interesting. What is needed is the location
of the member causing this nesting.

So, fix the warning message to use the member's location.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+1/-1), validation/flex-array-nested.c (+2/-2)
--------------------------------------------------------------------------------

[0c6896f449e8] 2020-10-09 17:28:49 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'misc'

[Auto-summary] Modifies simplify.c. Updates header lib.h. Adds/updates 1 test(s). Modifies build system. Changes: +5/-9 in 5 file(s)

Files: Makefile (+1/-1), lib.h (+1/-1), opcode.def (+0/-2), simplify.c (+2/-4), validation/optim/canonical-mul.c (+1/-1)
--------------------------------------------------------------------------------

[26f670cfb694] 2020-10-09 17:28:36 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'usual-conv'

[Auto-summary] Modifies evaluate.c. Adds/updates 2 test(s). Changes: +47/-32 in 3 file(s)

Files: evaluate.c (+36/-31), validation/linear/bool-cast-lp32.c (+0/-1), validation/usual-conv-lp32.c (+11/-0)
--------------------------------------------------------------------------------

[b5d46df743be] 2020-10-09 17:06:46 +0200
Author: Ilya Maximets <i.maximets@ovn.org>
Subject: flex-array: allow arrays of unions with flexible members.

There is a common pattern on how to allocate memory for a flexible-size
structure, e.g.

  union {
      struct flex f;  /* Structure that contains a flexible array. */
      char buf[MAX_SIZE];  /* Memory buffer for structure 'flex' and
                              its flexible array. */
  };

There is another example of such thing in CMSG manpage with the
alignment purposes:

  union {         /* Ancillary data buffer, wrapped in a union
                     in order to ensure it is suitably aligned */
      char buf[CMSG_SPACE(sizeof(myfds))];
      struct cmsghdr align;
  } u;

Such unions could form an array in case user wants multiple
instances of them.  For example, if you want receive up to
32 network packets via recvmmsg(), you will need 32 unions like 'u'.
Open vSwitch does exactly that and fails the check.

So, add a new option, -W[no-]flex-array-union, to enable or disable
any warning concerning flexible arrays and unions. This option needs
at least one of -Wflex-array-{array,nested,union} to be enabled in
order to have any effect.

Signed-off-by: Ilya Maximets <i.maximets@ovn.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: options.c (+2/-0), options.h (+1/-0), sparse.1 (+9/-0), symbol.c (+1/-1), validation/flex-array-union-array-no.c (+9/-0), ... and 2 more
--------------------------------------------------------------------------------

[56b9d0afc2dc] 2020-10-08 13:45:02 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix usual conversion of integers

The current implementation of the usual conversion doesn't handle
correctly the case of 'long' + 'unsigned int' on a 32-bit arch.
The resulting type is 'unsigned int' instead of 'unsigned long'.

Fix this by following closely the C99's wording.
This now gives the expected result for C89 & C99 on 32 & 64-bit archs
(as tested with the GCC testsuite).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+34/-31), validation/usual-conv-lp32.c (+11/-0)
--------------------------------------------------------------------------------

[b6a937a18d3b] 2020-10-08 13:44:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix evaluation of pointer to bool conversions

The pointer to bool conversion used an indirect intermediate
conversion to an int because the pointer was compared to 0
and not to a null pointer. The final result is the same
but the intermediate conversion generated an unneeded OP_PTRTOU
instruction which made some tests to fail.

Fix this by directly comparing to a null pointer of the same
type as the type to convert.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+2/-0), validation/linear/bool-cast-lp32.c (+0/-1)
--------------------------------------------------------------------------------

[a28fcdabb7cf] 2020-10-08 02:52:36 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: rule for validation needs to be FORCEd

The Makefile contains a rule for launching a test from the testsuite
but we want these tests to run even if when their dependencies are
up-to-date.

So, add 'FORCE' in the dependency list.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[1ba7c820275c] 2020-10-08 00:26:43 +0200
Author: Ilya Maximets <i.maximets@ovn.org>
Subject: add helpers is_struct_type() &  is_union_type()

Signed-off-by: Ilya Maximets <i.maximets@ovn.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+14/-0)
--------------------------------------------------------------------------------

[bf0e2bd3c86a] 2020-10-06 18:35:39 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: unop: fix access to defining instruction in simplify_unop()

Only pseudos of type PSEUDO_REG have a defining instruction.

However, in commit 5425db10d4d3 ("simplify '~(~x)' and '-(-x)' to 'x'"),
this defining instruction of the 'src' of the outer unop
was accessed without checking the type.

Fixes: 5425db10d4d35895ba3ca390478c624233ec027d
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+2/-4)
--------------------------------------------------------------------------------

[735ac5d051fb] 2020-10-06 18:32:50 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove definition of removed OP_{AND,OR}_BOOL

These instructions have been removed years ago, in 2016
but the corresponding opcode defines have been forgotten.

So remove them now.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: opcode.def (+0/-2)
--------------------------------------------------------------------------------

[c0e96d6d3b95] 2020-10-06 02:31:25 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'flex-array-base'

[Auto-summary] Modifies 3 source files: evaluate.c, options.c, symbol.c. Updates 2 headers. Adds/updates 5 test(s). Changes: +177/-18 in 11 file(s)

Files: evaluate.c (+3/-0), options.c (+6/-0), options.h (+3/-0), sparse.1 (+21/-0), symbol.c (+30/-18), ... and 6 more
--------------------------------------------------------------------------------

[ce9cf5b77cd8] 2020-10-06 02:27:22 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: flex-array: remove unneeded test

This test was for a failed experience. Remove it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/flex-array-padding.c (+0/-22)
--------------------------------------------------------------------------------

[efc02e9ee225] 2020-10-05 12:56:10 +0200
Author: Ben Dooks <ben.dooks@codethink.co.uk>
Subject: evaluate: check variadic argument types against format string

The variadic argument code did not check any of the variadic arguments
as it did not previously know the possible type. Now we have the possible
formatting information stored in the ctype, we can do some checks on the
printf formatting types.

Signed-off-by: Ben Dooks <ben.dooks@codethink.co.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), builtin.c (+1/-1), evaluate.c (+8/-4), evaluate.h (+10/-1), options.c (+2/-0), ... and 8 more
--------------------------------------------------------------------------------

[375690b61e8e] 2020-10-05 12:56:10 +0200
Author: Ben Dooks <ben.dooks@codethink.co.uk>
Subject: parse: initial parsing of __attribute__((format))

Add code to parse the __attribute__((format)) used to indicate that
a variadic function takes a printf-style format string and where
those are. Save the data in ctype ready for checking when such an
function is encountered.

Signed-off-by: Ben Dooks <ben.dooks@codethink.co.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+74/-1), symbol.h (+15/-2), validation/varargs-format-bad.c (+0/-1)
--------------------------------------------------------------------------------

[a53fa379c76d] 2020-10-05 12:53:13 +0200
Author: Ben Dooks <ben.dooks@codethink.co.uk>
Subject: tests: add varargs printf format tests

Add some tests for the new printf format checking code.
Note, these do not all pass yet.

Signed-off-by: Ben Dooks <ben.dooks@codethink.co.uk>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/varargs-format-addrspace1.c (+37/-0), validation/varargs-format-bad.c (+19/-0), validation/varargs-format-checking.c (+21/-0), validation/varargs-format-position.c (+32/-0), validation/varargs-format-prefix.c (+20/-0), ... and 2 more
--------------------------------------------------------------------------------

[60e6eff80b7d] 2020-10-05 12:52:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add helper get_nth_expression()

This will be used for -Wformat.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.h (+5/-0)
--------------------------------------------------------------------------------

[b9453d0493bc] 2020-10-04 13:42:10 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add builtin types for size_t*, intmax_t* & ptrdiff_t*

This is needed for printf format checking of "%zn", "%jn" & "%tn".

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+8/-0), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[a6d459c66773] 2020-10-04 13:42:10 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add builtin types for signed char* and short *

This is needed for printf format checking of "%hhn" & "%hn".

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+3/-0), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[0f50030dccb2] 2020-10-04 13:42:10 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add builtin type for wide strings

This is needed for printf format checking of "%Ls".

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+8/-0), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[7f816fc3cd71] 2020-10-01 01:40:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: fix erroneous comment

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/optim/canonical-mul.c (+1/-1)
--------------------------------------------------------------------------------

[304e4d065ca4] 2020-10-01 01:38:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix Hurd PATH_MAX ...

The fix quickly added for Hurd not defining PATH_MAX is not correct:
the local define must be guaranteed to be done only after <limits.h>
is included, which is not.

Since this problem only exists with Hurd, simply conditionalize
the local define by __gnu_hurd__. Horrible but well ... Hurd.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.h (+1/-1)
--------------------------------------------------------------------------------

[02ed28909f3b] 2020-10-01 00:46:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: flex-array: warn on flexible array in nested aggregate types

A structure or a union containing another aggregate type containing,
possibly recursively, a flexible array is quite error prone and make
not much sense. So, add an option -Wflexible-array-nested to warn
on such usage.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: options.c (+2/-0), options.h (+1/-0), sparse.1 (+7/-0), symbol.c (+4/-0), validation/flex-array-nested.c (+0/-1)
--------------------------------------------------------------------------------

[8b187dd493fb] 2020-10-01 00:45:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: flex-array: warn an arrays containing a flexible array

An array of some aggregate type containing, possibly recursively,
a flexible array is pretty non-sensical. So, add an option
-Wflexible-array-array to warn on such usage.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: options.c (+2/-0), options.h (+1/-0), sparse.1 (+7/-0), symbol.c (+2/-0), validation/flex-array-array.c (+0/-1)
--------------------------------------------------------------------------------

[1a88f2f24619] 2020-10-01 00:45:21 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: flex-array: warn when using sizeof() on a flexible array

Using sizeof() on a structure containing a flexible array
will ignore the 'flexible' part. This is maybe what is expected
but maybe not, so add an option -Wflexible-array-sizeof to
warn on such usage.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+3/-0), options.c (+2/-0), options.h (+1/-0), sparse.1 (+7/-0), validation/flex-array-sizeof.c (+0/-1)
--------------------------------------------------------------------------------

[58721d6e25e1] 2020-10-01 00:44:54 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: flex-array: add helper has_flexible_array()

This will make later checks easier & clearer.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+7/-0)
--------------------------------------------------------------------------------

[bf3144077b3d] 2020-10-01 00:44:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: flex-array: identify structures with a flexible array member

Structures containing a flexible array must not be nested.
So, as a preparatory step, detect structures or union containing
a flexible array, possibly recursively and mark the corresponding
type with a dedicated flag.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+6/-0), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[aa64a1b91cfb] 2020-10-01 00:44:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: flex-array: warn if flexible array is not last

Flexible array members must be the last in a structure.
Warn if it is not the case.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+2/-0), validation/flex-array-error.c (+0/-1)
--------------------------------------------------------------------------------

[b6d76fee64b9] 2020-10-01 00:44:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: flex-array: warn on flexible arrays in unions

Flexible array members are not allowed in unions.
So, warn if one is present.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+3/-0)
--------------------------------------------------------------------------------

[d54f252497a0] 2020-10-01 00:44:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: flex-array: detect structures with a flexible array member

This is a preparatory step for doing the checks and warnings.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+2/-0)
--------------------------------------------------------------------------------

[71ddf37a17ea] 2020-10-01 00:44:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: flex-array: flexible array members have zero size and alignment is OK

When doing the layout of structures, flexible arrays used to
not align the resulting structure size.

However, the standard specify that while for most purposes
flexible arrays can be handled as if not present, they still
may add some trailing padding (cfr. C11's 6.7.2.1p18).

So, there is no reason to reset the alignment.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+0/-1), validation/flex-array-align.c (+0/-1)
--------------------------------------------------------------------------------

[338dd771d713] 2020-10-01 00:44:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: flex-array: do not lay out invalid struct members

Do not bother trying to lay out invalid struct members,
ignore them as it will avoid to special case them later.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+4/-2)
--------------------------------------------------------------------------------

[e5b7d1ecb842] 2020-10-01 00:44:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: flex-array: factor out common part of lay_out_{struct,union}()

This is a preparatory step for later patches.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+8/-16)
--------------------------------------------------------------------------------

[644f20bb0e0a] 2020-10-01 00:44:49 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: flex-array: add testcases

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/flex-array-align.c (+19/-0), validation/flex-array-array.c (+16/-0), validation/flex-array-error.c (+27/-0), validation/flex-array-nested.c (+30/-0), validation/flex-array-padding.c (+22/-0), ... and 1 more
--------------------------------------------------------------------------------

[517177692e00] 2020-09-16 23:19:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse about -funsigned-bitfields

Currently, Sparse treats 'plain' bitfields as unsigned.

However, this is this is inconsistent with how non-bitfield integers
are handled and with how GCC & clang handle bitfields.

So, teach sparse about '-funsigned-bitfields' and by default treat
these bitfields are signed, like done by GCC & clang and like done
for non-bitfield integers.

Also, avoid plain bitfields in IR related testcases.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: options.c (+3/-0), options.h (+1/-0), sparse.1 (+6/-0), symbol.c (+2/-2), validation/linear/bitfield-sign-default.c (+13/-0), ... and 5 more
--------------------------------------------------------------------------------

[24bdaac6682c] 2020-09-07 00:58:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'linear-fma' into next

* add support for a new instruction: OP_FMA
* teach sparse to linearize __builtin_fma()

Files: Documentation/IR.rst (+7/-0), builtin.c (+3/-0), linearize.c (+27/-2), opcode.def (+1/-0), validation/linear/builtin-fma.c (+19/-0)
--------------------------------------------------------------------------------

[814cda15f647] 2020-09-07 00:57:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: teach sparse to linearize __builtin_fma()

The support for the linearization of builtins was already
added for __builtin_unreachable() but this builtin has
no arguments and no return value.

So, to complete the experience of builtin linearization,
add the linearization of __builtin_fma().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+20/-0), validation/linear/builtin-fma.c (+19/-0)
--------------------------------------------------------------------------------

[5c86c487ea5e] 2020-09-07 00:57:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add declaration for __builtin_fma{,f,l}()

The motivation for this is to experiment with adding infrastructure
for the linearization of builtins.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+3/-0)
--------------------------------------------------------------------------------

[78d7bdb29a92] 2020-09-07 00:57:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: allow linearization to fail

Allow the linearization of builtins to fail and continue with
the normal linearization of OP_CALLs. The motivation for this
is for the linearization of target specific builtins.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+5/-2)
--------------------------------------------------------------------------------

[9937d33bf945] 2020-09-07 00:56:06 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support for a new instruction: OP_FMADD

This will be the instruction for fused multiply-add
but the motivation for it is some experimentation with
the linearization of builtins.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.rst (+7/-0), linearize.c (+2/-0), opcode.def (+1/-0)
--------------------------------------------------------------------------------

[7524a9a874a7] 2020-09-07 00:02:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'replace-with-val' into next

* add & use replace_with_value()

Files: simplify.c (+15/-14)
--------------------------------------------------------------------------------

[859bbdd93e8f] 2020-09-06 23:56:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: easier testing via script & makefile

With this change, using the testsuite via the Makefile is not
limited anymore to a single file.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+2/-2)
--------------------------------------------------------------------------------

[554f3b2ca09f] 2020-09-05 14:09:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: replace_with_{pseudo,value}() can be tail-calls

This avoids the need to have a separate 'return REPEAT_CSE' and
thus make the code slightly more compact and fast to read.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+4/-8)
--------------------------------------------------------------------------------

[e25db16860b2] 2020-09-05 13:34:08 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use replace_with_value()

Replace existing 'replace_with_pseudo(insn, value_pseudo($N))'
by 'replace_with_value($N)'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+8/-8)
--------------------------------------------------------------------------------

[cedc66458ddd] 2020-09-05 13:32:09 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add helper replace_with_value()

During simplification, it's relatively common to have to replace
an instruction with pseudo corresponding to a known value.
The pseudo can be created with value_pseudo() and the replacement
can be made via replace_with_pseudo() but the combination
of the two is a bit long.

So, create an helper doing both sat once: replace_with_value().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: simplify.c (+5/-0)
--------------------------------------------------------------------------------

[101649206777] 2020-08-18 22:00:41 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'union-cast' into master

* teach sparse about union casts

Files: Documentation/release-notes/v0.6.3.rst (+5/-0), evaluate.c (+68/-20), options.c (+2/-0), options.h (+1/-0), sparse.1 (+6/-0), ... and 2 more
--------------------------------------------------------------------------------

[ad7af4347d27] 2020-08-18 22:00:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'pointer-arith' into master

* fix evaluate_ptr_add() when sizeof(offset) != sizeof(pointer)

Files: evaluate.c (+2/-2), validation/linear/pointer-arith32.c (+94/-0), validation/linear/pointer-arith64.c (+79/-0)
--------------------------------------------------------------------------------

[bdcf20485487] 2020-08-18 21:59:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'past-deep'

* conditionalize warning "advancing past deep designator"

Files: evaluate.c (+2/-2), options.c (+2/-0), options.h (+1/-0), sparse.1 (+7/-0)
--------------------------------------------------------------------------------

[aa6ede3b4d9d] 2020-08-18 06:31:35 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'cleanup' into master

* cleanup: remove unneeded predeclaration of evaluate_cast()

Files: evaluate.c (+0/-2)
--------------------------------------------------------------------------------

[93200fb123a0] 2020-08-18 06:30:09 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unneeded predeclaration of evaluate_cast()

evaluate_cast() is predeclared in the middle of the file but
is not used before it's defined.

So, remove this unneeded predeclaration.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+0/-2)
--------------------------------------------------------------------------------

[b987e1d13196] 2020-08-17 05:18:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix evaluate_ptr_add() when sizeof(offset) != sizeof(pointer)

For a binary op, both sides need to be converted to the resulting
type of the usual conversion. For a compound-assignment (which
is equivalent to a binary op followed by an assignment), the LHS
can't be so converted since its type needs to be preserved for
the assignment, so only the RHS is converted at evaluation and
the type of the RHS is used at linearization to convert the LHS.

However, in the case of pointer arithmetics, a number of shortcuts
are taken and as a result additions with mixed sizes can be produced
producing invalid IR.

So, fix this by converting the RHS to the same size as pointers,
as done for 'normal' binops.

Note: On 32-bit kernel, this patch also removes a few warnings
      about non size-preserving casts. It's fine as these warnings
      were designed for when an address would be stored in an
      integer, not for storing an offset like it's the case here.

Reported-by: Valentin Schneider <valentin.schneider@arm.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+2/-2), validation/linear/pointer-arith32.c (+94/-0), validation/linear/pointer-arith64.c (+79/-0)
--------------------------------------------------------------------------------

[8b3cbf54ad42] 2020-08-17 00:38:46 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: union-cast: teach sparse about union casts

A cast to union type is a GCC extension similar to a compound
literal just for union, using the syntax of a cast.

However, sparse doesn't know about them and treats them like
other casts to non-scalars.

So, teach sparse about them, convert them to the corresponding
compound literal and add a warning flag to enable/disable the
associated warning: -W[no-]union-cast.

Note: a difference between union casts and compound literals
      is that the union casts yield rvalues while compound
      literals are lvalues but this distinction is not yet done
      in this series.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/release-notes/v0.6.3.rst (+5/-0), evaluate.c (+46/-1), options.c (+2/-0), options.h (+1/-0), sparse.1 (+6/-0), ... and 2 more
--------------------------------------------------------------------------------

[c42c30946902] 2020-08-17 00:08:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix typo in warning

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[8b5d92da3b19] 2020-08-15 17:08:07 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: union-cast: extract evaluate_compound_literal()

extract evaluate_compound_literal() from evaluate_cast,
in preparation for supporting union casts.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+22/-19)
--------------------------------------------------------------------------------

[c73a5a4bbcb3] 2020-08-15 17:08:03 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: union-cast: add some testcases

Casts to union type are a GCC extension and are similar to
compound literals.

However, sparse doesn't know about them and treats them like
other casts to non-scalars.

Add some testcases for this and its upcoming warning flag.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/eval/union-cast-no.c (+24/-0), validation/eval/union-cast.c (+25/-0)
--------------------------------------------------------------------------------

[49f7e13a7ac9] 2020-08-12 21:06:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'doc-next'

* doc: more compact sidebar
* doc: use shorter titles
* doc: reorganize the table of content

Files: Documentation/IR.rst (+2/-2), Documentation/conf.py (+7/-1), Documentation/dev-options.rst (+2/-2), Documentation/doc-guide.rst (+2/-2), Documentation/index.rst (+15/-11), ... and 2 more
--------------------------------------------------------------------------------

[fc064f991e39] 2020-08-12 21:05:50 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'fix-scalar'

* fouled types are scalars too (fix is_{scalar,integral}_type()

Files: symbol.h (+2/-0), validation/foul-scalar.c (+13/-0)
--------------------------------------------------------------------------------

[5d038837ebea] 2020-08-11 22:23:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix is_scalar_type(): fouled types are scalars too

is_scalar_type() accept SYM_RESTRICT but not SYM_FOULED
but both are for integer types (and only for them).

So, let it accept SYM_FOULED too. Same for is_integral_type().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+2/-0), validation/foul-scalar.c (+13/-0)
--------------------------------------------------------------------------------

[65ba62230b88] 2020-08-11 18:20:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'force-to-0' into master

* force to 0 expressions which are erroneously non-constant

Files: expand.c (+5/-1)
--------------------------------------------------------------------------------

[9554805cc1ba] 2020-08-11 06:28:34 +0200
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: bug-assign-op0.c: fix test on 32-bit builds

This test was failing on 32-bit because it made
the assumption that 'long' is always 64-bit.

Fix this by using 'long long' when 64-bit is needed.

Fixes 36a75754ba161b4ce905390cf5b0ba9b83b34cd2
Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/bug-assign-op0.c (+5/-5)
--------------------------------------------------------------------------------

[f412da2fb52e] 2020-08-10 22:54:47 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add links to some external doc

One is a LWN article which covers sparse very well, the other
is a pdf giving a short overview of sparse.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/index.rst (+5/-0)
--------------------------------------------------------------------------------

[37691f987be9] 2020-08-10 22:54:47 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: use shorter titles

Mainly it's removing 'sparse' from the title.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.rst (+2/-2), Documentation/dev-options.rst (+2/-2), Documentation/doc-guide.rst (+2/-2), Documentation/types.rst (+3/-3)
--------------------------------------------------------------------------------

[ee51f5ae9252] 2020-08-10 22:54:47 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: reorganize the table of content

Reorganize the table of of content with user documentation first
then all documentation useful for development on sparse itself.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/index.rst (+8/-8)
--------------------------------------------------------------------------------

[24d7f8bf2dfc] 2020-08-10 22:54:47 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: move down info about tarballs, after git repositories

Better to have the information about the GIT repositories
first because I'm not sure if anyone still use the tarballs.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/index.rst (+2/-3)
--------------------------------------------------------------------------------

[587a75116bd6] 2020-08-10 22:54:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: decrease vertical spacing

The vertical spacing in the generated HTML is a bit excessive
to my taste. So decrease it somehow, especially the top of lists.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/sphinx/static/theme_overrides.css (+13/-0)
--------------------------------------------------------------------------------

[cd93f56e2003] 2020-08-10 22:54:13 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: make the sidebar more compact

There is generous spacing in the sidebar, too generous.

So, reduce it to something more compact, which will also
allow more entries without scrolling.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/sphinx/static/theme_overrides.css (+4/-0)
--------------------------------------------------------------------------------

[4b41c2cd2636] 2020-08-10 22:48:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: use a smaller logo in the sidebar

The logo takes quite a bit height in the sidebar and so
pushes the table of content too much at the bottom.

Fix this by reducing the logo to 50%.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/conf.py (+7/-1), Documentation/sphinx/static/theme_overrides.css (+3/-0)
--------------------------------------------------------------------------------

[fb8d5ee78525] 2020-08-09 22:47:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'attr-asm' and 'storage-mod'

* separate parsing of asm-names from attributes
* simplify parsing of storage modifiers

Files: parse.c (+119/-217), show-parse.c (+18/-2), symbol.h (+6/-3)
--------------------------------------------------------------------------------

[6fe6d05b5681] 2020-08-09 21:33:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'doc-annot'

* improve presentation of the doc, mainly the sidebar

Files: Documentation/annotations.rst (+85/-0), Documentation/index.rst (+7/-21), Documentation/nocast-vs-bitwise.md (+0/-43), Documentation/submitting-patches.md (+2/-2), Documentation/templates/breadcrumbs.html (+11/-0), ... and 1 more
--------------------------------------------------------------------------------

[f31c401c5f03] 2020-08-09 16:46:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: parse: simplify set_storage_class()

The second test is now made as the else part of the first test,
saving a 'return' that is otherwise not needed.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+2/-5)
--------------------------------------------------------------------------------

[35c853cc17f3] 2020-08-09 16:46:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: parse: improve error messages concerning storage specifiers

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+4/-5)
--------------------------------------------------------------------------------

[9b4d0862315e] 2020-08-09 16:46:06 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: parse: let asm_modifier() use the keyword modifier

Now that 'MOD_INLINE' & 'MOD_VOLATILE' are associated with their
corresponding keyword, a single asm_modifier() method can cover
both cases.

So, replace asm_modifier_inline() & asm_modifier_volatile() by
a single, generic version: asm_modifier().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+3/-13), symbol.h (+1/-1)
--------------------------------------------------------------------------------

[c27f83b3f134] 2020-08-09 16:45:46 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: parse: associate modifiers with their keyword

A significant number of declarators need to set or simply use
the modifier associated with the corresponding keyword but this
is open-coded for each of them. As result, almost all keywords
corresponding to a declaration need their own specific method.

Make this more generic by adding the associated modifier to the
ctype associated to keywords and passing the result of the keyword
lookup to the declarator methods. This way, these methods can be
made generic by getting the modifier from the ctype, like it was
already done for attributes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+47/-109), symbol.h (+1/-1)
--------------------------------------------------------------------------------

[bc9fc82e7771] 2020-08-09 16:38:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: parse: rework handling of storage_class

The handling of the storage class modifiers is done
differently than the other modifiers:
* they don't use MOD_... but their own enums
* consequently they can't use modifier_string() and have
  their own string table to display them.
* the attribute 'force' is considered as a kind of storage
  class. Fine, but it means that 'register' or '__tls' can't
  be used with 'force' (which is probably very fine but
  seems more as a side-effect than something really desired).

The real justification for these difference seems to be
that storage class modifiers *must* be treated differently
than the other modifiers because they don't apply at the same
level. For example, in a declaration like:
	static const int a[N];
'static' applies to the array/the whole object, while 'const'
only applies to the (type of the) elements of the array.

Storage class specifiers must thus be parsed, stored aside
and only be applied after the whole declarator have been parsed.
But other modifiers are also in the same situation (for example,
'__noreturn' or '__pure' for functions).

So, use the generic keyword/attribute handling of modifiers
for storage class specifiers but for simplicity, store them
separately in decl_state to easily do duplication tests on them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+22/-49), symbol.h (+3/-1)
--------------------------------------------------------------------------------

[19506bc2873e] 2020-08-09 16:18:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'empty-char' into next

* delay 'empty character constant' warning to phase 5

Files: char.c (+5/-0), tokenize.c (+1/-6), validation/empty-char-constant.c (+9/-0), validation/preprocessor/empty-char-constant.c (+13/-0)
--------------------------------------------------------------------------------

[6ed98066f6d1] 2020-08-09 16:06:18 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: force to 0 expressions which are erroneously non-constant

When an expression that needs to be constant but is, in fact,
not constant, sparse throws an error and leaves it as-is.
But some code makes the assumption that the expression is
constant and uses its value, with some random result.

One situation where this happens is in code like:
	switch (x) {
	case <some non-const expression>: ...

In this case, the linearization of the switch/case statement
will unconditionally use the value of the case expression
but the expression has no value.

One way to avoid this would be to add defensive checks each
time a value is retrieved but this is a lot of work and time
for no benefits.

So, change this by forcing the expression to be a constant
value of 0 just after the error message has been issued.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expand.c (+5/-1)
--------------------------------------------------------------------------------

[2f2539bc481a] 2020-08-09 02:13:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'check-void' into tip

* fix checking if type is void

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[3bc32d46494c] 2020-08-09 01:42:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix checking if type is void

Sparse warns if a void function returns a non-void expression.

But the check directly compares the returned type with void_ctype,
without taking in account the presence of a SYM_NODE. In
consequence, sparse issues a few false warnings.

Fix this by using is_void_type() to test the returned type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[1bffdc1843a5] 2020-08-08 18:45:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'wstring-init' into next

* teach sparse about wide string initializers

Files: evaluate.c (+15/-10), symbol.c (+25/-0), symbol.h (+7/-0), validation/init-wstring.c (+40/-0), validation/init_cstring.c (+2/-0)
--------------------------------------------------------------------------------

[437aaeabe6f1] 2020-08-08 18:44:49 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: warning: conditionalize "advancing past deep designator"

The warning "advancing past deep designator" is issued when a
multi-level (deep) designator is followed by a non-designated one.

But it's far from clear what is the value of this warning, what
could be the confusion about this situation and what is special
about these 'deep' designators?

There are hundreds such occurrences in the kernel (394 in the configs
I use for testing) and GCC, clang and sparse have no problems to handle
them correctly. This means that there is also 0 chances that they
will be 'corrected'.

So, add conditionalize this warning with a '-Wpast-deep-designator'
and make it false by default.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+2/-2), options.c (+2/-0), options.h (+1/-0), sparse.1 (+7/-0)
--------------------------------------------------------------------------------

[13252024246c] 2020-08-08 18:44:49 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'sync-cas' into next

* fix evaluation of __sync_{bool,val}_compare_and_swap()

Files: builtin.c (+58/-2), evaluate.c (+3/-4), evaluate.h (+7/-0), validation/builtin-sync-cas.c (+25/-0)
--------------------------------------------------------------------------------

[ed14a50f8ff7] 2020-08-08 18:42:21 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'bad-shift-equal' into next

* fix type evaluation of shifts-assigns
* don't warn for UB shifts in dead code

Files: evaluate.c (+10/-1), expand.c (+0/-18), linearize.c (+44/-0), simplify.c (+5/-15), validation/expand/bad-shift.c (+4/-4), ... and 7 more
--------------------------------------------------------------------------------

[77b4fdcada5f] 2020-08-08 18:40:39 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'prev-stream' into next

* fix diagnostic source path from command line
* fix diagnostic source path for invalid streams

Files: lib.c (+2/-0), tokenize.c (+4/-1), validation/preprocessor/bad-cmdline-include.c (+11/-0)
--------------------------------------------------------------------------------

[172d4be4d595] 2020-08-08 15:36:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: wstring: call is_string_type() only when needed

Just a tiny code reorganization to call is_string_type()
only where & when needed.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+2/-3)
--------------------------------------------------------------------------------

[446313222a0b] 2020-08-08 15:36:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: wstring: extend is_string_type() to also detect wide strings

When evaluating initializers, it must be known if it is for a string
or not. But sparse doesn't known about wide strings.

Fix this by modifying is_string_type() to use is_wchar_type()
in addition of is_byte_type().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+4/-1), validation/init-wstring.c (+0/-1)
--------------------------------------------------------------------------------

[ce8785f0a924] 2020-08-08 15:36:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: wstring: add helper is_wchar_type()

Like is_byte_type() but for wide chars.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+7/-0)
--------------------------------------------------------------------------------

[7d3b07840e74] 2020-08-08 15:36:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: wstring: add support for examination of string initialization

The examination of a string initializer doesn't know about wide
strings. The only thing needed is if the base type is some kind
of char but for wide chars, this type is the same as 'int' and
an array of ints can't be treated the same as an array of chars.

So, do the detection for wide string initializers as:
1) check that the LHS base type is wchar_ctype
2) check that the RHS is a kind of string expression
   (possibly between braces or parenthesis, recursively).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+25/-0)
--------------------------------------------------------------------------------

[a060d243f8dc] 2020-08-08 15:36:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: wstring: add support for checking size in string initializer

A warning is given for string initializers if the LHS array
is not large enough to contains the string. But this check
doesn't knowns about wide strings.

Fix this by selecting the correct char type and use this type
for the size calculations.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+4/-2), validation/init-wstring.c (+41/-0), validation/init_cstring.c (+2/-0)
--------------------------------------------------------------------------------

[aa198d93e6a2] 2020-08-08 15:36:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: wstring: add support for evaluation of wide string

Evaluation doesn't know about wide strings.

Fix this by:
1) selecting the right base type (char_ctype vs wchar_ctype)
2) adapting the type, size & alignment of the underlying array
   to this base type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+5/-4)
--------------------------------------------------------------------------------

[561d0af14666] 2020-08-07 22:39:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add builtin support for __sync_{bool,val}_compare_and_swap()

In the kernel, the architecture s390 uses these builtins to
implement __atomic_cmpxchg() and friends. These builtins
are polymorphic, so they need some special evaluation.
These builtins are known to sparse but with a return type
of 'int' and the argument's types being ignored.

A problem occurs when used on a pointer type: the expected
type doesn't match 'int' and it can give warnings like:
	warning: non size-preserving integer to pointer cast

So, improve the support for these builtins by:
*) checking the number of arguments
*) extract the type from the 1st argument
*) set the returned type to this type if needed
*) finally, do the typechecking by calling evaluate_arguments()

Reported-by: kernel test robot <lkp@intel.com>
Link: https://lore.kernel.org/lkml/202008072005.Myrby1lg%25lkp@intel.com/
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+58/-2), validation/builtin-sync-cas.c (+0/-1)
--------------------------------------------------------------------------------

[b0bd7d895a02] 2020-08-07 22:02:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: export evaluate_arguments()

evaluate_arguments() is local to evaluate.c but the same functionality
is needed for builtins.

So, in order to not duplicate this code:
*) change slightly its interface to accept the expected types as a list
*) make this function extern.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+3/-4), evaluate.h (+7/-0)
--------------------------------------------------------------------------------

[0819ba9b1047] 2020-08-07 22:02:39 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for __sync_{bool,val}_compare_and_swap()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/builtin-sync-cas.c (+26/-0)
--------------------------------------------------------------------------------

[9aa1c8656be5] 2020-08-06 18:30:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bad-shift: wait dead code elimination to warn about bad shifts

Sparse complains when a shift amount is too big for the size
of its operand or if it's negative.

However, it does this even for expressions that are never evaluated.
It's especially annoying in the kernel for type generic macros,
for example the ones in arch/*/include/asm/cmpxchg.h

So, remove all warnings done at expansion time and avoid any
simplifications of such expressions. Same, at linearization
and optimization time but in this case mark the instructions as
'tainted' to inhibit any further simplifications. Finally, at the
end of the optimization phase, warn for the tainted instructions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expand.c (+0/-18), linearize.c (+44/-0), simplify.c (+5/-15), validation/expand/bad-shift.c (+4/-4), validation/optim/shift-big.c (+8/-4), ... and 3 more
--------------------------------------------------------------------------------

[c2a5bd264187] 2020-08-06 18:30:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: shift-assign: restrict shift count to unsigned int

After the RHS of shift-assigns had been integer-promoted,
both gcc & clang seems to restrict it to an unsigned int.
This only make a difference when the shift count is negative
and would it make it UB.

Better to have the same generated code, so make the same here.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+5/-0), validation/linear/shift-assign2.c (+0/-1)
--------------------------------------------------------------------------------

[f01f79df0512] 2020-08-06 18:30:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: shift-assign: fix linearization of shift-assign

The result of a shift-assigns has the same type as the left
operand but the shift itself must be done on the promoted type.
The usual conversions are not done for shifts.

The problem is that this promoted type is not stored explicitly
in the data structure.  This is specific to shift-assigns because
for other operations, for example add-assign, the usual conversions
must be done and the resulting type can be found on the RHS.

Since at linearization, the LHS and the RHS must have the same type,
the solution is to cast the RHS to LHS's promoted type during
evaluation.

This solve a bunch of problems with shift-assigns, like doing
logical shift when an arithmetic shift was needed.

Fixes: efdefb100d086aaabf20d475c3d1a65cbceeb534
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+5/-1), validation/linear/bug-assign-op0.c (+0/-1), validation/linear/shift-assign1.c (+0/-1), validation/shift-undef.c (+8/-8)
--------------------------------------------------------------------------------

[a9e0d28f7669] 2020-08-06 18:30:41 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: shift-assign: add more testcases for bogus linearization

The usual conversions must not be applied to shifts.
This causes problems for shift-assigns.

So, add testcases for all combinations of size and signedness.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/shift-assign1.c (+320/-0), validation/linear/shift-assign2.c (+54/-0)
--------------------------------------------------------------------------------

[e1578773182e] 2020-08-05 21:55:19 +0200
Author: Alexey Gladkov <gladkov.alexey@gmail.com>
Subject: sindex: rename it to 'semind'

The name 'sindex' is already used by another package (biosquid).

So it was decided to rename it to 'semind'.

Signed-off-by: Alexey Gladkov <gladkov.alexey@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: .gitignore (+1/-1), Makefile (+7/-7), sindex.1 => semind.1 (+9/-9), sindex.c => semind.c (+178/-178)
--------------------------------------------------------------------------------

[a82ef22e0140] 2020-08-03 00:15:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: remove link "edit on github"

since the development isn't done on github, the link "edit on github"
is useless and confusing.

So remove this link (but leave the one "View page source" as it's
sometimes quite handy).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/templates/breadcrumbs.html (+11/-0)
--------------------------------------------------------------------------------

[4631d0323296] 2020-08-03 00:15:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add index to the sidebar

It's very useful to be able to access the index from the sidebar
but no change in the configuration seems to allow this. Trying
to abuse the toctree give the same result.

So, add it directly via the template system.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/templates/layout.html (+8/-0)
--------------------------------------------------------------------------------

[b09b9dda368d] 2020-08-03 00:15:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: simplify the toctree

Combine the 'user' documentation with the one for developers
and add captions for each sections in order to have this
structuration visible in the sidebar.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/index.rst (+7/-21)
--------------------------------------------------------------------------------

[9cc01abd43e3] 2020-08-03 00:15:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: replace nocast-vs-bitwise document with its lore link

The nocast-vs-bitwise document was copied here to be sure
to remain accessible but isn't really useful here now because:
1) the original document have also been archived to lore.kernel.org
2) nocast & bitwise have now been documented
3) 2) contains a link to 1)

So, remove this redundant document.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/index.rst (+0/-1), Documentation/nocast-vs-bitwise.md (+0/-43)
--------------------------------------------------------------------------------

[bdf3eca7298e] 2020-08-03 00:14:32 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: document the sparse's extensions

First try at documenting sparse's extensions to C's type system.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/annotations.rst (+85/-0), Documentation/index.rst (+1/-0)
--------------------------------------------------------------------------------

[8c7aee717a33] 2020-08-01 18:16:11 +0200
Author: Uwe Kleine-Knig <uwe@kleine-koenig.org>
Subject: sindex.1: Use ' for a plain quote char

lintian (a linter for Debian packages) warns:

N:    This manual page uses the \' groff sequence. Usually, the intent to
N:    generate an apostrophe, but that sequence actually renders as a an acute
N:    accent.
N:
N:    For an apostrophe or a single closing quote, use plain '. For single
N:    opening quote, i.e. a straight downward line ' like the one used in
N:    shell commands, use &#92;(aq.

I'm not following its advice but stick to ' as is done in other places
of sindex.1.

Signed-off-by: Uwe Kleine-Knig <uwe@kleine-koenig.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Alexey Gladkov <gladkov.alexey@gmail.com>

Files: sindex.1 (+2/-2)
--------------------------------------------------------------------------------

[5bbebae38be8] 2020-08-01 18:16:11 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix build on Hurd which doesn't define PATH_MAX

Hurd doesn't define PATH_MAX but is needed by pre-process.c
and sindex.c.

pre-process.c had already its local define but sindex doesn't.
So, allow sindex to build on Hurd and avoid possible problems
with some future tools by moving the default define of 4096
for it to lib.h where it will be visible for all code.

Reported-by: Uwe Kleine-Knig <uwe@kleine-koenig.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.h (+4/-0), pre-process.c (+0/-4)
--------------------------------------------------------------------------------

[b47eba200030] 2020-08-01 18:14:01 +0200
Author: Uwe Kleine-Knig <uwe@kleine-koenig.org>
Subject: sindex.1: Use ' for a plain quote char

lintian (a linter for Debian packages) warns:

N:    This manual page uses the \' groff sequence. Usually, the intent to
N:    generate an apostrophe, but that sequence actually renders as a an acute
N:    accent.
N:
N:    For an apostrophe or a single closing quote, use plain '. For single
N:    opening quote, i.e. a straight downward line ' like the one used in
N:    shell commands, use &#92;(aq.

I'm not following its advice but stick to ' as is done in other places
of sindex.1.

Signed-off-by: Uwe Kleine-Knig <uwe@kleine-koenig.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Alexey Gladkov <gladkov.alexey@gmail.com>

Files: sindex.1 (+2/-2)
--------------------------------------------------------------------------------

[13732fc80c0b] 2020-08-01 18:14:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix build on Hurd which doesn't define PATH_MAX

Hurd doesn't define PATH_MAX but is needed by pre-process.c
and sindex.c.

pre-process.c had already its local define but sindex doesn't.
So, allow sindex to build on Hurd and avoid possible problems
with some future tools by moving the default define of 4096
for it to lib.h where it will be visible for all code.

Reported-by: Uwe Kleine-Knig <uwe@kleine-koenig.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.h (+4/-0), pre-process.c (+0/-4)
--------------------------------------------------------------------------------

[77f35b796cc8] 2020-08-01 18:14:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: generic: fix missing inlining of generic expression

Inlining in sparse works slightly differently than what my
mental model is: the body is only evaluated after the inline
expansion. IOW, an inline function is not evaluated until it
is effectively inlined. That's fine but it means that generic
expressions also need to be handled during the inlining.

However, since the body of inline functions is evaluated just
after inline expansion, so (recursively) copying the expression
and its type - expression map is quite useless here.

So, just copy the expression itself and its control expression
to 'isolate' them from evaluation, evaluate it and then just
copy the selected expression.

Reported-by: kernel test robot <lkp@intel.com>
Reported-by: Peter Zijlstra <peterz@infradead.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: inline.c (+8/-0), validation/inline-generic.c (+10/-0)
--------------------------------------------------------------------------------

[5fc204f2ec2d] 2020-07-31 01:06:09 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'array-decl'

[Auto-summary] Modifies parse.c. Updates header symbol.h. Adds/updates 3 test(s). Changes: +57/-38 in 5 file(s)

Files: parse.c (+16/-37), symbol.h (+1/-1), validation/abstract-array-declarator-quals.c (+21/-0), validation/abstract-array-declarator-star.c (+8/-0), validation/abstract-array-declarator.c (+11/-0)
--------------------------------------------------------------------------------

[9d3aa4b96b85] 2020-07-31 00:44:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'attr-parsing'

[Auto-summary] Modifies parse.c. Changes: +3/-19 in 1 file(s)

Files: parse.c (+3/-19)
--------------------------------------------------------------------------------

[89353af46b10] 2020-07-31 00:43:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'doc-misc'

[Auto-summary] Updates documentation. Changes: +5/-5 in 3 file(s)

Files: Documentation/index.rst (+3/-3), sindex.1 (+1/-1), sparse.1 (+1/-1)
--------------------------------------------------------------------------------

[907ac2de8298] 2020-07-31 00:41:06 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'undef-option'

[Auto-summary] Modifies options.c. Changes: +6/-0 in 1 file(s)

Files: options.c (+6/-0)
--------------------------------------------------------------------------------

[e1bba1a90358] 2020-07-30 21:35:07 +0200
Author: Alexey Gladkov <gladkov.alexey@gmail.com>
Subject: sindex: allow indexing outside the project tree

One possible way to compile the linux kernel is by using the O=<DIR>
parameter to place all generated files outside the source tree.

Prior to this patch, sindex filters processed sources to exclude system
files. The base directory of the project was the current directory.

When compiled outside of the source tree, this may not be the case.
This patch adds a parameter and an environment variable to specify
the source tree.

You can use it like this:

$ make O=$PWD-build C=2 CHECK="sindex -B $PWD add --"

This parameter is also needed for searching if you want to display
the source code line because sindex does not store lines in the database
but reads them from source files.

Signed-off-by: Alexey Gladkov <gladkov.alexey@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sindex.c (+17/-4)
--------------------------------------------------------------------------------

[6701c7769965] 2020-07-30 21:29:12 +0200
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: support _Generic() a bit more

Change do_expression(EXPR_GENERIC) to inspect expr->control/map/def.
The is the minimal "better than nothing" change, technically incorrect
but still useful for the indexing.

Example:

	void func(void)
	{
		_Generic(a,
			int:		b,
			void:		c,
			default:	d,
		) = e;
	}

output:

   1:6                    def   f func                             void ( ... )
   3:18  func             ---   v a                                bad type
   4:33  func             -w-   v b                                bad type
   5:33  func             -w-   v c                                bad type
   6:33  func             -w-   v d                                bad type
   7:13  func             -r-   v e                                bad type

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+11/-1)
--------------------------------------------------------------------------------

[2f255a14665d] 2020-07-30 04:20:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix diagnostic source path from command line

Now, diagnostic messages are prepended with the source path.
But if the problem comes from a file included directly from
the command line like:
	sparse -include some-buggy-file.c

the prepended message will be:
	(null): note: in included file ...

because there isn't a source path yet.

So, initialize the source path to "command-line".

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+2/-0), validation/preprocessor/bad-cmdline-include.c (+11/-0)
--------------------------------------------------------------------------------

[3b54ee2f16c6] 2020-07-29 23:48:11 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix stream_prev() for invalid (negative) stream

Now that the parent stream is stored as a position, the validity
of a stream can't anymore be tested by checking if its number
is non-negative because inside a struct position stream number
are stored as an unsigned (and changing it to signed would halve
the maximum number of stream).

So, add a check against input_stream_nr before returning the
previous stream.

Fixes: 4c6cbe557c48205f9b3d2aae4c166cd66446b240
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: tokenize.c (+4/-1)
--------------------------------------------------------------------------------

[4932334a3205] 2020-07-29 18:13:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: dissect: use struct symbol::visited/inspected instead of ::examined/evaluated

The dissect client uses struct symbol's fields 'examined' & 'evaluated'
to avoid reprocessing the same symbols. But these fields are used
internally by sparse for type examination & evaluation and despite
dissect not doing these operations explicitly, they can be done
implicitly (for example to handle static assertions or when the
value of a constant expression is needed) inside __sparse().

If this happens, dissect.c:examine_sym_node() will be a no-op because
node->examined will already be set and node->kind would be 0.
Same can happen with node->evaluated.

So, add a new field to struct symbol: 'inspected' and use it, as
well as the existing 'visited', instead of 'evaluated' & 'examined'.
This way, dissect will control its recursion via flags reserved for
backends and thus never set by sparse internals.

Note: when used on the kernel, this patch avoids a lot of warnings:
	"warning: r_member bad sym type=7 kind=0"
	"warning: r_member bad mem->kind = 0"
      and creates substantially more normal output.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Acked-by: Oleg Nesterov <oleg@redhat.com>

Files: dissect.c (+4/-4), symbol.h (+3/-2)
--------------------------------------------------------------------------------

[ee4aea9a9b09] 2020-07-29 00:24:19 +0200
Author: Alexey Gladkov <gladkov.alexey@gmail.com>
Subject: dissect: add support for _Generic

Just suppress the warning about unknown type.

Before:

$ ./test-dissect validation/generic-functions.c

FILE: validation/generic-functions.c

  13:1                    def   f testf                            void ( ... )
  13:1   testf            def . v a                                float
validation/generic-functions.c:13:1: warning: bad expr->type: 31
  13:1   testf            -r- . v a                                float
  14:1                    def   f testd                            void ( ... )
  14:1   testd            def . v a                                double
validation/generic-functions.c:14:1: warning: bad expr->type: 31
  14:1   testd            -r- . v a                                double
  15:1                    def   f testl                            void ( ... )
  15:1   testl            def . v a                                long double
validation/generic-functions.c:15:1: warning: bad expr->type: 31
  15:1   testl            -r- . v a                                long double

After:

$ ./test-dissect validation/generic-functions.c

FILE: validation/generic-functions.c

  13:1                    def   f testf                            void ( ... )
  13:1   testf            def . v a                                float
  13:1   testf            -r- . v a                                float
  14:1                    def   f testd                            void ( ... )
  14:1   testd            def . v a                                double
  14:1   testd            -r- . v a                                double
  15:1                    def   f testl                            void ( ... )
  15:1   testl            def . v a                                long double
  15:1   testl            -r- . v a                                long double

Signed-off-by: Alexey Gladkov <gladkov.alexey@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+1/-0)
--------------------------------------------------------------------------------

[26b99f23652e] 2020-07-27 23:44:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: xtensa: fix configuration of endianness

Since gcc 3.4.0 there is no option to specify the endianness for
the Xtensa architecture, so the kernel relies on autodetecting
the endianness and then defining the macros __XTENSA_E{B,L}__.

But this means that sparse's 'arch_big_endian' can't be used
for the predefine.

So, do not predefine these macros anymore, they will transparently
be set directly from the command line.

Reported-by: Peter Zijlstra <peterz@infradead.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-xtensa.c (+0/-5)
--------------------------------------------------------------------------------

[35e691359a4c] 2020-07-27 23:44:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unsed field for EXPR_GENERIC

The field 'result' have been committed by inadvertence in the
initial commit. Remove it now.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expression.h (+0/-1)
--------------------------------------------------------------------------------

[6b53fc26ca9b] 2020-07-25 23:19:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: keyword type is a bitmask and must be tested so

The keyword's type is a bitmask because depending on the context
the same keyword can be of different type (for example 'const'
as qualifier and the attribute 'const' , a variant of 'pure').

Thus, it's an error to test this type for equality, instead it's
a specific (set of) bit(s) that must be tested.

So, change a test ' x == KW_...' into 'x & KW_...'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[3832167298fa] 2020-07-25 23:19:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testing for sym->op is unneeded for lookup_keyword()

All symbols returned by lookup_keyword() are of type SYM_KEYWORD,
because either:
   1) it's in NS_KEYWORD (and all symbol in NS_KEYWORD are SYM_KEYWORD)
   2) it's in NS_TYPEDEF and all *keywords* in NS_TYPEDEF are reserved
      and so can't be user defined and so must be SYM_KEYWORD.
Thus, they all have a symbol_op associated to them and it's
unneeded to test it.

So, remove the unneeded test.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[f009179a05f7] 2020-07-25 23:19:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testing for SYM_KEYWORD is unneeded for lookup_keyword()

All symbols returned by lookup_keyword() are of type SYM_KEYWORD,
because either:
   1) it's in NS_KEYWORD (and all symbol in NS_KEYWORD are SYM_KEYWORD)
   2) it's in NS_TYPEDEF and all *keywords* in NS_TYPEDEF are reserved
      and so can't be user defined and so must be SYM_KEYWORD.
It's thus unneeded to test it.

So, remove the unneeded test.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+2/-4)
--------------------------------------------------------------------------------

[99f8202a62d3] 2020-07-25 23:19:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: no need to lookup '__attribute__' in NS_KEYWORD

Since '__attribute__' is in NS_TYPEDEF, it's not useful to
look it up also in NS_KEYWORD.

So, remove NS_KEYWORD from the mask while looking up '__attribute__'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[49fc08a0378a] 2020-07-25 23:19:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: factorize matching of '__attribute__'

Matching the keyword '__attribute__' (or '__attribute') needs
several tests and this matching is needed to handle attributes
or to skip them.

So, create an helper, match_attribute(), and use it in the loops
to handle and to skip attributes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+16/-19)
--------------------------------------------------------------------------------

[3ba7f29e393c] 2020-07-25 23:19:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: directly use attribute_specifier() to handle attributes

handle_attributes() used to also handle asm names and so used
the declarator method associated to the taken. But now, asm names
are handled in a separated function.

So, directly use attribute_specifier() to handle the attributes
instead of using it via the declarator method.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[1069b76d5bef] 2020-07-25 23:19:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: remove argument 'keywords' from handle_attributes()

Now that the asm names are handled in handle_asm(), the 'keywords'
argument of handle_attributes() is no more needed since it always
must be 'KW_ATTRIBUTE'.

So, remove this argument.

Note: this is preparation work to later make the distinction between
      function/variable/type/label/... attributes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+12/-13)
--------------------------------------------------------------------------------

[e31f8759b06c] 2020-07-25 23:19:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: fold parse_asm_declarator() into handle_asm_name()

An asm name is not really a declarator, it must only be placed
*after* a declarator and is directly handled by handle_asm_name().
It's thus not needed and possibly confusing to treat it like a
generic declarator.

So, fold parse_asm_declarator() into handle_asm_name() and remove it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+8/-12)
--------------------------------------------------------------------------------

[c6b40f4538f8] 2020-07-25 23:19:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: split handle_asm_name() from handle_attributes()

handle_attributes() handles attributes but also the asm names.
These asm names must occur before the attributes and only once
while the attributes may occur multiple time. Also, these asm
names are not allowed everywhere attributes, only in declarations.

It's maybe handy to process both in the same function but it's
also slightly confusing. So, move the handling of the asm names
in a separate function.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+18/-3)
--------------------------------------------------------------------------------

[e7dad08db283] 2020-07-25 23:19:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: use lookup_keyword() for qualifiers

When handling qualifiers, the corresponding symbol is looked-up with
lookup_symbol() then it's checked if the symbol's type is SYM_KEYWORD.

But, only if the identifier is a keyword (struct ident::keyword) can
the symbol be a SYM_KEYWORD. Thus, non-keyword can be filtered-out
early by using lookup_keyword().

So change the call to lookup_symbol() by a call to lookup_keyword().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[ab77399f33b8] 2020-07-25 23:19:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: simplify parsing of attributes

In the loop doing the parsing of attributes, it's first checked
if EOF is reached, then if the token is ';' but these tests are
not needed since they're subsumed by the third one: checking if
the token is an identifier.

So, remove the tests for EOF and ';', and change the for-loop
into a while-loop checking for TOKEN_IDENT. As a bonus, remove
the local variable holding the identifier since it's there only
for historical reasons.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+3/-19)
--------------------------------------------------------------------------------

[b5b4cd3e13db] 2020-07-25 23:18:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: option: accept 'sparse -U ...'

The '-D' flag was fixed to accept whitespace before the argument
but the '-U' flag wasn't. So, fix this now.

Fixes: 7f1011b311e9329f53d73f88de495ea64071eb77
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: options.c (+6/-0)
--------------------------------------------------------------------------------

[127318b74480] 2020-07-25 23:18:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: do not display bugzilla's URL, it's too long

The full URL for bugzilla is quite long and was rendered as
split into 2 lines which is quite ugly.

So, do not show the URL but simply the hyperlink's name:
"Linux kernels bugzilla for sparse".

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/index.rst (+2/-2)
--------------------------------------------------------------------------------

[22d46dedcc94] 2020-07-25 23:18:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: use https URLs

Use 'https' instead of 'http' for pages needing some level of trust.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/index.rst (+2/-2)
--------------------------------------------------------------------------------

[c86d5859ba0b] 2020-07-25 23:18:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: manpage: replace homepage to sparse.docs.kernel.org

The online documentation was updated for the new homepage
but the manpages were forgotten.

So, update them now.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sindex.1 (+1/-1), sparse.1 (+1/-1)
--------------------------------------------------------------------------------

[39644bf3fe36] 2020-07-25 23:13:21 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: show-mod: no extra space when showing modifiers + ident

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: show-parse.c (+1/-1)
--------------------------------------------------------------------------------

[1eaabedb4c8a] 2020-07-25 23:13:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: show-mod: no ending space when showing a single modifier

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-1)
--------------------------------------------------------------------------------

[e5d710cac54f] 2020-07-25 23:10:46 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: show-mod: add helper to show the modifiers but without ending space

modifier_string() returns either "" or a string with one or
several modifiers separated by a space. In this last case the
string has also a trailing space.

This trailing space is sometimes desired (for example when
composed with identifier name: "%s%s") but is also sometimes not
desired (for example when only the modifiers must be displayed).

So, create a variant of modifier_string() which doesn't add the
ending space: modifier_name().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: show-parse.c (+17/-1), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[eb6779f6f621] 2020-07-25 00:20:08 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: generic: fix missing inlining of generic expression

Inlining in sparse works slightly differently than what my
mental model is: the body is only evaluated after the inline
expansion. IOW, an inline function is not evaluated until it
is effectively inlined. That's fine but it means that generic
expressions also need to be handled during the inlining.

However, since the body of inline functions is evaluated just
after inline expansion, so (recursively) copying the expression
and its type - expression map is quite useless here.

So, just copy the expression itself and its control expression
to 'isolate' them from evaluation, evaluate it and then just
copy the selected expression.

Reported-by: kernel test robot <lkp@intel.com>
Reported-by: Peter Zijlstra <peterz@infradead.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: inline.c (+8/-0), validation/inline-generic.c (+10/-0)
--------------------------------------------------------------------------------

[7cdd65dd26cc] 2020-07-23 23:29:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: allow [*] in array declarators

Since C99, a '*' is allowed in an abstract array declarator to
specify that the array is a VLA with a yet-to-be-determined size.

So, accept this construction (but still ignore it for now).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+6/-1), validation/abstract-array-declarator-star.c (+0/-1)
--------------------------------------------------------------------------------

[0de9fc21de2c] 2020-07-23 23:25:39 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove now unused match_idents()

match_idents() is now unused and identifier matching should
preferably be done via the keyword table.

So, remove this function.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+0/-18)
--------------------------------------------------------------------------------

[06ce9117090b] 2020-07-23 23:25:35 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: simplify & fix parsing of array declarators

Any type qualifier is valid inside an abstract-array-declarator
but currently only 'restrict' is accepted. Also the parsing of
this is somehow more complex than needed and done by comparing
the identifiers instead of being driven by the keyword table.

So, simplify & fix the parsing of these declarators by:
1) using the keyword type KW_QUALIFIER to identify all type
   qualifier at once.
2) add a new keyword type just for 'static'
3) folding the helper abstract_array_static_declarator() into
   the main function: abstract_array_declarator().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+10/-18), symbol.h (+1/-1), validation/abstract-array-declarator-quals.c (+0/-1)
--------------------------------------------------------------------------------

[279d8171c795] 2020-07-23 23:23:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for C99 array declarators

C99 introduced some funky new array declarators, those with
'restrict' or 'static' inside the brackets.

Add some testcases for them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/abstract-array-declarator-quals.c (+22/-0), validation/abstract-array-declarator-star.c (+9/-0)
--------------------------------------------------------------------------------

[e078347c520e] 2020-07-23 23:20:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: do not accept comma expressions in array declarator

Comma expressions are not allowed for the size in an array
declarator.

So, change the parsing of these expressions to only accept
assignment-expressions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-1), validation/abstract-array-declarator.c (+0/-1)
--------------------------------------------------------------------------------

[8702f4e5e409] 2020-07-23 23:12:15 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for comma in array declarator

Comma expressions are not allowed for the size in an array
declarator. Add a testcase for this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/abstract-array-declarator.c (+12/-0)
--------------------------------------------------------------------------------

[bf520529b316] 2020-07-22 18:02:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: shorter title for "submitting-patches.md"

The documentation for submitting patches has ": the sparse version"
is in its title. This is quite useless and makes it longer than
needed.

So, remove this part from the title.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/submitting-patches.md (+2/-2)
--------------------------------------------------------------------------------

[4c6cbe557c48] 2020-07-22 18:02:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add position to struct stream

Now that struct stream contains the parent's stream, it
might as well contains the position so that all information
about the parent is available.

So, add a struct position to struct stream, initialize it
with the information from the '#include' token (if there is one)
and use this positions's ::stream as previous/parent stream.

Suggested-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-1), pre-process.c (+2/-2), symbol.c (+1/-1), token.h (+4/-3), tokenize.c (+8/-5)
--------------------------------------------------------------------------------

[c03ffb321228] 2020-07-22 01:38:24 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: delay 'empty character constant' warning to phase 5

A subset of C syntax regarding character constants is:
	char-constant:
		' c-char-sequence '
	c-char-sequence:
		char
		c-char-sequence char

In short, when tokenized, a character constant must have at least
one character between the quotes. Consequently, sparse will
issue an error on empty character constants (unlike GCC).

However, sparse issues the error during tokenization (phase 3),
before preprocessing directives are handled (phase 4).
This means that code like:
	#if 0
	... ''
	#endif
will throw an error although the corresponding code is discarded.

Fix this by
1) silently accept empty char constants during tokenization
2) issue the diagnostic only when escape sequences are handled.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: char.c (+5/-0), tokenize.c (+1/-6), validation/empty-char-constant.c (+9/-0), validation/preprocessor/empty-char-constant.c (+13/-0)
--------------------------------------------------------------------------------

[e140005c44ef] 2020-07-19 01:11:21 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: prepend diagnostics with source's path and include chain

When a diagnostic is issued for a problem in an included file,
the message show the include's path but it's often needed to
(quickly) know the chain of include files involved.

So, if the path associated with the diagnostic is different
than the path oft he source file and different from the path
of the previous message, prepend the message with a note
showing the source file's path. And, if any intermediate
include file is concerned, display the include chain
(possibly truncated or not displayed at all if too long).

Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+81/-5), pre-process.c (+5/-5), symbol.c (+1/-1), token.h (+4/-3), tokenize.c (+11/-3), ... and 1 more
--------------------------------------------------------------------------------

[dd6c3980de7d] 2020-07-18 18:10:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'error-inval-num'

* teach sparse about -fmax-errors
* syntax errors in numbers are not fatal

Files: expression.c (+4/-1), lib.c (+1/-1), options.c (+8/-0), options.h (+1/-0), sparse.1 (+6/-0)
--------------------------------------------------------------------------------

[a30da6a51cc2] 2020-07-18 18:09:35 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'empty-expr'

* warn on empty assignments & initializations

Files: expression.c (+5/-1), parse.c (+4/-1), validation/bad-assignment.c (+1/-0), validation/empty-assign.c (+13/-0), validation/empty-initializer.c (+9/-0)
--------------------------------------------------------------------------------

[92d7f58c4111] 2020-07-18 14:46:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'arch'

* some small adjustments to the builtin types and predefined macros.

Files: Makefile (+5/-0), cgcc (+8/-24), machine.h (+6/-0), options.c (+19/-0), predefine.c (+61/-8), ... and 22 more
--------------------------------------------------------------------------------

[e40b8106953b] 2020-07-16 00:21:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: predefine: let predefine_width() take the usual interface

All the helpers for type-related predefines directly take in
argument the pointer to the type. All but predefine_width().
This must be an historical relic.

So, let predefine_width() also take the pointer to the type
as argument.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: predefine.c (+3/-3)
--------------------------------------------------------------------------------

[7d648be9208b] 2020-07-15 00:00:12 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: syntax errors in numbers are not fatal

When parsing expressions, if an invalid number is reached, a fatal
error is issued. But this is not the kind of error for which
continuing the processing doesn't make sense, since the token
was already categorized as a number during the tokenization.

So, change the fatal error into a normal one (and set the value to 0).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expression.c (+4/-1)
--------------------------------------------------------------------------------

[707c50174d08] 2020-07-14 23:06:18 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'keyword-tbl'

[Auto-summary] Modifies parse.c. Changes: +132/-154 in 1 file(s)

Files: parse.c (+132/-154)
--------------------------------------------------------------------------------

[5db5a1655337] 2020-07-14 22:03:21 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'assert-opt-msg'

[Auto-summary] Modifies parse.c. Adds/updates 1 test(s). Changes: +21/-8 in 2 file(s)

Files: parse.c (+16/-8), validation/static_assert.c (+5/-0)
--------------------------------------------------------------------------------

[a1fdab368870] 2020-07-14 22:02:47 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'bad-shift-assign'

[Auto-summary] Adds/updates 1 test(s). Changes: +115/-0 in 1 file(s)

Files: validation/linear/bug-assign-op0.c (+115/-0)
--------------------------------------------------------------------------------

[14b55d27ee7d] 2020-07-14 01:27:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: warn on empty initializations

Currently sparse accepts an empty initialization like:
	int a = ;

Make this an error.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+4/-1), validation/empty-initializer.c (+0/-1)
--------------------------------------------------------------------------------

[584bf4cd77d4] 2020-07-14 01:27:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: warn on empty assignments

Currently sparse accepts an empty assignment like:
	a = ;

Make this an error.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expression.c (+5/-1), validation/bad-assignment.c (+1/-0), validation/empty-assign.c (+0/-1)
--------------------------------------------------------------------------------

[0394c281af25] 2020-07-14 01:27:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for incorrect empty expressions

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/empty-assign.c (+14/-0), validation/empty-initializer.c (+10/-0)
--------------------------------------------------------------------------------

[9a7a095c6cab] 2020-07-14 00:07:46 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: x86-x32: fix it by defining a separate target for it

On x86-64, the x32 ABI was processed as a kind of special case
of the usual 32-bit variant. But this doesn't work very well.

Fix it and help avoiding possible future problems by defining
a separate target for it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-x86.c (+32/-0), target.c (+8/-3), target.h (+1/-0)
--------------------------------------------------------------------------------

[a0ce077c9fa9] 2020-07-14 00:07:02 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: arch: allow target specific [u]intptr_t & ptrdiff_t

These types are aliased to size_t & ssize_t but this is not
correct for all architectures.

So, add a variable for them so that target files can adjust them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: predefine.c (+3/-3), symbol.c (+7/-0), symbol.h (+0/-3), target-h8300.c (+2/-0), target-s390.c (+3/-0), ... and 3 more
--------------------------------------------------------------------------------

[7f4170c8d5dc] 2020-07-14 00:06:10 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: predefine: teach sparse about __SIG_ATOMIC_TYPE__

This type is predefined by GCC so add it to sparse too.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: predefine.c (+1/-0), target.c (+1/-0), target.h (+1/-0)
--------------------------------------------------------------------------------

[99bcbcaf803f] 2020-07-14 00:05:28 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: arch: add predefines __INT_FAST${N}_TYPE__

We just added __INT_LEAST${N}_TYPE__, so add these ones
too as they looks slightly more useful.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: predefine.c (+9/-0), target-arm.c (+7/-0), target-h8300.c (+5/-0), target-m68k.c (+9/-0), target-microblaze.c (+9/-0), ... and 12 more
--------------------------------------------------------------------------------

[fa09d838d4b2] 2020-07-14 00:04:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: arch: add predefines __INT_LEAST${N}_TYPE__

These are used by some system headers (neon on arm64).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: predefine.c (+9/-0), target-x86.c (+2/-0), target.c (+8/-0), target.h (+8/-0)
--------------------------------------------------------------------------------

[165d99c40f65] 2020-07-13 23:30:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ppc: add predefines __LONGDOUBLE128 & __LONG_DOUBLE_128__

On powerpc, if long double is 128-bit width, then
'__LONGDOUBLE128' & '__LONG_DOUBLE_128__' should be defined.

So do this in the target specific file.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-ppc.c (+4/-0)
--------------------------------------------------------------------------------

[a9a0425cde66] 2020-07-13 23:30:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: alpha: has 64-bit long double & int128

Support for alpha was added in order to move the specific builtins
away from the common list without changing the defaults.

Improve the support for this arch by fixing a few specificities:
* support of 128-bit integers
* long doubles are 64-bit.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-alpha.c (+3/-0)
--------------------------------------------------------------------------------

[8d017625fd11] 2020-07-13 23:30:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sparc: add 'sparcv8' predefines for sparc32

By default, the architecture version is 'v8' for sparc32
and 'v9' for sparc64.
The predefines were added for sparc64 but not for sparc32.

Fix this by adding a generic 'sparcv%d' together with a
variable to hold the architecture version and initialize
this one accordingly.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-sparc.c (+16/-3)
--------------------------------------------------------------------------------

[d2947a933574] 2020-07-13 23:30:21 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'march', 'endianness', 'os' and 'arch-mini' into arch

[Auto-summary] Modifies 15 source files: options.c, predefine.c, target-arm.c and 12 more. Updates 2 headers. Modifies build system. Changes: +460/-49 in 20 file(s)

Files: Makefile (+5/-0), cgcc (+8/-24), machine.h (+6/-0), options.c (+19/-0), predefine.c (+36/-2), ... and 15 more
--------------------------------------------------------------------------------

[14e84ffc0e76] 2020-07-13 21:27:15 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix evaluation error with assignment of qualified arrays

This is a fix for a problem reported today to the mailing list.

In check_assignment_types(), the first 'level' is checked by the
function itself but the next level is checked by the type_difference().
This later function take as arguments, beside the types to be
checked, the modifiers that can be assumed for each of the types
(this works as a kind of reverse mask).
But these modifiers are taken from target_qualifiers() which,
purposely ignore the modifiers for arrays introduced in commit
    984b7b66457c ("[PATCH] deal correctly with qualifiers on arrays")
with the comment:
    "Pointers to any array are considered as pointers to unqualified
    type as far as implicit conversions are concerned"

But by dropping these modifiers, type_difference() reports
incorrect results for pointers to qualified arrays.

So, do not use target_qualifiers() but take the modifiers directly
from the ctypes. Admittingly, I'm far from sure that this is the
right fix but it solve several wrong cases.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+2/-2), validation/eval/array-quals0.c (+0/-1), validation/eval/array-quals1.c (+0/-1)
--------------------------------------------------------------------------------

[13f4aefdb21d] 2020-07-13 18:02:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: openrisc: add minimal support

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), machine.h (+1/-0), target-openrisc.c (+26/-0), target.c (+2/-0), target.h (+1/-0)
--------------------------------------------------------------------------------

[338f93fad2fb] 2020-07-13 18:02:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sh: add minimal support

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), machine.h (+1/-0), target-sh.c (+28/-0), target.c (+2/-0), target.h (+1/-0)
--------------------------------------------------------------------------------

[e7ff2c6b8ad2] 2020-07-13 17:58:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: nds32: add minimal support

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), machine.h (+1/-0), target-nds32.c (+28/-0), target.c (+2/-0), target.h (+1/-0)
--------------------------------------------------------------------------------

[03adbff28af6] 2020-07-13 17:57:04 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: xtensa: add minimal support

This is one of the architecture needing a specific predefine
set in order to correctly process byteorder.h.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), machine.h (+1/-0), target-xtensa.c (+31/-0), target.c (+2/-0), target.h (+1/-0)
--------------------------------------------------------------------------------

[85fb62e73e82] 2020-07-13 17:54:36 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: h8300: add minimal support

This is now the only architecture needing '-msize-long'.

Prepare the obsolescence of this option by adding the
target file for this architecture.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), machine.h (+1/-0), target-h8300.c (+27/-0), target.c (+2/-0), target.h (+1/-0)
--------------------------------------------------------------------------------

[53ff1650faff] 2020-07-13 17:54:36 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: target: keep tables sorted

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target.c (+4/-4)
--------------------------------------------------------------------------------

[375dbdd22935] 2020-07-13 17:49:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: arm: fix int32_t & uint32_t on bare-metal.

On arm, int32_t & uint32_t seem to be differently defined on bare-metal.
Fix this in the target-specific file.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-arm.c (+9/-0)
--------------------------------------------------------------------------------

[04b9164a17bf] 2020-07-13 17:49:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cgcc: remove now unneeded options & defines

Now that the OS can be specified to sparse via an option (--os=$OS)
and that sparse knows about their specificities, it's no more
needed or useful to also define them in cgcc.

So, remove from cgcc the OS-specificities known to sparse (a few
few exotic ones remain for now) but ensure that the info about
the correct OS is passed to sparse.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: cgcc (+8/-24)
--------------------------------------------------------------------------------

[490d0caa578c] 2020-07-13 17:49:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cygwin: add the predefines '__cdecl', ...

For CygWin, GCC defines some pseudo-specifiers like '__cdecl',
'__stdcall' or '_thiscall'. Some of these are already defined by cgcc.

So, add these predefines to sparse itself.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: predefine.c (+9/-0)
--------------------------------------------------------------------------------

[30682796740c] 2020-07-13 17:49:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: arch: add predefines for OS identification

Predefine macros like '__OpenBSD__', ... for the three BSDs,
CygWin and Darwin (those for Linus and SunOS were already defined).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: predefine.c (+19/-0)
--------------------------------------------------------------------------------

[aec42aa3b2ad] 2020-07-13 17:49:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sparc: char are unsigned on Solaris

On Solaris, at least on sparc32, chars are unsigned.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-sparc.c (+2/-0)
--------------------------------------------------------------------------------

[ec475321a4ce] 2020-07-13 17:49:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: x86: fixes types for NetBSD & OpenBSD

On NetBSD & OpenBSD, some types are not defined like on Linux.

Fix this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-x86.c (+11/-0)
--------------------------------------------------------------------------------

[2cea13f8bf05] 2020-07-13 17:49:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: predefine: no __unix__ for Darwin

On Darwin, '__unix__' & '__unix' doesn't seem to be predefined.
Don't ask me why.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: predefine.c (+1/-1)
--------------------------------------------------------------------------------

[f57ae22a393b] 2020-07-13 17:49:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: predefine: add __linux__ & __linux

These are already defined in cgcc but not yet by sparse
itself. So, add them now.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: predefine.c (+7/-1)
--------------------------------------------------------------------------------

[7fffea101f87] 2020-07-13 17:49:51 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: arch: add an option to specify the OS: --os=$OS

This is not needed when doing native 'compilation' but is
quite handy when testing the predefined types & macros.
The supported OSes are: 'linux', 'freebsd', 'openbsd', 'netbsd'
'darwin', 'sunos', 'cygwin' and a generic 'unix'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: machine.h (+1/-0), options.c (+11/-0), sparse.1 (+10/-0), target.c (+29/-0), target.h (+1/-0)
--------------------------------------------------------------------------------

[635db41c41a4] 2020-07-11 16:32:27 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse about -fmax-errors

Currently, the maximum number of displayed errors is 100.
This is nice to not be flooded with error messages when things
are really broken but in some situation, for example testing,
it is desirable to have all error messages.

So, teach sparse about '-fmax-errors=COUNT'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-1), options.c (+8/-0), options.h (+1/-0), sparse.1 (+6/-0)
--------------------------------------------------------------------------------

[c122e6540d53] 2020-07-10 02:03:57 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcase for missing warning for assignment to const

The problem is seems to be related with evaluate_dereference()
where all mods are dropped when the type is a node.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/eval/array-quals-node.c (+29/-0)
--------------------------------------------------------------------------------

[efc5f66c4221] 2020-07-10 01:15:58 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add another testcase  with const array/pointer

Those are cases that sparse should warn about but doesn't.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/eval/array-quals1.c (+50/-0)
--------------------------------------------------------------------------------

[72c88ef852d6] 2020-07-09 23:16:57 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add a testcase for assignment to const <type> (*)[]

You can assign a '<type>[]' to a 'const <type> *'. Likewise,
you can assign a '<type>[][N]' to a 'const <type> (*)[N]' but
sparse doesn't like this.

Analyzed-by: Ard Biesheuvel <ardb@kernel.org>
Reported-by: Herbert Xu <herbert@gondor.apana.org.au>
Link: https://lore.kernel.org/linux-crypto/20200709120937.GA13332@gondor.apana.org.au/
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/eval/array-quals0.c (+7/-0)
--------------------------------------------------------------------------------

[a52ccc23e3c9] 2020-07-09 00:55:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: x86: reorg the target file

More, specifically, split the 'init' method into a common part
and add one for each of the i386 (32-bit) and another one for 64-bit.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-x86.c (+35/-17)
--------------------------------------------------------------------------------

[3821c301395f] 2020-07-08 21:25:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: keyword: use some macros to avoid duplication

Most keywords have a variant with the leading nd trailing
double-underscore. Some have also a variant with only the
leading underscores. But only the identifier change, the
remaining of the information is duplicated for them.

So, use some macros to define the corresponding entries
without duplication.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+98/-125)
--------------------------------------------------------------------------------

[9a9846bc7cca] 2020-07-08 21:25:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: keyword: reorder the keywords

Reorder the keywords to make them even more logically organized.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+34/-38)
--------------------------------------------------------------------------------

[ef2a7919dbc7] 2020-07-08 21:22:49 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: keyword: reorganize the keyword table

With time, the keyword table has become quite hard to read.

So, split the table in 2: one for NS_TYPEDEF and one for NS_KEYWORD.
This allows to remove one argument, making more place for those
that really matter.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+148/-139)
--------------------------------------------------------------------------------

[424486c49e41] 2020-07-08 02:19:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: arm: add predefine __ARMEL__ or __ARMEB__

Depending on the endianness, predefine '__ARMEL__' or '__ARMEB__'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-arm.c (+5/-0)
--------------------------------------------------------------------------------

[378420df6c66] 2020-07-08 02:19:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: arm64: add predefine for endianness

Depending on the endianness, predefine '__AARCH64EL__' or '__AARCH64EB__'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-arm64.c (+5/-0)
--------------------------------------------------------------------------------

[cc885f41d75d] 2020-07-08 02:19:40 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: mips: add predefines __MIPSEL__ or __MIPSEB__ & friends

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-mips.c (+10/-0)
--------------------------------------------------------------------------------

[cc0592e1e3da] 2020-07-08 02:12:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: riscv: parse '-march=....'

The RISC-V architecture has quite a bit of extensions.
Some of these correspond to a predefined macro and thus
parsing correctly the '-march' flag can be important.

So, teach sparse how to parse this flag for RISC-V.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-riscv.c (+80/-0), target.h (+1/-0)
--------------------------------------------------------------------------------

[ea8cf0fef930] 2020-07-08 01:57:25 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: arch: teach sparse about the '-march' option

The option '-march' is not one of the common option but is
architecture specific.

So, teach sparse to delegate the parsing of this option to
the targets.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: options.c (+8/-0), target.h (+1/-0)
--------------------------------------------------------------------------------

[bbeebf636d49] 2020-07-08 01:48:24 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: c2x: message in _Static_assert() is now optional

It seems that in the next version of the standard, the
second argument of _Static_assert() will be optional.

Nice. Let sparse already support this now.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+16/-8), validation/static_assert.c (+5/-0)
--------------------------------------------------------------------------------

[562179b3d751] 2020-07-08 01:37:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: nios2: add non-trailing double underscore predefines

For Nios2, some predefines with the trailing double underscores
were added but the variant with only the leading ones are also
used. So add these too.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-nios2.c (+7/-2)
--------------------------------------------------------------------------------

[e5c2352578cb] 2020-07-08 01:37:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: nios2: long double is 64-bit

On Nios2, long double are (of course) only 64 bits width.
Specify this in the target file.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-nios2.c (+2/-0)
--------------------------------------------------------------------------------

[c9676a3b0349] 2020-07-08 01:35:46 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branches 'predef-fix', 'predef-helper' and 'simplify-add-pre-buffer'

* predefine: fix multi-token predefine
* predefine: add helper predefine_{strong,weak}()
* predefine: avoid add_pre_buffer() for targets
* predefine: simplify add_pre_buffer()

Files: lib.c (+3/-6), lib.h (+2/-0), pre-process.c (+26/-0), predefine.c (+1/-1), target-arm64.c (+1/-1), ... and 2 more
--------------------------------------------------------------------------------

[d92121c266d1] 2020-07-07 03:12:39 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: riscv: add the predefines for the extensions

The RISC-V architecture has some predefined macros
to specify which extensions are supported.

So, now that these extensions are known via the '-march'
options, add the corresponding predefines.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-riscv.c (+19/-0)
--------------------------------------------------------------------------------

[0a45df1135e7] 2020-07-06 03:45:10 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: predef: simplify add_pre_buffer()

pre_buffer_begin & pre_buffer_end are the head and the tail of
a singly chained list. As such, it's slightly easier to not
keep a pointer on the last element but a pointer where the
next element should be written.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+3/-6)
--------------------------------------------------------------------------------

[f99c666c493c] 2020-07-06 03:39:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: predefine: avoid add_pre_buffer() for targets

Avoid add_pre_buffer() and use one of the predefine...()
variant instead.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-arm64.c (+1/-1), target-riscv.c (+1/-1)
--------------------------------------------------------------------------------

[20b4c3c4ca21] 2020-07-06 03:39:44 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: predefine: add helper predefine_{strong,weak}()

A lot of predefined macros are just set to the value '1' and
of them have a name that is not statically known. OTOH, the
function predefine() is designed for a statically known name
but a variable value.

Add a set of helpers to cover the first case: predefine_strong()
and predefine_weak().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.h (+2/-0), pre-process.c (+26/-0)
--------------------------------------------------------------------------------

[c6dff56f6c01] 2020-07-06 03:39:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: predefine: fix multi-token predefine

The function predefine() and its variants are only valid
if they define a single-token value.

However, when a type is signed, predefine_min() will produce
a multi-token value.

Fix this by using add_pre_buffer() instead of predefine().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: predefine.c (+1/-1)
--------------------------------------------------------------------------------

[11db59ea8e96] 2020-07-06 03:39:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: predefine: add testcase for multi-token predefines

The function predefine() and its variants are only valid
if they define a single-token value.

Add a testcase for this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/preprocessor/predef-token.c (+5/-0)
--------------------------------------------------------------------------------

[36a75754ba16] 2020-07-06 02:59:09 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add testcase for bogus linearization of >>= & /=

When doing a shift operation, both arguments are subjected to
integer promotion and the type of the result is simply the type
of the promoted left operand. Easy.

But for a shift-assignment, things are slightly more complex:
  -) 'a >>= n' should be equivalent to 'a = a >> n'
  -) but the type of the result must be the type of the left
     operand *before* integer promotion.

Currently, the linearization code use the type of the right
operand to infer of the type of the operation. But simply changing
the code to use the type of the left operand will also be wrong
(for example for signed/unsigned divisions). Nasty.

For example, the following C code:
	int s = ...;
	s >>= 11U;
is linearized as a logical shift:
	lsr.32      %r2 <- %arg1, $11
while, of course it's an arithmetic shift that is expected:
	asr.32      %r2 <- %arg1, $11

So, add a testcase for these.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/bug-assign-op0.c (+115/-0)
--------------------------------------------------------------------------------

[abbfd661b2de] 2020-07-06 02:21:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: arch: add minimal support for microblaze

The Kernel Test Robot reports a problem on microblaze.

The cause is that __MICROBLAZEEL__ is not defined. However, the real
problem is that sparse has no support at all for this architecture.

So, add the minimal support for microblaze.

Link: https://lore.kernel.org/lkml/202007060542.hNfoTcsC%25lkp@intel.com
Reported-by: kernel test robot <lkp@intel.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), machine.h (+1/-0), target-microblaze.c (+25/-0), target.c (+2/-0), target.h (+1/-0)
--------------------------------------------------------------------------------

[d2c1cda9f75c] 2020-07-06 02:13:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'options'

A lot of content in lib.c have been added by just appending at the
bottom of what was already present. As consequence, things are now
not well organized at all, especially when related to the options.
So, reorganize things a little bit here:
* move all helpers on top
* keep things alphabetically sorted
* move options parsing in a separate file
* move predefine-related stuff in a separate file

Files: Makefile (+2/-0), lib.c (+4/-1252), lib.h (+2/-121), options.c (+998/-0), options.h (+137/-0), ... and 6 more
--------------------------------------------------------------------------------

[61f53e257de4] 2020-07-06 02:07:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cleanup: move hexval() to utils.c

Now lib.c contains almost nothing else than library entrypoints.

Move a small utility, hexval(), to utils.c to complete this cleanup.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+0/-17), lib.h (+0/-2), utils.c (+17/-0), utils.h (+4/-0)
--------------------------------------------------------------------------------

[8e929d4e369f] 2020-07-06 01:28:21 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cleanup: move parsing helpers to parse.c

lib.c contains 2-3 helpers for parsing. Move them to parse.c.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+0/-38), lib.h (+0/-4), parse.c (+38/-0), parse.h (+2/-0)
--------------------------------------------------------------------------------

[8fce3d7a27fa] 2020-07-05 22:58:45 +0200
Author: Davidson Francis <davidsondfgl@gmail.com>
Subject: test-inspect: reset locale after gtk_init()

The test-inspect tool uses GTK to visualize symbol nodes. It turns
out that gtk_init() implicitly sets the locale to the system locale,
and since Sparse uses strtod()/strtold() for parsing floating-point
numbers in expressions, parsing becomes locale-dependent.

Since the system's locale may be different from "C", test-inspect
may be unable to parse float numbers.

Steps to reproduce:
    $ echo "int main(void){3.14;}" > test.c
    $ LC_ALL="fr_FR.UTF-8" test-inspect test.c
Output:
    test.c:1:16: error: constant 3.14 is not a valid number

Fix this by resetting the locale right after gtk_init().

Signed-off-by: Davidson Francis <davidsondfgl@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: test-inspect.c (+2/-0)
--------------------------------------------------------------------------------

[a424976e1645] 2020-07-05 13:13:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'sindex-uchar'

* sindex: avoid a warning with 'case -1:'

Files: sindex.c (+5/-2)
--------------------------------------------------------------------------------

[aeb1b5f5b720] 2020-07-05 13:12:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sindex: avoid a warning with 'case -1:'

When parsing the format, there is a 'case -1:' which:
* seems to be there only for the following label (but mixing
  labels with cases, like here, is OK).
* on architectures where chars are unsigned, the compiler complains:
	warning: case label value is less than minimum value for type

So, remove the unneeded 'case -1:' and use an explicit 'default:'
to catch invalid formats. Also, align the label with the cases,
it looks nicer so.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Reviewed-by: Alexey Gladkov <gladkov.alexey@gmail.com>

Files: sindex.c (+5/-2)
--------------------------------------------------------------------------------

[d5305a788ebe] 2020-07-05 12:34:11 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'arch-asm-mem'

* teach sparse about arch specific asm constraints
* teach sparse about memory operand constraints for ppc & s390

Files: evaluate.c (+4/-1), target-ppc.c (+13/-0), target-s390.c (+13/-0), target.h (+2/-1)
--------------------------------------------------------------------------------

[1a913ebefbc0] 2020-07-05 12:32:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'cleanup-compat'

* remove pre-C99 compatibility layer for BSD & Solaris

Files: compat-bsd.c (+1/-13), compat-solaris.c (+1/-33)
--------------------------------------------------------------------------------

[b84b4b4b63aa] 2020-07-04 15:56:54 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add memory asm constraint for S390

The 'Q', 'R', 'S' & 'T'' asm constraint are used for for memory
operands on S390 but only 'Q' belong to the 'common constraints'.

Fix this by handling the 3 others with an arch-specific method.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-s390.c (+13/-0)
--------------------------------------------------------------------------------

[60aa5705d990] 2020-07-04 15:39:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add memory asm constraint for PPC

The 'Z' asm constraint is used for doing IO accessors on PPC but
isn't part of the 'common constraints'. It's responsible for
more than half of all warnings (with defconfig + allyesconfig).

Fix this by handling this constraint in a specific method for PPC.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-ppc.c (+13/-0)
--------------------------------------------------------------------------------

[dcf7d2a15920] 2020-07-04 15:39:50 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support for arch specific asm constraints

When evaluating asm operands it must be known if they correspond
to a memory operand or not in order to process/ignore the 'noderef'
attribute.

This is done for operands specified with the common constraints
but not for the machine specific constraints.

So, add support for processing machine specific constraints.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+4/-1), target.h (+2/-1)
--------------------------------------------------------------------------------

[709595b2979d] 2020-07-04 12:16:59 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add new flag '-p' to subcommand 'format'

This flag facilitates the creation of testcases for preprocessing.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+4/-0)
--------------------------------------------------------------------------------

[79a6ae831637] 2020-07-04 12:14:26 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: avoid multiple warnings when inlining undeclared calls

When inlining multiple times a function which contains an undeclared
function call, multiple error messages are issued. More annoyingly,
only the first one is meaningful, the other ones doesn't even show
the incriminated identifier:
	error: undefined identifier '...'
	error: not a function <noident>

Part of the problem is that the first message is displayed with
expression_error() which also sets the expression to &bad_ctype.
This change the way how the expression is handled when re-evaluated.

Fix this by avoiding the evaluation of function calls that already
evaluate to bad_ctype: it's known that an error message have already
been issued for them and that nothing good can done with them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+4/-0), validation/eval/undecl-no-indent.c (+19/-0)
--------------------------------------------------------------------------------

[111956db3b21] 2020-07-02 23:33:10 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cleanup: move predefines in a separate file

Now that option parsing have moved to a separate file, move
everything related to predefined macros to a separate file too.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), lib.c (+0/-221), lib.h (+1/-0), predefine.c (+225/-0)
--------------------------------------------------------------------------------

[50565794dbb3] 2020-07-02 23:33:10 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: options: keep the options sorted

The declarations and definitions of the variables corresponding to
the options half-sorted half-unsorted.

Sort them a little more.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: options.c (+49/-49), options.h (+71/-66)
--------------------------------------------------------------------------------

[4c12284169f2] 2020-07-02 21:08:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: options: move option parsing in a separate file

lib.c contains to much things and is too hard to keep tidy.
So, move everything related to option parsing in it's own file.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), lib.c (+2/-980), lib.h (+1/-116), options.c (+998/-0), options.h (+132/-0)
--------------------------------------------------------------------------------

[5784e53b392c] 2020-07-02 21:08:00 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: options: add a small helper: handle_switch_finalize()

This is just to isolate the details about which switch need an
extra 'finalization' in a separate function in preparation
to moving all the parsing code in a separate file.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+7/-2)
--------------------------------------------------------------------------------

[a717e30bdf1a] 2020-07-02 21:07:58 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: options: move declaration of tabstop out of "token.h"

'tabstop' is unusual in the sense that it's one the few (the only?)
variable defined via an option flag which is not declared in "lib.h"
but in "token.h". This for to have to include "token.h" in the code
doing the parsing of the options ...

Move this declaration to "lib.h".

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.h (+1/-0), token.h (+0/-1)
--------------------------------------------------------------------------------

[6e43ab07fa27] 2020-07-02 21:07:57 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: options: avoid spaces between function name and arguments list

It's a stylistic detail but a lot of the strcmp() calls used for
the processing of the options are written 'strcmp (...)'. Two
other functions calls are also in the case.

Reformat them to the usual style for function calls: without
the space between the function name and the arguments.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+17/-17)
--------------------------------------------------------------------------------

[be21656fd77e] 2020-07-02 21:07:56 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: options: alphasort the handle_switch_[a-zA_Z]()

These function have probably been added in 'historical order' and
as result it's not easy to quickly see where they're defined.

Change this arranging them in asciibetical order.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+327/-329)
--------------------------------------------------------------------------------

[9e9ee8433d21] 2020-07-02 21:07:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: options: move helpers up

The helpers for parsing the options are often situated just above the
first function using them. As result, these helpers can be found a bit
everywhere in the code, it's messy and doesn't help to reuse these helpers.

So, move all these helpers to the top.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+44/-43)
--------------------------------------------------------------------------------

[daaeb83f8232] 2020-07-02 21:05:36 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: options: handle_onoff_switch() can handle any flags, not only warnings

So, use 'flag' instead of 'warning' for variable and function names.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+18/-18)
--------------------------------------------------------------------------------

[763d239e13f9] 2020-07-02 18:42:06 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: options: make Wsparse_error less special

-Wsparse-error should not be enabled with -Wsparse-all, this is
special cased in the condition in loop handling -Wsparse-all.

However, the condition already handle warnings forced to off.
So instead of explicitly checking for &Wsparse_error, it's enough
to force Wsparse_error off.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+2/-2)
--------------------------------------------------------------------------------

[626e61ab54cd] 2020-07-02 18:42:06 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: options: move on top the definition of warning type enums

This allows to reuse these enums in earlier helpers.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+6/-6)
--------------------------------------------------------------------------------

[851b48b8129b] 2020-07-02 18:42:06 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: options: move -Wsparse-all's processing out of handle_onoff_switch()

Since handle_onoff_switch() can be used for other flags than the
warnings, the processing of -Wsparse-all should move elsewhere.

So move it into handle_switch_W().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+8/-8)
--------------------------------------------------------------------------------

[60ffe1dd0fd4] 2020-07-02 18:42:06 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: options: let handle_onoff_switch() use null terminated arrays

This makes things slightly easier to use.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+11/-9)
--------------------------------------------------------------------------------

[3fa11becc5b8] 2020-06-28 11:06:43 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: remove unneeded BSD & Solaris compatibility layer

None of the BSDs need "compat-bsd.c" anymore. Same for
Solaris and "compat-solaris.c", even for Solaris 10.

The only problem was lacking C99's strtold() but it seems
that this was solved many years ago and they're all doing
quite fine with "compat-linux.c".

So, simply replace the content of these file by an include of
"compat-linux.c".

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: compat-bsd.c (+1/-13), compat-solaris.c (+1/-33)
--------------------------------------------------------------------------------

[fa15396204a7] 2020-06-23 01:34:11 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: fix 'format help' / validate number of arguments

The subcommand 'format help' is broken because the of the way
arguments are parsed without validating the number of arguments.

Fix this by parsing all arguments (even if there is only one)
and validate the number of arguments at the end of the loop.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+6/-1)
--------------------------------------------------------------------------------

[44936538b1f9] 2020-06-23 01:34:08 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse about __STDC_HOSTED__

It seems that some system libraries expect __STDC_HOSTED__ to
be always defined.

So, teach sparse the options flags -f[no-]{hosted,freestanding}
and define __STDC_HOSTED__ accordingly.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+4/-0), lib.h (+1/-0), validation/preprocessor/freestanding.c (+11/-0), validation/preprocessor/hosted.c (+11/-0)
--------------------------------------------------------------------------------

[cc651aa7b6a0] 2020-06-23 00:34:09 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: gensel: remove unneeded test/uninitialized warning

When evaluation generic selections, it is tested if the type in
the selection is a SYM_NODE or not, but:
* all these are SYM_NODE
* the variable for the base type would be uninitialized
  if not a SYM_NODE.

So, remove the test and unconditionally set the base type.

Reported-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-3)
--------------------------------------------------------------------------------

[b24508f10b9a] 2020-06-21 15:00:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Sparse v0.6.2

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[6c7e66db21e5] 2020-06-21 14:19:42 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: update release notes

Update the release notes with the changes since v0.6.2-rc1.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/release-notes/v0.6.2.rst (+9/-3)
--------------------------------------------------------------------------------

[9b9f1a0a4f4e] 2020-06-21 11:38:22 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add some info to the main page

Add some info about:
* how to get sparse
* how to install it,
* the mailing list and how to report bugs.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/index.rst (+30/-10)
--------------------------------------------------------------------------------

[c59158c8f967] 2020-06-20 23:40:46 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: switch to the sphinx_rtd theme

The generated documentation used Sphinx's classic/default theme
but the one from readthedocs ('rtd', the same as used for the kernel)
looks nicer, especially in the sidebar, and is not as large.

So, for now, switch to the 'rtd' theme.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/conf.py (+8/-1)
--------------------------------------------------------------------------------

[8451604a75f8] 2020-06-20 23:40:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'fix-gensel'

[Auto-summary] Modifies evaluate.c. Adds/updates 2 test(s). Changes: +50/-3 in 3 file(s)

Files: evaluate.c (+30/-3), validation/generic-bad0.c (+4/-0), validation/generic-dr481.c (+16/-0)
--------------------------------------------------------------------------------

[ad9670d0530c] 2020-06-20 23:38:19 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: gensel: validate the type of the associations

The type in a generic association must correspond to a complete
type and not a variably modified type.

Add validation for this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+20/-0), validation/generic-bad0.c (+4/-0)
--------------------------------------------------------------------------------

[1d91e40cb10a] 2020-06-20 23:26:54 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: gensel: controlling expression must be pointer-converted

Following the resolution of DR481, the controlling expression
of a generic selection must be array-to-pointer converted and
function-to-pointer converted.

Do this by adding a call to degenerate().

Reported-by: Marco Elver <elver@google.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+3/-1), validation/generic-dr481.c (+0/-1)
--------------------------------------------------------------------------------

[2878dae725a9] 2020-06-19 16:02:04 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: gensel: controlling expression must be lvalue converted

Following the resolution of DR481, the controlling expression
of a generic selection must be lvalue converted. In other words,
the qualifiers must be ignored.

Reported-by: Marco Elver <elver@google.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+4/-1)
--------------------------------------------------------------------------------

[383e7d4f1b74] 2020-06-19 15:44:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: gensel: use temporary variable in generic selection

Use a temporary variable for 'map->type' to make the expressions
in the following patches more readable.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+4/-2)
--------------------------------------------------------------------------------

[e06c9268c4e9] 2020-06-19 15:44:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: gensel: add testcases from DR481

Following the resolution of DR481, the controlling expression
is subject to a few different rules.

Add the testcases from this defect report.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/generic-dr481.c (+17/-0)
--------------------------------------------------------------------------------

[c290ad8ed9bc] 2020-06-18 23:47:16 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Sparse v0.6.2-rc2

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[fdbb6dbe1d39] 2020-06-18 22:19:17 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'genmacro'

* support for builtin macros with arguments
* support for __has_feature() & __has_extension()

Files: ident-list.h (+4/-2), lib.c (+0/-2), pre-process.c (+124/-56), symbol.h (+3/-1), validation/preprocessor/has-feature.c (+20/-0)
--------------------------------------------------------------------------------

[05e59dea673e] 2020-06-18 22:02:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: pre-process: make __has_{attribute,builtin}() true builtin macros

The macros __has_atribute() & __has_builtin() are only expanded
in the context of a preprocessor conditional but they should
be expanded like usual user defined macros.

Fix this by using the new infrastructure for builtin macros.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ident-list.h (+0/-2), lib.c (+0/-2), pre-process.c (+32/-52)
--------------------------------------------------------------------------------

[be9df1ee611d] 2020-06-18 21:57:34 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: pre-process: add support for __has_feature() & __has_extension()

Add the trivial methods for the expansion of these macros with:
c_alignas, c_alignof, c_generic_selections and c_static_assert.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: ident-list.h (+4/-0), pre-process.c (+54/-0), validation/preprocessor/has-feature.c (+0/-1)
--------------------------------------------------------------------------------

[27caae403c96] 2020-06-18 21:44:17 +0200
Author: garritfra <garritfranke@gmail.com>
Subject: ir-validate: remove orphan comments

These comments were wrongly added and then forgotten.
So, remove them.

Signed-off-by: Garrit Franke <garritfranke@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: optimize.c (+0/-7)
--------------------------------------------------------------------------------

[31f0c22032d2] 2020-06-18 21:42:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'misc'

[Auto-summary] Adds/updates 1 test(s). Updates documentation. Modifies build system. Changes: +16/-16 in 4 file(s)

Files: Documentation/TODO.md (+2/-3), Documentation/types.rst (+11/-11), Makefile (+2/-1), validation/test-suite (+1/-1)
--------------------------------------------------------------------------------

[e6b31b72c25f] 2020-06-18 21:26:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: pre-process: add support for builtin macros

Sparse support the expansion of one-symbol-builtin macros like __FILE__.
It also support builtin macros with an argument, like 'defined()'
or '__has_attribute()'.

However, these last one are only expanded inside a pre-processor
conditional expression. This is correct for 'defined()' but macros
like '__has_attribute()' should be expanded in all contexts,
like user defined macros.

So, add support for the general expansion of such macros.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+34/-0), symbol.h (+2/-0)
--------------------------------------------------------------------------------

[5d390e127ede] 2020-06-18 21:26:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: pre-process: rename 'expander' into 'expand_simple'

Sparse support the expansion of one-symbol-builtin macros like
__FILE__ or the pre-processor operator 'defined'. It also supports the
expansion of builtin macros with arguments, like __has_attribute()
but only inside a pre-processor conditional expression.

In preparation of adding the general expansion of these macros,
rename the method 'expander' into 'expand_simple'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+4/-4), symbol.h (+1/-1)
--------------------------------------------------------------------------------

[9b14d5925ab2] 2020-06-18 21:26:23 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: pre-process: add testcases for __has_feature() & __has_extension()

The support for these builtin macros is incoming.
So, add some testcases for them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/preprocessor/has-feature.c (+21/-0)
--------------------------------------------------------------------------------

[9cd32cbde900] 2020-06-16 23:10:17 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: be less paranoid with timeout

For some testcases, the testsuite use the command 'timeout'
to ensure that the test finish after a reasonable amount of
time. This is mainly used for some testcases which, in the past,
were stuck in an infinite loop. This the command 'timeout' is
used with an extra option (-k 1s) to issue a second kill signal
in case the first one would have been ignored.

However, this extra option is not supported on all implementations
(Alpine) and its use seems a bit paranoid for sparse.

So, remove this extra option.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/test-suite (+1/-1)
--------------------------------------------------------------------------------

[cbd373504952] 2020-06-16 23:10:15 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: build: let the C++ compiler be configurable

By default, the C compiler is 'gcc' but it can be overridden
on the command line via 'make CC=...'.

However, the C++ compiler (only needed for sparse-llvm) is
hardcoded to 'g++'.

Fix this by allowing to specify the C++ compiler via 'CXX=...'
but keeping 'g++' as the default.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+2/-1)
--------------------------------------------------------------------------------

[c17b1b06c00f] 2020-06-16 23:01:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'sindex-build'

[Auto-summary] Modifies build system. Changes: +7/-0 in 1 file(s)

Files: Makefile (+7/-0)
--------------------------------------------------------------------------------

[bf1408ac0d61] 2020-06-16 20:44:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: reformulate an item in the TODO

One of the item wasn't even grammatical. Reformulate it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/TODO.md (+2/-2)
--------------------------------------------------------------------------------

[1b31044203e6] 2020-06-16 20:44:15 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: fix markup in types.rst (s/```/``/)

Literal text was marked with ``` but that's a bit excessive.

Fix that by replacing these with ``.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/types.rst (+9/-9)
--------------------------------------------------------------------------------

[2bf23b46328b] 2020-06-16 20:30:38 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: fix some typos

Fix some silly typos.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/types.rst (+2/-2)
--------------------------------------------------------------------------------

[6d4506fa2019] 2020-06-16 20:30:05 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: update TODO

Support for __builtin_unreachable() was added in commit
  d2be323e25c3 ("teach sparse to linearize __builtin_unreachable()")

So, remove this item from the TODO list.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/TODO.md (+0/-1)
--------------------------------------------------------------------------------

[729e241bf89a] 2020-06-16 07:03:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: copy the old relnotes here

The releases notes of the versions previously released
are stored on the wiki.

Copy them here too (with minimal changes in the markup),
so that everything is centralized here.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/release-notes/index.rst (+14/-0), Documentation/release-notes/v0.1.rst (+54/-0), Documentation/release-notes/v0.2.rst (+48/-0), Documentation/release-notes/v0.3.rst (+111/-0), Documentation/release-notes/v0.4.1.rst (+29/-0), ... and 10 more
--------------------------------------------------------------------------------

[78f577f89447] 2020-06-16 07:02:02 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add intro stolen from the wiki

The wiki has a small introduction but there is none here.

So, copy this introduction from the wiki into the entrypoint
of the documentation (and convert the wikimedia markup
into restructuredtext).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/index.rst (+37/-0)
--------------------------------------------------------------------------------

[69b9052279a2] 2020-06-16 01:19:24 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: fix code-block formatting in v0.6.2 relnotes

The small code example at the top was in normal text-style
(which is fine) but was lacking the newline between the two
statements (which is much less fine).

Fix this by using a '::' instead of a ':' to trigger the
literal-code-block-and-more style.

Reported-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/release-notes/v0.6.2.rst (+1/-1)
--------------------------------------------------------------------------------

[030d27930858] 2020-06-15 18:39:30 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: minimal version for Sphinx is 1.7

Because of the changes needed after the removal of the obsolete
sphinx.ext.autodoc.AutodocReporter, the minimal version of Sphinx
is 1.7 (the first one containing switch_source_input()).

So, update this information in the conf file.

Fixes: b741a793e63c0fd4a333cd575ac2339f5a9b2698
Reported-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/conf.py (+1/-1)
--------------------------------------------------------------------------------

[556079643d3f] 2020-06-14 22:32:25 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: parse but ignore enum attributes

Currently, sparse is confused when encountering an enum attribute.

Teach sparse about these attributes and, for now, ignore them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+4/-0)
--------------------------------------------------------------------------------

[b8e2004068f9] 2020-06-14 22:32:25 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: reindent the sublists in the relnotes

The html-generated version of the release notes looked
terrible because the used indentation was too small.

Fix this by indenting the sublists by 4 instead of 2

Reported-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/release-notes/v0.6.2.rst (+67/-69)
--------------------------------------------------------------------------------

[42fbf9ae548d] 2020-06-14 22:32:25 +0200
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: doc: correct some spelling

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/release-notes/v0.6.2.rst (+4/-4), sparse.1 (+7/-7)
--------------------------------------------------------------------------------

[ce33665c36e0] 2020-06-14 13:34:47 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sindex: use -stdc=gnu99

sindex use C99 for-loops:
	for (int i = 0, ....)

No problem with this but sparse doesn't use this elsewhere yet
and older compilers don't allow C99 by default.

Fix this by adding '-std=gnu99' to the sindex-specific CFLAGS.

Cc: Alexey Gladkov <gladkov.alexey@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0)
--------------------------------------------------------------------------------

[704d0a285f1e] 2020-06-14 13:28:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: sindex: minimal version for sqlite3 is 3.24

sindex uses the sqlite3_str API which is only present since version
3.24 of SQLite3.

Fix this by adding some checks in the Makefile and refuse to build
it if the requirement is not met.

Cc: Alexey Gladkov <gladkov.alexey@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+6/-0)
--------------------------------------------------------------------------------

[423a9e103669] 2020-06-13 02:42:11 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Sparse v0.6.2-rc1

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-1)
--------------------------------------------------------------------------------

[83c492956bc5] 2020-06-13 02:42:11 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: show the ToC in the sidebar

With the configured theme, 'classic', the table of contents
didn't show up in the sidebar.

It seems it was because 'html_sidebars' was partially set in
conf.py, overhidding the theme defaults.

Fix this by removing 'html_sidebars' from the config.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/conf.py (+1/-6)
--------------------------------------------------------------------------------

[bcc11c748107] 2020-06-13 00:07:06 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add release notes for incoming v0.6.2

Currently, the release notes are kept on the wiki which
contains nothing else but a small intro.

The docs are certainly as good as this wiki to keep these
release notes. So, let try this for now.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/index.rst (+7/-0), Documentation/release-notes/index.rst (+8/-0), Documentation/release-notes/v0.6.2.rst (+100/-0)
--------------------------------------------------------------------------------

[2569db76224a] 2020-06-12 23:47:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add link to the doc on kernel.org in the man page

The generated doc is hosted on readthedocs.io since a little
while but:
* it wasn't much publicised
* it's now also live on sparse.docs.kernel.org

So, add a link to this doc on the manpage.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sparse.1 (+4/-0)
--------------------------------------------------------------------------------

[69433d2abc99] 2020-06-12 23:35:50 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: move meta-doc to its own section

The documentation about the documentation is in the middle of the
documentation about sparse itself.

Move it to its own section.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/index.rst (+7/-1)
--------------------------------------------------------------------------------

[b4dc4b91ce01] 2020-06-12 23:27:14 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: add some doc for the type system

Sparse's type system, or more exactly the way types are encoded
in Sparse's data structures, is not hard but is also not exactly
immediate to grok.

Here is a modest attempt to document this.

The corresponding generated documentation can be find at:
	https://sparse.docs/kernel.org

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/index.rst (+1/-0), Documentation/types.rst (+165/-0)
--------------------------------------------------------------------------------

[1d943afe2b8b] 2020-06-12 23:04:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: ctype: keep modifiers & base_type close

In struct ctype, 'modifiers' & 'base_type' are, by far,
the 2 most frequently used members.

However, `base_type`, the most used, is defined as the last one.

Change this by moving `base_type` as the first one.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+1/-1)
--------------------------------------------------------------------------------

[b125cc059508] 2020-06-12 21:57:58 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'builtins'

* add support for arch-specific builtins

Files: Makefile (+3/-0), builtin.c (+196/-242), builtin.h (+15/-0), lib.c (+1/-1), machine.h (+5/-0), ... and 7 more
--------------------------------------------------------------------------------

[bb213492a306] 2020-06-12 21:56:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: plain chars are never compatible with [un]signed chars

In standard C, plain chars are either signed or unsigned but are only
compatible with themselves, not with signed chars nor with unsigned ones.

However, Sparse has this wrong and make them compatible with the
corresponding sign-qualified chars.

So, add a testcase for this.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/plain-char-compatibility.c (+19/-0)
--------------------------------------------------------------------------------

[11d797903ae1] 2020-06-12 21:41:32 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: arch: add specificities for Alpha

The real goal here is in fact to move the alpha-specfic
builtins out of the main builtins table.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), builtin.c (+0/-9), machine.h (+3/-0), target-alpha.c (+30/-0), target.c (+2/-0), ... and 1 more
--------------------------------------------------------------------------------

[dd8a0323d4a1] 2020-06-12 21:41:32 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: arch: add specificities for Blackfin

The real goal here is in fact to move the bfin-specfic
builtins out of the main builtins table.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), builtin.c (+0/-5), machine.h (+1/-0), target-bfin.c (+26/-0), target.c (+2/-0), ... and 1 more
--------------------------------------------------------------------------------

[1e07ab5a0916] 2020-06-12 21:41:32 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: arch: add specificities for Nios2

The real goal here is, in fact, to move the nios2-specfic
builtins out of the main builtins table.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+1/-0), builtin.c (+0/-5), machine.h (+1/-0), target-nios2.c (+31/-0), target.c (+2/-0), ... and 1 more
--------------------------------------------------------------------------------

[f72b16c3864a] 2020-06-12 21:41:32 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: add support for arch-specific builtins

Now that a table is used for the declaration of builtin functions
it's easy to support arch-specific builtins.

The main objective is to not 'pollute' the main table with
arch-specfic entries for uncommon architectures.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+4/-0), target.h (+4/-0)
--------------------------------------------------------------------------------

[f8dc0b0fc2a0] 2020-06-12 21:41:29 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: unify the 2 tables of builtins

Till now, 2 tables are used to initialize builtin functions:
* an older, small one, without type information, used to set
  a symbol_op to evaluate and/or expand the ones that have
  some associated behaviour.
* a newer and bigger one which only contains what is effectively
  the prototype for these builtins in order to avoid warnings
  about undeclared functions.

It's kinda annoying to have 2 tables for this, even more so
because most entries in the first table also need to be in the
second one (for arguments type and number checking).

Fix this by:
* adding a field in the second table for the symbol_op
* merging or moving the entries in the first table into
  the second one.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+49/-95), builtin.h (+1/-0)
--------------------------------------------------------------------------------

[935cf032524f] 2020-06-12 21:40:10 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: use a table for the builtins

The curent way to declare the builtins is not by using a table
but via a (variadic) function call, one for each builtin.

A table is preferable but a complication for doing this
is that some elements are not constant. For example, 'size_t_ctype'
is dynamically set in the early steps of the type initialization.
Doing a series of function calls allowed to circumvent this.

Fix this by:
* Using a constant temporary alias for non-constant entries. It's the
  value of these alias that will be used when registering the builtins.
* using a table to declare the builtin functions.

Note: the motivation for doing this is to be able to add sub-tables
      for the arch-specific builtins (and use the same mechanism
      as for the main table).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+213/-198), builtin.h (+14/-0), lib.c (+0/-1), symbol.h (+0/-1)
--------------------------------------------------------------------------------

[c1439d43d0bd] 2020-06-12 20:45:57 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: builtin: can be initialized later

The initialization of the buitins can be done later, after
the types have been initialized.

So move the call to init_builtins() to just before declare_builtins().
This will allow some other small improvements.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-0), symbol.c (+0/-1)
--------------------------------------------------------------------------------

[42323db39555] 2020-06-09 20:41:55 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: nios2: add declaration for __builtin_{rd,wr}ctl()

These 2 are used for the kernel and the lack of a
declaration is causing problems.

So add the declarations for these 2 builtins.
At the same time also add one for '__builtin_custom_ini()'
since this one may also be used in the kernel.

Note: a better fix should be to move this to target-nios2.c

Link: https://lore.kernel.org/lkml/20200609151329.GU23011@xsang-OptiPlex-9020/
Reported-by: kbuild test robot <lkp@intel.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+5/-0)
--------------------------------------------------------------------------------

[966dd78f873a] 2020-06-09 01:32:15 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: generic: fix crash when nothing match

The code for the generic selection doesn't take in account
the fact that the default entry could be absent.

Catch the case where nothing matches and issue an error.

Fixes: c100a7ab2504f9e6fe6b6d3f9a010a8ea5ed30a3
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+6/-2), validation/generic-bad0.c (+23/-0)
--------------------------------------------------------------------------------

[08256ea9dfd1] 2020-06-06 23:44:58 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: pre-process: remove unneeded declaration of show_token_sequence()

Remove this declaration which follows the definition.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+0/-2)
--------------------------------------------------------------------------------

[cadbd1245ace] 2020-06-06 00:32:50 +0200
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: pre-process: fix a compiler array subscript type warning

On cygwin, the <ctype.h> header is written in such a way as to cause
a gcc compiler warning if a plain 'char' is passed to the character
classification macros (in this case isdigit). The result is defined
only if the parameter is representable as an unsigned char, or if it
is EOF.

When passing a 'char' type argument to isdigit(), the compiler warns
like so:

    CC      pre-process.o
  In file included from pre-process.c:33:
  pre-process.c: In function predefine:
  pre-process.c:1429:18: warning: array subscript has type char [-Wchar-subscripts]
   1429 |   if (isdigit(buf[0])) {
        |               ~~~^~~

In order to suppress the warning, cast the argument of isdigit() to
an 'unsigned char' type.

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+1/-1)
--------------------------------------------------------------------------------

[41f651b442fa] 2020-06-03 13:17:35 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: univ-init: set default to -Wno-universal-initializer

'{ 0 }' is the standard idiom for the universal zero initializer '{ }'.

But if the '0' is taken literally, warnings can be issued, for exemple
for 'using 0 as NULL pointer' or for 'using a positional initializer'
when the attribute 'designated_init' is used.
These warnings were not intended to be issued for this initializer
and are confusing and annoying when people have to use or want to
use standard code or ignore that '{ }' is fine to use with GCC,
clang or Sparse.

So, set sparse default to -Wno-universal-initializer, suppressing
any warnings caused by using '{ 0 }' instead of '{ }'.

Reference: https://lore.kernel.org/git/e6796c60-a870-e761-3b07-b680f934c537@ramsayjones.plus.com/
Reference: https://gcc.gnu.org/bugzilla/show_bug.cgi?id=95379
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+1/-1), sparse.1 (+6/-4)
--------------------------------------------------------------------------------

[3800353ba503] 2020-06-03 13:17:35 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: univ-init: scalar initializer needs some additional checks

Currently, -Wno-universal-initializer is simply implemented
by simply replacing '{ 0 }' by '{ }'.

However, this is a bit too simple when it concerns scalars
initialized with '{ 0 }' because:
* sparse & GCC issued warnings for empty scalar initializers
* initializing a pointer with '{ }' is extra bad.

So, restore the old behaviour for scalar initializers.
This is done by leaving '{ 0 }' as-is at parse time and changing
it as '{ }' only at evaluation time for compound initializers.

Fixes: 537e3e2daebd37d69447e65535fc94e82b38fc18
Thanks-to: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+3/-0), expression.h (+1/-0), parse.c (+10/-7), validation/Wuniv-init-ko.c (+17/-0), validation/Wuniv-init-ok.c (+18/-0)
--------------------------------------------------------------------------------

[0ee050a84a29] 2020-05-30 18:51:38 +0100
Author: Ramsay Jones <ramsay@ramsayjones.plus.com>
Subject: evaluate: mark evaluate_generic_selection() as static

Commit c100a7ab (add support for _Generic, 2020-05-28) added the
function evaluate_generic_selection() as an external symbol, without
providing an external declaration in a header file. This causes
sparse to issue a warning as part of the 'selfcheck' target.

Since this function does not (currently) need to be an external symbol,
mark it as static.

Signed-off-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-1)
--------------------------------------------------------------------------------

[c100a7ab2504] 2020-05-28 16:59:37 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support for _Generic

It's slightly tested but is fine for the latest kernels
like https://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.git locking/kcsan

Note: a known difference with GCC is that it doesn't make the
      distinction between 'signed char' and a plain 'char'
      (on platforms where plain char are signed) since it's using
      the usual type compatbility like used for assignements.

Reference: lore.kernel.org/r/20200527235442.GC1805@zn.tnic
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+36/-0), expand.c (+1/-0), expression.c (+40/-0), expression.h (+16/-0), show-parse.c (+3/-0), ... and 3 more
--------------------------------------------------------------------------------

[f7679db159d0] 2020-05-27 21:10:59 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add testcase for duplicated local definitions

Sparse warn when a top-level object is initialized multiple
times but doesn't warn when it's a local object.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/dup-defs-local.c (+28/-0)
--------------------------------------------------------------------------------

[3fa54adf7994] 2020-05-27 21:02:38 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add an option to suppress warning 'no newline at EOF'

Some platforms have some of their system header files missing the
ending newline. Sparse will then warn about it, again and again,
and more important warnings can easily be lost in the noise.

So, add an option flag '-W[no-]newline-eof' to conditionalize
this warning.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+2/-0), lib.h (+1/-0), sparse.1 (+7/-0), tokenize.c (+1/-1)
--------------------------------------------------------------------------------

[f0fe1cd9e4fe] 2020-05-21 18:28:38 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'univ'

* conditionally accept { 0 } without warnings

Files: lib.c (+2/-0), lib.h (+1/-0), parse.c (+7/-0), sparse.1 (+8/-0), token.h (+7/-0), ... and 2 more
--------------------------------------------------------------------------------

[4d96f72782e0] 2020-05-21 18:23:04 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'bad-goto'

* warn when jumping into statement expressions
* warn when using undefined labels
* warn on defined but unused labels

It's not allowed to do a goto into an expression statement.
For example, it's not well defined what should happen if such
an expression is not otherwise reachable and/or can be optimized
away. For such situations GCC issues an error, clang doesn't
and produce a valid IR but Spare produce an invalid IR with
branches to unexisting BBs.

The goals of the patches in this series are:
*) to detect such gotos at evaluation time;
*) issue a sensible error message;
*) avoid the linearization of functions with invalid gotos.

The implementation principle behind these is to add a new kind
of scope (label_scope), one for the usual function scope of
labels one for each statement expressions. This new scope,
instead of being used as a real scope for the visibility of
labels, is used to mark where labels are defined and where
they're used.

Using this label scope as a real scope controling the
visibility of labels was quite appealing and was the initial
drive for this implementation but has the problem of inner
scope shadowing earlier occurence of labels identically
named. This is of course desired for 'normal' symbols but for
labels (which are normally visible in the whole function
and which may be used before being declared/defined)
it has the disadvantage of:
*) inhibiting the detecting of misuses once an inner scope
   is closed
*) allowing several distinct labels with the same name
   in a single function (this can be regarded as a feature
   but __label__ at block scope should be used for this)
*) create diffrences about what is permssble or not between
   sparse and GCC or clang.

Files: evaluate.c (+28/-8), expand.c (+1/-1), expression.c (+6/-6), linearize.c (+1/-1), parse.c (+55/-18), ... and 26 more
--------------------------------------------------------------------------------

[537e3e2daebd] 2020-05-21 17:53:57 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: univ-init: conditionally accept { 0 } without warnings

In standard C '{ 0 }' is valid to initialize any compound object.
OTOH, Sparse allows '{ }' for the same purpose but:
1) '{ }' is not standard
2) Sparse warns when using '0' to initialize pointers.

Some projects (git) legitimately like to be able to use the
standard '{ 0 }' without the null-pointer warnings

So, add a new warning flag (-Wno-universal-initializer) to
handle '{ 0 }' as '{ }', suppressing the warnings.

Reference: https://lore.kernel.org/git/1df91aa4-dda5-64da-6ae3-5d65e50a55c5@ramsayjones.plus.com/
Reference: https://lore.kernel.org/git/e6796c60-a870-e761-3b07-b680f934c537@ramsayjones.plus.com/
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+2/-0), lib.h (+1/-0), parse.c (+7/-0), sparse.1 (+8/-0), validation/Wuniv-init-ko.c (+14/-0), ... and 1 more
--------------------------------------------------------------------------------

[18351292096b] 2020-05-21 17:40:33 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'fun-attr'

* improve handling of function attributes
* separate modifiers into type/declaration
* add support for attributes 'unused' & 'gnu_inline'
* simplify parsing of inline/__tls/__visible

Files: parse.c (+27/-31), show-parse.c (+15/-13), symbol.h (+9/-5), validation/attr-visible.c (+0/-1), validation/attr-visible2.c (+0/-1), ... and 2 more
--------------------------------------------------------------------------------

[386baba96aa1] 2020-05-21 17:35:18 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'doc-update' * doc: do not use obsolete sphinx's AutodocReporter

[Auto-summary] Updates documentation. Changes: +28/-28 in 3 file(s)

Files: Documentation/TODO.md (+5/-7), Documentation/nocast-vs-bitwise.md (+18/-16), Documentation/sphinx/cdoc.py (+5/-5)
--------------------------------------------------------------------------------

[384008074a8d] 2020-05-21 17:27:46 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bad-label: respect attribute((unused))

Currently, attributes on labels were simply ignored. This was fine
since nothing was done wth them anyway.

But now that Sparse can give a warning for unused labels it would
be nice to also support the attribute 'unused' not to issues the
warning when not desired.

So, add a small helper around handle_attributes() and use this
instead of skipping the attributes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+10/-1), scope.c (+2/-0), symbol.h (+1/-0), validation/label-unused.c (+6/-0)
--------------------------------------------------------------------------------

[d89355c8ec57] 2020-05-21 17:27:46 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bad-label: mark labels as used when needed

In most cases symbols are automatically marked as being used via
a successfull call to lookup_symbols(), the idea being that the
symbol will be created at its declaration and then any (successfull)
lookup will correspond to an use.

For labels, things are slightly different because labels are
created on-demand via label_symbol() and their use can precede their
'declaration'. And of, course, label_symbol() has no ways to know
if it is used for a definition or an use.

So, fix this by adding an argument to label_symbol(), explictly
telling if the call correspond to an use or not.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expression.c (+1/-1), parse.c (+6/-4), parse.h (+1/-1)
--------------------------------------------------------------------------------

[b307a6b54da6] 2020-05-21 17:27:46 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bad-label: check for unused labels

Issue a warning if a label is defined but not used.

Note: this should take in account the attribute 'unused'.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: scope.c (+8/-0), validation/label-unused.c (+0/-1)
--------------------------------------------------------------------------------

[f3ec4bb41cdd] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bad-goto: check declaration of label expressions

Issue an error when taking the address of an undeclared label
and mark the function as improper for linearization since
the resulting IR would be invalid.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-0), validation/label-scope-cgoto.c (+0/-1), validation/linear/label-scope-cgoto.c (+0/-1)
--------------------------------------------------------------------------------

[c5421b0d1ab0] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bad-goto: extract check_label_declaration()

Extract this helper from evaluate_goto_statement().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+16/-6)
--------------------------------------------------------------------------------

[25216452d77c] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bad-goto: label expression inside a statement expression is UB

More exactly, what is undefined is to jump inside the statement
expression with a computed goto.

Of course, once the address of such a label is taken, it's generaly
impossible to track if it will be used or not to jump inside the
statement expression.

So, for now, handle taking the address of such a label from outside
the statement expression, exactly as if a computed goto is effectively
done from there and so issue an error message and also mark the function
as useless for linearization.

Note: this is only partially correct since:
      1) the address could be taken from outside the statement
         and never used for a computed goto.
      2) the address could be taken from outside the statement
         but the corresponding computed goto only done from
         inside, which is perfectly fine.
      3) the address could be taken from inside but a computed
         goto done from outside.

Note: the real problem, like for the regular goto, is that the
      statement expression can be eliminated before linearization,
      the correspondng gotos corresponding then to branches to
      unexistent BBs.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expression.c (+1/-0)
--------------------------------------------------------------------------------

[33319e351c28] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bad-goto: jumping inside a statement expression is an error

It's invalid to jump inside a statement expression.

So, detect such jumps, issue an error message and mark the
function as useless for linearization since the resulting IR
would be invalid.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+26/-4), parse.h (+1/-0), validation/label-scope2.c (+0/-1), validation/label-stmt-expr0.c (+0/-1), validation/label-stmt-expr1.c (+0/-1), ... and 3 more
--------------------------------------------------------------------------------

[177f5fe2255e] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: scope: give a scope for labels & gotos

One way of detecting gotos inside an statement expression
is to use a new kind of scope for the gotos & labels.
Since gotos don't need to have their label predeclared,
nothing can be checked at parsing time but later it can
be checked that a goto doesn't jump inside one of the
label scope created by statement expressions.

So, add additional scope information to gotos and labels
to allow such check to be done.

Note: the label's symbols are still created in the function
      scope since they belong to a single namespace.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+7/-1), parse.h (+1/-0), symbol.h (+4/-0)
--------------------------------------------------------------------------------

[eff5e6c1a4e6] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: scope: add is_in_scope()

Add an helper to check if a scope is included into another one.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: scope.c (+9/-0), scope.h (+2/-0)
--------------------------------------------------------------------------------

[db0a795b1455] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: scope: let labels have their own scope

It's invalid to jump inside a statement expression.
So, concerning labels & gotos, a statement expression is
like a kind of scope.

So, in preparation for the detection of such jumps, create
these new scopes and open/close them when entering/leaving
statement expressions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expression.c (+2/-0), scope.c (+15/-2), scope.h (+4/-0)
--------------------------------------------------------------------------------

[dbaf79f0e3ab] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: scope: s/{start,end}_symbol_scope/{start,end}_block_scope/

The functions {start,end}_symbol_scope() haven't been renamed
when separated scope have been introduced for functions & blocks.
But these functions only start & end a block scope.

So, rename them to their more direct name: {start,end}_block_scope().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+6/-6), scope.c (+2/-2), scope.h (+2/-2)
--------------------------------------------------------------------------------

[5e8b78ce213f] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: scope: __label__ is special

Labels declared wth __label__ are special because they must follow
the block scope normally used for variables instad of using the
scope used for labels.

So, use bind_symbol_with_scope() instead of first using bind_symbol()
and then changing the namespace.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-2)
--------------------------------------------------------------------------------

[c1b89f892ebe] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: scope: __func__ is special

__func__ needs to be in the namepsace for symbols: NS_SYMBOL
but doesn't follow the usual scope rules of them: it always
needs to be declared in the function scope.

So, use bind_symbol_with_scope() instead of first using bind_symbol()
and then changing the namespace.
Also change the comment to better express that it's the scope
that is the unusual thing.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expression.c (+2/-3)
--------------------------------------------------------------------------------

[91de00e92952] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: scope: extract bind_symbol_with_scope() from bind_symbol()

In most cases, the scope that must be used for a symbol is
given by its namespace.

However, in some situations a different scope must be used.
This is then set, for example by doing the lookup with
the wrong namespace (but corresponding to the desired scope)
and changing it just after to its correct value.

To avoid these contortions, extract from bind_symbol() a version
where the scope can be explicitly given: bind_symbol_with_scope().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.c (+9/-4), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[93ec535db78b] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: scope: move scope opening/ending inside compound_statement()

A compound statement starts and ends a block scope, so
it's better to start & end this scope inside the function
parsing the statement: compound_statement.
The only exception is for the body of a function where
the scope also enclose the parameter declaration but that
is fine since the function is special anyway.

Move the calls to start & close the block scope inside
compound_statement() and directly call statement_list()
for the function body.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expression.c (+0/-2), parse.c (+6/-7)
--------------------------------------------------------------------------------

[06c0531322a5] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: scope: no memset() needed after __alloc_scope()

When starting some scopes, the newly allocated struct is
memset'ed with zero but this is unneeded since the allocator
always returns zeroed memory.

Remove the unneeded call to memset().

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: scope.c (+0/-2)
--------------------------------------------------------------------------------

[38e7c70c3074] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bad-goto: catch labels with reserved names

If a reserved name is used as the destination of a goto,
its associated label won't be valid and at linearization
time no BB will can be created for it, resulting in an
invalid IR.

So, catch such gotos at evaluation time and mark the
function to not be linearized.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+2/-0), validation/linear/goto-invalid.c (+0/-1)
--------------------------------------------------------------------------------

[4e70521d74cb] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bad-goto: do not linearize function with undeclared labels

It's not possible to produce a valid & correct IR if
the function contains a goto to an undeclared label.

So, try to catch these situations and mark the function
as such, the linearization will then simply ignore it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+1/-0)
--------------------------------------------------------------------------------

[86edd142e6fa] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bad-goto: simplify testing of undeclared labels

There is no need to do a lookup: checking if the label's
symbol is in the NS_LABEL namespace and is lacking an
associated statement is enough and much simpler.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+2/-1)
--------------------------------------------------------------------------------

[4a71ea181024] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bad-goto: reorg test in evaluate_goto_statement()

No functional changes here, only changing the code structure
to prepare more incoming changes.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+7/-3)
--------------------------------------------------------------------------------

[557aba56c4bc] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bad-goto: do not linearize if the IR will be invalid

In some error cases, it's not possible to produce a valid &
correct IR for the concerned function. For exemple, if the
AST contains invalid gotos, the CFG will either be invalid
or won't correspond to the erroneous source code.

So, refuse to linearize such functions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+1/-1), symbol.h (+1/-0)
--------------------------------------------------------------------------------

[633a390c1690] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bad-goto: reorganize testcases and add some more

Reorganize the testcases related to the 'scope' of labels
and add a few new ones.

Also, some related testcases have some unreported errors other
than the features being tested. This is a problem since such
tescases can still fail after the feature being tested is fixed
or implemented. So, fix these testcases or split them so that
they each test a unique feature.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/__func__-scope.c (+8/-0), validation/{asm-goto-lables.c => asm-goto-labels.c} (+0/-0), validation/label-asm.c (+1/-0), validation/label-attr.c (+1/-1), validation/label-scope-cgoto.c (+83/-0), ... and 13 more
--------------------------------------------------------------------------------

[0b6d161ed1cc] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bad-goto: add testcases for linearization of invalid labels

A goto to a reserved or a undeclared label will generate
an IR with a branch to a non-existing BB. Bad.

Add a testcase for these.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/linear/invalid-labels0.c (+19/-0)
--------------------------------------------------------------------------------

[aa42800cc4ac] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: bad-goto: add testcase for 'jump inside discarded expression statement'

A goto done into an piece of code discarded at expand or
linearize time will produce an invalid IR.

Add a testcase for it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/label-stmt-expr1.c (+29/-0), validation/linear/goto-and-expr-stmt0.c (+28/-0)
--------------------------------------------------------------------------------

[154278d4e26d] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: misc: always use the node for current_fn

At evaluation time and at expansion time, current_fn is set
to the function's base type (SYM_FN) but at parse time it's
set to its parent type (SYM_NODE).

Since current_fn is used to access the corresponding ident,
it should be set to the node type, not the base.

So, always set current_fn to the node type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+2/-2), expand.c (+1/-1)
--------------------------------------------------------------------------------

[62596fe4efb1] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: misc: s/fntype/rettype/

In evaluate_return_expression(), it's checked if the type of
the return statement match the function return type.

But, the variable used to hold this type is named 'fntype'
which is slightly confusing.

So, rename the variable holding the return type to 'rettype'
and only use 'fntype' for the one holding the full function type.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+6/-5)
--------------------------------------------------------------------------------

[efda1a044c7c] 2020-05-21 17:27:45 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: misc: fix testcase typeof-safe

This testcase was marked as known-to-fail but it was
simply the expected error messages that were missing.

So, slightly reorganize the test a little bit, add the
expected messages and remove the 'known-to-fail' tag.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/typeof-safe.c (+20/-7)
--------------------------------------------------------------------------------

[80e2b2a0fc0f] 2020-05-19 22:06:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: testsuite: add a few testcases for nested functions

Sparse doesn't really support nested functions but is
able to parse them correctly.

Add some testcases with them so that it continue to
catch possible errors concerning them.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/nested-functions.c (+43/-0)
--------------------------------------------------------------------------------

[d1c0ce0393ca] 2020-05-19 01:25:57 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: 'externally_visible' is just another 'declaration' modifier

Now that the distinction is made between type modifiers and
'declaration' modifiers, there is no more reasons to parse
this attribute differently than other attributes/modifiers.
Even more so because this special casing made this attribute
to be ignored when placed after the declarator.

So, use the the generic code for 'declaration modifiers'
to parse this attribute.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+3/-15), symbol.h (+0/-1), validation/attr-visible.c (+0/-1), validation/attr-visible2.c (+0/-1)
--------------------------------------------------------------------------------

[b496110b16a6] 2020-05-19 01:25:53 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: 'inline' is just another 'declaration' modifier

Now that the distinction is made between type modifiers and
'declaration' modifiers, there is no more reasons to parse
this attribute differently than other attributes/modifiers.

So, use the the generic code for 'declaration modifiers'
to parse this attribute.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+2/-2), symbol.h (+2/-2)
--------------------------------------------------------------------------------

[185572dd1d9e] 2020-05-19 01:25:48 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: '__tls' is just another 'declaration' modifier

Now that the distinction is made between type modifiers and
'declaration' modifiers, there is no more reasons to parse
this attribute differently than other attributes/modifiers.

So, use the the generic code for 'declaration modifiers'
to parse this attribute.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+3/-3), symbol.h (+2/-2)
--------------------------------------------------------------------------------

[850c8625ae78] 2020-05-18 04:08:31 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: univ-init: add helper match_token_zero()

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: token.h (+7/-0)
--------------------------------------------------------------------------------

[146e6a63e715] 2020-05-17 23:24:09 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: teach sparse about attribute((gnu_inline))

But for the moment do nothing special with it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+2/-0), show-parse.c (+1/-0), symbol.h (+4/-4)
--------------------------------------------------------------------------------

[f3bb11fc7cc4] 2020-05-17 23:24:09 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: separate modifiers into type/declaration

When parsing a declaration, type specifiers, qualifiers and other
modifiers are handled by declaration_specifiers(). Some of these
are part of the type being declared but some others only concern
the object in itself. For example, the storage specifiers pertains
to the objects being declared but not their type. Because of this
the storage specifiers need to be processed separately in order to
be correctly applied to the object node. This is done via the helper:
storage_modifier().

However, some attributes are exactly in the same situation (an
obvious example is something like the section attribute).
These attributes should also be moved to the declaration and it's
only because they are currently ignored/without effect that they're
not causing problem in the type.

So generalize storage_modifiers() into decl_modifiers() to extract
all modifiers not pertaining to the type of the declared object.

The modifiers currently concerned are the attributes:
  - unused
  - pure
  - noreturn
  - externally_visible

Note: currently this change shouldn't have any effects other
      than not showing anymore the "[unused]" when displaying
      the type differences in diagnostics.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+8/-6), symbol.h (+3/-0)
--------------------------------------------------------------------------------

[d58b2cd305c6] 2020-05-17 23:24:09 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: add support for unused

Add support for the attribute 'unused' (and its double underscore
variant. There is no semantic attached to it but it's now at least
parsed and added to the modifiers.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+2/-0), show-parse.c (+1/-0), symbol.h (+3/-3)
--------------------------------------------------------------------------------

[b508d84449b1] 2020-05-17 23:23:56 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: allow some attribute to be present multiple times

A warning is issued when a qualifier or another modifier
is present more than once in a declaration.

This is fine but in the kernel some attributes, for example
'unused' & 'gnu_inline', are sometimes present multiple times
in the same declaration (mainly they are added in the define
used for 'inline'). This then creates a lot of useless noise.

So, use a (now empty) white list to not warn when these attributes
are present multiple times in the same declaration.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-1), symbol.h (+2/-0)
--------------------------------------------------------------------------------

[d3a25d90664d] 2020-05-17 23:23:01 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: add helper apply_mod() and use it

to avoid duplicated code checking for ... duplicated modifiers!

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+9/-7)
--------------------------------------------------------------------------------

[98fa204a2da0] 2020-05-17 22:58:22 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: attribute: sort the table of modifier names

It easier to search an item if sorted and this avoid needless
conflict when new items are always added at the end of the table.

So, sort the table but keep the storage modifers first so
that show_typename() & friends still display types as usual.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: show-parse.c (+13/-13), validation/cond_expr2.c (+1/-1), validation/function-redecl.c (+3/-3)
--------------------------------------------------------------------------------

[baf385aae029] 2020-05-15 17:49:20 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: misc: fix typo: s/OS_UNIX/OS_NATIVE/

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: machine.h (+1/-1)
--------------------------------------------------------------------------------

[47aa4bdcf62f] 2020-05-15 14:33:06 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: remove done item from the TODO

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/TODO.md (+0/-6)
--------------------------------------------------------------------------------

[6a738e1eab22] 2020-05-15 14:32:56 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: fix the warnings when building the doc

It seems that Markdown is now parsed slightly differently and
now generate some warnings.

So tweak the .md files to shut up the warnings.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/TODO.md (+5/-1), Documentation/nocast-vs-bitwise.md (+18/-16)
--------------------------------------------------------------------------------

[b741a793e63c] 2020-05-15 14:24:32 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: doc: do not use obsolete sphinx.ext.autodoc.AutodocReporter

sphinx.ext.autodoc.AutodocReporter is obsolete since Sphinx 1.7
and removed in some later versions.

So, replace it by the code suggested in the release notes when
it was obsoleted.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/sphinx/cdoc.py (+5/-5)
--------------------------------------------------------------------------------

[b8fad4bcd022] 2020-05-14 22:59:07 +0200
Author: Davidson Francis <davidsondfgl@gmail.com>
Subject: show-parse: null pointer dereference in do_show_type()

In do_show_type() the first if statement allows passing null
pointers, which can cause a null pointer dereference in some
cases, which I believe is not the desired behavior.

Fix this by changing the first if statement comparison.

Signed-off-by: Davidson Francis <davidsondfgl@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: show-parse.c (+1/-1)
--------------------------------------------------------------------------------

[1bca83e8bfdc] 2020-05-14 22:58:51 +0200
Author: Quentin Monnet <quentin@isovalent.com>
Subject: build: fix LLVM version detection

The regex match used for detecting the LLVM version works for versions
with a single-digit major number. Now that LLVM v10 is out, detection
can fail, resulting in sparse-llvm not being built.

Fix detection by extracting the major version number to compare with the
minimum supported.

Signed-off-by: Quentin Monnet <quentin@isovalent.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Makefile (+2/-1)
--------------------------------------------------------------------------------

[c51a0382202e] 2020-04-13 14:39:52 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'fix-atomic-type'

* fix type compatibility of _Atomic types

Files: symbol.h (+3/-3), validation/c11-atomic.c (+37/-21), validation/typeof-mods.c (+1/-1)
--------------------------------------------------------------------------------

[0f5a39dcea89] 2020-04-11 08:19:38 +0200
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: do not use expr->left for conditionals

expr->left & expr->conditional are unioned but 'left'
should only be used for binary operators.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: expression.c (+1/-1)
--------------------------------------------------------------------------------

[79f7ac984473] 2020-03-24 10:51:35 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support for GCC's __auto_type

Despite the similarity with typeof, the approach taken here
is relatively different. A specific symbol type (SYM_TYPEOF)
is not used, instead a new flag is added to decl_state, another
one in the declared symbol and a new internal type is used:
'autotype_ctype'. It's this new internal type that will be
resolved to the definitive type at evalution time.

It seems to be working pretty well, maybe because it
hasn't been tested well enough.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+38/-0), symbol.c (+19/-0), symbol.h (+2/-0), validation/autotype-ko.c (+45/-0), validation/autotype.c (+55/-0)
--------------------------------------------------------------------------------

[bff9b106e8fc] 2020-03-20 16:24:19 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'unreach'

* generate OP_UNREACH from  __builtin_unreachable()
* add OP_UNREACH after calls to __noreturn functions

Files: Documentation/IR.rst (+3/-0), builtin.c (+2/-0), linearize.c (+52/-0), opcode.def (+1/-0), symbol.h (+6/-1), ... and 4 more
--------------------------------------------------------------------------------

[d2be323e25c3] 2020-03-20 00:52:39 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse to linearize __builtin_unreachable()

__builtin_unreachable() is one of the builtin that shouldn't
be ignored at IR level since it directly impact the CFG.

So, add the infrastructure put in place in the previous patch
to generate the OP_UNREACH instruction instead of generating
a call to a non-existing function "__builtin_unreachable()".

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+7/-0), validation/context-unreachable.c (+0/-1), validation/linear/builtin_unreachable0.c (+0/-1), validation/linear/builtin_unreachable1.c (+0/-1)
--------------------------------------------------------------------------------

[c88f0098ff20] 2020-03-20 00:52:39 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add support for linearization of builtins

Sparse ignores most builtins. A few of them are directly
interpreted at parsing time (types_compatible_p, offsetof).
Some others are expanded if their argument(s) are constant
but that's all.

However, some of the builtins are significant at the IR
level and shouldn't thus be ignored.

This patch add the support needed for the linearization of
these builtins.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: builtin.c (+2/-0), linearize.c (+32/-0), symbol.h (+6/-1)
--------------------------------------------------------------------------------

[e737cc332ccb] 2020-03-20 00:52:39 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add an implicit __builtin_unreachable() for __noreturn

The semantic of a __noreturn function is that ... it doesn't return.

So, insert an instruction OP_UNREACH after calls to such functions.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: linearize.c (+10/-0), validation/linear/noreturn-unreachable0.c (+0/-1)
--------------------------------------------------------------------------------

[326046a5850b] 2020-03-20 00:52:39 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add instruction OP_UNREACH

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: Documentation/IR.rst (+3/-0), linearize.c (+3/-0), opcode.def (+1/-0)
--------------------------------------------------------------------------------

[0095a95a31bb] 2020-03-20 00:52:28 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add testcases for OP_UNREACH

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/context-unreachable.c (+16/-0), validation/linear/builtin_unreachable0.c (+28/-0), validation/linear/{builtin_unreachable.c => builtin_unreachable1.c} (+7/-7), validation/linear/noreturn-unreachable0.c (+23/-0)
--------------------------------------------------------------------------------

[83789bbc4d38] 2020-03-18 20:50:08 +0100
Author: Alexey Gladkov <gladkov.alexey@gmail.com>
Subject: sindex: Add option to search by location

To create plugin for text editor, it may be useful to be able to search
by position in a file.

$ sindex search -l include/uapi/linux/msdos_fs.h:91:8
(---) fs/fat/dir.c 759 1 fat_ioctl_filldir FAT_IOCTL_FILLDIR_FUNC(fat_ioctl_filldir, __fat_dirent)
(r--) fs/fat/dir.c 759 1 fat_ioctl_filldir FAT_IOCTL_FILLDIR_FUNC(fat_ioctl_filldir, __fat_dirent)
(m--) fs/fat/dir.c 759 1 fat_ioctl_filldir FAT_IOCTL_FILLDIR_FUNC(fat_ioctl_filldir, __fat_dirent)
(def) include/uapi/linux/msdos_fs.h 91 8   long  d_ino;

$ sindex search -l -m w include/uapi/linux/msdos_fs.h:91:8
(m--) fs/fat/dir.c 759 1 fat_ioctl_filldir FAT_IOCTL_FILLDIR_FUNC(fat_ioctl_filldir, __fat_dirent)

Another use is to get the full name of symbol in case of a high level
of nesting:

$ sindex search -e fs/dcache.c:567
(--r) fs/dcache.c 567 9 __dentry_kill   dentry->d_op->d_prune(dentry);
(--r) fs/dcache.c 567 15 __dentry_kill   dentry->d_op->d_prune(dentry);

$ sindex search -e --format='%n' fs/dcache.c:567
dentry.d_op
dentry_operations.d_prune

$ sindex search -e --format='%n' fs/dcache.c:567:9
dentry.d_op

Signed-off-by: Alexey Gladkov <gladkov.alexey@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: sindex.1 (+8/-0), sindex.c (+72/-2)
--------------------------------------------------------------------------------

[0558317d0c7a] 2020-03-16 00:48:45 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cpp: fix redefinition of a macro during its own expansion

The presence of preprocessor directives within the arguments
of a macro invocation is Undefined Behaviour but most of
these directives, like the conditionals, are well-defined
and harmless.

OTOH, the redefinition of a macro during its own expansion makes
much less sense. However, it can be given a reasonable meaning:
* use the initial definition for the macro body
* use the new defintion for its arguments, in text order.
It's what gcc & clang do but Sparse can't handle this
because, during the expansion, a reference to the initial
macro's body is not kept. What is used instead is what is
currently associated with the macro.

Fix this by using the body associated with the macro at
the time of its invocation.

Testcase-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+2/-1), validation/preprocessor/expand-redef.c (+20/-0)
--------------------------------------------------------------------------------

[6e5fbe9870a8] 2020-03-15 23:52:29 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cpp: remove extra newlines during macro expansion

During macro expansion, Sparse doesn't strip newlines from
the arguments as required by 6.10.3p10 and done by gcc & clang.

So, remove these newlines.

Note: the current behaviour may make the preprocessed output
      more readable (and so may be considered as a feature).

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+1/-0), validation/preprocessor/directive-within-macro.c (+2/-6), validation/preprocessor/expand-and-nl.c (+13/-0), validation/preprocessor/preprocessor22.c (+1/-3)
--------------------------------------------------------------------------------

[5c2338f694cd] 2020-03-15 23:52:18 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: cpp: silently allow conditional directives within a macro

The presence of preprocessor directives within the arguments
of a macro invocation is Undefined Behaviour [6.10.3p11].
However, conditional directives are harmless here and are
useful (and commonly used in the kernel).

So, relax the warning by restricting it to non-conditional
directives.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+14/-3), validation/preprocessor/directive-within-macro.c (+40/-0), validation/preprocessor/preprocessor22.c (+1/-1)
--------------------------------------------------------------------------------

[0e3729b3edb8] 2020-03-15 23:25:15 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: make "directive in macro's argument list" a warning

The presence of preprocessor directives within the arguments
of a macro invocation is Undefined Behaviour [6.10.3p11].
Sparse issues an error for this but most often the result is
well defined and is not a problem, processing can continue
(for example, when the directive is one of the conditional ones).

So, downgrade this sparse_error() to warning() (especially
because issuing an error message can hide those coming later).

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: pre-process.c (+1/-1), validation/preprocessor/preprocessor22.c (+4/-4)
--------------------------------------------------------------------------------

[bc544c461c14] 2020-03-15 23:12:30 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: teach sparse about -pedantic/-Wpedantic

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+14/-0), lib.h (+1/-0)
--------------------------------------------------------------------------------

[9d31ee5fc730] 2020-03-11 22:43:59 +0100
Author: Alexey Gladkov <gladkov.alexey@gmail.com>
Subject: Add semantic index utility

sindex is the simple to use cscope-like tool based on sparse/dissect.
Unlike cscope it runs after pre-processor and thus it can't index the
code filtered out by ifdef's, but otoh it understands how the symbol
is used and it can track the usage of struct members.

To create an index for your linux kernel configuration:

$ make C=2 CHECK="sindex add --"

Now, to find where a definition of the pid field from the task_struct
structure:

$ sindex search -m def task_struct.pid
(def) include/linux/sched.h 793 11   pid_t    pid;

default output format:

SOURCE-FILE \t LINE-NUMBER \t COLUMN \t IN FUNCTION NAME \t CODE LINE

To find where this field changes:

$ sindex search -m w task_struct.pid
(-w-) fs/exec.c 1154 6 de_thread   tsk->pid = leader->pid;
(-w-) kernel/fork.c 2155 3 copy_process  p->pid = pid_nr(pid);

To get only filenames and line number you can change output format:

$ sindex search -f '%f:%l' -m w task_struct.pid
fs/exec.c:1154
kernel/fork.c:2155

Current limitations:

* inline functions are ignored;
* enums are ignored;
* unknown #include leads to a fatal error.

Suggested-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Alexey Gladkov <gladkov.alexey@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: .gitignore (+1/-0), Makefile (+11/-1), sindex.1 (+143/-0), sindex.c (+1094/-0)
--------------------------------------------------------------------------------

[094d5a948d8c] 2020-03-02 13:22:08 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: enforce toplevel() if SYM_STRUCT was not defined

A separate change for documentation purposes.

Test-case:

	void func(void)
	{
		struct UNDEFINED x;
		x.member = 0;
	}

output:

   1:6                    def   f func                             void ( ... )
   3:26  func             def . v x                                struct UNDEFINED
   4:9   func             -w- . v x                                struct UNDEFINED
   4:10  func             -w- . m UNDEFINED.member                 bad type

but in this case is_sym_local(UNDEFINED) = F makes more sense, most
probably this struct was defined somewhere else but __sparse() didn't
see its definition.

Change lookup_member() to set type->scope = file_scope if !symbol_list.
This is not 100% correct, but struct_union_enum_specifier() does the
same check with the following comment:

	// The following test is actually wrong for empty
	// structs, but (1) they are not C99, (2) gcc does
	// the same thing, and (3) it's easier.

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+3/-0)
--------------------------------------------------------------------------------

[e078774555c6] 2020-02-20 01:41:46 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: fix sym_is_local(SYM_STRUCT/UNION/ENUM)

Now that struct_union_enum_specifier() always sets sym->scope we can
simplify sym_is_local(sym) and rely on toplevel() even if sym is type.

Test-case:

	// copied from linux kernel
	# define __force	__attribute__((force))
	#define WRITE_ONCE(x, val) \
	({							\
		union { typeof(x) __val; char __c[1]; } __u =	\
			{ .__val = (__force typeof(x)) (val) }; \
		__write_once_size(&(x), __u.__c, sizeof(x));	\
		__u.__val;					\
	})

	void func(int *p)
	{
		WRITE_ONCE(*p, 0);
	}

before this patch the widely used WRITE_ONCE() generates a lot of spam which
can't be filtered out using sym_is_local(),

	11:6                    def   f func                             void ( ... )
	11:11  func             def . v p                                int *
	13:9                    def   s :__u
	13:9                    --- . v p                                int *
	13:9                    def   m :__u.__val                       int
	13:9                    def   m :__u.__c                         char [1]
	13:9   func             def . v __u                              union :__u
	13:9   func             -w- . v __u                              union :__u
	13:9   func             -w-   m :__u.__val                       int
	13:9   func             --- . v p                                int *
	13:9   func             --r   f __write_once_size                bad type
	13:9   func             -r- . v p                                int *
	13:9   func             -r- . v __u                              union :__u
	13:9   func             m--   m :__u.__c                         char [1]
	13:9   func             --- . v p                                int *
	13:9   func             --- . v __u                              union :__u
	13:9   func             ---   m :__u.__val                       int

plus it triggers warning("no context") in test-dissect.c. With this patch
the only "nonlocal" report is __write_once_size() call.

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+2/-2), dissect.h (+2/-1)
--------------------------------------------------------------------------------

[9ac20e9e3c06] 2020-02-20 01:41:31 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: struct_union_enum_specifier: always initialize sym->scope

Currently it is not possible to figure out the scope of the private
struct/union/enum type, its ->scope is NULL because bind_symbol() is
not called.

Change struct_union_enum_specifier() to set sym->scope = block_scope
in this case, this is what bind_symbol() does when type has a name.

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: parse.c (+1/-0), scope.c (+5/-0), scope.h (+1/-0)
--------------------------------------------------------------------------------

[4201c46a5290] 2020-02-13 18:32:38 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: kill no_member()

It is trivial and has a single caller, lookup_member().

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+14/-15)
--------------------------------------------------------------------------------

[9f207728de61] 2020-02-13 18:32:38 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: don't set ->ident = '?' in no_member()

no_member() sets ->ident = built_in_ident("?") for the case when dissect()
can't figure out the name of initialized member. For example:

	struct EMPTY {} var = { 10 };

the output:

	1:25  var        -w-   m EMPTY.?           bad type

This is useful, but dissect should not dictate the policy. Let r_member()
decide how this case should be reported.

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+3/-3), test-dissect.c (+4/-3)
--------------------------------------------------------------------------------

[c5e931373223] 2020-02-13 18:32:38 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: use show_ident() to print dctx->ident

I didn't know show_ident() uses 4 buffers for the string it returns and
thus it is safe to call it twice in a row.

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+3/-6)
--------------------------------------------------------------------------------

[b50ae26fec7d] 2020-02-13 18:32:38 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: move __sparse() callsite from test-dissect.c to dissect.c

This is more flexible. For example, we can change dissect() to inspect
file_scope->symbols too without changing its callers.

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+3/-2), dissect.h (+1/-1), test-dissect.c (+2/-9)
--------------------------------------------------------------------------------

[6d779f4925fd] 2020-02-13 18:32:38 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: introduce sym_is_local() for reporter

Can be used to filter out the usage of local variables.

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+1/-1), dissect.h (+5/-0), test-dissect.c (+14/-4)
--------------------------------------------------------------------------------

[7e4a5b6fded1] 2020-02-10 22:52:42 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: enforce sym->kind='f' when it looks like a function call

A separate change for documentation purposes.

dissect() tries to work even if the parsed code is buggy or incomplete,
thus it makes sense to change expr_symbol() to set kind = 'f' when it
likely looks like a function name.

We can safely abuse EXPR_SYMBOL->op to pass the hint to expr_symbol(),
it must be 0.

Test-case:

	void call(void)
	{
		func();
	}

before this patch

	1:14                   def f call                             void ( ... )
	3:17  call             --r v func                             bad type

after:

	1:14                   def f call                             void ( ... )
	3:17  call             --r f func                             bad type

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+3/-1), test-dissect.c (+1/-1)
--------------------------------------------------------------------------------

[75757784c819] 2020-02-10 22:52:42 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: set sym->kind for reporter

Change dissect to report ctags-like kind passed in sym->kind.
Currently only v,f,s and m kinds are possible.

SYM_UNION doesn't differ from SYM_STRUCT and has ->kind = 's'.

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+14/-5), test-dissect.c (+30/-4)
--------------------------------------------------------------------------------

[ffb24e18c9b8] 2020-02-09 23:56:01 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: do the tree inlining during expansion phase

Currently, the tree inlining is done very early, during the
evaluation phase. This means that the inlining is done even
if the corresponding call belong to a sub-expression that
will be discarded during the expansion phase.
Usually this is not a problem but in some pathological
cases it can lead to a huge waste of memory and CPU time.

So, move this inline expansion to ... the expansion phase.
Also, re-expand the resulting expression since constant
arguments may create new opportunities for simplification.

Note: the motivation for thsi is a pathological case in the
      kernel where a combination of max_t() + const_ilog2() +
      roundup_pow_of_two() + cpumask_weight() + __const_hweight*()
      caused Sparse to use 2.3Gb of memory. With this patch
      the memory consumption is down to 247Mb.

Link: https://marc.info/?l=linux-sparse&m=158098958501220
Link: https://lore.kernel.org/netdev/CAHk-=whvS9x5NKtOqcUgJeTY7dfdAHc
Reported-by: Randy Dunlap <rdunlap@infradead.org>
Originally-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: evaluate.c (+0/-16), expand.c (+19/-0), inline.c (+0/-5), validation/expand/builtin_constant_inline0.c (+0/-1)
--------------------------------------------------------------------------------

[b369f9225bfc] 2020-02-09 23:55:56 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: inline: add some tests

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: validation/expand/builtin_constant_inline0.c (+24/-0), validation/expand/builtin_constant_inline1.c (+24/-0), validation/inline_base0.c (+47/-0), validation/inline_self.c (+13/-0)
--------------------------------------------------------------------------------

[98276e6116f3] 2020-02-07 14:53:51 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: kill return_type

Now that we have dissect_ctx do_statement(STMT_RETURN) can use
base_type(dissect_ctx->ctype.base_type) instead.

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+4/-5)
--------------------------------------------------------------------------------

[f3a6f29a8ab2] 2020-02-07 14:53:51 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: change do_symbol(SYM_FN) to check base_type->stmt != NULL

examine_fn_arguments() silently degenerates function arguments into
pointers but dissect doesn't do evaluate_symbol_list(), that is why
do_sym_list(type->arguments) can report the bogus definitions.

Test case:

	void extf(int MUST_NOT_BE_REPORTED);
	typedef void (fptr_t)(int MUST_NOT_BE_REPORTED);

	void func1(fptr_t fptr) {}
	void func2(typeof(extf) fptr) {}
	void func3(void) { typeof(extf) fptr; };
	void func4(void (fptr)(int MUST_NOT_BE_REPORTED)) {}

without this patch:

	4:6                    def  func1                            void ( ... )
	4:12  func1            def  fptr                             void ( ... )
	2:23  fptr             def  MUST_NOT_BE_REPORTED             int
	5:6                    def  func2                            void ( ... )
	5:19  func2            ---  extf                             void ( ... )
	5:12  func2            def  fptr                             void ( ... )
	1:11  fptr             def  MUST_NOT_BE_REPORTED             int
	6:6                    def  func3                            void ( ... )
	6:27  func3            ---  extf                             void ( ... )
	6:33  func3            def  fptr                             void ( ... )
	1:11  fptr             def  MUST_NOT_BE_REPORTED             int
	7:6                    def  func4                            void ( ... )
	7:12  func4            def  fptr                             void ( ... )
	7:24  fptr             def  MUST_NOT_BE_REPORTED             int

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+14/-3)
--------------------------------------------------------------------------------

[5778d8fe517b] 2020-02-07 14:53:51 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: introduce dissect_ctx

Points to the current function or to the global variable in case of
compound initializer.

Kill the ugly test-dissect.c:storage() and change print_usage() to
report dissect_ctx->ident instead.

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+15/-2), dissect.h (+2/-0), test-dissect.c (+8/-13)
--------------------------------------------------------------------------------

[a606990219d5] 2020-02-06 22:15:53 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix type compatibility of _Atomic

When _Atomic was introduced, it was treated, for most purposes,
like the other qualifiers.

However, it's best to consider _Atomic as an qualifier only for
syntaxic reasons. In particular, an _Atomic type may have different
size and alignment that its corresponding unqualified type.
Also, an _Atomic type is never compatible with its corresponding
unqualified type, and thus, for type checking, this qualifier must
never be ignored.

Fix this by removing MOD_ATOMIC from MOD_QUALIFIER. This,
essentially, has the effect to stop to ignore MOD_ATOMIC when
comparing types.

Fixes: ffe9f9fef003d29b65d29b8da5416aff72baff5a
Repoted-by: Ramsay Jones <ramsay@ramsayjones.plus.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: symbol.h (+3/-3), validation/c11-atomic.c (+37/-21), validation/typeof-mods.c (+1/-1)
--------------------------------------------------------------------------------

[100509c0789f] 2020-02-06 03:37:12 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: introduce reporter->r_memdef()

To report where is the member of struct/union defined.

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+11/-1), dissect.h (+1/-0), test-dissect.c (+6/-0)
--------------------------------------------------------------------------------

[b0f73c73c1f0] 2020-02-06 03:36:29 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: disallow NULL pointers in struct reporter

This makes dissect.c a bit more readable.

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+7/-17)
--------------------------------------------------------------------------------

[c6adc489224b] 2020-02-06 03:36:29 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: change deanon() to handle the !node case

Change deanon() to always initialize base->ident when parent != NULL
but still return false to avoid the pointless ->r_symdef().

Test-case:

	struct {
		union {
			int x;
		};
	} var = {
		{ .x = 0 },
	};

before this patch:

	1:8   s def  :var
	5:3   g def  var                              struct :var
	5:3   g -w-  var                              struct :var
	6:12  s -w-  ?.x                              int

after:

	1:8   s def  :var
	5:3   g def  var                              struct :var
	5:3   g -w-  var                              struct :var
	6:12  s -w-  :var.x                           int

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+3/-1)
--------------------------------------------------------------------------------

[cac470f792eb] 2020-02-06 03:36:29 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: turn mk_name() into deanon()

Preparation. Change mk_name() to initialize base->ident itself, simplify it,
and rename to deanon().

Also change examine_sym_node() to accept "struct symbol *parent" rather than
"struct ident *root". Currently it is only used as ->ident holder, but this
will be changed.

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+14/-10)
--------------------------------------------------------------------------------

[c7b778b311d3] 2020-02-06 03:36:29 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: dissect: don't report anonymous members in initializers

Change report_member() to not call ->r_member(mem) if !mem->ident.
This can only happen in initializer, the output gives no useful info
but looks like a bug. Test-case:

	struct {
		union {
			int x;
		};
	} var = {
		{}
	};

before this patch:

	1:8   s def  :var
	5:3   g def  var                              struct :var
	5:3   g -w-  var                              struct :var
	6:9   s -w-  :var.?                           union <noident>

after:

	1:8   s def  :var
	5:3   g def  var                              struct :var
	5:3   g -w-  var                              struct :var

We also need to change no_member() to ensure we still report the bad
initializers, this will be cleanuped later.

Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: dissect.c (+2/-2), test-dissect.c (+3/-4)
--------------------------------------------------------------------------------

[1dc00f876305] 2020-01-29 07:59:33 +0100
Author: Xan Phung <xan.phung@gmail.com>
Subject: domtree: domtree_build() creates extraneous bb->doms entries

Each time domtree_build gets called, extraneous/duplicated child nodes
get left in the bb->doms ptrlist. This is because the existing children
are not cleared from bb->doms before rebuilding it.

In addition to consuming memory, the extraneous child nodes result
in a malformed dominance tree.

The following 3 line patch fixes this problem by freeing the dominator
tree before rebuilding it.

Signed-off-by: Xan Phung <xan.phung@gmail.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: flowgraph.c (+4/-0)
--------------------------------------------------------------------------------

[47b6dfef9d8d] 2020-01-23 02:00:17 +0100
Author: John Levon <john.levon@joyent.com>
Subject: predefine "i386" if needed

Signed-off-by: John Levon <john.levon@joyent.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: target-x86.c (+1/-0)
--------------------------------------------------------------------------------

[1097c2eb1e0c] 2020-01-22 23:24:20 +0100
Author: Toomas Soome <tsoome@me.com>
Subject: correct sparcv9 defines

The SPARCV9 compile check needs to look for __sparcv9 on some systems,
and should also define "sparc".

Signed-off-by: Toomas Soome <tsoome@me.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: machine.h (+1/-1), target-sparc.c (+1/-0)
--------------------------------------------------------------------------------

[4efeeb73f741] 2020-01-22 23:24:20 +0100
Author: John Levon <john.levon@joyent.com>
Subject: pre-define __unix__ and friends

GCC defines these, so should we.

Signed-off-by: John Levon <john.levon@joyent.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+6/-0)
--------------------------------------------------------------------------------

[a2bf440057d2] 2020-01-22 23:24:20 +0100
Author: John Levon <john.levon@joyent.com>
Subject: add necessary defined for sunos-derived systems

Signed-off-by: John Levon <john.levon@joyent.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+7/-0)
--------------------------------------------------------------------------------

[54d1c99ed7c1] 2020-01-22 23:24:20 +0100
Author: John Levon <john.levon@joyent.com>
Subject: define __PRAGMA_REDEFINE_EXTNAME

As per:

https://gcc.gnu.org/onlinedocs/gcc-4.6.3/gcc/Symbol_002dRenaming-Pragmas.html

we should set this define.

Signed-off-by: John Levon <john.levon@joyent.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.c (+2/-0)
--------------------------------------------------------------------------------

[972a9fd5d024] 2020-01-22 23:24:20 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: allow to easily test if the OS is UNIX-like

Only on UNIX-like OSes are __unix__ & __unix predefined, so it's needed
to easily test if the OS is UNIX-like or not.

Let's do this cheaply by moving all the define of UNIX-like OSes
after the define for 'generic UNIX': OS_UNIX.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: machine.h (+2/-2)
--------------------------------------------------------------------------------

[207720e399ec] 2020-01-22 23:24:20 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: detect OS_UNIX as native OS

If nothing more specific matches but __unix__ or __unix is defined,
use OS_UNIX as the native OS.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: machine.h (+3/-0)
--------------------------------------------------------------------------------

[eeb1054a7aa5] 2020-01-22 23:24:20 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: detect native OS on OpenBSD & NetBSD

Sparse knew about OpenBSD & NetBSD but didn't detected them.
Until now, that's it.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: machine.h (+4/-0)
--------------------------------------------------------------------------------

[0e36de0e5c73] 2020-01-22 23:24:20 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: detect native OS in alphabetical order

The detection of the native OS was done in a strange order.
Now, do this alphabetically.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: machine.h (+6/-6)
--------------------------------------------------------------------------------

[c29bf506149e] 2020-01-22 23:24:20 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: fix typo when detecting SunOS

When detecting SunOS, '&&' was used instead of '||'.
Fix that.

Fixes: 6bca188679d235ddbad2e97aa3e4186a4730686e
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: machine.h (+1/-1)
--------------------------------------------------------------------------------

[00cace12abed] 2020-01-22 23:24:07 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: add predefine_nostd()

GCC adds predefines for some symbols lying in the user's namespace,
like "linux" or "sparc", but only if the selected dialect is not one
of the standard ones.

Add an helper, predefine_nostd(), for these.

Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: lib.h (+1/-0), pre-process.c (+8/-0)
--------------------------------------------------------------------------------

[eed8930cb4ec] 2020-01-21 00:02:16 +0100
Author: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>
Subject: Merge branch 'arch-spec'

* move arch specificities in their own files
* better support of arch specificities

Files: Makefile (+10/-0), cgcc (+8/-5), lib.c (+13/-234), lib.h (+2/-1), machine.h (+1/-1), ... and 13 more
--------------------------------------------------------------------------------

[22978b6b1e5e] 2020-01-16 20:10:31 +0100
Author: Oleg Nesterov <oleg@redhat.com>
Subject: show_parse: avoid null pointer dereference in do_show_type()

do_show_type() checks sym->type inside the "if (!sym || ...)" block.

While at it, remove the trailing whitespaces.

Fixes: 0fe7ebb9 ("show-parse: do not display base type's redundant specifiers")
Reported-by: Alexey Gladkov <gladkov.alexey@gmail.com>
Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>

Files: show-parse.c (+3/-3)
--------------------------------------------------------------------------------

