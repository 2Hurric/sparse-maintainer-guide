{
  "year": "2024",
  "stats": {
    "total_threads": 46,
    "total_messages": 352,
    "categories": {
      "sparse_internals": 12,
      "general": 2,
      "rfc_proposals": 11,
      "kernel_integration": 11,
      "address_space": 10
    }
  },
  "threads": [
    {
      "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
      "normalized_subject": "compiler.h: add is_const() as a replacement of __is_constexpr()",
      "message_count": 25,
      "participants": [
        "David Laight",
        "Rasmus Villemoes",
        "Linus Torvalds",
        "Martin Uecker"
      ],
      "categories": [
        "rfc_proposals",
        "compiler_compat",
        "sparse_internals",
        "type_system"
      ],
      "first_date": "2024-12-08T01:58:37+00:00",
      "last_date": "2024-12-09T09:59:44+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/12/173362294820856.mbox",
          "message_id": "<CAHk-=wgVGmj+nAju2XuWWD_FZHdeytRW2XX5D-L3MqDuRRciVg () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 01:58:37+00:00",
          "date_str": "Sun, 08 Dec 2024 01:58:37 +0000",
          "body": "On Sat, 7 Dec 2024 at 15:52, Martin Uecker <muecker@gwdg.de> wrote:\n>\n> Can you point me to some horror stories?\n\nSo the main issues tended to be about various static verification tools.\n\nRanging from things like the stackleak plugin for gcc, where handling\nVLA's and alloca() (which are pretty much the same thing with\ndifferent syntax) was just very much added complexity, to perhaps\noverly simplistic tools that literally just check the stack usage by\nparsing \"objdump --disassemble\" output and then building up\napproximate \"this is the combined deepest stack\" call chain\napproximations.\n\nAnd even in the *basic* infrastructure like gcc itself, VLA's simply\nmade -Wframe-larger-than= just simply not work.\n\nI also have this memory of bad code generation (again, this is 5=\nyears ago, so take this with a pinch of salt: dim memories), where gcc\nwouldn't end up re-using VLA stack slots, so VLA's made the frame\nbigger for that reason or something like that.\n\nWe explicitly use \"-fconserve-stack\" to get gcc to reuse spill slots,\nbecause gcc has been known to sometimes makes insanely piggish stack\nframes when it just creates a spill slot for *everything*, even if the\nspills aren't live at the same time (think big functions with lots of\ncase statements).\n\nWe also had several cases of the VLA's just being silly, when a simple\nconstant-sized allocation just worked fine and didn't generate\npointless extra code.\n\nPretty much none of the code core actually ever wanted VLA's, so the\nend result was that we had these bad patterns mainly in random drivers\netc. Don't do that.\n\n                Linus\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173362326320947.mbox",
          "message_id": "<CAHk-=wgVGmj+nAju2XuWWD_FZHdeytRW2XX5D-L3MqDuRRciVg () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 01:58:37+00:00",
          "date_str": "Sun, 08 Dec 2024 01:58:37 +0000",
          "body": "On Sat, 7 Dec 2024 at 15:52, Martin Uecker <muecker@gwdg.de> wrote:\n>\n> Can you point me to some horror stories?\n\nSo the main issues tended to be about various static verification tools.\n\nRanging from things like the stackleak plugin for gcc, where handling\nVLA's and alloca() (which are pretty much the same thing with\ndifferent syntax) was just very much added complexity, to perhaps\noverly simplistic tools that literally just check the stack usage by\nparsing \"objdump --disassemble\" output and then building up\napproximate \"this is the combined deepest stack\" call chain\napproximations.\n\nAnd even in the *basic* infrastructure like gcc itself, VLA's simply\nmade -Wframe-larger-than= just simply not work.\n\nI also have this memory of bad code generation (again, this is 5=\nyears ago, so take this with a pinch of salt: dim memories), where gcc\nwouldn't end up re-using VLA stack slots, so VLA's made the frame\nbigger for that reason or something like that.\n\nWe explicitly use \"-fconserve-stack\" to get gcc to reuse spill slots,\nbecause gcc has been known to sometimes makes insanely piggish stack\nframes when it just creates a spill slot for *everything*, even if the\nspills aren't live at the same time (think big functions with lots of\ncase statements).\n\nWe also had several cases of the VLA's just being silly, when a simple\nconstant-sized allocation just worked fine and didn't generate\npointless extra code.\n\nPretty much none of the code core actually ever wanted VLA's, so the\nend result was that we had these bad patterns mainly in random drivers\netc. Don't do that.\n\n                Linus\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173364934627929.mbox",
          "message_id": "<aeb1c27d320800dcd8375771022e11e8c27b0d1a.camel () gwdg ! de>",
          "author_name": "Martin Uecker",
          "author_email": "muecker () gwdg ! de",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 09:18:40+00:00",
          "date_str": "Sun, 08 Dec 2024 09:18:40 +0000",
          "body": "Am Samstag, dem 07.12.2024 um 17:58 -0800 schrieb Linus Torvalds:\n> On Sat, 7 Dec 2024 at 15:52, Martin Uecker <muecker@gwdg.de> wrote:\n> >=20\n> > Can you point me to some horror stories?\n>=20\n> So the main issues tended to be about various static verification tools.\n>=20\n> Ranging from things like the stackleak plugin for gcc, where handling\n> VLA's and alloca() (which are pretty much the same thing with\n> different syntax) was just very much added complexity, to perhaps\n> overly simplistic tools that literally just check the stack usage by\n> parsing \"objdump --disassemble\" output and then building up\n> approximate \"this is the combined deepest stack\" call chain\n> approximations.\n>=20\n> And even in the *basic* infrastructure like gcc itself, VLA's simply\n> made -Wframe-larger-than=3D just simply not work.\n>=20\n> I also have this memory of bad code generation (again, this is 5=3D\n> years ago, so take this with a pinch of salt: dim memories), where gcc\n> wouldn't end up re-using VLA stack slots, so VLA's made the frame\n> bigger for that reason or something like that.\n>=20\n> We explicitly use \"-fconserve-stack\" to get gcc to reuse spill slots,\n> because gcc has been known to sometimes makes insanely piggish stack\n> frames when it just creates a spill slot for *everything*, even if the\n> spills aren't live at the same time (think big functions with lots of\n> case statements).\n>=20\n> We also had several cases of the VLA's just being silly, when a simple\n> constant-sized allocation just worked fine and didn't generate\n> pointless extra code.\n>=20\n> Pretty much none of the code core actually ever wanted VLA's, so the\n> end result was that we had these bad patterns mainly in random drivers\n> etc. Don't do that.\n\nThanks. This confirms that the tooling around VLAs is rather poor.\n\n\nMartin\n\n\n\n\n\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173364934727932.mbox",
          "message_id": "<aeb1c27d320800dcd8375771022e11e8c27b0d1a.camel () gwdg ! de>",
          "author_name": "Martin Uecker",
          "author_email": "muecker () gwdg ! de",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 09:18:40+00:00",
          "date_str": "Sun, 08 Dec 2024 09:18:40 +0000",
          "body": "Am Samstag, dem 07.12.2024 um 17:58 -0800 schrieb Linus Torvalds:\n> On Sat, 7 Dec 2024 at 15:52, Martin Uecker <muecker@gwdg.de> wrote:\n> >=20\n> > Can you point me to some horror stories?\n>=20\n> So the main issues tended to be about various static verification tools.\n>=20\n> Ranging from things like the stackleak plugin for gcc, where handling\n> VLA's and alloca() (which are pretty much the same thing with\n> different syntax) was just very much added complexity, to perhaps\n> overly simplistic tools that literally just check the stack usage by\n> parsing \"objdump --disassemble\" output and then building up\n> approximate \"this is the combined deepest stack\" call chain\n> approximations.\n>=20\n> And even in the *basic* infrastructure like gcc itself, VLA's simply\n> made -Wframe-larger-than=3D just simply not work.\n>=20\n> I also have this memory of bad code generation (again, this is 5=3D\n> years ago, so take this with a pinch of salt: dim memories), where gcc\n> wouldn't end up re-using VLA stack slots, so VLA's made the frame\n> bigger for that reason or something like that.\n>=20\n> We explicitly use \"-fconserve-stack\" to get gcc to reuse spill slots,\n> because gcc has been known to sometimes makes insanely piggish stack\n> frames when it just creates a spill slot for *everything*, even if the\n> spills aren't live at the same time (think big functions with lots of\n> case statements).\n>=20\n> We also had several cases of the VLA's just being silly, when a simple\n> constant-sized allocation just worked fine and didn't generate\n> pointless extra code.\n>=20\n> Pretty much none of the code core actually ever wanted VLA's, so the\n> end result was that we had these bad patterns mainly in random drivers\n> etc. Don't do that.\n\nThanks. This confirms that the tooling around VLAs is rather poor.\n\n\nMartin\n\n\n\n\n\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173364933927923.mbox",
          "message_id": "<aeb1c27d320800dcd8375771022e11e8c27b0d1a.camel () gwdg ! de>",
          "author_name": "Martin Uecker",
          "author_email": "muecker () gwdg ! de",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 09:18:40+00:00",
          "date_str": "Sun, 08 Dec 2024 09:18:40 +0000",
          "body": "Am Samstag, dem 07.12.2024 um 17:58 -0800 schrieb Linus Torvalds:\n> On Sat, 7 Dec 2024 at 15:52, Martin Uecker <muecker@gwdg.de> wrote:\n> >=20\n> > Can you point me to some horror stories?\n>=20\n> So the main issues tended to be about various static verification tools.\n>=20\n> Ranging from things like the stackleak plugin for gcc, where handling\n> VLA's and alloca() (which are pretty much the same thing with\n> different syntax) was just very much added complexity, to perhaps\n> overly simplistic tools that literally just check the stack usage by\n> parsing \"objdump --disassemble\" output and then building up\n> approximate \"this is the combined deepest stack\" call chain\n> approximations.\n>=20\n> And even in the *basic* infrastructure like gcc itself, VLA's simply\n> made -Wframe-larger-than=3D just simply not work.\n>=20\n> I also have this memory of bad code generation (again, this is 5=3D\n> years ago, so take this with a pinch of salt: dim memories), where gcc\n> wouldn't end up re-using VLA stack slots, so VLA's made the frame\n> bigger for that reason or something like that.\n>=20\n> We explicitly use \"-fconserve-stack\" to get gcc to reuse spill slots,\n> because gcc has been known to sometimes makes insanely piggish stack\n> frames when it just creates a spill slot for *everything*, even if the\n> spills aren't live at the same time (think big functions with lots of\n> case statements).\n>=20\n> We also had several cases of the VLA's just being silly, when a simple\n> constant-sized allocation just worked fine and didn't generate\n> pointless extra code.\n>=20\n> Pretty much none of the code core actually ever wanted VLA's, so the\n> end result was that we had these bad patterns mainly in random drivers\n> etc. Don't do that.\n\nThanks. This confirms that the tooling around VLAs is rather poor.\n\n\nMartin\n\n\n\n\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173364934927935.mbox",
          "message_id": "<aeb1c27d320800dcd8375771022e11e8c27b0d1a.camel () gwdg ! de>",
          "author_name": "Martin Uecker",
          "author_email": "muecker () gwdg ! de",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 09:18:40+00:00",
          "date_str": "Sun, 08 Dec 2024 09:18:40 +0000",
          "body": "Am Samstag, dem 07.12.2024 um 17:58 -0800 schrieb Linus Torvalds:\n> On Sat, 7 Dec 2024 at 15:52, Martin Uecker <muecker@gwdg.de> wrote:\n> >=20\n> > Can you point me to some horror stories?\n>=20\n> So the main issues tended to be about various static verification tools.\n>=20\n> Ranging from things like the stackleak plugin for gcc, where handling\n> VLA's and alloca() (which are pretty much the same thing with\n> different syntax) was just very much added complexity, to perhaps\n> overly simplistic tools that literally just check the stack usage by\n> parsing \"objdump --disassemble\" output and then building up\n> approximate \"this is the combined deepest stack\" call chain\n> approximations.\n>=20\n> And even in the *basic* infrastructure like gcc itself, VLA's simply\n> made -Wframe-larger-than=3D just simply not work.\n>=20\n> I also have this memory of bad code generation (again, this is 5=3D\n> years ago, so take this with a pinch of salt: dim memories), where gcc\n> wouldn't end up re-using VLA stack slots, so VLA's made the frame\n> bigger for that reason or something like that.\n>=20\n> We explicitly use \"-fconserve-stack\" to get gcc to reuse spill slots,\n> because gcc has been known to sometimes makes insanely piggish stack\n> frames when it just creates a spill slot for *everything*, even if the\n> spills aren't live at the same time (think big functions with lots of\n> case statements).\n>=20\n> We also had several cases of the VLA's just being silly, when a simple\n> constant-sized allocation just worked fine and didn't generate\n> pointless extra code.\n>=20\n> Pretty much none of the code core actually ever wanted VLA's, so the\n> end result was that we had these bad patterns mainly in random drivers\n> etc. Don't do that.\n\nThanks. This confirms that the tooling around VLAs is rather poor.\n\n\nMartin\n\n\n\n\n\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173365707130057.mbox",
          "message_id": "<b71056c1b9e04aa383f2e5608c27290f () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 11:26:44+00:00",
          "date_str": "Sun, 08 Dec 2024 11:26:44 +0000",
          "body": "RnJvbTogTWFydGluIFVlY2tlcg0KPiBTZW50OiAwNyBEZWNlbWJlciAyMDI0IDIzOjUyDQouLi4N\nCj4gV2hpbGUgdGhlIGNvbXBpbGVyIGNhbiBub3QgYXV0b21hdGljYWxseSBwcm92ZSBldmVyeSB1\nc2UNCj4gb2YgVkxBIGJvdW5kZWQsIGl0IGNhbiByZWxpYWJseSBkaWFnbm9zZSB0aGUgY2FzZXMg\nd2hlcmUgaXQNCj4gY2FuwqAqbm90KiBzZWUgdGhhdCBpdCBpcyBib3VuZGVkLiBDb25zaWRlciB0\naGlzIGV4YW1wbGU6DQo+IA0KPiB2b2lkIG9vYihpbnQgbiwgY2hhciBwW25dKTsNCj4gdm9pZCBm\nKHVuc2lnbmVkIGludCBuKQ0KPiB7DQo+ICAgICBjaGFyIGJ1ZltNSU4obiwgMTAwKV07IC8vIGJv\ndW5kZWQNCj4gICAgIG9vYihuICsgMTAsIGJ1Zik7IC8vIHdhcm5pbmcNCj4gfQ0KLi4uDQoNClRo\nZSBrZXJuZWwgc3RhY2sgaGFzIHRvIGhhdmUgZW5vdWdoIHNwYWNlIGZvciB0aGUgWzEwMF0NCnNv\nIHRoZSBmdWxsIGFtb3VudCBtaWdodCBhcyB3ZWxsIGFsd2F5cyBiZSBhbGxvY2F0ZWQuDQpUaGUg\nY2hhbmNlIG9mICd0cmFkaW5nIG9mZicgc3RhY2sgdXNhZ2Ugd2l0aCBhbm90aGVyIGZ1bmN0aW9u\nDQppbiB0aGUgc2FtZSBjYWxsIHN0YWNrIHRoYXQgaXMgZ3VhcmFudGVlZCB0byB1c2UgbGVzcyB0\naGFuDQppdHMgbWF4aW11bSBpcyBhYm91dCB6ZXJvLg0KDQpUaGUgVkxBIGNvZGUgYWxzbyBhZGRz\nIGFuIGV4dHJhIHN0YWNrIGZyYW1lLCB0aGlzIHByZXR0eSBtdWNoDQpwZXNzaW1pc2VzIGV2ZXJ5\ndGhpbmcuDQpUaGlzIGhhcHBlbmVkIGZvciAnY29uc3RhbnQnIHNpemVzIGZyb20gbWluKDE2LCBz\naXplb2YgKHN0cnVjdCkpDQpiZWNhdXNlIG1pbigpIG5lZWRzIHRvIGJlIGEgc3RhdGVtZW50IGZ1\nbmN0aW9uIHRvIGF2b2lkIHJlLWV2YWx1YXRpbmcNCml0cyBhcmd1bWVudHMuDQooVGhlIHZlcnNp\nb24gb2YgbWluKCkgdGhhdCBtYW5hZ2VkIHRvIHJldHVybiBjb25zdGFudCBmcm9tIGNvbnN0YW50\nDQppbnB1dCBqdXN0IGV4cGxvZGVkIGluIGNwcCwgcGFydGlhbGx5IHJlc3BvbnNpYmxlIGZvciAx\nOE1CIGxpbmVzDQpiZWluZyBmZWQgaW50byB0aGUgY29tcGlsZXIgcGFydC4pDQoNCglEYXZpZA0K\nDQotDQpSZWdpc3RlcmVkIEFkZHJlc3MgTGFrZXNpZGUsIEJyYW1sZXkgUm9hZCwgTW91bnQgRmFy\nbSwgTWlsdG9uIEtleW5lcywgTUsxIDFQVCwgVUsNClJlZ2lzdHJhdGlvbiBObzogMTM5NzM4NiAo\nV2FsZXMpDQo=\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173365706930052.mbox",
          "message_id": "<b71056c1b9e04aa383f2e5608c27290f () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 11:26:44+00:00",
          "date_str": "Sun, 08 Dec 2024 11:26:44 +0000",
          "body": "RnJvbTogTWFydGluIFVlY2tlcg0KPiBTZW50OiAwNyBEZWNlbWJlciAyMDI0IDIzOjUyDQouLi4N\nCj4gV2hpbGUgdGhlIGNvbXBpbGVyIGNhbiBub3QgYXV0b21hdGljYWxseSBwcm92ZSBldmVyeSB1\nc2UNCj4gb2YgVkxBIGJvdW5kZWQsIGl0IGNhbiByZWxpYWJseSBkaWFnbm9zZSB0aGUgY2FzZXMg\nd2hlcmUgaXQNCj4gY2FuwqAqbm90KiBzZWUgdGhhdCBpdCBpcyBib3VuZGVkLiBDb25zaWRlciB0\naGlzIGV4YW1wbGU6DQo+IA0KPiB2b2lkIG9vYihpbnQgbiwgY2hhciBwW25dKTsNCj4gdm9pZCBm\nKHVuc2lnbmVkIGludCBuKQ0KPiB7DQo+ICAgICBjaGFyIGJ1ZltNSU4obiwgMTAwKV07IC8vIGJv\ndW5kZWQNCj4gICAgIG9vYihuICsgMTAsIGJ1Zik7IC8vIHdhcm5pbmcNCj4gfQ0KLi4uDQoNClRo\nZSBrZXJuZWwgc3RhY2sgaGFzIHRvIGhhdmUgZW5vdWdoIHNwYWNlIGZvciB0aGUgWzEwMF0NCnNv\nIHRoZSBmdWxsIGFtb3VudCBtaWdodCBhcyB3ZWxsIGFsd2F5cyBiZSBhbGxvY2F0ZWQuDQpUaGUg\nY2hhbmNlIG9mICd0cmFkaW5nIG9mZicgc3RhY2sgdXNhZ2Ugd2l0aCBhbm90aGVyIGZ1bmN0aW9u\nDQppbiB0aGUgc2FtZSBjYWxsIHN0YWNrIHRoYXQgaXMgZ3VhcmFudGVlZCB0byB1c2UgbGVzcyB0\naGFuDQppdHMgbWF4aW11bSBpcyBhYm91dCB6ZXJvLg0KDQpUaGUgVkxBIGNvZGUgYWxzbyBhZGRz\nIGFuIGV4dHJhIHN0YWNrIGZyYW1lLCB0aGlzIHByZXR0eSBtdWNoDQpwZXNzaW1pc2VzIGV2ZXJ5\ndGhpbmcuDQpUaGlzIGhhcHBlbmVkIGZvciAnY29uc3RhbnQnIHNpemVzIGZyb20gbWluKDE2LCBz\naXplb2YgKHN0cnVjdCkpDQpiZWNhdXNlIG1pbigpIG5lZWRzIHRvIGJlIGEgc3RhdGVtZW50IGZ1\nbmN0aW9uIHRvIGF2b2lkIHJlLWV2YWx1YXRpbmcNCml0cyBhcmd1bWVudHMuDQooVGhlIHZlcnNp\nb24gb2YgbWluKCkgdGhhdCBtYW5hZ2VkIHRvIHJldHVybiBjb25zdGFudCBmcm9tIGNvbnN0YW50\nDQppbnB1dCBqdXN0IGV4cGxvZGVkIGluIGNwcCwgcGFydGlhbGx5IHJlc3BvbnNpYmxlIGZvciAx\nOE1CIGxpbmVzDQpiZWluZyBmZWQgaW50byB0aGUgY29tcGlsZXIgcGFydC4pDQoNCglEYXZpZA0K\nDQotDQpSZWdpc3RlcmVkIEFkZHJlc3MgTGFrZXNpZGUsIEJyYW1sZXkgUm9hZCwgTW91bnQgRmFy\nbSwgTWlsdG9uIEtleW5lcywgTUsxIDFQVCwgVUsNClJlZ2lzdHJhdGlvbiBObzogMTM5NzM4NiAo\nV2FsZXMpDQo=\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173365706930054.mbox",
          "message_id": "<b71056c1b9e04aa383f2e5608c27290f () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 11:26:44+00:00",
          "date_str": "Sun, 08 Dec 2024 11:26:44 +0000",
          "body": "RnJvbTogTWFydGluIFVlY2tlcg0KPiBTZW50OiAwNyBEZWNlbWJlciAyMDI0IDIzOjUyDQouLi4N\nCj4gV2hpbGUgdGhlIGNvbXBpbGVyIGNhbiBub3QgYXV0b21hdGljYWxseSBwcm92ZSBldmVyeSB1\nc2UNCj4gb2YgVkxBIGJvdW5kZWQsIGl0IGNhbiByZWxpYWJseSBkaWFnbm9zZSB0aGUgY2FzZXMg\nd2hlcmUgaXQNCj4gY2FuwqAqbm90KiBzZWUgdGhhdCBpdCBpcyBib3VuZGVkLiBDb25zaWRlciB0\naGlzIGV4YW1wbGU6DQo+IA0KPiB2b2lkIG9vYihpbnQgbiwgY2hhciBwW25dKTsNCj4gdm9pZCBm\nKHVuc2lnbmVkIGludCBuKQ0KPiB7DQo+ICAgICBjaGFyIGJ1ZltNSU4obiwgMTAwKV07IC8vIGJv\ndW5kZWQNCj4gICAgIG9vYihuICsgMTAsIGJ1Zik7IC8vIHdhcm5pbmcNCj4gfQ0KLi4uDQoNClRo\nZSBrZXJuZWwgc3RhY2sgaGFzIHRvIGhhdmUgZW5vdWdoIHNwYWNlIGZvciB0aGUgWzEwMF0NCnNv\nIHRoZSBmdWxsIGFtb3VudCBtaWdodCBhcyB3ZWxsIGFsd2F5cyBiZSBhbGxvY2F0ZWQuDQpUaGUg\nY2hhbmNlIG9mICd0cmFkaW5nIG9mZicgc3RhY2sgdXNhZ2Ugd2l0aCBhbm90aGVyIGZ1bmN0aW9u\nDQppbiB0aGUgc2FtZSBjYWxsIHN0YWNrIHRoYXQgaXMgZ3VhcmFudGVlZCB0byB1c2UgbGVzcyB0\naGFuDQppdHMgbWF4aW11bSBpcyBhYm91dCB6ZXJvLg0KDQpUaGUgVkxBIGNvZGUgYWxzbyBhZGRz\nIGFuIGV4dHJhIHN0YWNrIGZyYW1lLCB0aGlzIHByZXR0eSBtdWNoDQpwZXNzaW1pc2VzIGV2ZXJ5\ndGhpbmcuDQpUaGlzIGhhcHBlbmVkIGZvciAnY29uc3RhbnQnIHNpemVzIGZyb20gbWluKDE2LCBz\naXplb2YgKHN0cnVjdCkpDQpiZWNhdXNlIG1pbigpIG5lZWRzIHRvIGJlIGEgc3RhdGVtZW50IGZ1\nbmN0aW9uIHRvIGF2b2lkIHJlLWV2YWx1YXRpbmcNCml0cyBhcmd1bWVudHMuDQooVGhlIHZlcnNp\nb24gb2YgbWluKCkgdGhhdCBtYW5hZ2VkIHRvIHJldHVybiBjb25zdGFudCBmcm9tIGNvbnN0YW50\nDQppbnB1dCBqdXN0IGV4cGxvZGVkIGluIGNwcCwgcGFydGlhbGx5IHJlc3BvbnNpYmxlIGZvciAx\nOE1CIGxpbmVzDQpiZWluZyBmZWQgaW50byB0aGUgY29tcGlsZXIgcGFydC4pDQoNCglEYXZpZA0K\nDQotDQpSZWdpc3RlcmVkIEFkZHJlc3MgTGFrZXNpZGUsIEJyYW1sZXkgUm9hZCwgTW91bnQgRmFy\nbSwgTWlsdG9uIEtleW5lcywgTUsxIDFQVCwgVUsNClJlZ2lzdHJhdGlvbiBObzogMTM5NzM4NiAo\nV2FsZXMpDQo=\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173366131331195.mbox",
          "message_id": "<6658618490381cf5ec35edbb66f1478024174e67.camel () gwdg ! de>",
          "author_name": "Martin Uecker",
          "author_email": "muecker () gwdg ! de",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 12:38:10+00:00",
          "date_str": "Sun, 08 Dec 2024 12:38:10 +0000",
          "body": "Am Sonntag, dem 08.12.2024 um 11:26 +0000 schrieb David Laight:\n> From: Martin Uecker\n> > Sent: 07 December 2024 23:52\n> ...\n> > While the compiler can not automatically prove every use\n> > of VLA bounded, it can reliably diagnose the cases where it\n> > can=C2=A0*not* see that it is bounded. Consider this example:\n> >=20\n> > void oob(int n, char p[n]);\n> > void f(unsigned int n)\n> > {\n> >     char buf[MIN(n, 100)]; // bounded\n> >     oob(n + 10, buf); // warning\n> > }\n> ...\n>=20\n> The kernel stack has to have enough space for the [100]\n> so the full amount might as well always be allocated.\n> The chance of 'trading off' stack usage with another function\n> in the same call stack that is guaranteed to use less than\n> its maximum is about zero.\n\nIn numerical computing this is a big motivation because\nyou can reduce stack usage in recursive divide-and-conquer\nalgorithms.  For the kernel, I agree this is not a\ncompelling use case, and the better motivation would be\nprecise bounds checking and clearer semantics for buffer\nmanagement. =C2=A0\n\nBut don't get me wrong, if the kernel is happier without VLA\nthis is fine with me, I am just trying to understand the\nunderlying issues better and the \"VLAs are security problem\"\nor \"VLA use more stack\"  arguments do not convince me, while\nthe points Linus raises make much more sense to me.\n\n>=20\n> The VLA code also adds an extra stack frame, this pretty much\n> pessimises everything.\n\nYes, but this is something which seems could be improved\non the compiler side, e.g. by simply transforming\nsmall VLAs automatically to a fixed size array while\npreserving their semantics for bound checking.\n\n\n> This happened for 'constant' sizes from min(16, sizeof (struct))\n> because min() needs to be a statement function to avoid re-evaluating\n> its arguments.\n\nCan you clarify this?  If the VLA size is constant, even when\nit is not an integer constant expression according to ISO C,\nthe compiler should not produce worse code.  For example,\n\nvoid g(void*);\n\nvoid foo()\n{\n    int n =3D 10;\n    char buf[n];\n    g(buf);\n}\n\nvoid bar()\n{\n    char buf[10];\n    g(buf);\n}\n\nSo a lot of this macro business seems to be necessary\nto avoid creating warnings for ISO VLAs when instead you really\ncare about the created code not having a dynamic allocation on\nthe stack.\n\nSo one might wonder whether a compiler warning that warns more\nspecifically about this would help.\n\n> (The version of min() that managed to return constant from constant\n> input just exploded in cpp, partially responsible for 18MB lines\n> being fed into the compiler part.)\n\nThe issue here is that we miss a language feature in C to\nintroduce local variables that help avoid multiple expansion\nof macro arguments.  GCC's statement expressions and __auto_type\nare a solution\n\n#define foo(x) ({ __auto_type __x =3D (x); ... })\n\nbut this runs into the current limitations that ({ }) can not be used\nat file-scope and can not return constant expressions.\n\n\nFor other reasons I was thinking about adding names to _Generic,\nas in\n\n_Generic(x, int i: (i + 1));\n\nbecause one design issues with _Generic is that it typechecks=C2=A0\nalso the untaken associations and there the 'x' then has the wrong\ntype.  Having an 'i' with the right type which is set to the value\nof 'x' when the branch is taken would fix this issue.\n\nBut this feature might also allow writing macros that avoid\ndoublel expansion without requiring statement expressions (which\nare more difficult to fix):\n\n#define foo(x) _Generic(x, int i: (i + i));\n\n\nMartin\n\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173366131231189.mbox",
          "message_id": "<6658618490381cf5ec35edbb66f1478024174e67.camel () gwdg ! de>",
          "author_name": "Martin Uecker",
          "author_email": "muecker () gwdg ! de",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 12:38:10+00:00",
          "date_str": "Sun, 08 Dec 2024 12:38:10 +0000",
          "body": "Am Sonntag, dem 08.12.2024 um 11:26 +0000 schrieb David Laight:\n> From: Martin Uecker\n> > Sent: 07 December 2024 23:52\n> ...\n> > While the compiler can not automatically prove every use\n> > of VLA bounded, it can reliably diagnose the cases where it\n> > can=C2=A0*not* see that it is bounded. Consider this example:\n> >=20\n> > void oob(int n, char p[n]);\n> > void f(unsigned int n)\n> > {\n> >     char buf[MIN(n, 100)]; // bounded\n> >     oob(n + 10, buf); // warning\n> > }\n> ...\n>=20\n> The kernel stack has to have enough space for the [100]\n> so the full amount might as well always be allocated.\n> The chance of 'trading off' stack usage with another function\n> in the same call stack that is guaranteed to use less than\n> its maximum is about zero.\n\nIn numerical computing this is a big motivation because\nyou can reduce stack usage in recursive divide-and-conquer\nalgorithms.  For the kernel, I agree this is not a\ncompelling use case, and the better motivation would be\nprecise bounds checking and clearer semantics for buffer\nmanagement. =C2=A0\n\nBut don't get me wrong, if the kernel is happier without VLA\nthis is fine with me, I am just trying to understand the\nunderlying issues better and the \"VLAs are security problem\"\nor \"VLA use more stack\"  arguments do not convince me, while\nthe points Linus raises make much more sense to me.\n\n>=20\n> The VLA code also adds an extra stack frame, this pretty much\n> pessimises everything.\n\nYes, but this is something which seems could be improved\non the compiler side, e.g. by simply transforming\nsmall VLAs automatically to a fixed size array while\npreserving their semantics for bound checking.\n\n\n> This happened for 'constant' sizes from min(16, sizeof (struct))\n> because min() needs to be a statement function to avoid re-evaluating\n> its arguments.\n\nCan you clarify this?  If the VLA size is constant, even when\nit is not an integer constant expression according to ISO C,\nthe compiler should not produce worse code.  For example,\n\nvoid g(void*);\n\nvoid foo()\n{\n    int n =3D 10;\n    char buf[n];\n    g(buf);\n}\n\nvoid bar()\n{\n    char buf[10];\n    g(buf);\n}\n\nSo a lot of this macro business seems to be necessary\nto avoid creating warnings for ISO VLAs when instead you really\ncare about the created code not having a dynamic allocation on\nthe stack.\n\nSo one might wonder whether a compiler warning that warns more\nspecifically about this would help.\n\n> (The version of min() that managed to return constant from constant\n> input just exploded in cpp, partially responsible for 18MB lines\n> being fed into the compiler part.)\n\nThe issue here is that we miss a language feature in C to\nintroduce local variables that help avoid multiple expansion\nof macro arguments.  GCC's statement expressions and __auto_type\nare a solution\n\n#define foo(x) ({ __auto_type __x =3D (x); ... })\n\nbut this runs into the current limitations that ({ }) can not be used\nat file-scope and can not return constant expressions.\n\n\nFor other reasons I was thinking about adding names to _Generic,\nas in\n\n_Generic(x, int i: (i + 1));\n\nbecause one design issues with _Generic is that it typechecks=C2=A0\nalso the untaken associations and there the 'x' then has the wrong\ntype.  Having an 'i' with the right type which is set to the value\nof 'x' when the branch is taken would fix this issue.\n\nBut this feature might also allow writing macros that avoid\ndoublel expansion without requiring statement expressions (which\nare more difficult to fix):\n\n#define foo(x) _Generic(x, int i: (i + i));\n\n\nMartin\n\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173366130831186.mbox",
          "message_id": "<6658618490381cf5ec35edbb66f1478024174e67.camel () gwdg ! de>",
          "author_name": "Martin Uecker",
          "author_email": "muecker () gwdg ! de",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 12:38:10+00:00",
          "date_str": "Sun, 08 Dec 2024 12:38:10 +0000",
          "body": "Am Sonntag, dem 08.12.2024 um 11:26 +0000 schrieb David Laight:\n> From: Martin Uecker\n> > Sent: 07 December 2024 23:52\n> ...\n> > While the compiler can not automatically prove every use\n> > of VLA bounded, it can reliably diagnose the cases where it\n> > can=C2=A0*not* see that it is bounded. Consider this example:\n> >=20\n> > void oob(int n, char p[n]);\n> > void f(unsigned int n)\n> > {\n> >     char buf[MIN(n, 100)]; // bounded\n> >     oob(n + 10, buf); // warning\n> > }\n> ...\n>=20\n> The kernel stack has to have enough space for the [100]\n> so the full amount might as well always be allocated.\n> The chance of 'trading off' stack usage with another function\n> in the same call stack that is guaranteed to use less than\n> its maximum is about zero.\n\nIn numerical computing this is a big motivation because\nyou can reduce stack usage in recursive divide-and-conquer\nalgorithms.  For the kernel, I agree this is not a\ncompelling use case, and the better motivation would be\nprecise bounds checking and clearer semantics for buffer\nmanagement. =C2=A0\n\nBut don't get me wrong, if the kernel is happier without VLA\nthis is fine with me, I am just trying to understand the\nunderlying issues better and the \"VLAs are security problem\"\nor \"VLA use more stack\"  arguments do not convince me, while\nthe points Linus raises make much more sense to me.\n\n>=20\n> The VLA code also adds an extra stack frame, this pretty much\n> pessimises everything.\n\nYes, but this is something which seems could be improved\non the compiler side, e.g. by simply transforming\nsmall VLAs automatically to a fixed size array while\npreserving their semantics for bound checking.\n\n\n> This happened for 'constant' sizes from min(16, sizeof (struct))\n> because min() needs to be a statement function to avoid re-evaluating\n> its arguments.\n\nCan you clarify this?  If the VLA size is constant, even when\nit is not an integer constant expression according to ISO C,\nthe compiler should not produce worse code.  For example,\n\nvoid g(void*);\n\nvoid foo()\n{\n    int n =3D 10;\n    char buf[n];\n    g(buf);\n}\n\nvoid bar()\n{\n    char buf[10];\n    g(buf);\n}\n\nSo a lot of this macro business seems to be necessary\nto avoid creating warnings for ISO VLAs when instead you really\ncare about the created code not having a dynamic allocation on\nthe stack.\n\nSo one might wonder whether a compiler warning that warns more\nspecifically about this would help.\n\n> (The version of min() that managed to return constant from constant\n> input just exploded in cpp, partially responsible for 18MB lines\n> being fed into the compiler part.)\n\nThe issue here is that we miss a language feature in C to\nintroduce local variables that help avoid multiple expansion\nof macro arguments.  GCC's statement expressions and __auto_type\nare a solution\n\n#define foo(x) ({ __auto_type __x =3D (x); ... })\n\nbut this runs into the current limitations that ({ }) can not be used\nat file-scope and can not return constant expressions.\n\n\nFor other reasons I was thinking about adding names to _Generic,\nas in\n\n_Generic(x, int i: (i + 1));\n\nbecause one design issues with _Generic is that it typechecks=C2=A0\nalso the untaken associations and there the 'x' then has the wrong\ntype.  Having an 'i' with the right type which is set to the value\nof 'x' when the branch is taken would fix this issue.\n\nBut this feature might also allow writing macros that avoid\ndoublel expansion without requiring statement expressions (which\nare more difficult to fix):\n\n#define foo(x) _Generic(x, int i: (i + i));\n\n\nMartin\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173367640505101.mbox",
          "message_id": "<e71fffb7ff0e4bf29692d006c0fe77c2 () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 16:48:58+00:00",
          "date_str": "Sun, 08 Dec 2024 16:48:58 +0000",
          "body": "RnJvbTogTWFydGluIFVlY2tlcg0KPiBTZW50OiAwOCBEZWNlbWJlciAyMDI0IDEyOjM4DQo+IA0K\nPiBBbSBTb25udGFnLCBkZW0gMDguMTIuMjAyNCB1bSAxMToyNiArMDAwMCBzY2hyaWViIERhdmlk\nIExhaWdodDoNCj4gPiBGcm9tOiBNYXJ0aW4gVWVja2VyDQo+ID4gPiBTZW50OiAwNyBEZWNlbWJl\nciAyMDI0IDIzOjUyDQo+ID4gLi4uDQo+ID4gPiBXaGlsZSB0aGUgY29tcGlsZXIgY2FuIG5vdCBh\ndXRvbWF0aWNhbGx5IHByb3ZlIGV2ZXJ5IHVzZQ0KPiA+ID4gb2YgVkxBIGJvdW5kZWQsIGl0IGNh\nbiByZWxpYWJseSBkaWFnbm9zZSB0aGUgY2FzZXMgd2hlcmUgaXQNCj4gPiA+IGNhbsKgKm5vdCog\nc2VlIHRoYXQgaXQgaXMgYm91bmRlZC4gQ29uc2lkZXIgdGhpcyBleGFtcGxlOg0KPiA+ID4NCj4g\nPiA+IHZvaWQgb29iKGludCBuLCBjaGFyIHBbbl0pOw0KPiA+ID4gdm9pZCBmKHVuc2lnbmVkIGlu\ndCBuKQ0KPiA+ID4gew0KPiA+ID4gICAgIGNoYXIgYnVmW01JTihuLCAxMDApXTsgLy8gYm91bmRl\nZA0KPiA+ID4gICAgIG9vYihuICsgMTAsIGJ1Zik7IC8vIHdhcm5pbmcNCj4gPiA+IH0NCj4gPiAu\nLi4NCj4gPg0KPiA+IFRoZSBrZXJuZWwgc3RhY2sgaGFzIHRvIGhhdmUgZW5vdWdoIHNwYWNlIGZv\nciB0aGUgWzEwMF0NCj4gPiBzbyB0aGUgZnVsbCBhbW91bnQgbWlnaHQgYXMgd2VsbCBhbHdheXMg\nYmUgYWxsb2NhdGVkLg0KPiA+IFRoZSBjaGFuY2Ugb2YgJ3RyYWRpbmcgb2ZmJyBzdGFjayB1c2Fn\nZSB3aXRoIGFub3RoZXIgZnVuY3Rpb24NCj4gPiBpbiB0aGUgc2FtZSBjYWxsIHN0YWNrIHRoYXQg\naXMgZ3VhcmFudGVlZCB0byB1c2UgbGVzcyB0aGFuDQo+ID4gaXRzIG1heGltdW0gaXMgYWJvdXQg\nemVyby4NCj4gDQo+IEluIG51bWVyaWNhbCBjb21wdXRpbmcgdGhpcyBpcyBhIGJpZyBtb3RpdmF0\naW9uIGJlY2F1c2UNCj4geW91IGNhbiByZWR1Y2Ugc3RhY2sgdXNhZ2UgaW4gcmVjdXJzaXZlIGRp\ndmlkZS1hbmQtY29ucXVlcg0KPiBhbGdvcml0aG1zLiAgRm9yIHRoZSBrZXJuZWwsIEkgYWdyZWUg\ndGhpcyBpcyBub3QgYQ0KPiBjb21wZWxsaW5nIHVzZSBjYXNlLCBhbmQgdGhlIGJldHRlciBtb3Rp\ndmF0aW9uIHdvdWxkIGJlDQo+IHByZWNpc2UgYm91bmRzIGNoZWNraW5nIGFuZCBjbGVhcmVyIHNl\nbWFudGljcyBmb3IgYnVmZmVyDQo+IG1hbmFnZW1lbnQuDQoNCkV4Y2VwdCB0aGF0IGNoYW5naW5n\nIHRoZSBzaXplIG9mIHRoZSBvbi1zdGFjayBhcnJheSBtYWtlcw0KYWJzb2x1dGVseSBubyBkaWZm\nZXJlbmNlLg0KSWRlYWxseSB0aGUga2VybmVsIHN0YWNrIHdvdWxkIGJlIGEgc2luZ2xlIDRrIHBh\nZ2UsIGJ1dCB0b28NCm11Y2ggY29kZSB1c2VzIG9uLXN0YWNrIGJ1ZmZlcnMgc28gaXQgaGFzIGJl\nZW4gaW5jcmVhc2VkIGFuZA0KbWlnaHQgYmUgMTZrIChvciBtb3JlISkuDQpSZW1lbWJlciB0aGlz\nIGlzIHBoeXNpY2FsIG1lbW9yeSBhbGxvY2F0ZWQgdG8gZXZlcnkgdXNlciB0aHJlYWQuDQpPbiBM\naW51eCBpdCBpcyBub3Qgc3dhcHBhYmxlLg0KDQouLi4NCj4gPiBUaGlzIGhhcHBlbmVkIGZvciAn\nY29uc3RhbnQnIHNpemVzIGZyb20gbWluKDE2LCBzaXplb2YgKHN0cnVjdCkpDQo+ID4gYmVjYXVz\nZSBtaW4oKSBuZWVkcyB0byBiZSBhIHN0YXRlbWVudCBmdW5jdGlvbiB0byBhdm9pZCByZS1ldmFs\ndWF0aW5nDQo+ID4gaXRzIGFyZ3VtZW50cy4NCj4gDQo+IENhbiB5b3UgY2xhcmlmeSB0aGlzPyAg\nSWYgdGhlIFZMQSBzaXplIGlzIGNvbnN0YW50LCBldmVuIHdoZW4NCj4gaXQgaXMgbm90IGFuIGlu\ndGVnZXIgY29uc3RhbnQgZXhwcmVzc2lvbiBhY2NvcmRpbmcgdG8gSVNPIEMsDQo+IHRoZSBjb21w\naWxlciBzaG91bGQgbm90IHByb2R1Y2Ugd29yc2UgY29kZS4gIEZvciBleGFtcGxlLA0KDQpJIGp1\nc3QgdHJpZWQgdG8gcmVwcm9kdWNlIHRoZSBmYWlsaW5nIGNhc2UgLSBhbmQgZmFpbGVkLg0KSXQg\nd2FzIHNpbWlsYXIgdG8gX19idWlsdGluX2NvbnN0YW50X3AoKSBpbml0aWFsbHkgcmV0dXJuaW5n\nICdkb24ndCBrbm93Jw0Kc28gdGhlICd2YXJpYWJsZSBzaXplZCcgYXJyYXkgY29kZSBnb3QgYWRk\nZWQsIHRoZW4gbXVjaCBsYXRlcg0KYWZ0ZXIgZnVydGhlciBvcHRpbWlzYXRpb24gcGFzc2VzIHRo\nZSBleHByZXNzaW9uIGJlY2FtZSBjb25zdGFudC4NClNvIHlvdSBlbmRlZCB1cCB3aXRoIGEgJ2Zp\neGVkIHNpemUnIFZMQS4NCg0KQ29tcGlsZSB3aXRoIC1Xbm8tdmxhIChhbmQgLVdlcnJvcikgYW5k\nIHRoZSBjb21waWxlIGZhaWxlZC4NCg0KLi4uDQo+IFNvIGEgbG90IG9mIHRoaXMgbWFjcm8gYnVz\naW5lc3Mgc2VlbXMgdG8gYmUgbmVjZXNzYXJ5DQo+IHRvIGF2b2lkIGNyZWF0aW5nIHdhcm5pbmdz\nIGZvciBJU08gVkxBcyB3aGVuIGluc3RlYWQgeW91IHJlYWxseQ0KPiBjYXJlIGFib3V0IHRoZSBj\ncmVhdGVkIGNvZGUgbm90IGhhdmluZyBhIGR5bmFtaWMgYWxsb2NhdGlvbiBvbg0KPiB0aGUgc3Rh\nY2suDQoNCkEgbG90IG9mIHRoZSAnbWFjcm8gYnVzaW5lc3MnIGZvciBtaW4vbWF4IGlzIGF2b2lk\naW5nIHVuZXhwZWN0ZWQNCmNvbnZlcnNpb24gb2YgbmVnYXRpdmUgdmFsdWVzIHRvIHZlcnkgbGFy\nZ2UgdW5zaWduZWQgb25lcy4NCkFuZCBubywgLVdzaWduLWNvbXBhcmUgaXMgc3BlY3RhY3VsYXJs\neSB1c2VsZXNzLg0KDQouLg0KPiBUaGUgaXNzdWUgaGVyZSBpcyB0aGF0IHdlIG1pc3MgYSBsYW5n\ndWFnZSBmZWF0dXJlIGluIEMgdG8NCj4gaW50cm9kdWNlIGxvY2FsIHZhcmlhYmxlcyB0aGF0IGhl\nbHAgYXZvaWQgbXVsdGlwbGUgZXhwYW5zaW9uDQo+IG9mIG1hY3JvIGFyZ3VtZW50cy4gIEdDQydz\nIHN0YXRlbWVudCBleHByZXNzaW9ucyBhbmQgX19hdXRvX3R5cGUNCj4gYXJlIGEgc29sdXRpb24N\nCg0Kb3IgaGlzdG9yaWNhbGx5ICd0eXBlb2YoeCkgX3ggPSB4Jw0KDQo+ICNkZWZpbmUgZm9vKHgp\nICh7IF9fYXV0b190eXBlIF9feCA9ICh4KTsgLi4uIH0pDQo+IA0KPiBidXQgdGhpcyBydW5zIGlu\ndG8gdGhlIGN1cnJlbnQgbGltaXRhdGlvbnMgdGhhdCAoeyB9KSBjYW4gbm90IGJlIHVzZWQNCj4g\nYXQgZmlsZS1zY29wZSBhbmQgY2FuIG5vdCByZXR1cm4gY29uc3RhbnQgZXhwcmVzc2lvbnMuDQo+\nIA0KPiANCj4gRm9yIG90aGVyIHJlYXNvbnMgSSB3YXMgdGhpbmtpbmcgYWJvdXQgYWRkaW5nIG5h\nbWVzIHRvIF9HZW5lcmljLA0KPiBhcyBpbg0KPiANCj4gX0dlbmVyaWMoeCwgaW50IGk6IChpICsg\nMSkpOw0KPiANCj4gYmVjYXVzZSBvbmUgZGVzaWduIGlzc3VlcyB3aXRoIF9HZW5lcmljIGlzIHRo\nYXQgaXQgdHlwZWNoZWNrcw0KPiBhbHNvIHRoZSB1bnRha2VuIGFzc29jaWF0aW9ucyBhbmQgdGhl\ncmUgdGhlICd4JyB0aGVuIGhhcyB0aGUgd3JvbmcNCj4gdHlwZS4gIEhhdmluZyBhbiAnaScgd2l0\naCB0aGUgcmlnaHQgdHlwZSB3aGljaCBpcyBzZXQgdG8gdGhlIHZhbHVlDQo+IG9mICd4JyB3aGVu\nIHRoZSBicmFuY2ggaXMgdGFrZW4gd291bGQgZml4IHRoaXMgaXNzdWUuDQoNClRoYXQgbG9va3Mg\nZXZlbiBtb3JlIHN5bnRhY3RpY2FsbHkgb2JzY3VyZSB0aGFuIF9HZW5lcmljIGl0c2VsZi4NCldo\neSBkb2VzIGl0IG5lZWQgdG8gZG8gbW9yZSB0aGFuIHZlcnkgc2ltcGxlIHN5bnRheCBhbmFseXNp\ncyBvZg0KdGhlIHVud2FudGVkIGJyYW5jaGVzIC0gb3IgdGhleSBjb3VsZCBhdXRvbWF0aWNhbGx5\nIGJlIGFuYWx5c2VkDQp3aXRoIHRoZSBuYW1lZCB2YXJpYWJsZSBoYXZlIHRoZSBzcGVjaWZp",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173367640605105.mbox",
          "message_id": "<e71fffb7ff0e4bf29692d006c0fe77c2 () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 16:48:58+00:00",
          "date_str": "Sun, 08 Dec 2024 16:48:58 +0000",
          "body": "RnJvbTogTWFydGluIFVlY2tlcg0KPiBTZW50OiAwOCBEZWNlbWJlciAyMDI0IDEyOjM4DQo+IA0K\nPiBBbSBTb25udGFnLCBkZW0gMDguMTIuMjAyNCB1bSAxMToyNiArMDAwMCBzY2hyaWViIERhdmlk\nIExhaWdodDoNCj4gPiBGcm9tOiBNYXJ0aW4gVWVja2VyDQo+ID4gPiBTZW50OiAwNyBEZWNlbWJl\nciAyMDI0IDIzOjUyDQo+ID4gLi4uDQo+ID4gPiBXaGlsZSB0aGUgY29tcGlsZXIgY2FuIG5vdCBh\ndXRvbWF0aWNhbGx5IHByb3ZlIGV2ZXJ5IHVzZQ0KPiA+ID4gb2YgVkxBIGJvdW5kZWQsIGl0IGNh\nbiByZWxpYWJseSBkaWFnbm9zZSB0aGUgY2FzZXMgd2hlcmUgaXQNCj4gPiA+IGNhbsKgKm5vdCog\nc2VlIHRoYXQgaXQgaXMgYm91bmRlZC4gQ29uc2lkZXIgdGhpcyBleGFtcGxlOg0KPiA+ID4NCj4g\nPiA+IHZvaWQgb29iKGludCBuLCBjaGFyIHBbbl0pOw0KPiA+ID4gdm9pZCBmKHVuc2lnbmVkIGlu\ndCBuKQ0KPiA+ID4gew0KPiA+ID4gICAgIGNoYXIgYnVmW01JTihuLCAxMDApXTsgLy8gYm91bmRl\nZA0KPiA+ID4gICAgIG9vYihuICsgMTAsIGJ1Zik7IC8vIHdhcm5pbmcNCj4gPiA+IH0NCj4gPiAu\nLi4NCj4gPg0KPiA+IFRoZSBrZXJuZWwgc3RhY2sgaGFzIHRvIGhhdmUgZW5vdWdoIHNwYWNlIGZv\nciB0aGUgWzEwMF0NCj4gPiBzbyB0aGUgZnVsbCBhbW91bnQgbWlnaHQgYXMgd2VsbCBhbHdheXMg\nYmUgYWxsb2NhdGVkLg0KPiA+IFRoZSBjaGFuY2Ugb2YgJ3RyYWRpbmcgb2ZmJyBzdGFjayB1c2Fn\nZSB3aXRoIGFub3RoZXIgZnVuY3Rpb24NCj4gPiBpbiB0aGUgc2FtZSBjYWxsIHN0YWNrIHRoYXQg\naXMgZ3VhcmFudGVlZCB0byB1c2UgbGVzcyB0aGFuDQo+ID4gaXRzIG1heGltdW0gaXMgYWJvdXQg\nemVyby4NCj4gDQo+IEluIG51bWVyaWNhbCBjb21wdXRpbmcgdGhpcyBpcyBhIGJpZyBtb3RpdmF0\naW9uIGJlY2F1c2UNCj4geW91IGNhbiByZWR1Y2Ugc3RhY2sgdXNhZ2UgaW4gcmVjdXJzaXZlIGRp\ndmlkZS1hbmQtY29ucXVlcg0KPiBhbGdvcml0aG1zLiAgRm9yIHRoZSBrZXJuZWwsIEkgYWdyZWUg\ndGhpcyBpcyBub3QgYQ0KPiBjb21wZWxsaW5nIHVzZSBjYXNlLCBhbmQgdGhlIGJldHRlciBtb3Rp\ndmF0aW9uIHdvdWxkIGJlDQo+IHByZWNpc2UgYm91bmRzIGNoZWNraW5nIGFuZCBjbGVhcmVyIHNl\nbWFudGljcyBmb3IgYnVmZmVyDQo+IG1hbmFnZW1lbnQuDQoNCkV4Y2VwdCB0aGF0IGNoYW5naW5n\nIHRoZSBzaXplIG9mIHRoZSBvbi1zdGFjayBhcnJheSBtYWtlcw0KYWJzb2x1dGVseSBubyBkaWZm\nZXJlbmNlLg0KSWRlYWxseSB0aGUga2VybmVsIHN0YWNrIHdvdWxkIGJlIGEgc2luZ2xlIDRrIHBh\nZ2UsIGJ1dCB0b28NCm11Y2ggY29kZSB1c2VzIG9uLXN0YWNrIGJ1ZmZlcnMgc28gaXQgaGFzIGJl\nZW4gaW5jcmVhc2VkIGFuZA0KbWlnaHQgYmUgMTZrIChvciBtb3JlISkuDQpSZW1lbWJlciB0aGlz\nIGlzIHBoeXNpY2FsIG1lbW9yeSBhbGxvY2F0ZWQgdG8gZXZlcnkgdXNlciB0aHJlYWQuDQpPbiBM\naW51eCBpdCBpcyBub3Qgc3dhcHBhYmxlLg0KDQouLi4NCj4gPiBUaGlzIGhhcHBlbmVkIGZvciAn\nY29uc3RhbnQnIHNpemVzIGZyb20gbWluKDE2LCBzaXplb2YgKHN0cnVjdCkpDQo+ID4gYmVjYXVz\nZSBtaW4oKSBuZWVkcyB0byBiZSBhIHN0YXRlbWVudCBmdW5jdGlvbiB0byBhdm9pZCByZS1ldmFs\ndWF0aW5nDQo+ID4gaXRzIGFyZ3VtZW50cy4NCj4gDQo+IENhbiB5b3UgY2xhcmlmeSB0aGlzPyAg\nSWYgdGhlIFZMQSBzaXplIGlzIGNvbnN0YW50LCBldmVuIHdoZW4NCj4gaXQgaXMgbm90IGFuIGlu\ndGVnZXIgY29uc3RhbnQgZXhwcmVzc2lvbiBhY2NvcmRpbmcgdG8gSVNPIEMsDQo+IHRoZSBjb21w\naWxlciBzaG91bGQgbm90IHByb2R1Y2Ugd29yc2UgY29kZS4gIEZvciBleGFtcGxlLA0KDQpJIGp1\nc3QgdHJpZWQgdG8gcmVwcm9kdWNlIHRoZSBmYWlsaW5nIGNhc2UgLSBhbmQgZmFpbGVkLg0KSXQg\nd2FzIHNpbWlsYXIgdG8gX19idWlsdGluX2NvbnN0YW50X3AoKSBpbml0aWFsbHkgcmV0dXJuaW5n\nICdkb24ndCBrbm93Jw0Kc28gdGhlICd2YXJpYWJsZSBzaXplZCcgYXJyYXkgY29kZSBnb3QgYWRk\nZWQsIHRoZW4gbXVjaCBsYXRlcg0KYWZ0ZXIgZnVydGhlciBvcHRpbWlzYXRpb24gcGFzc2VzIHRo\nZSBleHByZXNzaW9uIGJlY2FtZSBjb25zdGFudC4NClNvIHlvdSBlbmRlZCB1cCB3aXRoIGEgJ2Zp\neGVkIHNpemUnIFZMQS4NCg0KQ29tcGlsZSB3aXRoIC1Xbm8tdmxhIChhbmQgLVdlcnJvcikgYW5k\nIHRoZSBjb21waWxlIGZhaWxlZC4NCg0KLi4uDQo+IFNvIGEgbG90IG9mIHRoaXMgbWFjcm8gYnVz\naW5lc3Mgc2VlbXMgdG8gYmUgbmVjZXNzYXJ5DQo+IHRvIGF2b2lkIGNyZWF0aW5nIHdhcm5pbmdz\nIGZvciBJU08gVkxBcyB3aGVuIGluc3RlYWQgeW91IHJlYWxseQ0KPiBjYXJlIGFib3V0IHRoZSBj\ncmVhdGVkIGNvZGUgbm90IGhhdmluZyBhIGR5bmFtaWMgYWxsb2NhdGlvbiBvbg0KPiB0aGUgc3Rh\nY2suDQoNCkEgbG90IG9mIHRoZSAnbWFjcm8gYnVzaW5lc3MnIGZvciBtaW4vbWF4IGlzIGF2b2lk\naW5nIHVuZXhwZWN0ZWQNCmNvbnZlcnNpb24gb2YgbmVnYXRpdmUgdmFsdWVzIHRvIHZlcnkgbGFy\nZ2UgdW5zaWduZWQgb25lcy4NCkFuZCBubywgLVdzaWduLWNvbXBhcmUgaXMgc3BlY3RhY3VsYXJs\neSB1c2VsZXNzLg0KDQouLg0KPiBUaGUgaXNzdWUgaGVyZSBpcyB0aGF0IHdlIG1pc3MgYSBsYW5n\ndWFnZSBmZWF0dXJlIGluIEMgdG8NCj4gaW50cm9kdWNlIGxvY2FsIHZhcmlhYmxlcyB0aGF0IGhl\nbHAgYXZvaWQgbXVsdGlwbGUgZXhwYW5zaW9uDQo+IG9mIG1hY3JvIGFyZ3VtZW50cy4gIEdDQydz\nIHN0YXRlbWVudCBleHByZXNzaW9ucyBhbmQgX19hdXRvX3R5cGUNCj4gYXJlIGEgc29sdXRpb24N\nCg0Kb3IgaGlzdG9yaWNhbGx5ICd0eXBlb2YoeCkgX3ggPSB4Jw0KDQo+ICNkZWZpbmUgZm9vKHgp\nICh7IF9fYXV0b190eXBlIF9feCA9ICh4KTsgLi4uIH0pDQo+IA0KPiBidXQgdGhpcyBydW5zIGlu\ndG8gdGhlIGN1cnJlbnQgbGltaXRhdGlvbnMgdGhhdCAoeyB9KSBjYW4gbm90IGJlIHVzZWQNCj4g\nYXQgZmlsZS1zY29wZSBhbmQgY2FuIG5vdCByZXR1cm4gY29uc3RhbnQgZXhwcmVzc2lvbnMuDQo+\nIA0KPiANCj4gRm9yIG90aGVyIHJlYXNvbnMgSSB3YXMgdGhpbmtpbmcgYWJvdXQgYWRkaW5nIG5h\nbWVzIHRvIF9HZW5lcmljLA0KPiBhcyBpbg0KPiANCj4gX0dlbmVyaWMoeCwgaW50IGk6IChpICsg\nMSkpOw0KPiANCj4gYmVjYXVzZSBvbmUgZGVzaWduIGlzc3VlcyB3aXRoIF9HZW5lcmljIGlzIHRo\nYXQgaXQgdHlwZWNoZWNrcw0KPiBhbHNvIHRoZSB1bnRha2VuIGFzc29jaWF0aW9ucyBhbmQgdGhl\ncmUgdGhlICd4JyB0aGVuIGhhcyB0aGUgd3JvbmcNCj4gdHlwZS4gIEhhdmluZyBhbiAnaScgd2l0\naCB0aGUgcmlnaHQgdHlwZSB3aGljaCBpcyBzZXQgdG8gdGhlIHZhbHVlDQo+IG9mICd4JyB3aGVu\nIHRoZSBicmFuY2ggaXMgdGFrZW4gd291bGQgZml4IHRoaXMgaXNzdWUuDQoNClRoYXQgbG9va3Mg\nZXZlbiBtb3JlIHN5bnRhY3RpY2FsbHkgb2JzY3VyZSB0aGFuIF9HZW5lcmljIGl0c2VsZi4NCldo\neSBkb2VzIGl0IG5lZWQgdG8gZG8gbW9yZSB0aGFuIHZlcnkgc2ltcGxlIHN5bnRheCBhbmFseXNp\ncyBvZg0KdGhlIHVud2FudGVkIGJyYW5jaGVzIC0gb3IgdGhleSBjb3VsZCBhdXRvbWF0aWNhbGx5\nIGJlIGFuYWx5c2VkDQp3aXRoIHRoZSBuYW1lZCB2YXJpYWJsZSBoYXZlIHRoZSBzcGVjaWZp",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173367640405098.mbox",
          "message_id": "<e71fffb7ff0e4bf29692d006c0fe77c2 () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 16:48:58+00:00",
          "date_str": "Sun, 08 Dec 2024 16:48:58 +0000",
          "body": "RnJvbTogTWFydGluIFVlY2tlcg0KPiBTZW50OiAwOCBEZWNlbWJlciAyMDI0IDEyOjM4DQo+IA0K\nPiBBbSBTb25udGFnLCBkZW0gMDguMTIuMjAyNCB1bSAxMToyNiArMDAwMCBzY2hyaWViIERhdmlk\nIExhaWdodDoNCj4gPiBGcm9tOiBNYXJ0aW4gVWVja2VyDQo+ID4gPiBTZW50OiAwNyBEZWNlbWJl\nciAyMDI0IDIzOjUyDQo+ID4gLi4uDQo+ID4gPiBXaGlsZSB0aGUgY29tcGlsZXIgY2FuIG5vdCBh\ndXRvbWF0aWNhbGx5IHByb3ZlIGV2ZXJ5IHVzZQ0KPiA+ID4gb2YgVkxBIGJvdW5kZWQsIGl0IGNh\nbiByZWxpYWJseSBkaWFnbm9zZSB0aGUgY2FzZXMgd2hlcmUgaXQNCj4gPiA+IGNhbsKgKm5vdCog\nc2VlIHRoYXQgaXQgaXMgYm91bmRlZC4gQ29uc2lkZXIgdGhpcyBleGFtcGxlOg0KPiA+ID4NCj4g\nPiA+IHZvaWQgb29iKGludCBuLCBjaGFyIHBbbl0pOw0KPiA+ID4gdm9pZCBmKHVuc2lnbmVkIGlu\ndCBuKQ0KPiA+ID4gew0KPiA+ID4gICAgIGNoYXIgYnVmW01JTihuLCAxMDApXTsgLy8gYm91bmRl\nZA0KPiA+ID4gICAgIG9vYihuICsgMTAsIGJ1Zik7IC8vIHdhcm5pbmcNCj4gPiA+IH0NCj4gPiAu\nLi4NCj4gPg0KPiA+IFRoZSBrZXJuZWwgc3RhY2sgaGFzIHRvIGhhdmUgZW5vdWdoIHNwYWNlIGZv\nciB0aGUgWzEwMF0NCj4gPiBzbyB0aGUgZnVsbCBhbW91bnQgbWlnaHQgYXMgd2VsbCBhbHdheXMg\nYmUgYWxsb2NhdGVkLg0KPiA+IFRoZSBjaGFuY2Ugb2YgJ3RyYWRpbmcgb2ZmJyBzdGFjayB1c2Fn\nZSB3aXRoIGFub3RoZXIgZnVuY3Rpb24NCj4gPiBpbiB0aGUgc2FtZSBjYWxsIHN0YWNrIHRoYXQg\naXMgZ3VhcmFudGVlZCB0byB1c2UgbGVzcyB0aGFuDQo+ID4gaXRzIG1heGltdW0gaXMgYWJvdXQg\nemVyby4NCj4gDQo+IEluIG51bWVyaWNhbCBjb21wdXRpbmcgdGhpcyBpcyBhIGJpZyBtb3RpdmF0\naW9uIGJlY2F1c2UNCj4geW91IGNhbiByZWR1Y2Ugc3RhY2sgdXNhZ2UgaW4gcmVjdXJzaXZlIGRp\ndmlkZS1hbmQtY29ucXVlcg0KPiBhbGdvcml0aG1zLiAgRm9yIHRoZSBrZXJuZWwsIEkgYWdyZWUg\ndGhpcyBpcyBub3QgYQ0KPiBjb21wZWxsaW5nIHVzZSBjYXNlLCBhbmQgdGhlIGJldHRlciBtb3Rp\ndmF0aW9uIHdvdWxkIGJlDQo+IHByZWNpc2UgYm91bmRzIGNoZWNraW5nIGFuZCBjbGVhcmVyIHNl\nbWFudGljcyBmb3IgYnVmZmVyDQo+IG1hbmFnZW1lbnQuDQoNCkV4Y2VwdCB0aGF0IGNoYW5naW5n\nIHRoZSBzaXplIG9mIHRoZSBvbi1zdGFjayBhcnJheSBtYWtlcw0KYWJzb2x1dGVseSBubyBkaWZm\nZXJlbmNlLg0KSWRlYWxseSB0aGUga2VybmVsIHN0YWNrIHdvdWxkIGJlIGEgc2luZ2xlIDRrIHBh\nZ2UsIGJ1dCB0b28NCm11Y2ggY29kZSB1c2VzIG9uLXN0YWNrIGJ1ZmZlcnMgc28gaXQgaGFzIGJl\nZW4gaW5jcmVhc2VkIGFuZA0KbWlnaHQgYmUgMTZrIChvciBtb3JlISkuDQpSZW1lbWJlciB0aGlz\nIGlzIHBoeXNpY2FsIG1lbW9yeSBhbGxvY2F0ZWQgdG8gZXZlcnkgdXNlciB0aHJlYWQuDQpPbiBM\naW51eCBpdCBpcyBub3Qgc3dhcHBhYmxlLg0KDQouLi4NCj4gPiBUaGlzIGhhcHBlbmVkIGZvciAn\nY29uc3RhbnQnIHNpemVzIGZyb20gbWluKDE2LCBzaXplb2YgKHN0cnVjdCkpDQo+ID4gYmVjYXVz\nZSBtaW4oKSBuZWVkcyB0byBiZSBhIHN0YXRlbWVudCBmdW5jdGlvbiB0byBhdm9pZCByZS1ldmFs\ndWF0aW5nDQo+ID4gaXRzIGFyZ3VtZW50cy4NCj4gDQo+IENhbiB5b3UgY2xhcmlmeSB0aGlzPyAg\nSWYgdGhlIFZMQSBzaXplIGlzIGNvbnN0YW50LCBldmVuIHdoZW4NCj4gaXQgaXMgbm90IGFuIGlu\ndGVnZXIgY29uc3RhbnQgZXhwcmVzc2lvbiBhY2NvcmRpbmcgdG8gSVNPIEMsDQo+IHRoZSBjb21w\naWxlciBzaG91bGQgbm90IHByb2R1Y2Ugd29yc2UgY29kZS4gIEZvciBleGFtcGxlLA0KDQpJIGp1\nc3QgdHJpZWQgdG8gcmVwcm9kdWNlIHRoZSBmYWlsaW5nIGNhc2UgLSBhbmQgZmFpbGVkLg0KSXQg\nd2FzIHNpbWlsYXIgdG8gX19idWlsdGluX2NvbnN0YW50X3AoKSBpbml0aWFsbHkgcmV0dXJuaW5n\nICdkb24ndCBrbm93Jw0Kc28gdGhlICd2YXJpYWJsZSBzaXplZCcgYXJyYXkgY29kZSBnb3QgYWRk\nZWQsIHRoZW4gbXVjaCBsYXRlcg0KYWZ0ZXIgZnVydGhlciBvcHRpbWlzYXRpb24gcGFzc2VzIHRo\nZSBleHByZXNzaW9uIGJlY2FtZSBjb25zdGFudC4NClNvIHlvdSBlbmRlZCB1cCB3aXRoIGEgJ2Zp\neGVkIHNpemUnIFZMQS4NCg0KQ29tcGlsZSB3aXRoIC1Xbm8tdmxhIChhbmQgLVdlcnJvcikgYW5k\nIHRoZSBjb21waWxlIGZhaWxlZC4NCg0KLi4uDQo+IFNvIGEgbG90IG9mIHRoaXMgbWFjcm8gYnVz\naW5lc3Mgc2VlbXMgdG8gYmUgbmVjZXNzYXJ5DQo+IHRvIGF2b2lkIGNyZWF0aW5nIHdhcm5pbmdz\nIGZvciBJU08gVkxBcyB3aGVuIGluc3RlYWQgeW91IHJlYWxseQ0KPiBjYXJlIGFib3V0IHRoZSBj\ncmVhdGVkIGNvZGUgbm90IGhhdmluZyBhIGR5bmFtaWMgYWxsb2NhdGlvbiBvbg0KPiB0aGUgc3Rh\nY2suDQoNCkEgbG90IG9mIHRoZSAnbWFjcm8gYnVzaW5lc3MnIGZvciBtaW4vbWF4IGlzIGF2b2lk\naW5nIHVuZXhwZWN0ZWQNCmNvbnZlcnNpb24gb2YgbmVnYXRpdmUgdmFsdWVzIHRvIHZlcnkgbGFy\nZ2UgdW5zaWduZWQgb25lcy4NCkFuZCBubywgLVdzaWduLWNvbXBhcmUgaXMgc3BlY3RhY3VsYXJs\neSB1c2VsZXNzLg0KDQouLg0KPiBUaGUgaXNzdWUgaGVyZSBpcyB0aGF0IHdlIG1pc3MgYSBsYW5n\ndWFnZSBmZWF0dXJlIGluIEMgdG8NCj4gaW50cm9kdWNlIGxvY2FsIHZhcmlhYmxlcyB0aGF0IGhl\nbHAgYXZvaWQgbXVsdGlwbGUgZXhwYW5zaW9uDQo+IG9mIG1hY3JvIGFyZ3VtZW50cy4gIEdDQydz\nIHN0YXRlbWVudCBleHByZXNzaW9ucyBhbmQgX19hdXRvX3R5cGUNCj4gYXJlIGEgc29sdXRpb24N\nCg0Kb3IgaGlzdG9yaWNhbGx5ICd0eXBlb2YoeCkgX3ggPSB4Jw0KDQo+ICNkZWZpbmUgZm9vKHgp\nICh7IF9fYXV0b190eXBlIF9feCA9ICh4KTsgLi4uIH0pDQo+IA0KPiBidXQgdGhpcyBydW5zIGlu\ndG8gdGhlIGN1cnJlbnQgbGltaXRhdGlvbnMgdGhhdCAoeyB9KSBjYW4gbm90IGJlIHVzZWQNCj4g\nYXQgZmlsZS1zY29wZSBhbmQgY2FuIG5vdCByZXR1cm4gY29uc3RhbnQgZXhwcmVzc2lvbnMuDQo+\nIA0KPiANCj4gRm9yIG90aGVyIHJlYXNvbnMgSSB3YXMgdGhpbmtpbmcgYWJvdXQgYWRkaW5nIG5h\nbWVzIHRvIF9HZW5lcmljLA0KPiBhcyBpbg0KPiANCj4gX0dlbmVyaWMoeCwgaW50IGk6IChpICsg\nMSkpOw0KPiANCj4gYmVjYXVzZSBvbmUgZGVzaWduIGlzc3VlcyB3aXRoIF9HZW5lcmljIGlzIHRo\nYXQgaXQgdHlwZWNoZWNrcw0KPiBhbHNvIHRoZSB1bnRha2VuIGFzc29jaWF0aW9ucyBhbmQgdGhl\ncmUgdGhlICd4JyB0aGVuIGhhcyB0aGUgd3JvbmcNCj4gdHlwZS4gIEhhdmluZyBhbiAnaScgd2l0\naCB0aGUgcmlnaHQgdHlwZSB3aGljaCBpcyBzZXQgdG8gdGhlIHZhbHVlDQo+IG9mICd4JyB3aGVu\nIHRoZSBicmFuY2ggaXMgdGFrZW4gd291bGQgZml4IHRoaXMgaXNzdWUuDQoNClRoYXQgbG9va3Mg\nZXZlbiBtb3JlIHN5bnRhY3RpY2FsbHkgb2JzY3VyZSB0aGFuIF9HZW5lcmljIGl0c2VsZi4NCldo\neSBkb2VzIGl0IG5lZWQgdG8gZG8gbW9yZSB0aGFuIHZlcnkgc2ltcGxlIHN5bnRheCBhbmFseXNp\ncyBvZg0KdGhlIHVud2FudGVkIGJyYW5jaGVzIC0gb3IgdGhleSBjb3VsZCBhdXRvbWF0aWNhbGx5\nIGJlIGFuYWx5c2VkDQp3aXRoIHRoZSBuYW1lZCB2YXJpYWJsZSBoYXZlIHRoZSBzcGVjaWZp",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173368127407149.mbox",
          "message_id": "<87dd9b7b52e7cea874c1899f56efdd3d7c5b7243.camel () gwdg ! de>",
          "author_name": "Martin Uecker",
          "author_email": "muecker () gwdg ! de",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 18:10:49+00:00",
          "date_str": "Sun, 08 Dec 2024 18:10:49 +0000",
          "body": "Am Sonntag, dem 08.12.2024 um 16:48 +0000 schrieb David Laight:\n> From: Martin Uecker\n> > Sent: 08 December 2024 12:38\n\n...\n> ...\n> > So a lot of this macro business seems to be necessary\n> > to avoid creating warnings for ISO VLAs when instead you really\n> > care about the created code not having a dynamic allocation on\n> > the stack.\n>=20\n> A lot of the 'macro business' for min/max is avoiding unexpected\n> conversion of negative values to very large unsigned ones.\n> And no, -Wsign-compare is spectacularly useless.\n\nThis is a different topic, but what would be needed here?\n>=20\n> ..\n> > The issue here is that we miss a language feature in C to\n> > introduce local variables that help avoid multiple expansion\n> > of macro arguments.  GCC's statement expressions and __auto_type\n> > are a solution\n>=20\n> or historically 'typeof(x) _x =3D x'\n>=20\n> > #define foo(x) ({ __auto_type __x =3D (x); ... })\n> >=20\n> > but this runs into the current limitations that ({ }) can not be used\n> > at file-scope and can not return constant expressions.\n> >=20\n> >=20\n> > For other reasons I was thinking about adding names to _Generic,\n> > as in\n> >=20\n> > _Generic(x, int i: (i + 1));\n> >=20\n> > because one design issues with _Generic is that it typechecks\n> > also the untaken associations and there the 'x' then has the wrong\n> > type.  Having an 'i' with the right type which is set to the value\n> > of 'x' when the branch is taken would fix this issue.\n>=20\n> That looks even more syntactically obscure than _Generic itself.\n> Why does it need to do more than very simple syntax analysis of\n> the unwanted branches=C2=A0\n\nThis would be possible and GCC does turn of some warnings in\nthe unwanted branches.  I added this to GCC 14 I think.\n\nBut so far, ISO C requires that all branches are valid and this\nwas an intentional design decision to detect errors.\n\n> - or they could automatically be analysed\n> with the named variable have the specified type?\n\nInside a macro there is no variable 'x' but\nthe macro argument 'x' is replaced by some expression.\n\nAlso there is the general problem of multiple expansion which\ncan only be addressed by introducing an identifier.\n\n>=20\n> > But this feature might also allow writing macros that avoid\n> > double expansion without requiring statement expressions (which\n> > are more difficult to fix):\n> >=20\n> > #define foo(x) _Generic(x, int i: (i + i));\n>=20\n> How can that work for things like min() that have multiple arguments?\n\nYou would need to nest it:\n\n#define foo(x, y) _Generic(x, int i: _Generic(y, int j: i + j))\n\nOtherwise one could invent syntax for matching multiple arguments\nat the same time.\n\nThere is still the problem of name collision, but this is already\na problem with=C2=A0\n\n({ int i =3D (x); int j =3D (x); i + j; })=20\n\n> Not going to work if you need __auto_type either.\n\nIf we allowed an identifier for the default branch too, this\nwould work:  _Generic(x, default i: (2 * i))\n\n\nBut hey, I am not saying  this is perfect, it is just\na possible improvement I was thinking about and which could be\nimplemented easily, would automatically return constant expressions,\nand could be used at file scope without further changes.\n\nThere are certainly better long-term solutions.\n\nMartin\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173368127307144.mbox",
          "message_id": "<87dd9b7b52e7cea874c1899f56efdd3d7c5b7243.camel () gwdg ! de>",
          "author_name": "Martin Uecker",
          "author_email": "muecker () gwdg ! de",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 18:10:49+00:00",
          "date_str": "Sun, 08 Dec 2024 18:10:49 +0000",
          "body": "Am Sonntag, dem 08.12.2024 um 16:48 +0000 schrieb David Laight:\n> From: Martin Uecker\n> > Sent: 08 December 2024 12:38\n\n...\n> ...\n> > So a lot of this macro business seems to be necessary\n> > to avoid creating warnings for ISO VLAs when instead you really\n> > care about the created code not having a dynamic allocation on\n> > the stack.\n>=20\n> A lot of the 'macro business' for min/max is avoiding unexpected\n> conversion of negative values to very large unsigned ones.\n> And no, -Wsign-compare is spectacularly useless.\n\nThis is a different topic, but what would be needed here?\n>=20\n> ..\n> > The issue here is that we miss a language feature in C to\n> > introduce local variables that help avoid multiple expansion\n> > of macro arguments.  GCC's statement expressions and __auto_type\n> > are a solution\n>=20\n> or historically 'typeof(x) _x =3D x'\n>=20\n> > #define foo(x) ({ __auto_type __x =3D (x); ... })\n> >=20\n> > but this runs into the current limitations that ({ }) can not be used\n> > at file-scope and can not return constant expressions.\n> >=20\n> >=20\n> > For other reasons I was thinking about adding names to _Generic,\n> > as in\n> >=20\n> > _Generic(x, int i: (i + 1));\n> >=20\n> > because one design issues with _Generic is that it typechecks\n> > also the untaken associations and there the 'x' then has the wrong\n> > type.  Having an 'i' with the right type which is set to the value\n> > of 'x' when the branch is taken would fix this issue.\n>=20\n> That looks even more syntactically obscure than _Generic itself.\n> Why does it need to do more than very simple syntax analysis of\n> the unwanted branches=C2=A0\n\nThis would be possible and GCC does turn of some warnings in\nthe unwanted branches.  I added this to GCC 14 I think.\n\nBut so far, ISO C requires that all branches are valid and this\nwas an intentional design decision to detect errors.\n\n> - or they could automatically be analysed\n> with the named variable have the specified type?\n\nInside a macro there is no variable 'x' but\nthe macro argument 'x' is replaced by some expression.\n\nAlso there is the general problem of multiple expansion which\ncan only be addressed by introducing an identifier.\n\n>=20\n> > But this feature might also allow writing macros that avoid\n> > double expansion without requiring statement expressions (which\n> > are more difficult to fix):\n> >=20\n> > #define foo(x) _Generic(x, int i: (i + i));\n>=20\n> How can that work for things like min() that have multiple arguments?\n\nYou would need to nest it:\n\n#define foo(x, y) _Generic(x, int i: _Generic(y, int j: i + j))\n\nOtherwise one could invent syntax for matching multiple arguments\nat the same time.\n\nThere is still the problem of name collision, but this is already\na problem with=C2=A0\n\n({ int i =3D (x); int j =3D (x); i + j; })=20\n\n> Not going to work if you need __auto_type either.\n\nIf we allowed an identifier for the default branch too, this\nwould work:  _Generic(x, default i: (2 * i))\n\n\nBut hey, I am not saying  this is perfect, it is just\na possible improvement I was thinking about and which could be\nimplemented easily, would automatically return constant expressions,\nand could be used at file scope without further changes.\n\nThere are certainly better long-term solutions.\n\nMartin\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173368126507138.mbox",
          "message_id": "<87dd9b7b52e7cea874c1899f56efdd3d7c5b7243.camel () gwdg ! de>",
          "author_name": "Martin Uecker",
          "author_email": "muecker () gwdg ! de",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 18:10:49+00:00",
          "date_str": "Sun, 08 Dec 2024 18:10:49 +0000",
          "body": "Am Sonntag, dem 08.12.2024 um 16:48 +0000 schrieb David Laight:\n> From: Martin Uecker\n> > Sent: 08 December 2024 12:38\n\n...\n> ...\n> > So a lot of this macro business seems to be necessary\n> > to avoid creating warnings for ISO VLAs when instead you really\n> > care about the created code not having a dynamic allocation on\n> > the stack.\n>=20\n> A lot of the 'macro business' for min/max is avoiding unexpected\n> conversion of negative values to very large unsigned ones.\n> And no, -Wsign-compare is spectacularly useless.\n\nThis is a different topic, but what would be needed here?\n>=20\n> ..\n> > The issue here is that we miss a language feature in C to\n> > introduce local variables that help avoid multiple expansion\n> > of macro arguments.  GCC's statement expressions and __auto_type\n> > are a solution\n>=20\n> or historically 'typeof(x) _x =3D x'\n>=20\n> > #define foo(x) ({ __auto_type __x =3D (x); ... })\n> >=20\n> > but this runs into the current limitations that ({ }) can not be used\n> > at file-scope and can not return constant expressions.\n> >=20\n> >=20\n> > For other reasons I was thinking about adding names to _Generic,\n> > as in\n> >=20\n> > _Generic(x, int i: (i + 1));\n> >=20\n> > because one design issues with _Generic is that it typechecks\n> > also the untaken associations and there the 'x' then has the wrong\n> > type.  Having an 'i' with the right type which is set to the value\n> > of 'x' when the branch is taken would fix this issue.\n>=20\n> That looks even more syntactically obscure than _Generic itself.\n> Why does it need to do more than very simple syntax analysis of\n> the unwanted branches=C2=A0\n\nThis would be possible and GCC does turn of some warnings in\nthe unwanted branches.  I added this to GCC 14 I think.\n\nBut so far, ISO C requires that all branches are valid and this\nwas an intentional design decision to detect errors.\n\n> - or they could automatically be analysed\n> with the named variable have the specified type?\n\nInside a macro there is no variable 'x' but\nthe macro argument 'x' is replaced by some expression.\n\nAlso there is the general problem of multiple expansion which\ncan only be addressed by introducing an identifier.\n\n>=20\n> > But this feature might also allow writing macros that avoid\n> > double expansion without requiring statement expressions (which\n> > are more difficult to fix):\n> >=20\n> > #define foo(x) _Generic(x, int i: (i + i));\n>=20\n> How can that work for things like min() that have multiple arguments?\n\nYou would need to nest it:\n\n#define foo(x, y) _Generic(x, int i: _Generic(y, int j: i + j))\n\nOtherwise one could invent syntax for matching multiple arguments\nat the same time.\n\nThere is still the problem of name collision, but this is already\na problem with=C2=A0\n\n({ int i =3D (x); int j =3D (x); i + j; })=20\n\n> Not going to work if you need __auto_type either.\n\nIf we allowed an identifier for the default branch too, this\nwould work:  _Generic(x, default i: (2 * i))\n\n\nBut hey, I am not saying  this is perfect, it is just\na possible improvement I was thinking about and which could be\nimplemented easily, would automatically return constant expressions,\nand could be used at file scope without further changes.\n\nThere are certainly better long-term solutions.\n\nMartin\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173368456408499.mbox",
          "message_id": "<CAHk-=wg+_6eQnLWm-kihFxJo1_EmyLSGruKVGzuRUwACE=osrA () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 19:05:34+00:00",
          "date_str": "Sun, 08 Dec 2024 19:05:34 +0000",
          "body": "On Sun, 8 Dec 2024 at 10:11, Martin Uecker <muecker@gwdg.de> wrote:\n> >\n> > A lot of the 'macro business' for min/max is avoiding unexpected\n> > conversion of negative values to very large unsigned ones.\n> > And no, -Wsign-compare is spectacularly useless.\n>\n> This is a different topic, but what would be needed here?\n\nDan Carpenter actually wrote up some of the issues in:\n\n   https://staticthinking.wordpress.com/2023/07/25/wsign-compare-is-garbage=\n/\n\nbut the basic issue is that -Wsign-compare has over the years been\ntruly spectacularly bad.\n\nIt has literally started out from the completely nonsensical and\nincorrect assumption that the types of a comparison have to match in\nsignedness, and it shows in the name itself, but it also showed in\nearly implementations.\n\nThe very first versions of gcc that did -Wsign-compare literally\ncomplained about code like\n\n     sizeof(x) < 5\n\nbecause obviously one side is an unsigned 'size_t', and the other side\nis a signed 'int'. So comparing the two is clearly invalid, right?\n\nNo.\n\nIt's obviously *not* invalid, and any compiler that complains about\ndifferent signedness of that compare is just complete useless garbage.\nIt's literally checking two constants against each other, and the\nresult doesn't depend on the signedness or the silent C implicit type\nconversion.\n\nAnd no, gcc doesn't complain about that particular code any more.\n*That* particular problem was I think only visible in a gcc\npre-release that sadly did actually ship as part of a SUSE release, so\nwe saw it in the wild even if it was never in an official gcc release.\n\nI'm pointing out the history because it's relevant due to explaining\n*why* the whole concept of looking at just the type is so broken, and\nhow the whole background to the warning was broken from the very\nbeginning. The very name of the warning is a sign of the problem.\n\nBecause gcc still *does* complain about entirely valid code, where\n\"fixing\" the warning just means you have to write worse code.\n\nI think Dan's example from the link above is a good one: if\n\n        for (int i =3D 0; i < sizeof(x); i++)\n\ncauses a warning, the compiler got things entirely wrong.\n\nAnd yes, modern gcc very much warns about that:\n\n  t.c:4:27: warning: comparison of integer expressions of different\nsignedness: =E2=80=98int=E2=80=99 and =E2=80=98long unsigned int=E2=80=99 [=\n-Wsign-compare]\n      4 |         for (int i =3D 0; i < sizeof(b); i++)\n        |                           ^\n\nSo if you want a general-purpose \"Warn about dangerous comparisons\",\nyou need to get away from the mindset that it's about different signs.\n\nA compiler needs to do proper value range analysis before warning\nabout comparing said values. Not just mindlessly say \"different types\nbad\" like some marsupial that has been dropped on its head a few too\nmany times.\n\nEnd result: calling it \"Warn about sign compare\" is a disease. It\nshows a lack of understanding of how complex the warning logic needs\nto be.\n\nNow, I'm not claiming that our min/max type warnings are great either:\nthey *do* end up basically being the same silly \"just check signs, but\nat least don't complain about signed positive constants being used for\nunsigned comparisons\".\n\nSo our min/max macros most definitely are *not* doing that \"value\nrange analysis\" that I claim is required for a *general* comparison\nthing.\n\nBut our min//max macros aren't some general thing. They are very\nspecific, and so it's a lot easier to accept the not-great-analysis\nfor those specific cases where we then may have to change types\nexplicitly or do some other massaging to avoid the warning.\n\nPut another way: a warning that triggers on really basic C absolutely\n*must*not* have silly easily triggerable false positives for good and\nidiomatic source code.\n\nSuch a warning is worse than useless, and gets disabled.\n\nBut a warning that is overly restrictive and gives silly false\npositives can still be entirely acceptable when the context of that\nwarning is very limited.\n\nSo this is why in the kernel we disable '-Wsign-compare' in the\ngeneral case, but *do* basically manually then implement that very\nsame logic in the very _specific_ case of the min/max() macros.\n\nWhat is unacceptable nonsense in one case may be acceptable \"good\nenough\" in another. Life is not fair, I'm afraid.\n\n                Linus\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173368493108712.mbox",
          "message_id": "<CAHk-=wg+_6eQnLWm-kihFxJo1_EmyLSGruKVGzuRUwACE=osrA () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 19:05:34+00:00",
          "date_str": "Sun, 08 Dec 2024 19:05:34 +0000",
          "body": "On Sun, 8 Dec 2024 at 10:11, Martin Uecker <muecker@gwdg.de> wrote:\n> >\n> > A lot of the 'macro business' for min/max is avoiding unexpected\n> > conversion of negative values to very large unsigned ones.\n> > And no, -Wsign-compare is spectacularly useless.\n>\n> This is a different topic, but what would be needed here?\n\nDan Carpenter actually wrote up some of the issues in:\n\n   https://staticthinking.wordpress.com/2023/07/25/wsign-compare-is-garbage=\n/\n\nbut the basic issue is that -Wsign-compare has over the years been\ntruly spectacularly bad.\n\nIt has literally started out from the completely nonsensical and\nincorrect assumption that the types of a comparison have to match in\nsignedness, and it shows in the name itself, but it also showed in\nearly implementations.\n\nThe very first versions of gcc that did -Wsign-compare literally\ncomplained about code like\n\n     sizeof(x) < 5\n\nbecause obviously one side is an unsigned 'size_t', and the other side\nis a signed 'int'. So comparing the two is clearly invalid, right?\n\nNo.\n\nIt's obviously *not* invalid, and any compiler that complains about\ndifferent signedness of that compare is just complete useless garbage.\nIt's literally checking two constants against each other, and the\nresult doesn't depend on the signedness or the silent C implicit type\nconversion.\n\nAnd no, gcc doesn't complain about that particular code any more.\n*That* particular problem was I think only visible in a gcc\npre-release that sadly did actually ship as part of a SUSE release, so\nwe saw it in the wild even if it was never in an official gcc release.\n\nI'm pointing out the history because it's relevant due to explaining\n*why* the whole concept of looking at just the type is so broken, and\nhow the whole background to the warning was broken from the very\nbeginning. The very name of the warning is a sign of the problem.\n\nBecause gcc still *does* complain about entirely valid code, where\n\"fixing\" the warning just means you have to write worse code.\n\nI think Dan's example from the link above is a good one: if\n\n        for (int i =3D 0; i < sizeof(x); i++)\n\ncauses a warning, the compiler got things entirely wrong.\n\nAnd yes, modern gcc very much warns about that:\n\n  t.c:4:27: warning: comparison of integer expressions of different\nsignedness: =E2=80=98int=E2=80=99 and =E2=80=98long unsigned int=E2=80=99 [=\n-Wsign-compare]\n      4 |         for (int i =3D 0; i < sizeof(b); i++)\n        |                           ^\n\nSo if you want a general-purpose \"Warn about dangerous comparisons\",\nyou need to get away from the mindset that it's about different signs.\n\nA compiler needs to do proper value range analysis before warning\nabout comparing said values. Not just mindlessly say \"different types\nbad\" like some marsupial that has been dropped on its head a few too\nmany times.\n\nEnd result: calling it \"Warn about sign compare\" is a disease. It\nshows a lack of understanding of how complex the warning logic needs\nto be.\n\nNow, I'm not claiming that our min/max type warnings are great either:\nthey *do* end up basically being the same silly \"just check signs, but\nat least don't complain about signed positive constants being used for\nunsigned comparisons\".\n\nSo our min/max macros most definitely are *not* doing that \"value\nrange analysis\" that I claim is required for a *general* comparison\nthing.\n\nBut our min//max macros aren't some general thing. They are very\nspecific, and so it's a lot easier to accept the not-great-analysis\nfor those specific cases where we then may have to change types\nexplicitly or do some other massaging to avoid the warning.\n\nPut another way: a warning that triggers on really basic C absolutely\n*must*not* have silly easily triggerable false positives for good and\nidiomatic source code.\n\nSuch a warning is worse than useless, and gets disabled.\n\nBut a warning that is overly restrictive and gives silly false\npositives can still be entirely acceptable when the context of that\nwarning is very limited.\n\nSo this is why in the kernel we disable '-Wsign-compare' in the\ngeneral case, but *do* basically manually then implement that very\nsame logic in the very _specific_ case of the min/max() macros.\n\nWhat is unacceptable nonsense in one case may be acceptable \"good\nenough\" in another. Life is not fair, I'm afraid.\n\n                Linus\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173368456308496.mbox",
          "message_id": "<CAHk-=wg+_6eQnLWm-kihFxJo1_EmyLSGruKVGzuRUwACE=osrA () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-08 19:05:34+00:00",
          "date_str": "Sun, 08 Dec 2024 19:05:34 +0000",
          "body": "On Sun, 8 Dec 2024 at 10:11, Martin Uecker <muecker@gwdg.de> wrote:\n> >\n> > A lot of the 'macro business' for min/max is avoiding unexpected\n> > conversion of negative values to very large unsigned ones.\n> > And no, -Wsign-compare is spectacularly useless.\n>\n> This is a different topic, but what would be needed here?\n\nDan Carpenter actually wrote up some of the issues in:\n\n   https://staticthinking.wordpress.com/2023/07/25/wsign-compare-is-garbage=\n/\n\nbut the basic issue is that -Wsign-compare has over the years been\ntruly spectacularly bad.\n\nIt has literally started out from the completely nonsensical and\nincorrect assumption that the types of a comparison have to match in\nsignedness, and it shows in the name itself, but it also showed in\nearly implementations.\n\nThe very first versions of gcc that did -Wsign-compare literally\ncomplained about code like\n\n     sizeof(x) < 5\n\nbecause obviously one side is an unsigned 'size_t', and the other side\nis a signed 'int'. So comparing the two is clearly invalid, right?\n\nNo.\n\nIt's obviously *not* invalid, and any compiler that complains about\ndifferent signedness of that compare is just complete useless garbage.\nIt's literally checking two constants against each other, and the\nresult doesn't depend on the signedness or the silent C implicit type\nconversion.\n\nAnd no, gcc doesn't complain about that particular code any more.\n*That* particular problem was I think only visible in a gcc\npre-release that sadly did actually ship as part of a SUSE release, so\nwe saw it in the wild even if it was never in an official gcc release.\n\nI'm pointing out the history because it's relevant due to explaining\n*why* the whole concept of looking at just the type is so broken, and\nhow the whole background to the warning was broken from the very\nbeginning. The very name of the warning is a sign of the problem.\n\nBecause gcc still *does* complain about entirely valid code, where\n\"fixing\" the warning just means you have to write worse code.\n\nI think Dan's example from the link above is a good one: if\n\n        for (int i =3D 0; i < sizeof(x); i++)\n\ncauses a warning, the compiler got things entirely wrong.\n\nAnd yes, modern gcc very much warns about that:\n\n  t.c:4:27: warning: comparison of integer expressions of different\nsignedness: =E2=80=98int=E2=80=99 and =E2=80=98long unsigned int=E2=80=99 [=\n-Wsign-compare]\n      4 |         for (int i =3D 0; i < sizeof(b); i++)\n        |                           ^\n\nSo if you want a general-purpose \"Warn about dangerous comparisons\",\nyou need to get away from the mindset that it's about different signs.\n\nA compiler needs to do proper value range analysis before warning\nabout comparing said values. Not just mindlessly say \"different types\nbad\" like some marsupial that has been dropped on its head a few too\nmany times.\n\nEnd result: calling it \"Warn about sign compare\" is a disease. It\nshows a lack of understanding of how complex the warning logic needs\nto be.\n\nNow, I'm not claiming that our min/max type warnings are great either:\nthey *do* end up basically being the same silly \"just check signs, but\nat least don't complain about signed positive constants being used for\nunsigned comparisons\".\n\nSo our min/max macros most definitely are *not* doing that \"value\nrange analysis\" that I claim is required for a *general* comparison\nthing.\n\nBut our min//max macros aren't some general thing. They are very\nspecific, and so it's a lot easier to accept the not-great-analysis\nfor those specific cases where we then may have to change types\nexplicitly or do some other massaging to avoid the warning.\n\nPut another way: a warning that triggers on really basic C absolutely\n*must*not* have silly easily triggerable false positives for good and\nidiomatic source code.\n\nSuch a warning is worse than useless, and gets disabled.\n\nBut a warning that is overly restrictive and gives silly false\npositives can still be entirely acceptable when the context of that\nwarning is very limited.\n\nSo this is why in the kernel we disable '-Wsign-compare' in the\ngeneral case, but *do* basically manually then implement that very\nsame logic in the very _specific_ case of the min/max() macros.\n\nWhat is unacceptable nonsense in one case may be acceptable \"good\nenough\" in another. Life is not fair, I'm afraid.\n\n                Linus",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173373823900610.mbox",
          "message_id": "<87ldwpgorz.fsf () prevas ! dk>",
          "author_name": "Rasmus Villemoes",
          "author_email": "ravi () prevas ! dk",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-09 09:59:44+00:00",
          "date_str": "Mon, 09 Dec 2024 09:59:44 +0000",
          "body": "On Sat, Dec 07 2024, Linus Torvalds <torvalds@linux-foundation.org> wrote:\n\n> On Sat, 7 Dec 2024 at 04:24, Vincent Mailhol <vincent.mailhol@gmail.com> wrote:\n>>\n>> > No good - expands everything twice.\n>>\n>> And? __is_const_zero() does not evaluate its arguments, so no side effect:\n>\n> No, the problem is literally the expansion.\n>\n> Double expansion of these fundamental helpers gets exponential,\n> because they are used in various nested ways in other fundamental\n> helpers.\n>\n> That's why we then spent so much effort on trying to clean up the\n> min/max macros, because a single line of code would expand to\n> literally tens of megabytes of horrific expansions.\n>\n> And the problem with these things is that you can't make them inline\n> functions, so they have to be macros, and then you build up other\n> macros using them (like that \"clamp()\" macro), and it really gets\n> horrendous and affects the build time.\n>\n> And yes, it is very sad. Particularly since a compiler would have a\n> really easy time with some nice helper builtins.\n>\n> Of course, often the compiler *does* have helper builtins, but we\n> can't use them, because they aren't *quite* the right thing.\n\nOne thing I've been thinking about when all this comes up is: What if\nthe compilers gave us (and the same for _min):\n\n  __builtin_max(T, e1, e2, ...)\n  __builtin_max(e1, e2, ...)\n\nwith T being a type, e1... expressions, the latter being the former with\nT being the result of usual promotion on the types of the expressions,\nand the former having these semantics:\n\n(1) If all the expressions are ICE, so is the whole thing.\n\n(2) It's a compile-time error if the values of the expressions are not\n    guaranteed to fit in T (that also applies in case (1)), but this\n    should not be thrown by the front-end but only after optimizations\n    have had a chance.\n\n(3) Obviously: Every expression is evaluated exactly once and the result\n    is the maximum of those, of type T.\n\nFor (2), I'd expect trivial value-range analysis to allow something like\n\n  int x;\n\n  ...\n  if (x < 0)\n    bail;\n  size_t y = max(x, sizeof(foo));\n\nOf course, specifying exactly which optimizations one can rely on having\nbeen applied is impossible, but it's the same with our current\nBUILD_BUG_ON() - many of them would trigger at -O0.\n\nThen we could just have _one_ simple #define max __builtin_max , which\nwould work at file-scope, automatically have max3 etc. (because I'd\nimagine it would not be much harder for the compiler to just provide the\nvariadic version if it has code to compute the max of two already), and\nnone of the preprocessor issues would apply.\n\nDear Santa: Pretty please?\n\nRasmus\n\nFootnotes:\n\nThis is of course very kernel-centric. A compiler developer\ndoing this would probably have to think about \"what if floating point\ntypes are in the mix\". I wouldn't mind if that was just disallowed, but\nI can see how that might be a bit odd. I don't think it's hard to amend\nthe rules to that case - rule 2 could probably be used as-is, and (3)\ncould say \"if any expr are NaN, so is the whole thing\" (and if one cares\nwhich NaN, just the first among the expressions); inf values don't need\nspecial treatment wrt. min/max.\n\nWith my math hat on, I'd want the zero-expressions variant\n__builtin_max(int) to evaluate to INT_MIN ('cause that's the neutral\nelement for the binary max of two ints) and similarly for other types,\nbut it's probably better to just require at least two expressions.\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173382978032461.mbox",
          "message_id": "<87ldwpgorz.fsf () prevas ! dk>",
          "author_name": "Rasmus Villemoes",
          "author_email": "ravi () prevas ! dk",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-09 09:59:44+00:00",
          "date_str": "Mon, 09 Dec 2024 09:59:44 +0000",
          "body": "On Sat, Dec 07 2024, Linus Torvalds <torvalds@linux-foundation.org> wrote:\n\n> On Sat, 7 Dec 2024 at 04:24, Vincent Mailhol <vincent.mailhol@gmail.com> wrote:\n>>\n>> > No good - expands everything twice.\n>>\n>> And? __is_const_zero() does not evaluate its arguments, so no side effect:\n>\n> No, the problem is literally the expansion.\n>\n> Double expansion of these fundamental helpers gets exponential,\n> because they are used in various nested ways in other fundamental\n> helpers.\n>\n> That's why we then spent so much effort on trying to clean up the\n> min/max macros, because a single line of code would expand to\n> literally tens of megabytes of horrific expansions.\n>\n> And the problem with these things is that you can't make them inline\n> functions, so they have to be macros, and then you build up other\n> macros using them (like that \"clamp()\" macro), and it really gets\n> horrendous and affects the build time.\n>\n> And yes, it is very sad. Particularly since a compiler would have a\n> really easy time with some nice helper builtins.\n>\n> Of course, often the compiler *does* have helper builtins, but we\n> can't use them, because they aren't *quite* the right thing.\n\nOne thing I've been thinking about when all this comes up is: What if\nthe compilers gave us (and the same for _min):\n\n  __builtin_max(T, e1, e2, ...)\n  __builtin_max(e1, e2, ...)\n\nwith T being a type, e1... expressions, the latter being the former with\nT being the result of usual promotion on the types of the expressions,\nand the former having these semantics:\n\n(1) If all the expressions are ICE, so is the whole thing.\n\n(2) It's a compile-time error if the values of the expressions are not\n    guaranteed to fit in T (that also applies in case (1)), but this\n    should not be thrown by the front-end but only after optimizations\n    have had a chance.\n\n(3) Obviously: Every expression is evaluated exactly once and the result\n    is the maximum of those, of type T.\n\nFor (2), I'd expect trivial value-range analysis to allow something like\n\n  int x;\n\n  ...\n  if (x < 0)\n    bail;\n  size_t y = max(x, sizeof(foo));\n\nOf course, specifying exactly which optimizations one can rely on having\nbeen applied is impossible, but it's the same with our current\nBUILD_BUG_ON() - many of them would trigger at -O0.\n\nThen we could just have _one_ simple #define max __builtin_max , which\nwould work at file-scope, automatically have max3 etc. (because I'd\nimagine it would not be much harder for the compiler to just provide the\nvariadic version if it has code to compute the max of two already), and\nnone of the preprocessor issues would apply.\n\nDear Santa: Pretty please?\n\nRasmus\n\nFootnotes:\n\nThis is of course very kernel-centric. A compiler developer\ndoing this would probably have to think about \"what if floating point\ntypes are in the mix\". I wouldn't mind if that was just disallowed, but\nI can see how that might be a bit odd. I don't think it's hard to amend\nthe rules to that case - rule 2 could probably be used as-is, and (3)\ncould say \"if any expr are NaN, so is the whole thing\" (and if one cares\nwhich NaN, just the first among the expressions); inf values don't need\nspecial treatment wrt. min/max.\n\nWith my math hat on, I'd want the zero-expressions variant\n__builtin_max(int) to evaluate to INT_MIN ('cause that's the neutral\nelement for the binary max of two ints) and similarly for other types,\nbut it's probably better to just require at least two expressions.",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173373824200614.mbox",
          "message_id": "<87ldwpgorz.fsf () prevas ! dk>",
          "author_name": "Rasmus Villemoes",
          "author_email": "ravi () prevas ! dk",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-09 09:59:44+00:00",
          "date_str": "Mon, 09 Dec 2024 09:59:44 +0000",
          "body": "On Sat, Dec 07 2024, Linus Torvalds <torvalds@linux-foundation.org> wrote:\n\n> On Sat, 7 Dec 2024 at 04:24, Vincent Mailhol <vincent.mailhol@gmail.com> wrote:\n>>\n>> > No good - expands everything twice.\n>>\n>> And? __is_const_zero() does not evaluate its arguments, so no side effect:\n>\n> No, the problem is literally the expansion.\n>\n> Double expansion of these fundamental helpers gets exponential,\n> because they are used in various nested ways in other fundamental\n> helpers.\n>\n> That's why we then spent so much effort on trying to clean up the\n> min/max macros, because a single line of code would expand to\n> literally tens of megabytes of horrific expansions.\n>\n> And the problem with these things is that you can't make them inline\n> functions, so they have to be macros, and then you build up other\n> macros using them (like that \"clamp()\" macro), and it really gets\n> horrendous and affects the build time.\n>\n> And yes, it is very sad. Particularly since a compiler would have a\n> really easy time with some nice helper builtins.\n>\n> Of course, often the compiler *does* have helper builtins, but we\n> can't use them, because they aren't *quite* the right thing.\n\nOne thing I've been thinking about when all this comes up is: What if\nthe compilers gave us (and the same for _min):\n\n  __builtin_max(T, e1, e2, ...)\n  __builtin_max(e1, e2, ...)\n\nwith T being a type, e1... expressions, the latter being the former with\nT being the result of usual promotion on the types of the expressions,\nand the former having these semantics:\n\n(1) If all the expressions are ICE, so is the whole thing.\n\n(2) It's a compile-time error if the values of the expressions are not\n    guaranteed to fit in T (that also applies in case (1)), but this\n    should not be thrown by the front-end but only after optimizations\n    have had a chance.\n\n(3) Obviously: Every expression is evaluated exactly once and the result\n    is the maximum of those, of type T.\n\nFor (2), I'd expect trivial value-range analysis to allow something like\n\n  int x;\n\n  ...\n  if (x < 0)\n    bail;\n  size_t y = max(x, sizeof(foo));\n\nOf course, specifying exactly which optimizations one can rely on having\nbeen applied is impossible, but it's the same with our current\nBUILD_BUG_ON() - many of them would trigger at -O0.\n\nThen we could just have _one_ simple #define max __builtin_max , which\nwould work at file-scope, automatically have max3 etc. (because I'd\nimagine it would not be much harder for the compiler to just provide the\nvariadic version if it has code to compute the max of two already), and\nnone of the preprocessor issues would apply.\n\nDear Santa: Pretty please?\n\nRasmus\n\nFootnotes:\n\nThis is of course very kernel-centric. A compiler developer\ndoing this would probably have to think about \"what if floating point\ntypes are in the mix\". I wouldn't mind if that was just disallowed, but\nI can see how that might be a bit odd. I don't think it's hard to amend\nthe rules to that case - rule 2 could probably be used as-is, and (3)\ncould say \"if any expr are NaN, so is the whole thing\" (and if one cares\nwhich NaN, just the first among the expressions); inf values don't need\nspecial treatment wrt. min/max.\n\nWith my math hat on, I'd want the zero-expressions variant\n__builtin_max(int) to evaluate to INT_MIN ('cause that's the neutral\nelement for the binary max of two ints) and similarly for other types,\nbut it's probably better to just require at least two expressions.\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173373823900609.mbox",
          "message_id": "<87ldwpgorz.fsf () prevas ! dk>",
          "author_name": "Rasmus Villemoes",
          "author_email": "ravi () prevas ! dk",
          "subject": "Re: [PATCH 02/10] compiler.h: add is_const() as a replacement of __is_constexpr()",
          "date": "2024-12-09 09:59:44+00:00",
          "date_str": "Mon, 09 Dec 2024 09:59:44 +0000",
          "body": "On Sat, Dec 07 2024, Linus Torvalds <torvalds@linux-foundation.org> wrote:\n\n> On Sat, 7 Dec 2024 at 04:24, Vincent Mailhol <vincent.mailhol@gmail.com> wrote:\n>>\n>> > No good - expands everything twice.\n>>\n>> And? __is_const_zero() does not evaluate its arguments, so no side effect:\n>\n> No, the problem is literally the expansion.\n>\n> Double expansion of these fundamental helpers gets exponential,\n> because they are used in various nested ways in other fundamental\n> helpers.\n>\n> That's why we then spent so much effort on trying to clean up the\n> min/max macros, because a single line of code would expand to\n> literally tens of megabytes of horrific expansions.\n>\n> And the problem with these things is that you can't make them inline\n> functions, so they have to be macros, and then you build up other\n> macros using them (like that \"clamp()\" macro), and it really gets\n> horrendous and affects the build time.\n>\n> And yes, it is very sad. Particularly since a compiler would have a\n> really easy time with some nice helper builtins.\n>\n> Of course, often the compiler *does* have helper builtins, but we\n> can't use them, because they aren't *quite* the right thing.\n\nOne thing I've been thinking about when all this comes up is: What if\nthe compilers gave us (and the same for _min):\n\n  __builtin_max(T, e1, e2, ...)\n  __builtin_max(e1, e2, ...)\n\nwith T being a type, e1... expressions, the latter being the former with\nT being the result of usual promotion on the types of the expressions,\nand the former having these semantics:\n\n(1) If all the expressions are ICE, so is the whole thing.\n\n(2) It's a compile-time error if the values of the expressions are not\n    guaranteed to fit in T (that also applies in case (1)), but this\n    should not be thrown by the front-end but only after optimizations\n    have had a chance.\n\n(3) Obviously: Every expression is evaluated exactly once and the result\n    is the maximum of those, of type T.\n\nFor (2), I'd expect trivial value-range analysis to allow something like\n\n  int x;\n\n  ...\n  if (x < 0)\n    bail;\n  size_t y = max(x, sizeof(foo));\n\nOf course, specifying exactly which optimizations one can rely on having\nbeen applied is impossible, but it's the same with our current\nBUILD_BUG_ON() - many of them would trigger at -O0.\n\nThen we could just have _one_ simple #define max __builtin_max , which\nwould work at file-scope, automatically have max3 etc. (because I'd\nimagine it would not be much harder for the compiler to just provide the\nvariadic version if it has code to compute the max of two already), and\nnone of the preprocessor issues would apply.\n\nDear Santa: Pretty please?\n\nRasmus\n\nFootnotes:\n\nThis is of course very kernel-centric. A compiler developer\ndoing this would probably have to think about \"what if floating point\ntypes are in the mix\". I wouldn't mind if that was just disallowed, but\nI can see how that might be a bit odd. I don't think it's hard to amend\nthe rules to that case - rule 2 could probably be used as-is, and (3)\ncould say \"if any expr are NaN, so is the whole thing\" (and if one cares\nwhich NaN, just the first among the expressions); inf values don't need\nspecial treatment wrt. min/max.\n\nWith my math hat on, I'd want the zero-expressions variant\n__builtin_max(int) to evaluate to INT_MIN ('cause that's the neutral\nelement for the binary max of two ints) and similarly for other types,\nbut it's probably better to just require at least two expressions.\n",
          "year": "2024",
          "month": "12"
        }
      ],
      "primary_category": "sparse_internals"
    },
    {
      "subject": "Re: [PATCH 03/10] compiler.h: add is_const_true() and is_const_false()",
      "normalized_subject": "compiler.h: add is_const_true() and is_const_false()",
      "message_count": 1,
      "participants": [
        "Vincent Mailhol"
      ],
      "categories": [
        "compiler_compat",
        "sparse_internals",
        "type_system"
      ],
      "first_date": "2024-12-05T15:48:31+00:00",
      "last_date": "2024-12-05T15:48:31+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/12/173349188328801.mbox",
          "message_id": "<CAMZ6Rq+=-d0_v3Xqj0CpaPbNuzQuv1SouTkc3Ew5vc5Sb_DUng () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH 03/10] compiler.h: add is_const_true() and is_const_false()",
          "date": "2024-12-05 15:48:31+00:00",
          "date_str": "Thu, 05 Dec 2024 15:48:31 +0000",
          "body": "On Thu. 5 Dec 2024 at 03:48, David Laight <David.Laight@aculab.com> wrote:\n> From: Vincent Mailhol\n> > Sent: 02 December 2024 17:33\n> >\n> > __builtin_constant_p() is known for not always being able to produce\n> > constant expression [1] which led to the introduction of\n> > __is_constexpr() [2]. Because of its dependency on\n> > __builtin_constant_p(), statically_true() suffers from the same\n> > issues.\n>\n> No, they are testing different things.\n\nOK, I will remove this paragraph.\n\n> > For example:\n> >\n> >   void foo(int a)\n> >   {\n> >        /* fail on GCC */\n> >       BUILD_BUG_ON_ZERO(statically_true(a));\n> >\n> >        /* fail on both clang and GCC */\n> >       static char arr[statically_true(a) ? 1 : 2];\n> >   }\n> >\n> > Define a new is_const_true() and is_const_false() pair of macros\n> > which, by making use of __is_const_zero(), always produces a constant\n> > expression.\n> >\n> > Note that is_const_false() can not be directly defined as an alias to\n> > __is_const_zero(). Otherwise, it could yield some false positives on\n> > huge numbers because of a lost of precision when doing the (long) cast\n> > in __is_const_zero(). Example:\n> >\n> >   is_const_false((u128)ULONG_MAX << BITS_PER_LONG)\n> >\n> > Furthermore, using the ! operator like this:\n> >\n> >   #define is_const_true(x) __is_const_zero(!(x))\n> >   #define is_const_false(x) __is_const_zero(!!(x))\n> >\n> > would yield a -Wint-in-bool-context compiler warning if the argument\n> > is not a boolean. Use the =3D=3D and !=3D operators instead.\n> >\n> > It should be noted that statically_true/false() are the only ones\n> > capable of folding tautologic expressions in which at least one on the\n> > operands is not a constant expression. For example:\n> >\n> >   statically_true(true || var)\n> >   statically_true(var =3D=3D var)\n> >   statically_false(var * 0)\n> >   statically_false(var * 8 % 4)\n> >\n> > always evaluate to true, whereas all of these would be false under\n> > is_const_true/false() if var is not a constant expression [3].\n> >\n> > For this reason, usage of const_true/false() should be the exception.\n> > Reflect in the documentation that const_true() is less powerful and\n> > that statically_true() is the overall preferred solution.\n> >\n> > [1] __builtin_constant_p cannot resolve to const when optimizing\n> > Link: https://gcc.gnu.org/bugzilla/show_bug.cgi?id=3D19449\n> >\n> > [2] commit 3c8ba0d61d04 (\"kernel.h: Retain constant expression output f=\nor max()/min()\")\n> > Link: https://git.kernel.org/torvalds/c/3c8ba0d61d04\n> >\n> > [3] https://godbolt.org/z/E4r7EaxW9\n\nD'oh, I used some old versions of the macros in that link. The link\nwill be updated to this in v2:\n\n  https://godbolt.org/z/E4r7EaxW9\n\n> > Signed-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n> > ---\n> >  include/linux/compiler.h | 23 +++++++++++++++++++++++\n> >  1 file changed, 23 insertions(+)\n> >\n> > diff --git a/include/linux/compiler.h b/include/linux/compiler.h\n> > index 30ce06df4153cfdc0fad9bc7bffab9097f8b0450..165aa5b9bc484376087a130=\na1ac1f3edb50c983d 100644\n> > --- a/include/linux/compiler.h\n> > +++ b/include/linux/compiler.h\n> > @@ -357,6 +357,29 @@ static inline void *offset_to_ptr(const int *off)\n> >   */\n> >  #define is_const(x) __is_const_zero(0 * (x))\n> >\n> > +/*\n> > + * Similar to statically_true() but produces a constant expression\n>\n> No.\n> It tests whether a value is a 'constant integer expression' and\n> the result is a 'constant integer expression'.\n> statically_true() checks for the value being a 'compile time constant'.\n\nI still would argue that =E2=80=99constant integer expressions=E2=80=99 and=\n =E2=80=99compile\ntime constants=E2=80=99 are *similar*. Not the same, agreed, but not\ndrastically different either. I picked the term *similar* for that\nreason.\n\n> Most code really doesn't care, it all got added to min() so that\n> a very few places could do:\n>         char foo[min(16, sizeof (type))];\n> without triggering the 'variable length array' warning.\n> But that just bloated everywhere else and (IIRC) Linus replaced\n> them with a MIN() that was just an expression.\n\nWhat about:\n\n  Return an integer constant expression while evaluating if the\n  argument is a true (non zero) integer constant expression.\n\n\n\n> > + *\n> > + * To be used in conjunction with macros, such as BUILD_BUG_ON_ZERO(),\n> > + * which require their input to be a constant expression and for which\n> > + * statically_true() would otherwise fail.\n>\n> Use a different BUILD_BUG macro instead.\n> Look at the current definition of min().\n\nDo you mean BUILD_BUG_ON_MSG()? That one, at the end, relies on the\nerror attribute:\n\n  https://gcc.gnu.org/onlinedocs/gcc/Common-Function-Attributes.html#index-=\nerror-function-attribute\n\nAnd the error attribute logic relies on compiler optimization. So\nBUILD_BUG_ON_MSG() is not a valid example here because it does not\nrequire its argument to be an integer constant expression. It works\nwell with other compile time constants.\n\nAnother valid example would be _Static_assert() but as a ",
          "year": "2024",
          "month": "12"
        }
      ],
      "primary_category": "sparse_internals"
    },
    {
      "subject": "Re: [PATCH 00/10] compiler.h: refactor __is_constexpr() into is_const{, _true, _false}()",
      "normalized_subject": "compiler.h: refactor __is_constexpr() into is_const{, _true, _false}()",
      "message_count": 1,
      "participants": [
        "Vincent Mailhol"
      ],
      "categories": [
        "rfc_proposals",
        "compiler_compat"
      ],
      "first_date": "2024-12-05T15:21:35+00:00",
      "last_date": "2024-12-05T15:21:35+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/12/173347254315123.mbox",
          "message_id": "<CAMZ6RqLSiTfTNQrcje06MbSxvM2k16MgqG1YTCufe6j9FhupEw () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH 00/10] compiler.h: refactor __is_constexpr() into is_const{, _true, _false}()",
          "date": "2024-12-05 15:21:35+00:00",
          "date_str": "Thu, 05 Dec 2024 15:21:35 +0000",
          "body": "On Thu. 5 Dec. 2024 at 08:58, Kees Cook <kees@kernel.org> wrote:\n> On December 3, 2024 3:33:22 AM GMT+10:00, Vincent Mailhol via B4 Relay <devnull+mailhol.vincent.wanadoo.fr@kernel.org> wrote:\n> >This series is the spiritual successor of [1] which introduced\n> >const_true(). In [1], following a comment from David Laight, Linus\n> >came with a suggestion to simplify __is_constexpr() and its derived\n> >macros using a _Generic() selection. Because of the total change of\n> >scope, I am starting a new series.\n> >\n> >The goal is to introduce a set of three macros:\n> >\n> >  - is_const(): a one to one replacement of __is_constexpr() in term\n> >    of features but written in a less hacky way thanks to _Generic().\n> >\n> >  - is_const_true(): tells whether or not the argument is a true\n> >    integer constant expression.\n> >\n> >  - is_const_false(): tells whether or not the argument is a false\n> >    integer constant expression.\n>\n> But why make this change? Is something broken? Does it make builds faster?\n>\n> > 7 files changed, 97 insertions(+), 84 deletions(-)\n>\n> It makes the code larger too. I don't see what the benefit is, and given how much time has been spent making sure the existing stuff works correctly, I feel like we should have a clear benefit to replacing it all.\n\nIt makes the \"code\" larger because patch 3 (\"compiler.h: add\nis_const_true() and is_const_false()\") adds two new macros with 20\nlines of comments to explain the pros and cons. So the added \"code\" is\nonly comments. If you ignore the comments, you can see that I am\nactually removing a few lines of code.\n\nAs for the clear benefit, sorry, but I have nothing more to offer\nother than code simplification. The reason why a lot of time was spent\nto make __is_constexpr() work correctly is just a testimony of how\ncomplex the thing is. That alone can be a reason to simplify it, now\nthat new tools (_Generic()) are available.\n\nOf course, modifying __is_constexpr() is not strictly needed to\nintroduce the new is_const_expr(). My previous series:\n\n  https://lore.kernel.org/all/20241113172939.747686-4-mailhol.vincent@wanadoo.fr/\n\n did it that way. But I was rightfully pointed out for my macro being\nugly. Maybe I can suggest that you give a look to the above thread and\ntell me if you still disagree with David and Linus's comments after\nreading it?\n\n\nYours sincerely,\nVincent Mailhol",
          "year": "2024",
          "month": "12"
        }
      ],
      "primary_category": "rfc_proposals"
    },
    {
      "subject": "[PATCH] build_bug.h: more user friendly error messages in BUILD_BUG_ON_ZERO()",
      "normalized_subject": "build_bug.h: more user friendly error messages in BUILD_BUG_ON_ZERO()",
      "message_count": 14,
      "participants": [
        "Yury Norov",
        "Kees Cook",
        "Vincent Mailhol"
      ],
      "categories": [
        "rfc_proposals",
        "compiler_compat",
        "sparse_internals"
      ],
      "first_date": "2024-12-05T15:11:46+00:00",
      "last_date": "2025-04-14T21:55:03+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/12/173341150612123.mbox",
          "message_id": "<20241205151316.1480255-2-mailhol.vincent () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "[PATCH] build_bug.h: more user friendly error messages in BUILD_BUG_ON_ZERO()",
          "date": "2024-12-05 15:11:46+00:00",
          "date_str": "Thu, 05 Dec 2024 15:11:46 +0000",
          "body": "__BUILD_BUG_ON_ZERO_MSG(), as introduced in [1], makes it possible to\ndo a static assert while still returning a zero value. The direct\nbenefit is to provide a meaningful error message instead of the\ncryptic negative bitfield size error message currently returned by\nBUILD_BUG_ON_ZERO():\n\n  ./include/linux/build_bug.h:16:51: error: negative width in bit-field '<anonymous>'\n     16 | #define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n        |                                                   ^\n\nGet rid of BUILD_BUG_ON_ZERO() bitfield size hack. Instead rely on\n__BUILD_BUG_ON_ZERO_MSG() (which in turn relies on C11's\n_Static_assert()).\n\nUse some macro magic, similarly to static_assert(), to either use an\nerror message provided by the user or, when omitted, to produce a\ndefault error message by stringifying the tested expression. With\nthis, for example:\n\n  BUILD_BUG_ON_ZERO_MSG(1 > 0)\n\nwould now throw:\n\n  ./include/linux/compiler.h:245:62: error: static assertion failed: \"1 > 0 is true\"\n    245 | #define __BUILD_BUG_ON_ZERO_MSG(e, msg) ((int)sizeof(struct {_Static_assert(!(e), msg);}))\n        |                                                              ^~~~~~~~~~~~~~\n\nFinally, __BUILD_BUG_ON_ZERO_MSG() is already guarded by an:\n\n  #ifdef __CHECKER__\n\nSo no need any more for that guard clause for BUILD_BUG_ON_ZERO().\nRemove it.\n\n[1] commit d7a516c6eeae (\"compiler.h: Fix undefined BUILD_BUG_ON_ZERO()\")\nLink: https://git.kernel.org/torvalds/c/d7a516c6eeae\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\n include/linux/build_bug.h | 10 +++++-----\n 1 file changed, 5 insertions(+), 5 deletions(-)\n\ndiff --git a/include/linux/build_bug.h b/include/linux/build_bug.h\nindex 3aa3640f8c18..f4460a36f10f 100644\n--- a/include/linux/build_bug.h\n+++ b/include/linux/build_bug.h\n@@ -4,17 +4,17 @@\n \n #include <linux/compiler.h>\n \n-#ifdef __CHECKER__\n-#define BUILD_BUG_ON_ZERO(e) (0)\n-#else /* __CHECKER__ */\n /*\n  * Force a compilation error if condition is true, but also produce a\n  * result (of value 0 and type int), so the expression can be used\n  * e.g. in a structure initializer (or where-ever else comma expressions\n  * aren't permitted).\n+ *\n+ * Take a message as an optional second argument. If omitted, default to\n+ * the stringification of the tested expression.\n  */\n-#define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n-#endif /* __CHECKER__ */\n+#define BUILD_BUG_ON_ZERO(e, ...) __BUILD_BUG_ON_ZERO(e, ##__VA_ARGS__, #e)\n+#define __BUILD_BUG_ON_ZERO(e, msg) __BUILD_BUG_ON_ZERO_MSG(e, msg \" is true\")\n \n /* Force a compilation error if a constant expression is not a power of 2 */\n #define __BUILD_BUG_ON_NOT_POWER_OF_2(n)\t\\\n-- \n2.45.2\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2025/03/174318084625101.mbox",
          "message_id": "<20250329-build_bug-v2-1-1c831e5ddf89 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "[PATCH v2] build_bug.h: more user friendly error messages in BUILD_BUG_ON_ZERO()",
          "date": "2025-03-28 16:48:50+00:00",
          "date_str": "Fri, 28 Mar 2025 16:48:50 +0000",
          "body": "__BUILD_BUG_ON_ZERO_MSG(), as introduced in [1], makes it possible to\ndo a static assertions in expressions. The direct benefit is to\nprovide a meaningful error message instead of the cryptic negative\nbitfield size error message currently returned by BUILD_BUG_ON_ZERO():\n\n  ./include/linux/build_bug.h:16:51: error: negative width in bit-field '<anonymous>'\n     16 | #define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n        |                                                   ^\n\nGet rid of BUILD_BUG_ON_ZERO()'s bitfield size hack. Instead rely on\n__BUILD_BUG_ON_ZERO_MSG() which in turn relies on C11's\n_Static_assert().\n\nUse some macro magic, similarly to static_assert(), to either use an\noptional error message provided by the user or, when omitted, to\nproduce a default error message by stringifying the tested\nexpression. With this, for example:\n\n  BUILD_BUG_ON_ZERO(1 > 0)\n\nwould now throw:\n\n  ./include/linux/compiler.h:197:62: error: static assertion failed: \"1 > 0 is true\"\n    197 | define __BUILD_BUG_ON_ZERO_MSG(e, msg) ((int)sizeof(struct {_Static_assert(!(e), msg);}))\n        |                                                             ^~~~~~~~~~~~~~\n\nFinally, __BUILD_BUG_ON_ZERO_MSG() is already guarded by an:\n\n  #ifdef __CHECKER__\n\nSo no need any more for that guard clause for BUILD_BUG_ON_ZERO().\nRemove it.\n\n[1] commit d7a516c6eeae (\"compiler.h: Fix undefined BUILD_BUG_ON_ZERO()\")\nLink: https://git.kernel.org/torvalds/c/d7a516c6eeae\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\n** Prerequisite **\n\nThis patch depends on:\n\n  commit b88937277df (\"drm/i915: Convert REG_GENMASK*() to fixed-width GENMASK_U*()\")\n  Link: https://git.kernel.org/next/linux-next/c/b88937277df\n\nChangelog:\n\n  v1 -> v2:\n\n    - The patch caused an issue because of a conflict in drm/i915:\n\n      Link: https://lore.kernel.org/all/202412080849.sPp82jSi-lkp@intel.com/\n\n      Above conflict is indirectly resolved by commit b88937277df\n      (c.f. above prerequisite).\n\n      Now that the conflict is resolved, resend the patch.\n\n    - Remove the intermediary __BUILD_BUG_ON_ZERO() macro, instead,\n      make __BUILD_BUG_ON_ZERO_MSG() variadic.\n\n  Link to v1: https://lore.kernel.org/all/20241205151316.1480255-2-mailhol.vincent@wanadoo.fr/\n---\n include/linux/build_bug.h | 10 +++++-----\n include/linux/compiler.h  |  4 ++--\n 2 files changed, 7 insertions(+), 7 deletions(-)\n\ndiff --git a/include/linux/build_bug.h b/include/linux/build_bug.h\nindex 3aa3640f8c181f6a54bacffbc43260b57481e67f..2cfbb4c65c784ad82edd1e45c1b4f4c23e78b009 100644\n--- a/include/linux/build_bug.h\n+++ b/include/linux/build_bug.h\n@@ -4,17 +4,17 @@\n \n #include <linux/compiler.h>\n \n-#ifdef __CHECKER__\n-#define BUILD_BUG_ON_ZERO(e) (0)\n-#else /* __CHECKER__ */\n /*\n  * Force a compilation error if condition is true, but also produce a\n  * result (of value 0 and type int), so the expression can be used\n  * e.g. in a structure initializer (or where-ever else comma expressions\n  * aren't permitted).\n+ *\n+ * Take an error message as an optional second argument. If omitted,\n+ * default to the stringification of the tested expression.\n  */\n-#define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n-#endif /* __CHECKER__ */\n+#define BUILD_BUG_ON_ZERO(e, ...) \\\n+\t__BUILD_BUG_ON_ZERO_MSG(e, ##__VA_ARGS__, #e \" is true\")\n \n /* Force a compilation error if a constant expression is not a power of 2 */\n #define __BUILD_BUG_ON_NOT_POWER_OF_2(n)\t\\\ndiff --git a/include/linux/compiler.h b/include/linux/compiler.h\nindex 9fc30b6b80c9ef8e53a89f53c16ebbe84e40eedb..48793a7822daad99b27324848d585e3cd9893e71 100644\n--- a/include/linux/compiler.h\n+++ b/include/linux/compiler.h\n@@ -192,9 +192,9 @@ void ftrace_likely_update(struct ftrace_likely_data *f, int val,\n })\n \n #ifdef __CHECKER__\n-#define __BUILD_BUG_ON_ZERO_MSG(e, msg) (0)\n+#define __BUILD_BUG_ON_ZERO_MSG(e, msg, ...) (0)\n #else /* __CHECKER__ */\n-#define __BUILD_BUG_ON_ZERO_MSG(e, msg) ((int)sizeof(struct {_Static_assert(!(e), msg);}))\n+#define __BUILD_BUG_ON_ZERO_MSG(e, msg, ...) ((int)sizeof(struct {_Static_assert(!(e), msg);}))\n #endif /* __CHECKER__ */\n \n /* &a[0] degrades to a pointer: a different type from an array */\n\n---\nbase-commit: de305063001d5624138a452bdb2d56e68dc2301c\nchange-id: 20250327-build_bug-a55c1812ce51\n\nBest regards,\n-- \nVincent Mailhol <mailhol.vincent@wanadoo.fr>\n\n",
          "year": "2025",
          "month": "03"
        },
        {
          "filepath": "emails/2025/04/174318084625100.mbox",
          "message_id": "<20250329-build_bug-v2-1-1c831e5ddf89 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "[PATCH v2] build_bug.h: more user friendly error messages in BUILD_BUG_ON_ZERO()",
          "date": "2025-03-28 16:48:50+00:00",
          "date_str": "Fri, 28 Mar 2025 16:48:50 +0000",
          "body": "__BUILD_BUG_ON_ZERO_MSG(), as introduced in [1], makes it possible to\ndo a static assertions in expressions. The direct benefit is to\nprovide a meaningful error message instead of the cryptic negative\nbitfield size error message currently returned by BUILD_BUG_ON_ZERO():\n\n  ./include/linux/build_bug.h:16:51: error: negative width in bit-field '<anonymous>'\n     16 | #define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n        |                                                   ^\n\nGet rid of BUILD_BUG_ON_ZERO()'s bitfield size hack. Instead rely on\n__BUILD_BUG_ON_ZERO_MSG() which in turn relies on C11's\n_Static_assert().\n\nUse some macro magic, similarly to static_assert(), to either use an\noptional error message provided by the user or, when omitted, to\nproduce a default error message by stringifying the tested\nexpression. With this, for example:\n\n  BUILD_BUG_ON_ZERO(1 > 0)\n\nwould now throw:\n\n  ./include/linux/compiler.h:197:62: error: static assertion failed: \"1 > 0 is true\"\n    197 | define __BUILD_BUG_ON_ZERO_MSG(e, msg) ((int)sizeof(struct {_Static_assert(!(e), msg);}))\n        |                                                             ^~~~~~~~~~~~~~\n\nFinally, __BUILD_BUG_ON_ZERO_MSG() is already guarded by an:\n\n  #ifdef __CHECKER__\n\nSo no need any more for that guard clause for BUILD_BUG_ON_ZERO().\nRemove it.\n\n[1] commit d7a516c6eeae (\"compiler.h: Fix undefined BUILD_BUG_ON_ZERO()\")\nLink: https://git.kernel.org/torvalds/c/d7a516c6eeae\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\n** Prerequisite **\n\nThis patch depends on:\n\n  commit b88937277df (\"drm/i915: Convert REG_GENMASK*() to fixed-width GENMASK_U*()\")\n  Link: https://git.kernel.org/next/linux-next/c/b88937277df\n\nChangelog:\n\n  v1 -> v2:\n\n    - The patch caused an issue because of a conflict in drm/i915:\n\n      Link: https://lore.kernel.org/all/202412080849.sPp82jSi-lkp@intel.com/\n\n      Above conflict is indirectly resolved by commit b88937277df\n      (c.f. above prerequisite).\n\n      Now that the conflict is resolved, resend the patch.\n\n    - Remove the intermediary __BUILD_BUG_ON_ZERO() macro, instead,\n      make __BUILD_BUG_ON_ZERO_MSG() variadic.\n\n  Link to v1: https://lore.kernel.org/all/20241205151316.1480255-2-mailhol.vincent@wanadoo.fr/\n---\n include/linux/build_bug.h | 10 +++++-----\n include/linux/compiler.h  |  4 ++--\n 2 files changed, 7 insertions(+), 7 deletions(-)\n\ndiff --git a/include/linux/build_bug.h b/include/linux/build_bug.h\nindex 3aa3640f8c181f6a54bacffbc43260b57481e67f..2cfbb4c65c784ad82edd1e45c1b4f4c23e78b009 100644\n--- a/include/linux/build_bug.h\n+++ b/include/linux/build_bug.h\n@@ -4,17 +4,17 @@\n \n #include <linux/compiler.h>\n \n-#ifdef __CHECKER__\n-#define BUILD_BUG_ON_ZERO(e) (0)\n-#else /* __CHECKER__ */\n /*\n  * Force a compilation error if condition is true, but also produce a\n  * result (of value 0 and type int), so the expression can be used\n  * e.g. in a structure initializer (or where-ever else comma expressions\n  * aren't permitted).\n+ *\n+ * Take an error message as an optional second argument. If omitted,\n+ * default to the stringification of the tested expression.\n  */\n-#define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n-#endif /* __CHECKER__ */\n+#define BUILD_BUG_ON_ZERO(e, ...) \\\n+\t__BUILD_BUG_ON_ZERO_MSG(e, ##__VA_ARGS__, #e \" is true\")\n \n /* Force a compilation error if a constant expression is not a power of 2 */\n #define __BUILD_BUG_ON_NOT_POWER_OF_2(n)\t\\\ndiff --git a/include/linux/compiler.h b/include/linux/compiler.h\nindex 9fc30b6b80c9ef8e53a89f53c16ebbe84e40eedb..48793a7822daad99b27324848d585e3cd9893e71 100644\n--- a/include/linux/compiler.h\n+++ b/include/linux/compiler.h\n@@ -192,9 +192,9 @@ void ftrace_likely_update(struct ftrace_likely_data *f, int val,\n })\n \n #ifdef __CHECKER__\n-#define __BUILD_BUG_ON_ZERO_MSG(e, msg) (0)\n+#define __BUILD_BUG_ON_ZERO_MSG(e, msg, ...) (0)\n #else /* __CHECKER__ */\n-#define __BUILD_BUG_ON_ZERO_MSG(e, msg) ((int)sizeof(struct {_Static_assert(!(e), msg);}))\n+#define __BUILD_BUG_ON_ZERO_MSG(e, msg, ...) ((int)sizeof(struct {_Static_assert(!(e), msg);}))\n #endif /* __CHECKER__ */\n \n /* &a[0] degrades to a pointer: a different type from an array */\n\n---\nbase-commit: de305063001d5624138a452bdb2d56e68dc2301c\nchange-id: 20250327-build_bug-a55c1812ce51\n\nBest regards,\n-- \nVincent Mailhol <mailhol.vincent@wanadoo.fr>\n\n",
          "year": "2025",
          "month": "04"
        },
        {
          "filepath": "emails/2025/04/174318084625101.mbox",
          "message_id": "<20250329-build_bug-v2-1-1c831e5ddf89 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "[PATCH v2] build_bug.h: more user friendly error messages in BUILD_BUG_ON_ZERO()",
          "date": "2025-03-28 16:48:50+00:00",
          "date_str": "Fri, 28 Mar 2025 16:48:50 +0000",
          "body": "__BUILD_BUG_ON_ZERO_MSG(), as introduced in [1], makes it possible to\ndo a static assertions in expressions. The direct benefit is to\nprovide a meaningful error message instead of the cryptic negative\nbitfield size error message currently returned by BUILD_BUG_ON_ZERO():\n\n  ./include/linux/build_bug.h:16:51: error: negative width in bit-field '<anonymous>'\n     16 | #define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n        |                                                   ^\n\nGet rid of BUILD_BUG_ON_ZERO()'s bitfield size hack. Instead rely on\n__BUILD_BUG_ON_ZERO_MSG() which in turn relies on C11's\n_Static_assert().\n\nUse some macro magic, similarly to static_assert(), to either use an\noptional error message provided by the user or, when omitted, to\nproduce a default error message by stringifying the tested\nexpression. With this, for example:\n\n  BUILD_BUG_ON_ZERO(1 > 0)\n\nwould now throw:\n\n  ./include/linux/compiler.h:197:62: error: static assertion failed: \"1 > 0 is true\"\n    197 | define __BUILD_BUG_ON_ZERO_MSG(e, msg) ((int)sizeof(struct {_Static_assert(!(e), msg);}))\n        |                                                             ^~~~~~~~~~~~~~\n\nFinally, __BUILD_BUG_ON_ZERO_MSG() is already guarded by an:\n\n  #ifdef __CHECKER__\n\nSo no need any more for that guard clause for BUILD_BUG_ON_ZERO().\nRemove it.\n\n[1] commit d7a516c6eeae (\"compiler.h: Fix undefined BUILD_BUG_ON_ZERO()\")\nLink: https://git.kernel.org/torvalds/c/d7a516c6eeae\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\n** Prerequisite **\n\nThis patch depends on:\n\n  commit b88937277df (\"drm/i915: Convert REG_GENMASK*() to fixed-width GENMASK_U*()\")\n  Link: https://git.kernel.org/next/linux-next/c/b88937277df\n\nChangelog:\n\n  v1 -> v2:\n\n    - The patch caused an issue because of a conflict in drm/i915:\n\n      Link: https://lore.kernel.org/all/202412080849.sPp82jSi-lkp@intel.com/\n\n      Above conflict is indirectly resolved by commit b88937277df\n      (c.f. above prerequisite).\n\n      Now that the conflict is resolved, resend the patch.\n\n    - Remove the intermediary __BUILD_BUG_ON_ZERO() macro, instead,\n      make __BUILD_BUG_ON_ZERO_MSG() variadic.\n\n  Link to v1: https://lore.kernel.org/all/20241205151316.1480255-2-mailhol.vincent@wanadoo.fr/\n---\n include/linux/build_bug.h | 10 +++++-----\n include/linux/compiler.h  |  4 ++--\n 2 files changed, 7 insertions(+), 7 deletions(-)\n\ndiff --git a/include/linux/build_bug.h b/include/linux/build_bug.h\nindex 3aa3640f8c181f6a54bacffbc43260b57481e67f..2cfbb4c65c784ad82edd1e45c1b4f4c23e78b009 100644\n--- a/include/linux/build_bug.h\n+++ b/include/linux/build_bug.h\n@@ -4,17 +4,17 @@\n \n #include <linux/compiler.h>\n \n-#ifdef __CHECKER__\n-#define BUILD_BUG_ON_ZERO(e) (0)\n-#else /* __CHECKER__ */\n /*\n  * Force a compilation error if condition is true, but also produce a\n  * result (of value 0 and type int), so the expression can be used\n  * e.g. in a structure initializer (or where-ever else comma expressions\n  * aren't permitted).\n+ *\n+ * Take an error message as an optional second argument. If omitted,\n+ * default to the stringification of the tested expression.\n  */\n-#define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n-#endif /* __CHECKER__ */\n+#define BUILD_BUG_ON_ZERO(e, ...) \\\n+\t__BUILD_BUG_ON_ZERO_MSG(e, ##__VA_ARGS__, #e \" is true\")\n \n /* Force a compilation error if a constant expression is not a power of 2 */\n #define __BUILD_BUG_ON_NOT_POWER_OF_2(n)\t\\\ndiff --git a/include/linux/compiler.h b/include/linux/compiler.h\nindex 9fc30b6b80c9ef8e53a89f53c16ebbe84e40eedb..48793a7822daad99b27324848d585e3cd9893e71 100644\n--- a/include/linux/compiler.h\n+++ b/include/linux/compiler.h\n@@ -192,9 +192,9 @@ void ftrace_likely_update(struct ftrace_likely_data *f, int val,\n })\n \n #ifdef __CHECKER__\n-#define __BUILD_BUG_ON_ZERO_MSG(e, msg) (0)\n+#define __BUILD_BUG_ON_ZERO_MSG(e, msg, ...) (0)\n #else /* __CHECKER__ */\n-#define __BUILD_BUG_ON_ZERO_MSG(e, msg) ((int)sizeof(struct {_Static_assert(!(e), msg);}))\n+#define __BUILD_BUG_ON_ZERO_MSG(e, msg, ...) ((int)sizeof(struct {_Static_assert(!(e), msg);}))\n #endif /* __CHECKER__ */\n \n /* &a[0] degrades to a pointer: a different type from an array */\n\n---\nbase-commit: de305063001d5624138a452bdb2d56e68dc2301c\nchange-id: 20250327-build_bug-a55c1812ce51\n\nBest regards,\n-- \nVincent Mailhol <mailhol.vincent@wanadoo.fr>\n\n",
          "year": "2025",
          "month": "04"
        },
        {
          "filepath": "emails/2025/04/174404435717202.mbox",
          "message_id": "<202504070945.BAC93C0 () keescook>",
          "author_name": "Kees Cook",
          "author_email": "kees () kernel ! org",
          "subject": "Re: [PATCH v2] build_bug.h: more user friendly error messages in BUILD_BUG_ON_ZERO()",
          "date": "2025-04-07 16:46:39+00:00",
          "date_str": "Mon, 07 Apr 2025 16:46:39 +0000",
          "body": "On Sat, Mar 29, 2025 at 01:48:50AM +0900, Vincent Mailhol wrote:\n> __BUILD_BUG_ON_ZERO_MSG(), as introduced in [1], makes it possible to\n> do a static assertions in expressions. The direct benefit is to\n> provide a meaningful error message instead of the cryptic negative\n> bitfield size error message currently returned by BUILD_BUG_ON_ZERO():\n> \n>   ./include/linux/build_bug.h:16:51: error: negative width in bit-field '<anonymous>'\n>      16 | #define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n>         |                                                   ^\n> \n> Get rid of BUILD_BUG_ON_ZERO()'s bitfield size hack. Instead rely on\n> __BUILD_BUG_ON_ZERO_MSG() which in turn relies on C11's\n> _Static_assert().\n> \n> Use some macro magic, similarly to static_assert(), to either use an\n> optional error message provided by the user or, when omitted, to\n> produce a default error message by stringifying the tested\n> expression. With this, for example:\n> \n>   BUILD_BUG_ON_ZERO(1 > 0)\n> \n> would now throw:\n> \n>   ./include/linux/compiler.h:197:62: error: static assertion failed: \"1 > 0 is true\"\n\nThis is so much easier to read! Thanks for this. :)\n\nIf no one else snags it, I can take this via the hardening tree for\n-next once -rc2 is released.\n\n-- \nKees Cook\n",
          "year": "2025",
          "month": "04"
        },
        {
          "filepath": "emails/2025/04/174404408216769.mbox",
          "message_id": "<202504070945.BAC93C0 () keescook>",
          "author_name": "Kees Cook",
          "author_email": "kees () kernel ! org",
          "subject": "Re: [PATCH v2] build_bug.h: more user friendly error messages in BUILD_BUG_ON_ZERO()",
          "date": "2025-04-07 16:46:39+00:00",
          "date_str": "Mon, 07 Apr 2025 16:46:39 +0000",
          "body": "On Sat, Mar 29, 2025 at 01:48:50AM +0900, Vincent Mailhol wrote:\n> __BUILD_BUG_ON_ZERO_MSG(), as introduced in [1], makes it possible to\n> do a static assertions in expressions. The direct benefit is to\n> provide a meaningful error message instead of the cryptic negative\n> bitfield size error message currently returned by BUILD_BUG_ON_ZERO():\n> \n>   ./include/linux/build_bug.h:16:51: error: negative width in bit-field '<anonymous>'\n>      16 | #define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n>         |                                                   ^\n> \n> Get rid of BUILD_BUG_ON_ZERO()'s bitfield size hack. Instead rely on\n> __BUILD_BUG_ON_ZERO_MSG() which in turn relies on C11's\n> _Static_assert().\n> \n> Use some macro magic, similarly to static_assert(), to either use an\n> optional error message provided by the user or, when omitted, to\n> produce a default error message by stringifying the tested\n> expression. With this, for example:\n> \n>   BUILD_BUG_ON_ZERO(1 > 0)\n> \n> would now throw:\n> \n>   ./include/linux/compiler.h:197:62: error: static assertion failed: \"1 > 0 is true\"\n\nThis is so much easier to read! Thanks for this. :)\n\nIf no one else snags it, I can take this via the hardening tree for\n-next once -rc2 is released.\n\n-- \nKees Cook\n",
          "year": "2025",
          "month": "04"
        },
        {
          "filepath": "emails/2025/04/174411868800543.mbox",
          "message_id": "<9dc6f94e-c739-4fdf-8e43-4386d35e02e5 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH v2] build_bug.h: more user friendly error messages in BUILD_BUG_ON_ZERO()",
          "date": "2025-04-08 13:23:53+00:00",
          "date_str": "Tue, 08 Apr 2025 13:23:53 +0000",
          "body": "On 08/04/2025 at 01:46, Kees Cook wrote:\n> On Sat, Mar 29, 2025 at 01:48:50AM +0900, Vincent Mailhol wrote:\n>> __BUILD_BUG_ON_ZERO_MSG(), as introduced in [1], makes it possible to\n>> do a static assertions in expressions. The direct benefit is to\n>> provide a meaningful error message instead of the cryptic negative\n>> bitfield size error message currently returned by BUILD_BUG_ON_ZERO():\n>>\n>>   ./include/linux/build_bug.h:16:51: error: negative width in bit-field '<anonymous>'\n>>      16 | #define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n>>         |                                                   ^\n>>\n>> Get rid of BUILD_BUG_ON_ZERO()'s bitfield size hack. Instead rely on\n>> __BUILD_BUG_ON_ZERO_MSG() which in turn relies on C11's\n>> _Static_assert().\n>>\n>> Use some macro magic, similarly to static_assert(), to either use an\n>> optional error message provided by the user or, when omitted, to\n>> produce a default error message by stringifying the tested\n>> expression. With this, for example:\n>>\n>>   BUILD_BUG_ON_ZERO(1 > 0)\n>>\n>> would now throw:\n>>\n>>   ./include/linux/compiler.h:197:62: error: static assertion failed: \"1 > 0 is true\"\n> \n> This is so much easier to read! Thanks for this. :)\n> \n> If no one else snags it, I can take this via the hardening tree for\n> -next once -rc2 is released.\n\nI discussed about this with Andrew by DM.\n\nAndrew can pick it up but for the next-next release. That is to say,\nwait for [1] to be merged in v6.16 and then take it to target the v6.17\nmerge windows.\n\nIf you can take it in your hardening-next tree and have it merged in\nv6.16, then this is convenient for me.\n\nJust make sure that you send it to Linus after Yury's bitmap-for-next\nget merged: https://github.com/norov/linux/commits/bitmap-for-next/\n\nUsually, bitmap changes are merged at the very beginning of the merge\nwindow so that should be OK.\n\n\n[1] commit b88937277df (\"drm/i915: Convert REG_GENMASK*() to fixed-width\nGENMASK_U*()\")\nLink: https://git.kernel.org/next/linux-next/c/b88937277df\n\nYours sincerely,\nVincent Mailhol\n\n",
          "year": "2025",
          "month": "04"
        },
        {
          "filepath": "emails/2025/04/174413866117354.mbox",
          "message_id": "<202504081202.7CA5DBE () keescook>",
          "author_name": "Kees Cook",
          "author_email": "kees () kernel ! org",
          "subject": "Re: [PATCH v2] build_bug.h: more user friendly error messages in BUILD_BUG_ON_ZERO()",
          "date": "2025-04-08 18:57:41+00:00",
          "date_str": "Tue, 08 Apr 2025 18:57:41 +0000",
          "body": "On Tue, Apr 08, 2025 at 10:23:53PM +0900, Vincent Mailhol wrote:\n> On 08/04/2025 at 01:46, Kees Cook wrote:\n> > On Sat, Mar 29, 2025 at 01:48:50AM +0900, Vincent Mailhol wrote:\n> >> __BUILD_BUG_ON_ZERO_MSG(), as introduced in [1], makes it possible to\n> >> do a static assertions in expressions. The direct benefit is to\n> >> provide a meaningful error message instead of the cryptic negative\n> >> bitfield size error message currently returned by BUILD_BUG_ON_ZERO():\n> >>\n> >>   ./include/linux/build_bug.h:16:51: error: negative width in bit-field '<anonymous>'\n> >>      16 | #define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n> >>         |                                                   ^\n> >>\n> >> Get rid of BUILD_BUG_ON_ZERO()'s bitfield size hack. Instead rely on\n> >> __BUILD_BUG_ON_ZERO_MSG() which in turn relies on C11's\n> >> _Static_assert().\n> >>\n> >> Use some macro magic, similarly to static_assert(), to either use an\n> >> optional error message provided by the user or, when omitted, to\n> >> produce a default error message by stringifying the tested\n> >> expression. With this, for example:\n> >>\n> >>   BUILD_BUG_ON_ZERO(1 > 0)\n> >>\n> >> would now throw:\n> >>\n> >>   ./include/linux/compiler.h:197:62: error: static assertion failed: \"1 > 0 is true\"\n> > \n> > This is so much easier to read! Thanks for this. :)\n> > \n> > If no one else snags it, I can take this via the hardening tree for\n> > -next once -rc2 is released.\n> \n> I discussed about this with Andrew by DM.\n> \n> Andrew can pick it up but for the next-next release. That is to say,\n> wait for [1] to be merged in v6.16 and then take it to target the v6.17\n> merge windows.\n> \n> If you can take it in your hardening-next tree and have it merged in\n> v6.16, then this is convenient for me.\n> \n> Just make sure that you send it to Linus after Yury's bitmap-for-next\n> get merged: https://github.com/norov/linux/commits/bitmap-for-next/\n\nCould this land via Yury's tree?\n\n-- \nKees Cook\n",
          "year": "2025",
          "month": "04"
        },
        {
          "filepath": "emails/2025/04/174413872617369.mbox",
          "message_id": "<202504081202.7CA5DBE () keescook>",
          "author_name": "Kees Cook",
          "author_email": "kees () kernel ! org",
          "subject": "Re: [PATCH v2] build_bug.h: more user friendly error messages in BUILD_BUG_ON_ZERO()",
          "date": "2025-04-08 18:58:46+00:00",
          "date_str": "Tue, 08 Apr 2025 18:58:46 +0000",
          "body": "On Tue, Apr 08, 2025 at 10:23:53PM +0900, Vincent Mailhol wrote:\n> On 08/04/2025 at 01:46, Kees Cook wrote:\n> > On Sat, Mar 29, 2025 at 01:48:50AM +0900, Vincent Mailhol wrote:\n> >> __BUILD_BUG_ON_ZERO_MSG(), as introduced in [1], makes it possible to\n> >> do a static assertions in expressions. The direct benefit is to\n> >> provide a meaningful error message instead of the cryptic negative\n> >> bitfield size error message currently returned by BUILD_BUG_ON_ZERO():\n> >>\n> >>   ./include/linux/build_bug.h:16:51: error: negative width in bit-field '<anonymous>'\n> >>      16 | #define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n> >>         |                                                   ^\n> >>\n> >> Get rid of BUILD_BUG_ON_ZERO()'s bitfield size hack. Instead rely on\n> >> __BUILD_BUG_ON_ZERO_MSG() which in turn relies on C11's\n> >> _Static_assert().\n> >>\n> >> Use some macro magic, similarly to static_assert(), to either use an\n> >> optional error message provided by the user or, when omitted, to\n> >> produce a default error message by stringifying the tested\n> >> expression. With this, for example:\n> >>\n> >>   BUILD_BUG_ON_ZERO(1 > 0)\n> >>\n> >> would now throw:\n> >>\n> >>   ./include/linux/compiler.h:197:62: error: static assertion failed: \"1 > 0 is true\"\n> > \n> > This is so much easier to read! Thanks for this. :)\n> > \n> > If no one else snags it, I can take this via the hardening tree for\n> > -next once -rc2 is released.\n> \n> I discussed about this with Andrew by DM.\n> \n> Andrew can pick it up but for the next-next release. That is to say,\n> wait for [1] to be merged in v6.16 and then take it to target the v6.17\n> merge windows.\n> \n> If you can take it in your hardening-next tree and have it merged in\n> v6.16, then this is convenient for me.\n> \n> Just make sure that you send it to Linus after Yury's bitmap-for-next\n> get merged: https://github.com/norov/linux/commits/bitmap-for-next/\n\nCould this land via Yury's tree?\n\n-- \nKees Cook\n",
          "year": "2025",
          "month": "04"
        },
        {
          "filepath": "emails/2025/04/174420193318401.mbox",
          "message_id": "<4c01c2a6-5271-41e4-8013-836e59aeae6d () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH v2] build_bug.h: more user friendly error messages in BUILD_BUG_ON_ZERO()",
          "date": "2025-04-09 12:26:41+00:00",
          "date_str": "Wed, 09 Apr 2025 12:26:41 +0000",
          "body": "+To: Yury Norov\n\nOn 09/04/2025 at 04:03, Kees Cook wrote:\n> On Tue, Apr 08, 2025 at 10:23:53PM +0900, Vincent Mailhol wrote:\n>> On 08/04/2025 at 01:46, Kees Cook wrote:\n>>> On Sat, Mar 29, 2025 at 01:48:50AM +0900, Vincent Mailhol wrote:\n>>>> __BUILD_BUG_ON_ZERO_MSG(), as introduced in [1], makes it possible to\n>>>> do a static assertions in expressions. The direct benefit is to\n>>>> provide a meaningful error message instead of the cryptic negative\n>>>> bitfield size error message currently returned by BUILD_BUG_ON_ZERO():\n>>>>\n>>>>   ./include/linux/build_bug.h:16:51: error: negative width in bit-field '<anonymous>'\n>>>>      16 | #define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n>>>>         |                                                   ^\n>>>>\n>>>> Get rid of BUILD_BUG_ON_ZERO()'s bitfield size hack. Instead rely on\n>>>> __BUILD_BUG_ON_ZERO_MSG() which in turn relies on C11's\n>>>> _Static_assert().\n>>>>\n>>>> Use some macro magic, similarly to static_assert(), to either use an\n>>>> optional error message provided by the user or, when omitted, to\n>>>> produce a default error message by stringifying the tested\n>>>> expression. With this, for example:\n>>>>\n>>>>   BUILD_BUG_ON_ZERO(1 > 0)\n>>>>\n>>>> would now throw:\n>>>>\n>>>>   ./include/linux/compiler.h:197:62: error: static assertion failed: \"1 > 0 is true\"\n>>>\n>>> This is so much easier to read! Thanks for this. :)\n>>>\n>>> If no one else snags it, I can take this via the hardening tree for\n>>> -next once -rc2 is released.\n>>\n>> I discussed about this with Andrew by DM.\n>>\n>> Andrew can pick it up but for the next-next release. That is to say,\n>> wait for [1] to be merged in v6.16 and then take it to target the v6.17\n>> merge windows.\n>>\n>> If you can take it in your hardening-next tree and have it merged in\n>> v6.16, then this is convenient for me.\n>>\n>> Just make sure that you send it to Linus after Yury's bitmap-for-next\n>> get merged: https://github.com/norov/linux/commits/bitmap-for-next/\n> \n> Could this land via Yury's tree?\n\nHi Yury,\n\nI have this patch:\n\nhttps://lore.kernel.org/all/20250329-build_bug-v2-1-1c831e5ddf89@wanadoo.fr/\n\nwhich depends on commit b88937277df (\"drm/i915: Convert REG_GENMASK*()\nto fixed-width GENMASK_U*()\") in your bitmap-for-next tree.\n\nI discussed this with Andrew (by DM) and Kees. Because of the\ndependency, it would be convenient if this patch went through your tree.\n\nWhat do you think?\n\n\nYours sincerely,\nVincent Mailhol\n\n",
          "year": "2025",
          "month": "04"
        },
        {
          "filepath": "emails/2025/04/174420798622748.mbox",
          "message_id": "<Z_aBjSP4WB062Ii9 () yury>",
          "author_name": "Yury Norov",
          "author_email": "yury.norov () gmail ! com",
          "subject": "Re: [PATCH v2] build_bug.h: more user friendly error messages in BUILD_BUG_ON_ZERO()",
          "date": "2025-04-09 14:17:49+00:00",
          "date_str": "Wed, 09 Apr 2025 14:17:49 +0000",
          "body": "On Wed, Apr 09, 2025 at 09:26:41PM +0900, Vincent Mailhol wrote:\n> +To: Yury Norov\n> \n> On 09/04/2025 at 04:03, Kees Cook wrote:\n> > On Tue, Apr 08, 2025 at 10:23:53PM +0900, Vincent Mailhol wrote:\n> >> On 08/04/2025 at 01:46, Kees Cook wrote:\n> >>> On Sat, Mar 29, 2025 at 01:48:50AM +0900, Vincent Mailhol wrote:\n> >>>> __BUILD_BUG_ON_ZERO_MSG(), as introduced in [1], makes it possible to\n> >>>> do a static assertions in expressions. The direct benefit is to\n> >>>> provide a meaningful error message instead of the cryptic negative\n> >>>> bitfield size error message currently returned by BUILD_BUG_ON_ZERO():\n> >>>>\n> >>>>   ./include/linux/build_bug.h:16:51: error: negative width in bit-field '<anonymous>'\n> >>>>      16 | #define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n> >>>>         |                                                   ^\n> >>>>\n> >>>> Get rid of BUILD_BUG_ON_ZERO()'s bitfield size hack. Instead rely on\n> >>>> __BUILD_BUG_ON_ZERO_MSG() which in turn relies on C11's\n> >>>> _Static_assert().\n> >>>>\n> >>>> Use some macro magic, similarly to static_assert(), to either use an\n> >>>> optional error message provided by the user or, when omitted, to\n> >>>> produce a default error message by stringifying the tested\n> >>>> expression. With this, for example:\n> >>>>\n> >>>>   BUILD_BUG_ON_ZERO(1 > 0)\n> >>>>\n> >>>> would now throw:\n> >>>>\n> >>>>   ./include/linux/compiler.h:197:62: error: static assertion failed: \"1 > 0 is true\"\n> >>>\n> >>> This is so much easier to read! Thanks for this. :)\n> >>>\n> >>> If no one else snags it, I can take this via the hardening tree for\n> >>> -next once -rc2 is released.\n> >>\n> >> I discussed about this with Andrew by DM.\n> >>\n> >> Andrew can pick it up but for the next-next release. That is to say,\n> >> wait for [1] to be merged in v6.16 and then take it to target the v6.17\n> >> merge windows.\n> >>\n> >> If you can take it in your hardening-next tree and have it merged in\n> >> v6.16, then this is convenient for me.\n> >>\n> >> Just make sure that you send it to Linus after Yury's bitmap-for-next\n> >> get merged: https://github.com/norov/linux/commits/bitmap-for-next/\n> > \n> > Could this land via Yury's tree?\n> \n> Hi Yury,\n> \n> I have this patch:\n> \n> https://lore.kernel.org/all/20250329-build_bug-v2-1-1c831e5ddf89@wanadoo.fr/\n> \n> which depends on commit b88937277df (\"drm/i915: Convert REG_GENMASK*()\n> to fixed-width GENMASK_U*()\") in your bitmap-for-next tree.\n> \n> I discussed this with Andrew (by DM) and Kees. Because of the\n> dependency, it would be convenient if this patch went through your tree.\n> \n> What do you think?\n\nSure, I can merge it. Please everyone send your tags before the end of\nweek.\n\nThanks,\nYury\n",
          "year": "2025",
          "month": "04"
        },
        {
          "filepath": "emails/2025/04/174421534629568.mbox",
          "message_id": "<202504090914.BC7A6BD89 () keescook>",
          "author_name": "Kees Cook",
          "author_email": "kees () kernel ! org",
          "subject": "Re: [PATCH v2] build_bug.h: more user friendly error messages in BUILD_BUG_ON_ZERO()",
          "date": "2025-04-09 16:14:56+00:00",
          "date_str": "Wed, 09 Apr 2025 16:14:56 +0000",
          "body": "On Wed, Apr 09, 2025 at 10:17:49AM -0400, Yury Norov wrote:\n> On Wed, Apr 09, 2025 at 09:26:41PM +0900, Vincent Mailhol wrote:\n> > +To: Yury Norov\n> > \n> > On 09/04/2025 at 04:03, Kees Cook wrote:\n> > > On Tue, Apr 08, 2025 at 10:23:53PM +0900, Vincent Mailhol wrote:\n> > >> On 08/04/2025 at 01:46, Kees Cook wrote:\n> > >>> On Sat, Mar 29, 2025 at 01:48:50AM +0900, Vincent Mailhol wrote:\n> > >>>> __BUILD_BUG_ON_ZERO_MSG(), as introduced in [1], makes it possible to\n> > >>>> do a static assertions in expressions. The direct benefit is to\n> > >>>> provide a meaningful error message instead of the cryptic negative\n> > >>>> bitfield size error message currently returned by BUILD_BUG_ON_ZERO():\n> > >>>>\n> > >>>>   ./include/linux/build_bug.h:16:51: error: negative width in bit-field '<anonymous>'\n> > >>>>      16 | #define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n> > >>>>         |                                                   ^\n> > >>>>\n> > >>>> Get rid of BUILD_BUG_ON_ZERO()'s bitfield size hack. Instead rely on\n> > >>>> __BUILD_BUG_ON_ZERO_MSG() which in turn relies on C11's\n> > >>>> _Static_assert().\n> > >>>>\n> > >>>> Use some macro magic, similarly to static_assert(), to either use an\n> > >>>> optional error message provided by the user or, when omitted, to\n> > >>>> produce a default error message by stringifying the tested\n> > >>>> expression. With this, for example:\n> > >>>>\n> > >>>>   BUILD_BUG_ON_ZERO(1 > 0)\n> > >>>>\n> > >>>> would now throw:\n> > >>>>\n> > >>>>   ./include/linux/compiler.h:197:62: error: static assertion failed: \"1 > 0 is true\"\n> > >>>\n> > >>> This is so much easier to read! Thanks for this. :)\n> > >>>\n> > >>> If no one else snags it, I can take this via the hardening tree for\n> > >>> -next once -rc2 is released.\n> > >>\n> > >> I discussed about this with Andrew by DM.\n> > >>\n> > >> Andrew can pick it up but for the next-next release. That is to say,\n> > >> wait for [1] to be merged in v6.16 and then take it to target the v6.17\n> > >> merge windows.\n> > >>\n> > >> If you can take it in your hardening-next tree and have it merged in\n> > >> v6.16, then this is convenient for me.\n> > >>\n> > >> Just make sure that you send it to Linus after Yury's bitmap-for-next\n> > >> get merged: https://github.com/norov/linux/commits/bitmap-for-next/\n> > > \n> > > Could this land via Yury's tree?\n> > \n> > Hi Yury,\n> > \n> > I have this patch:\n> > \n> > https://lore.kernel.org/all/20250329-build_bug-v2-1-1c831e5ddf89@wanadoo.fr/\n> > \n> > which depends on commit b88937277df (\"drm/i915: Convert REG_GENMASK*()\n> > to fixed-width GENMASK_U*()\") in your bitmap-for-next tree.\n> > \n> > I discussed this with Andrew (by DM) and Kees. Because of the\n> > dependency, it would be convenient if this patch went through your tree.\n> > \n> > What do you think?\n> \n> Sure, I can merge it. Please everyone send your tags before the end of\n> week.\n\nThanks!\n\nReviewed-by: Kees Cook <kees@kernel.org>\n\n-- \nKees Cook\n",
          "year": "2025",
          "month": "04"
        },
        {
          "filepath": "emails/2025/04/174466769602467.mbox",
          "message_id": "<Z_2EN7OYrXF4gb9G () yury>",
          "author_name": "Yury Norov",
          "author_email": "yury.norov () gmail ! com",
          "subject": "Re: [PATCH v2] build_bug.h: more user friendly error messages in BUILD_BUG_ON_ZERO()",
          "date": "2025-04-14 21:55:03+00:00",
          "date_str": "Mon, 14 Apr 2025 21:55:03 +0000",
          "body": "> > > Hi Yury,\n> > > \n> > > I have this patch:\n> > > \n> > > https://lore.kernel.org/all/20250329-build_bug-v2-1-1c831e5ddf89@wanadoo.fr/\n> > > \n> > > which depends on commit b88937277df (\"drm/i915: Convert REG_GENMASK*()\n> > > to fixed-width GENMASK_U*()\") in your bitmap-for-next tree.\n> > > \n> > > I discussed this with Andrew (by DM) and Kees. Because of the\n> > > dependency, it would be convenient if this patch went through your tree.\n> > > \n> > > What do you think?\n> > \n> > Sure, I can merge it. Please everyone send your tags before the end of\n> > week.\n> \n> Thanks!\n> \n> Reviewed-by: Kees Cook <kees@kernel.org>\n\nApplied, thanks!\n\nThanks,\nYury\n",
          "year": "2025",
          "month": "04"
        },
        {
          "filepath": "emails/2025/04/174466769502459.mbox",
          "message_id": "<Z_2EN7OYrXF4gb9G () yury>",
          "author_name": "Yury Norov",
          "author_email": "yury.norov () gmail ! com",
          "subject": "Re: [PATCH v2] build_bug.h: more user friendly error messages in BUILD_BUG_ON_ZERO()",
          "date": "2025-04-14 21:55:03+00:00",
          "date_str": "Mon, 14 Apr 2025 21:55:03 +0000",
          "body": "> > > Hi Yury,\n> > > \n> > > I have this patch:\n> > > \n> > > https://lore.kernel.org/all/20250329-build_bug-v2-1-1c831e5ddf89@wanadoo.fr/\n> > > \n> > > which depends on commit b88937277df (\"drm/i915: Convert REG_GENMASK*()\n> > > to fixed-width GENMASK_U*()\") in your bitmap-for-next tree.\n> > > \n> > > I discussed this with Andrew (by DM) and Kees. Because of the\n> > > dependency, it would be convenient if this patch went through your tree.\n> > > \n> > > What do you think?\n> > \n> > Sure, I can merge it. Please everyone send your tags before the end of\n> > week.\n> \n> Thanks!\n> \n> Reviewed-by: Kees Cook <kees@kernel.org>\n\nApplied, thanks!\n\nThanks,\nYury\n",
          "year": "2025",
          "month": "04"
        }
      ],
      "primary_category": "sparse_internals"
    },
    {
      "subject": "=?US-ASCII?Q?Re=3A_=5BPATCH_00/10=5D_compiler=2Eh=3A_refactor_=5F=5Fis?= =?US-ASCII?Q?=5Fconstexpr=2",
      "normalized_subject": "=?US-ASCII?Q?Re=3A_=5BPATCH_00/10=5D_compiler=2Eh=3A_refactor_=5F=5Fis?= =?US-ASCII?Q?=5Fconstexpr=2",
      "message_count": 1,
      "participants": [
        "Kees Cook"
      ],
      "categories": [
        "rfc_proposals"
      ],
      "first_date": "2024-12-04T23:58:44+00:00",
      "last_date": "2024-12-04T23:58:44+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/12/173335653912168.mbox",
          "message_id": "<FBEB24FF-5885-4938-8D1C-9B7BA9071FB9 () kernel ! org>",
          "author_name": "Kees Cook",
          "author_email": "kees () kernel ! org",
          "subject": "=?US-ASCII?Q?Re=3A_=5BPATCH_00/10=5D_compiler=2Eh=3A_refactor_=5F=5Fis?= =?US-ASCII?Q?=5Fconstexpr=2",
          "date": "2024-12-04 23:58:44+00:00",
          "date_str": "Wed, 04 Dec 2024 23:58:44 +0000",
          "body": "\n\nOn December 3, 2024 3:33:22 AM GMT+10:00, Vincent Mailhol via B4 Relay <de=\nvnull+mailhol=2Evincent=2Ewanadoo=2Efr@kernel=2Eorg> wrote:\n>This series is the spiritual successor of [1] which introduced\n>const_true()=2E In [1], following a comment from David Laight, Linus\n>came with a suggestion to simplify __is_constexpr() and its derived\n>macros using a _Generic() selection=2E Because of the total change of\n>scope, I am starting a new series=2E\n>\n>The goal is to introduce a set of three macros:\n>\n>  - is_const(): a one to one replacement of __is_constexpr() in term\n>    of features but written in a less hacky way thanks to _Generic()=2E\n>\n>  - is_const_true(): tells whether or not the argument is a true\n>    integer constant expression=2E\n>\n>  - is_const_false(): tells whether or not the argument is a false\n>    integer constant expression=2E\n\nBut why make this change? Is something broken? Does it make builds faster?\n\n> 7 files changed, 97 insertions(+), 84 deletions(-)\n\nIt makes the code larger too=2E I don't see what the benefit is, and given=\n how much time has been spent making sure the existing stuff works correctl=\ny, I feel like we should have a clear benefit to replacing it all=2E\n\n-Kees\n\n--=20\nKees Cook\n",
          "year": "2024",
          "month": "12"
        }
      ],
      "primary_category": "rfc_proposals"
    },
    {
      "subject": "Re: sparse reports \"different lock contexts for basic block\" when using guard syntax",
      "normalized_subject": "sparse reports \"different lock contexts for basic block\" when using guard syntax",
      "message_count": 1,
      "participants": [
        "Linus Torvalds"
      ],
      "categories": [
        "sparse_internals"
      ],
      "first_date": "2024-12-02T21:06:15+00:00",
      "last_date": "2024-12-02T21:06:15+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/12/173317401227477.mbox",
          "message_id": "<CAHk-=wiVDZejo_1BhOaR33qb=pny7sWnYtP4JUbRTXkXCkW6jA () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: sparse reports \"different lock contexts for basic block\" when using guard syntax",
          "date": "2024-12-02 21:06:15+00:00",
          "date_str": "Mon, 02 Dec 2024 21:06:15 +0000",
          "body": "On Mon, 2 Dec 2024 at 01:26, Uwe Kleine-K=C3=B6nig\n<u.kleine-koenig@baylibre.com> wrote:\n>\n> Trying to understand what sparse wants to tell me, I tried the following\n> change and the 2nd warning goes away:\n\nSparse really doesn't understand the new guard infrastructure. It gets\n_parsed_, but that's just about it.\n\nSo it parses the cleanup function, but never actually generates the\nlogic to _call_ the cleanup function when the variable goes out of\nscope.\n\nWhich obviously then means that none of the context updates of the\ncleanup get done, and so the lock context never gets undone.\n\nSadly, I think sparse is unmaintained these days,\n\n               Linus\n",
          "year": "2024",
          "month": "12"
        }
      ],
      "primary_category": "sparse_internals"
    },
    {
      "subject": "[PATCH 10/10] compiler.h: remove __is_constexpr()",
      "normalized_subject": "compiler.h: remove __is_constexpr()",
      "message_count": 1,
      "participants": [
        "Vincent Mailhol via B4 Relay"
      ],
      "categories": [
        "compiler_compat",
        "sparse_internals",
        "type_system"
      ],
      "first_date": "2024-12-02T17:33:32+00:00",
      "last_date": "2024-12-02T17:33:32+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/12/173316074217742.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-10-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 10/10] compiler.h: remove __is_constexpr()",
          "date": "2024-12-02 17:33:32+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:32 +0000",
          "body": "From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n\nNow that all the users of __is_constexpr() have been migrated to\nis_const() or one of its friends, remove it.\n\nThe homage to Martin Uecker's genius hack remains in the documentation\nof __is_const_zero().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\n include/linux/compiler.h | 47 -----------------------------------------------\n 1 file changed, 47 deletions(-)\n\ndiff --git a/include/linux/compiler.h b/include/linux/compiler.h\nindex 165aa5b9bc484376087a130a1ac1f3edb50c983d..7ba75044828129cf1f81f458ade695786dbf132a 100644\n--- a/include/linux/compiler.h\n+++ b/include/linux/compiler.h\n@@ -252,53 +252,6 @@ static inline void *offset_to_ptr(const int *off)\n #define __must_be_cstr(p) \\\n \t__BUILD_BUG_ON_ZERO_MSG(__annotated(p, nonstring), \"must be cstr (NUL-terminated)\")\n \n-/*\n- * This returns a constant expression while determining if an argument is\n- * a constant expression, most importantly without evaluating the argument.\n- * Glory to Martin Uecker <Martin.Uecker@med.uni-goettingen.de>\n- *\n- * Details:\n- * - sizeof() return an integer constant expression, and does not evaluate\n- *   the value of its operand; it only examines the type of its operand.\n- * - The results of comparing two integer constant expressions is also\n- *   an integer constant expression.\n- * - The first literal \"8\" isn't important. It could be any literal value.\n- * - The second literal \"8\" is to avoid warnings about unaligned pointers;\n- *   this could otherwise just be \"1\".\n- * - (long)(x) is used to avoid warnings about 64-bit types on 32-bit\n- *   architectures.\n- * - The C Standard defines \"null pointer constant\", \"(void *)0\", as\n- *   distinct from other void pointers.\n- * - If (x) is an integer constant expression, then the \"* 0l\" resolves\n- *   it into an integer constant expression of value 0. Since it is cast to\n- *   \"void *\", this makes the second operand a null pointer constant.\n- * - If (x) is not an integer constant expression, then the second operand\n- *   resolves to a void pointer (but not a null pointer constant: the value\n- *   is not an integer constant 0).\n- * - The conditional operator's third operand, \"(int *)8\", is an object\n- *   pointer (to type \"int\").\n- * - The behavior (including the return type) of the conditional operator\n- *   (\"operand1 ? operand2 : operand3\") depends on the kind of expressions\n- *   given for the second and third operands. This is the central mechanism\n- *   of the macro:\n- *   - When one operand is a null pointer constant (i.e. when x is an integer\n- *     constant expression) and the other is an object pointer (i.e. our\n- *     third operand), the conditional operator returns the type of the\n- *     object pointer operand (i.e. \"int *\"). Here, within the sizeof(), we\n- *     would then get:\n- *       sizeof(*((int *)(...))  == sizeof(int)  == 4\n- *   - When one operand is a void pointer (i.e. when x is not an integer\n- *     constant expression) and the other is an object pointer (i.e. our\n- *     third operand), the conditional operator returns a \"void *\" type.\n- *     Here, within the sizeof(), we would then get:\n- *       sizeof(*((void *)(...)) == sizeof(void) == 1\n- * - The equality comparison to \"sizeof(int)\" therefore depends on (x):\n- *     sizeof(int) == sizeof(int)     (x) was a constant expression\n- *     sizeof(int) != sizeof(void)    (x) was not a constant expression\n- */\n-#define __is_constexpr(x) \\\n-\t(sizeof(int) == sizeof(*(8 ? ((void *)((long)(x) * 0l)) : (int *)8)))\n-\n /*\n  * Whether 'type' is a signed type or an unsigned type. Supports scalar types,\n  * bool and also pointer types.\n\n-- \n2.45.2\n\n\n",
          "year": "2024",
          "month": "12"
        }
      ],
      "primary_category": "sparse_internals"
    },
    {
      "subject": "RE: [PATCH 08/10] drm/i915/reg: replace __is_const_expr() by is_const_true() or is_const()",
      "normalized_subject": "drm/i915/reg: replace __is_const_expr() by is_const_true() or is_const()",
      "message_count": 7,
      "participants": [
        "David Laight",
        "Vincent Mailhol via B4 Relay",
        "Vincent Mailhol"
      ],
      "categories": [
        "general",
        "sparse_internals"
      ],
      "first_date": "2024-12-02T17:33:30+00:00",
      "last_date": "2024-12-05T15:56:35+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/12/173316073617719.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-8-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 08/10] drm/i915/reg: replace __is_const_expr() by is_const_true() or is_const()",
          "date": "2024-12-02 17:33:30+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:30 +0000",
          "body": "From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n\nMost of the use of __is_const_expr() in i915_reg_defs.h are just to\ntest whether an expression is known to be true. Because those checks\nare all done in a BUILD_BUG_ON_ZERO(), replace those with\nis_const_true().\n\nReplace the few other occurrences of __is_const_expr() with is_const().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\n drivers/gpu/drm/i915/i915_reg_defs.h | 47 +++++++++++++++++-------------------\n 1 file changed, 22 insertions(+), 25 deletions(-)\n\ndiff --git a/drivers/gpu/drm/i915/i915_reg_defs.h b/drivers/gpu/drm/i915/i915_reg_defs.h\nindex e251bcc0c89f5710125bc70f07851b2cb978c89c..6ed2fb9cf506a3bd6467ba30f9d0e863d62762f3 100644\n--- a/drivers/gpu/drm/i915/i915_reg_defs.h\n+++ b/drivers/gpu/drm/i915/i915_reg_defs.h\n@@ -19,8 +19,7 @@\n  */\n #define REG_BIT(__n)\t\t\t\t\t\t\t\\\n \t((u32)(BIT(__n) +\t\t\t\t\t\t\\\n-\t       BUILD_BUG_ON_ZERO(__is_constexpr(__n) &&\t\t\\\n-\t\t\t\t ((__n) < 0 || (__n) > 31))))\n+\t       BUILD_BUG_ON_ZERO(is_const_true((__n) < 0 || (__n) > 31))))\n \n /**\n  * REG_BIT8() - Prepare a u8 bit value\n@@ -32,8 +31,7 @@\n  */\n #define REG_BIT8(__n)                                                   \\\n \t((u8)(BIT(__n) +                                                \\\n-\t       BUILD_BUG_ON_ZERO(__is_constexpr(__n) &&         \\\n-\t\t\t\t ((__n) < 0 || (__n) > 7))))\n+\t      BUILD_BUG_ON_ZERO(is_const_true((__n) < 0 || (__n) > 7))))\n \n /**\n  * REG_GENMASK() - Prepare a continuous u32 bitmask\n@@ -46,9 +44,9 @@\n  */\n #define REG_GENMASK(__high, __low)\t\t\t\t\t\\\n \t((u32)(GENMASK(__high, __low) +\t\t\t\t\t\\\n-\t       BUILD_BUG_ON_ZERO(__is_constexpr(__high) &&\t\\\n-\t\t\t\t __is_constexpr(__low) &&\t\t\\\n-\t\t\t\t ((__low) < 0 || (__high) > 31 || (__low) > (__high)))))\n+\t       BUILD_BUG_ON_ZERO(is_const_true((__low) < 0 ||\t\t\\\n+\t\t\t\t\t       (__high) > 31 ||\t\t\\\n+\t\t\t\t\t       (__low) > (__high)))))\n \n /**\n  * REG_GENMASK64() - Prepare a continuous u64 bitmask\n@@ -61,9 +59,9 @@\n  */\n #define REG_GENMASK64(__high, __low)\t\t\t\t\t\\\n \t((u64)(GENMASK_ULL(__high, __low) +\t\t\t\t\\\n-\t       BUILD_BUG_ON_ZERO(__is_constexpr(__high) &&\t\t\\\n-\t\t\t\t __is_constexpr(__low) &&\t\t\\\n-\t\t\t\t ((__low) < 0 || (__high) > 63 || (__low) > (__high)))))\n+\t       BUILD_BUG_ON_ZERO(is_const_true((__low) < 0 ||\t\t\\\n+\t\t\t\t\t       (__high) > 63 ||\t\t\\\n+\t\t\t\t\t       (__low) > (__high)))))\n \n /**\n  * REG_GENMASK8() - Prepare a continuous u8 bitmask\n@@ -76,9 +74,9 @@\n  */\n #define REG_GENMASK8(__high, __low)                                     \\\n \t((u8)(GENMASK(__high, __low) +                                  \\\n-\t       BUILD_BUG_ON_ZERO(__is_constexpr(__high) &&      \\\n-\t\t\t\t __is_constexpr(__low) &&               \\\n-\t\t\t\t ((__low) < 0 || (__high) > 7 || (__low) > (__high)))))\n+\t      BUILD_BUG_ON_ZERO(is_const_true((__low) < 0 ||            \\\n+\t\t\t\t\t      (__high) > 7 ||           \\\n+\t\t\t\t\t      (__low) > (__high)))))\n \n /*\n  * Local integer constant expression version of is_power_of_2().\n@@ -97,10 +95,10 @@\n  */\n #define REG_FIELD_PREP(__mask, __val)\t\t\t\t\t\t\\\n \t((u32)((((typeof(__mask))(__val) << __bf_shf(__mask)) & (__mask)) +\t\\\n-\t       BUILD_BUG_ON_ZERO(!__is_constexpr(__mask)) +\t\t\\\n+\t       BUILD_BUG_ON_ZERO(!is_const(__mask)) +\t\t\t\t\\\n \t       BUILD_BUG_ON_ZERO((__mask) == 0 || (__mask) > U32_MAX) +\t\t\\\n \t       BUILD_BUG_ON_ZERO(!IS_POWER_OF_2((__mask) + (1ULL << __bf_shf(__mask)))) + \\\n-\t       BUILD_BUG_ON_ZERO(__builtin_choose_expr(__is_constexpr(__val), (~((__mask) >> __bf_shf(__mask)) & (__val)), 0))))\n+\t       BUILD_BUG_ON_ZERO(is_const_true(~((__mask) >> __bf_shf(__mask)) & (__val)))))\n \n /**\n  * REG_FIELD_PREP8() - Prepare a u8 bitfield value\n@@ -114,10 +112,10 @@\n  */\n #define REG_FIELD_PREP8(__mask, __val)                                          \\\n \t((u8)((((typeof(__mask))(__val) << __bf_shf(__mask)) & (__mask)) +      \\\n-\t       BUILD_BUG_ON_ZERO(!__is_constexpr(__mask)) +             \\\n+\t       BUILD_BUG_ON_ZERO(!is_const(__mask)) +                           \\\n \t       BUILD_BUG_ON_ZERO((__mask) == 0 || (__mask) > U8_MAX) +          \\\n \t       BUILD_BUG_ON_ZERO(!IS_POWER_OF_2((__mask) + (1ULL << __bf_shf(__mask)))) + \\\n-\t       BUILD_BUG_ON_ZERO(__builtin_choose_expr(__is_constexpr(__val), (~((__mask) >> __bf_shf(__mask)) & (__val)), 0))))\n+\t       BUILD_BUG_ON_ZERO(is_const_true(~((__mask) >> __bf_shf(__mask)) & (__val)))))\n \n /**\n  * REG_FIELD_GET() - Extract a u32 bitfield value\n@@ -154,8 +152,7 @@\n  */\n #define REG_BIT16(__n)                                                   \\\n \t((u16)(BIT(__n) +                                                \\\n-\t       BUILD_BUG_ON_ZERO(__is_constexpr(__n) &&         \\\n-\t\t\t\t ((__n) < 0 || (__n) > 15))))\n+\t       BUILD_BUG_ON_ZERO(is_const_true((__n) < 0 || (__n) > 15))))\n \n /**\n  * REG_GENMASK16() - Prepare a continuous u8 bitmask\n@@ -169,9 +166,9 @@\n  */\n #define REG_GENMASK16(__high, __low)                                     \\\n \t((u16)(GENMASK(__high, __low) +                                  \\\n-\t       BUILD_BUG_ON_ZERO(__is_constexpr(__high) &&      \\\n-\t\t\t\t __is_conste",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173316837223858.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-8-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 08/10] drm/i915/reg: replace __is_const_expr() by is_const_true() or is_const()",
          "date": "2024-12-02 17:33:30+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:30 +0000",
          "body": "From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n\nMost of the use of __is_const_expr() in i915_reg_defs.h are just to\ntest whether an expression is known to be true. Because those checks\nare all done in a BUILD_BUG_ON_ZERO(), replace those with\nis_const_true().\n\nReplace the few other occurrences of __is_const_expr() with is_const().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\n drivers/gpu/drm/i915/i915_reg_defs.h | 47 +++++++++++++++++-------------------\n 1 file changed, 22 insertions(+), 25 deletions(-)\n\ndiff --git a/drivers/gpu/drm/i915/i915_reg_defs.h b/drivers/gpu/drm/i915/i915_reg_defs.h\nindex e251bcc0c89f5710125bc70f07851b2cb978c89c..6ed2fb9cf506a3bd6467ba30f9d0e863d62762f3 100644\n--- a/drivers/gpu/drm/i915/i915_reg_defs.h\n+++ b/drivers/gpu/drm/i915/i915_reg_defs.h\n@@ -19,8 +19,7 @@\n  */\n #define REG_BIT(__n)\t\t\t\t\t\t\t\\\n \t((u32)(BIT(__n) +\t\t\t\t\t\t\\\n-\t       BUILD_BUG_ON_ZERO(__is_constexpr(__n) &&\t\t\\\n-\t\t\t\t ((__n) < 0 || (__n) > 31))))\n+\t       BUILD_BUG_ON_ZERO(is_const_true((__n) < 0 || (__n) > 31))))\n \n /**\n  * REG_BIT8() - Prepare a u8 bit value\n@@ -32,8 +31,7 @@\n  */\n #define REG_BIT8(__n)                                                   \\\n \t((u8)(BIT(__n) +                                                \\\n-\t       BUILD_BUG_ON_ZERO(__is_constexpr(__n) &&         \\\n-\t\t\t\t ((__n) < 0 || (__n) > 7))))\n+\t      BUILD_BUG_ON_ZERO(is_const_true((__n) < 0 || (__n) > 7))))\n \n /**\n  * REG_GENMASK() - Prepare a continuous u32 bitmask\n@@ -46,9 +44,9 @@\n  */\n #define REG_GENMASK(__high, __low)\t\t\t\t\t\\\n \t((u32)(GENMASK(__high, __low) +\t\t\t\t\t\\\n-\t       BUILD_BUG_ON_ZERO(__is_constexpr(__high) &&\t\\\n-\t\t\t\t __is_constexpr(__low) &&\t\t\\\n-\t\t\t\t ((__low) < 0 || (__high) > 31 || (__low) > (__high)))))\n+\t       BUILD_BUG_ON_ZERO(is_const_true((__low) < 0 ||\t\t\\\n+\t\t\t\t\t       (__high) > 31 ||\t\t\\\n+\t\t\t\t\t       (__low) > (__high)))))\n \n /**\n  * REG_GENMASK64() - Prepare a continuous u64 bitmask\n@@ -61,9 +59,9 @@\n  */\n #define REG_GENMASK64(__high, __low)\t\t\t\t\t\\\n \t((u64)(GENMASK_ULL(__high, __low) +\t\t\t\t\\\n-\t       BUILD_BUG_ON_ZERO(__is_constexpr(__high) &&\t\t\\\n-\t\t\t\t __is_constexpr(__low) &&\t\t\\\n-\t\t\t\t ((__low) < 0 || (__high) > 63 || (__low) > (__high)))))\n+\t       BUILD_BUG_ON_ZERO(is_const_true((__low) < 0 ||\t\t\\\n+\t\t\t\t\t       (__high) > 63 ||\t\t\\\n+\t\t\t\t\t       (__low) > (__high)))))\n \n /**\n  * REG_GENMASK8() - Prepare a continuous u8 bitmask\n@@ -76,9 +74,9 @@\n  */\n #define REG_GENMASK8(__high, __low)                                     \\\n \t((u8)(GENMASK(__high, __low) +                                  \\\n-\t       BUILD_BUG_ON_ZERO(__is_constexpr(__high) &&      \\\n-\t\t\t\t __is_constexpr(__low) &&               \\\n-\t\t\t\t ((__low) < 0 || (__high) > 7 || (__low) > (__high)))))\n+\t      BUILD_BUG_ON_ZERO(is_const_true((__low) < 0 ||            \\\n+\t\t\t\t\t      (__high) > 7 ||           \\\n+\t\t\t\t\t      (__low) > (__high)))))\n \n /*\n  * Local integer constant expression version of is_power_of_2().\n@@ -97,10 +95,10 @@\n  */\n #define REG_FIELD_PREP(__mask, __val)\t\t\t\t\t\t\\\n \t((u32)((((typeof(__mask))(__val) << __bf_shf(__mask)) & (__mask)) +\t\\\n-\t       BUILD_BUG_ON_ZERO(!__is_constexpr(__mask)) +\t\t\\\n+\t       BUILD_BUG_ON_ZERO(!is_const(__mask)) +\t\t\t\t\\\n \t       BUILD_BUG_ON_ZERO((__mask) == 0 || (__mask) > U32_MAX) +\t\t\\\n \t       BUILD_BUG_ON_ZERO(!IS_POWER_OF_2((__mask) + (1ULL << __bf_shf(__mask)))) + \\\n-\t       BUILD_BUG_ON_ZERO(__builtin_choose_expr(__is_constexpr(__val), (~((__mask) >> __bf_shf(__mask)) & (__val)), 0))))\n+\t       BUILD_BUG_ON_ZERO(is_const_true(~((__mask) >> __bf_shf(__mask)) & (__val)))))\n \n /**\n  * REG_FIELD_PREP8() - Prepare a u8 bitfield value\n@@ -114,10 +112,10 @@\n  */\n #define REG_FIELD_PREP8(__mask, __val)                                          \\\n \t((u8)((((typeof(__mask))(__val) << __bf_shf(__mask)) & (__mask)) +      \\\n-\t       BUILD_BUG_ON_ZERO(!__is_constexpr(__mask)) +             \\\n+\t       BUILD_BUG_ON_ZERO(!is_const(__mask)) +                           \\\n \t       BUILD_BUG_ON_ZERO((__mask) == 0 || (__mask) > U8_MAX) +          \\\n \t       BUILD_BUG_ON_ZERO(!IS_POWER_OF_2((__mask) + (1ULL << __bf_shf(__mask)))) + \\\n-\t       BUILD_BUG_ON_ZERO(__builtin_choose_expr(__is_constexpr(__val), (~((__mask) >> __bf_shf(__mask)) & (__val)), 0))))\n+\t       BUILD_BUG_ON_ZERO(is_const_true(~((__mask) >> __bf_shf(__mask)) & (__val)))))\n \n /**\n  * REG_FIELD_GET() - Extract a u32 bitfield value\n@@ -154,8 +152,7 @@\n  */\n #define REG_BIT16(__n)                                                   \\\n \t((u16)(BIT(__n) +                                                \\\n-\t       BUILD_BUG_ON_ZERO(__is_constexpr(__n) &&         \\\n-\t\t\t\t ((__n) < 0 || (__n) > 15))))\n+\t       BUILD_BUG_ON_ZERO(is_const_true((__n) < 0 || (__n) > 15))))\n \n /**\n  * REG_GENMASK16() - Prepare a continuous u8 bitmask\n@@ -169,9 +166,9 @@\n  */\n #define REG_GENMASK16(__high, __low)                                     \\\n \t((u16)(GENMASK(__high, __low) +                                  \\\n-\t       BUILD_BUG_ON_ZERO(__is_constexpr(__high) &&      \\\n-\t\t\t\t __is_conste",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173333868332401.mbox",
          "message_id": "<6597979088eb4ee7b98cfb99815a402e () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH 08/10] drm/i915/reg: replace __is_const_expr() by is_const_true() or is_const()",
          "date": "2024-12-04 18:58:03+00:00",
          "date_str": "Wed, 04 Dec 2024 18:58:03 +0000",
          "body": "RnJvbTogVmluY2VudCBNYWlsaG9sDQo+IFNlbnQ6IDAyIERlY2VtYmVyIDIwMjQgMTc6MzQNCj4g\nDQo+IE1vc3Qgb2YgdGhlIHVzZSBvZiBfX2lzX2NvbnN0X2V4cHIoKSBpbiBpOTE1X3JlZ19kZWZz\nLmggYXJlIGp1c3QgdG8NCj4gdGVzdCB3aGV0aGVyIGFuIGV4cHJlc3Npb24gaXMga25vd24gdG8g\nYmUgdHJ1ZS4gQmVjYXVzZSB0aG9zZSBjaGVja3MNCj4gYXJlIGFsbCBkb25lIGluIGEgQlVJTERf\nQlVHX09OX1pFUk8oKSwgcmVwbGFjZSB0aG9zZSB3aXRoDQo+IGlzX2NvbnN0X3RydWUoKS4NCg0K\nQW5vdGhlciBwbGFjZSB0aGF0IGNvdWxkIHVzZSBzdGF0aWNhbGx5X3RydWUoKSBhbmQgQlVJTERf\nQlVHX09OX01TRygpLg0KDQoJRGF2aWQNCg0KPiANCj4gUmVwbGFjZSB0aGUgZmV3IG90aGVyIG9j\nY3VycmVuY2VzIG9mIF9faXNfY29uc3RfZXhwcigpIHdpdGggaXNfY29uc3QoKS4NCj4gDQo+IFNp\nZ25lZC1vZmYtYnk6IFZpbmNlbnQgTWFpbGhvbCA8bWFpbGhvbC52aW5jZW50QHdhbmFkb28uZnI+\nDQo+IC0tLQ0KPiAgZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZWdfZGVmcy5oIHwgNDcgKysr\nKysrKysrKysrKysrKystLS0tLS0tLS0tLS0tLS0tLS0tDQo+ICAxIGZpbGUgY2hhbmdlZCwgMjIg\naW5zZXJ0aW9ucygrKSwgMjUgZGVsZXRpb25zKC0pDQo+IA0KPiBkaWZmIC0tZ2l0IGEvZHJpdmVy\ncy9ncHUvZHJtL2k5MTUvaTkxNV9yZWdfZGVmcy5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkx\nNV9yZWdfZGVmcy5oDQo+IGluZGV4IGUyNTFiY2MwYzg5ZjU3MTAxMjViYzcwZjA3ODUxYjJjYjk3\nOGM4OWMuLjZlZDJmYjljZjUwNmEzYmQ2NDY3YmEzMGY5ZDBlODYzZDYyNzYyZjMgMTAwNjQ0DQo+\nIC0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVnX2RlZnMuaA0KPiArKysgYi9kcml2\nZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3JlZ19kZWZzLmgNCj4gQEAgLTE5LDggKzE5LDcgQEANCj4g\nICAqLw0KPiAgI2RlZmluZSBSRUdfQklUKF9fbikJCQkJCQkJXA0KPiAgCSgodTMyKShCSVQoX19u\nKSArCQkJCQkJXA0KPiAtCSAgICAgICBCVUlMRF9CVUdfT05fWkVSTyhfX2lzX2NvbnN0ZXhwcihf\nX24pICYmCQlcDQo+IC0JCQkJICgoX19uKSA8IDAgfHwgKF9fbikgPiAzMSkpKSkNCj4gKwkgICAg\nICAgQlVJTERfQlVHX09OX1pFUk8oaXNfY29uc3RfdHJ1ZSgoX19uKSA8IDAgfHwgKF9fbikgPiAz\nMSkpKSkNCj4gDQo+ICAvKioNCj4gICAqIFJFR19CSVQ4KCkgLSBQcmVwYXJlIGEgdTggYml0IHZh\nbHVlDQo+IEBAIC0zMiw4ICszMSw3IEBADQo+ICAgKi8NCj4gICNkZWZpbmUgUkVHX0JJVDgoX19u\nKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwNCj4g\nIAkoKHU4KShCSVQoX19uKSArICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg\nICAgICAgICAgXA0KPiAtCSAgICAgICBCVUlMRF9CVUdfT05fWkVSTyhfX2lzX2NvbnN0ZXhwcihf\nX24pICYmICAgICAgICAgXA0KPiAtCQkJCSAoKF9fbikgPCAwIHx8IChfX24pID4gNykpKSkNCj4g\nKwkgICAgICBCVUlMRF9CVUdfT05fWkVSTyhpc19jb25zdF90cnVlKChfX24pIDwgMCB8fCAoX19u\nKSA+IDcpKSkpDQo+IA0KPiAgLyoqDQo+ICAgKiBSRUdfR0VOTUFTSygpIC0gUHJlcGFyZSBhIGNv\nbnRpbnVvdXMgdTMyIGJpdG1hc2sNCj4gQEAgLTQ2LDkgKzQ0LDkgQEANCj4gICAqLw0KPiAgI2Rl\nZmluZSBSRUdfR0VOTUFTSyhfX2hpZ2gsIF9fbG93KQkJCQkJXA0KPiAgCSgodTMyKShHRU5NQVNL\nKF9faGlnaCwgX19sb3cpICsJCQkJCVwNCj4gLQkgICAgICAgQlVJTERfQlVHX09OX1pFUk8oX19p\nc19jb25zdGV4cHIoX19oaWdoKSAmJglcDQo+IC0JCQkJIF9faXNfY29uc3RleHByKF9fbG93KSAm\nJgkJXA0KPiAtCQkJCSAoKF9fbG93KSA8IDAgfHwgKF9faGlnaCkgPiAzMSB8fCAoX19sb3cpID4g\nKF9faGlnaCkpKSkpDQo+ICsJICAgICAgIEJVSUxEX0JVR19PTl9aRVJPKGlzX2NvbnN0X3RydWUo\nKF9fbG93KSA8IDAgfHwJCVwNCj4gKwkJCQkJICAgICAgIChfX2hpZ2gpID4gMzEgfHwJCVwNCj4g\nKwkJCQkJICAgICAgIChfX2xvdykgPiAoX19oaWdoKSkpKSkNCj4gDQo+ICAvKioNCj4gICAqIFJF\nR19HRU5NQVNLNjQoKSAtIFByZXBhcmUgYSBjb250aW51b3VzIHU2NCBiaXRtYXNrDQo+IEBAIC02\nMSw5ICs1OSw5IEBADQo+ICAgKi8NCj4gICNkZWZpbmUgUkVHX0dFTk1BU0s2NChfX2hpZ2gsIF9f\nbG93KQkJCQkJXA0KPiAgCSgodTY0KShHRU5NQVNLX1VMTChfX2hpZ2gsIF9fbG93KSArCQkJCVwN\nCj4gLQkgICAgICAgQlVJTERfQlVHX09OX1pFUk8oX19pc19jb25zdGV4cHIoX19oaWdoKSAmJgkJ\nXA0KPiAtCQkJCSBfX2lzX2NvbnN0ZXhwcihfX2xvdykgJiYJCVwNCj4gLQkJCQkgKChfX2xvdykg\nPCAwIHx8IChfX2hpZ2gpID4gNjMgfHwgKF9fbG93KSA+IChfX2hpZ2gpKSkpKQ0KPiArCSAgICAg\nICBCVUlMRF9CVUdfT05fWkVSTyhpc19jb25zdF90cnVlKChfX2xvdykgPCAwIHx8CQlcDQo+ICsJ\nCQkJCSAgICAgICAoX19oaWdoKSA+IDYzIHx8CQlcDQo+ICsJCQkJCSAgICAgICAoX19sb3cpID4g\nKF9faGlnaCkpKSkpDQo+IA0KPiAgLyoqDQo+ICAgKiBSRUdfR0VOTUFTSzgoKSAtIFByZXBhcmUg\nYSBjb250aW51b3VzIHU4IGJpdG1hc2sNCj4gQEAgLTc2LDkgKzc0LDkgQEANCj4gICAqLw0KPiAg\nI2RlZmluZSBSRUdfR0VOTUFTSzgoX19oaWdoLCBfX2xvdykgICAgICAgICAgICAgICAgICAgICAg\nICAgICAgICAgICAgICAgXA0KPiAgCSgodTgpKEdFTk1BU0soX19oaWdoLCBfX2xvdykgKyAgICAg\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcDQo+IC0JICAgICAgIEJVSUxEX0JVR19PTl9a\nRVJPKF9faXNfY29uc3RleHByKF9faGlnaCkgJiYgICAgICBcDQo+IC0JCQkJIF9faXNfY29uc3Rl\neHByKF9fbG93KSAmJiAgICAgICAgICAgICAgIFwNCj4gLQkJCQkgKChfX2xvdykgPCAwIHx8IChf\nX2hpZ2gpID4gNyB8fCAoX19sb3cpID4gKF9faGlnaCkpKSkpDQo+ICsJICAgICAgQlVJTERfQlVH\nX09OX1pFUk8oaXNfY29uc3RfdHJ1ZSgoX19sb3cpIDwgMCB8fCAgICAgICAgICAgIFwNCj4gKwkJ\nCQkJICAgICAgKF9faGlnaCkgPiA3IHx8ICAgICAgICAgICBcDQo+ICsJCQkJCSAgICAgIChfX2xv\ndykgPiAoX19oaWdoKSkpKSkNCj4gDQo+ICAvKg0KPiAgICogTG9jYWwgaW50ZWdlciBjb25zdGFu\ndCBleHByZXNzaW9uIHZlcnNpb24gb2YgaXNfcG93ZXJfb2ZfMigpLg0KPiBAQCAtOTcsMTAgKzk1\nLDEwIEBADQo+ICAgKi8NCj4gICNkZWZpbmUgUkVHX0ZJRUxEX1BSRVAoX19tYXNrLCBfX3ZhbCkJ\nCQkJCQlcDQo+ICAJKCh1MzIpKCgoKHR5cGVvZihfX21hc2spKShfX3ZhbCkgPDwgX19iZl9zaGYo\nX19tYXNrKSkgJiAoX19tYXNrKSkgKwlcDQo+IC0JICAgICAgIEJVSUxEX0JVR19PTl9aRVJPKCFf\nX2lzX2NvbnN0ZXhwcihfX21hc2spKSArCQlcDQo+ICsJICAgICAgIEJVSUxEX0JVR19PTl9aRVJP\nKCFpc19jb25zdChfX21hc2spKSArCQkJCVwNCj4gIAkgICAgICAgQlVJTERfQlVHX09OX1pFUk8o\nKF9fbWFzaykgPT0gMCB8fCAoX19tYXNrKSA+IFUzMl9NQVgpICsJCVwNCj4gIAkgICAgICAgQlVJ\nTERfQlVHX09OX1pFUk8oIUlTX1BPV0VSX09GXzIoKF9fbWFzaykgKyAoMVVMTCA8PCBfX2JmX3No\nZihfX21hc2spKSkpICsgXA0KPiAtCSAgICAgICBCVUlMRF9CVUdfT05fWkVSTyhfX2J1aWx0",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173333868932405.mbox",
          "message_id": "<6597979088eb4ee7b98cfb99815a402e () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH 08/10] drm/i915/reg: replace __is_const_expr() by is_const_true() or is_const()",
          "date": "2024-12-04 18:58:09+00:00",
          "date_str": "Wed, 04 Dec 2024 18:58:09 +0000",
          "body": "RnJvbTogVmluY2VudCBNYWlsaG9sDQo+IFNlbnQ6IDAyIERlY2VtYmVyIDIwMjQgMTc6MzQNCj4g\nDQo+IE1vc3Qgb2YgdGhlIHVzZSBvZiBfX2lzX2NvbnN0X2V4cHIoKSBpbiBpOTE1X3JlZ19kZWZz\nLmggYXJlIGp1c3QgdG8NCj4gdGVzdCB3aGV0aGVyIGFuIGV4cHJlc3Npb24gaXMga25vd24gdG8g\nYmUgdHJ1ZS4gQmVjYXVzZSB0aG9zZSBjaGVja3MNCj4gYXJlIGFsbCBkb25lIGluIGEgQlVJTERf\nQlVHX09OX1pFUk8oKSwgcmVwbGFjZSB0aG9zZSB3aXRoDQo+IGlzX2NvbnN0X3RydWUoKS4NCg0K\nQW5vdGhlciBwbGFjZSB0aGF0IGNvdWxkIHVzZSBzdGF0aWNhbGx5X3RydWUoKSBhbmQgQlVJTERf\nQlVHX09OX01TRygpLg0KDQoJRGF2aWQNCg0KPiANCj4gUmVwbGFjZSB0aGUgZmV3IG90aGVyIG9j\nY3VycmVuY2VzIG9mIF9faXNfY29uc3RfZXhwcigpIHdpdGggaXNfY29uc3QoKS4NCj4gDQo+IFNp\nZ25lZC1vZmYtYnk6IFZpbmNlbnQgTWFpbGhvbCA8bWFpbGhvbC52aW5jZW50QHdhbmFkb28uZnI+\nDQo+IC0tLQ0KPiAgZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZWdfZGVmcy5oIHwgNDcgKysr\nKysrKysrKysrKysrKystLS0tLS0tLS0tLS0tLS0tLS0tDQo+ICAxIGZpbGUgY2hhbmdlZCwgMjIg\naW5zZXJ0aW9ucygrKSwgMjUgZGVsZXRpb25zKC0pDQo+IA0KPiBkaWZmIC0tZ2l0IGEvZHJpdmVy\ncy9ncHUvZHJtL2k5MTUvaTkxNV9yZWdfZGVmcy5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkx\nNV9yZWdfZGVmcy5oDQo+IGluZGV4IGUyNTFiY2MwYzg5ZjU3MTAxMjViYzcwZjA3ODUxYjJjYjk3\nOGM4OWMuLjZlZDJmYjljZjUwNmEzYmQ2NDY3YmEzMGY5ZDBlODYzZDYyNzYyZjMgMTAwNjQ0DQo+\nIC0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVnX2RlZnMuaA0KPiArKysgYi9kcml2\nZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3JlZ19kZWZzLmgNCj4gQEAgLTE5LDggKzE5LDcgQEANCj4g\nICAqLw0KPiAgI2RlZmluZSBSRUdfQklUKF9fbikJCQkJCQkJXA0KPiAgCSgodTMyKShCSVQoX19u\nKSArCQkJCQkJXA0KPiAtCSAgICAgICBCVUlMRF9CVUdfT05fWkVSTyhfX2lzX2NvbnN0ZXhwcihf\nX24pICYmCQlcDQo+IC0JCQkJICgoX19uKSA8IDAgfHwgKF9fbikgPiAzMSkpKSkNCj4gKwkgICAg\nICAgQlVJTERfQlVHX09OX1pFUk8oaXNfY29uc3RfdHJ1ZSgoX19uKSA8IDAgfHwgKF9fbikgPiAz\nMSkpKSkNCj4gDQo+ICAvKioNCj4gICAqIFJFR19CSVQ4KCkgLSBQcmVwYXJlIGEgdTggYml0IHZh\nbHVlDQo+IEBAIC0zMiw4ICszMSw3IEBADQo+ICAgKi8NCj4gICNkZWZpbmUgUkVHX0JJVDgoX19u\nKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwNCj4g\nIAkoKHU4KShCSVQoX19uKSArICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg\nICAgICAgICAgXA0KPiAtCSAgICAgICBCVUlMRF9CVUdfT05fWkVSTyhfX2lzX2NvbnN0ZXhwcihf\nX24pICYmICAgICAgICAgXA0KPiAtCQkJCSAoKF9fbikgPCAwIHx8IChfX24pID4gNykpKSkNCj4g\nKwkgICAgICBCVUlMRF9CVUdfT05fWkVSTyhpc19jb25zdF90cnVlKChfX24pIDwgMCB8fCAoX19u\nKSA+IDcpKSkpDQo+IA0KPiAgLyoqDQo+ICAgKiBSRUdfR0VOTUFTSygpIC0gUHJlcGFyZSBhIGNv\nbnRpbnVvdXMgdTMyIGJpdG1hc2sNCj4gQEAgLTQ2LDkgKzQ0LDkgQEANCj4gICAqLw0KPiAgI2Rl\nZmluZSBSRUdfR0VOTUFTSyhfX2hpZ2gsIF9fbG93KQkJCQkJXA0KPiAgCSgodTMyKShHRU5NQVNL\nKF9faGlnaCwgX19sb3cpICsJCQkJCVwNCj4gLQkgICAgICAgQlVJTERfQlVHX09OX1pFUk8oX19p\nc19jb25zdGV4cHIoX19oaWdoKSAmJglcDQo+IC0JCQkJIF9faXNfY29uc3RleHByKF9fbG93KSAm\nJgkJXA0KPiAtCQkJCSAoKF9fbG93KSA8IDAgfHwgKF9faGlnaCkgPiAzMSB8fCAoX19sb3cpID4g\nKF9faGlnaCkpKSkpDQo+ICsJICAgICAgIEJVSUxEX0JVR19PTl9aRVJPKGlzX2NvbnN0X3RydWUo\nKF9fbG93KSA8IDAgfHwJCVwNCj4gKwkJCQkJICAgICAgIChfX2hpZ2gpID4gMzEgfHwJCVwNCj4g\nKwkJCQkJICAgICAgIChfX2xvdykgPiAoX19oaWdoKSkpKSkNCj4gDQo+ICAvKioNCj4gICAqIFJF\nR19HRU5NQVNLNjQoKSAtIFByZXBhcmUgYSBjb250aW51b3VzIHU2NCBiaXRtYXNrDQo+IEBAIC02\nMSw5ICs1OSw5IEBADQo+ICAgKi8NCj4gICNkZWZpbmUgUkVHX0dFTk1BU0s2NChfX2hpZ2gsIF9f\nbG93KQkJCQkJXA0KPiAgCSgodTY0KShHRU5NQVNLX1VMTChfX2hpZ2gsIF9fbG93KSArCQkJCVwN\nCj4gLQkgICAgICAgQlVJTERfQlVHX09OX1pFUk8oX19pc19jb25zdGV4cHIoX19oaWdoKSAmJgkJ\nXA0KPiAtCQkJCSBfX2lzX2NvbnN0ZXhwcihfX2xvdykgJiYJCVwNCj4gLQkJCQkgKChfX2xvdykg\nPCAwIHx8IChfX2hpZ2gpID4gNjMgfHwgKF9fbG93KSA+IChfX2hpZ2gpKSkpKQ0KPiArCSAgICAg\nICBCVUlMRF9CVUdfT05fWkVSTyhpc19jb25zdF90cnVlKChfX2xvdykgPCAwIHx8CQlcDQo+ICsJ\nCQkJCSAgICAgICAoX19oaWdoKSA+IDYzIHx8CQlcDQo+ICsJCQkJCSAgICAgICAoX19sb3cpID4g\nKF9faGlnaCkpKSkpDQo+IA0KPiAgLyoqDQo+ICAgKiBSRUdfR0VOTUFTSzgoKSAtIFByZXBhcmUg\nYSBjb250aW51b3VzIHU4IGJpdG1hc2sNCj4gQEAgLTc2LDkgKzc0LDkgQEANCj4gICAqLw0KPiAg\nI2RlZmluZSBSRUdfR0VOTUFTSzgoX19oaWdoLCBfX2xvdykgICAgICAgICAgICAgICAgICAgICAg\nICAgICAgICAgICAgICAgXA0KPiAgCSgodTgpKEdFTk1BU0soX19oaWdoLCBfX2xvdykgKyAgICAg\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcDQo+IC0JICAgICAgIEJVSUxEX0JVR19PTl9a\nRVJPKF9faXNfY29uc3RleHByKF9faGlnaCkgJiYgICAgICBcDQo+IC0JCQkJIF9faXNfY29uc3Rl\neHByKF9fbG93KSAmJiAgICAgICAgICAgICAgIFwNCj4gLQkJCQkgKChfX2xvdykgPCAwIHx8IChf\nX2hpZ2gpID4gNyB8fCAoX19sb3cpID4gKF9faGlnaCkpKSkpDQo+ICsJICAgICAgQlVJTERfQlVH\nX09OX1pFUk8oaXNfY29uc3RfdHJ1ZSgoX19sb3cpIDwgMCB8fCAgICAgICAgICAgIFwNCj4gKwkJ\nCQkJICAgICAgKF9faGlnaCkgPiA3IHx8ICAgICAgICAgICBcDQo+ICsJCQkJCSAgICAgIChfX2xv\ndykgPiAoX19oaWdoKSkpKSkNCj4gDQo+ICAvKg0KPiAgICogTG9jYWwgaW50ZWdlciBjb25zdGFu\ndCBleHByZXNzaW9uIHZlcnNpb24gb2YgaXNfcG93ZXJfb2ZfMigpLg0KPiBAQCAtOTcsMTAgKzk1\nLDEwIEBADQo+ICAgKi8NCj4gICNkZWZpbmUgUkVHX0ZJRUxEX1BSRVAoX19tYXNrLCBfX3ZhbCkJ\nCQkJCQlcDQo+ICAJKCh1MzIpKCgoKHR5cGVvZihfX21hc2spKShfX3ZhbCkgPDwgX19iZl9zaGYo\nX19tYXNrKSkgJiAoX19tYXNrKSkgKwlcDQo+IC0JICAgICAgIEJVSUxEX0JVR19PTl9aRVJPKCFf\nX2lzX2NvbnN0ZXhwcihfX21hc2spKSArCQlcDQo+ICsJICAgICAgIEJVSUxEX0JVR19PTl9aRVJP\nKCFpc19jb25zdChfX21hc2spKSArCQkJCVwNCj4gIAkgICAgICAgQlVJTERfQlVHX09OX1pFUk8o\nKF9fbWFzaykgPT0gMCB8fCAoX19tYXNrKSA+IFUzMl9NQVgpICsJCVwNCj4gIAkgICAgICAgQlVJ\nTERfQlVHX09OX1pFUk8oIUlTX1BPV0VSX09GXzIoKF9fbWFzaykgKyAoMVVMTCA8PCBfX2JmX3No\nZihfX21hc2spKSkpICsgXA0KPiAtCSAgICAgICBCVUlMRF9CVUdfT05fWkVSTyhfX2J1aWx0",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173333869232409.mbox",
          "message_id": "<6597979088eb4ee7b98cfb99815a402e () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH 08/10] drm/i915/reg: replace __is_const_expr() by is_const_true() or is_const()",
          "date": "2024-12-04 18:58:12+00:00",
          "date_str": "Wed, 04 Dec 2024 18:58:12 +0000",
          "body": "RnJvbTogVmluY2VudCBNYWlsaG9sDQo+IFNlbnQ6IDAyIERlY2VtYmVyIDIwMjQgMTc6MzQNCj4g\nDQo+IE1vc3Qgb2YgdGhlIHVzZSBvZiBfX2lzX2NvbnN0X2V4cHIoKSBpbiBpOTE1X3JlZ19kZWZz\nLmggYXJlIGp1c3QgdG8NCj4gdGVzdCB3aGV0aGVyIGFuIGV4cHJlc3Npb24gaXMga25vd24gdG8g\nYmUgdHJ1ZS4gQmVjYXVzZSB0aG9zZSBjaGVja3MNCj4gYXJlIGFsbCBkb25lIGluIGEgQlVJTERf\nQlVHX09OX1pFUk8oKSwgcmVwbGFjZSB0aG9zZSB3aXRoDQo+IGlzX2NvbnN0X3RydWUoKS4NCg0K\nQW5vdGhlciBwbGFjZSB0aGF0IGNvdWxkIHVzZSBzdGF0aWNhbGx5X3RydWUoKSBhbmQgQlVJTERf\nQlVHX09OX01TRygpLg0KDQoJRGF2aWQNCg0KPiANCj4gUmVwbGFjZSB0aGUgZmV3IG90aGVyIG9j\nY3VycmVuY2VzIG9mIF9faXNfY29uc3RfZXhwcigpIHdpdGggaXNfY29uc3QoKS4NCj4gDQo+IFNp\nZ25lZC1vZmYtYnk6IFZpbmNlbnQgTWFpbGhvbCA8bWFpbGhvbC52aW5jZW50QHdhbmFkb28uZnI+\nDQo+IC0tLQ0KPiAgZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9yZWdfZGVmcy5oIHwgNDcgKysr\nKysrKysrKysrKysrKystLS0tLS0tLS0tLS0tLS0tLS0tDQo+ICAxIGZpbGUgY2hhbmdlZCwgMjIg\naW5zZXJ0aW9ucygrKSwgMjUgZGVsZXRpb25zKC0pDQo+IA0KPiBkaWZmIC0tZ2l0IGEvZHJpdmVy\ncy9ncHUvZHJtL2k5MTUvaTkxNV9yZWdfZGVmcy5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkx\nNV9yZWdfZGVmcy5oDQo+IGluZGV4IGUyNTFiY2MwYzg5ZjU3MTAxMjViYzcwZjA3ODUxYjJjYjk3\nOGM4OWMuLjZlZDJmYjljZjUwNmEzYmQ2NDY3YmEzMGY5ZDBlODYzZDYyNzYyZjMgMTAwNjQ0DQo+\nIC0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcmVnX2RlZnMuaA0KPiArKysgYi9kcml2\nZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3JlZ19kZWZzLmgNCj4gQEAgLTE5LDggKzE5LDcgQEANCj4g\nICAqLw0KPiAgI2RlZmluZSBSRUdfQklUKF9fbikJCQkJCQkJXA0KPiAgCSgodTMyKShCSVQoX19u\nKSArCQkJCQkJXA0KPiAtCSAgICAgICBCVUlMRF9CVUdfT05fWkVSTyhfX2lzX2NvbnN0ZXhwcihf\nX24pICYmCQlcDQo+IC0JCQkJICgoX19uKSA8IDAgfHwgKF9fbikgPiAzMSkpKSkNCj4gKwkgICAg\nICAgQlVJTERfQlVHX09OX1pFUk8oaXNfY29uc3RfdHJ1ZSgoX19uKSA8IDAgfHwgKF9fbikgPiAz\nMSkpKSkNCj4gDQo+ICAvKioNCj4gICAqIFJFR19CSVQ4KCkgLSBQcmVwYXJlIGEgdTggYml0IHZh\nbHVlDQo+IEBAIC0zMiw4ICszMSw3IEBADQo+ICAgKi8NCj4gICNkZWZpbmUgUkVHX0JJVDgoX19u\nKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwNCj4g\nIAkoKHU4KShCSVQoX19uKSArICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg\nICAgICAgICAgXA0KPiAtCSAgICAgICBCVUlMRF9CVUdfT05fWkVSTyhfX2lzX2NvbnN0ZXhwcihf\nX24pICYmICAgICAgICAgXA0KPiAtCQkJCSAoKF9fbikgPCAwIHx8IChfX24pID4gNykpKSkNCj4g\nKwkgICAgICBCVUlMRF9CVUdfT05fWkVSTyhpc19jb25zdF90cnVlKChfX24pIDwgMCB8fCAoX19u\nKSA+IDcpKSkpDQo+IA0KPiAgLyoqDQo+ICAgKiBSRUdfR0VOTUFTSygpIC0gUHJlcGFyZSBhIGNv\nbnRpbnVvdXMgdTMyIGJpdG1hc2sNCj4gQEAgLTQ2LDkgKzQ0LDkgQEANCj4gICAqLw0KPiAgI2Rl\nZmluZSBSRUdfR0VOTUFTSyhfX2hpZ2gsIF9fbG93KQkJCQkJXA0KPiAgCSgodTMyKShHRU5NQVNL\nKF9faGlnaCwgX19sb3cpICsJCQkJCVwNCj4gLQkgICAgICAgQlVJTERfQlVHX09OX1pFUk8oX19p\nc19jb25zdGV4cHIoX19oaWdoKSAmJglcDQo+IC0JCQkJIF9faXNfY29uc3RleHByKF9fbG93KSAm\nJgkJXA0KPiAtCQkJCSAoKF9fbG93KSA8IDAgfHwgKF9faGlnaCkgPiAzMSB8fCAoX19sb3cpID4g\nKF9faGlnaCkpKSkpDQo+ICsJICAgICAgIEJVSUxEX0JVR19PTl9aRVJPKGlzX2NvbnN0X3RydWUo\nKF9fbG93KSA8IDAgfHwJCVwNCj4gKwkJCQkJICAgICAgIChfX2hpZ2gpID4gMzEgfHwJCVwNCj4g\nKwkJCQkJICAgICAgIChfX2xvdykgPiAoX19oaWdoKSkpKSkNCj4gDQo+ICAvKioNCj4gICAqIFJF\nR19HRU5NQVNLNjQoKSAtIFByZXBhcmUgYSBjb250aW51b3VzIHU2NCBiaXRtYXNrDQo+IEBAIC02\nMSw5ICs1OSw5IEBADQo+ICAgKi8NCj4gICNkZWZpbmUgUkVHX0dFTk1BU0s2NChfX2hpZ2gsIF9f\nbG93KQkJCQkJXA0KPiAgCSgodTY0KShHRU5NQVNLX1VMTChfX2hpZ2gsIF9fbG93KSArCQkJCVwN\nCj4gLQkgICAgICAgQlVJTERfQlVHX09OX1pFUk8oX19pc19jb25zdGV4cHIoX19oaWdoKSAmJgkJ\nXA0KPiAtCQkJCSBfX2lzX2NvbnN0ZXhwcihfX2xvdykgJiYJCVwNCj4gLQkJCQkgKChfX2xvdykg\nPCAwIHx8IChfX2hpZ2gpID4gNjMgfHwgKF9fbG93KSA+IChfX2hpZ2gpKSkpKQ0KPiArCSAgICAg\nICBCVUlMRF9CVUdfT05fWkVSTyhpc19jb25zdF90cnVlKChfX2xvdykgPCAwIHx8CQlcDQo+ICsJ\nCQkJCSAgICAgICAoX19oaWdoKSA+IDYzIHx8CQlcDQo+ICsJCQkJCSAgICAgICAoX19sb3cpID4g\nKF9faGlnaCkpKSkpDQo+IA0KPiAgLyoqDQo+ICAgKiBSRUdfR0VOTUFTSzgoKSAtIFByZXBhcmUg\nYSBjb250aW51b3VzIHU4IGJpdG1hc2sNCj4gQEAgLTc2LDkgKzc0LDkgQEANCj4gICAqLw0KPiAg\nI2RlZmluZSBSRUdfR0VOTUFTSzgoX19oaWdoLCBfX2xvdykgICAgICAgICAgICAgICAgICAgICAg\nICAgICAgICAgICAgICAgXA0KPiAgCSgodTgpKEdFTk1BU0soX19oaWdoLCBfX2xvdykgKyAgICAg\nICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcDQo+IC0JICAgICAgIEJVSUxEX0JVR19PTl9a\nRVJPKF9faXNfY29uc3RleHByKF9faGlnaCkgJiYgICAgICBcDQo+IC0JCQkJIF9faXNfY29uc3Rl\neHByKF9fbG93KSAmJiAgICAgICAgICAgICAgIFwNCj4gLQkJCQkgKChfX2xvdykgPCAwIHx8IChf\nX2hpZ2gpID4gNyB8fCAoX19sb3cpID4gKF9faGlnaCkpKSkpDQo+ICsJICAgICAgQlVJTERfQlVH\nX09OX1pFUk8oaXNfY29uc3RfdHJ1ZSgoX19sb3cpIDwgMCB8fCAgICAgICAgICAgIFwNCj4gKwkJ\nCQkJICAgICAgKF9faGlnaCkgPiA3IHx8ICAgICAgICAgICBcDQo+ICsJCQkJCSAgICAgIChfX2xv\ndykgPiAoX19oaWdoKSkpKSkNCj4gDQo+ICAvKg0KPiAgICogTG9jYWwgaW50ZWdlciBjb25zdGFu\ndCBleHByZXNzaW9uIHZlcnNpb24gb2YgaXNfcG93ZXJfb2ZfMigpLg0KPiBAQCAtOTcsMTAgKzk1\nLDEwIEBADQo+ICAgKi8NCj4gICNkZWZpbmUgUkVHX0ZJRUxEX1BSRVAoX19tYXNrLCBfX3ZhbCkJ\nCQkJCQlcDQo+ICAJKCh1MzIpKCgoKHR5cGVvZihfX21hc2spKShfX3ZhbCkgPDwgX19iZl9zaGYo\nX19tYXNrKSkgJiAoX19tYXNrKSkgKwlcDQo+IC0JICAgICAgIEJVSUxEX0JVR19PTl9aRVJPKCFf\nX2lzX2NvbnN0ZXhwcihfX21hc2spKSArCQlcDQo+ICsJICAgICAgIEJVSUxEX0JVR19PTl9aRVJP\nKCFpc19jb25zdChfX21hc2spKSArCQkJCVwNCj4gIAkgICAgICAgQlVJTERfQlVHX09OX1pFUk8o\nKF9fbWFzaykgPT0gMCB8fCAoX19tYXNrKSA+IFUzMl9NQVgpICsJCVwNCj4gIAkgICAgICAgQlVJ\nTERfQlVHX09OX1pFUk8oIUlTX1BPV0VSX09GXzIoKF9fbWFzaykgKyAoMVVMTCA8PCBfX2JmX3No\nZihfX21hc2spKSkpICsgXA0KPiAtCSAgICAgICBCVUlMRF9CVUdfT05fWkVSTyhfX2J1aWx0",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173353678424625.mbox",
          "message_id": "<CAMZ6Rq+XhOb+yn5A1dHD=qkbB1_FQXMA7_ydBB4nPTSnys3jkA () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH 08/10] drm/i915/reg: replace __is_const_expr() by is_const_true() or is_const()",
          "date": "2024-12-05 15:56:35+00:00",
          "date_str": "Thu, 05 Dec 2024 15:56:35 +0000",
          "body": "On Thu. 5 Dec 2024 at 04:00, David Laight <David.Laight@aculab.com> wrote:\n> From: Vincent Mailhol\n> > Sent: 02 December 2024 17:34\n> >\n> > Most of the use of __is_const_expr() in i915_reg_defs.h are just to\n> > test whether an expression is known to be true. Because those checks\n> > are all done in a BUILD_BUG_ON_ZERO(), replace those with\n> > is_const_true().\n>\n> Another place that could use statically_true() and BUILD_BUG_ON_MSG().\n\nHere also, BUILD_BUG_ON_MSG() is not suitable because it does not\nreturn a value.\n\n__BUILD_BUG_ON_ZERO_MSG() could be used; but there is less benefit to\ndo this at a driver scope. In this i915_reg_defs.h,\nBUILD_BUG_ON_ZERO() is used 20 times. Adding an error message each\ntime will just make things ugly.\n\nIf we want more readable error messages here, the solution for me is\njust to redefine BUILD_BUG_ON_ZERO() to print a more meaningful error\nmessage by default. But this is not the scope of this series. I sent a\nseparate patch for this:\n\n  https://lore.kernel.org/all/20241205151316.1480255-2-mailhol.vincent@wanadoo.fr/\n\nConcerning statically_true() instead of is_const_true(), let me test,\nand if this works, then I will replace these in v2.\n\n\nYours sincerely,\nVincent Mailhol\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173347254215120.mbox",
          "message_id": "<CAMZ6Rq+XhOb+yn5A1dHD=qkbB1_FQXMA7_ydBB4nPTSnys3jkA () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH 08/10] drm/i915/reg: replace __is_const_expr() by is_const_true() or is_const()",
          "date": "2024-12-05 15:56:35+00:00",
          "date_str": "Thu, 05 Dec 2024 15:56:35 +0000",
          "body": "On Thu. 5 Dec 2024 at 04:00, David Laight <David.Laight@aculab.com> wrote:\n> From: Vincent Mailhol\n> > Sent: 02 December 2024 17:34\n> >\n> > Most of the use of __is_const_expr() in i915_reg_defs.h are just to\n> > test whether an expression is known to be true. Because those checks\n> > are all done in a BUILD_BUG_ON_ZERO(), replace those with\n> > is_const_true().\n>\n> Another place that could use statically_true() and BUILD_BUG_ON_MSG().\n\nHere also, BUILD_BUG_ON_MSG() is not suitable because it does not\nreturn a value.\n\n__BUILD_BUG_ON_ZERO_MSG() could be used; but there is less benefit to\ndo this at a driver scope. In this i915_reg_defs.h,\nBUILD_BUG_ON_ZERO() is used 20 times. Adding an error message each\ntime will just make things ugly.\n\nIf we want more readable error messages here, the solution for me is\njust to redefine BUILD_BUG_ON_ZERO() to print a more meaningful error\nmessage by default. But this is not the scope of this series. I sent a\nseparate patch for this:\n\n  https://lore.kernel.org/all/20241205151316.1480255-2-mailhol.vincent@wanadoo.fr/\n\nConcerning statically_true() instead of is_const_true(), let me test,\nand if this works, then I will replace these in v2.\n\n\nYours sincerely,\nVincent Mailhol",
          "year": "2024",
          "month": "12"
        }
      ],
      "primary_category": "sparse_internals"
    },
    {
      "subject": "RE: [PATCH 06/10] fortify: replace __is_constexpr() by is_const() in strlen()",
      "normalized_subject": "fortify: replace __is_constexpr() by is_const() in strlen()",
      "message_count": 9,
      "participants": [
        "David Laight",
        "Vincent Mailhol via B4 Relay",
        "Vincent Mailhol"
      ],
      "categories": [
        "compiler_compat",
        "address_space"
      ],
      "first_date": "2024-12-02T17:33:28+00:00",
      "last_date": "2024-12-05T15:53:56+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/12/173316072917702.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-6-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 06/10] fortify: replace __is_constexpr() by is_const() in strlen()",
          "date": "2024-12-02 17:33:28+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:28 +0000",
          "body": "From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n\nis_const() is a one to one replacement of __is_constexpr(). Do the\nreplacement so that __is_constexpr() can be removed.\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\n include/linux/fortify-string.h | 4 ++--\n 1 file changed, 2 insertions(+), 2 deletions(-)\n\ndiff --git a/include/linux/fortify-string.h b/include/linux/fortify-string.h\nindex 0d99bf11d260a3482bbe46e35c7553c0ccfb8b94..e3f2f772c5439ef71eb4a904b4ce27956bc69743 100644\n--- a/include/linux/fortify-string.h\n+++ b/include/linux/fortify-string.h\n@@ -254,8 +254,8 @@ __FORTIFY_INLINE __kernel_size_t strnlen(const char * const POS p, __kernel_size\n  * Returns number of characters in @p (NOT including the final NUL).\n  *\n  */\n-#define strlen(p)\t\t\t\t\t\t\t\\\n-\t__builtin_choose_expr(__is_constexpr(__builtin_strlen(p)),\t\\\n+#define strlen(p)\t\t\t\t\t\t\\\n+\t__builtin_choose_expr(is_const(__builtin_strlen(p)),\t\\\n \t\t__builtin_strlen(p), __fortify_strlen(p))\n __FORTIFY_INLINE __diagnose_as(__builtin_strlen, 1)\n __kernel_size_t __fortify_strlen(const char * const POS p)\n\n-- \n2.45.2\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173316072817696.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-6-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 06/10] fortify: replace __is_constexpr() by is_const() in strlen()",
          "date": "2024-12-02 17:33:28+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:28 +0000",
          "body": "From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n\nis_const() is a one to one replacement of __is_constexpr(). Do the\nreplacement so that __is_constexpr() can be removed.\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\n include/linux/fortify-string.h | 4 ++--\n 1 file changed, 2 insertions(+), 2 deletions(-)\n\ndiff --git a/include/linux/fortify-string.h b/include/linux/fortify-string.h\nindex 0d99bf11d260a3482bbe46e35c7553c0ccfb8b94..e3f2f772c5439ef71eb4a904b4ce27956bc69743 100644\n--- a/include/linux/fortify-string.h\n+++ b/include/linux/fortify-string.h\n@@ -254,8 +254,8 @@ __FORTIFY_INLINE __kernel_size_t strnlen(const char * const POS p, __kernel_size\n  * Returns number of characters in @p (NOT including the final NUL).\n  *\n  */\n-#define strlen(p)\t\t\t\t\t\t\t\\\n-\t__builtin_choose_expr(__is_constexpr(__builtin_strlen(p)),\t\\\n+#define strlen(p)\t\t\t\t\t\t\\\n+\t__builtin_choose_expr(is_const(__builtin_strlen(p)),\t\\\n \t\t__builtin_strlen(p), __fortify_strlen(p))\n __FORTIFY_INLINE __diagnose_as(__builtin_strlen, 1)\n __kernel_size_t __fortify_strlen(const char * const POS p)\n\n-- \n2.45.2\n\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173316072517659.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-6-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 06/10] fortify: replace __is_constexpr() by is_const() in strlen()",
          "date": "2024-12-02 17:33:28+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:28 +0000",
          "body": "From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n\nis_const() is a one to one replacement of __is_constexpr(). Do the\nreplacement so that __is_constexpr() can be removed.\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\n include/linux/fortify-string.h | 4 ++--\n 1 file changed, 2 insertions(+), 2 deletions(-)\n\ndiff --git a/include/linux/fortify-string.h b/include/linux/fortify-string.h\nindex 0d99bf11d260a3482bbe46e35c7553c0ccfb8b94..e3f2f772c5439ef71eb4a904b4ce27956bc69743 100644\n--- a/include/linux/fortify-string.h\n+++ b/include/linux/fortify-string.h\n@@ -254,8 +254,8 @@ __FORTIFY_INLINE __kernel_size_t strnlen(const char * const POS p, __kernel_size\n  * Returns number of characters in @p (NOT including the final NUL).\n  *\n  */\n-#define strlen(p)\t\t\t\t\t\t\t\\\n-\t__builtin_choose_expr(__is_constexpr(__builtin_strlen(p)),\t\\\n+#define strlen(p)\t\t\t\t\t\t\\\n+\t__builtin_choose_expr(is_const(__builtin_strlen(p)),\t\\\n \t\t__builtin_strlen(p), __fortify_strlen(p))\n __FORTIFY_INLINE __diagnose_as(__builtin_strlen, 1)\n __kernel_size_t __fortify_strlen(const char * const POS p)\n\n-- \n2.45.2\n\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173333856832345.mbox",
          "message_id": "<ad4482cc835543578862051431f5174f () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH 06/10] fortify: replace __is_constexpr() by is_const() in strlen()",
          "date": "2024-12-04 18:58:35+00:00",
          "date_str": "Wed, 04 Dec 2024 18:58:35 +0000",
          "body": "RnJvbTogVmluY2VudCBNYWlsaG9sDQo+IFNlbnQ6IDAyIERlY2VtYmVyIDIwMjQgMTc6MzMNCj4g\nDQo+IEZyb206IFZpbmNlbnQgTWFpbGhvbCA8bWFpbGhvbC52aW5jZW50QHdhbmFkb28uZnI+DQo+\nIA0KPiBpc19jb25zdCgpIGlzIGEgb25lIHRvIG9uZSByZXBsYWNlbWVudCBvZiBfX2lzX2NvbnN0\nZXhwcigpLiBEbyB0aGUNCj4gcmVwbGFjZW1lbnQgc28gdGhhdCBfX2lzX2NvbnN0ZXhwcigpIGNh\nbiBiZSByZW1vdmVkLg0KPiANCj4gU2lnbmVkLW9mZi1ieTogVmluY2VudCBNYWlsaG9sIDxtYWls\naG9sLnZpbmNlbnRAd2FuYWRvby5mcj4NCj4gLS0tDQo+ICBpbmNsdWRlL2xpbnV4L2ZvcnRpZnkt\nc3RyaW5nLmggfCA0ICsrLS0NCj4gIDEgZmlsZSBjaGFuZ2VkLCAyIGluc2VydGlvbnMoKyksIDIg\nZGVsZXRpb25zKC0pDQo+IA0KPiBkaWZmIC0tZ2l0IGEvaW5jbHVkZS9saW51eC9mb3J0aWZ5LXN0\ncmluZy5oIGIvaW5jbHVkZS9saW51eC9mb3J0aWZ5LXN0cmluZy5oDQo+IGluZGV4IDBkOTliZjEx\nZDI2MGEzNDgyYmJlNDZlMzVjNzU1M2MwY2NmYjhiOTQuLmUzZjJmNzcyYzU0MzllZjcxZWI0YTkw\nNGI0Y2UyNzk1NmJjNjk3NDMgMTAwNjQ0DQo+IC0tLSBhL2luY2x1ZGUvbGludXgvZm9ydGlmeS1z\ndHJpbmcuaA0KPiArKysgYi9pbmNsdWRlL2xpbnV4L2ZvcnRpZnktc3RyaW5nLmgNCj4gQEAgLTI1\nNCw4ICsyNTQsOCBAQCBfX0ZPUlRJRllfSU5MSU5FIF9fa2VybmVsX3NpemVfdCBzdHJubGVuKGNv\nbnN0IGNoYXIgKiBjb25zdCBQT1MgcCwgX19rZXJuZWxfc2l6ZQ0KPiAgICogUmV0dXJucyBudW1i\nZXIgb2YgY2hhcmFjdGVycyBpbiBAcCAoTk9UIGluY2x1ZGluZyB0aGUgZmluYWwgTlVMKS4NCj4g\nICAqDQo+ICAgKi8NCj4gLSNkZWZpbmUgc3RybGVuKHApCQkJCQkJCVwNCj4gLQlfX2J1aWx0aW5f\nY2hvb3NlX2V4cHIoX19pc19jb25zdGV4cHIoX19idWlsdGluX3N0cmxlbihwKSksCVwNCj4gKyNk\nZWZpbmUgc3RybGVuKHApCQkJCQkJXA0KPiArCV9fYnVpbHRpbl9jaG9vc2VfZXhwcihpc19jb25z\ndChfX2J1aWx0aW5fc3RybGVuKHApKSwJXA0KPiAgCQlfX2J1aWx0aW5fc3RybGVuKHApLCBfX2Zv\ncnRpZnlfc3RybGVuKHApKQ0KDQpJJ20gc3VyZSBMaW51cyBzdWdnZXN0ZWQgYSB3YXkgb2YgZG9p\nbmcgdGhhdCB3aXRob3V0IHJlcGxpY2F0aW5nDQp0aGUgX19idWlsdGluX3N0cmxlbigpLg0KDQpJ\nbmRlZWQgaXQgbWF5IGJlIHZhbGlkIHRvIGRvOg0KCWxlbiA9IF9fYnVpbHRpbl9zdHJsZW4ocCk7\nDQoJX19idWlsdGluX2NvbnN0YW50X3AobGVuKSA/IGxlbiA6IF9fZm9ydGlmeV9zdHJsZW4ocCk7\nDQoNCglEYXZpZA0KDQo+ICBfX0ZPUlRJRllfSU5MSU5FIF9fZGlhZ25vc2VfYXMoX19idWlsdGlu\nX3N0cmxlbiwgMSkNCj4gIF9fa2VybmVsX3NpemVfdCBfX2ZvcnRpZnlfc3RybGVuKGNvbnN0IGNo\nYXIgKiBjb25zdCBQT1MgcCkNCj4gDQo+IC0tDQo+IDIuNDUuMg0KPiANCj4gDQoNCi0NClJlZ2lz\ndGVyZWQgQWRkcmVzcyBMYWtlc2lkZSwgQnJhbWxleSBSb2FkLCBNb3VudCBGYXJtLCBNaWx0b24g\nS2V5bmVzLCBNSzEgMVBULCBVSw0KUmVnaXN0cmF0aW9uIE5vOiAxMzk3Mzg2IChXYWxlcykNCg==\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173333857132353.mbox",
          "message_id": "<ad4482cc835543578862051431f5174f () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH 06/10] fortify: replace __is_constexpr() by is_const() in strlen()",
          "date": "2024-12-04 18:58:35+00:00",
          "date_str": "Wed, 04 Dec 2024 18:58:35 +0000",
          "body": "RnJvbTogVmluY2VudCBNYWlsaG9sDQo+IFNlbnQ6IDAyIERlY2VtYmVyIDIwMjQgMTc6MzMNCj4g\nDQo+IEZyb206IFZpbmNlbnQgTWFpbGhvbCA8bWFpbGhvbC52aW5jZW50QHdhbmFkb28uZnI+DQo+\nIA0KPiBpc19jb25zdCgpIGlzIGEgb25lIHRvIG9uZSByZXBsYWNlbWVudCBvZiBfX2lzX2NvbnN0\nZXhwcigpLiBEbyB0aGUNCj4gcmVwbGFjZW1lbnQgc28gdGhhdCBfX2lzX2NvbnN0ZXhwcigpIGNh\nbiBiZSByZW1vdmVkLg0KPiANCj4gU2lnbmVkLW9mZi1ieTogVmluY2VudCBNYWlsaG9sIDxtYWls\naG9sLnZpbmNlbnRAd2FuYWRvby5mcj4NCj4gLS0tDQo+ICBpbmNsdWRlL2xpbnV4L2ZvcnRpZnkt\nc3RyaW5nLmggfCA0ICsrLS0NCj4gIDEgZmlsZSBjaGFuZ2VkLCAyIGluc2VydGlvbnMoKyksIDIg\nZGVsZXRpb25zKC0pDQo+IA0KPiBkaWZmIC0tZ2l0IGEvaW5jbHVkZS9saW51eC9mb3J0aWZ5LXN0\ncmluZy5oIGIvaW5jbHVkZS9saW51eC9mb3J0aWZ5LXN0cmluZy5oDQo+IGluZGV4IDBkOTliZjEx\nZDI2MGEzNDgyYmJlNDZlMzVjNzU1M2MwY2NmYjhiOTQuLmUzZjJmNzcyYzU0MzllZjcxZWI0YTkw\nNGI0Y2UyNzk1NmJjNjk3NDMgMTAwNjQ0DQo+IC0tLSBhL2luY2x1ZGUvbGludXgvZm9ydGlmeS1z\ndHJpbmcuaA0KPiArKysgYi9pbmNsdWRlL2xpbnV4L2ZvcnRpZnktc3RyaW5nLmgNCj4gQEAgLTI1\nNCw4ICsyNTQsOCBAQCBfX0ZPUlRJRllfSU5MSU5FIF9fa2VybmVsX3NpemVfdCBzdHJubGVuKGNv\nbnN0IGNoYXIgKiBjb25zdCBQT1MgcCwgX19rZXJuZWxfc2l6ZQ0KPiAgICogUmV0dXJucyBudW1i\nZXIgb2YgY2hhcmFjdGVycyBpbiBAcCAoTk9UIGluY2x1ZGluZyB0aGUgZmluYWwgTlVMKS4NCj4g\nICAqDQo+ICAgKi8NCj4gLSNkZWZpbmUgc3RybGVuKHApCQkJCQkJCVwNCj4gLQlfX2J1aWx0aW5f\nY2hvb3NlX2V4cHIoX19pc19jb25zdGV4cHIoX19idWlsdGluX3N0cmxlbihwKSksCVwNCj4gKyNk\nZWZpbmUgc3RybGVuKHApCQkJCQkJXA0KPiArCV9fYnVpbHRpbl9jaG9vc2VfZXhwcihpc19jb25z\ndChfX2J1aWx0aW5fc3RybGVuKHApKSwJXA0KPiAgCQlfX2J1aWx0aW5fc3RybGVuKHApLCBfX2Zv\ncnRpZnlfc3RybGVuKHApKQ0KDQpJJ20gc3VyZSBMaW51cyBzdWdnZXN0ZWQgYSB3YXkgb2YgZG9p\nbmcgdGhhdCB3aXRob3V0IHJlcGxpY2F0aW5nDQp0aGUgX19idWlsdGluX3N0cmxlbigpLg0KDQpJ\nbmRlZWQgaXQgbWF5IGJlIHZhbGlkIHRvIGRvOg0KCWxlbiA9IF9fYnVpbHRpbl9zdHJsZW4ocCk7\nDQoJX19idWlsdGluX2NvbnN0YW50X3AobGVuKSA/IGxlbiA6IF9fZm9ydGlmeV9zdHJsZW4ocCk7\nDQoNCglEYXZpZA0KDQo+ICBfX0ZPUlRJRllfSU5MSU5FIF9fZGlhZ25vc2VfYXMoX19idWlsdGlu\nX3N0cmxlbiwgMSkNCj4gIF9fa2VybmVsX3NpemVfdCBfX2ZvcnRpZnlfc3RybGVuKGNvbnN0IGNo\nYXIgKiBjb25zdCBQT1MgcCkNCj4gDQo+IC0tDQo+IDIuNDUuMg0KPiANCj4gDQoNCi0NClJlZ2lz\ndGVyZWQgQWRkcmVzcyBMYWtlc2lkZSwgQnJhbWxleSBSb2FkLCBNb3VudCBGYXJtLCBNaWx0b24g\nS2V5bmVzLCBNSzEgMVBULCBVSw0KUmVnaXN0cmF0aW9uIE5vOiAxMzk3Mzg2IChXYWxlcykNCg==\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173342711724272.mbox",
          "message_id": "<CAMZ6RqJMXKaa_xDcyweGwb+FqvANrpvrkRvnjh6_s-J1ApVmaA () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH 06/10] fortify: replace __is_constexpr() by is_const() in strlen()",
          "date": "2024-12-05 15:53:56+00:00",
          "date_str": "Thu, 05 Dec 2024 15:53:56 +0000",
          "body": "On Thu. 5 Dec. 2024 at 03:58, David Laight <David.Laight@aculab.com> wrote:\n> From: Vincent Mailhol\n> > Sent: 02 December 2024 17:33\n> >\n> > From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n> >\n> > is_const() is a one to one replacement of __is_constexpr(). Do the\n> > replacement so that __is_constexpr() can be removed.\n> >\n> > Signed-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n> > ---\n> >  include/linux/fortify-string.h | 4 ++--\n> >  1 file changed, 2 insertions(+), 2 deletions(-)\n> >\n> > diff --git a/include/linux/fortify-string.h b/include/linux/fortify-string.h\n> > index 0d99bf11d260a3482bbe46e35c7553c0ccfb8b94..e3f2f772c5439ef71eb4a904b4ce27956bc69743 100644\n> > --- a/include/linux/fortify-string.h\n> > +++ b/include/linux/fortify-string.h\n> > @@ -254,8 +254,8 @@ __FORTIFY_INLINE __kernel_size_t strnlen(const char * const POS p, __kernel_size\n> >   * Returns number of characters in @p (NOT including the final NUL).\n> >   *\n> >   */\n> > -#define strlen(p)                                                    \\\n> > -     __builtin_choose_expr(__is_constexpr(__builtin_strlen(p)),      \\\n> > +#define strlen(p)                                            \\\n> > +     __builtin_choose_expr(is_const(__builtin_strlen(p)),    \\\n> >               __builtin_strlen(p), __fortify_strlen(p))\n>\n> I'm sure Linus suggested a way of doing that without replicating\n> the __builtin_strlen().\n>\n> Indeed it may be valid to do:\n>         len = __builtin_strlen(p);\n>         __builtin_constant_p(len) ? len : __fortify_strlen(p);\n\nThen, wouldn't it be better for strlen() to be an inline function\ninstead of a macro?\n\n  __FORTIFY_INLINE __kernel_size_t strlen(const char *p)\n  {\n          __kernel_size_t ret = __builtin_strlen(p);\n\n          if (__builtin_constant_p(ret))\n                  return ret;\n          return __fortify_strlen(p);\n  }\n\nI tested it and it worked on an allyesconfig. So if I receive no\nobjections, strlen() will become an inline function in v2.\n\n\nYours sincerely,\nVincent Mailhol\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173347254915142.mbox",
          "message_id": "<CAMZ6RqJMXKaa_xDcyweGwb+FqvANrpvrkRvnjh6_s-J1ApVmaA () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH 06/10] fortify: replace __is_constexpr() by is_const() in strlen()",
          "date": "2024-12-05 15:53:56+00:00",
          "date_str": "Thu, 05 Dec 2024 15:53:56 +0000",
          "body": "On Thu. 5 Dec. 2024 at 03:58, David Laight <David.Laight@aculab.com> wrote:\n> From: Vincent Mailhol\n> > Sent: 02 December 2024 17:33\n> >\n> > From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n> >\n> > is_const() is a one to one replacement of __is_constexpr(). Do the\n> > replacement so that __is_constexpr() can be removed.\n> >\n> > Signed-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n> > ---\n> >  include/linux/fortify-string.h | 4 ++--\n> >  1 file changed, 2 insertions(+), 2 deletions(-)\n> >\n> > diff --git a/include/linux/fortify-string.h b/include/linux/fortify-string.h\n> > index 0d99bf11d260a3482bbe46e35c7553c0ccfb8b94..e3f2f772c5439ef71eb4a904b4ce27956bc69743 100644\n> > --- a/include/linux/fortify-string.h\n> > +++ b/include/linux/fortify-string.h\n> > @@ -254,8 +254,8 @@ __FORTIFY_INLINE __kernel_size_t strnlen(const char * const POS p, __kernel_size\n> >   * Returns number of characters in @p (NOT including the final NUL).\n> >   *\n> >   */\n> > -#define strlen(p)                                                    \\\n> > -     __builtin_choose_expr(__is_constexpr(__builtin_strlen(p)),      \\\n> > +#define strlen(p)                                            \\\n> > +     __builtin_choose_expr(is_const(__builtin_strlen(p)),    \\\n> >               __builtin_strlen(p), __fortify_strlen(p))\n>\n> I'm sure Linus suggested a way of doing that without replicating\n> the __builtin_strlen().\n>\n> Indeed it may be valid to do:\n>         len = __builtin_strlen(p);\n>         __builtin_constant_p(len) ? len : __fortify_strlen(p);\n\nThen, wouldn't it be better for strlen() to be an inline function\ninstead of a macro?\n\n  __FORTIFY_INLINE __kernel_size_t strlen(const char *p)\n  {\n          __kernel_size_t ret = __builtin_strlen(p);\n\n          if (__builtin_constant_p(ret))\n                  return ret;\n          return __fortify_strlen(p);\n  }\n\nI tested it and it worked on an allyesconfig. So if I receive no\nobjections, strlen() will become an inline function in v2.\n\n\nYours sincerely,\nVincent Mailhol",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173342711824273.mbox",
          "message_id": "<CAMZ6RqJMXKaa_xDcyweGwb+FqvANrpvrkRvnjh6_s-J1ApVmaA () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH 06/10] fortify: replace __is_constexpr() by is_const() in strlen()",
          "date": "2024-12-05 15:53:56+00:00",
          "date_str": "Thu, 05 Dec 2024 15:53:56 +0000",
          "body": "On Thu. 5 Dec. 2024 at 03:58, David Laight <David.Laight@aculab.com> wrote:\n> From: Vincent Mailhol\n> > Sent: 02 December 2024 17:33\n> >\n> > From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n> >\n> > is_const() is a one to one replacement of __is_constexpr(). Do the\n> > replacement so that __is_constexpr() can be removed.\n> >\n> > Signed-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n> > ---\n> >  include/linux/fortify-string.h | 4 ++--\n> >  1 file changed, 2 insertions(+), 2 deletions(-)\n> >\n> > diff --git a/include/linux/fortify-string.h b/include/linux/fortify-string.h\n> > index 0d99bf11d260a3482bbe46e35c7553c0ccfb8b94..e3f2f772c5439ef71eb4a904b4ce27956bc69743 100644\n> > --- a/include/linux/fortify-string.h\n> > +++ b/include/linux/fortify-string.h\n> > @@ -254,8 +254,8 @@ __FORTIFY_INLINE __kernel_size_t strnlen(const char * const POS p, __kernel_size\n> >   * Returns number of characters in @p (NOT including the final NUL).\n> >   *\n> >   */\n> > -#define strlen(p)                                                    \\\n> > -     __builtin_choose_expr(__is_constexpr(__builtin_strlen(p)),      \\\n> > +#define strlen(p)                                            \\\n> > +     __builtin_choose_expr(is_const(__builtin_strlen(p)),    \\\n> >               __builtin_strlen(p), __fortify_strlen(p))\n>\n> I'm sure Linus suggested a way of doing that without replicating\n> the __builtin_strlen().\n>\n> Indeed it may be valid to do:\n>         len = __builtin_strlen(p);\n>         __builtin_constant_p(len) ? len : __fortify_strlen(p);\n\nThen, wouldn't it be better for strlen() to be an inline function\ninstead of a macro?\n\n  __FORTIFY_INLINE __kernel_size_t strlen(const char *p)\n  {\n          __kernel_size_t ret = __builtin_strlen(p);\n\n          if (__builtin_constant_p(ret))\n                  return ret;\n          return __fortify_strlen(p);\n  }\n\nI tested it and it worked on an allyesconfig. So if I receive no\nobjections, strlen() will become an inline function in v2.\n\n\nYours sincerely,\nVincent Mailhol\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173342711424265.mbox",
          "message_id": "<CAMZ6RqJMXKaa_xDcyweGwb+FqvANrpvrkRvnjh6_s-J1ApVmaA () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH 06/10] fortify: replace __is_constexpr() by is_const() in strlen()",
          "date": "2024-12-05 15:53:56+00:00",
          "date_str": "Thu, 05 Dec 2024 15:53:56 +0000",
          "body": "On Thu. 5 Dec. 2024 at 03:58, David Laight <David.Laight@aculab.com> wrote:\n> From: Vincent Mailhol\n> > Sent: 02 December 2024 17:33\n> >\n> > From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n> >\n> > is_const() is a one to one replacement of __is_constexpr(). Do the\n> > replacement so that __is_constexpr() can be removed.\n> >\n> > Signed-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n> > ---\n> >  include/linux/fortify-string.h | 4 ++--\n> >  1 file changed, 2 insertions(+), 2 deletions(-)\n> >\n> > diff --git a/include/linux/fortify-string.h b/include/linux/fortify-string.h\n> > index 0d99bf11d260a3482bbe46e35c7553c0ccfb8b94..e3f2f772c5439ef71eb4a904b4ce27956bc69743 100644\n> > --- a/include/linux/fortify-string.h\n> > +++ b/include/linux/fortify-string.h\n> > @@ -254,8 +254,8 @@ __FORTIFY_INLINE __kernel_size_t strnlen(const char * const POS p, __kernel_size\n> >   * Returns number of characters in @p (NOT including the final NUL).\n> >   *\n> >   */\n> > -#define strlen(p)                                                    \\\n> > -     __builtin_choose_expr(__is_constexpr(__builtin_strlen(p)),      \\\n> > +#define strlen(p)                                            \\\n> > +     __builtin_choose_expr(is_const(__builtin_strlen(p)),    \\\n> >               __builtin_strlen(p), __fortify_strlen(p))\n>\n> I'm sure Linus suggested a way of doing that without replicating\n> the __builtin_strlen().\n>\n> Indeed it may be valid to do:\n>         len = __builtin_strlen(p);\n>         __builtin_constant_p(len) ? len : __fortify_strlen(p);\n\nThen, wouldn't it be better for strlen() to be an inline function\ninstead of a macro?\n\n  __FORTIFY_INLINE __kernel_size_t strlen(const char *p)\n  {\n          __kernel_size_t ret = __builtin_strlen(p);\n\n          if (__builtin_constant_p(ret))\n                  return ret;\n          return __fortify_strlen(p);\n  }\n\nI tested it and it worked on an allyesconfig. So if I receive no\nobjections, strlen() will become an inline function in v2.\n\n\nYours sincerely,\nVincent Mailhol\n",
          "year": "2024",
          "month": "12"
        }
      ],
      "primary_category": "address_space"
    },
    {
      "subject": "Re: [PATCH 05/10] minmax: simplify __clamp_once() by using is_const_false()",
      "normalized_subject": "minmax: simplify __clamp_once() by using is_const_false()",
      "message_count": 11,
      "participants": [
        "David Laight",
        "Vincent Mailhol via B4 Relay",
        "Vincent Mailhol"
      ],
      "categories": [
        "general",
        "compiler_compat",
        "type_system"
      ],
      "first_date": "2024-12-02T17:33:27+00:00",
      "last_date": "2024-12-09T12:32:14+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/12/173316080117828.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-5-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 05/10] minmax: simplify __clamp_once() by using is_const_false()",
          "date": "2024-12-02 17:33:27+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:27 +0000",
          "body": "From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n\nIn __clamp_once(),\n\n  __builtin_choose_expr(__is_constexpr((lo) > (hi)), (lo) <= (hi), true)\n\nis equivalent to:\n\n  !is_const_false((lo) <= (hi))\n\nApply is_const_false() to simplify __clamp_once().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\n include/linux/minmax.h | 3 +--\n 1 file changed, 1 insertion(+), 2 deletions(-)\n\ndiff --git a/include/linux/minmax.h b/include/linux/minmax.h\nindex 98008dd92153db10c672155bca93201ffabee994..431bf76ac460a11a2e4af23acd90c0d26e99c862 100644\n--- a/include/linux/minmax.h\n+++ b/include/linux/minmax.h\n@@ -111,8 +111,7 @@\n \t__auto_type uval = (val);\t\t\t\t\t\t\\\n \t__auto_type ulo = (lo);\t\t\t\t\t\t\t\\\n \t__auto_type uhi = (hi);\t\t\t\t\t\t\t\\\n-\tstatic_assert(__builtin_choose_expr(__is_constexpr((lo) > (hi)), \t\\\n-\t\t\t(lo) <= (hi), true),\t\t\t\t\t\\\n+\tstatic_assert(!is_const_false((lo) <= (hi)),\t\t\t\t\\\n \t\t\"clamp() low limit \" #lo \" greater than high limit \" #hi);\t\\\n \tBUILD_BUG_ON_MSG(!__types_ok3(val,lo,hi,uval,ulo,uhi),\t\t\t\\\n \t\t\"clamp(\"#val\", \"#lo\", \"#hi\") signedness error\");\t\t\\\n\n-- \n2.45.2\n\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173316862524072.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-5-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 05/10] minmax: simplify __clamp_once() by using is_const_false()",
          "date": "2024-12-02 17:33:27+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:27 +0000",
          "body": "From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n\nIn __clamp_once(),\n\n  __builtin_choose_expr(__is_constexpr((lo) > (hi)), (lo) <= (hi), true)\n\nis equivalent to:\n\n  !is_const_false((lo) <= (hi))\n\nApply is_const_false() to simplify __clamp_once().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\n include/linux/minmax.h | 3 +--\n 1 file changed, 1 insertion(+), 2 deletions(-)\n\ndiff --git a/include/linux/minmax.h b/include/linux/minmax.h\nindex 98008dd92153db10c672155bca93201ffabee994..431bf76ac460a11a2e4af23acd90c0d26e99c862 100644\n--- a/include/linux/minmax.h\n+++ b/include/linux/minmax.h\n@@ -111,8 +111,7 @@\n \t__auto_type uval = (val);\t\t\t\t\t\t\\\n \t__auto_type ulo = (lo);\t\t\t\t\t\t\t\\\n \t__auto_type uhi = (hi);\t\t\t\t\t\t\t\\\n-\tstatic_assert(__builtin_choose_expr(__is_constexpr((lo) > (hi)), \t\\\n-\t\t\t(lo) <= (hi), true),\t\t\t\t\t\\\n+\tstatic_assert(!is_const_false((lo) <= (hi)),\t\t\t\t\\\n \t\t\"clamp() low limit \" #lo \" greater than high limit \" #hi);\t\\\n \tBUILD_BUG_ON_MSG(!__types_ok3(val,lo,hi,uval,ulo,uhi),\t\t\t\\\n \t\t\"clamp(\"#val\", \"#lo\", \"#hi\") signedness error\");\t\t\\\n\n-- \n2.45.2\n\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173316072917706.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-5-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 05/10] minmax: simplify __clamp_once() by using is_const_false()",
          "date": "2024-12-02 17:33:27+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:27 +0000",
          "body": "From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n\nIn __clamp_once(),\n\n  __builtin_choose_expr(__is_constexpr((lo) > (hi)), (lo) <= (hi), true)\n\nis equivalent to:\n\n  !is_const_false((lo) <= (hi))\n\nApply is_const_false() to simplify __clamp_once().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\n include/linux/minmax.h | 3 +--\n 1 file changed, 1 insertion(+), 2 deletions(-)\n\ndiff --git a/include/linux/minmax.h b/include/linux/minmax.h\nindex 98008dd92153db10c672155bca93201ffabee994..431bf76ac460a11a2e4af23acd90c0d26e99c862 100644\n--- a/include/linux/minmax.h\n+++ b/include/linux/minmax.h\n@@ -111,8 +111,7 @@\n \t__auto_type uval = (val);\t\t\t\t\t\t\\\n \t__auto_type ulo = (lo);\t\t\t\t\t\t\t\\\n \t__auto_type uhi = (hi);\t\t\t\t\t\t\t\\\n-\tstatic_assert(__builtin_choose_expr(__is_constexpr((lo) > (hi)), \t\\\n-\t\t\t(lo) <= (hi), true),\t\t\t\t\t\\\n+\tstatic_assert(!is_const_false((lo) <= (hi)),\t\t\t\t\\\n \t\t\"clamp() low limit \" #lo \" greater than high limit \" #hi);\t\\\n \tBUILD_BUG_ON_MSG(!__types_ok3(val,lo,hi,uval,ulo,uhi),\t\t\t\\\n \t\t\"clamp(\"#val\", \"#lo\", \"#hi\") signedness error\");\t\t\\\n\n-- \n2.45.2\n\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173316072617685.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-5-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 05/10] minmax: simplify __clamp_once() by using is_const_false()",
          "date": "2024-12-02 17:33:27+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:27 +0000",
          "body": "From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n\nIn __clamp_once(),\n\n  __builtin_choose_expr(__is_constexpr((lo) > (hi)), (lo) <= (hi), true)\n\nis equivalent to:\n\n  !is_const_false((lo) <= (hi))\n\nApply is_const_false() to simplify __clamp_once().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\n include/linux/minmax.h | 3 +--\n 1 file changed, 1 insertion(+), 2 deletions(-)\n\ndiff --git a/include/linux/minmax.h b/include/linux/minmax.h\nindex 98008dd92153db10c672155bca93201ffabee994..431bf76ac460a11a2e4af23acd90c0d26e99c862 100644\n--- a/include/linux/minmax.h\n+++ b/include/linux/minmax.h\n@@ -111,8 +111,7 @@\n \t__auto_type uval = (val);\t\t\t\t\t\t\\\n \t__auto_type ulo = (lo);\t\t\t\t\t\t\t\\\n \t__auto_type uhi = (hi);\t\t\t\t\t\t\t\\\n-\tstatic_assert(__builtin_choose_expr(__is_constexpr((lo) > (hi)), \t\\\n-\t\t\t(lo) <= (hi), true),\t\t\t\t\t\\\n+\tstatic_assert(!is_const_false((lo) <= (hi)),\t\t\t\t\\\n \t\t\"clamp() low limit \" #lo \" greater than high limit \" #hi);\t\\\n \tBUILD_BUG_ON_MSG(!__types_ok3(val,lo,hi,uval,ulo,uhi),\t\t\t\\\n \t\t\"clamp(\"#val\", \"#lo\", \"#hi\") signedness error\");\t\t\\\n\n-- \n2.45.2\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173334606705000.mbox",
          "message_id": "<8b8262389bd6484586007d749132346f () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH 05/10] minmax: simplify __clamp_once() by using is_const_false()",
          "date": "2024-12-04 18:54:16+00:00",
          "date_str": "Wed, 04 Dec 2024 18:54:16 +0000",
          "body": "RnJvbTogVmluY2VudCBNYWlsaG9sDQo+IFNlbnQ6IDAyIERlY2VtYmVyIDIwMjQgMTc6MzMNCj4g\nDQo+IEluIF9fY2xhbXBfb25jZSgpLA0KPiANCj4gICBfX2J1aWx0aW5fY2hvb3NlX2V4cHIoX19p\nc19jb25zdGV4cHIoKGxvKSA+IChoaSkpLCAobG8pIDw9IChoaSksIHRydWUpDQo+IA0KPiBpcyBl\ncXVpdmFsZW50IHRvOg0KPiANCj4gICAhaXNfY29uc3RfZmFsc2UoKGxvKSA8PSAoaGkpKQ0KPiAN\nCj4gQXBwbHkgaXNfY29uc3RfZmFsc2UoKSB0byBzaW1wbGlmeSBfX2NsYW1wX29uY2UoKS4NCg0K\nVGhlcmUgaXMgYWxyZWFkeSBhIHBhdGNoICdmb3IgbmV4dCcgdGhhdCBjaGFuZ2VzIGl0IHVzZSBC\nVUlMRF9CVUdfT05fTVNHKCkNCmFuZCBzdGF0aWNhbGx5X3RydWUoKS4NCg0KSXQgaGFzIGZvdW5k\nIHNvbWUgJ2ludGVyZXN0aW5nJyBjb2RlLg0KDQoJRGF2aWQNCg0KPiANCj4gU2lnbmVkLW9mZi1i\neTogVmluY2VudCBNYWlsaG9sIDxtYWlsaG9sLnZpbmNlbnRAd2FuYWRvby5mcj4NCj4gLS0tDQo+\nICBpbmNsdWRlL2xpbnV4L21pbm1heC5oIHwgMyArLS0NCj4gIDEgZmlsZSBjaGFuZ2VkLCAxIGlu\nc2VydGlvbigrKSwgMiBkZWxldGlvbnMoLSkNCj4gDQo+IGRpZmYgLS1naXQgYS9pbmNsdWRlL2xp\nbnV4L21pbm1heC5oIGIvaW5jbHVkZS9saW51eC9taW5tYXguaA0KPiBpbmRleCA5ODAwOGRkOTIx\nNTNkYjEwYzY3MjE1NWJjYTkzMjAxZmZhYmVlOTk0Li40MzFiZjc2YWM0NjBhMTFhMmU0YWYyM2Fj\nZDkwYzBkMjZlOTljODYyIDEwMDY0NA0KPiAtLS0gYS9pbmNsdWRlL2xpbnV4L21pbm1heC5oDQo+\nICsrKyBiL2luY2x1ZGUvbGludXgvbWlubWF4LmgNCj4gQEAgLTExMSw4ICsxMTEsNyBAQA0KPiAg\nCV9fYXV0b190eXBlIHV2YWwgPSAodmFsKTsJCQkJCQlcDQo+ICAJX19hdXRvX3R5cGUgdWxvID0g\nKGxvKTsJCQkJCQkJXA0KPiAgCV9fYXV0b190eXBlIHVoaSA9IChoaSk7CQkJCQkJCVwNCj4gLQlz\ndGF0aWNfYXNzZXJ0KF9fYnVpbHRpbl9jaG9vc2VfZXhwcihfX2lzX2NvbnN0ZXhwcigobG8pID4g\nKGhpKSksIAlcDQo+IC0JCQkobG8pIDw9IChoaSksIHRydWUpLAkJCQkJXA0KPiArCXN0YXRpY19h\nc3NlcnQoIWlzX2NvbnN0X2ZhbHNlKChsbykgPD0gKGhpKSksCQkJCVwNCj4gIAkJImNsYW1wKCkg\nbG93IGxpbWl0ICIgI2xvICIgZ3JlYXRlciB0aGFuIGhpZ2ggbGltaXQgIiAjaGkpOwlcDQo+ICAJ\nQlVJTERfQlVHX09OX01TRyghX190eXBlc19vazModmFsLGxvLGhpLHV2YWwsdWxvLHVoaSksCQkJ\nXA0KPiAgCQkiY2xhbXAoIiN2YWwiLCAiI2xvIiwgIiNoaSIpIHNpZ25lZG5lc3MgZXJyb3IiKTsJ\nCVwNCj4gDQo+IC0tDQo+IDIuNDUuMg0KPiANCg0KLQ0KUmVnaXN0ZXJlZCBBZGRyZXNzIExha2Vz\naWRlLCBCcmFtbGV5IFJvYWQsIE1vdW50IEZhcm0sIE1pbHRvbiBLZXluZXMsIE1LMSAxUFQsIFVL\nDQpSZWdpc3RyYXRpb24gTm86IDEzOTczODYgKFdhbGVzKQ0K\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173333831132215.mbox",
          "message_id": "<8b8262389bd6484586007d749132346f () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH 05/10] minmax: simplify __clamp_once() by using is_const_false()",
          "date": "2024-12-04 18:54:16+00:00",
          "date_str": "Wed, 04 Dec 2024 18:54:16 +0000",
          "body": "RnJvbTogVmluY2VudCBNYWlsaG9sDQo+IFNlbnQ6IDAyIERlY2VtYmVyIDIwMjQgMTc6MzMNCj4g\nDQo+IEluIF9fY2xhbXBfb25jZSgpLA0KPiANCj4gICBfX2J1aWx0aW5fY2hvb3NlX2V4cHIoX19p\nc19jb25zdGV4cHIoKGxvKSA+IChoaSkpLCAobG8pIDw9IChoaSksIHRydWUpDQo+IA0KPiBpcyBl\ncXVpdmFsZW50IHRvOg0KPiANCj4gICAhaXNfY29uc3RfZmFsc2UoKGxvKSA8PSAoaGkpKQ0KPiAN\nCj4gQXBwbHkgaXNfY29uc3RfZmFsc2UoKSB0byBzaW1wbGlmeSBfX2NsYW1wX29uY2UoKS4NCg0K\nVGhlcmUgaXMgYWxyZWFkeSBhIHBhdGNoICdmb3IgbmV4dCcgdGhhdCBjaGFuZ2VzIGl0IHVzZSBC\nVUlMRF9CVUdfT05fTVNHKCkNCmFuZCBzdGF0aWNhbGx5X3RydWUoKS4NCg0KSXQgaGFzIGZvdW5k\nIHNvbWUgJ2ludGVyZXN0aW5nJyBjb2RlLg0KDQoJRGF2aWQNCg0KPiANCj4gU2lnbmVkLW9mZi1i\neTogVmluY2VudCBNYWlsaG9sIDxtYWlsaG9sLnZpbmNlbnRAd2FuYWRvby5mcj4NCj4gLS0tDQo+\nICBpbmNsdWRlL2xpbnV4L21pbm1heC5oIHwgMyArLS0NCj4gIDEgZmlsZSBjaGFuZ2VkLCAxIGlu\nc2VydGlvbigrKSwgMiBkZWxldGlvbnMoLSkNCj4gDQo+IGRpZmYgLS1naXQgYS9pbmNsdWRlL2xp\nbnV4L21pbm1heC5oIGIvaW5jbHVkZS9saW51eC9taW5tYXguaA0KPiBpbmRleCA5ODAwOGRkOTIx\nNTNkYjEwYzY3MjE1NWJjYTkzMjAxZmZhYmVlOTk0Li40MzFiZjc2YWM0NjBhMTFhMmU0YWYyM2Fj\nZDkwYzBkMjZlOTljODYyIDEwMDY0NA0KPiAtLS0gYS9pbmNsdWRlL2xpbnV4L21pbm1heC5oDQo+\nICsrKyBiL2luY2x1ZGUvbGludXgvbWlubWF4LmgNCj4gQEAgLTExMSw4ICsxMTEsNyBAQA0KPiAg\nCV9fYXV0b190eXBlIHV2YWwgPSAodmFsKTsJCQkJCQlcDQo+ICAJX19hdXRvX3R5cGUgdWxvID0g\nKGxvKTsJCQkJCQkJXA0KPiAgCV9fYXV0b190eXBlIHVoaSA9IChoaSk7CQkJCQkJCVwNCj4gLQlz\ndGF0aWNfYXNzZXJ0KF9fYnVpbHRpbl9jaG9vc2VfZXhwcihfX2lzX2NvbnN0ZXhwcigobG8pID4g\nKGhpKSksIAlcDQo+IC0JCQkobG8pIDw9IChoaSksIHRydWUpLAkJCQkJXA0KPiArCXN0YXRpY19h\nc3NlcnQoIWlzX2NvbnN0X2ZhbHNlKChsbykgPD0gKGhpKSksCQkJCVwNCj4gIAkJImNsYW1wKCkg\nbG93IGxpbWl0ICIgI2xvICIgZ3JlYXRlciB0aGFuIGhpZ2ggbGltaXQgIiAjaGkpOwlcDQo+ICAJ\nQlVJTERfQlVHX09OX01TRyghX190eXBlc19vazModmFsLGxvLGhpLHV2YWwsdWxvLHVoaSksCQkJ\nXA0KPiAgCQkiY2xhbXAoIiN2YWwiLCAiI2xvIiwgIiNoaSIpIHNpZ25lZG5lc3MgZXJyb3IiKTsJ\nCVwNCj4gDQo+IC0tDQo+IDIuNDUuMg0KPiANCg0KLQ0KUmVnaXN0ZXJlZCBBZGRyZXNzIExha2Vz\naWRlLCBCcmFtbGV5IFJvYWQsIE1vdW50IEZhcm0sIE1pbHRvbiBLZXluZXMsIE1LMSAxUFQsIFVL\nDQpSZWdpc3RyYXRpb24gTm86IDEzOTczODYgKFdhbGVzKQ0K\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173333831232218.mbox",
          "message_id": "<8b8262389bd6484586007d749132346f () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH 05/10] minmax: simplify __clamp_once() by using is_const_false()",
          "date": "2024-12-04 18:54:16+00:00",
          "date_str": "Wed, 04 Dec 2024 18:54:16 +0000",
          "body": "RnJvbTogVmluY2VudCBNYWlsaG9sDQo+IFNlbnQ6IDAyIERlY2VtYmVyIDIwMjQgMTc6MzMNCj4g\nDQo+IEluIF9fY2xhbXBfb25jZSgpLA0KPiANCj4gICBfX2J1aWx0aW5fY2hvb3NlX2V4cHIoX19p\nc19jb25zdGV4cHIoKGxvKSA+IChoaSkpLCAobG8pIDw9IChoaSksIHRydWUpDQo+IA0KPiBpcyBl\ncXVpdmFsZW50IHRvOg0KPiANCj4gICAhaXNfY29uc3RfZmFsc2UoKGxvKSA8PSAoaGkpKQ0KPiAN\nCj4gQXBwbHkgaXNfY29uc3RfZmFsc2UoKSB0byBzaW1wbGlmeSBfX2NsYW1wX29uY2UoKS4NCg0K\nVGhlcmUgaXMgYWxyZWFkeSBhIHBhdGNoICdmb3IgbmV4dCcgdGhhdCBjaGFuZ2VzIGl0IHVzZSBC\nVUlMRF9CVUdfT05fTVNHKCkNCmFuZCBzdGF0aWNhbGx5X3RydWUoKS4NCg0KSXQgaGFzIGZvdW5k\nIHNvbWUgJ2ludGVyZXN0aW5nJyBjb2RlLg0KDQoJRGF2aWQNCg0KPiANCj4gU2lnbmVkLW9mZi1i\neTogVmluY2VudCBNYWlsaG9sIDxtYWlsaG9sLnZpbmNlbnRAd2FuYWRvby5mcj4NCj4gLS0tDQo+\nICBpbmNsdWRlL2xpbnV4L21pbm1heC5oIHwgMyArLS0NCj4gIDEgZmlsZSBjaGFuZ2VkLCAxIGlu\nc2VydGlvbigrKSwgMiBkZWxldGlvbnMoLSkNCj4gDQo+IGRpZmYgLS1naXQgYS9pbmNsdWRlL2xp\nbnV4L21pbm1heC5oIGIvaW5jbHVkZS9saW51eC9taW5tYXguaA0KPiBpbmRleCA5ODAwOGRkOTIx\nNTNkYjEwYzY3MjE1NWJjYTkzMjAxZmZhYmVlOTk0Li40MzFiZjc2YWM0NjBhMTFhMmU0YWYyM2Fj\nZDkwYzBkMjZlOTljODYyIDEwMDY0NA0KPiAtLS0gYS9pbmNsdWRlL2xpbnV4L21pbm1heC5oDQo+\nICsrKyBiL2luY2x1ZGUvbGludXgvbWlubWF4LmgNCj4gQEAgLTExMSw4ICsxMTEsNyBAQA0KPiAg\nCV9fYXV0b190eXBlIHV2YWwgPSAodmFsKTsJCQkJCQlcDQo+ICAJX19hdXRvX3R5cGUgdWxvID0g\nKGxvKTsJCQkJCQkJXA0KPiAgCV9fYXV0b190eXBlIHVoaSA9IChoaSk7CQkJCQkJCVwNCj4gLQlz\ndGF0aWNfYXNzZXJ0KF9fYnVpbHRpbl9jaG9vc2VfZXhwcihfX2lzX2NvbnN0ZXhwcigobG8pID4g\nKGhpKSksIAlcDQo+IC0JCQkobG8pIDw9IChoaSksIHRydWUpLAkJCQkJXA0KPiArCXN0YXRpY19h\nc3NlcnQoIWlzX2NvbnN0X2ZhbHNlKChsbykgPD0gKGhpKSksCQkJCVwNCj4gIAkJImNsYW1wKCkg\nbG93IGxpbWl0ICIgI2xvICIgZ3JlYXRlciB0aGFuIGhpZ2ggbGltaXQgIiAjaGkpOwlcDQo+ICAJ\nQlVJTERfQlVHX09OX01TRyghX190eXBlc19vazModmFsLGxvLGhpLHV2YWwsdWxvLHVoaSksCQkJ\nXA0KPiAgCQkiY2xhbXAoIiN2YWwiLCAiI2xvIiwgIiNoaSIpIHNpZ25lZG5lc3MgZXJyb3IiKTsJ\nCVwNCj4gDQo+IC0tDQo+IDIuNDUuMg0KPiANCg0KLQ0KUmVnaXN0ZXJlZCBBZGRyZXNzIExha2Vz\naWRlLCBCcmFtbGV5IFJvYWQsIE1vdW50IEZhcm0sIE1pbHRvbiBLZXluZXMsIE1LMSAxUFQsIFVL\nDQpSZWdpc3RyYXRpb24gTm86IDEzOTczODYgKFdhbGVzKQ0K\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173361499818380.mbox",
          "message_id": "<CAMZ6RqJPvbSr5i8N4Dm=2N6D8uSzefCM3TyK8HBNNNrybo5f2Q () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH 05/10] minmax: simplify __clamp_once() by using is_const_false()",
          "date": "2024-12-05 15:52:20+00:00",
          "date_str": "Thu, 05 Dec 2024 15:52:20 +0000",
          "body": "On Thu. 5 Dec. 2024 at 03:54, David Laight <David.Laight@aculab.com> wrote:\n> From: Vincent Mailhol\n> > Sent: 02 December 2024 17:33\n> >\n> > In __clamp_once(),\n> >\n> >   __builtin_choose_expr(__is_constexpr((lo) > (hi)), (lo) <= (hi), true)\n> >\n> > is equivalent to:\n> >\n> >   !is_const_false((lo) <= (hi))\n> >\n> > Apply is_const_false() to simplify __clamp_once().\n>\n> There is already a patch 'for next' that changes it use BUILD_BUG_ON_MSG()\n> and statically_true().\n\nFound it!\n\n  https://lore.kernel.org/all/34d53778977747f19cce2abb287bb3e6@AcuMS.aculab.com/\n\nI think the easiest would be for me to cherry pick this patch. So that\nregardless which series is merged first, no conflict will occur, the\npatch will just be skipped the second time it is encountered.\n\nDoes this work for you?\n\n\nYours sincerely,\nVincent Mailhol",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173345172705133.mbox",
          "message_id": "<CAMZ6RqJPvbSr5i8N4Dm=2N6D8uSzefCM3TyK8HBNNNrybo5f2Q () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH 05/10] minmax: simplify __clamp_once() by using is_const_false()",
          "date": "2024-12-05 15:52:20+00:00",
          "date_str": "Thu, 05 Dec 2024 15:52:20 +0000",
          "body": "On Thu. 5 Dec. 2024 at 03:54, David Laight <David.Laight@aculab.com> wrote:\n> From: Vincent Mailhol\n> > Sent: 02 December 2024 17:33\n> >\n> > In __clamp_once(),\n> >\n> >   __builtin_choose_expr(__is_constexpr((lo) > (hi)), (lo) <= (hi), true)\n> >\n> > is equivalent to:\n> >\n> >   !is_const_false((lo) <= (hi))\n> >\n> > Apply is_const_false() to simplify __clamp_once().\n>\n> There is already a patch 'for next' that changes it use BUILD_BUG_ON_MSG()\n> and statically_true().\n\nFound it!\n\n  https://lore.kernel.org/all/34d53778977747f19cce2abb287bb3e6@AcuMS.aculab.com/\n\nI think the easiest would be for me to cherry pick this patch. So that\nregardless which series is merged first, no conflict will occur, the\npatch will just be skipped the second time it is encountered.\n\nDoes this work for you?\n\n\nYours sincerely,\nVincent Mailhol\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173374735209107.mbox",
          "message_id": "<CAMZ6RqLMXaAej75eXrLgvt-Co1yyEg0QNJSxPovzLzb7vdxmdQ () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "vincent.mailhol () gmail ! com",
          "subject": "Re: [PATCH 05/10] minmax: simplify __clamp_once() by using is_const_false()",
          "date": "2024-12-09 12:32:14+00:00",
          "date_str": "Mon, 09 Dec 2024 12:32:14 +0000",
          "body": "On Fri. 6 Dec. 2024 at 00:52, Vincent Mailhol\n<mailhol.vincent@wanadoo.fr> wrote:\n> On Thu. 5 Dec. 2024 at 03:54, David Laight <David.Laight@aculab.com> wrote:\n> > From: Vincent Mailhol\n> > > Sent: 02 December 2024 17:33\n> > >\n> > > In __clamp_once(),\n> > >\n> > >   __builtin_choose_expr(__is_constexpr((lo) > (hi)), (lo) <= (hi), true)\n> > >\n> > > is equivalent to:\n> > >\n> > >   !is_const_false((lo) <= (hi))\n> > >\n> > > Apply is_const_false() to simplify __clamp_once().\n> >\n> > There is already a patch 'for next' that changes it use BUILD_BUG_ON_MSG()\n> > and statically_true().\n>\n> Found it!\n>\n>   https://lore.kernel.org/all/34d53778977747f19cce2abb287bb3e6@AcuMS.aculab.com/\n\nI picked up your patch and got two build errors on an allyesconfig.\n\nYou already sent a patch for the first one:\n\n  https://lore.kernel.org/all/33893212b1cc4a418cec09aeeed0a9fc@AcuMS.aculab.com/\n\nFor the second one, I submitted a patch here:\n\n  https://lore.kernel.org/all/20241209-nfs4state_fix-v1-1-7a66819c60f0@wanadoo.fr/\n\nI will wait for those two to appear in Andrew's mm tree first, and\nonly then, I will send a v2 (that will be rebased on the mm tree to\nget your change).\n\nMeanwhile, I think this series will be on hiatus.\n\n\nYours sincerely,\nVincent Mailhol",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173374742409219.mbox",
          "message_id": "<CAMZ6RqLMXaAej75eXrLgvt-Co1yyEg0QNJSxPovzLzb7vdxmdQ () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "vincent.mailhol () gmail ! com",
          "subject": "Re: [PATCH 05/10] minmax: simplify __clamp_once() by using is_const_false()",
          "date": "2024-12-09 12:32:14+00:00",
          "date_str": "Mon, 09 Dec 2024 12:32:14 +0000",
          "body": "On Fri. 6 Dec. 2024 at 00:52, Vincent Mailhol\n<mailhol.vincent@wanadoo.fr> wrote:\n> On Thu. 5 Dec. 2024 at 03:54, David Laight <David.Laight@aculab.com> wrote:\n> > From: Vincent Mailhol\n> > > Sent: 02 December 2024 17:33\n> > >\n> > > In __clamp_once(),\n> > >\n> > >   __builtin_choose_expr(__is_constexpr((lo) > (hi)), (lo) <= (hi), true)\n> > >\n> > > is equivalent to:\n> > >\n> > >   !is_const_false((lo) <= (hi))\n> > >\n> > > Apply is_const_false() to simplify __clamp_once().\n> >\n> > There is already a patch 'for next' that changes it use BUILD_BUG_ON_MSG()\n> > and statically_true().\n>\n> Found it!\n>\n>   https://lore.kernel.org/all/34d53778977747f19cce2abb287bb3e6@AcuMS.aculab.com/\n\nI picked up your patch and got two build errors on an allyesconfig.\n\nYou already sent a patch for the first one:\n\n  https://lore.kernel.org/all/33893212b1cc4a418cec09aeeed0a9fc@AcuMS.aculab.com/\n\nFor the second one, I submitted a patch here:\n\n  https://lore.kernel.org/all/20241209-nfs4state_fix-v1-1-7a66819c60f0@wanadoo.fr/\n\nI will wait for those two to appear in Andrew's mm tree first, and\nonly then, I will send a v2 (that will be rebased on the mm tree to\nget your change).\n\nMeanwhile, I think this series will be on hiatus.\n\n\nYours sincerely,\nVincent Mailhol\n",
          "year": "2024",
          "month": "12"
        }
      ],
      "primary_category": "general"
    },
    {
      "subject": "Re: [PATCH 04/10] linux/bits.h: simplify GENMASK_INPUT_CHECK() by using is_const_true()",
      "normalized_subject": "linux/bits.h: simplify GENMASK_INPUT_CHECK() by using is_const_true()",
      "message_count": 9,
      "participants": [
        "David Laight",
        "Vincent Mailhol via B4 Relay",
        "Vincent Mailhol"
      ],
      "categories": [
        "general",
        "compiler_compat",
        "sparse_internals"
      ],
      "first_date": "2024-12-02T17:33:26+00:00",
      "last_date": "2024-12-05T15:49:43+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/12/173316072017633.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-4-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 04/10] linux/bits.h: simplify GENMASK_INPUT_CHECK() by using is_const_true()",
          "date": "2024-12-02 17:33:26+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:26 +0000",
          "body": "From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n\nIn GENMASK_INPUT_CHECK(),\n\n  __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n\nis equivalent to:\n\n  is_const_true((l) > (h))\n\nApply is_const_true() to simplify GENMASK_INPUT_CHECK().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\nThis change passes the unit tests from CONFIG_BITS_TEST, including the\nextra negative tests provided under #ifdef TEST_GENMASK_FAILURES [1].\n\n[1] commit 6d511020e13d (\"lib/test_bits.c: add tests of GENMASK\")\nLink: https://git.kernel.org/torvalds/c/6d511020e13d\n---\n include/linux/bits.h | 5 ++---\n 1 file changed, 2 insertions(+), 3 deletions(-)\n\ndiff --git a/include/linux/bits.h b/include/linux/bits.h\nindex 60044b6088172b3f26aa3f17cdaede9786863dae..ef0119e6179e1ca95345a3d4d3327ba19633028e 100644\n--- a/include/linux/bits.h\n+++ b/include/linux/bits.h\n@@ -20,9 +20,8 @@\n  */\n #if !defined(__ASSEMBLY__)\n #include <linux/build_bug.h>\n-#define GENMASK_INPUT_CHECK(h, l) \\\n-\t(BUILD_BUG_ON_ZERO(__builtin_choose_expr( \\\n-\t\t__is_constexpr((l) > (h)), (l) > (h), 0)))\n+#include <linux/compiler.h>\n+#define GENMASK_INPUT_CHECK(h, l) BUILD_BUG_ON_ZERO(is_const_true((l) > (h)))\n #else\n /*\n  * BUILD_BUG_ON_ZERO is not available in h files included from asm files,\n\n-- \n2.45.2\n\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173316072017634.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-4-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 04/10] linux/bits.h: simplify GENMASK_INPUT_CHECK() by using is_const_true()",
          "date": "2024-12-02 17:33:26+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:26 +0000",
          "body": "From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n\nIn GENMASK_INPUT_CHECK(),\n\n  __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n\nis equivalent to:\n\n  is_const_true((l) > (h))\n\nApply is_const_true() to simplify GENMASK_INPUT_CHECK().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\nThis change passes the unit tests from CONFIG_BITS_TEST, including the\nextra negative tests provided under #ifdef TEST_GENMASK_FAILURES [1].\n\n[1] commit 6d511020e13d (\"lib/test_bits.c: add tests of GENMASK\")\nLink: https://git.kernel.org/torvalds/c/6d511020e13d\n---\n include/linux/bits.h | 5 ++---\n 1 file changed, 2 insertions(+), 3 deletions(-)\n\ndiff --git a/include/linux/bits.h b/include/linux/bits.h\nindex 60044b6088172b3f26aa3f17cdaede9786863dae..ef0119e6179e1ca95345a3d4d3327ba19633028e 100644\n--- a/include/linux/bits.h\n+++ b/include/linux/bits.h\n@@ -20,9 +20,8 @@\n  */\n #if !defined(__ASSEMBLY__)\n #include <linux/build_bug.h>\n-#define GENMASK_INPUT_CHECK(h, l) \\\n-\t(BUILD_BUG_ON_ZERO(__builtin_choose_expr( \\\n-\t\t__is_constexpr((l) > (h)), (l) > (h), 0)))\n+#include <linux/compiler.h>\n+#define GENMASK_INPUT_CHECK(h, l) BUILD_BUG_ON_ZERO(is_const_true((l) > (h)))\n #else\n /*\n  * BUILD_BUG_ON_ZERO is not available in h files included from asm files,\n\n-- \n2.45.2\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173316073517716.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-4-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 04/10] linux/bits.h: simplify GENMASK_INPUT_CHECK() by using is_const_true()",
          "date": "2024-12-02 17:33:26+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:26 +0000",
          "body": "From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n\nIn GENMASK_INPUT_CHECK(),\n\n  __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n\nis equivalent to:\n\n  is_const_true((l) > (h))\n\nApply is_const_true() to simplify GENMASK_INPUT_CHECK().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\nThis change passes the unit tests from CONFIG_BITS_TEST, including the\nextra negative tests provided under #ifdef TEST_GENMASK_FAILURES [1].\n\n[1] commit 6d511020e13d (\"lib/test_bits.c: add tests of GENMASK\")\nLink: https://git.kernel.org/torvalds/c/6d511020e13d\n---\n include/linux/bits.h | 5 ++---\n 1 file changed, 2 insertions(+), 3 deletions(-)\n\ndiff --git a/include/linux/bits.h b/include/linux/bits.h\nindex 60044b6088172b3f26aa3f17cdaede9786863dae..ef0119e6179e1ca95345a3d4d3327ba19633028e 100644\n--- a/include/linux/bits.h\n+++ b/include/linux/bits.h\n@@ -20,9 +20,8 @@\n  */\n #if !defined(__ASSEMBLY__)\n #include <linux/build_bug.h>\n-#define GENMASK_INPUT_CHECK(h, l) \\\n-\t(BUILD_BUG_ON_ZERO(__builtin_choose_expr( \\\n-\t\t__is_constexpr((l) > (h)), (l) > (h), 0)))\n+#include <linux/compiler.h>\n+#define GENMASK_INPUT_CHECK(h, l) BUILD_BUG_ON_ZERO(is_const_true((l) > (h)))\n #else\n /*\n  * BUILD_BUG_ON_ZERO is not available in h files included from asm files,\n\n-- \n2.45.2\n\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173316840623890.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-4-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 04/10] linux/bits.h: simplify GENMASK_INPUT_CHECK() by using is_const_true()",
          "date": "2024-12-02 17:33:26+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:26 +0000",
          "body": "From: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n\nIn GENMASK_INPUT_CHECK(),\n\n  __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n\nis equivalent to:\n\n  is_const_true((l) > (h))\n\nApply is_const_true() to simplify GENMASK_INPUT_CHECK().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\nThis change passes the unit tests from CONFIG_BITS_TEST, including the\nextra negative tests provided under #ifdef TEST_GENMASK_FAILURES [1].\n\n[1] commit 6d511020e13d (\"lib/test_bits.c: add tests of GENMASK\")\nLink: https://git.kernel.org/torvalds/c/6d511020e13d\n---\n include/linux/bits.h | 5 ++---\n 1 file changed, 2 insertions(+), 3 deletions(-)\n\ndiff --git a/include/linux/bits.h b/include/linux/bits.h\nindex 60044b6088172b3f26aa3f17cdaede9786863dae..ef0119e6179e1ca95345a3d4d3327ba19633028e 100644\n--- a/include/linux/bits.h\n+++ b/include/linux/bits.h\n@@ -20,9 +20,8 @@\n  */\n #if !defined(__ASSEMBLY__)\n #include <linux/build_bug.h>\n-#define GENMASK_INPUT_CHECK(h, l) \\\n-\t(BUILD_BUG_ON_ZERO(__builtin_choose_expr( \\\n-\t\t__is_constexpr((l) > (h)), (l) > (h), 0)))\n+#include <linux/compiler.h>\n+#define GENMASK_INPUT_CHECK(h, l) BUILD_BUG_ON_ZERO(is_const_true((l) > (h)))\n #else\n /*\n  * BUILD_BUG_ON_ZERO is not available in h files included from asm files,\n\n-- \n2.45.2\n\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173333823832153.mbox",
          "message_id": "<dff4cdd543104e3792e4856375f310c1 () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH 04/10] linux/bits.h: simplify GENMASK_INPUT_CHECK() by using is_const_true()",
          "date": "2024-12-04 18:52:10+00:00",
          "date_str": "Wed, 04 Dec 2024 18:52:10 +0000",
          "body": "RnJvbTogVmluY2VudCBNYWlsaG9sDQo+IFNlbnQ6IDAyIERlY2VtYmVyIDIwMjQgMTc6MzMNCj4g\nDQo+ICAgX19idWlsdGluX2Nob29zZV9leHByKF9faXNfY29uc3RleHByKChsKSA+IChoKSksIChs\nKSA+IChoKSwgMCkNCj4gDQo+IGlzIGVxdWl2YWxlbnQgdG86DQo+IA0KPiAgIGlzX2NvbnN0X3Ry\ndWUoKGwpID4gKGgpKQ0KDQpDaGFuZ2UgaXQgdG8gQlVJTERfQlVHX09OX01TRyhzdGF0aWNhbGx5\nX3RydWUoKGwpIDwgKGgpKSwgImVycm9yIG1lc3NhZ2UiKQ0KDQphbmQgdGhlbiBmaXggYWxsIHRo\nZSBmYWxsb3V0IDotKQ0KDQoJRGF2aWQNCg0KPiANCj4gQXBwbHkgaXNfY29uc3RfdHJ1ZSgpIHRv\nIHNpbXBsaWZ5IEdFTk1BU0tfSU5QVVRfQ0hFQ0soKS4NCj4gDQo+IFNpZ25lZC1vZmYtYnk6IFZp\nbmNlbnQgTWFpbGhvbCA8bWFpbGhvbC52aW5jZW50QHdhbmFkb28uZnI+DQo+IC0tLQ0KPiBUaGlz\nIGNoYW5nZSBwYXNzZXMgdGhlIHVuaXQgdGVzdHMgZnJvbSBDT05GSUdfQklUU19URVNULCBpbmNs\ndWRpbmcgdGhlDQo+IGV4dHJhIG5lZ2F0aXZlIHRlc3RzIHByb3ZpZGVkIHVuZGVyICNpZmRlZiBU\nRVNUX0dFTk1BU0tfRkFJTFVSRVMgWzFdLg0KPiANCj4gWzFdIGNvbW1pdCA2ZDUxMTAyMGUxM2Qg\nKCJsaWIvdGVzdF9iaXRzLmM6IGFkZCB0ZXN0cyBvZiBHRU5NQVNLIikNCj4gTGluazogaHR0cHM6\nLy9naXQua2VybmVsLm9yZy90b3J2YWxkcy9jLzZkNTExMDIwZTEzZA0KPiAtLS0NCj4gIGluY2x1\nZGUvbGludXgvYml0cy5oIHwgNSArKy0tLQ0KPiAgMSBmaWxlIGNoYW5nZWQsIDIgaW5zZXJ0aW9u\ncygrKSwgMyBkZWxldGlvbnMoLSkNCj4gDQo+IGRpZmYgLS1naXQgYS9pbmNsdWRlL2xpbnV4L2Jp\ndHMuaCBiL2luY2x1ZGUvbGludXgvYml0cy5oDQo+IGluZGV4IDYwMDQ0YjYwODgxNzJiM2YyNmFh\nM2YxN2NkYWVkZTk3ODY4NjNkYWUuLmVmMDExOWU2MTc5ZTFjYTk1MzQ1YTNkNGQzMzI3YmExOTYz\nMzAyOGUgMTAwNjQ0DQo+IC0tLSBhL2luY2x1ZGUvbGludXgvYml0cy5oDQo+ICsrKyBiL2luY2x1\nZGUvbGludXgvYml0cy5oDQo+IEBAIC0yMCw5ICsyMCw4IEBADQo+ICAgKi8NCj4gICNpZiAhZGVm\naW5lZChfX0FTU0VNQkxZX18pDQo+ICAjaW5jbHVkZSA8bGludXgvYnVpbGRfYnVnLmg+DQo+IC0j\nZGVmaW5lIEdFTk1BU0tfSU5QVVRfQ0hFQ0soaCwgbCkgXA0KPiAtCShCVUlMRF9CVUdfT05fWkVS\nTyhfX2J1aWx0aW5fY2hvb3NlX2V4cHIoIFwNCj4gLQkJX19pc19jb25zdGV4cHIoKGwpID4gKGgp\nKSwgKGwpID4gKGgpLCAwKSkpDQo+ICsjaW5jbHVkZSA8bGludXgvY29tcGlsZXIuaD4NCj4gKyNk\nZWZpbmUgR0VOTUFTS19JTlBVVF9DSEVDSyhoLCBsKSBCVUlMRF9CVUdfT05fWkVSTyhpc19jb25z\ndF90cnVlKChsKSA+IChoKSkpDQo+ICAjZWxzZQ0KPiAgLyoNCj4gICAqIEJVSUxEX0JVR19PTl9a\nRVJPIGlzIG5vdCBhdmFpbGFibGUgaW4gaCBmaWxlcyBpbmNsdWRlZCBmcm9tIGFzbSBmaWxlcywN\nCj4gDQo+IC0tDQo+IDIuNDUuMg0KPiANCg0KLQ0KUmVnaXN0ZXJlZCBBZGRyZXNzIExha2VzaWRl\nLCBCcmFtbGV5IFJvYWQsIE1vdW50IEZhcm0sIE1pbHRvbiBLZXluZXMsIE1LMSAxUFQsIFVLDQpS\nZWdpc3RyYXRpb24gTm86IDEzOTczODYgKFdhbGVzKQ0K\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173333823932158.mbox",
          "message_id": "<dff4cdd543104e3792e4856375f310c1 () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH 04/10] linux/bits.h: simplify GENMASK_INPUT_CHECK() by using is_const_true()",
          "date": "2024-12-04 18:52:10+00:00",
          "date_str": "Wed, 04 Dec 2024 18:52:10 +0000",
          "body": "RnJvbTogVmluY2VudCBNYWlsaG9sDQo+IFNlbnQ6IDAyIERlY2VtYmVyIDIwMjQgMTc6MzMNCj4g\nDQo+ICAgX19idWlsdGluX2Nob29zZV9leHByKF9faXNfY29uc3RleHByKChsKSA+IChoKSksIChs\nKSA+IChoKSwgMCkNCj4gDQo+IGlzIGVxdWl2YWxlbnQgdG86DQo+IA0KPiAgIGlzX2NvbnN0X3Ry\ndWUoKGwpID4gKGgpKQ0KDQpDaGFuZ2UgaXQgdG8gQlVJTERfQlVHX09OX01TRyhzdGF0aWNhbGx5\nX3RydWUoKGwpIDwgKGgpKSwgImVycm9yIG1lc3NhZ2UiKQ0KDQphbmQgdGhlbiBmaXggYWxsIHRo\nZSBmYWxsb3V0IDotKQ0KDQoJRGF2aWQNCg0KPiANCj4gQXBwbHkgaXNfY29uc3RfdHJ1ZSgpIHRv\nIHNpbXBsaWZ5IEdFTk1BU0tfSU5QVVRfQ0hFQ0soKS4NCj4gDQo+IFNpZ25lZC1vZmYtYnk6IFZp\nbmNlbnQgTWFpbGhvbCA8bWFpbGhvbC52aW5jZW50QHdhbmFkb28uZnI+DQo+IC0tLQ0KPiBUaGlz\nIGNoYW5nZSBwYXNzZXMgdGhlIHVuaXQgdGVzdHMgZnJvbSBDT05GSUdfQklUU19URVNULCBpbmNs\ndWRpbmcgdGhlDQo+IGV4dHJhIG5lZ2F0aXZlIHRlc3RzIHByb3ZpZGVkIHVuZGVyICNpZmRlZiBU\nRVNUX0dFTk1BU0tfRkFJTFVSRVMgWzFdLg0KPiANCj4gWzFdIGNvbW1pdCA2ZDUxMTAyMGUxM2Qg\nKCJsaWIvdGVzdF9iaXRzLmM6IGFkZCB0ZXN0cyBvZiBHRU5NQVNLIikNCj4gTGluazogaHR0cHM6\nLy9naXQua2VybmVsLm9yZy90b3J2YWxkcy9jLzZkNTExMDIwZTEzZA0KPiAtLS0NCj4gIGluY2x1\nZGUvbGludXgvYml0cy5oIHwgNSArKy0tLQ0KPiAgMSBmaWxlIGNoYW5nZWQsIDIgaW5zZXJ0aW9u\ncygrKSwgMyBkZWxldGlvbnMoLSkNCj4gDQo+IGRpZmYgLS1naXQgYS9pbmNsdWRlL2xpbnV4L2Jp\ndHMuaCBiL2luY2x1ZGUvbGludXgvYml0cy5oDQo+IGluZGV4IDYwMDQ0YjYwODgxNzJiM2YyNmFh\nM2YxN2NkYWVkZTk3ODY4NjNkYWUuLmVmMDExOWU2MTc5ZTFjYTk1MzQ1YTNkNGQzMzI3YmExOTYz\nMzAyOGUgMTAwNjQ0DQo+IC0tLSBhL2luY2x1ZGUvbGludXgvYml0cy5oDQo+ICsrKyBiL2luY2x1\nZGUvbGludXgvYml0cy5oDQo+IEBAIC0yMCw5ICsyMCw4IEBADQo+ICAgKi8NCj4gICNpZiAhZGVm\naW5lZChfX0FTU0VNQkxZX18pDQo+ICAjaW5jbHVkZSA8bGludXgvYnVpbGRfYnVnLmg+DQo+IC0j\nZGVmaW5lIEdFTk1BU0tfSU5QVVRfQ0hFQ0soaCwgbCkgXA0KPiAtCShCVUlMRF9CVUdfT05fWkVS\nTyhfX2J1aWx0aW5fY2hvb3NlX2V4cHIoIFwNCj4gLQkJX19pc19jb25zdGV4cHIoKGwpID4gKGgp\nKSwgKGwpID4gKGgpLCAwKSkpDQo+ICsjaW5jbHVkZSA8bGludXgvY29tcGlsZXIuaD4NCj4gKyNk\nZWZpbmUgR0VOTUFTS19JTlBVVF9DSEVDSyhoLCBsKSBCVUlMRF9CVUdfT05fWkVSTyhpc19jb25z\ndF90cnVlKChsKSA+IChoKSkpDQo+ICAjZWxzZQ0KPiAgLyoNCj4gICAqIEJVSUxEX0JVR19PTl9a\nRVJPIGlzIG5vdCBhdmFpbGFibGUgaW4gaCBmaWxlcyBpbmNsdWRlZCBmcm9tIGFzbSBmaWxlcywN\nCj4gDQo+IC0tDQo+IDIuNDUuMg0KPiANCg0KLQ0KUmVnaXN0ZXJlZCBBZGRyZXNzIExha2VzaWRl\nLCBCcmFtbGV5IFJvYWQsIE1vdW50IEZhcm0sIE1pbHRvbiBLZXluZXMsIE1LMSAxUFQsIFVLDQpS\nZWdpc3RyYXRpb24gTm86IDEzOTczODYgKFdhbGVzKQ0K\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173361499818379.mbox",
          "message_id": "<CAMZ6RqLsiOF=5FZ=U2MtZ01iBYKZHtfZ5Zi4t3m=L5Oc4EPHGg () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH 04/10] linux/bits.h: simplify GENMASK_INPUT_CHECK() by using is_const_true()",
          "date": "2024-12-05 15:49:43+00:00",
          "date_str": "Thu, 05 Dec 2024 15:49:43 +0000",
          "body": "On Thu. 5 Dec 2024 at 03:52, David Laight <David.Laight@aculab.com> wrote:\n> From: Vincent Mailhol\n> > Sent: 02 December 2024 17:33\n> >\n> >   __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n> >\n> > is equivalent to:\n> >\n> >   is_const_true((l) > (h))\n>\n> Change it to BUILD_BUG_ON_MSG(statically_true((l) < (h)), \"error message\")\n>\n> and then fix all the fallout :-)\n\nBUILD_BUG_ON_MSG() is not suitable for GENMASK_INPUT_CHECK. We need\none of the variants that returns zero here.\n\nBut I agree that it is good to have a more meaningful error message\nhere. I will use __BUILD_BUG_ON_ZERO_MSG() in v2.\n\n\nYours sincerely,\nVincent Mailhol",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173341940619038.mbox",
          "message_id": "<CAMZ6RqLsiOF=5FZ=U2MtZ01iBYKZHtfZ5Zi4t3m=L5Oc4EPHGg () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH 04/10] linux/bits.h: simplify GENMASK_INPUT_CHECK() by using is_const_true()",
          "date": "2024-12-05 15:49:43+00:00",
          "date_str": "Thu, 05 Dec 2024 15:49:43 +0000",
          "body": "On Thu. 5 Dec 2024 at 03:52, David Laight <David.Laight@aculab.com> wrote:\n> From: Vincent Mailhol\n> > Sent: 02 December 2024 17:33\n> >\n> >   __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n> >\n> > is equivalent to:\n> >\n> >   is_const_true((l) > (h))\n>\n> Change it to BUILD_BUG_ON_MSG(statically_true((l) < (h)), \"error message\")\n>\n> and then fix all the fallout :-)\n\nBUILD_BUG_ON_MSG() is not suitable for GENMASK_INPUT_CHECK. We need\none of the variants that returns zero here.\n\nBut I agree that it is good to have a more meaningful error message\nhere. I will use __BUILD_BUG_ON_ZERO_MSG() in v2.\n\n\nYours sincerely,\nVincent Mailhol\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173341940219035.mbox",
          "message_id": "<CAMZ6RqLsiOF=5FZ=U2MtZ01iBYKZHtfZ5Zi4t3m=L5Oc4EPHGg () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH 04/10] linux/bits.h: simplify GENMASK_INPUT_CHECK() by using is_const_true()",
          "date": "2024-12-05 15:49:43+00:00",
          "date_str": "Thu, 05 Dec 2024 15:49:43 +0000",
          "body": "On Thu. 5 Dec 2024 at 03:52, David Laight <David.Laight@aculab.com> wrote:\n> From: Vincent Mailhol\n> > Sent: 02 December 2024 17:33\n> >\n> >   __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n> >\n> > is equivalent to:\n> >\n> >   is_const_true((l) > (h))\n>\n> Change it to BUILD_BUG_ON_MSG(statically_true((l) < (h)), \"error message\")\n>\n> and then fix all the fallout :-)\n\nBUILD_BUG_ON_MSG() is not suitable for GENMASK_INPUT_CHECK. We need\none of the variants that returns zero here.\n\nBut I agree that it is good to have a more meaningful error message\nhere. I will use __BUILD_BUG_ON_ZERO_MSG() in v2.\n\n\nYours sincerely,\nVincent Mailhol\n",
          "year": "2024",
          "month": "12"
        }
      ],
      "primary_category": "sparse_internals"
    },
    {
      "subject": "[PATCH 00/10] compiler.h: refactor __is_constexpr() into is_const{,_true,_false}()",
      "normalized_subject": "compiler.h: refactor __is_constexpr() into is_const{,_true,_false}()",
      "message_count": 5,
      "participants": [
        "Vincent Mailhol via B4 Relay",
        "Vincent Mailhol"
      ],
      "categories": [
        "rfc_proposals",
        "compiler_compat",
        "type_system"
      ],
      "first_date": "2024-12-02T17:33:22+00:00",
      "last_date": "2024-12-05T15:21:35+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/12/173316073117712.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-0-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 00/10] compiler.h: refactor __is_constexpr() into is_const{,_true,_false}()",
          "date": "2024-12-02 17:33:22+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:22 +0000",
          "body": "This series is the spiritual successor of [1] which introduced\nconst_true(). In [1], following a comment from David Laight, Linus\ncame with a suggestion to simplify __is_constexpr() and its derived\nmacros using a _Generic() selection. Because of the total change of\nscope, I am starting a new series.\n\nThe goal is to introduce a set of three macros:\n\n  - is_const(): a one to one replacement of __is_constexpr() in term\n    of features but written in a less hacky way thanks to _Generic().\n\n  - is_const_true(): tells whether or not the argument is a true\n    integer constant expression.\n\n  - is_const_false(): tells whether or not the argument is a false\n    integer constant expression.\n\nOnce defined, apply them tree-wide.\n\nAll those three macros will rely on a single building block:\n__is_const_zero().\n\nPatch 1 adds statically_false(). This is just done so that at the end\nof this series, the full set of statically_true/false() and\nis_const_true/false() is present.\n\nPatch 2 adds __is_const_zero() and is_const().\n\nPatch 3 adds is_const_true() and is_const_false().\n\nPatch 4 to 9 do a tree-wide replacement to remove all the usages of\n__is_constexpr() and replace them by is_const_true() or\nis_const_false() whenever feasible, or by is_const() otherwise.\n\nPatch 10 finally remove __is_constexpr(). RIP!\n\n[1] add const_true() to simplify GENMASK_INPUT_CHECK()\nLink: https://lore.kernel.org/all/20241113172939.747686-4-mailhol.vincent@wanadoo.fr/\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\nVincent Mailhol (10):\n      compiler.h: add statically_false()\n      compiler.h: add is_const() as a replacement of __is_constexpr()\n      compiler.h: add is_const_true() and is_const_false()\n      linux/bits.h: simplify GENMASK_INPUT_CHECK() by using is_const_true()\n      minmax: simplify __clamp_once() by using is_const_false()\n      fortify: replace __is_constexpr() by is_const() in strlen()\n      overflow: replace __is_constexpr() by is_const()\n      drm/i915/reg: replace __is_const_expr() by is_const_true() or is_const()\n      coresight: etm4x: replace __is_const_expr() by is_const()\n      compiler.h: remove __is_constexpr()\n\n drivers/gpu/drm/i915/i915_reg_defs.h          |  47 +++++------\n drivers/hwtracing/coresight/coresight-etm4x.h |   2 +-\n include/linux/bits.h                          |   5 +-\n include/linux/compiler.h                      | 112 +++++++++++++++-----------\n include/linux/fortify-string.h                |   4 +-\n include/linux/minmax.h                        |   3 +-\n include/linux/overflow.h                      |   8 +-\n 7 files changed, 97 insertions(+), 84 deletions(-)\n---\nbase-commit: e70140ba0d2b1a30467d4af6bcfe761327b9ec95\nchange-id: 20241129-is_constexpr-refactor-19460adedc48\n\nBest regards,\n-- \nVincent Mailhol <mailhol.vincent@wanadoo.fr>\n\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173316071817626.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-0-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 00/10] compiler.h: refactor __is_constexpr() into is_const{,_true,_false}()",
          "date": "2024-12-02 17:33:22+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:22 +0000",
          "body": "This series is the spiritual successor of [1] which introduced\nconst_true(). In [1], following a comment from David Laight, Linus\ncame with a suggestion to simplify __is_constexpr() and its derived\nmacros using a _Generic() selection. Because of the total change of\nscope, I am starting a new series.\n\nThe goal is to introduce a set of three macros:\n\n  - is_const(): a one to one replacement of __is_constexpr() in term\n    of features but written in a less hacky way thanks to _Generic().\n\n  - is_const_true(): tells whether or not the argument is a true\n    integer constant expression.\n\n  - is_const_false(): tells whether or not the argument is a false\n    integer constant expression.\n\nOnce defined, apply them tree-wide.\n\nAll those three macros will rely on a single building block:\n__is_const_zero().\n\nPatch 1 adds statically_false(). This is just done so that at the end\nof this series, the full set of statically_true/false() and\nis_const_true/false() is present.\n\nPatch 2 adds __is_const_zero() and is_const().\n\nPatch 3 adds is_const_true() and is_const_false().\n\nPatch 4 to 9 do a tree-wide replacement to remove all the usages of\n__is_constexpr() and replace them by is_const_true() or\nis_const_false() whenever feasible, or by is_const() otherwise.\n\nPatch 10 finally remove __is_constexpr(). RIP!\n\n[1] add const_true() to simplify GENMASK_INPUT_CHECK()\nLink: https://lore.kernel.org/all/20241113172939.747686-4-mailhol.vincent@wanadoo.fr/\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\nVincent Mailhol (10):\n      compiler.h: add statically_false()\n      compiler.h: add is_const() as a replacement of __is_constexpr()\n      compiler.h: add is_const_true() and is_const_false()\n      linux/bits.h: simplify GENMASK_INPUT_CHECK() by using is_const_true()\n      minmax: simplify __clamp_once() by using is_const_false()\n      fortify: replace __is_constexpr() by is_const() in strlen()\n      overflow: replace __is_constexpr() by is_const()\n      drm/i915/reg: replace __is_const_expr() by is_const_true() or is_const()\n      coresight: etm4x: replace __is_const_expr() by is_const()\n      compiler.h: remove __is_constexpr()\n\n drivers/gpu/drm/i915/i915_reg_defs.h          |  47 +++++------\n drivers/hwtracing/coresight/coresight-etm4x.h |   2 +-\n include/linux/bits.h                          |   5 +-\n include/linux/compiler.h                      | 112 +++++++++++++++-----------\n include/linux/fortify-string.h                |   4 +-\n include/linux/minmax.h                        |   3 +-\n include/linux/overflow.h                      |   8 +-\n 7 files changed, 97 insertions(+), 84 deletions(-)\n---\nbase-commit: e70140ba0d2b1a30467d4af6bcfe761327b9ec95\nchange-id: 20241129-is_constexpr-refactor-19460adedc48\n\nBest regards,\n-- \nVincent Mailhol <mailhol.vincent@wanadoo.fr>\n\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173316072417654.mbox",
          "message_id": "<20241203-is_constexpr-refactor-v1-0-4e4cbaecc216 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol via B4 Relay",
          "author_email": "devnull+mailhol.vincent.wanadoo.fr () kernel ! org",
          "subject": "[PATCH 00/10] compiler.h: refactor __is_constexpr() into is_const{,_true,_false}()",
          "date": "2024-12-02 17:33:22+00:00",
          "date_str": "Mon, 02 Dec 2024 17:33:22 +0000",
          "body": "This series is the spiritual successor of [1] which introduced\nconst_true(). In [1], following a comment from David Laight, Linus\ncame with a suggestion to simplify __is_constexpr() and its derived\nmacros using a _Generic() selection. Because of the total change of\nscope, I am starting a new series.\n\nThe goal is to introduce a set of three macros:\n\n  - is_const(): a one to one replacement of __is_constexpr() in term\n    of features but written in a less hacky way thanks to _Generic().\n\n  - is_const_true(): tells whether or not the argument is a true\n    integer constant expression.\n\n  - is_const_false(): tells whether or not the argument is a false\n    integer constant expression.\n\nOnce defined, apply them tree-wide.\n\nAll those three macros will rely on a single building block:\n__is_const_zero().\n\nPatch 1 adds statically_false(). This is just done so that at the end\nof this series, the full set of statically_true/false() and\nis_const_true/false() is present.\n\nPatch 2 adds __is_const_zero() and is_const().\n\nPatch 3 adds is_const_true() and is_const_false().\n\nPatch 4 to 9 do a tree-wide replacement to remove all the usages of\n__is_constexpr() and replace them by is_const_true() or\nis_const_false() whenever feasible, or by is_const() otherwise.\n\nPatch 10 finally remove __is_constexpr(). RIP!\n\n[1] add const_true() to simplify GENMASK_INPUT_CHECK()\nLink: https://lore.kernel.org/all/20241113172939.747686-4-mailhol.vincent@wanadoo.fr/\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\nVincent Mailhol (10):\n      compiler.h: add statically_false()\n      compiler.h: add is_const() as a replacement of __is_constexpr()\n      compiler.h: add is_const_true() and is_const_false()\n      linux/bits.h: simplify GENMASK_INPUT_CHECK() by using is_const_true()\n      minmax: simplify __clamp_once() by using is_const_false()\n      fortify: replace __is_constexpr() by is_const() in strlen()\n      overflow: replace __is_constexpr() by is_const()\n      drm/i915/reg: replace __is_const_expr() by is_const_true() or is_const()\n      coresight: etm4x: replace __is_const_expr() by is_const()\n      compiler.h: remove __is_constexpr()\n\n drivers/gpu/drm/i915/i915_reg_defs.h          |  47 +++++------\n drivers/hwtracing/coresight/coresight-etm4x.h |   2 +-\n include/linux/bits.h                          |   5 +-\n include/linux/compiler.h                      | 112 +++++++++++++++-----------\n include/linux/fortify-string.h                |   4 +-\n include/linux/minmax.h                        |   3 +-\n include/linux/overflow.h                      |   8 +-\n 7 files changed, 97 insertions(+), 84 deletions(-)\n---\nbase-commit: e70140ba0d2b1a30467d4af6bcfe761327b9ec95\nchange-id: 20241129-is_constexpr-refactor-19460adedc48\n\nBest regards,\n-- \nVincent Mailhol <mailhol.vincent@wanadoo.fr>\n\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173341192512543.mbox",
          "message_id": "<CAMZ6RqLSiTfTNQrcje06MbSxvM2k16MgqG1YTCufe6j9FhupEw () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH 00/10] compiler.h: refactor __is_constexpr() into is_const{,_true,_false}()",
          "date": "2024-12-05 15:21:35+00:00",
          "date_str": "Thu, 05 Dec 2024 15:21:35 +0000",
          "body": "On Thu. 5 Dec. 2024 at 08:58, Kees Cook <kees@kernel.org> wrote:\n> On December 3, 2024 3:33:22 AM GMT+10:00, Vincent Mailhol via B4 Relay <devnull+mailhol.vincent.wanadoo.fr@kernel.org> wrote:\n> >This series is the spiritual successor of [1] which introduced\n> >const_true(). In [1], following a comment from David Laight, Linus\n> >came with a suggestion to simplify __is_constexpr() and its derived\n> >macros using a _Generic() selection. Because of the total change of\n> >scope, I am starting a new series.\n> >\n> >The goal is to introduce a set of three macros:\n> >\n> >  - is_const(): a one to one replacement of __is_constexpr() in term\n> >    of features but written in a less hacky way thanks to _Generic().\n> >\n> >  - is_const_true(): tells whether or not the argument is a true\n> >    integer constant expression.\n> >\n> >  - is_const_false(): tells whether or not the argument is a false\n> >    integer constant expression.\n>\n> But why make this change? Is something broken? Does it make builds faster?\n>\n> > 7 files changed, 97 insertions(+), 84 deletions(-)\n>\n> It makes the code larger too. I don't see what the benefit is, and given how much time has been spent making sure the existing stuff works correctly, I feel like we should have a clear benefit to replacing it all.\n\nIt makes the \"code\" larger because patch 3 (\"compiler.h: add\nis_const_true() and is_const_false()\") adds two new macros with 20\nlines of comments to explain the pros and cons. So the added \"code\" is\nonly comments. If you ignore the comments, you can see that I am\nactually removing a few lines of code.\n\nAs for the clear benefit, sorry, but I have nothing more to offer\nother than code simplification. The reason why a lot of time was spent\nto make __is_constexpr() work correctly is just a testimony of how\ncomplex the thing is. That alone can be a reason to simplify it, now\nthat new tools (_Generic()) are available.\n\nOf course, modifying __is_constexpr() is not strictly needed to\nintroduce the new is_const_expr(). My previous series:\n\n  https://lore.kernel.org/all/20241113172939.747686-4-mailhol.vincent@wanadoo.fr/\n\n did it that way. But I was rightfully pointed out for my macro being\nugly. Maybe I can suggest that you give a look to the above thread and\ntell me if you still disagree with David and Linus's comments after\nreading it?\n\n\nYours sincerely,\nVincent Mailhol\n",
          "year": "2024",
          "month": "12"
        },
        {
          "filepath": "emails/2024/12/173341192712549.mbox",
          "message_id": "<CAMZ6RqLSiTfTNQrcje06MbSxvM2k16MgqG1YTCufe6j9FhupEw () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH 00/10] compiler.h: refactor __is_constexpr() into is_const{,_true,_false}()",
          "date": "2024-12-05 15:21:35+00:00",
          "date_str": "Thu, 05 Dec 2024 15:21:35 +0000",
          "body": "On Thu. 5 Dec. 2024 at 08:58, Kees Cook <kees@kernel.org> wrote:\n> On December 3, 2024 3:33:22 AM GMT+10:00, Vincent Mailhol via B4 Relay <devnull+mailhol.vincent.wanadoo.fr@kernel.org> wrote:\n> >This series is the spiritual successor of [1] which introduced\n> >const_true(). In [1], following a comment from David Laight, Linus\n> >came with a suggestion to simplify __is_constexpr() and its derived\n> >macros using a _Generic() selection. Because of the total change of\n> >scope, I am starting a new series.\n> >\n> >The goal is to introduce a set of three macros:\n> >\n> >  - is_const(): a one to one replacement of __is_constexpr() in term\n> >    of features but written in a less hacky way thanks to _Generic().\n> >\n> >  - is_const_true(): tells whether or not the argument is a true\n> >    integer constant expression.\n> >\n> >  - is_const_false(): tells whether or not the argument is a false\n> >    integer constant expression.\n>\n> But why make this change? Is something broken? Does it make builds faster?\n>\n> > 7 files changed, 97 insertions(+), 84 deletions(-)\n>\n> It makes the code larger too. I don't see what the benefit is, and given how much time has been spent making sure the existing stuff works correctly, I feel like we should have a clear benefit to replacing it all.\n\nIt makes the \"code\" larger because patch 3 (\"compiler.h: add\nis_const_true() and is_const_false()\") adds two new macros with 20\nlines of comments to explain the pros and cons. So the added \"code\" is\nonly comments. If you ignore the comments, you can see that I am\nactually removing a few lines of code.\n\nAs for the clear benefit, sorry, but I have nothing more to offer\nother than code simplification. The reason why a lot of time was spent\nto make __is_constexpr() work correctly is just a testimony of how\ncomplex the thing is. That alone can be a reason to simplify it, now\nthat new tools (_Generic()) are available.\n\nOf course, modifying __is_constexpr() is not strictly needed to\nintroduce the new is_const_expr(). My previous series:\n\n  https://lore.kernel.org/all/20241113172939.747686-4-mailhol.vincent@wanadoo.fr/\n\n did it that way. But I was rightfully pointed out for my macro being\nugly. Maybe I can suggest that you give a look to the above thread and\ntell me if you still disagree with David and Linus's comments after\nreading it?\n\n\nYours sincerely,\nVincent Mailhol\n",
          "year": "2024",
          "month": "12"
        }
      ],
      "primary_category": "rfc_proposals"
    },
    {
      "subject": "[PATCH 6/6] percpu/x86: Enable strict percpu checks via named AS qualifiers",
      "normalized_subject": "percpu/x86: Enable strict percpu checks via named AS qualifiers",
      "message_count": 10,
      "participants": [
        "Nadav Amit",
        "Uros Bizjak"
      ],
      "categories": [
        "compiler_compat",
        "type_system",
        "address_space"
      ],
      "first_date": "2024-11-26T17:21:23+00:00",
      "last_date": "2024-11-29T16:33:33+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/11/173264231204113.mbox",
          "message_id": "<20241126172332.112212-7-ubizjak () gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "[PATCH 6/6] percpu/x86: Enable strict percpu checks via named AS qualifiers",
          "date": "2024-11-26 17:21:23+00:00",
          "date_str": "Tue, 26 Nov 2024 17:21:23 +0000",
          "body": "This patch declares percpu variables in __seg_gs/__seg_fs named AS\nand keeps them named AS qualified until they are dereferenced with\npercpu accessor. This approach enables various compiler check\nfor cross-namespace variable assignments.\n\nSigned-off-by: Uros Bizjak <ubizjak@gmail.com>\nCc: Dennis Zhou <dennis@kernel.org>\nCc: Tejun Heo <tj@kernel.org>\nCc: Christoph Lameter <cl@linux.com>\nCc: Thomas Gleixner <tglx@linutronix.de>\nCc: Ingo Molnar <mingo@kernel.org>\nCc: Borislav Petkov <bp@alien8.de>\nCc: Dave Hansen <dave.hansen@linux.intel.com>\nCc: \"H. Peter Anvin\" <hpa@zytor.com>\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Andy Lutomirski <luto@kernel.org>\nCc: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>\nCc: Nadav Amit <nadav.amit@gmail.com>\nCc: Brian Gerst <brgerst@gmail.com>\nCc: Peter Zijlstra <peterz@infradead.org>\n---\n arch/x86/include/asm/percpu.h | 16 +++++++++++++---\n 1 file changed, 13 insertions(+), 3 deletions(-)\n\ndiff --git a/arch/x86/include/asm/percpu.h b/arch/x86/include/asm/percpu.h\nindex 27f668660abe..61b875243ea3 100644\n--- a/arch/x86/include/asm/percpu.h\n+++ b/arch/x86/include/asm/percpu.h\n@@ -95,9 +95,19 @@\n \n #endif /* CONFIG_SMP */\n \n-#define __my_cpu_type(var)\ttypeof(var) __percpu_seg_override\n-#define __my_cpu_ptr(ptr)\t(__my_cpu_type(*(ptr))*)(__force uintptr_t)(ptr)\n-#define __my_cpu_var(var)\t(*__my_cpu_ptr(&(var)))\n+#if defined(CONFIG_USE_X86_SEG_SUPPORT) && \\\n+    defined(CONFIG_CC_HAS_TYPEOF_UNQUAL) && !defined(__CHECKER__)\n+# define __my_cpu_type(var)\ttypeof(var)\n+# define __my_cpu_ptr(ptr)\t(ptr)\n+# define __my_cpu_var(var)\t(var)\n+\n+# define __per_cpu_qual\t\t__percpu_seg_override\n+#else\n+# define __my_cpu_type(var)\ttypeof(var) __percpu_seg_override\n+# define __my_cpu_ptr(ptr)\t(__my_cpu_type(*(ptr))*)(__force uintptr_t)(ptr)\n+# define __my_cpu_var(var)\t(*__my_cpu_ptr(&(var)))\n+#endif\n+\n #define __percpu_arg(x)\t\t__percpu_prefix \"%\" #x\n #define __force_percpu_arg(x)\t__force_percpu_prefix \"%\" #x\n \n-- \n2.42.0\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173264183303735.mbox",
          "message_id": "<20241126172332.112212-7-ubizjak () gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "[PATCH 6/6] percpu/x86: Enable strict percpu checks via named AS qualifiers",
          "date": "2024-11-26 17:21:23+00:00",
          "date_str": "Tue, 26 Nov 2024 17:21:23 +0000",
          "body": "This patch declares percpu variables in __seg_gs/__seg_fs named AS\nand keeps them named AS qualified until they are dereferenced with\npercpu accessor. This approach enables various compiler check\nfor cross-namespace variable assignments.\n\nSigned-off-by: Uros Bizjak <ubizjak@gmail.com>\nCc: Dennis Zhou <dennis@kernel.org>\nCc: Tejun Heo <tj@kernel.org>\nCc: Christoph Lameter <cl@linux.com>\nCc: Thomas Gleixner <tglx@linutronix.de>\nCc: Ingo Molnar <mingo@kernel.org>\nCc: Borislav Petkov <bp@alien8.de>\nCc: Dave Hansen <dave.hansen@linux.intel.com>\nCc: \"H. Peter Anvin\" <hpa@zytor.com>\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Andy Lutomirski <luto@kernel.org>\nCc: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>\nCc: Nadav Amit <nadav.amit@gmail.com>\nCc: Brian Gerst <brgerst@gmail.com>\nCc: Peter Zijlstra <peterz@infradead.org>\n---\n arch/x86/include/asm/percpu.h | 16 +++++++++++++---\n 1 file changed, 13 insertions(+), 3 deletions(-)\n\ndiff --git a/arch/x86/include/asm/percpu.h b/arch/x86/include/asm/percpu.h\nindex 27f668660abe..61b875243ea3 100644\n--- a/arch/x86/include/asm/percpu.h\n+++ b/arch/x86/include/asm/percpu.h\n@@ -95,9 +95,19 @@\n \n #endif /* CONFIG_SMP */\n \n-#define __my_cpu_type(var)\ttypeof(var) __percpu_seg_override\n-#define __my_cpu_ptr(ptr)\t(__my_cpu_type(*(ptr))*)(__force uintptr_t)(ptr)\n-#define __my_cpu_var(var)\t(*__my_cpu_ptr(&(var)))\n+#if defined(CONFIG_USE_X86_SEG_SUPPORT) && \\\n+    defined(CONFIG_CC_HAS_TYPEOF_UNQUAL) && !defined(__CHECKER__)\n+# define __my_cpu_type(var)\ttypeof(var)\n+# define __my_cpu_ptr(ptr)\t(ptr)\n+# define __my_cpu_var(var)\t(var)\n+\n+# define __per_cpu_qual\t\t__percpu_seg_override\n+#else\n+# define __my_cpu_type(var)\ttypeof(var) __percpu_seg_override\n+# define __my_cpu_ptr(ptr)\t(__my_cpu_type(*(ptr))*)(__force uintptr_t)(ptr)\n+# define __my_cpu_var(var)\t(*__my_cpu_ptr(&(var)))\n+#endif\n+\n #define __percpu_arg(x)\t\t__percpu_prefix \"%\" #x\n #define __force_percpu_arg(x)\t__force_percpu_prefix \"%\" #x\n \n-- \n2.42.0\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173264167003516.mbox",
          "message_id": "<20241126172332.112212-7-ubizjak () gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "[PATCH 6/6] percpu/x86: Enable strict percpu checks via named AS qualifiers",
          "date": "2024-11-26 17:21:23+00:00",
          "date_str": "Tue, 26 Nov 2024 17:21:23 +0000",
          "body": "This patch declares percpu variables in __seg_gs/__seg_fs named AS\nand keeps them named AS qualified until they are dereferenced with\npercpu accessor. This approach enables various compiler check\nfor cross-namespace variable assignments.\n\nSigned-off-by: Uros Bizjak <ubizjak@gmail.com>\nCc: Dennis Zhou <dennis@kernel.org>\nCc: Tejun Heo <tj@kernel.org>\nCc: Christoph Lameter <cl@linux.com>\nCc: Thomas Gleixner <tglx@linutronix.de>\nCc: Ingo Molnar <mingo@kernel.org>\nCc: Borislav Petkov <bp@alien8.de>\nCc: Dave Hansen <dave.hansen@linux.intel.com>\nCc: \"H. Peter Anvin\" <hpa@zytor.com>\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Andy Lutomirski <luto@kernel.org>\nCc: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>\nCc: Nadav Amit <nadav.amit@gmail.com>\nCc: Brian Gerst <brgerst@gmail.com>\nCc: Peter Zijlstra <peterz@infradead.org>\n---\n arch/x86/include/asm/percpu.h | 16 +++++++++++++---\n 1 file changed, 13 insertions(+), 3 deletions(-)\n\ndiff --git a/arch/x86/include/asm/percpu.h b/arch/x86/include/asm/percpu.h\nindex 27f668660abe..61b875243ea3 100644\n--- a/arch/x86/include/asm/percpu.h\n+++ b/arch/x86/include/asm/percpu.h\n@@ -95,9 +95,19 @@\n \n #endif /* CONFIG_SMP */\n \n-#define __my_cpu_type(var)\ttypeof(var) __percpu_seg_override\n-#define __my_cpu_ptr(ptr)\t(__my_cpu_type(*(ptr))*)(__force uintptr_t)(ptr)\n-#define __my_cpu_var(var)\t(*__my_cpu_ptr(&(var)))\n+#if defined(CONFIG_USE_X86_SEG_SUPPORT) && \\\n+    defined(CONFIG_CC_HAS_TYPEOF_UNQUAL) && !defined(__CHECKER__)\n+# define __my_cpu_type(var)\ttypeof(var)\n+# define __my_cpu_ptr(ptr)\t(ptr)\n+# define __my_cpu_var(var)\t(var)\n+\n+# define __per_cpu_qual\t\t__percpu_seg_override\n+#else\n+# define __my_cpu_type(var)\ttypeof(var) __percpu_seg_override\n+# define __my_cpu_ptr(ptr)\t(__my_cpu_type(*(ptr))*)(__force uintptr_t)(ptr)\n+# define __my_cpu_var(var)\t(*__my_cpu_ptr(&(var)))\n+#endif\n+\n #define __percpu_arg(x)\t\t__percpu_prefix \"%\" #x\n #define __force_percpu_arg(x)\t__force_percpu_prefix \"%\" #x\n \n-- \n2.42.0\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173264181603716.mbox",
          "message_id": "<20241126172332.112212-7-ubizjak () gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "[PATCH 6/6] percpu/x86: Enable strict percpu checks via named AS qualifiers",
          "date": "2024-11-26 17:21:23+00:00",
          "date_str": "Tue, 26 Nov 2024 17:21:23 +0000",
          "body": "This patch declares percpu variables in __seg_gs/__seg_fs named AS\nand keeps them named AS qualified until they are dereferenced with\npercpu accessor. This approach enables various compiler check\nfor cross-namespace variable assignments.\n\nSigned-off-by: Uros Bizjak <ubizjak@gmail.com>\nCc: Dennis Zhou <dennis@kernel.org>\nCc: Tejun Heo <tj@kernel.org>\nCc: Christoph Lameter <cl@linux.com>\nCc: Thomas Gleixner <tglx@linutronix.de>\nCc: Ingo Molnar <mingo@kernel.org>\nCc: Borislav Petkov <bp@alien8.de>\nCc: Dave Hansen <dave.hansen@linux.intel.com>\nCc: \"H. Peter Anvin\" <hpa@zytor.com>\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Andy Lutomirski <luto@kernel.org>\nCc: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>\nCc: Nadav Amit <nadav.amit@gmail.com>\nCc: Brian Gerst <brgerst@gmail.com>\nCc: Peter Zijlstra <peterz@infradead.org>\n---\n arch/x86/include/asm/percpu.h | 16 +++++++++++++---\n 1 file changed, 13 insertions(+), 3 deletions(-)\n\ndiff --git a/arch/x86/include/asm/percpu.h b/arch/x86/include/asm/percpu.h\nindex 27f668660abe..61b875243ea3 100644\n--- a/arch/x86/include/asm/percpu.h\n+++ b/arch/x86/include/asm/percpu.h\n@@ -95,9 +95,19 @@\n \n #endif /* CONFIG_SMP */\n \n-#define __my_cpu_type(var)\ttypeof(var) __percpu_seg_override\n-#define __my_cpu_ptr(ptr)\t(__my_cpu_type(*(ptr))*)(__force uintptr_t)(ptr)\n-#define __my_cpu_var(var)\t(*__my_cpu_ptr(&(var)))\n+#if defined(CONFIG_USE_X86_SEG_SUPPORT) && \\\n+    defined(CONFIG_CC_HAS_TYPEOF_UNQUAL) && !defined(__CHECKER__)\n+# define __my_cpu_type(var)\ttypeof(var)\n+# define __my_cpu_ptr(ptr)\t(ptr)\n+# define __my_cpu_var(var)\t(var)\n+\n+# define __per_cpu_qual\t\t__percpu_seg_override\n+#else\n+# define __my_cpu_type(var)\ttypeof(var) __percpu_seg_override\n+# define __my_cpu_ptr(ptr)\t(__my_cpu_type(*(ptr))*)(__force uintptr_t)(ptr)\n+# define __my_cpu_var(var)\t(*__my_cpu_ptr(&(var)))\n+#endif\n+\n #define __percpu_arg(x)\t\t__percpu_prefix \"%\" #x\n #define __force_percpu_arg(x)\t__force_percpu_prefix \"%\" #x\n \n-- \n2.42.0\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173289494901207.mbox",
          "message_id": "<9CECB9F7-E700-4A92-98B9-6FD027F9CE65 () gmail ! com>",
          "author_name": "Nadav Amit",
          "author_email": "nadav.amit () gmail ! com",
          "subject": "Re: [PATCH 6/6] percpu/x86: Enable strict percpu checks via named AS qualifiers",
          "date": "2024-11-29 15:45:09+00:00",
          "date_str": "Fri, 29 Nov 2024 15:45:09 +0000",
          "body": "\n> On 26 Nov 2024, at 19:21, Uros Bizjak <ubizjak@gmail.com> wrote:\n> \n> This patch declares percpu variables in __seg_gs/__seg_fs named AS\n> and keeps them named AS qualified until they are dereferenced with\n> percpu accessor. This approach enables various compiler check\n> for cross-namespace variable assignments.\n\n[snip]\n\n> @@ -95,9 +95,19 @@\n> \n> #endif /* CONFIG_SMP */\n> \n> -#define __my_cpu_type(var) typeof(var) __percpu_seg_override\n> -#define __my_cpu_ptr(ptr) (__my_cpu_type(*(ptr))*)(__force uintptr_t)(ptr)\n> -#define __my_cpu_var(var) (*__my_cpu_ptr(&(var)))\n> +#if defined(CONFIG_USE_X86_SEG_SUPPORT) && \\\n> +    defined(CONFIG_CC_HAS_TYPEOF_UNQUAL) && !defined(__CHECKER__)\n\nIs the __CHECKER__ check because of sparse, as in patch 2/6 ?\nIf so, do you want to add a similar comment here?\n\nOther than that, I went over the different patches and it looks good as\nmuch as I can tell.\n\nIf it means anything, you have for the series\n\nAcked-by: Nadav Amit <nadav.amit@gmail.com <mailto:nadav.amit@gmail.com>>\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173289494601198.mbox",
          "message_id": "<9CECB9F7-E700-4A92-98B9-6FD027F9CE65 () gmail ! com>",
          "author_name": "Nadav Amit",
          "author_email": "nadav.amit () gmail ! com",
          "subject": "Re: [PATCH 6/6] percpu/x86: Enable strict percpu checks via named AS qualifiers",
          "date": "2024-11-29 15:45:09+00:00",
          "date_str": "Fri, 29 Nov 2024 15:45:09 +0000",
          "body": "\n> On 26 Nov 2024, at 19:21, Uros Bizjak <ubizjak@gmail.com> wrote:\n> \n> This patch declares percpu variables in __seg_gs/__seg_fs named AS\n> and keeps them named AS qualified until they are dereferenced with\n> percpu accessor. This approach enables various compiler check\n> for cross-namespace variable assignments.\n\n[snip]\n\n> @@ -95,9 +95,19 @@\n> \n> #endif /* CONFIG_SMP */\n> \n> -#define __my_cpu_type(var) typeof(var) __percpu_seg_override\n> -#define __my_cpu_ptr(ptr) (__my_cpu_type(*(ptr))*)(__force uintptr_t)(ptr)\n> -#define __my_cpu_var(var) (*__my_cpu_ptr(&(var)))\n> +#if defined(CONFIG_USE_X86_SEG_SUPPORT) && \\\n> +    defined(CONFIG_CC_HAS_TYPEOF_UNQUAL) && !defined(__CHECKER__)\n\nIs the __CHECKER__ check because of sparse, as in patch 2/6 ?\nIf so, do you want to add a similar comment here?\n\nOther than that, I went over the different patches and it looks good as\nmuch as I can tell.\n\nIf it means anything, you have for the series\n\nAcked-by: Nadav Amit <nadav.amit@gmail.com <mailto:nadav.amit@gmail.com>>\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173289494601199.mbox",
          "message_id": "<9CECB9F7-E700-4A92-98B9-6FD027F9CE65 () gmail ! com>",
          "author_name": "Nadav Amit",
          "author_email": "nadav.amit () gmail ! com",
          "subject": "Re: [PATCH 6/6] percpu/x86: Enable strict percpu checks via named AS qualifiers",
          "date": "2024-11-29 15:45:09+00:00",
          "date_str": "Fri, 29 Nov 2024 15:45:09 +0000",
          "body": "\n> On 26 Nov 2024, at 19:21, Uros Bizjak <ubizjak@gmail.com> wrote:\n> \n> This patch declares percpu variables in __seg_gs/__seg_fs named AS\n> and keeps them named AS qualified until they are dereferenced with\n> percpu accessor. This approach enables various compiler check\n> for cross-namespace variable assignments.\n\n[snip]\n\n> @@ -95,9 +95,19 @@\n> \n> #endif /* CONFIG_SMP */\n> \n> -#define __my_cpu_type(var) typeof(var) __percpu_seg_override\n> -#define __my_cpu_ptr(ptr) (__my_cpu_type(*(ptr))*)(__force uintptr_t)(ptr)\n> -#define __my_cpu_var(var) (*__my_cpu_ptr(&(var)))\n> +#if defined(CONFIG_USE_X86_SEG_SUPPORT) && \\\n> +    defined(CONFIG_CC_HAS_TYPEOF_UNQUAL) && !defined(__CHECKER__)\n\nIs the __CHECKER__ check because of sparse, as in patch 2/6 ?\nIf so, do you want to add a similar comment here?\n\nOther than that, I went over the different patches and it looks good as\nmuch as I can tell.\n\nIf it means anything, you have for the series\n\nAcked-by: Nadav Amit <nadav.amit@gmail.com <mailto:nadav.amit@gmail.com>>\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173289784203265.mbox",
          "message_id": "<CAFULd4Zs32G+NToyGSHv8quQbSOfaEC2UjtQ3vwnn9jufK47rA () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [PATCH 6/6] percpu/x86: Enable strict percpu checks via named AS qualifiers",
          "date": "2024-11-29 16:33:33+00:00",
          "date_str": "Fri, 29 Nov 2024 16:33:33 +0000",
          "body": "On Fri, Nov 29, 2024 at 4:45=E2=80=AFPM Nadav Amit <nadav.amit@gmail.com> w=\nrote:\n>\n>\n> > On 26 Nov 2024, at 19:21, Uros Bizjak <ubizjak@gmail.com> wrote:\n> >\n> > This patch declares percpu variables in __seg_gs/__seg_fs named AS\n> > and keeps them named AS qualified until they are dereferenced with\n> > percpu accessor. This approach enables various compiler check\n> > for cross-namespace variable assignments.\n>\n> [snip]\n>\n> > @@ -95,9 +95,19 @@\n> >\n> > #endif /* CONFIG_SMP */\n> >\n> > -#define __my_cpu_type(var) typeof(var) __percpu_seg_override\n> > -#define __my_cpu_ptr(ptr) (__my_cpu_type(*(ptr))*)(__force uintptr_t)(=\nptr)\n> > -#define __my_cpu_var(var) (*__my_cpu_ptr(&(var)))\n> > +#if defined(CONFIG_USE_X86_SEG_SUPPORT) && \\\n> > +    defined(CONFIG_CC_HAS_TYPEOF_UNQUAL) && !defined(__CHECKER__)\n>\n> Is the __CHECKER__ check because of sparse, as in patch 2/6 ?\n> If so, do you want to add a similar comment here?\n\nYes, this is the same check. We can declare _percpu variables in\n__seg_gs named address space only when __typeof_unqual__ is used. I\nwill add a comment in the next revision of the patchset.\n\n> Other than that, I went over the different patches and it looks good as\n> much as I can tell.\n>\n> If it means anything, you have for the series\n>\n> Acked-by: Nadav Amit <nadav.amit@gmail.com <mailto:nadav.amit@gmail.com>>\n\nThanks!\n\nUros.\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173289793703323.mbox",
          "message_id": "<CAFULd4Zs32G+NToyGSHv8quQbSOfaEC2UjtQ3vwnn9jufK47rA () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [PATCH 6/6] percpu/x86: Enable strict percpu checks via named AS qualifiers",
          "date": "2024-11-29 16:33:33+00:00",
          "date_str": "Fri, 29 Nov 2024 16:33:33 +0000",
          "body": "On Fri, Nov 29, 2024 at 4:45=E2=80=AFPM Nadav Amit <nadav.amit@gmail.com> w=\nrote:\n>\n>\n> > On 26 Nov 2024, at 19:21, Uros Bizjak <ubizjak@gmail.com> wrote:\n> >\n> > This patch declares percpu variables in __seg_gs/__seg_fs named AS\n> > and keeps them named AS qualified until they are dereferenced with\n> > percpu accessor. This approach enables various compiler check\n> > for cross-namespace variable assignments.\n>\n> [snip]\n>\n> > @@ -95,9 +95,19 @@\n> >\n> > #endif /* CONFIG_SMP */\n> >\n> > -#define __my_cpu_type(var) typeof(var) __percpu_seg_override\n> > -#define __my_cpu_ptr(ptr) (__my_cpu_type(*(ptr))*)(__force uintptr_t)(=\nptr)\n> > -#define __my_cpu_var(var) (*__my_cpu_ptr(&(var)))\n> > +#if defined(CONFIG_USE_X86_SEG_SUPPORT) && \\\n> > +    defined(CONFIG_CC_HAS_TYPEOF_UNQUAL) && !defined(__CHECKER__)\n>\n> Is the __CHECKER__ check because of sparse, as in patch 2/6 ?\n> If so, do you want to add a similar comment here?\n\nYes, this is the same check. We can declare _percpu variables in\n__seg_gs named address space only when __typeof_unqual__ is used. I\nwill add a comment in the next revision of the patchset.\n\n> Other than that, I went over the different patches and it looks good as\n> much as I can tell.\n>\n> If it means anything, you have for the series\n>\n> Acked-by: Nadav Amit <nadav.amit@gmail.com <mailto:nadav.amit@gmail.com>>\n\nThanks!\n\nUros.\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173289794103328.mbox",
          "message_id": "<CAFULd4Zs32G+NToyGSHv8quQbSOfaEC2UjtQ3vwnn9jufK47rA () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [PATCH 6/6] percpu/x86: Enable strict percpu checks via named AS qualifiers",
          "date": "2024-11-29 16:33:33+00:00",
          "date_str": "Fri, 29 Nov 2024 16:33:33 +0000",
          "body": "On Fri, Nov 29, 2024 at 4:45=E2=80=AFPM Nadav Amit <nadav.amit@gmail.com> w=\nrote:\n>\n>\n> > On 26 Nov 2024, at 19:21, Uros Bizjak <ubizjak@gmail.com> wrote:\n> >\n> > This patch declares percpu variables in __seg_gs/__seg_fs named AS\n> > and keeps them named AS qualified until they are dereferenced with\n> > percpu accessor. This approach enables various compiler check\n> > for cross-namespace variable assignments.\n>\n> [snip]\n>\n> > @@ -95,9 +95,19 @@\n> >\n> > #endif /* CONFIG_SMP */\n> >\n> > -#define __my_cpu_type(var) typeof(var) __percpu_seg_override\n> > -#define __my_cpu_ptr(ptr) (__my_cpu_type(*(ptr))*)(__force uintptr_t)(=\nptr)\n> > -#define __my_cpu_var(var) (*__my_cpu_ptr(&(var)))\n> > +#if defined(CONFIG_USE_X86_SEG_SUPPORT) && \\\n> > +    defined(CONFIG_CC_HAS_TYPEOF_UNQUAL) && !defined(__CHECKER__)\n>\n> Is the __CHECKER__ check because of sparse, as in patch 2/6 ?\n> If so, do you want to add a similar comment here?\n\nYes, this is the same check. We can declare _percpu variables in\n__seg_gs named address space only when __typeof_unqual__ is used. I\nwill add a comment in the next revision of the patchset.\n\n> Other than that, I went over the different patches and it looks good as\n> much as I can tell.\n>\n> If it means anything, you have for the series\n>\n> Acked-by: Nadav Amit <nadav.amit@gmail.com <mailto:nadav.amit@gmail.com>>\n\nThanks!\n\nUros.\n",
          "year": "2024",
          "month": "11"
        }
      ],
      "primary_category": "address_space"
    },
    {
      "subject": "[PATCH 5/6] percpu: Repurpose __percpu tag as a named address space qualifier",
      "normalized_subject": "percpu: Repurpose __percpu tag as a named address space qualifier",
      "message_count": 1,
      "participants": [
        "Uros Bizjak"
      ],
      "categories": [
        "rfc_proposals",
        "compiler_compat",
        "address_space"
      ],
      "first_date": "2024-11-26T17:21:22+00:00",
      "last_date": "2024-11-26T17:21:22+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/11/173264217003986.mbox",
          "message_id": "<20241126172332.112212-6-ubizjak () gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "[PATCH 5/6] percpu: Repurpose __percpu tag as a named address space qualifier",
          "date": "2024-11-26 17:21:22+00:00",
          "date_str": "Tue, 26 Nov 2024 17:21:22 +0000",
          "body": "The patch introduces per_cpu_qual define and repurposes __percpu\ntag as a named address space qualifier using the new define.\n\nArches can now conditionally define __per_cpu_qual as their\nnamed address space qualifier for percpu variables.\n\nSigned-off-by: Uros Bizjak <ubizjak@gmail.com>\nCc: Arnd Bergmann <arnd@arndb.de>\nCc: Thomas Gleixner <tglx@linutronix.de>\nCc: Dennis Zhou <dennis@kernel.org>\nCc: Tejun Heo <tj@kernel.org>\nCc: Christoph Lameter <cl@linux.com>\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Andy Lutomirski <luto@kernel.org>\nCc: Ingo Molnar <mingo@kernel.org>\nCc: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>\nCc: Nadav Amit <nadav.amit@gmail.com>\nCc: Brian Gerst <brgerst@gmail.com>\nCc: \"H. Peter Anvin\" <hpa@zytor.com>\nCc: Peter Zijlstra <peterz@infradead.org>\n---\n include/asm-generic/percpu.h   | 15 +++++++++++++++\n include/linux/compiler_types.h |  2 +-\n 2 files changed, 16 insertions(+), 1 deletion(-)\n\ndiff --git a/include/asm-generic/percpu.h b/include/asm-generic/percpu.h\nindex 50597b975a49..3b93b168faa1 100644\n--- a/include/asm-generic/percpu.h\n+++ b/include/asm-generic/percpu.h\n@@ -6,6 +6,21 @@\n #include <linux/threads.h>\n #include <linux/percpu-defs.h>\n \n+/*\n+ * per_cpu_qual is the qualifier for the percpu named address space.\n+ *\n+ * Most arches use generic named address space for percpu variables but\n+ * some arches define percpu variables in different named address space\n+ * (on the x86 arch, percpu variable may be declared as being relative\n+ * to the %fs or %gs segments using __seg_fs or __seg_gs named address\n+ * space qualifier).\n+ */\n+#ifdef __per_cpu_qual\n+# define per_cpu_qual __per_cpu_qual\n+#else\n+# define per_cpu_qual\n+#endif\n+\n #ifdef CONFIG_SMP\n \n /*\ndiff --git a/include/linux/compiler_types.h b/include/linux/compiler_types.h\nindex 981cc3d7e3aa..877fe0c43c5d 100644\n--- a/include/linux/compiler_types.h\n+++ b/include/linux/compiler_types.h\n@@ -57,7 +57,7 @@ static inline void __chk_io_ptr(const volatile void __iomem *ptr) { }\n #  define __user\tBTF_TYPE_TAG(user)\n # endif\n # define __iomem\n-# define __percpu\tBTF_TYPE_TAG(percpu)\n+# define __percpu\tper_cpu_qual BTF_TYPE_TAG(percpu)\n # define __rcu\t\tBTF_TYPE_TAG(rcu)\n \n # define __chk_user_ptr(x)\t(void)0\n-- \n2.42.0\n\n",
          "year": "2024",
          "month": "11"
        }
      ],
      "primary_category": "rfc_proposals"
    },
    {
      "subject": "[PATCH 3/6] percpu: Use TYPEOF_UNQUAL() in variable declarations",
      "normalized_subject": "percpu: Use TYPEOF_UNQUAL() in variable declarations",
      "message_count": 1,
      "participants": [
        "Uros Bizjak"
      ],
      "categories": [
        "type_system",
        "compiler_compat",
        "address_space"
      ],
      "first_date": "2024-11-26T17:21:20+00:00",
      "last_date": "2024-11-26T17:21:20+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/11/173264222404043.mbox",
          "message_id": "<20241126172332.112212-4-ubizjak () gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "[PATCH 3/6] percpu: Use TYPEOF_UNQUAL() in variable declarations",
          "date": "2024-11-26 17:21:20+00:00",
          "date_str": "Tue, 26 Nov 2024 17:21:20 +0000",
          "body": "Use TYPEOF_UNQUAL() to declare variables as a corresponding\ntype without named address space qualifier to avoid\n\"\u2018__seg_gs\u2019 specified for auto variable \u2018var\u2019\" errors.\n\nSigned-off-by: Uros Bizjak <ubizjak@gmail.com>\nCc: Dennis Zhou <dennis@kernel.org>\nCc: Tejun Heo <tj@kernel.org>\nCc: Christoph Lameter <cl@linux.com>\nCc: Andy Lutomirski <luto@kernel.org>\nCc: Thomas Gleixner <tglx@linutronix.de>\nCc: Ingo Molnar <mingo@kernel.org>\nCc: Borislav Petkov <bp@alien8.de>\nCc: Dave Hansen <dave.hansen@linux.intel.com>\nCc: \"H. Peter Anvin\" <hpa@zytor.com>\nCc: Kent Overstreet <kent.overstreet@linux.dev>\nCc: Arnd Bergmann <arnd@arndb.de>\nCc: \"David S. Miller\" <davem@davemloft.net>\nCc: Eric Dumazet <edumazet@google.com>\nCc: Jakub Kicinski <kuba@kernel.org>\nCc: Paolo Abeni <pabeni@redhat.com>\nCc: Peter Zijlstra <peterz@infradead.org>\nCc: Will Deacon <will@kernel.org>\nCc: Waiman Long <longman@redhat.com>\nCc: Boqun Feng <boqun.feng@gmail.com>\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>\nCc: Nadav Amit <nadav.amit@gmail.com>\nCc: Brian Gerst <brgerst@gmail.com>\n---\n arch/x86/include/asm/percpu.h | 10 +++++-----\n fs/bcachefs/util.h            |  2 +-\n include/asm-generic/percpu.h  | 26 +++++++++++++-------------\n include/linux/part_stat.h     |  2 +-\n include/linux/percpu-defs.h   |  4 ++--\n include/net/snmp.h            |  5 ++---\n kernel/locking/percpu-rwsem.c |  2 +-\n net/mpls/internal.h           |  4 ++--\n 8 files changed, 27 insertions(+), 28 deletions(-)\n\ndiff --git a/arch/x86/include/asm/percpu.h b/arch/x86/include/asm/percpu.h\nindex e525cd85f999..666e4137b09f 100644\n--- a/arch/x86/include/asm/percpu.h\n+++ b/arch/x86/include/asm/percpu.h\n@@ -180,7 +180,7 @@ do {\t\t\t\t\t\t\t\t\t\\\n \t__pcpu_type_##size pto_val__ = __pcpu_cast_##size(_val);\t\\\n \t\t\t\t\t\t\t\t\t\\\n \tif (0) {\t\t                                        \\\n-\t\ttypeof(_var) pto_tmp__;\t\t\t\t\t\\\n+\t\tTYPEOF_UNQUAL(_var) pto_tmp__;\t\t\t\t\\\n \t\tpto_tmp__ = (_val);\t\t\t\t\t\\\n \t\t(void)pto_tmp__;\t\t\t\t\t\\\n \t}\t\t\t\t\t\t\t\t\\\n@@ -219,7 +219,7 @@ do {\t\t\t\t\t\t\t\t\t\\\n \t__pcpu_type_##size pto_val__ = __pcpu_cast_##size(_val);\t\\\n \t\t\t\t\t\t\t\t\t\\\n \tif (0) {\t\t                                        \\\n-\t\ttypeof(_var) pto_tmp__;\t\t\t\t\t\\\n+\t\tTYPEOF_UNQUAL(_var) pto_tmp__;\t\t\t\t\\\n \t\tpto_tmp__ = (_val);\t\t\t\t\t\\\n \t\t(void)pto_tmp__;\t\t\t\t\t\\\n \t}\t\t\t\t\t\t\t\t\\\n@@ -240,7 +240,7 @@ do {\t\t\t\t\t\t\t\t\t\\\n \t\t\t (val) == (typeof(val))-1)) ? (int)(val) : 0;\t\\\n \t\t\t\t\t\t\t\t\t\\\n \tif (0) {\t\t\t\t\t\t\t\\\n-\t\ttypeof(var) pao_tmp__;\t\t\t\t\t\\\n+\t\tTYPEOF_UNQUAL(var) pao_tmp__;\t\t\t\t\\\n \t\tpao_tmp__ = (val);\t\t\t\t\t\\\n \t\t(void)pao_tmp__;\t\t\t\t\t\\\n \t}\t\t\t\t\t\t\t\t\\\n@@ -273,7 +273,7 @@ do {\t\t\t\t\t\t\t\t\t\\\n  */\n #define raw_percpu_xchg_op(_var, _nval)\t\t\t\t\t\\\n ({\t\t\t\t\t\t\t\t\t\\\n-\ttypeof(_var) pxo_old__ = raw_cpu_read(_var);\t\t\t\\\n+\tTYPEOF_UNQUAL(_var) pxo_old__ = raw_cpu_read(_var);\t\t\\\n \t\t\t\t\t\t\t\t\t\\\n \traw_cpu_write(_var, _nval);\t\t\t\t\t\\\n \t\t\t\t\t\t\t\t\t\\\n@@ -287,7 +287,7 @@ do {\t\t\t\t\t\t\t\t\t\\\n  */\n #define this_percpu_xchg_op(_var, _nval)\t\t\t\t\\\n ({\t\t\t\t\t\t\t\t\t\\\n-\ttypeof(_var) pxo_old__ = this_cpu_read(_var);\t\t\t\\\n+\tTYPEOF_UNQUAL(_var) pxo_old__ = this_cpu_read(_var);\t\t\\\n \t\t\t\t\t\t\t\t\t\\\n \tdo { } while (!this_cpu_try_cmpxchg(_var, &pxo_old__, _nval));\t\\\n \t\t\t\t\t\t\t\t\t\\\ndiff --git a/fs/bcachefs/util.h b/fs/bcachefs/util.h\nindex fb02c1c36004..415a5803b8f4 100644\n--- a/fs/bcachefs/util.h\n+++ b/fs/bcachefs/util.h\n@@ -586,7 +586,7 @@ do {\t\t\t\t\t\t\t\t\t\\\n \n #define per_cpu_sum(_p)\t\t\t\t\t\t\t\\\n ({\t\t\t\t\t\t\t\t\t\\\n-\ttypeof(*_p) _ret = 0;\t\t\t\t\t\t\\\n+\tTYPEOF_UNQUAL(*_p) _ret = 0;\t\t\t\t\t\\\n \t\t\t\t\t\t\t\t\t\\\n \tint cpu;\t\t\t\t\t\t\t\\\n \tfor_each_possible_cpu(cpu)\t\t\t\t\t\\\ndiff --git a/include/asm-generic/percpu.h b/include/asm-generic/percpu.h\nindex 94cbd50cc870..50597b975a49 100644\n--- a/include/asm-generic/percpu.h\n+++ b/include/asm-generic/percpu.h\n@@ -74,7 +74,7 @@ do {\t\t\t\t\t\t\t\t\t\\\n \n #define raw_cpu_generic_add_return(pcp, val)\t\t\t\t\\\n ({\t\t\t\t\t\t\t\t\t\\\n-\ttypeof(pcp) *__p = raw_cpu_ptr(&(pcp));\t\t\t\t\\\n+\tTYPEOF_UNQUAL(pcp) *__p = raw_cpu_ptr(&(pcp));\t\t\t\\\n \t\t\t\t\t\t\t\t\t\\\n \t*__p += val;\t\t\t\t\t\t\t\\\n \t*__p;\t\t\t\t\t\t\t\t\\\n@@ -82,8 +82,8 @@ do {\t\t\t\t\t\t\t\t\t\\\n \n #define raw_cpu_generic_xchg(pcp, nval)\t\t\t\t\t\\\n ({\t\t\t\t\t\t\t\t\t\\\n-\ttypeof(pcp) *__p = raw_cpu_ptr(&(pcp));\t\t\t\t\\\n-\ttypeof(pcp) __ret;\t\t\t\t\t\t\\\n+\tTYPEOF_UNQUAL(pcp) *__p = raw_cpu_ptr(&(pcp));\t\t\t\\\n+\tTYPEOF_UNQUAL(pcp) __ret;\t\t\t\t\t\\\n \t__ret = *__p;\t\t\t\t\t\t\t\\\n \t*__p = nval;\t\t\t\t\t\t\t\\\n \t__ret;\t\t\t\t\t\t\t\t\\\n@@ -91,7 +91,7 @@ do {\t\t\t\t\t\t\t\t\t\\\n \n #define __cpu_fallback_try_cmpxchg(pcp, ovalp, nval, _cmpxchg)\t\t\\\n ({\t\t\t\t\t\t\t\t\t\\\n-\ttypeof(pcp) __val, __old = *(ovalp);\t\t\t\t\\\n+\tTYPEOF_UNQUAL(pcp) __val, __old = *(ovalp);\t\t\t\\\n \t__val = _cmpxchg(pcp, __old, nval);\t\t\t\t\\\n \tif (__val != __old)\t\t\t\t\t\t\\\n \t\t*(ovalp) = __val;\t\t\t\t\t\\\n@@ -100,8 +100,8 @@ do {\t\t\t\t\t\t\t\t\t\\\n \n #define raw_cpu_generic_try_cmpxchg(pcp, ovalp, nval)\t\t\t\\\n ({\t\t\t\t\t\t\t\t\t\\\n-\ttypeof(pcp) *__p = raw_cpu_ptr(&(pcp));\t\t\t\t\\\n-\ttypeof(pcp) __val = *__p, ___old = *(ovalp);\t\t\t\\\n+\tTYPEOF_UNQUAL(pcp) *__p = raw_cpu_ptr(&(pcp));\t\t\t\\\n+\tTYPEOF_UNQUAL(pcp) __val = *__p, ___old = *(ovalp);\t\t\\\n \tbool __ret;\t\t\t\t\t\t\t\\\n \tif (__val == ___old) {\t\t\t\t\t\t\\\n \t\t*__p = nval;\t\t\t\t\t\t\\\n@@ -115,14 +115,14 @@ do {\t\t\t\t\t\t\t\t\t",
          "year": "2024",
          "month": "11"
        }
      ],
      "primary_category": "address_space"
    },
    {
      "subject": "[PATCH 2/6] compiler.h: Introduce TYPEOF_UNQUAL() macro",
      "normalized_subject": "compiler.h: Introduce TYPEOF_UNQUAL() macro",
      "message_count": 1,
      "participants": [
        "Uros Bizjak"
      ],
      "categories": [
        "kernel_integration",
        "rfc_proposals",
        "compiler_compat",
        "type_system"
      ],
      "first_date": "2024-11-26T17:21:19+00:00",
      "last_date": "2024-11-26T17:21:19+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/11/173264173903629.mbox",
          "message_id": "<20241126172332.112212-3-ubizjak () gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "[PATCH 2/6] compiler.h: Introduce TYPEOF_UNQUAL() macro",
          "date": "2024-11-26 17:21:19+00:00",
          "date_str": "Tue, 26 Nov 2024 17:21:19 +0000",
          "body": "Define TYPEOF_UNQUAL() to use __typeof_unqual__() as typeof operator\nwhen available, to return unqualified type of the expression.\n\nCurrent version of sparse doesn't know anything about __typeof_unqual__()\noperator. Avoid the usage of __typeof_unqual__() when sparse checking\nis active to prevent sparse errors with unknowing keyword.\n\nSigned-off-by: Uros Bizjak <ubizjak@gmail.com>\nCc: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>\nCc: Thomas Gleixner <tglx@linutronix.de>\nCc: Dennis Zhou <dennis@kernel.org>\nCc: Tejun Heo <tj@kernel.org>\nCc: Christoph Lameter <cl@linux.com>\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Andy Lutomirski <luto@kernel.org>\nCc: Ingo Molnar <mingo@kernel.org>\nCc: Nadav Amit <nadav.amit@gmail.com>\nCc: Brian Gerst <brgerst@gmail.com>\nCc: Denys Vlasenko <dvlasenk@redhat.com>\nCc: \"H. Peter Anvin\" <hpa@zytor.com>\nCc: Peter Zijlstra <peterz@infradead.org\n---\n include/linux/compiler.h | 13 +++++++++++++\n init/Kconfig             |  3 +++\n 2 files changed, 16 insertions(+)\n\ndiff --git a/include/linux/compiler.h b/include/linux/compiler.h\nindex 469a64dd6495..bb0bde335129 100644\n--- a/include/linux/compiler.h\n+++ b/include/linux/compiler.h\n@@ -321,6 +321,19 @@ static inline void *offset_to_ptr(const int *off)\n  */\n #define prevent_tail_call_optimization()\tmb()\n \n+/*\n+ * Define unqual_typeof() to use __typeof_unqual__() as typeof\n+ * operator when available, to return unqualified type of the exp.\n+ *\n+ * XXX: Remove test for __CHECKER__ once\n+ * sparse learns about __typeof_unqual__.\n+ */\n+#if defined(CONFIG_CC_HAS_TYPEOF_UNQUAL) && !defined(__CHECKER__)\n+# define TYPEOF_UNQUAL(exp) __typeof_unqual__(exp)\n+#else\n+# define TYPEOF_UNQUAL(exp) __typeof__(exp)\n+#endif\n+\n #include <asm/rwonce.h>\n \n #endif /* __LINUX_COMPILER_H */\ndiff --git a/init/Kconfig b/init/Kconfig\nindex a20e6efd3f0f..c1f9eb3d5f2e 100644\n--- a/init/Kconfig\n+++ b/init/Kconfig\n@@ -894,6 +894,9 @@ config ARCH_WANT_BATCHED_UNMAP_TLB_FLUSH\n config CC_HAS_INT128\n \tdef_bool !$(cc-option,$(m64-flag) -D__SIZEOF_INT128__=0) && 64BIT\n \n+config CC_HAS_TYPEOF_UNQUAL\n+\tdef_bool $(success,echo 'int foo (int a) { __typeof_unqual__(a) b = a; return b; }' | $(CC) -x c - -S -o /dev/null)\n+\n config CC_IMPLICIT_FALLTHROUGH\n \tstring\n \tdefault \"-Wimplicit-fallthrough=5\" if CC_IS_GCC && $(cc-option,-Wimplicit-fallthrough=5)\n-- \n2.42.0\n\n",
          "year": "2024",
          "month": "11"
        }
      ],
      "primary_category": "rfc_proposals"
    },
    {
      "subject": "[PATCH 0/6] Enable strict percpu address space checks",
      "normalized_subject": "Enable strict percpu address space checks",
      "message_count": 2,
      "participants": [
        "Uros Bizjak",
        "Dan Carpenter"
      ],
      "categories": [
        "kernel_integration",
        "sparse_internals",
        "type_system",
        "address_space",
        "compiler_compat",
        "rfc_proposals"
      ],
      "first_date": "2024-11-26T17:21:17+00:00",
      "last_date": "2024-12-04T07:24:41+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/11/173264192203815.mbox",
          "message_id": "<20241126172332.112212-1-ubizjak () gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "[PATCH 0/6] Enable strict percpu address space checks",
          "date": "2024-11-26 17:21:17+00:00",
          "date_str": "Tue, 26 Nov 2024 17:21:17 +0000",
          "body": "This patchset enables strict percpu address space checks via x86 named \naddress space qualifiers. Percpu variables are declared in\n__seg_gs/__seg_fs named AS and kept named AS qualified until they\nare dereferenced via percpu accessor. This approach enables various\ncompiler checks for cross-namespace variable assignments.\n\nPlease note that current version of sparse doesn't know anything about\n__typeof_unqual__() operator. Avoid the usage of __typeof_unqual__()\nwhen sparse checking is active to prevent sparse errors with unknowing\nkeyword.\n\nCc: Thomas Gleixner <tglx@linutronix.de>\nCc: Dennis Zhou <dennis@kernel.org>\nCc: Tejun Heo <tj@kernel.org>\nCc: Christoph Lameter <cl@linux.com>\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Andy Lutomirski <luto@kernel.org>\nCc: Ingo Molnar <mingo@kernel.org>\nCc: Luc Van Oostenryck <luc.vanoostenryck@gmail.com>\nCc: Nadav Amit <nadav.amit@gmail.com>\nCc: Brian Gerst <brgerst@gmail.com>\nCc: H. Peter Anvin <hpa@zytor.com>\nCc: Peter Zijlstra <peterz@infradead.org>\n\nUros Bizjak (6):\n  x86/kgdb: Use IS_ERR_PCPU() macro\n  compiler.h: Introduce TYPEOF_UNQUAL() macro\n  percpu: Use TYPEOF_UNQUAL() in variable declarations\n  percpu: Use TYPEOF_UNQUAL() in *_cpu_ptr() accessors\n  percpu: Repurpose __percpu tag as a named address space qualifier\n  percpu/x86: Enable strict percpu checks via named AS qualifiers\n\n arch/x86/include/asm/percpu.h  | 34 +++++++++++++++++++---------\n arch/x86/kernel/kgdb.c         |  2 +-\n fs/bcachefs/util.h             |  2 +-\n include/asm-generic/percpu.h   | 41 +++++++++++++++++++++++-----------\n include/linux/compiler.h       | 13 +++++++++++\n include/linux/compiler_types.h |  2 +-\n include/linux/part_stat.h      |  2 +-\n include/linux/percpu-defs.h    |  6 ++---\n include/net/snmp.h             |  5 ++---\n init/Kconfig                   |  3 +++\n kernel/locking/percpu-rwsem.c  |  2 +-\n net/mpls/internal.h            |  4 ++--\n 12 files changed, 80 insertions(+), 36 deletions(-)\n\n-- \n2.42.0\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/12/173329690703963.mbox",
          "message_id": "<5b8d0dee-8fb6-45af-ba6c-7f74aff9a4b8 () stanley ! mountain>",
          "author_name": "Dan Carpenter",
          "author_email": "dan.carpenter () linaro ! org",
          "subject": "Re: [PATCH 0/6] Enable strict percpu address space checks",
          "date": "2024-12-04 07:24:41+00:00",
          "date_str": "Wed, 04 Dec 2024 07:24:41 +0000",
          "body": "On Tue, Nov 26, 2024 at 06:21:17PM +0100, Uros Bizjak wrote:\n> This patchset enables strict percpu address space checks via x86 named \n> address space qualifiers. Percpu variables are declared in\n> __seg_gs/__seg_fs named AS and kept named AS qualified until they\n> are dereferenced via percpu accessor. This approach enables various\n> compiler checks for cross-namespace variable assignments.\n> \n> Please note that current version of sparse doesn't know anything about\n> __typeof_unqual__() operator. Avoid the usage of __typeof_unqual__()\n> when sparse checking is active to prevent sparse errors with unknowing\n> keyword.\n\nI don't think it would be super hard to add support to Sparse.  The only places\nwhere typeof and typeof_unqual are different is that you have to mask away the\nqualifiers in examine_typeof()?\n\nI would take over Sparse maintainership but I'm far too sloppy to do it.  We\nshould get Greg to take over, he likes abandoned projects.  ;)\n\nSigned-off-by: Dan Carpenter <dan.carpenter@linaro.org>\n---\n ast-inspect.c |  1 +\n ctags.c       |  1 +\n dissect.c     |  1 +\n evaluate.c    |  3 ++-\n parse.c       | 24 +++++++++++++++++++++---\n show-parse.c  |  1 +\n symbol.c      | 17 ++++++++++++++++-\n symbol.h      |  1 +\n 8 files changed, 44 insertions(+), 5 deletions(-)\n\ndiff --git a/ast-inspect.c b/ast-inspect.c\nindex b510cd9b1d2c..e940a93a411e 100644\n--- a/ast-inspect.c\n+++ b/ast-inspect.c\n@@ -110,6 +110,7 @@ static const char *symbol_type_name(enum type type)\n \t\t[SYM_UNION] = \"SYM_UNION\",\n \t\t[SYM_ENUM] = \"SYM_ENUM\",\n \t\t[SYM_TYPEOF] = \"SYM_TYPEOF\",\n+\t\t[SYM_TYPEOF_UNQUAL] = \"SYM_TYPEOF_UNQUAL\",\n \t\t[SYM_BITFIELD] = \"SYM_BITFIELD\",\n \t\t[SYM_LABEL] = \"SYM_LABEL\",\n \t\t[SYM_RESTRICT] = \"SYM_RESTRICT\",\ndiff --git a/ctags.c b/ctags.c\nindex aa5f9718d847..afdc42b77b98 100644\n--- a/ctags.c\n+++ b/ctags.c\n@@ -151,6 +151,7 @@ static void examine_symbol(struct symbol *sym)\n \t\tsym->kind = 'e';\n \tcase SYM_PTR:\n \tcase SYM_TYPEOF:\n+\tcase SYM_TYPEOF_UNQUAL:\n \tcase SYM_BITFIELD:\n \tcase SYM_FN:\n \tcase SYM_ARRAY:\ndiff --git a/dissect.c b/dissect.c\nindex 300d5ca99c97..9419c5931fbb 100644\n--- a/dissect.c\n+++ b/dissect.c\n@@ -212,6 +212,7 @@ static void examine_sym_node(struct symbol *node, struct symbol *parent)\n \twhile ((base = node->ctype.base_type) != NULL)\n \t\tswitch (base->type) {\n \t\tcase SYM_TYPEOF:\n+\t\tcase SYM_TYPEOF_UNQUAL:\n \t\t\tnode->ctype.base_type =\n \t\t\t\tdo_expression(U_VOID, base->initializer);\n \t\t\tbreak;\ndiff --git a/evaluate.c b/evaluate.c\nindex fe716f631987..85a6447ba3ce 100644\n--- a/evaluate.c\n+++ b/evaluate.c\n@@ -358,7 +358,8 @@ static inline int classify_type(struct symbol *type, struct symbol **base)\n \t};\n \tif (type->type == SYM_NODE)\n \t\ttype = type->ctype.base_type;\n-\tif (type->type == SYM_TYPEOF) {\n+\tif (type->type == SYM_TYPEOF ||\n+\t    type->type == SYM_TYPEOF_UNQUAL) {\n \t\ttype = examine_symbol_type(type);\n \t\tif (type->type == SYM_NODE)\n \t\t\ttype = type->ctype.base_type;\ndiff --git a/parse.c b/parse.c\nindex f868bf63a0f5..95894bf5e54d 100644\n--- a/parse.c\n+++ b/parse.c\n@@ -54,7 +54,7 @@ static struct token *handle_attributes(struct token *token, struct decl_state *c\n typedef struct token *declarator_t(struct token *, struct symbol *, struct decl_state *);\n static declarator_t\n \tstruct_specifier, union_specifier, enum_specifier,\n-\tattribute_specifier, typeof_specifier,\n+\tattribute_specifier, typeof_specifier, typeof_unqual_specifier,\n \tstorage_specifier, thread_specifier;\n static declarator_t generic_qualifier;\n static declarator_t autotype_specifier;\n@@ -196,6 +196,13 @@ static struct symbol_op typeof_op = {\n \t.set = Set_S|Set_T,\n };\n \n+static struct symbol_op typeof_unqual_op = {\n+\t.type = KW_SPECIFIER,\n+\t.declarator = typeof_unqual_specifier,\n+\t.test = Set_Any,\n+\t.set = Set_S|Set_T,\n+};\n+\n static struct symbol_op autotype_op = {\n \t.type = KW_SPECIFIER,\n \t.declarator = autotype_specifier,\n@@ -480,6 +487,7 @@ static struct init_keyword {\n \t/* Typedef ... */\n \tN(\"typedef\",\t\t&typedef_op,\t.mods = MOD_USERTYPE),\n \tA(\"typeof\",\t\t&typeof_op),\n+\tA(\"typeof_unqual\",\t&typeof_unqual_op),\n \tN(\"__auto_type\",\t&autotype_op),\n \n \t/* Type qualifiers */\n@@ -1052,7 +1060,7 @@ static struct token *enum_specifier(struct token *token, struct symbol *sym, str\n \treturn ret;\n }\n \n-static struct token *typeof_specifier(struct token *token, struct symbol *sym, struct decl_state *ctx)\n+static struct token *typeof_specifier_helper(struct token *token, struct symbol *sym, struct decl_state *ctx, bool qual)\n {\n \n \tif (!match_op(token, '(')) {\n@@ -1065,7 +1073,7 @@ static struct token *typeof_specifier(struct token *token, struct symbol *sym, s\n \t\tctx->ctype.base_type = sym->ctype.base_type;\n \t\tapply_ctype(token->pos, &ctx->ctype, &sym->ctype);\n \t} else {\n-\t\tstruct symbol *typeof_sym = alloc_symbol(token->pos, SYM_TYPEOF);\n+\t\tstruct symbol *typeof_sym = alloc_symbol(token->pos, qual? SYM_TYPEOF : SYM_TYPEOF_UNQUAL);\n \t\ttoken = parse_expression(token->next, &typeof_sym->initializer);\n \n \t\ttypeof_sym->endpos = token->pos;\n@@ -1078,6 +1086,16 @@ static ",
          "year": "2024",
          "month": "12"
        }
      ],
      "primary_category": "sparse_internals"
    },
    {
      "subject": "Re: [PATCH v4 1/2] compiler.h: add const_true()",
      "normalized_subject": "compiler.h: add const_true()",
      "message_count": 2,
      "participants": [
        "Linus Torvalds",
        "Vincent Mailhol"
      ],
      "categories": [
        "compiler_compat",
        "sparse_internals"
      ],
      "first_date": "2024-11-18T17:09:55+00:00",
      "last_date": "2024-12-31T04:58:04+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/11/173194964822788.mbox",
          "message_id": "<CAHk-=wg0r4XutgSRxzeEi6QQUJ4oej5o-kdS8j02KrLEXT4WnA () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [PATCH v4 1/2] compiler.h: add const_true()",
          "date": "2024-11-18 17:09:55+00:00",
          "date_str": "Mon, 18 Nov 2024 17:09:55 +0000",
          "body": "On Sun, 17 Nov 2024 at 19:22, Vincent Mailhol\n<mailhol.vincent@wanadoo.fr> wrote:\n>\n> I did a tree wide replacement of __is_constexpr() with is_const() and\n> did an allyesconfig build test. It yields a -Wint-in-bool-context\n> warning in GCC for both the \"0*!(x)\" and the \"0&&(x)\" each time the\n> expression contains non-boolean operators, for example: * or <<.\n\nGrr. Annoying. But yeah, replace the \"!\" with \"!= 0\" and I guess it\nshould be ok.\n\n             Linus\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/12/173562088607043.mbox",
          "message_id": "<f8d71557-b767-422d-976f-ab9902da87b8 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH v4 1/2] compiler.h: add const_true()",
          "date": "2024-12-31 04:58:04+00:00",
          "date_str": "Tue, 31 Dec 2024 04:58:04 +0000",
          "body": "On 31/12/2024 at 03:32, Yury Norov wrote:\n> On Wed, Nov 13, 2024 at 10:53:55AM -0800, Yury Norov wrote:\n>> On Thu, Nov 14, 2024 at 02:18:32AM +0900, Vincent Mailhol wrote:\n>>> __builtin_constant_p() is known for not always being able to produce\n>>> constant expression [1] which led to the introduction of\n>>> __is_constexpr() [2]. Because of its dependency on\n>>> __builtin_constant_p(), statically_true() suffers from the same\n>>> issues.\n>>>\n>>> For example:\n>>>\n>>>   void foo(int a)\n>>>   {\n>>>   \t /* fail on GCC */\n>>>   \tBUILD_BUG_ON_ZERO(statically_true(a));\n>>>\n>>>   \t /* fail on both clang and GCC */\n>>>   \tstatic char arr[statically_true(a) ? 1 : 2];\n>>>   }\n>>>\n>>> For the same reasons why __is_constexpr() was created to cover\n>>> __builtin_constant_p() edge cases, __is_constexpr() can be used to\n>>> resolve statically_true() limitations.\n>>>\n>>> Note that, somehow, GCC is not always able to fold this:\n>>>\n>>>   __is_constexpr(x) && (x)\n>>>\n>>> It is OK in BUILD_BUG_ON_ZERO() but not in array declarations nor in\n>>> static_assert():\n>>>\n>>>   void bar(int a)\n>>>   {\n>>>   \t/* success */\n>>>   \tBUILD_BUG_ON_ZERO(__is_constexpr(a) && (a));\n>>>\n>>>   \t/* fail on GCC */\n>>>   \tstatic char arr[__is_constexpr(a) && (a) ? 1 : 2];\n>>>\n>>>   \t/* fail on GCC */\n>>>   \tstatic_assert(__is_constexpr(a) && (a));\n>>>   }\n>>>\n>>> Encapsulating the expression in a __builtin_choose_expr() switch\n>>> resolves all these failed tests.\n>>>\n>>> Define a new const_true() macro which, by making use of the\n>>> __builtin_choose_expr() and __is_constexpr(x) combo, always produces a\n>>> constant expression.\n>>>\n>>> It should be noted that statically_true() is the only one able to fold\n>>> tautologic expressions in which at least one on the operands is not a\n>>> constant expression. For example:\n>>>\n>>>   statically_true(true || var)\n>>>   statically_true(var == var)\n>>>   statically_true(var * 0 + 1)\n>>>   statically_true(!(var * 8 % 4))\n>>>\n>>> always evaluates to true, whereas all of these would be false under\n>>> const_true() if var is not a constant expression [3].\n>>>\n>>> For this reason, usage of const_true() be should the exception.\n>>> Reflect in the documentation that const_true() is less powerful and\n>>> that statically_true() is the overall preferred solution.\n>>>\n>>> [1] __builtin_constant_p cannot resolve to const when optimizing\n>>> Link: https://gcc.gnu.org/bugzilla/show_bug.cgi?id=19449\n>>>\n>>> [2] commit 3c8ba0d61d04 (\"kernel.h: Retain constant expression output for max()/min()\")\n>>> Link: https://git.kernel.org/torvalds/c/3c8ba0d61d04\n>>>\n>>> [3] https://godbolt.org/z/c61PMxqbK\n>>>\n>>> Signed-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n>>\n>> For the series:\n>>\n>> Reviewed-by: Yury Norov <yury.norov@gmail.com>\n>>\n>> If no objections, I'll move it with my tree.\n> \n> This is already in my branch, but there was a discussion after I pulled\n> it. Can you guys tell me what is your conclusion on that? Should I\n> keep it in the branch, or drop?\n\nI see... Thanks for asking!\n\nAfter receiving criticism on this series, I was assuming that I had to\nrework it. But if given the option, I definitely prefer if you keep it\nin your tree.\n\nThe new series [1] I sent depends on this patch from David:\n\n  https://git.kernel.org/akpm/mm/c/c108f4c2947a\n\nwhich is causing build failure in linux-next. Because of that, I put my\nnew series of hiatus. And the merge windows approaches, so I would\nrather like that we just keep this series of two patches for 6.13 and\nthat I continue the bigger refactor of is_const() in the 6.14 cycle (by\nthen, the dependencies on David patch will hopefully be fixed).\n\nNote that the new series does not conflict with this one. So if this\nseries gets merged first, I see only benefit: it will offload some work\nand make the new series a bit smaller.\n\n[1]\nhttps://lore.kernel.org/all/20241203-is_constexpr-refactor-v1-0-4e4cbaecc216@wanadoo.fr/\n\n\nYours sincerely,\nVincent Mailhol\n\n",
          "year": "2024",
          "month": "12"
        }
      ],
      "primary_category": "sparse_internals"
    },
    {
      "subject": "Re: [PATCH 1/1] compiler.h: Add missing include statement for build_bug.h",
      "normalized_subject": "compiler.h: Add missing include statement for build_bug.h",
      "message_count": 9,
      "participants": [
        "Philipp Reisner",
        "Linus Torvalds",
        "Dan Carpenter"
      ],
      "categories": [
        "compiler_compat",
        "sparse_internals"
      ],
      "first_date": "2024-11-14T10:14:02+00:00",
      "last_date": "2024-11-14T18:28:02+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/11/173158043332203.mbox",
          "message_id": "<20241114101402.156397-2-philipp.reisner () linbit ! com>",
          "author_name": "Philipp Reisner",
          "author_email": "philipp.reisner () linbit ! com",
          "subject": "[PATCH 1/1] compiler.h: Add missing include statement for build_bug.h",
          "date": "2024-11-14 10:14:02+00:00",
          "date_str": "Thu, 14 Nov 2024 10:14:02 +0000",
          "body": "compiler.h defines __must_be_array() and __must_be_cstr() and both\nexpand to BUILD_BUG_ON_ZERO(). build_bug.h defines BUILD_BUG_ON_ZERO().\nSo far compiler.h lacks to include build_bug.h.\n\nFix compiler.h by including build_bug.h. With that compiler.h and\nbuild_bug.h depend on each other.\n\nSigned-off-by: Philipp Reisner <philipp.reisner@linbit.com>\n---\n include/linux/compiler.h | 1 +\n 1 file changed, 1 insertion(+)\n\ndiff --git a/include/linux/compiler.h b/include/linux/compiler.h\nindex 4d4e23b6e3e7..2d75e4892316 100644\n--- a/include/linux/compiler.h\n+++ b/include/linux/compiler.h\n@@ -3,6 +3,7 @@\n #define __LINUX_COMPILER_H\n \n #include <linux/compiler_types.h>\n+#include <linux/build_bug.h>    /* for BUILD_BUG_ON_ZERO() */\n \n #ifndef __ASSEMBLY__\n \n-- \n2.47.0\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173158138100528.mbox",
          "message_id": "<a2ed9ec0-4909-44bf-be11-21a22789e1d1 () stanley ! mountain>",
          "author_name": "Dan Carpenter",
          "author_email": "dan.carpenter () linaro ! org",
          "subject": "Re: [PATCH 1/1] compiler.h: Add missing include statement for build_bug.h",
          "date": "2024-11-14 10:40:23+00:00",
          "date_str": "Thu, 14 Nov 2024 10:40:23 +0000",
          "body": "On Thu, Nov 14, 2024 at 11:14:02AM +0100, Philipp Reisner wrote:\n> compiler.h defines __must_be_array() and __must_be_cstr() and both\n> expand to BUILD_BUG_ON_ZERO(). build_bug.h defines BUILD_BUG_ON_ZERO().\n> So far compiler.h lacks to include build_bug.h.\n> \n> Fix compiler.h by including build_bug.h. With that compiler.h and\n> build_bug.h depend on each other.\n> \n> Signed-off-by: Philipp Reisner <philipp.reisner@linbit.com>\n> ---\n\nFixes: ec0bbef66f86 (\"Compiler Attributes: homogenize __must_be_array\")\n\nWhat actually breaks?  This commit is six years old.  It's weird that we're only\nseeing build breakage now.  Or did you just notice this while reviewing the\ncode?\n\nregards,\ndan carpenter\n\n>  include/linux/compiler.h | 1 +\n>  1 file changed, 1 insertion(+)\n> \n> diff --git a/include/linux/compiler.h b/include/linux/compiler.h\n> index 4d4e23b6e3e7..2d75e4892316 100644\n> --- a/include/linux/compiler.h\n> +++ b/include/linux/compiler.h\n> @@ -3,6 +3,7 @@\n>  #define __LINUX_COMPILER_H\n>  \n>  #include <linux/compiler_types.h>\n> +#include <linux/build_bug.h>    /* for BUILD_BUG_ON_ZERO() */\n>  \n>  #ifndef __ASSEMBLY__\n>  \n> -- \n> 2.47.0\n> \n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173158338001943.mbox",
          "message_id": "<CADGDV=XZnkOUrc=AC=D5CeOHagiTbSGd2KGK0rN1MWoSXjidCw () mail ! gmail ! com>",
          "author_name": "Philipp Reisner",
          "author_email": "philipp.reisner () linbit ! com",
          "subject": "Re: [PATCH 1/1] compiler.h: Add missing include statement for build_bug.h",
          "date": "2024-11-14 11:01:42+00:00",
          "date_str": "Thu, 14 Nov 2024 11:01:42 +0000",
          "body": "On Thu, Nov 14, 2024 at 11:40=E2=80=AFAM Dan Carpenter <dan.carpenter@linar=\no.org> wrote:\n>\n> On Thu, Nov 14, 2024 at 11:14:02AM +0100, Philipp Reisner wrote:\n> > compiler.h defines __must_be_array() and __must_be_cstr() and both\n> > expand to BUILD_BUG_ON_ZERO(). build_bug.h defines BUILD_BUG_ON_ZERO().\n> > So far compiler.h lacks to include build_bug.h.\n> >\n> > Fix compiler.h by including build_bug.h. With that compiler.h and\n> > build_bug.h depend on each other.\n> >\n> > Signed-off-by: Philipp Reisner <philipp.reisner@linbit.com>\n> > ---\n>\n> Fixes: ec0bbef66f86 (\"Compiler Attributes: homogenize __must_be_array\")\n>\n> What actually breaks?  This commit is six years old.  It's weird that we'=\nre only\n> seeing build breakage now.  Or did you just notice this while reviewing t=\nhe\n> code?\n>\n\nI am working on a compilation unit that includes linux/string.h.\nCompiling it breaks when using strscp(). That is since commit\ncommit 559048d156ff3391c4b793779a824c9193e20442\nAuthor: Kees Cook <kees@kernel.org>\nDate:   Mon Aug 5 14:43:44 2024 -0700\n\nOf course, my trivial workaround is including build_bug.h in my\nsource; it is just not the proper way to fix this.\n\nbest regards,\n Phil\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173158219301071.mbox",
          "message_id": "<870a1165-6281-4ca7-9379-83fc6cccf702 () stanley ! mountain>",
          "author_name": "Dan Carpenter",
          "author_email": "dan.carpenter () linaro ! org",
          "subject": "Re: [PATCH 1/1] compiler.h: Add missing include statement for build_bug.h",
          "date": "2024-11-14 11:05:53+00:00",
          "date_str": "Thu, 14 Nov 2024 11:05:53 +0000",
          "body": "On Thu, Nov 14, 2024 at 12:01:42PM +0100, Philipp Reisner wrote:\n> On Thu, Nov 14, 2024 at 11:40\u202fAM Dan Carpenter <dan.carpenter@linaro.org> wrote:\n> >\n> > On Thu, Nov 14, 2024 at 11:14:02AM +0100, Philipp Reisner wrote:\n> > > compiler.h defines __must_be_array() and __must_be_cstr() and both\n> > > expand to BUILD_BUG_ON_ZERO(). build_bug.h defines BUILD_BUG_ON_ZERO().\n> > > So far compiler.h lacks to include build_bug.h.\n> > >\n> > > Fix compiler.h by including build_bug.h. With that compiler.h and\n> > > build_bug.h depend on each other.\n> > >\n> > > Signed-off-by: Philipp Reisner <philipp.reisner@linbit.com>\n> > > ---\n> >\n> > Fixes: ec0bbef66f86 (\"Compiler Attributes: homogenize __must_be_array\")\n> >\n> > What actually breaks?  This commit is six years old.  It's weird that we're only\n> > seeing build breakage now.  Or did you just notice this while reviewing the\n> > code?\n> >\n> \n> I am working on a compilation unit that includes linux/string.h.\n> Compiling it breaks when using strscp(). That is since commit\n> commit 559048d156ff3391c4b793779a824c9193e20442\n> Author: Kees Cook <kees@kernel.org>\n> Date:   Mon Aug 5 14:43:44 2024 -0700\n> \n> Of course, my trivial workaround is including build_bug.h in my\n> source; it is just not the proper way to fix this.\n> \n\nAh, okay.  Thanks.  I thought it might have broken in tree code.\n\nregards,\ndan carpenter\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173158219001060.mbox",
          "message_id": "<870a1165-6281-4ca7-9379-83fc6cccf702 () stanley ! mountain>",
          "author_name": "Dan Carpenter",
          "author_email": "dan.carpenter () linaro ! org",
          "subject": "Re: [PATCH 1/1] compiler.h: Add missing include statement for build_bug.h",
          "date": "2024-11-14 11:05:53+00:00",
          "date_str": "Thu, 14 Nov 2024 11:05:53 +0000",
          "body": "On Thu, Nov 14, 2024 at 12:01:42PM +0100, Philipp Reisner wrote:\n> On Thu, Nov 14, 2024 at 11:40\u202fAM Dan Carpenter <dan.carpenter@linaro.org> wrote:\n> >\n> > On Thu, Nov 14, 2024 at 11:14:02AM +0100, Philipp Reisner wrote:\n> > > compiler.h defines __must_be_array() and __must_be_cstr() and both\n> > > expand to BUILD_BUG_ON_ZERO(). build_bug.h defines BUILD_BUG_ON_ZERO().\n> > > So far compiler.h lacks to include build_bug.h.\n> > >\n> > > Fix compiler.h by including build_bug.h. With that compiler.h and\n> > > build_bug.h depend on each other.\n> > >\n> > > Signed-off-by: Philipp Reisner <philipp.reisner@linbit.com>\n> > > ---\n> >\n> > Fixes: ec0bbef66f86 (\"Compiler Attributes: homogenize __must_be_array\")\n> >\n> > What actually breaks?  This commit is six years old.  It's weird that we're only\n> > seeing build breakage now.  Or did you just notice this while reviewing the\n> > code?\n> >\n> \n> I am working on a compilation unit that includes linux/string.h.\n> Compiling it breaks when using strscp(). That is since commit\n> commit 559048d156ff3391c4b793779a824c9193e20442\n> Author: Kees Cook <kees@kernel.org>\n> Date:   Mon Aug 5 14:43:44 2024 -0700\n> \n> Of course, my trivial workaround is including build_bug.h in my\n> source; it is just not the proper way to fix this.\n> \n\nAh, okay.  Thanks.  I thought it might have broken in tree code.\n\nregards,\ndan carpenter\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173160840720750.mbox",
          "message_id": "<CAHk-=wgn=e3gD=tty+p1o8HBy7qxBCgCHiDEd5+FMtn9jdwd2g () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [PATCH 1/1] compiler.h: Add missing include statement for build_bug.h",
          "date": "2024-11-14 17:42:15+00:00",
          "date_str": "Thu, 14 Nov 2024 17:42:15 +0000",
          "body": "On Thu, 14 Nov 2024 at 02:23, Philipp Reisner\n<philipp.reisner@linbit.com> wrote:\n>\n> compiler.h defines __must_be_array() and __must_be_cstr() and both\n> expand to BUILD_BUG_ON_ZERO(). build_bug.h defines BUILD_BUG_ON_ZERO().\n> So far compiler.h lacks to include build_bug.h.\n\nThe bug is real, but..\n\n> Fix compiler.h by including build_bug.h. With that compiler.h and\n> build_bug.h depend on each other.\n\nI hate how compiler.h would include build_bug.h, which - on the very\nfirst line - then in turn includes compiler.h.\n\nDoes it *work*? Yes. The standard include guards stop the thing from\nrecursing, and both headers only do create pre-processor defines, so\nthe dependencies aren't ordered, but it's really really ugly to have\nthese kinds of circular includes.\n\nI think a better fix would be to not use BUILD_BUG_ON_ZERO() at all,\nbut just use _Static_assert() directly here, to make\n<linux/compiler.h> be more self-sufficient.\n\nThe gcc docs say that __builtin_types_compatible_p() and\n__builtin_has_attribute() both return an integer constant expression,\nso that should be fine (the advantage of BUILD_BUG_ON_ZERO() is that\nit works in some contexts that aren't necessarily technically integer\nconstant expressions - as long as they just evaluate to a constant).\n\nWe historically used to avoid _Static_assert(), but that was for\nhistorical reasons (ie it's one of those things that didn't exist back\nin the day..)\n\nHmm?\n\n              Linus\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173160805820582.mbox",
          "message_id": "<CAHk-=wgn=e3gD=tty+p1o8HBy7qxBCgCHiDEd5+FMtn9jdwd2g () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [PATCH 1/1] compiler.h: Add missing include statement for build_bug.h",
          "date": "2024-11-14 17:42:15+00:00",
          "date_str": "Thu, 14 Nov 2024 17:42:15 +0000",
          "body": "On Thu, 14 Nov 2024 at 02:23, Philipp Reisner\n<philipp.reisner@linbit.com> wrote:\n>\n> compiler.h defines __must_be_array() and __must_be_cstr() and both\n> expand to BUILD_BUG_ON_ZERO(). build_bug.h defines BUILD_BUG_ON_ZERO().\n> So far compiler.h lacks to include build_bug.h.\n\nThe bug is real, but..\n\n> Fix compiler.h by including build_bug.h. With that compiler.h and\n> build_bug.h depend on each other.\n\nI hate how compiler.h would include build_bug.h, which - on the very\nfirst line - then in turn includes compiler.h.\n\nDoes it *work*? Yes. The standard include guards stop the thing from\nrecursing, and both headers only do create pre-processor defines, so\nthe dependencies aren't ordered, but it's really really ugly to have\nthese kinds of circular includes.\n\nI think a better fix would be to not use BUILD_BUG_ON_ZERO() at all,\nbut just use _Static_assert() directly here, to make\n<linux/compiler.h> be more self-sufficient.\n\nThe gcc docs say that __builtin_types_compatible_p() and\n__builtin_has_attribute() both return an integer constant expression,\nso that should be fine (the advantage of BUILD_BUG_ON_ZERO() is that\nit works in some contexts that aren't necessarily technically integer\nconstant expressions - as long as they just evaluate to a constant).\n\nWe historically used to avoid _Static_assert(), but that was for\nhistorical reasons (ie it's one of those things that didn't exist back\nin the day..)\n\nHmm?\n\n              Linus\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173160907221149.mbox",
          "message_id": "<CAHk-=wjLSEcZ5LdW+3C+9rtjvNPHZT6zdk0POj67T5k2ZpDbgA () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [PATCH 1/1] compiler.h: Add missing include statement for build_bug.h",
          "date": "2024-11-14 18:28:02+00:00",
          "date_str": "Thu, 14 Nov 2024 18:28:02 +0000",
          "body": "On Thu, 14 Nov 2024 at 09:42, Linus Torvalds\n<torvalds@linux-foundation.org> wrote:\n>\n> I think a better fix would be to not use BUILD_BUG_ON_ZERO() at all,\n> but just use _Static_assert() directly here, to make\n> <linux/compiler.h> be more self-sufficient.\n\nDamn. We can't do that, because we typically use this in contexts that\nrequire us to return zero (because the assertion part of an\nexpression), and then that whole expression needs to be a constant\ninteger expression.\n\nAnd because _Static_assert() isn't an expression, we'd need to wrap it\nwith a statement expression or something.\n\nAnd *hat* we can't do in arbitrary contexts.\n\nGrr. I absolutely detest how bad the standard tools are. It's kind of\nsad how we need to build our own hacky BUILD_BUG_ON() to do this.\n\nThere's probably some trick I'm missing, but yeah, it looks like we\nneed our BUILD_BUG_ON_ZERO() thing with that crazy bitfield hack.\n\n                           Linus\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173160873720961.mbox",
          "message_id": "<CAHk-=wjLSEcZ5LdW+3C+9rtjvNPHZT6zdk0POj67T5k2ZpDbgA () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [PATCH 1/1] compiler.h: Add missing include statement for build_bug.h",
          "date": "2024-11-14 18:28:02+00:00",
          "date_str": "Thu, 14 Nov 2024 18:28:02 +0000",
          "body": "On Thu, 14 Nov 2024 at 09:42, Linus Torvalds\n<torvalds@linux-foundation.org> wrote:\n>\n> I think a better fix would be to not use BUILD_BUG_ON_ZERO() at all,\n> but just use _Static_assert() directly here, to make\n> <linux/compiler.h> be more self-sufficient.\n\nDamn. We can't do that, because we typically use this in contexts that\nrequire us to return zero (because the assertion part of an\nexpression), and then that whole expression needs to be a constant\ninteger expression.\n\nAnd because _Static_assert() isn't an expression, we'd need to wrap it\nwith a statement expression or something.\n\nAnd *hat* we can't do in arbitrary contexts.\n\nGrr. I absolutely detest how bad the standard tools are. It's kind of\nsad how we need to build our own hacky BUILD_BUG_ON() to do this.\n\nThere's probably some trick I'm missing, but yeah, it looks like we\nneed our BUILD_BUG_ON_ZERO() thing with that crazy bitfield hack.\n\n                           Linus\n",
          "year": "2024",
          "month": "11"
        }
      ],
      "primary_category": "sparse_internals"
    },
    {
      "subject": "[PATCH v4 0/2] add const_true() to simplify GENMASK_INPUT_CHECK()",
      "normalized_subject": "add const_true() to simplify GENMASK_INPUT_CHECK()",
      "message_count": 1,
      "participants": [
        "Vincent Mailhol"
      ],
      "categories": [
        "rfc_proposals",
        "compiler_compat"
      ],
      "first_date": "2024-11-13T17:18:31+00:00",
      "last_date": "2024-11-13T17:18:31+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/11/173151886327472.mbox",
          "message_id": "<20241113172939.747686-4-mailhol.vincent () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "[PATCH v4 0/2] add const_true() to simplify GENMASK_INPUT_CHECK()",
          "date": "2024-11-13 17:18:31+00:00",
          "date_str": "Wed, 13 Nov 2024 17:18:31 +0000",
          "body": "The first patch introduces a new variant of statically_true() named\nconst_true() which rely on __is_constexpr() to produce a constant\nexpression result which can be used in BUILD_BUG_ON_ZERO() and other\nmacros which expect a constant expression as input.\n\nThe second patch applies this newly created const_true() to\nGENMASK_INPUT_CHECK().\n---\n\n** Changelog **\n\nv3 -> v4:\n\n   - rename _statically_true() into const_true().\n\n   - fix incorrect subject in the first patch.\n\n   - s/Declare/Define in first patch description: macro are defined,\n     not declared.\n\n   - move the godbolt link with the tautology folding examples as a\n     footnote into the patch description (was after the --- scissors\n     in v3).\n\n   - add more examples of tautologically true expressions in the first\n     patch description.\n\n   - Rewrite the paragraph in the macro comment which compares\n     statically_true() with const_true() and add code examples\n     directly into that comment.\n\nLink: https://lore.kernel.org/all/20241112190840.601378-4-mailhol.vincent@wanadoo.fr/\n\nv3 -> v3 RESEND:\n\n   - send email using the smtp.wanadoo.fr gateway. Note that this may\n     appear as smtp.orange.fr which is an alias (both have the same IP).\n\nLink: https://lore.kernel.org/all/20241112140454.518823-4-mailhol.vincent@wanadoo.fr/\n\nv2 -> v3:\n\n   - split the single patch into a series of two patches.\n\n   - add explanation of why _statically_true() is needed in addition\n     to the existing statically_true(). Explain the pros and cons of\n     each.\n\n   - use __builtin_choose_expr() in _statically_true(). The\n     _statically_true() of the v2 works perfectly fine when used in\n     conjunction with BUILD_BUG_ON_ZERO() but fails if used, for\n     example, in arrays or in static_assert().\n\nLink: https://lore.kernel.org/all/20241111164743.339117-2-mailhol.vincent@wanadoo.fr/\n\nv1 -> v2:\n\n   - introduce _statically_true(), taking inspiration from\n     statically_true() as introduced in commit 22f546873149 (\"minmax:\n     improve macro expansion and type checking\").\n\nLink: https://lore.kernel.org/all/20240609073513.256179-1-mailhol.vincent@wanadoo.fr/\n\nVincent Mailhol (2):\n  compiler.h: add const_true()\n  linux/bits.h: simplify GENMASK_INPUT_CHECK()\n\n include/linux/bits.h     |  5 ++---\n include/linux/compiler.h | 22 ++++++++++++++++++++++\n 2 files changed, 24 insertions(+), 3 deletions(-)\n\n-- \n2.45.2\n\n",
          "year": "2024",
          "month": "11"
        }
      ],
      "primary_category": "rfc_proposals"
    },
    {
      "subject": "[RESEND PATCH v3 2/2] linux/bits.h: simplify GENMASK_INPUT_CHECK()",
      "normalized_subject": "[RESEND PATCH v3 2/2] linux/bits.h: simplify GENMASK_INPUT_CHECK()",
      "message_count": 1,
      "participants": [
        "Vincent Mailhol"
      ],
      "categories": [
        "rfc_proposals",
        "compiler_compat",
        "type_system"
      ],
      "first_date": "2024-11-12T19:08:40+00:00",
      "last_date": "2024-11-12T19:08:40+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/11/173143841114629.mbox",
          "message_id": "<20241112190840.601378-6-mailhol.vincent () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "[RESEND PATCH v3 2/2] linux/bits.h: simplify GENMASK_INPUT_CHECK()",
          "date": "2024-11-12 19:08:40+00:00",
          "date_str": "Tue, 12 Nov 2024 19:08:40 +0000",
          "body": "In GENMASK_INPUT_CHECK(),\n\n  __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n\nis the exact expansion of:\n\n  _statically_true((l) > (h))\n\nApply _statically_true() to simplify GENMASK_INPUT_CHECK().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\nThis change passes the unit tests from CONFIG_BITS_TEST, including the\nextra negative tests provided under #ifdef TEST_GENMASK_FAILURES [1].\n\n[1] commit 6d511020e13d (\"lib/test_bits.c: add tests of GENMASK\")\nLink: https://git.kernel.org/torvalds/c/6d511020e13d\n\n** Changelog **\n\nv2 -> v3:\n\n   - split the single patch into a series of two patches.\n\n   - add greater explanation of why _statically_true() is needed in\n     addition of the existing statically_true(). Explain the pros and\n     cons of both.\n\n   - use __builtin_choose_expr() in _statically_true(). The\n     _statically_true() of the v2 works perfectly fine when used in\n     conjunction with BUILD_BUG_ON_ZERO() but fails if used in arrays\n     or in static_assert()\n\n   - update the patch description accordingly\n\nLink: https://lore.kernel.org/all/20241111164743.339117-2-mailhol.vincent@wanadoo.fr/\n\nv1 -> v2:\n\n   - introduce _statically_true(), taking inspiration from\n     statically_true() as introduced in commit 22f546873149 (\"minmax:\n     improve macro expansion and type checking\").\n\nLink: https://lore.kernel.org/all/20240609073513.256179-1-mailhol.vincent@wanadoo.fr/\n---\n include/linux/bits.h | 5 ++---\n 1 file changed, 2 insertions(+), 3 deletions(-)\n\ndiff --git a/include/linux/bits.h b/include/linux/bits.h\nindex 60044b608817..01713e1eda56 100644\n--- a/include/linux/bits.h\n+++ b/include/linux/bits.h\n@@ -20,9 +20,8 @@\n  */\n #if !defined(__ASSEMBLY__)\n #include <linux/build_bug.h>\n-#define GENMASK_INPUT_CHECK(h, l) \\\n-\t(BUILD_BUG_ON_ZERO(__builtin_choose_expr( \\\n-\t\t__is_constexpr((l) > (h)), (l) > (h), 0)))\n+#include <linux/compiler.h>\n+#define GENMASK_INPUT_CHECK(h, l) BUILD_BUG_ON_ZERO(_statically_true((l) > (h)))\n #else\n /*\n  * BUILD_BUG_ON_ZERO is not available in h files included from asm files,\n-- \n2.45.2\n\n",
          "year": "2024",
          "month": "11"
        }
      ],
      "primary_category": "rfc_proposals"
    },
    {
      "subject": "Re: [RESEND PATCH v3 1/2] compiler.h: add _static_assert()",
      "normalized_subject": "[RESEND PATCH v3 1/2] compiler.h: add _static_assert()",
      "message_count": 6,
      "participants": [
        "Yury Norov",
        "Rasmus Villemoes",
        "Vincent Mailhol"
      ],
      "categories": [
        "compiler_compat",
        "sparse_internals"
      ],
      "first_date": "2024-11-12T19:08:39+00:00",
      "last_date": "2024-11-13T17:47:38+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/11/173145135522332.mbox",
          "message_id": "<20241112190840.601378-5-mailhol.vincent () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "[RESEND PATCH v3 1/2] compiler.h: add _static_assert()",
          "date": "2024-11-12 19:08:39+00:00",
          "date_str": "Tue, 12 Nov 2024 19:08:39 +0000",
          "body": "__builtin_constant_p() is known for not always being able to produce\nconstant expression [1] which lead to the introduction of\n__is_constexpr() [2]. Because of its dependency on\n__builtin_constant_p(), statically_true() suffers from the same\nissues.\n\nFor example:\n\n  void foo(int a)\n  {\n  \t /* fail on GCC */\n  \tBUILD_BUG_ON_ZERO(statically_true(a));\n\n  \t /* fail both clang and GCC */\n  \tstatic char arr[statically_true(a) ? 1 : 2];\n  }\n\nFor the same reasons why __is_constexpr() was created to cover\n__builtin_constant_p() edge cases, __is_constexpr() can be used to\nresolve statically_true() limitations.\n\nNote that, somehow, GCC is not always able to fold this:\n\n  __is_constexpr(x) && (x)\n\nIt is OK in BUILD_BUG_ON_ZERO() but not in array declarations or in\nstatic_assert():\n\n  void bar(int a)\n  {\n  \t/* success */\n  \tBUILD_BUG_ON_ZERO(__is_constexpr(a) && (a));\n\n  \t/* fail on GCC */\n  \tstatic char arr[__is_constexpr(a) && (a) ? 1 : 2];\n\n  \t/* fail on GCC */\n  \tstatic_assert(__is_constexpr(a) && (a));\n  }\n\nEncapsulating the expression in a __builtin_choose_expr() switch\nresolves all these failed test.\n\nDeclare a new _statically_true() macro which, by making use of the\n__builtin_choose_expr() and __is_constexpr(x) combo, always produces a\nconstant expression.\n\nIt should be noted that statically_true() still produces better\nfolding:\n\n  statically_true(!(var * 8 % 8))\n\nalways evaluates to true even if var is unknown, whereas\n\n  _statically_true(!(var * 8 % 8))\n\nfails to fold the expression and return false.\n\nFor this reason, usage of _statically_true() be should the exception.\nReflect in the documentation that _statically_true() is less powerful\nand that statically_true() is the overall preferred solution.\n\n[1] __builtin_constant_p cannot resolve to const when optimizing\nLink: https://gcc.gnu.org/bugzilla/show_bug.cgi?id=19449\n\n[2] commit 3c8ba0d61d04 (\"kernel.h: Retain constant expression output for max()/min()\")\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\nBonuses:\n\n  - above examples, and a bit more:\n\n      https://godbolt.org/z/zzqM1ajPj\n\n  - a proof that statically_true() does better constant folding than _statically_true()\n\n      https://godbolt.org/z/vK6KK4hMG\n---\n include/linux/compiler.h | 14 ++++++++++++++\n 1 file changed, 14 insertions(+)\n\ndiff --git a/include/linux/compiler.h b/include/linux/compiler.h\nindex 4d4e23b6e3e7..c76db8b50202 100644\n--- a/include/linux/compiler.h\n+++ b/include/linux/compiler.h\n@@ -308,6 +308,20 @@ static inline void *offset_to_ptr(const int *off)\n  */\n #define statically_true(x) (__builtin_constant_p(x) && (x))\n \n+/*\n+ * Similar to statically_true() but produces a constant expression\n+ *\n+ * To be used in conjunction with macros, such as BUILD_BUG_ON_ZERO(),\n+ * which require their input to be a constant expression and for which\n+ * statically_true() would otherwise fail.\n+ *\n+ * This is a tradeoff: _statically_true() is less efficient at\n+ * constant folding and will fail to optimize any expressions in which\n+ * at least one of the subcomponent is not constant. For the general\n+ * case, statically_true() is better.\n+ */\n+#define _statically_true(x) __builtin_choose_expr(__is_constexpr(x), x, false)\n+\n /*\n  * This is needed in functions which generate the stack canary, see\n  * arch/x86/kernel/smpboot.c::start_secondary() for an example.\n-- \n2.45.2\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173143912915063.mbox",
          "message_id": "<20241112190840.601378-5-mailhol.vincent () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "[RESEND PATCH v3 1/2] compiler.h: add _static_assert()",
          "date": "2024-11-12 19:08:39+00:00",
          "date_str": "Tue, 12 Nov 2024 19:08:39 +0000",
          "body": "__builtin_constant_p() is known for not always being able to produce\nconstant expression [1] which lead to the introduction of\n__is_constexpr() [2]. Because of its dependency on\n__builtin_constant_p(), statically_true() suffers from the same\nissues.\n\nFor example:\n\n  void foo(int a)\n  {\n  \t /* fail on GCC */\n  \tBUILD_BUG_ON_ZERO(statically_true(a));\n\n  \t /* fail both clang and GCC */\n  \tstatic char arr[statically_true(a) ? 1 : 2];\n  }\n\nFor the same reasons why __is_constexpr() was created to cover\n__builtin_constant_p() edge cases, __is_constexpr() can be used to\nresolve statically_true() limitations.\n\nNote that, somehow, GCC is not always able to fold this:\n\n  __is_constexpr(x) && (x)\n\nIt is OK in BUILD_BUG_ON_ZERO() but not in array declarations or in\nstatic_assert():\n\n  void bar(int a)\n  {\n  \t/* success */\n  \tBUILD_BUG_ON_ZERO(__is_constexpr(a) && (a));\n\n  \t/* fail on GCC */\n  \tstatic char arr[__is_constexpr(a) && (a) ? 1 : 2];\n\n  \t/* fail on GCC */\n  \tstatic_assert(__is_constexpr(a) && (a));\n  }\n\nEncapsulating the expression in a __builtin_choose_expr() switch\nresolves all these failed test.\n\nDeclare a new _statically_true() macro which, by making use of the\n__builtin_choose_expr() and __is_constexpr(x) combo, always produces a\nconstant expression.\n\nIt should be noted that statically_true() still produces better\nfolding:\n\n  statically_true(!(var * 8 % 8))\n\nalways evaluates to true even if var is unknown, whereas\n\n  _statically_true(!(var * 8 % 8))\n\nfails to fold the expression and return false.\n\nFor this reason, usage of _statically_true() be should the exception.\nReflect in the documentation that _statically_true() is less powerful\nand that statically_true() is the overall preferred solution.\n\n[1] __builtin_constant_p cannot resolve to const when optimizing\nLink: https://gcc.gnu.org/bugzilla/show_bug.cgi?id=19449\n\n[2] commit 3c8ba0d61d04 (\"kernel.h: Retain constant expression output for max()/min()\")\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\nBonuses:\n\n  - above examples, and a bit more:\n\n      https://godbolt.org/z/zzqM1ajPj\n\n  - a proof that statically_true() does better constant folding than _statically_true()\n\n      https://godbolt.org/z/vK6KK4hMG\n---\n include/linux/compiler.h | 14 ++++++++++++++\n 1 file changed, 14 insertions(+)\n\ndiff --git a/include/linux/compiler.h b/include/linux/compiler.h\nindex 4d4e23b6e3e7..c76db8b50202 100644\n--- a/include/linux/compiler.h\n+++ b/include/linux/compiler.h\n@@ -308,6 +308,20 @@ static inline void *offset_to_ptr(const int *off)\n  */\n #define statically_true(x) (__builtin_constant_p(x) && (x))\n \n+/*\n+ * Similar to statically_true() but produces a constant expression\n+ *\n+ * To be used in conjunction with macros, such as BUILD_BUG_ON_ZERO(),\n+ * which require their input to be a constant expression and for which\n+ * statically_true() would otherwise fail.\n+ *\n+ * This is a tradeoff: _statically_true() is less efficient at\n+ * constant folding and will fail to optimize any expressions in which\n+ * at least one of the subcomponent is not constant. For the general\n+ * case, statically_true() is better.\n+ */\n+#define _statically_true(x) __builtin_choose_expr(__is_constexpr(x), x, false)\n+\n /*\n  * This is needed in functions which generate the stack canary, see\n  * arch/x86/kernel/smpboot.c::start_secondary() for an example.\n-- \n2.45.2\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173145194022610.mbox",
          "message_id": "<8734jwnrrz.fsf () prevas ! dk>",
          "author_name": "Rasmus Villemoes",
          "author_email": "linux () rasmusvillemoes ! dk",
          "subject": "Re: [RESEND PATCH v3 1/2] compiler.h: add _static_assert()",
          "date": "2024-11-12 20:03:44+00:00",
          "date_str": "Tue, 12 Nov 2024 20:03:44 +0000",
          "body": "On Wed, Nov 13 2024, Vincent Mailhol <mailhol.vincent@wanadoo.fr> wrote:\n\n>\n> Declare a new _statically_true() macro which, by making use of the\n> __builtin_choose_expr() and __is_constexpr(x) combo, always produces a\n> constant expression.\n\nLooks sane, but $subject needs s/_static_assert/_statically_true/. And\nto be completely pedantic, macros are defined, not declared.\n>\n>   - above examples, and a bit more:\n>\n>       https://godbolt.org/z/zzqM1ajPj\n>\n>   - a proof that statically_true() does better constant folding than _statically_true()\n>\n>       https://godbolt.org/z/vK6KK4hMG\n\nAt least the second of these might be good to refer to in the commit\nmessage itself.\n\nRasmus\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173145311523202.mbox",
          "message_id": "<ZzO5390yVTqNbgJl () yury-ThinkPad>",
          "author_name": "Yury Norov",
          "author_email": "yury.norov () gmail ! com",
          "subject": "Re: [RESEND PATCH v3 1/2] compiler.h: add _static_assert()",
          "date": "2024-11-12 20:26:07+00:00",
          "date_str": "Tue, 12 Nov 2024 20:26:07 +0000",
          "body": "On Wed, Nov 13, 2024 at 04:08:39AM +0900, Vincent Mailhol wrote:\n> __builtin_constant_p() is known for not always being able to produce\n> constant expression [1] which lead to the introduction of\n> __is_constexpr() [2]. Because of its dependency on\n> __builtin_constant_p(), statically_true() suffers from the same\n> issues.\n> \n> For example:\n> \n>   void foo(int a)\n>   {\n>   \t /* fail on GCC */\n>   \tBUILD_BUG_ON_ZERO(statically_true(a));\n> \n>   \t /* fail both clang and GCC */\n>   \tstatic char arr[statically_true(a) ? 1 : 2];\n>   }\n> \n> For the same reasons why __is_constexpr() was created to cover\n> __builtin_constant_p() edge cases, __is_constexpr() can be used to\n> resolve statically_true() limitations.\n> \n> Note that, somehow, GCC is not always able to fold this:\n> \n>   __is_constexpr(x) && (x)\n> \n> It is OK in BUILD_BUG_ON_ZERO() but not in array declarations or in\n> static_assert():\n> \n>   void bar(int a)\n>   {\n>   \t/* success */\n>   \tBUILD_BUG_ON_ZERO(__is_constexpr(a) && (a));\n> \n>   \t/* fail on GCC */\n>   \tstatic char arr[__is_constexpr(a) && (a) ? 1 : 2];\n> \n>   \t/* fail on GCC */\n>   \tstatic_assert(__is_constexpr(a) && (a));\n>   }\n> \n> Encapsulating the expression in a __builtin_choose_expr() switch\n> resolves all these failed test.\n> \n> Declare a new _statically_true() macro which, by making use of the\n> __builtin_choose_expr() and __is_constexpr(x) combo, always produces a\n> constant expression.\n\nSo, maybe name it const_true() then?\n \n> It should be noted that statically_true() still produces better\n> folding:\n> \n>   statically_true(!(var * 8 % 8))\n> \n> always evaluates to true even if var is unknown, whereas\n> \n>   _statically_true(!(var * 8 % 8))\n> \n> fails to fold the expression and return false.\n> \n> For this reason, usage of _statically_true() be should the exception.\n> Reflect in the documentation that _statically_true() is less powerful\n> and that statically_true() is the overall preferred solution.\n> \n> [1] __builtin_constant_p cannot resolve to const when optimizing\n> Link: https://gcc.gnu.org/bugzilla/show_bug.cgi?id=19449\n> \n> [2] commit 3c8ba0d61d04 (\"kernel.h: Retain constant expression output for max()/min()\")\n> \n> Signed-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n> ---\n> Bonuses:\n> \n>   - above examples, and a bit more:\n> \n>       https://godbolt.org/z/zzqM1ajPj\n> \n>   - a proof that statically_true() does better constant folding than _statically_true()\n> \n>       https://godbolt.org/z/vK6KK4hMG\n> ---\n>  include/linux/compiler.h | 14 ++++++++++++++\n>  1 file changed, 14 insertions(+)\n> \n> diff --git a/include/linux/compiler.h b/include/linux/compiler.h\n> index 4d4e23b6e3e7..c76db8b50202 100644\n> --- a/include/linux/compiler.h\n> +++ b/include/linux/compiler.h\n> @@ -308,6 +308,20 @@ static inline void *offset_to_ptr(const int *off)\n>   */\n>  #define statically_true(x) (__builtin_constant_p(x) && (x))\n>  \n> +/*\n> + * Similar to statically_true() but produces a constant expression\n> + *\n> + * To be used in conjunction with macros, such as BUILD_BUG_ON_ZERO(),\n> + * which require their input to be a constant expression and for which\n> + * statically_true() would otherwise fail.\n> + *\n> + * This is a tradeoff: _statically_true() is less efficient at\n> + * constant folding and will fail to optimize any expressions in which\n> + * at least one of the subcomponent is not constant. For the general\n> + * case, statically_true() is better.\n\nI agree with Rasmus. Would be nice to have examples where should I use\none vs another right here in the comment.\n\n> + */\n> +#define _statically_true(x) __builtin_choose_expr(__is_constexpr(x), x, false)\n> +\n>  /*\n>   * This is needed in functions which generate the stack canary, see\n>   * arch/x86/kernel/smpboot.c::start_secondary() for an example.\n> -- \n> 2.45.2\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173151978028192.mbox",
          "message_id": "<2fd6212c-6406-4435-8cde-8a07aa16d933 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [RESEND PATCH v3 1/2] compiler.h: add _static_assert()",
          "date": "2024-11-13 17:44:10+00:00",
          "date_str": "Wed, 13 Nov 2024 17:44:10 +0000",
          "body": "On 13/11/2024 at 05:26, Yury Norov wrote:\n> On Wed, Nov 13, 2024 at 04:08:39AM +0900, Vincent Mailhol wrote:\n>> __builtin_constant_p() is known for not always being able to produce\n>> constant expression [1] which lead to the introduction of\n>> __is_constexpr() [2]. Because of its dependency on\n>> __builtin_constant_p(), statically_true() suffers from the same\n>> issues.\n>>\n>> For example:\n>>\n>>    void foo(int a)\n>>    {\n>>    \t /* fail on GCC */\n>>    \tBUILD_BUG_ON_ZERO(statically_true(a));\n>>\n>>    \t /* fail both clang and GCC */\n>>    \tstatic char arr[statically_true(a) ? 1 : 2];\n>>    }\n>>\n>> For the same reasons why __is_constexpr() was created to cover\n>> __builtin_constant_p() edge cases, __is_constexpr() can be used to\n>> resolve statically_true() limitations.\n>>\n>> Note that, somehow, GCC is not always able to fold this:\n>>\n>>    __is_constexpr(x) && (x)\n>>\n>> It is OK in BUILD_BUG_ON_ZERO() but not in array declarations or in\n>> static_assert():\n>>\n>>    void bar(int a)\n>>    {\n>>    \t/* success */\n>>    \tBUILD_BUG_ON_ZERO(__is_constexpr(a) && (a));\n>>\n>>    \t/* fail on GCC */\n>>    \tstatic char arr[__is_constexpr(a) && (a) ? 1 : 2];\n>>\n>>    \t/* fail on GCC */\n>>    \tstatic_assert(__is_constexpr(a) && (a));\n>>    }\n>>\n>> Encapsulating the expression in a __builtin_choose_expr() switch\n>> resolves all these failed test.\n>>\n>> Declare a new _statically_true() macro which, by making use of the\n>> __builtin_choose_expr() and __is_constexpr(x) combo, always produces a\n>> constant expression.\n> So, maybe name it const_true() then?\n\n\nOK. I pretty like the _statically_true() because the link with \nstatically_true() was obvious and the _ underscore prefix hinted that \nthis variant was \"special\". But I have to admit that the const_true() is \nalso really nice, and I finally adopted it in the v4.\n\n>> It should be noted that statically_true() still produces better\n>> folding:\n>>\n>>    statically_true(!(var * 8 % 8))\n>>\n>> always evaluates to true even if var is unknown, whereas\n>>\n>>    _statically_true(!(var * 8 % 8))\n>>\n>> fails to fold the expression and return false.\n>>\n>> For this reason, usage of _statically_true() be should the exception.\n>> Reflect in the documentation that _statically_true() is less powerful\n>> and that statically_true() is the overall preferred solution.\n>>\n>> [1] __builtin_constant_p cannot resolve to const when optimizing\n>> Link: https://gcc.gnu.org/bugzilla/show_bug.cgi?id=19449\n>>\n>> [2] commit 3c8ba0d61d04 (\"kernel.h: Retain constant expression output for max()/min()\")\n>>\n>> Signed-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n>> ---\n>> Bonuses:\n>>\n>>    - above examples, and a bit more:\n>>\n>>        https://godbolt.org/z/zzqM1ajPj\n>>\n>>    - a proof that statically_true() does better constant folding than _statically_true()\n>>\n>>        https://godbolt.org/z/vK6KK4hMG\n>> ---\n>>   include/linux/compiler.h | 14 ++++++++++++++\n>>   1 file changed, 14 insertions(+)\n>>\n>> diff --git a/include/linux/compiler.h b/include/linux/compiler.h\n>> index 4d4e23b6e3e7..c76db8b50202 100644\n>> --- a/include/linux/compiler.h\n>> +++ b/include/linux/compiler.h\n>> @@ -308,6 +308,20 @@ static inline void *offset_to_ptr(const int *off)\n>>    */\n>>   #define statically_true(x) (__builtin_constant_p(x) && (x))\n>>   \n>> +/*\n>> + * Similar to statically_true() but produces a constant expression\n>> + *\n>> + * To be used in conjunction with macros, such as BUILD_BUG_ON_ZERO(),\n>> + * which require their input to be a constant expression and for which\n>> + * statically_true() would otherwise fail.\n>> + *\n>> + * This is a tradeoff: _statically_true() is less efficient at\n>> + * constant folding and will fail to optimize any expressions in which\n>> + * at least one of the subcomponent is not constant. For the general\n>> + * case, statically_true() is better.\n> I agree with Rasmus. Would be nice to have examples where should I use\n> one vs another right here in the comment.\n\n\nI rewrote the full set of examples in v4. I added the godbolt link in \nthe patch description and I cherry picked what seems to me the two most \nmeaningful examples and put them in the macro comment. Let me know what \nyou think.\n\nYours sincerely,\nVincent Mailhol\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173151992628288.mbox",
          "message_id": "<46e494ba-a1c5-4576-adbb-b63c77a73365 () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [RESEND PATCH v3 1/2] compiler.h: add _static_assert()",
          "date": "2024-11-13 17:47:38+00:00",
          "date_str": "Wed, 13 Nov 2024 17:47:38 +0000",
          "body": "On 13/11/2024 at 05:03, Rasmus Villemoes wrote:\n> On Wed, Nov 13 2024, Vincent Mailhol <mailhol.vincent@wanadoo.fr> wrote:\n>\n>> Declare a new _statically_true() macro which, by making use of the\n>> __builtin_choose_expr() and __is_constexpr(x) combo, always produces a\n>> constant expression.\n> Looks sane, but $subject needs s/_static_assert/_statically_true/. And\n> to be completely pedantic, macros are defined, not declared.\nSorry for the silly mistake in the subject. And agreed that \"define\" is \nmore appropriate than \"declare\" when speaking of macros.\n>>    - above examples, and a bit more:\n>>\n>>        https://godbolt.org/z/zzqM1ajPj\n>>\n>>    - a proof that statically_true() does better constant folding than _statically_true()\n>>\n>>        https://godbolt.org/z/vK6KK4hMG\n> At least the second of these might be good to refer to in the commit\n> message itself.\n\nAck. I rewrote the set of examples in the v4 and added a few samples to \nthe macro comment.\n\nYours sincerely,\nVincent Mailhol\n\n",
          "year": "2024",
          "month": "11"
        }
      ],
      "primary_category": "sparse_internals"
    },
    {
      "subject": "[RESEND PATCH v3 0/2] add _statically_true() to simplify GENMASK_INPUT_CHECK()",
      "normalized_subject": "[RESEND PATCH v3 0/2] add _statically_true() to simplify GENMASK_INPUT_CHECK()",
      "message_count": 1,
      "participants": [
        "Vincent Mailhol"
      ],
      "categories": [
        "rfc_proposals",
        "compiler_compat",
        "type_system"
      ],
      "first_date": "2024-11-12T19:08:38+00:00",
      "last_date": "2024-11-12T19:08:38+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/11/173143838814620.mbox",
          "message_id": "<20241112190840.601378-4-mailhol.vincent () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "[RESEND PATCH v3 0/2] add _statically_true() to simplify GENMASK_INPUT_CHECK()",
          "date": "2024-11-12 19:08:38+00:00",
          "date_str": "Tue, 12 Nov 2024 19:08:38 +0000",
          "body": "The first patch introduces a new variant of statically_true() named\n_statically_true() which rely on __is_constexpr() to produce a\nconstant expression result which can be used in BUILD_BUG_ON_ZERO()\nand other macros which expect a constant expression as input.\n\nThe second patch applies this newly created _statically_true() to\nGENMASK_INPUT_CHECK().\n\n\n** Changelog **\n\nv3 -> v3 RESEND:\n\n   - send email using the smtp.wanadoo.fr gateway. Note that this may\n     appear as smtp.orange.fr which is an alias (both have the same IP).\n\nv2 -> v3:\n\n   - split the single patch into a series of two patches.\n\n   - add explanation of why _statically_true() is needed in addition\n     to the existing statically_true(). Explain the pros and cons of\n     each.\n\n   - use __builtin_choose_expr() in _statically_true(). The\n     _statically_true() of the v2 works perfectly fine when used in\n     conjunction with BUILD_BUG_ON_ZERO() but fails if used, for\n     example, in arrays or in static_assert().\n\nLink: https://lore.kernel.org/all/20241111164743.339117-2-mailhol.vincent@wanadoo.fr/\n\nv1 -> v2:\n\n   - introduce _statically_true(), taking inspiration from\n     statically_true() as introduced in commit 22f546873149 (\"minmax:\n     improve macro expansion and type checking\").\n\nLink: https://lore.kernel.org/all/20240609073513.256179-1-mailhol.vincent@wanadoo.fr/\n\nVincent Mailhol (2):\n  compiler.h: add _static_assert()\n  linux/bits.h: simplify GENMASK_INPUT_CHECK()\n\n include/linux/bits.h     |  5 ++---\n include/linux/compiler.h | 14 ++++++++++++++\n 2 files changed, 16 insertions(+), 3 deletions(-)\n\n-- \n2.45.2\n\n",
          "year": "2024",
          "month": "11"
        }
      ],
      "primary_category": "rfc_proposals"
    },
    {
      "subject": "Re: [PATCH v4 2/2] linux/bits.h: simplify GENMASK_INPUT_CHECK()",
      "normalized_subject": "linux/bits.h: simplify GENMASK_INPUT_CHECK()",
      "message_count": 8,
      "participants": [
        "David Laight",
        "Vincent Mailhol"
      ],
      "categories": [
        "rfc_proposals",
        "compiler_compat",
        "type_system"
      ],
      "first_date": "2024-11-12T13:59:24+00:00",
      "last_date": "2024-11-18T01:14:34+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/11/173142017731975.mbox",
          "message_id": "<20241112140454.518823-6-mailhol.vincent () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "[PATCH v3 2/2] linux/bits.h: simplify GENMASK_INPUT_CHECK()",
          "date": "2024-11-12 13:59:24+00:00",
          "date_str": "Tue, 12 Nov 2024 13:59:24 +0000",
          "body": "In GENMASK_INPUT_CHECK(),\n\n  __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n\nis the exact expansion of:\n\n  _statically_true((l) > (h))\n\nApply _statically_true() to simplify GENMASK_INPUT_CHECK().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\nThis change passes the unit tests from CONFIG_BITS_TEST, including the\nextra negative tests provided under #ifdef TEST_GENMASK_FAILURES [1].\n\n[1] commit 6d511020e13d (\"lib/test_bits.c: add tests of GENMASK\")\nLink: https://git.kernel.org/torvalds/c/6d511020e13d\n---\n include/linux/bits.h | 5 ++---\n 1 file changed, 2 insertions(+), 3 deletions(-)\n\ndiff --git a/include/linux/bits.h b/include/linux/bits.h\nindex 60044b608817..01713e1eda56 100644\n--- a/include/linux/bits.h\n+++ b/include/linux/bits.h\n@@ -20,9 +20,8 @@\n  */\n #if !defined(__ASSEMBLY__)\n #include <linux/build_bug.h>\n-#define GENMASK_INPUT_CHECK(h, l) \\\n-\t(BUILD_BUG_ON_ZERO(__builtin_choose_expr( \\\n-\t\t__is_constexpr((l) > (h)), (l) > (h), 0)))\n+#include <linux/compiler.h>\n+#define GENMASK_INPUT_CHECK(h, l) BUILD_BUG_ON_ZERO(_statically_true((l) > (h)))\n #else\n /*\n  * BUILD_BUG_ON_ZERO is not available in h files included from asm files,\n-- \n2.45.2\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173151886327471.mbox",
          "message_id": "<20241113172939.747686-6-mailhol.vincent () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "[PATCH v4 2/2] linux/bits.h: simplify GENMASK_INPUT_CHECK()",
          "date": "2024-11-13 17:18:33+00:00",
          "date_str": "Wed, 13 Nov 2024 17:18:33 +0000",
          "body": "In GENMASK_INPUT_CHECK(),\n\n  __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n\nis the exact expansion of:\n\n  const_true((l) > (h))\n\nApply const_true() to simplify GENMASK_INPUT_CHECK().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\nThis change passes the unit tests from CONFIG_BITS_TEST, including the\nextra negative tests provided under #ifdef TEST_GENMASK_FAILURES [1].\n\n[1] commit 6d511020e13d (\"lib/test_bits.c: add tests of GENMASK\")\nLink: https://git.kernel.org/torvalds/c/6d511020e13d\n---\n include/linux/bits.h | 5 ++---\n 1 file changed, 2 insertions(+), 3 deletions(-)\n\ndiff --git a/include/linux/bits.h b/include/linux/bits.h\nindex 60044b608817..61a75d3f294b 100644\n--- a/include/linux/bits.h\n+++ b/include/linux/bits.h\n@@ -20,9 +20,8 @@\n  */\n #if !defined(__ASSEMBLY__)\n #include <linux/build_bug.h>\n-#define GENMASK_INPUT_CHECK(h, l) \\\n-\t(BUILD_BUG_ON_ZERO(__builtin_choose_expr( \\\n-\t\t__is_constexpr((l) > (h)), (l) > (h), 0)))\n+#include <linux/compiler.h>\n+#define GENMASK_INPUT_CHECK(h, l) BUILD_BUG_ON_ZERO(const_true((l) > (h)))\n #else\n /*\n  * BUILD_BUG_ON_ZERO is not available in h files included from asm files,\n-- \n2.45.2\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173151889227493.mbox",
          "message_id": "<20241113172939.747686-6-mailhol.vincent () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "[PATCH v4 2/2] linux/bits.h: simplify GENMASK_INPUT_CHECK()",
          "date": "2024-11-13 17:18:33+00:00",
          "date_str": "Wed, 13 Nov 2024 17:18:33 +0000",
          "body": "In GENMASK_INPUT_CHECK(),\n\n  __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n\nis the exact expansion of:\n\n  const_true((l) > (h))\n\nApply const_true() to simplify GENMASK_INPUT_CHECK().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\nThis change passes the unit tests from CONFIG_BITS_TEST, including the\nextra negative tests provided under #ifdef TEST_GENMASK_FAILURES [1].\n\n[1] commit 6d511020e13d (\"lib/test_bits.c: add tests of GENMASK\")\nLink: https://git.kernel.org/torvalds/c/6d511020e13d\n---\n include/linux/bits.h | 5 ++---\n 1 file changed, 2 insertions(+), 3 deletions(-)\n\ndiff --git a/include/linux/bits.h b/include/linux/bits.h\nindex 60044b608817..61a75d3f294b 100644\n--- a/include/linux/bits.h\n+++ b/include/linux/bits.h\n@@ -20,9 +20,8 @@\n  */\n #if !defined(__ASSEMBLY__)\n #include <linux/build_bug.h>\n-#define GENMASK_INPUT_CHECK(h, l) \\\n-\t(BUILD_BUG_ON_ZERO(__builtin_choose_expr( \\\n-\t\t__is_constexpr((l) > (h)), (l) > (h), 0)))\n+#include <linux/compiler.h>\n+#define GENMASK_INPUT_CHECK(h, l) BUILD_BUG_ON_ZERO(const_true((l) > (h)))\n #else\n /*\n  * BUILD_BUG_ON_ZERO is not available in h files included from asm files,\n-- \n2.45.2\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173186413312665.mbox",
          "message_id": "<8bf9eb4434104a3b960d52bd1d38caea () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH v4 2/2] linux/bits.h: simplify GENMASK_INPUT_CHECK()",
          "date": "2024-11-17 17:24:54+00:00",
          "date_str": "Sun, 17 Nov 2024 17:24:54 +0000",
          "body": "From: Vincent Mailhol\n> Sent: 13 November 2024 17:19\n>=20\n> In GENMASK_INPUT_CHECK(),\n>=20\n>   __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n>=20\n> is the exact expansion of:\n>=20\n>   const_true((l) > (h))\n>=20\n> Apply const_true() to simplify GENMASK_INPUT_CHECK().\n\nWouldn't statically_true() give better coverage ?\nI wouldn't have though that GENMASK() got used anywhere where a constant\ninteger expression was needed.\n\nMore interesting would be to get it to pass a W=3D1 build for\nany place where 'l' is 0u.\n\n=09David\n\n>=20\n> Signed-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n> ---\n> This change passes the unit tests from CONFIG_BITS_TEST, including the\n> extra negative tests provided under #ifdef TEST_GENMASK_FAILURES [1].\n>=20\n> [1] commit 6d511020e13d (\"lib/test_bits.c: add tests of GENMASK\")\n> Link: https://git.kernel.org/torvalds/c/6d511020e13d\n> ---\n>  include/linux/bits.h | 5 ++---\n>  1 file changed, 2 insertions(+), 3 deletions(-)\n>=20\n> diff --git a/include/linux/bits.h b/include/linux/bits.h\n> index 60044b608817..61a75d3f294b 100644\n> --- a/include/linux/bits.h\n> +++ b/include/linux/bits.h\n> @@ -20,9 +20,8 @@\n>   */\n>  #if !defined(__ASSEMBLY__)\n>  #include <linux/build_bug.h>\n> -#define GENMASK_INPUT_CHECK(h, l) \\\n> -=09(BUILD_BUG_ON_ZERO(__builtin_choose_expr( \\\n> -=09=09__is_constexpr((l) > (h)), (l) > (h), 0)))\n> +#include <linux/compiler.h>\n> +#define GENMASK_INPUT_CHECK(h, l) BUILD_BUG_ON_ZERO(const_true((l) > (h)=\n))\n>  #else\n>  /*\n>   * BUILD_BUG_ON_ZERO is not available in h files included from asm files=\n,\n> --\n> 2.45.2\n>=20\n\n-\nRegistered Address Lakeside, Bramley Road, Mount Farm, Milton Keynes, MK1 1=\nPT, UK\nRegistration No: 1397386 (Wales)\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173187259615937.mbox",
          "message_id": "<f5692429eb4b43738f562e5fc402ead2 () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [PATCH v4 2/2] linux/bits.h: simplify GENMASK_INPUT_CHECK()",
          "date": "2024-11-17 19:45:56+00:00",
          "date_str": "Sun, 17 Nov 2024 19:45:56 +0000",
          "body": "From: David Laight\n> Sent: 17 November 2024 17:25\n>=20\n> From: Vincent Mailhol\n> > Sent: 13 November 2024 17:19\n> >\n> > In GENMASK_INPUT_CHECK(),\n> >\n> >   __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n> >\n> > is the exact expansion of:\n> >\n> >   const_true((l) > (h))\n> >\n> > Apply const_true() to simplify GENMASK_INPUT_CHECK().\n>=20\n> Wouldn't statically_true() give better coverage ?\n> I wouldn't have though that GENMASK() got used anywhere where a constant\n> integer expression was needed.\n\nIf it is, maybe add a GENMASK_CONST() that uses BUILD_BUG_ON_ZERO_MSG()\n(recently proposed) and so validates that the values are constants.\nAnd then use statically_true() in the normal case to pick up more errors.\n\n(Or just remove the check because coders really aren't that stupid!)\n\nThe interesting cases are the ones using variables.\nAnd they'd need run-time checks of some form.\n\n=09David\n\n-\nRegistered Address Lakeside, Bramley Road, Mount Farm, Milton Keynes, MK1 1=\nPT, UK\nRegistration No: 1397386 (Wales)\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173189229822367.mbox",
          "message_id": "<CAMZ6RqJwSf9L8sSA78uaizdqNDa__Xz7WY+g5yNgs62Sx-WUog () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH v4 2/2] linux/bits.h: simplify GENMASK_INPUT_CHECK()",
          "date": "2024-11-18 01:12:45+00:00",
          "date_str": "Mon, 18 Nov 2024 01:12:45 +0000",
          "body": "On Mon. 18 Nov. 2024 at 02:24, David Laight <David.Laight@aculab.com> wrote:\n> From: Vincent Mailhol\n> > Sent: 13 November 2024 17:19\n> >\n> > In GENMASK_INPUT_CHECK(),\n> >\n> >   __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n> >\n> > is the exact expansion of:\n> >\n> >   const_true((l) > (h))\n> >\n> > Apply const_true() to simplify GENMASK_INPUT_CHECK().\n>\n> Wouldn't statically_true() give better coverage ?\n> I wouldn't have though that GENMASK() got used anywhere where a constant\n> integer expression was needed.\n>\n> More interesting would be to get it to pass a W=1 build for\n> any place where 'l' is 0u.\n\nAre you referring to -Wtype-limits? If yes, this warning was moved to\nW=2. I suggested in the past to add a cast to silence this warning,\nbut got rejected:\n\n  https://lore.kernel.org/lkml/CAHk-=whvGWbpsTa538CvQ9e=VF+m8WPQmES2y6-=0=-64uGkgg@mail.gmail.com/\n\nYours sincerely,\nVincent Mailhol\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173189233122381.mbox",
          "message_id": "<CAMZ6RqJzULnu4X=FB6xQpEm034QUtn6kiSX-P0_JQW1JBMABaA () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH v4 2/2] linux/bits.h: simplify GENMASK_INPUT_CHECK()",
          "date": "2024-11-18 01:14:34+00:00",
          "date_str": "Mon, 18 Nov 2024 01:14:34 +0000",
          "body": "On Mon. 18 Nov. 2024 at 04:45, David Laight <David.Laight@aculab.com> wrote:\n> From: David Laight\n> > Sent: 17 November 2024 17:25\n> >\n> > From: Vincent Mailhol\n> > > Sent: 13 November 2024 17:19\n> > >\n> > > In GENMASK_INPUT_CHECK(),\n> > >\n> > >   __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n> > >\n> > > is the exact expansion of:\n> > >\n> > >   const_true((l) > (h))\n> > >\n> > > Apply const_true() to simplify GENMASK_INPUT_CHECK().\n> >\n> > Wouldn't statically_true() give better coverage ?\n\nYes, it would.\n\n> > I wouldn't have though that GENMASK() got used anywhere where a constant\n> > integer expression was needed.\n\nIt is used in many places, including some inline functions such as bitmap_set():\n\n  https://elixir.bootlin.com/linux/v6.11/source/include/linux/bitmap.h#L469\n\nwhere the input is not an integer constant expression (thus preventing\nthe use of statically_true()).\n\n> If it is, maybe add a GENMASK_CONST() that uses BUILD_BUG_ON_ZERO_MSG()\n> (recently proposed) and so validates that the values are constants.\n> And then use statically_true() in the normal case to pick up more errors.\n\nThe issue if you introduce GENMASK_CONST() is that there is no gain.\n\nThe only advantage of const_true(x) is that it works on cases where\nstatically_true(x) would cause a compilation error. But for\nstatically_true(x) to cause a compilation error, x has to be a non\nconstant expression. And if x is non constant, then const_true(x)\nreturns false.\n\nRegardless, considering the number of times where GENMASK() is used\nwith integer literals, I do not think it would be worth it to replace\nall of these with GENMASK_CONST() tree wide.\n\nTrying to go in your direction, we already have two genmasks:\n\n   - GENMASK(): which uses GENMASK_INPUT_CHECK()\n\n  - __GENMASK(): no check, used in uapi\n\nWhat would make more sense to me would be to:\n\n  1. replace const_true() by statically_true() in GENMASK_INPUT_CHECK()\n\n  2. replace all the instances where GENMASK() breaks compilation with\n     __GENMASK()\n\nBut this idea was already proposed in the past and was rejected here:\n\n  https://lore.kernel.org/lkml/YJm5Dpo+RspbAtye@rikard/\n\n> (Or just remove the check because coders really aren't that stupid!)\n\nI think that this check exists in the first place *because* such a\nmistake was made in the past.\n\n> The interesting cases are the ones using variables.\n> And they'd need run-time checks of some form.\n\nThen, instead of introducing GENMASK_CONST(), maybe introduce\nGENMASK_NON_CONST()? But then, the number of instances in which\nGENMASK() is used with something other than literal integers is pretty\nrare. So probably not worth it.\n\n\nYours sincerely,\nVincent Mailhol\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173189233422385.mbox",
          "message_id": "<CAMZ6RqJzULnu4X=FB6xQpEm034QUtn6kiSX-P0_JQW1JBMABaA () mail ! gmail ! com>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "Re: [PATCH v4 2/2] linux/bits.h: simplify GENMASK_INPUT_CHECK()",
          "date": "2024-11-18 01:14:34+00:00",
          "date_str": "Mon, 18 Nov 2024 01:14:34 +0000",
          "body": "On Mon. 18 Nov. 2024 at 04:45, David Laight <David.Laight@aculab.com> wrote:\n> From: David Laight\n> > Sent: 17 November 2024 17:25\n> >\n> > From: Vincent Mailhol\n> > > Sent: 13 November 2024 17:19\n> > >\n> > > In GENMASK_INPUT_CHECK(),\n> > >\n> > >   __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n> > >\n> > > is the exact expansion of:\n> > >\n> > >   const_true((l) > (h))\n> > >\n> > > Apply const_true() to simplify GENMASK_INPUT_CHECK().\n> >\n> > Wouldn't statically_true() give better coverage ?\n\nYes, it would.\n\n> > I wouldn't have though that GENMASK() got used anywhere where a constant\n> > integer expression was needed.\n\nIt is used in many places, including some inline functions such as bitmap_set():\n\n  https://elixir.bootlin.com/linux/v6.11/source/include/linux/bitmap.h#L469\n\nwhere the input is not an integer constant expression (thus preventing\nthe use of statically_true()).\n\n> If it is, maybe add a GENMASK_CONST() that uses BUILD_BUG_ON_ZERO_MSG()\n> (recently proposed) and so validates that the values are constants.\n> And then use statically_true() in the normal case to pick up more errors.\n\nThe issue if you introduce GENMASK_CONST() is that there is no gain.\n\nThe only advantage of const_true(x) is that it works on cases where\nstatically_true(x) would cause a compilation error. But for\nstatically_true(x) to cause a compilation error, x has to be a non\nconstant expression. And if x is non constant, then const_true(x)\nreturns false.\n\nRegardless, considering the number of times where GENMASK() is used\nwith integer literals, I do not think it would be worth it to replace\nall of these with GENMASK_CONST() tree wide.\n\nTrying to go in your direction, we already have two genmasks:\n\n   - GENMASK(): which uses GENMASK_INPUT_CHECK()\n\n  - __GENMASK(): no check, used in uapi\n\nWhat would make more sense to me would be to:\n\n  1. replace const_true() by statically_true() in GENMASK_INPUT_CHECK()\n\n  2. replace all the instances where GENMASK() breaks compilation with\n     __GENMASK()\n\nBut this idea was already proposed in the past and was rejected here:\n\n  https://lore.kernel.org/lkml/YJm5Dpo+RspbAtye@rikard/\n\n> (Or just remove the check because coders really aren't that stupid!)\n\nI think that this check exists in the first place *because* such a\nmistake was made in the past.\n\n> The interesting cases are the ones using variables.\n> And they'd need run-time checks of some form.\n\nThen, instead of introducing GENMASK_CONST(), maybe introduce\nGENMASK_NON_CONST()? But then, the number of instances in which\nGENMASK() is used with something other than literal integers is pretty\nrare. So probably not worth it.\n\n\nYours sincerely,\nVincent Mailhol\n",
          "year": "2024",
          "month": "11"
        }
      ],
      "primary_category": "rfc_proposals"
    },
    {
      "subject": "[PATCH v3 1/2] compiler.h: add _static_assert()",
      "normalized_subject": "compiler.h: add _static_assert()",
      "message_count": 1,
      "participants": [
        "Vincent Mailhol"
      ],
      "categories": [
        "compiler_compat",
        "sparse_internals"
      ],
      "first_date": "2024-11-12T13:59:23+00:00",
      "last_date": "2024-11-12T13:59:23+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/11/173142016031954.mbox",
          "message_id": "<20241112140454.518823-5-mailhol.vincent () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "[PATCH v3 1/2] compiler.h: add _static_assert()",
          "date": "2024-11-12 13:59:23+00:00",
          "date_str": "Tue, 12 Nov 2024 13:59:23 +0000",
          "body": "__builtin_constant_p() is known for not always being able to produce\nconstant expression [1] which led to the introduction of\n__is_constexpr() [2]. Because of its dependency on\n__builtin_constant_p(), statically_true() suffers from the same\nissues.\n\nFor example:\n\n  void foo(int a)\n  {\n  \t /* fail on GCC */\n  \tBUILD_BUG_ON_ZERO(statically_true(a));\n\n  \t /* fail on both clang and GCC */\n  \tstatic char arr[statically_true(a) ? 1 : 2];\n  }\n\nFor the same reasons why __is_constexpr() was created to remediate\n__builtin_constant_p() edge cases, __is_constexpr() can be used to\nresolve statically_true()'s limitations.\n\nNote that, somehow, GCC is not always able to fold this:\n\n  __is_constexpr(x) && (x)\n\nIt is OK in BUILD_BUG_ON_ZERO() but not in array declarations or in\nstatic_assert():\n\n  void bar(int a)\n  {\n  \t/* success */\n  \tBUILD_BUG_ON_ZERO(__is_constexpr(a) && (a));\n\n  \t/* fail on GCC */\n  \tstatic char arr[__is_constexpr(a) && (a) ? 1 : 2];\n\n  \t/* fail on GCC */\n  \tstatic_assert(__is_constexpr(a) && (a));\n  }\n\nEncapsulating the expression in a __builtin_choose_expr() switch\nresolves all these failed examples.\n\nDeclare a new _statically_true() macro which, by making use of the\n__builtin_choose_expr() and __is_constexpr() combo, always produces a\nconstant expression.\n\nIt should be noted that statically_true() still produces better\nfolding:\n\n  statically_true(!(var * 8 % 8))\n\nalways evaluates to true even if var is unknown, whereas\n\n  _statically_true(!(var * 8 % 8))\n\nfails to fold the expression and returns false.\n\nFor this reason, usage of _statically_true() should be the exception.\nReflect in the documentation that _statically_true() is less powerful\nand that statically_true() is the overall preferred solution.\n\n[1] __builtin_constant_p cannot resolve to const when optimizing\nLink: https://gcc.gnu.org/bugzilla/show_bug.cgi?id=19449\n\n[2] commit 3c8ba0d61d04 (\"kernel.h: Retain constant expression output for max()/min()\")\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\nBonuses:\n\n  - above examples (and a bit more) in godbolt:\n\n      https://godbolt.org/z/GYeEK5d7s\n\n  - that proof, in godbolt, that statically_true() is bettera at\n    constant folding than _statically_true()\n\n      https://godbolt.org/z/vK6KK4hMG\n---\n include/linux/compiler.h | 14 ++++++++++++++\n 1 file changed, 14 insertions(+)\n\ndiff --git a/include/linux/compiler.h b/include/linux/compiler.h\nindex 4d4e23b6e3e7..c76db8b50202 100644\n--- a/include/linux/compiler.h\n+++ b/include/linux/compiler.h\n@@ -308,6 +308,20 @@ static inline void *offset_to_ptr(const int *off)\n  */\n #define statically_true(x) (__builtin_constant_p(x) && (x))\n \n+/*\n+ * Similar to statically_true() but produces a constant expression\n+ *\n+ * To be used in conjunction with macros, such as BUILD_BUG_ON_ZERO(),\n+ * which require their input to be a constant expression and for which\n+ * statically_true() would otherwise fail.\n+ *\n+ * This is a tradeoff: _statically_true() is less efficient at\n+ * constant folding and will fail to optimize any expressions in which\n+ * at least one of the subcomponents is not constant. For the general\n+ * case, statically_true() is better.\n+ */\n+#define _statically_true(x) __builtin_choose_expr(__is_constexpr(x), x, false)\n+\n /*\n  * This is needed in functions which generate the stack canary, see\n  * arch/x86/kernel/smpboot.c::start_secondary() for an example.\n-- \n2.45.2\n\n",
          "year": "2024",
          "month": "11"
        }
      ],
      "primary_category": "sparse_internals"
    },
    {
      "subject": "Re: [PATCH v2] linux/bits: simplify GENMASK_INPUT_CHECK()",
      "normalized_subject": "linux/bits: simplify GENMASK_INPUT_CHECK()",
      "message_count": 4,
      "participants": [
        "Linus Torvalds",
        "Vincent Mailhol"
      ],
      "categories": [
        "rfc_proposals",
        "compiler_compat",
        "sparse_internals",
        "type_system"
      ],
      "first_date": "2024-11-11T16:43:30+00:00",
      "last_date": "2024-11-11T17:32:12+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/11/173134351721498.mbox",
          "message_id": "<20241111164743.339117-2-mailhol.vincent () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "[PATCH v2] linux/bits: simplify GENMASK_INPUT_CHECK()",
          "date": "2024-11-11 16:43:30+00:00",
          "date_str": "Mon, 11 Nov 2024 16:43:30 +0000",
          "body": "Because of the shortcut logic of the && operator, below expression:\n\n  __builtin_choose_expr(condition, boolean_expression, false)\n\ncan be simplified as:\n\n  condition && boolean_expression\n\nApplied to GENMASK_INPUT_CHECK(),\n\n  __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n\ncan be replaced by:\n\n  __is_constexpr((l) > (h)) && (l) > (h)\n\nFinally, above expression is nearly the same as the expansion of\nstatically_true((l) > (h)), except from the use of __is_constexpr()\ninstead of __builtin_constant_p().\n\nIntroduce _statically_true() which is similar to statically_true()\nbut with __is_constexpr(). Apply _statically_true() to simplify\nGENMASK_INPUT_CHECK().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\nThis change passes the unit tests from CONFIG_BITS_TEST, including the\nextra negative tests provided under #ifdef TEST_GENMASK_FAILURES [1].\n\n[1] commit 6d511020e13d (\"lib/test_bits.c: add tests of GENMASK\")\nLink: https://git.kernel.org/torvalds/c/6d511020e13d\n\n\n** Changelog **\n\nv1 -> v2:\n\n   - introduce _statically_true(), taking inspiration from\n     statically_true() as introduced in commit 22f546873149 (\"minmax:\n     improve macro expansion and type checking\")\n\nLink: https://lore.kernel.org/all/20240609073513.256179-1-mailhol.vincent@wanadoo.fr/\n---\n include/linux/bits.h     | 5 ++---\n include/linux/compiler.h | 1 +\n 2 files changed, 3 insertions(+), 3 deletions(-)\n\ndiff --git a/include/linux/bits.h b/include/linux/bits.h\nindex 60044b608817..01713e1eda56 100644\n--- a/include/linux/bits.h\n+++ b/include/linux/bits.h\n@@ -20,9 +20,8 @@\n  */\n #if !defined(__ASSEMBLY__)\n #include <linux/build_bug.h>\n-#define GENMASK_INPUT_CHECK(h, l) \\\n-\t(BUILD_BUG_ON_ZERO(__builtin_choose_expr( \\\n-\t\t__is_constexpr((l) > (h)), (l) > (h), 0)))\n+#include <linux/compiler.h>\n+#define GENMASK_INPUT_CHECK(h, l) BUILD_BUG_ON_ZERO(_statically_true((l) > (h)))\n #else\n /*\n  * BUILD_BUG_ON_ZERO is not available in h files included from asm files,\ndiff --git a/include/linux/compiler.h b/include/linux/compiler.h\nindex 4d4e23b6e3e7..fee66166eca2 100644\n--- a/include/linux/compiler.h\n+++ b/include/linux/compiler.h\n@@ -307,6 +307,7 @@ static inline void *offset_to_ptr(const int *off)\n  * values to determine that the condition is statically true.\n  */\n #define statically_true(x) (__builtin_constant_p(x) && (x))\n+#define _statically_true(x) (__is_constexpr(x) && (x))\n \n /*\n  * This is needed in functions which generate the stack canary, see\n-- \n2.45.2\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173134361321555.mbox",
          "message_id": "<20241111164743.339117-2-mailhol.vincent () wanadoo ! fr>",
          "author_name": "Vincent Mailhol",
          "author_email": "mailhol.vincent () wanadoo ! fr",
          "subject": "[PATCH v2] linux/bits: simplify GENMASK_INPUT_CHECK()",
          "date": "2024-11-11 16:43:30+00:00",
          "date_str": "Mon, 11 Nov 2024 16:43:30 +0000",
          "body": "Because of the shortcut logic of the && operator, below expression:\n\n  __builtin_choose_expr(condition, boolean_expression, false)\n\ncan be simplified as:\n\n  condition && boolean_expression\n\nApplied to GENMASK_INPUT_CHECK(),\n\n  __builtin_choose_expr(__is_constexpr((l) > (h)), (l) > (h), 0)\n\ncan be replaced by:\n\n  __is_constexpr((l) > (h)) && (l) > (h)\n\nFinally, above expression is nearly the same as the expansion of\nstatically_true((l) > (h)), except from the use of __is_constexpr()\ninstead of __builtin_constant_p().\n\nIntroduce _statically_true() which is similar to statically_true()\nbut with __is_constexpr(). Apply _statically_true() to simplify\nGENMASK_INPUT_CHECK().\n\nSigned-off-by: Vincent Mailhol <mailhol.vincent@wanadoo.fr>\n---\nThis change passes the unit tests from CONFIG_BITS_TEST, including the\nextra negative tests provided under #ifdef TEST_GENMASK_FAILURES [1].\n\n[1] commit 6d511020e13d (\"lib/test_bits.c: add tests of GENMASK\")\nLink: https://git.kernel.org/torvalds/c/6d511020e13d\n\n\n** Changelog **\n\nv1 -> v2:\n\n   - introduce _statically_true(), taking inspiration from\n     statically_true() as introduced in commit 22f546873149 (\"minmax:\n     improve macro expansion and type checking\")\n\nLink: https://lore.kernel.org/all/20240609073513.256179-1-mailhol.vincent@wanadoo.fr/\n---\n include/linux/bits.h     | 5 ++---\n include/linux/compiler.h | 1 +\n 2 files changed, 3 insertions(+), 3 deletions(-)\n\ndiff --git a/include/linux/bits.h b/include/linux/bits.h\nindex 60044b608817..01713e1eda56 100644\n--- a/include/linux/bits.h\n+++ b/include/linux/bits.h\n@@ -20,9 +20,8 @@\n  */\n #if !defined(__ASSEMBLY__)\n #include <linux/build_bug.h>\n-#define GENMASK_INPUT_CHECK(h, l) \\\n-\t(BUILD_BUG_ON_ZERO(__builtin_choose_expr( \\\n-\t\t__is_constexpr((l) > (h)), (l) > (h), 0)))\n+#include <linux/compiler.h>\n+#define GENMASK_INPUT_CHECK(h, l) BUILD_BUG_ON_ZERO(_statically_true((l) > (h)))\n #else\n /*\n  * BUILD_BUG_ON_ZERO is not available in h files included from asm files,\ndiff --git a/include/linux/compiler.h b/include/linux/compiler.h\nindex 4d4e23b6e3e7..fee66166eca2 100644\n--- a/include/linux/compiler.h\n+++ b/include/linux/compiler.h\n@@ -307,6 +307,7 @@ static inline void *offset_to_ptr(const int *off)\n  * values to determine that the condition is statically true.\n  */\n #define statically_true(x) (__builtin_constant_p(x) && (x))\n+#define _statically_true(x) (__is_constexpr(x) && (x))\n \n /*\n  * This is needed in functions which generate the stack canary, see\n-- \n2.45.2\n\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173134619623352.mbox",
          "message_id": "<CAHk-=wh5SNYdgx8-X+ggHP+ojbG2F7oyt3TLmMgqejYd5zn0Aw () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [PATCH v2] linux/bits: simplify GENMASK_INPUT_CHECK()",
          "date": "2024-11-11 17:32:12+00:00",
          "date_str": "Mon, 11 Nov 2024 17:32:12 +0000",
          "body": "On Mon, 11 Nov 2024 at 08:48, Vincent Mailhol\n<mailhol.vincent@wanadoo.fr> wrote:\n>\n>    - introduce _statically_true(), taking inspiration from\n>      statically_true() as introduced in commit 22f546873149 (\"minmax:\n>      improve macro expansion and type checking\")\n\nSo I really think this needs an explanation of what the difference is\nwhen using __builtin_constant_p() vs using __is_constexpr(), and why\nthe existing statically_true() didn't work for you.\n\nIn my experience, __is_constexpr() is too limited, because it\nliterally requires a syntactically constant expression.\n\nIn contrast, __builtin_constant_p() often works for things that aren't\nconstant expressions, but that evaluate to constants at build time.\n\nFor example, I had a test patch that used statically_true() to do\nthings like \"if the size of a user copy is a multiple of the size of\n'long', call a simplified version without the byte copy part\".\n\nAnd sure, __is_constexpr() gets it right for completely constant\narguments. But __builtin_constant_p() will actually trigger not only\nthose, but also when the argument is something like\n\n        if (copy_to_user(buf, values, n * sizeof(u64)))\n\nbecause it sees that even if \"n * sizeof(u64)\" is not a constant, the\n\"is this a multiple of 'long' size\" _is_ constant.\n\nIOW, I think __builtin_constant_p() is preferable, because it not only\ndoesn't expand to the horror that is __is_constexpr(), it also\ngenerally does better when you have the flexibility to use it.\n\nOf course, I do think that the use in BUILD_BUG_ON_ZERO() requires\nsomething that is more statically reliable, and so __is_constexpr()\nthat is purely syntactic is probably the right thing to have. So I'm\nnot objecting to your _statically_true() per se. I just think this\nneeds a big comment about why we have both versions, and when to use\none over the other.\n\n                     Linus\n",
          "year": "2024",
          "month": "11"
        },
        {
          "filepath": "emails/2024/11/173134619523349.mbox",
          "message_id": "<CAHk-=wh5SNYdgx8-X+ggHP+ojbG2F7oyt3TLmMgqejYd5zn0Aw () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [PATCH v2] linux/bits: simplify GENMASK_INPUT_CHECK()",
          "date": "2024-11-11 17:32:12+00:00",
          "date_str": "Mon, 11 Nov 2024 17:32:12 +0000",
          "body": "On Mon, 11 Nov 2024 at 08:48, Vincent Mailhol\n<mailhol.vincent@wanadoo.fr> wrote:\n>\n>    - introduce _statically_true(), taking inspiration from\n>      statically_true() as introduced in commit 22f546873149 (\"minmax:\n>      improve macro expansion and type checking\")\n\nSo I really think this needs an explanation of what the difference is\nwhen using __builtin_constant_p() vs using __is_constexpr(), and why\nthe existing statically_true() didn't work for you.\n\nIn my experience, __is_constexpr() is too limited, because it\nliterally requires a syntactically constant expression.\n\nIn contrast, __builtin_constant_p() often works for things that aren't\nconstant expressions, but that evaluate to constants at build time.\n\nFor example, I had a test patch that used statically_true() to do\nthings like \"if the size of a user copy is a multiple of the size of\n'long', call a simplified version without the byte copy part\".\n\nAnd sure, __is_constexpr() gets it right for completely constant\narguments. But __builtin_constant_p() will actually trigger not only\nthose, but also when the argument is something like\n\n        if (copy_to_user(buf, values, n * sizeof(u64)))\n\nbecause it sees that even if \"n * sizeof(u64)\" is not a constant, the\n\"is this a multiple of 'long' size\" _is_ constant.\n\nIOW, I think __builtin_constant_p() is preferable, because it not only\ndoesn't expand to the horror that is __is_constexpr(), it also\ngenerally does better when you have the flexibility to use it.\n\nOf course, I do think that the use in BUILD_BUG_ON_ZERO() requires\nsomething that is more statically reliable, and so __is_constexpr()\nthat is purely syntactic is probably the right thing to have. So I'm\nnot objecting to your _statically_true() per se. I just think this\nneeds a big comment about why we have both versions, and when to use\none over the other.\n\n                     Linus\n",
          "year": "2024",
          "month": "11"
        }
      ],
      "primary_category": "rfc_proposals"
    },
    {
      "subject": "how to figure if a struct symbol is incomplete",
      "normalized_subject": "how to figure if a struct symbol is incomplete",
      "message_count": 1,
      "participants": [
        "Aurelien Aptel"
      ],
      "categories": [
        "rfc_proposals"
      ],
      "first_date": "2024-10-17T09:09:04+00:00",
      "last_date": "2024-10-17T09:09:04+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/10/172915601411672.mbox",
          "message_id": "<SJ2PR12MB8943C1A7AF702D739C892D8DA5472 () SJ2PR12MB8943 ! namprd12 ! prod ! outlook ! com>",
          "author_name": "Aurelien Aptel",
          "author_email": "aaptel () nvidia ! com",
          "subject": "how to figure if a struct symbol is incomplete",
          "date": "2024-10-17 09:09:04+00:00",
          "date_str": "Thu, 17 Oct 2024 09:09:04 +0000",
          "body": "SGksDQoNCknigJltIHRveWluZyBhcm91bmQgd2l0aCBhIG5ldyBzcGFyc2UtYmFzZWQgcHJvZ3Jh\nbSwgdHJ5aW5nIHRvIGNoZWNrIGZvciBjZXJ0YWluIHRoaW5ncyBpbiBDIHN0cnVjdHMgZGVmaW5p\ndGlvbnMuDQoNCknigJl2ZSBsb29rZWQgYXJvdW5kIGF0IGV4YW1wbGVzIGFuZCBjdGFncyB3YXMg\ndGhlIG1vc3QgdXNlZnVsIGFzIGl04oCZcyB1c2luZyDigJhmaWxlX3Njb3Bl4oCZIGFzIHRoZSBz\neW1ib2wgZW50cnkgcG9pbnQgaW5zdGVhZCBvZiB0aGUgc3BhcnNlKCkgcmV0dXJuIHZhbHVlLCB3\naGljaCBhbGxvd2VkIG1lIHRvIHNlZSB0aGUgQVNUIG9mIHRoZSB0eXBlcy4NCkFmdGVyIHNvbWUg\ndHJpYWwgYW5kIGVycm9yLCBJJ3ZlIGZpZ3VyZWQgdGhhdCBJIGhhZCB0byBjYWxsIGV4YW1pbmVf\nc3ltYm9sX3R5cGUoKSBvbiBlYWNoIHN5bWJvbCBiZWZvcmUgSSBkaXZlIGludG8gdGhlbSB0byBm\ndWxseSBjb21wdXRlIHRoZSBiaXRfc2l6ZSAmIG9mZnNldCBvZiBhbGwgdGhlIHN0cnVjdCBtZW1i\nZXJzLg0KDQpXaGlsZSBkb2luZyB0aGF0LCBJJ3ZlIG5vdGljZWQgdGhhdCBJIGNhbm5vdCB0ZWxs\nIGFuIGVtcHR5IHN0cnVjdHVyZSBmcm9tIGFuIGluY29tcGxldGVseSBkZWZpbmVkIG9uZS4NCkkn\nZCBsaWtlIHRvIGVyciBvdXQgaW5zdGVhZCBvZiBzaWxlbnRseSB1c2luZyBhIHNpemU9MCBzdHJ1\nY3Qgd2hlbiBJIHNlZSBhbiB1bmRlZmluZWQgdHlwZS4NCg0Kc3RydWN0IGVtcHR5IHt9Ow0Kc3Ry\ndWN0IGZvbyB7DQogICAgaW50IGE7DQogICAgc3RydWN0IHVua25vd24gYjsNCn07DQoNClRoZSBz\neW1ib2wgZm9yICdzdHJ1Y3QgZW1wdHknIGFuZCB0aGUgbWVtYmVyICdiJyBib3RoIGhhdmUgYSBz\neW0tPnNpemUgPT0gMCwgYW4gZW1wdHkgc3ltLT5zeW1ib2xfbGlzdCBhbmQgYSBzeW0tPmN0eXBl\nLmJhc2VfdHlwZSA9PSBOVUxMLg0KSG93IGNhbiB5b3UgdGVsbCB0aG9zZSAyIGNhc2VzIGFwYXJ0\nPw0KDQpUaGFua3MNCg0K\n",
          "year": "2024",
          "month": "10"
        }
      ],
      "primary_category": "rfc_proposals"
    },
    {
      "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
      "normalized_subject": "x86: Define the stack protector guard symbol explicitly",
      "message_count": 22,
      "participants": [
        "Brian Gerst",
        "Ard Biesheuvel",
        "Uros Bizjak"
      ],
      "categories": [
        "kernel_integration",
        "rfc_proposals",
        "compiler_compat"
      ],
      "first_date": "2024-09-28T13:41:07+00:00",
      "last_date": "2024-10-08T14:36:03+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/09/172753077407103.mbox",
          "message_id": "<CAMzpN2j4uj=mhdi7QHaA7y_NLtaHuRpnit38quK6RjvxdUYQew () mail ! gmail ! com>",
          "author_name": "Brian Gerst",
          "author_email": "brgerst () gmail ! com",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-09-28 13:41:07+00:00",
          "date_str": "Sat, 28 Sep 2024 13:41:07 +0000",
          "body": "On Wed, Sep 25, 2024 at 2:33=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> wro=\nte:\n>\n> On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@google.c=\nom> wrote:\n> >\n> > From: Ard Biesheuvel <ardb@kernel.org>\n> >\n> > Specify the guard symbol for the stack cookie explicitly, rather than\n> > positioning it exactly 40 bytes into the per-CPU area. Doing so removes\n> > the need for the per-CPU region to be absolute rather than relative to\n> > the placement of the per-CPU template region in the kernel image, and\n> > this allows the special handling for absolute per-CPU symbols to be\n> > removed entirely.\n> >\n> > This is a worthwhile cleanup in itself, but it is also a prerequisite\n> > for PIE codegen and PIE linking, which can replace our bespoke and\n> > rather clunky runtime relocation handling.\n>\n> I would like to point out a series that converted the stack protector\n> guard symbol to a normal percpu variable [1], so there was no need to\n> assume anything about the location of the guard symbol.\n>\n> [1] \"[PATCH v4 00/16] x86-64: Stack protector and percpu improvements\"\n> https://lore.kernel.org/lkml/20240322165233.71698-1-brgerst@gmail.com/\n>\n> Uros.\n\nI plan on resubmitting that series sometime after the 6.12 merge\nwindow closes.  As I recall from the last version, it was decided to\nwait until after the next LTS release to raise the minimum GCC version\nto 8.1 and avoid the need to be compatible with the old stack\nprotector layout.\n\nBrian Gerst\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/10/172753077407104.mbox",
          "message_id": "<CAMzpN2j4uj=mhdi7QHaA7y_NLtaHuRpnit38quK6RjvxdUYQew () mail ! gmail ! com>",
          "author_name": "Brian Gerst",
          "author_email": "brgerst () gmail ! com",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-09-28 13:41:07+00:00",
          "date_str": "Sat, 28 Sep 2024 13:41:07 +0000",
          "body": "On Wed, Sep 25, 2024 at 2:33=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> wro=\nte:\n>\n> On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@google.c=\nom> wrote:\n> >\n> > From: Ard Biesheuvel <ardb@kernel.org>\n> >\n> > Specify the guard symbol for the stack cookie explicitly, rather than\n> > positioning it exactly 40 bytes into the per-CPU area. Doing so removes\n> > the need for the per-CPU region to be absolute rather than relative to\n> > the placement of the per-CPU template region in the kernel image, and\n> > this allows the special handling for absolute per-CPU symbols to be\n> > removed entirely.\n> >\n> > This is a worthwhile cleanup in itself, but it is also a prerequisite\n> > for PIE codegen and PIE linking, which can replace our bespoke and\n> > rather clunky runtime relocation handling.\n>\n> I would like to point out a series that converted the stack protector\n> guard symbol to a normal percpu variable [1], so there was no need to\n> assume anything about the location of the guard symbol.\n>\n> [1] \"[PATCH v4 00/16] x86-64: Stack protector and percpu improvements\"\n> https://lore.kernel.org/lkml/20240322165233.71698-1-brgerst@gmail.com/\n>\n> Uros.\n\nI plan on resubmitting that series sometime after the 6.12 merge\nwindow closes.  As I recall from the last version, it was decided to\nwait until after the next LTS release to raise the minimum GCC version\nto 8.1 and avoid the need to be compatible with the old stack\nprotector layout.\n\nBrian Gerst\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172753078007109.mbox",
          "message_id": "<CAMzpN2j4uj=mhdi7QHaA7y_NLtaHuRpnit38quK6RjvxdUYQew () mail ! gmail ! com>",
          "author_name": "Brian Gerst",
          "author_email": "brgerst () gmail ! com",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-09-28 13:41:07+00:00",
          "date_str": "Sat, 28 Sep 2024 13:41:07 +0000",
          "body": "On Wed, Sep 25, 2024 at 2:33=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> wro=\nte:\n>\n> On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@google.c=\nom> wrote:\n> >\n> > From: Ard Biesheuvel <ardb@kernel.org>\n> >\n> > Specify the guard symbol for the stack cookie explicitly, rather than\n> > positioning it exactly 40 bytes into the per-CPU area. Doing so removes\n> > the need for the per-CPU region to be absolute rather than relative to\n> > the placement of the per-CPU template region in the kernel image, and\n> > this allows the special handling for absolute per-CPU symbols to be\n> > removed entirely.\n> >\n> > This is a worthwhile cleanup in itself, but it is also a prerequisite\n> > for PIE codegen and PIE linking, which can replace our bespoke and\n> > rather clunky runtime relocation handling.\n>\n> I would like to point out a series that converted the stack protector\n> guard symbol to a normal percpu variable [1], so there was no need to\n> assume anything about the location of the guard symbol.\n>\n> [1] \"[PATCH v4 00/16] x86-64: Stack protector and percpu improvements\"\n> https://lore.kernel.org/lkml/20240322165233.71698-1-brgerst@gmail.com/\n>\n> Uros.\n\nI plan on resubmitting that series sometime after the 6.12 merge\nwindow closes.  As I recall from the last version, it was decided to\nwait until after the next LTS release to raise the minimum GCC version\nto 8.1 and avoid the need to be compatible with the old stack\nprotector layout.\n\nBrian Gerst\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172803599219088.mbox",
          "message_id": "<CAFULd4an+aN4iJ7T0DdMQDOBWrTZPJ4Oyy9ULm6R29fLNQND9Q () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-04 09:59:52+00:00",
          "date_str": "Fri, 04 Oct 2024 09:59:52 +0000",
          "body": "On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@google.com=\n> wrote:\n>\n> From: Ard Biesheuvel <ardb@kernel.org>\n>\n> Specify the guard symbol for the stack cookie explicitly, rather than\n> positioning it exactly 40 bytes into the per-CPU area. Doing so removes\n> the need for the per-CPU region to be absolute rather than relative to\n> the placement of the per-CPU template region in the kernel image, and\n> this allows the special handling for absolute per-CPU symbols to be\n> removed entirely.\n>\n> This is a worthwhile cleanup in itself, but it is also a prerequisite\n> for PIE codegen and PIE linking, which can replace our bespoke and\n> rather clunky runtime relocation handling.\n>\n> Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> ---\n>  arch/x86/Makefile                     |  4 ++++\n>  arch/x86/include/asm/init.h           |  2 +-\n>  arch/x86/include/asm/processor.h      | 11 +++--------\n>  arch/x86/include/asm/stackprotector.h |  4 ----\n>  tools/perf/util/annotate.c            |  4 ++--\n>  5 files changed, 10 insertions(+), 15 deletions(-)\n>\n> diff --git a/arch/x86/Makefile b/arch/x86/Makefile\n> index 6b3fe6e2aadd..b78b7623a4a9 100644\n> --- a/arch/x86/Makefile\n> +++ b/arch/x86/Makefile\n> @@ -193,6 +193,10 @@ else\n>          KBUILD_RUSTFLAGS +=3D -Cno-redzone=3Dy\n>          KBUILD_RUSTFLAGS +=3D -Ccode-model=3Dkernel\n>\n> +        ifeq ($(CONFIG_STACKPROTECTOR),y)\n> +                KBUILD_CFLAGS +=3D -mstack-protector-guard-symbol=3Dfixe=\nd_percpu_data\n\nLooking at:\n\n> +        * Since the irq_stack is the object at %gs:0, the bottom 8 bytes=\n of\n> +        * the irq stack are reserved for the canary.\n\nPlease note that %gs:0 can also be achieved with\n-mstack-protector-guard-offset=3D0\n\nUros.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172803599519093.mbox",
          "message_id": "<CAFULd4an+aN4iJ7T0DdMQDOBWrTZPJ4Oyy9ULm6R29fLNQND9Q () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-04 09:59:55+00:00",
          "date_str": "Fri, 04 Oct 2024 09:59:55 +0000",
          "body": "On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@google.com=\n> wrote:\n>\n> From: Ard Biesheuvel <ardb@kernel.org>\n>\n> Specify the guard symbol for the stack cookie explicitly, rather than\n> positioning it exactly 40 bytes into the per-CPU area. Doing so removes\n> the need for the per-CPU region to be absolute rather than relative to\n> the placement of the per-CPU template region in the kernel image, and\n> this allows the special handling for absolute per-CPU symbols to be\n> removed entirely.\n>\n> This is a worthwhile cleanup in itself, but it is also a prerequisite\n> for PIE codegen and PIE linking, which can replace our bespoke and\n> rather clunky runtime relocation handling.\n>\n> Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> ---\n>  arch/x86/Makefile                     |  4 ++++\n>  arch/x86/include/asm/init.h           |  2 +-\n>  arch/x86/include/asm/processor.h      | 11 +++--------\n>  arch/x86/include/asm/stackprotector.h |  4 ----\n>  tools/perf/util/annotate.c            |  4 ++--\n>  5 files changed, 10 insertions(+), 15 deletions(-)\n>\n> diff --git a/arch/x86/Makefile b/arch/x86/Makefile\n> index 6b3fe6e2aadd..b78b7623a4a9 100644\n> --- a/arch/x86/Makefile\n> +++ b/arch/x86/Makefile\n> @@ -193,6 +193,10 @@ else\n>          KBUILD_RUSTFLAGS +=3D -Cno-redzone=3Dy\n>          KBUILD_RUSTFLAGS +=3D -Ccode-model=3Dkernel\n>\n> +        ifeq ($(CONFIG_STACKPROTECTOR),y)\n> +                KBUILD_CFLAGS +=3D -mstack-protector-guard-symbol=3Dfixe=\nd_percpu_data\n\nLooking at:\n\n> +        * Since the irq_stack is the object at %gs:0, the bottom 8 bytes=\n of\n> +        * the irq stack are reserved for the canary.\n\nPlease note that %gs:0 can also be achieved with\n-mstack-protector-guard-offset=3D0\n\nUros.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172803599619097.mbox",
          "message_id": "<CAFULd4an+aN4iJ7T0DdMQDOBWrTZPJ4Oyy9ULm6R29fLNQND9Q () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-04 09:59:56+00:00",
          "date_str": "Fri, 04 Oct 2024 09:59:56 +0000",
          "body": "On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@google.com=\n> wrote:\n>\n> From: Ard Biesheuvel <ardb@kernel.org>\n>\n> Specify the guard symbol for the stack cookie explicitly, rather than\n> positioning it exactly 40 bytes into the per-CPU area. Doing so removes\n> the need for the per-CPU region to be absolute rather than relative to\n> the placement of the per-CPU template region in the kernel image, and\n> this allows the special handling for absolute per-CPU symbols to be\n> removed entirely.\n>\n> This is a worthwhile cleanup in itself, but it is also a prerequisite\n> for PIE codegen and PIE linking, which can replace our bespoke and\n> rather clunky runtime relocation handling.\n>\n> Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> ---\n>  arch/x86/Makefile                     |  4 ++++\n>  arch/x86/include/asm/init.h           |  2 +-\n>  arch/x86/include/asm/processor.h      | 11 +++--------\n>  arch/x86/include/asm/stackprotector.h |  4 ----\n>  tools/perf/util/annotate.c            |  4 ++--\n>  5 files changed, 10 insertions(+), 15 deletions(-)\n>\n> diff --git a/arch/x86/Makefile b/arch/x86/Makefile\n> index 6b3fe6e2aadd..b78b7623a4a9 100644\n> --- a/arch/x86/Makefile\n> +++ b/arch/x86/Makefile\n> @@ -193,6 +193,10 @@ else\n>          KBUILD_RUSTFLAGS +=3D -Cno-redzone=3Dy\n>          KBUILD_RUSTFLAGS +=3D -Ccode-model=3Dkernel\n>\n> +        ifeq ($(CONFIG_STACKPROTECTOR),y)\n> +                KBUILD_CFLAGS +=3D -mstack-protector-guard-symbol=3Dfixe=\nd_percpu_data\n\nLooking at:\n\n> +        * Since the irq_stack is the object at %gs:0, the bottom 8 bytes=\n of\n> +        * the irq stack are reserved for the canary.\n\nPlease note that %gs:0 can also be achieved with\n-mstack-protector-guard-offset=3D0\n\nUros.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172803600919147.mbox",
          "message_id": "<CAFULd4an+aN4iJ7T0DdMQDOBWrTZPJ4Oyy9ULm6R29fLNQND9Q () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-04 10:01:39+00:00",
          "date_str": "Fri, 04 Oct 2024 10:01:39 +0000",
          "body": "On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@google.com=\n> wrote:\n>\n> From: Ard Biesheuvel <ardb@kernel.org>\n>\n> Specify the guard symbol for the stack cookie explicitly, rather than\n> positioning it exactly 40 bytes into the per-CPU area. Doing so removes\n> the need for the per-CPU region to be absolute rather than relative to\n> the placement of the per-CPU template region in the kernel image, and\n> this allows the special handling for absolute per-CPU symbols to be\n> removed entirely.\n>\n> This is a worthwhile cleanup in itself, but it is also a prerequisite\n> for PIE codegen and PIE linking, which can replace our bespoke and\n> rather clunky runtime relocation handling.\n>\n> Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> ---\n>  arch/x86/Makefile                     |  4 ++++\n>  arch/x86/include/asm/init.h           |  2 +-\n>  arch/x86/include/asm/processor.h      | 11 +++--------\n>  arch/x86/include/asm/stackprotector.h |  4 ----\n>  tools/perf/util/annotate.c            |  4 ++--\n>  5 files changed, 10 insertions(+), 15 deletions(-)\n>\n> diff --git a/arch/x86/Makefile b/arch/x86/Makefile\n> index 6b3fe6e2aadd..b78b7623a4a9 100644\n> --- a/arch/x86/Makefile\n> +++ b/arch/x86/Makefile\n> @@ -193,6 +193,10 @@ else\n>          KBUILD_RUSTFLAGS +=3D -Cno-redzone=3Dy\n>          KBUILD_RUSTFLAGS +=3D -Ccode-model=3Dkernel\n>\n> +        ifeq ($(CONFIG_STACKPROTECTOR),y)\n> +                KBUILD_CFLAGS +=3D -mstack-protector-guard-symbol=3Dfixe=\nd_percpu_data\n\nLooking at:\n\n> +        * Since the irq_stack is the object at %gs:0, the bottom 8 bytes=\n of\n> +        * the irq stack are reserved for the canary.\n\nPlease note that %gs:0 can also be achieved with\n-mstack-protector-guard-offset=3D0\n\nUros.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172803600019115.mbox",
          "message_id": "<CAFULd4an+aN4iJ7T0DdMQDOBWrTZPJ4Oyy9ULm6R29fLNQND9Q () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-04 10:01:39+00:00",
          "date_str": "Fri, 04 Oct 2024 10:01:39 +0000",
          "body": "On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@google.com=\n> wrote:\n>\n> From: Ard Biesheuvel <ardb@kernel.org>\n>\n> Specify the guard symbol for the stack cookie explicitly, rather than\n> positioning it exactly 40 bytes into the per-CPU area. Doing so removes\n> the need for the per-CPU region to be absolute rather than relative to\n> the placement of the per-CPU template region in the kernel image, and\n> this allows the special handling for absolute per-CPU symbols to be\n> removed entirely.\n>\n> This is a worthwhile cleanup in itself, but it is also a prerequisite\n> for PIE codegen and PIE linking, which can replace our bespoke and\n> rather clunky runtime relocation handling.\n>\n> Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> ---\n>  arch/x86/Makefile                     |  4 ++++\n>  arch/x86/include/asm/init.h           |  2 +-\n>  arch/x86/include/asm/processor.h      | 11 +++--------\n>  arch/x86/include/asm/stackprotector.h |  4 ----\n>  tools/perf/util/annotate.c            |  4 ++--\n>  5 files changed, 10 insertions(+), 15 deletions(-)\n>\n> diff --git a/arch/x86/Makefile b/arch/x86/Makefile\n> index 6b3fe6e2aadd..b78b7623a4a9 100644\n> --- a/arch/x86/Makefile\n> +++ b/arch/x86/Makefile\n> @@ -193,6 +193,10 @@ else\n>          KBUILD_RUSTFLAGS +=3D -Cno-redzone=3Dy\n>          KBUILD_RUSTFLAGS +=3D -Ccode-model=3Dkernel\n>\n> +        ifeq ($(CONFIG_STACKPROTECTOR),y)\n> +                KBUILD_CFLAGS +=3D -mstack-protector-guard-symbol=3Dfixe=\nd_percpu_data\n\nLooking at:\n\n> +        * Since the irq_stack is the object at %gs:0, the bottom 8 bytes=\n of\n> +        * the irq stack are reserved for the canary.\n\nPlease note that %gs:0 can also be achieved with\n-mstack-protector-guard-offset=3D0\n\nUros.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172803600119118.mbox",
          "message_id": "<CAFULd4an+aN4iJ7T0DdMQDOBWrTZPJ4Oyy9ULm6R29fLNQND9Q () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-04 10:01:39+00:00",
          "date_str": "Fri, 04 Oct 2024 10:01:39 +0000",
          "body": "On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@google.com=\n> wrote:\n>\n> From: Ard Biesheuvel <ardb@kernel.org>\n>\n> Specify the guard symbol for the stack cookie explicitly, rather than\n> positioning it exactly 40 bytes into the per-CPU area. Doing so removes\n> the need for the per-CPU region to be absolute rather than relative to\n> the placement of the per-CPU template region in the kernel image, and\n> this allows the special handling for absolute per-CPU symbols to be\n> removed entirely.\n>\n> This is a worthwhile cleanup in itself, but it is also a prerequisite\n> for PIE codegen and PIE linking, which can replace our bespoke and\n> rather clunky runtime relocation handling.\n>\n> Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> ---\n>  arch/x86/Makefile                     |  4 ++++\n>  arch/x86/include/asm/init.h           |  2 +-\n>  arch/x86/include/asm/processor.h      | 11 +++--------\n>  arch/x86/include/asm/stackprotector.h |  4 ----\n>  tools/perf/util/annotate.c            |  4 ++--\n>  5 files changed, 10 insertions(+), 15 deletions(-)\n>\n> diff --git a/arch/x86/Makefile b/arch/x86/Makefile\n> index 6b3fe6e2aadd..b78b7623a4a9 100644\n> --- a/arch/x86/Makefile\n> +++ b/arch/x86/Makefile\n> @@ -193,6 +193,10 @@ else\n>          KBUILD_RUSTFLAGS +=3D -Cno-redzone=3Dy\n>          KBUILD_RUSTFLAGS +=3D -Ccode-model=3Dkernel\n>\n> +        ifeq ($(CONFIG_STACKPROTECTOR),y)\n> +                KBUILD_CFLAGS +=3D -mstack-protector-guard-symbol=3Dfixe=\nd_percpu_data\n\nLooking at:\n\n> +        * Since the irq_stack is the object at %gs:0, the bottom 8 bytes=\n of\n> +        * the irq stack are reserved for the canary.\n\nPlease note that %gs:0 can also be achieved with\n-mstack-protector-guard-offset=3D0\n\nUros.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172804762626560.mbox",
          "message_id": "<CAMj1kXF3_Hj9j2f_cBtwTFWvEmB0UoEs_cGkRiWc4AErDx0ftQ () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-04 13:15:22+00:00",
          "date_str": "Fri, 04 Oct 2024 13:15:22 +0000",
          "body": "On Sat, 28 Sept 2024 at 15:41, Brian Gerst <brgerst@gmail.com> wrote:\n>\n> On Wed, Sep 25, 2024 at 2:33=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> w=\nrote:\n> >\n> > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@google=\n.com> wrote:\n> > >\n> > > From: Ard Biesheuvel <ardb@kernel.org>\n> > >\n> > > Specify the guard symbol for the stack cookie explicitly, rather than\n> > > positioning it exactly 40 bytes into the per-CPU area. Doing so remov=\nes\n> > > the need for the per-CPU region to be absolute rather than relative t=\no\n> > > the placement of the per-CPU template region in the kernel image, and\n> > > this allows the special handling for absolute per-CPU symbols to be\n> > > removed entirely.\n> > >\n> > > This is a worthwhile cleanup in itself, but it is also a prerequisite\n> > > for PIE codegen and PIE linking, which can replace our bespoke and\n> > > rather clunky runtime relocation handling.\n> >\n> > I would like to point out a series that converted the stack protector\n> > guard symbol to a normal percpu variable [1], so there was no need to\n> > assume anything about the location of the guard symbol.\n> >\n> > [1] \"[PATCH v4 00/16] x86-64: Stack protector and percpu improvements\"\n> > https://lore.kernel.org/lkml/20240322165233.71698-1-brgerst@gmail.com/\n> >\n> > Uros.\n>\n> I plan on resubmitting that series sometime after the 6.12 merge\n> window closes.  As I recall from the last version, it was decided to\n> wait until after the next LTS release to raise the minimum GCC version\n> to 8.1 and avoid the need to be compatible with the old stack\n> protector layout.\n>\n\nHi Brian,\n\nI'd be more than happy to compare notes on that - I wasn't aware of\nyour intentions here, or I would have reached out before sending this\nRFC.\n\nThere are two things that you would need to address for Clang support\nto work correctly:\n- the workaround I cc'ed you on the other day [0],\n- a workaround for the module loader so it tolerates the GOTPCRELX\nrelocations that Clang emits [1]\n\n\n\n[0] https://lore.kernel.org/all/20241002092534.3163838-2-ardb+git@google.co=\nm/\n[1] https://git.kernel.org/pub/scm/linux/kernel/git/ardb/linux.git/commit/?=\nid=3Da18121aabbdd\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172804761726548.mbox",
          "message_id": "<CAMj1kXF3_Hj9j2f_cBtwTFWvEmB0UoEs_cGkRiWc4AErDx0ftQ () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-04 13:15:22+00:00",
          "date_str": "Fri, 04 Oct 2024 13:15:22 +0000",
          "body": "On Sat, 28 Sept 2024 at 15:41, Brian Gerst <brgerst@gmail.com> wrote:\n>\n> On Wed, Sep 25, 2024 at 2:33=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> w=\nrote:\n> >\n> > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@google=\n.com> wrote:\n> > >\n> > > From: Ard Biesheuvel <ardb@kernel.org>\n> > >\n> > > Specify the guard symbol for the stack cookie explicitly, rather than\n> > > positioning it exactly 40 bytes into the per-CPU area. Doing so remov=\nes\n> > > the need for the per-CPU region to be absolute rather than relative t=\no\n> > > the placement of the per-CPU template region in the kernel image, and\n> > > this allows the special handling for absolute per-CPU symbols to be\n> > > removed entirely.\n> > >\n> > > This is a worthwhile cleanup in itself, but it is also a prerequisite\n> > > for PIE codegen and PIE linking, which can replace our bespoke and\n> > > rather clunky runtime relocation handling.\n> >\n> > I would like to point out a series that converted the stack protector\n> > guard symbol to a normal percpu variable [1], so there was no need to\n> > assume anything about the location of the guard symbol.\n> >\n> > [1] \"[PATCH v4 00/16] x86-64: Stack protector and percpu improvements\"\n> > https://lore.kernel.org/lkml/20240322165233.71698-1-brgerst@gmail.com/\n> >\n> > Uros.\n>\n> I plan on resubmitting that series sometime after the 6.12 merge\n> window closes.  As I recall from the last version, it was decided to\n> wait until after the next LTS release to raise the minimum GCC version\n> to 8.1 and avoid the need to be compatible with the old stack\n> protector layout.\n>\n\nHi Brian,\n\nI'd be more than happy to compare notes on that - I wasn't aware of\nyour intentions here, or I would have reached out before sending this\nRFC.\n\nThere are two things that you would need to address for Clang support\nto work correctly:\n- the workaround I cc'ed you on the other day [0],\n- a workaround for the module loader so it tolerates the GOTPCRELX\nrelocations that Clang emits [1]\n\n\n\n[0] https://lore.kernel.org/all/20241002092534.3163838-2-ardb+git@google.co=\nm/\n[1] https://git.kernel.org/pub/scm/linux/kernel/git/ardb/linux.git/commit/?=\nid=3Da18121aabbdd\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172804762726563.mbox",
          "message_id": "<CAMj1kXF3_Hj9j2f_cBtwTFWvEmB0UoEs_cGkRiWc4AErDx0ftQ () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-04 13:15:22+00:00",
          "date_str": "Fri, 04 Oct 2024 13:15:22 +0000",
          "body": "On Sat, 28 Sept 2024 at 15:41, Brian Gerst <brgerst@gmail.com> wrote:\n>\n> On Wed, Sep 25, 2024 at 2:33=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> w=\nrote:\n> >\n> > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@google=\n.com> wrote:\n> > >\n> > > From: Ard Biesheuvel <ardb@kernel.org>\n> > >\n> > > Specify the guard symbol for the stack cookie explicitly, rather than\n> > > positioning it exactly 40 bytes into the per-CPU area. Doing so remov=\nes\n> > > the need for the per-CPU region to be absolute rather than relative t=\no\n> > > the placement of the per-CPU template region in the kernel image, and\n> > > this allows the special handling for absolute per-CPU symbols to be\n> > > removed entirely.\n> > >\n> > > This is a worthwhile cleanup in itself, but it is also a prerequisite\n> > > for PIE codegen and PIE linking, which can replace our bespoke and\n> > > rather clunky runtime relocation handling.\n> >\n> > I would like to point out a series that converted the stack protector\n> > guard symbol to a normal percpu variable [1], so there was no need to\n> > assume anything about the location of the guard symbol.\n> >\n> > [1] \"[PATCH v4 00/16] x86-64: Stack protector and percpu improvements\"\n> > https://lore.kernel.org/lkml/20240322165233.71698-1-brgerst@gmail.com/\n> >\n> > Uros.\n>\n> I plan on resubmitting that series sometime after the 6.12 merge\n> window closes.  As I recall from the last version, it was decided to\n> wait until after the next LTS release to raise the minimum GCC version\n> to 8.1 and avoid the need to be compatible with the old stack\n> protector layout.\n>\n\nHi Brian,\n\nI'd be more than happy to compare notes on that - I wasn't aware of\nyour intentions here, or I would have reached out before sending this\nRFC.\n\nThere are two things that you would need to address for Clang support\nto work correctly:\n- the workaround I cc'ed you on the other day [0],\n- a workaround for the module loader so it tolerates the GOTPCRELX\nrelocations that Clang emits [1]\n\n\n\n[0] https://lore.kernel.org/all/20241002092534.3163838-2-ardb+git@google.co=\nm/\n[1] https://git.kernel.org/pub/scm/linux/kernel/git/ardb/linux.git/commit/?=\nid=3Da18121aabbdd\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172804761726547.mbox",
          "message_id": "<CAMj1kXF3_Hj9j2f_cBtwTFWvEmB0UoEs_cGkRiWc4AErDx0ftQ () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-04 13:15:22+00:00",
          "date_str": "Fri, 04 Oct 2024 13:15:22 +0000",
          "body": "On Sat, 28 Sept 2024 at 15:41, Brian Gerst <brgerst@gmail.com> wrote:\n>\n> On Wed, Sep 25, 2024 at 2:33=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> w=\nrote:\n> >\n> > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@google=\n.com> wrote:\n> > >\n> > > From: Ard Biesheuvel <ardb@kernel.org>\n> > >\n> > > Specify the guard symbol for the stack cookie explicitly, rather than\n> > > positioning it exactly 40 bytes into the per-CPU area. Doing so remov=\nes\n> > > the need for the per-CPU region to be absolute rather than relative t=\no\n> > > the placement of the per-CPU template region in the kernel image, and\n> > > this allows the special handling for absolute per-CPU symbols to be\n> > > removed entirely.\n> > >\n> > > This is a worthwhile cleanup in itself, but it is also a prerequisite\n> > > for PIE codegen and PIE linking, which can replace our bespoke and\n> > > rather clunky runtime relocation handling.\n> >\n> > I would like to point out a series that converted the stack protector\n> > guard symbol to a normal percpu variable [1], so there was no need to\n> > assume anything about the location of the guard symbol.\n> >\n> > [1] \"[PATCH v4 00/16] x86-64: Stack protector and percpu improvements\"\n> > https://lore.kernel.org/lkml/20240322165233.71698-1-brgerst@gmail.com/\n> >\n> > Uros.\n>\n> I plan on resubmitting that series sometime after the 6.12 merge\n> window closes.  As I recall from the last version, it was decided to\n> wait until after the next LTS release to raise the minimum GCC version\n> to 8.1 and avoid the need to be compatible with the old stack\n> protector layout.\n>\n\nHi Brian,\n\nI'd be more than happy to compare notes on that - I wasn't aware of\nyour intentions here, or I would have reached out before sending this\nRFC.\n\nThere are two things that you would need to address for Clang support\nto work correctly:\n- the workaround I cc'ed you on the other day [0],\n- a workaround for the module loader so it tolerates the GOTPCRELX\nrelocations that Clang emits [1]\n\n\n\n[0] https://lore.kernel.org/all/20241002092534.3163838-2-ardb+git@google.co=\nm/\n[1] https://git.kernel.org/pub/scm/linux/kernel/git/ardb/linux.git/commit/?=\nid=3Da18121aabbdd\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172804762026554.mbox",
          "message_id": "<CAMj1kXF3_Hj9j2f_cBtwTFWvEmB0UoEs_cGkRiWc4AErDx0ftQ () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-04 13:15:22+00:00",
          "date_str": "Fri, 04 Oct 2024 13:15:22 +0000",
          "body": "On Sat, 28 Sept 2024 at 15:41, Brian Gerst <brgerst@gmail.com> wrote:\n>\n> On Wed, Sep 25, 2024 at 2:33=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> w=\nrote:\n> >\n> > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@google=\n.com> wrote:\n> > >\n> > > From: Ard Biesheuvel <ardb@kernel.org>\n> > >\n> > > Specify the guard symbol for the stack cookie explicitly, rather than\n> > > positioning it exactly 40 bytes into the per-CPU area. Doing so remov=\nes\n> > > the need for the per-CPU region to be absolute rather than relative t=\no\n> > > the placement of the per-CPU template region in the kernel image, and\n> > > this allows the special handling for absolute per-CPU symbols to be\n> > > removed entirely.\n> > >\n> > > This is a worthwhile cleanup in itself, but it is also a prerequisite\n> > > for PIE codegen and PIE linking, which can replace our bespoke and\n> > > rather clunky runtime relocation handling.\n> >\n> > I would like to point out a series that converted the stack protector\n> > guard symbol to a normal percpu variable [1], so there was no need to\n> > assume anything about the location of the guard symbol.\n> >\n> > [1] \"[PATCH v4 00/16] x86-64: Stack protector and percpu improvements\"\n> > https://lore.kernel.org/lkml/20240322165233.71698-1-brgerst@gmail.com/\n> >\n> > Uros.\n>\n> I plan on resubmitting that series sometime after the 6.12 merge\n> window closes.  As I recall from the last version, it was decided to\n> wait until after the next LTS release to raise the minimum GCC version\n> to 8.1 and avoid the need to be compatible with the old stack\n> protector layout.\n>\n\nHi Brian,\n\nI'd be more than happy to compare notes on that - I wasn't aware of\nyour intentions here, or I would have reached out before sending this\nRFC.\n\nThere are two things that you would need to address for Clang support\nto work correctly:\n- the workaround I cc'ed you on the other day [0],\n- a workaround for the module loader so it tolerates the GOTPCRELX\nrelocations that Clang emits [1]\n\n\n\n[0] https://lore.kernel.org/all/20241002092534.3163838-2-ardb+git@google.co=\nm/\n[1] https://git.kernel.org/pub/scm/linux/kernel/git/ardb/linux.git/commit/?=\nid=3Da18121aabbdd\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172804761626537.mbox",
          "message_id": "<CAMj1kXF3_Hj9j2f_cBtwTFWvEmB0UoEs_cGkRiWc4AErDx0ftQ () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-04 13:15:22+00:00",
          "date_str": "Fri, 04 Oct 2024 13:15:22 +0000",
          "body": "On Sat, 28 Sept 2024 at 15:41, Brian Gerst <brgerst@gmail.com> wrote:\n>\n> On Wed, Sep 25, 2024 at 2:33=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> w=\nrote:\n> >\n> > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@google=\n.com> wrote:\n> > >\n> > > From: Ard Biesheuvel <ardb@kernel.org>\n> > >\n> > > Specify the guard symbol for the stack cookie explicitly, rather than\n> > > positioning it exactly 40 bytes into the per-CPU area. Doing so remov=\nes\n> > > the need for the per-CPU region to be absolute rather than relative t=\no\n> > > the placement of the per-CPU template region in the kernel image, and\n> > > this allows the special handling for absolute per-CPU symbols to be\n> > > removed entirely.\n> > >\n> > > This is a worthwhile cleanup in itself, but it is also a prerequisite\n> > > for PIE codegen and PIE linking, which can replace our bespoke and\n> > > rather clunky runtime relocation handling.\n> >\n> > I would like to point out a series that converted the stack protector\n> > guard symbol to a normal percpu variable [1], so there was no need to\n> > assume anything about the location of the guard symbol.\n> >\n> > [1] \"[PATCH v4 00/16] x86-64: Stack protector and percpu improvements\"\n> > https://lore.kernel.org/lkml/20240322165233.71698-1-brgerst@gmail.com/\n> >\n> > Uros.\n>\n> I plan on resubmitting that series sometime after the 6.12 merge\n> window closes.  As I recall from the last version, it was decided to\n> wait until after the next LTS release to raise the minimum GCC version\n> to 8.1 and avoid the need to be compatible with the old stack\n> protector layout.\n>\n\nHi Brian,\n\nI'd be more than happy to compare notes on that - I wasn't aware of\nyour intentions here, or I would have reached out before sending this\nRFC.\n\nThere are two things that you would need to address for Clang support\nto work correctly:\n- the workaround I cc'ed you on the other day [0],\n- a workaround for the module loader so it tolerates the GOTPCRELX\nrelocations that Clang emits [1]\n\n\n\n[0] https://lore.kernel.org/all/20241002092534.3163838-2-ardb+git@google.co=\nm/\n[1] https://git.kernel.org/pub/scm/linux/kernel/git/ardb/linux.git/commit/?=\nid=3Da18121aabbdd\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172804761726546.mbox",
          "message_id": "<CAMj1kXF3_Hj9j2f_cBtwTFWvEmB0UoEs_cGkRiWc4AErDx0ftQ () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-04 13:15:22+00:00",
          "date_str": "Fri, 04 Oct 2024 13:15:22 +0000",
          "body": "On Sat, 28 Sept 2024 at 15:41, Brian Gerst <brgerst@gmail.com> wrote:\n>\n> On Wed, Sep 25, 2024 at 2:33=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> w=\nrote:\n> >\n> > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@google=\n.com> wrote:\n> > >\n> > > From: Ard Biesheuvel <ardb@kernel.org>\n> > >\n> > > Specify the guard symbol for the stack cookie explicitly, rather than\n> > > positioning it exactly 40 bytes into the per-CPU area. Doing so remov=\nes\n> > > the need for the per-CPU region to be absolute rather than relative t=\no\n> > > the placement of the per-CPU template region in the kernel image, and\n> > > this allows the special handling for absolute per-CPU symbols to be\n> > > removed entirely.\n> > >\n> > > This is a worthwhile cleanup in itself, but it is also a prerequisite\n> > > for PIE codegen and PIE linking, which can replace our bespoke and\n> > > rather clunky runtime relocation handling.\n> >\n> > I would like to point out a series that converted the stack protector\n> > guard symbol to a normal percpu variable [1], so there was no need to\n> > assume anything about the location of the guard symbol.\n> >\n> > [1] \"[PATCH v4 00/16] x86-64: Stack protector and percpu improvements\"\n> > https://lore.kernel.org/lkml/20240322165233.71698-1-brgerst@gmail.com/\n> >\n> > Uros.\n>\n> I plan on resubmitting that series sometime after the 6.12 merge\n> window closes.  As I recall from the last version, it was decided to\n> wait until after the next LTS release to raise the minimum GCC version\n> to 8.1 and avoid the need to be compatible with the old stack\n> protector layout.\n>\n\nHi Brian,\n\nI'd be more than happy to compare notes on that - I wasn't aware of\nyour intentions here, or I would have reached out before sending this\nRFC.\n\nThere are two things that you would need to address for Clang support\nto work correctly:\n- the workaround I cc'ed you on the other day [0],\n- a workaround for the module loader so it tolerates the GOTPCRELX\nrelocations that Clang emits [1]\n\n\n\n[0] https://lore.kernel.org/all/20241002092534.3163838-2-ardb+git@google.co=\nm/\n[1] https://git.kernel.org/pub/scm/linux/kernel/git/ardb/linux.git/commit/?=\nid=3Da18121aabbdd\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172839805328742.mbox",
          "message_id": "<CAMzpN2jWRV8-JzM2FjSvSz+VoDrNVeEJPgF7N5ksLaADHpnHsA () mail ! gmail ! com>",
          "author_name": "Brian Gerst",
          "author_email": "brgerst () gmail ! com",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-08 14:36:03+00:00",
          "date_str": "Tue, 08 Oct 2024 14:36:03 +0000",
          "body": "On Fri, Oct 4, 2024 at 9:15=E2=80=AFAM Ard Biesheuvel <ardb@kernel.org> wro=\nte:\n>\n> On Sat, 28 Sept 2024 at 15:41, Brian Gerst <brgerst@gmail.com> wrote:\n> >\n> > On Wed, Sep 25, 2024 at 2:33=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com>=\n wrote:\n> > >\n> > > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@goog=\nle.com> wrote:\n> > > >\n> > > > From: Ard Biesheuvel <ardb@kernel.org>\n> > > >\n> > > > Specify the guard symbol for the stack cookie explicitly, rather th=\nan\n> > > > positioning it exactly 40 bytes into the per-CPU area. Doing so rem=\noves\n> > > > the need for the per-CPU region to be absolute rather than relative=\n to\n> > > > the placement of the per-CPU template region in the kernel image, a=\nnd\n> > > > this allows the special handling for absolute per-CPU symbols to be\n> > > > removed entirely.\n> > > >\n> > > > This is a worthwhile cleanup in itself, but it is also a prerequisi=\nte\n> > > > for PIE codegen and PIE linking, which can replace our bespoke and\n> > > > rather clunky runtime relocation handling.\n> > >\n> > > I would like to point out a series that converted the stack protector\n> > > guard symbol to a normal percpu variable [1], so there was no need to\n> > > assume anything about the location of the guard symbol.\n> > >\n> > > [1] \"[PATCH v4 00/16] x86-64: Stack protector and percpu improvements=\n\"\n> > > https://lore.kernel.org/lkml/20240322165233.71698-1-brgerst@gmail.com=\n/\n> > >\n> > > Uros.\n> >\n> > I plan on resubmitting that series sometime after the 6.12 merge\n> > window closes.  As I recall from the last version, it was decided to\n> > wait until after the next LTS release to raise the minimum GCC version\n> > to 8.1 and avoid the need to be compatible with the old stack\n> > protector layout.\n> >\n>\n> Hi Brian,\n>\n> I'd be more than happy to compare notes on that - I wasn't aware of\n> your intentions here, or I would have reached out before sending this\n> RFC.\n>\n> There are two things that you would need to address for Clang support\n> to work correctly:\n> - the workaround I cc'ed you on the other day [0],\n> - a workaround for the module loader so it tolerates the GOTPCRELX\n> relocations that Clang emits [1]\n>\n>\n>\n> [0] https://lore.kernel.org/all/20241002092534.3163838-2-ardb+git@google.=\ncom/\n> [1] https://git.kernel.org/pub/scm/linux/kernel/git/ardb/linux.git/commit=\n/?id=3Da18121aabbdd\n\nThe first patch should be applied independently as a bug fix, since it\nalready affects the 32-bit build with clang.\n\nI don't have an environment with an older clang compiler to test the\nsecond patch, but I'll assume it will be necessary.  I did run into an\nissue with the GOTPCRELX relocations before [1], but I thought it was\njust an objtool issue and didn't do more testing to know if modules\nwere broken or not.\n\nBrian Gerst\n\n[1] https://lore.kernel.org/all/20231026160100.195099-6-brgerst@gmail.com/\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172839808928870.mbox",
          "message_id": "<CAMzpN2jWRV8-JzM2FjSvSz+VoDrNVeEJPgF7N5ksLaADHpnHsA () mail ! gmail ! com>",
          "author_name": "Brian Gerst",
          "author_email": "brgerst () gmail ! com",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-08 14:36:03+00:00",
          "date_str": "Tue, 08 Oct 2024 14:36:03 +0000",
          "body": "On Fri, Oct 4, 2024 at 9:15=E2=80=AFAM Ard Biesheuvel <ardb@kernel.org> wro=\nte:\n>\n> On Sat, 28 Sept 2024 at 15:41, Brian Gerst <brgerst@gmail.com> wrote:\n> >\n> > On Wed, Sep 25, 2024 at 2:33=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com>=\n wrote:\n> > >\n> > > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@goog=\nle.com> wrote:\n> > > >\n> > > > From: Ard Biesheuvel <ardb@kernel.org>\n> > > >\n> > > > Specify the guard symbol for the stack cookie explicitly, rather th=\nan\n> > > > positioning it exactly 40 bytes into the per-CPU area. Doing so rem=\noves\n> > > > the need for the per-CPU region to be absolute rather than relative=\n to\n> > > > the placement of the per-CPU template region in the kernel image, a=\nnd\n> > > > this allows the special handling for absolute per-CPU symbols to be\n> > > > removed entirely.\n> > > >\n> > > > This is a worthwhile cleanup in itself, but it is also a prerequisi=\nte\n> > > > for PIE codegen and PIE linking, which can replace our bespoke and\n> > > > rather clunky runtime relocation handling.\n> > >\n> > > I would like to point out a series that converted the stack protector\n> > > guard symbol to a normal percpu variable [1], so there was no need to\n> > > assume anything about the location of the guard symbol.\n> > >\n> > > [1] \"[PATCH v4 00/16] x86-64: Stack protector and percpu improvements=\n\"\n> > > https://lore.kernel.org/lkml/20240322165233.71698-1-brgerst@gmail.com=\n/\n> > >\n> > > Uros.\n> >\n> > I plan on resubmitting that series sometime after the 6.12 merge\n> > window closes.  As I recall from the last version, it was decided to\n> > wait until after the next LTS release to raise the minimum GCC version\n> > to 8.1 and avoid the need to be compatible with the old stack\n> > protector layout.\n> >\n>\n> Hi Brian,\n>\n> I'd be more than happy to compare notes on that - I wasn't aware of\n> your intentions here, or I would have reached out before sending this\n> RFC.\n>\n> There are two things that you would need to address for Clang support\n> to work correctly:\n> - the workaround I cc'ed you on the other day [0],\n> - a workaround for the module loader so it tolerates the GOTPCRELX\n> relocations that Clang emits [1]\n>\n>\n>\n> [0] https://lore.kernel.org/all/20241002092534.3163838-2-ardb+git@google.=\ncom/\n> [1] https://git.kernel.org/pub/scm/linux/kernel/git/ardb/linux.git/commit=\n/?id=3Da18121aabbdd\n\nThe first patch should be applied independently as a bug fix, since it\nalready affects the 32-bit build with clang.\n\nI don't have an environment with an older clang compiler to test the\nsecond patch, but I'll assume it will be necessary.  I did run into an\nissue with the GOTPCRELX relocations before [1], but I thought it was\njust an objtool issue and didn't do more testing to know if modules\nwere broken or not.\n\nBrian Gerst\n\n[1] https://lore.kernel.org/all/20231026160100.195099-6-brgerst@gmail.com/\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172839849029208.mbox",
          "message_id": "<CAMzpN2jWRV8-JzM2FjSvSz+VoDrNVeEJPgF7N5ksLaADHpnHsA () mail ! gmail ! com>",
          "author_name": "Brian Gerst",
          "author_email": "brgerst () gmail ! com",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-08 14:36:03+00:00",
          "date_str": "Tue, 08 Oct 2024 14:36:03 +0000",
          "body": "On Fri, Oct 4, 2024 at 9:15=E2=80=AFAM Ard Biesheuvel <ardb@kernel.org> wro=\nte:\n>\n> On Sat, 28 Sept 2024 at 15:41, Brian Gerst <brgerst@gmail.com> wrote:\n> >\n> > On Wed, Sep 25, 2024 at 2:33=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com>=\n wrote:\n> > >\n> > > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@goog=\nle.com> wrote:\n> > > >\n> > > > From: Ard Biesheuvel <ardb@kernel.org>\n> > > >\n> > > > Specify the guard symbol for the stack cookie explicitly, rather th=\nan\n> > > > positioning it exactly 40 bytes into the per-CPU area. Doing so rem=\noves\n> > > > the need for the per-CPU region to be absolute rather than relative=\n to\n> > > > the placement of the per-CPU template region in the kernel image, a=\nnd\n> > > > this allows the special handling for absolute per-CPU symbols to be\n> > > > removed entirely.\n> > > >\n> > > > This is a worthwhile cleanup in itself, but it is also a prerequisi=\nte\n> > > > for PIE codegen and PIE linking, which can replace our bespoke and\n> > > > rather clunky runtime relocation handling.\n> > >\n> > > I would like to point out a series that converted the stack protector\n> > > guard symbol to a normal percpu variable [1], so there was no need to\n> > > assume anything about the location of the guard symbol.\n> > >\n> > > [1] \"[PATCH v4 00/16] x86-64: Stack protector and percpu improvements=\n\"\n> > > https://lore.kernel.org/lkml/20240322165233.71698-1-brgerst@gmail.com=\n/\n> > >\n> > > Uros.\n> >\n> > I plan on resubmitting that series sometime after the 6.12 merge\n> > window closes.  As I recall from the last version, it was decided to\n> > wait until after the next LTS release to raise the minimum GCC version\n> > to 8.1 and avoid the need to be compatible with the old stack\n> > protector layout.\n> >\n>\n> Hi Brian,\n>\n> I'd be more than happy to compare notes on that - I wasn't aware of\n> your intentions here, or I would have reached out before sending this\n> RFC.\n>\n> There are two things that you would need to address for Clang support\n> to work correctly:\n> - the workaround I cc'ed you on the other day [0],\n> - a workaround for the module loader so it tolerates the GOTPCRELX\n> relocations that Clang emits [1]\n>\n>\n>\n> [0] https://lore.kernel.org/all/20241002092534.3163838-2-ardb+git@google.=\ncom/\n> [1] https://git.kernel.org/pub/scm/linux/kernel/git/ardb/linux.git/commit=\n/?id=3Da18121aabbdd\n\nThe first patch should be applied independently as a bug fix, since it\nalready affects the 32-bit build with clang.\n\nI don't have an environment with an older clang compiler to test the\nsecond patch, but I'll assume it will be necessary.  I did run into an\nissue with the GOTPCRELX relocations before [1], but I thought it was\njust an objtool issue and didn't do more testing to know if modules\nwere broken or not.\n\nBrian Gerst\n\n[1] https://lore.kernel.org/all/20231026160100.195099-6-brgerst@gmail.com/\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172839807828859.mbox",
          "message_id": "<CAMzpN2jWRV8-JzM2FjSvSz+VoDrNVeEJPgF7N5ksLaADHpnHsA () mail ! gmail ! com>",
          "author_name": "Brian Gerst",
          "author_email": "brgerst () gmail ! com",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-08 14:36:03+00:00",
          "date_str": "Tue, 08 Oct 2024 14:36:03 +0000",
          "body": "On Fri, Oct 4, 2024 at 9:15=E2=80=AFAM Ard Biesheuvel <ardb@kernel.org> wro=\nte:\n>\n> On Sat, 28 Sept 2024 at 15:41, Brian Gerst <brgerst@gmail.com> wrote:\n> >\n> > On Wed, Sep 25, 2024 at 2:33=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com>=\n wrote:\n> > >\n> > > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@goog=\nle.com> wrote:\n> > > >\n> > > > From: Ard Biesheuvel <ardb@kernel.org>\n> > > >\n> > > > Specify the guard symbol for the stack cookie explicitly, rather th=\nan\n> > > > positioning it exactly 40 bytes into the per-CPU area. Doing so rem=\noves\n> > > > the need for the per-CPU region to be absolute rather than relative=\n to\n> > > > the placement of the per-CPU template region in the kernel image, a=\nnd\n> > > > this allows the special handling for absolute per-CPU symbols to be\n> > > > removed entirely.\n> > > >\n> > > > This is a worthwhile cleanup in itself, but it is also a prerequisi=\nte\n> > > > for PIE codegen and PIE linking, which can replace our bespoke and\n> > > > rather clunky runtime relocation handling.\n> > >\n> > > I would like to point out a series that converted the stack protector\n> > > guard symbol to a normal percpu variable [1], so there was no need to\n> > > assume anything about the location of the guard symbol.\n> > >\n> > > [1] \"[PATCH v4 00/16] x86-64: Stack protector and percpu improvements=\n\"\n> > > https://lore.kernel.org/lkml/20240322165233.71698-1-brgerst@gmail.com=\n/\n> > >\n> > > Uros.\n> >\n> > I plan on resubmitting that series sometime after the 6.12 merge\n> > window closes.  As I recall from the last version, it was decided to\n> > wait until after the next LTS release to raise the minimum GCC version\n> > to 8.1 and avoid the need to be compatible with the old stack\n> > protector layout.\n> >\n>\n> Hi Brian,\n>\n> I'd be more than happy to compare notes on that - I wasn't aware of\n> your intentions here, or I would have reached out before sending this\n> RFC.\n>\n> There are two things that you would need to address for Clang support\n> to work correctly:\n> - the workaround I cc'ed you on the other day [0],\n> - a workaround for the module loader so it tolerates the GOTPCRELX\n> relocations that Clang emits [1]\n>\n>\n>\n> [0] https://lore.kernel.org/all/20241002092534.3163838-2-ardb+git@google.=\ncom/\n> [1] https://git.kernel.org/pub/scm/linux/kernel/git/ardb/linux.git/commit=\n/?id=3Da18121aabbdd\n\nThe first patch should be applied independently as a bug fix, since it\nalready affects the 32-bit build with clang.\n\nI don't have an environment with an older clang compiler to test the\nsecond patch, but I'll assume it will be necessary.  I did run into an\nissue with the GOTPCRELX relocations before [1], but I thought it was\njust an objtool issue and didn't do more testing to know if modules\nwere broken or not.\n\nBrian Gerst\n\n[1] https://lore.kernel.org/all/20231026160100.195099-6-brgerst@gmail.com/\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172839807428844.mbox",
          "message_id": "<CAMzpN2jWRV8-JzM2FjSvSz+VoDrNVeEJPgF7N5ksLaADHpnHsA () mail ! gmail ! com>",
          "author_name": "Brian Gerst",
          "author_email": "brgerst () gmail ! com",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-08 14:36:03+00:00",
          "date_str": "Tue, 08 Oct 2024 14:36:03 +0000",
          "body": "On Fri, Oct 4, 2024 at 9:15=E2=80=AFAM Ard Biesheuvel <ardb@kernel.org> wro=\nte:\n>\n> On Sat, 28 Sept 2024 at 15:41, Brian Gerst <brgerst@gmail.com> wrote:\n> >\n> > On Wed, Sep 25, 2024 at 2:33=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com>=\n wrote:\n> > >\n> > > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@goog=\nle.com> wrote:\n> > > >\n> > > > From: Ard Biesheuvel <ardb@kernel.org>\n> > > >\n> > > > Specify the guard symbol for the stack cookie explicitly, rather th=\nan\n> > > > positioning it exactly 40 bytes into the per-CPU area. Doing so rem=\noves\n> > > > the need for the per-CPU region to be absolute rather than relative=\n to\n> > > > the placement of the per-CPU template region in the kernel image, a=\nnd\n> > > > this allows the special handling for absolute per-CPU symbols to be\n> > > > removed entirely.\n> > > >\n> > > > This is a worthwhile cleanup in itself, but it is also a prerequisi=\nte\n> > > > for PIE codegen and PIE linking, which can replace our bespoke and\n> > > > rather clunky runtime relocation handling.\n> > >\n> > > I would like to point out a series that converted the stack protector\n> > > guard symbol to a normal percpu variable [1], so there was no need to\n> > > assume anything about the location of the guard symbol.\n> > >\n> > > [1] \"[PATCH v4 00/16] x86-64: Stack protector and percpu improvements=\n\"\n> > > https://lore.kernel.org/lkml/20240322165233.71698-1-brgerst@gmail.com=\n/\n> > >\n> > > Uros.\n> >\n> > I plan on resubmitting that series sometime after the 6.12 merge\n> > window closes.  As I recall from the last version, it was decided to\n> > wait until after the next LTS release to raise the minimum GCC version\n> > to 8.1 and avoid the need to be compatible with the old stack\n> > protector layout.\n> >\n>\n> Hi Brian,\n>\n> I'd be more than happy to compare notes on that - I wasn't aware of\n> your intentions here, or I would have reached out before sending this\n> RFC.\n>\n> There are two things that you would need to address for Clang support\n> to work correctly:\n> - the workaround I cc'ed you on the other day [0],\n> - a workaround for the module loader so it tolerates the GOTPCRELX\n> relocations that Clang emits [1]\n>\n>\n>\n> [0] https://lore.kernel.org/all/20241002092534.3163838-2-ardb+git@google.=\ncom/\n> [1] https://git.kernel.org/pub/scm/linux/kernel/git/ardb/linux.git/commit=\n/?id=3Da18121aabbdd\n\nThe first patch should be applied independently as a bug fix, since it\nalready affects the 32-bit build with clang.\n\nI don't have an environment with an older clang compiler to test the\nsecond patch, but I'll assume it will be necessary.  I did run into an\nissue with the GOTPCRELX relocations before [1], but I thought it was\njust an objtool issue and didn't do more testing to know if modules\nwere broken or not.\n\nBrian Gerst\n\n[1] https://lore.kernel.org/all/20231026160100.195099-6-brgerst@gmail.com/\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172839807828858.mbox",
          "message_id": "<CAMzpN2jWRV8-JzM2FjSvSz+VoDrNVeEJPgF7N5ksLaADHpnHsA () mail ! gmail ! com>",
          "author_name": "Brian Gerst",
          "author_email": "brgerst () gmail ! com",
          "subject": "Re: [RFC PATCH 05/28] x86: Define the stack protector guard symbol explicitly",
          "date": "2024-10-08 14:36:03+00:00",
          "date_str": "Tue, 08 Oct 2024 14:36:03 +0000",
          "body": "On Fri, Oct 4, 2024 at 9:15=E2=80=AFAM Ard Biesheuvel <ardb@kernel.org> wro=\nte:\n>\n> On Sat, 28 Sept 2024 at 15:41, Brian Gerst <brgerst@gmail.com> wrote:\n> >\n> > On Wed, Sep 25, 2024 at 2:33=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com>=\n wrote:\n> > >\n> > > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@goog=\nle.com> wrote:\n> > > >\n> > > > From: Ard Biesheuvel <ardb@kernel.org>\n> > > >\n> > > > Specify the guard symbol for the stack cookie explicitly, rather th=\nan\n> > > > positioning it exactly 40 bytes into the per-CPU area. Doing so rem=\noves\n> > > > the need for the per-CPU region to be absolute rather than relative=\n to\n> > > > the placement of the per-CPU template region in the kernel image, a=\nnd\n> > > > this allows the special handling for absolute per-CPU symbols to be\n> > > > removed entirely.\n> > > >\n> > > > This is a worthwhile cleanup in itself, but it is also a prerequisi=\nte\n> > > > for PIE codegen and PIE linking, which can replace our bespoke and\n> > > > rather clunky runtime relocation handling.\n> > >\n> > > I would like to point out a series that converted the stack protector\n> > > guard symbol to a normal percpu variable [1], so there was no need to\n> > > assume anything about the location of the guard symbol.\n> > >\n> > > [1] \"[PATCH v4 00/16] x86-64: Stack protector and percpu improvements=\n\"\n> > > https://lore.kernel.org/lkml/20240322165233.71698-1-brgerst@gmail.com=\n/\n> > >\n> > > Uros.\n> >\n> > I plan on resubmitting that series sometime after the 6.12 merge\n> > window closes.  As I recall from the last version, it was decided to\n> > wait until after the next LTS release to raise the minimum GCC version\n> > to 8.1 and avoid the need to be compatible with the old stack\n> > protector layout.\n> >\n>\n> Hi Brian,\n>\n> I'd be more than happy to compare notes on that - I wasn't aware of\n> your intentions here, or I would have reached out before sending this\n> RFC.\n>\n> There are two things that you would need to address for Clang support\n> to work correctly:\n> - the workaround I cc'ed you on the other day [0],\n> - a workaround for the module loader so it tolerates the GOTPCRELX\n> relocations that Clang emits [1]\n>\n>\n>\n> [0] https://lore.kernel.org/all/20241002092534.3163838-2-ardb+git@google.=\ncom/\n> [1] https://git.kernel.org/pub/scm/linux/kernel/git/ardb/linux.git/commit=\n/?id=3Da18121aabbdd\n\nThe first patch should be applied independently as a bug fix, since it\nalready affects the 32-bit build with clang.\n\nI don't have an environment with an older clang compiler to test the\nsecond patch, but I'll assume it will be necessary.  I did run into an\nissue with the GOTPCRELX relocations before [1], but I thought it was\njust an objtool issue and didn't do more testing to know if modules\nwere broken or not.\n\nBrian Gerst\n\n[1] https://lore.kernel.org/all/20231026160100.195099-6-brgerst@gmail.com/\n",
          "year": "2024",
          "month": "10"
        }
      ],
      "primary_category": "kernel_integration"
    },
    {
      "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
      "normalized_subject": "x86/kernel: Switch to PIE linking for the core kernel",
      "message_count": 24,
      "participants": [
        "Vegard Nossum",
        "Uros Bizjak",
        "Ard Biesheuvel"
      ],
      "categories": [
        "kernel_integration",
        "rfc_proposals",
        "sparse_internals"
      ],
      "first_date": "2024-09-25T19:59:32+00:00",
      "last_date": "2024-09-26T13:38:27+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/09/172729437230807.mbox",
          "message_id": "<CAMj1kXFJHGuxvEgZik_YnrUjoQZCDFaMsTd6BZU=dFe1UcUUNQ () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 19:59:32+00:00",
          "date_str": "Wed, 25 Sep 2024 19:59:32 +0000",
          "body": "On Wed, 25 Sept 2024 at 21:39, Uros Bizjak <ubizjak@gmail.com> wrote:\n>\n> On Wed, Sep 25, 2024 at 9:14=E2=80=AFPM Ard Biesheuvel <ardb@kernel.org> =\nwrote:\n> >\n> > On Wed, 25 Sept 2024 at 20:54, Uros Bizjak <ubizjak@gmail.com> wrote:\n> > >\n> > > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@goog=\nle.com> wrote:\n> > > >\n> > > > From: Ard Biesheuvel <ardb@kernel.org>\n> > > >\n> > > > Build the kernel as a Position Independent Executable (PIE). This\n> > > > results in more efficient relocation processing for the virtual\n> > > > displacement of the kernel (for KASLR). More importantly, it instru=\ncts\n> > > > the linker to generate what is actually needed (a program that can =\nbe\n> > > > moved around in memory before execution), which is better than havi=\nng to\n> > > > rely on the linker to create a position dependent binary that happe=\nns to\n> > > > tolerate being moved around after poking it in exactly the right ma=\nnner.\n> > > >\n> > > > Note that this means that all codegen should be compatible with PIE=\n,\n> > > > including Rust objects, so this needs to switch to the small code m=\nodel\n> > > > with the PIE relocation model as well.\n> > >\n> > > I think that related to this work is the patch series [1] that\n> > > introduces the changes necessary to build the kernel as Position\n> > > Independent Executable (PIE) on x86_64 [1]. There are some more place=\ns\n> > > that need to be adapted for PIE. The patch series also introduces\n> > > objtool functionality to add validation for x86 PIE.\n> > >\n> > > [1] \"[PATCH RFC 00/43] x86/pie: Make kernel image's virtual address f=\nlexible\"\n> > > https://lore.kernel.org/lkml/cover.1682673542.git.houwenlong.hwl@antg=\nroup.com/\n> > >\n> >\n> > Hi Uros,\n> >\n> > I am aware of that discussion, as I took part in it as well.\n> >\n> > I don't think any of those changes are actually needed now - did you\n> > notice anything in particular that is missing?\n>\n> Some time ago I went through the kernel sources and proposed several\n> patches that changed all trivial occurrences of non-RIP addresses to\n> RIP ones. The work was partially based on the mentioned patch series,\n> and I remember, I left some of them out [e.g. 1], because they\n> required a temporary variable.\n\nI have a similar patch in my series, but the DEBUG_ENTRY code just uses\n\npushf 1f@GOTPCREL(%rip)\n\nso no temporaries are needed.\n\n> Also, there was discussion about ftrace\n> [2], where no solution was found.\n>\n\nWhen linking with -z call-nop=3Dsuffix-nop, the __fentry__ call via the\nGOT will be relaxed by the linker into a 5 byte call followed by a 1\nbyte NOP, so I don't think we need to do anything special here. It\nmight mean we currently lose -mnop-mcount until we find a solution for\nthat in the compiler. In case you remember, I contributed and you\nmerged a GCC patch that makes the __fentry__ emission logic honour\n-fdirect-access-external-data which should help here. This landed in\nGCC 14.\n\n> Looking through your series, I didn't find some of the non-RIP -> RIP\n> changes proposed by the original series (especially the ftrace part),\n> and noticed that there is no objtool validator proposed to ensure that\n> all generated code is indeed PIE compatible.\n>\n\nWhat would be the point of that? The linker will complain and throw an\nerror if the code cannot be converted into a PIE executable, so I\ndon't think we need objtool's help for that.\n\n> Speaking of non-RIP -> RIP changes that require a temporary - would it\n> be beneficial to make a macro that would use the RIP form only when\n> #ifdef CONFIG_X86_PIE? That would avoid code size increase when PIE is\n> not needed.\n>\n\nThis series does not make the PIE support configurable. Do you think\nthe code size increase is a concern if all GOT based symbol references\nare elided, e.g, via -fdirect-access-external-data?\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172729437630817.mbox",
          "message_id": "<CAMj1kXFJHGuxvEgZik_YnrUjoQZCDFaMsTd6BZU=dFe1UcUUNQ () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 19:59:36+00:00",
          "date_str": "Wed, 25 Sep 2024 19:59:36 +0000",
          "body": "On Wed, 25 Sept 2024 at 21:39, Uros Bizjak <ubizjak@gmail.com> wrote:\n>\n> On Wed, Sep 25, 2024 at 9:14=E2=80=AFPM Ard Biesheuvel <ardb@kernel.org> =\nwrote:\n> >\n> > On Wed, 25 Sept 2024 at 20:54, Uros Bizjak <ubizjak@gmail.com> wrote:\n> > >\n> > > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@goog=\nle.com> wrote:\n> > > >\n> > > > From: Ard Biesheuvel <ardb@kernel.org>\n> > > >\n> > > > Build the kernel as a Position Independent Executable (PIE). This\n> > > > results in more efficient relocation processing for the virtual\n> > > > displacement of the kernel (for KASLR). More importantly, it instru=\ncts\n> > > > the linker to generate what is actually needed (a program that can =\nbe\n> > > > moved around in memory before execution), which is better than havi=\nng to\n> > > > rely on the linker to create a position dependent binary that happe=\nns to\n> > > > tolerate being moved around after poking it in exactly the right ma=\nnner.\n> > > >\n> > > > Note that this means that all codegen should be compatible with PIE=\n,\n> > > > including Rust objects, so this needs to switch to the small code m=\nodel\n> > > > with the PIE relocation model as well.\n> > >\n> > > I think that related to this work is the patch series [1] that\n> > > introduces the changes necessary to build the kernel as Position\n> > > Independent Executable (PIE) on x86_64 [1]. There are some more place=\ns\n> > > that need to be adapted for PIE. The patch series also introduces\n> > > objtool functionality to add validation for x86 PIE.\n> > >\n> > > [1] \"[PATCH RFC 00/43] x86/pie: Make kernel image's virtual address f=\nlexible\"\n> > > https://lore.kernel.org/lkml/cover.1682673542.git.houwenlong.hwl@antg=\nroup.com/\n> > >\n> >\n> > Hi Uros,\n> >\n> > I am aware of that discussion, as I took part in it as well.\n> >\n> > I don't think any of those changes are actually needed now - did you\n> > notice anything in particular that is missing?\n>\n> Some time ago I went through the kernel sources and proposed several\n> patches that changed all trivial occurrences of non-RIP addresses to\n> RIP ones. The work was partially based on the mentioned patch series,\n> and I remember, I left some of them out [e.g. 1], because they\n> required a temporary variable.\n\nI have a similar patch in my series, but the DEBUG_ENTRY code just uses\n\npushf 1f@GOTPCREL(%rip)\n\nso no temporaries are needed.\n\n> Also, there was discussion about ftrace\n> [2], where no solution was found.\n>\n\nWhen linking with -z call-nop=3Dsuffix-nop, the __fentry__ call via the\nGOT will be relaxed by the linker into a 5 byte call followed by a 1\nbyte NOP, so I don't think we need to do anything special here. It\nmight mean we currently lose -mnop-mcount until we find a solution for\nthat in the compiler. In case you remember, I contributed and you\nmerged a GCC patch that makes the __fentry__ emission logic honour\n-fdirect-access-external-data which should help here. This landed in\nGCC 14.\n\n> Looking through your series, I didn't find some of the non-RIP -> RIP\n> changes proposed by the original series (especially the ftrace part),\n> and noticed that there is no objtool validator proposed to ensure that\n> all generated code is indeed PIE compatible.\n>\n\nWhat would be the point of that? The linker will complain and throw an\nerror if the code cannot be converted into a PIE executable, so I\ndon't think we need objtool's help for that.\n\n> Speaking of non-RIP -> RIP changes that require a temporary - would it\n> be beneficial to make a macro that would use the RIP form only when\n> #ifdef CONFIG_X86_PIE? That would avoid code size increase when PIE is\n> not needed.\n>\n\nThis series does not make the PIE support configurable. Do you think\nthe code size increase is a concern if all GOT based symbol references\nare elided, e.g, via -fdirect-access-external-data?\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172729564831567.mbox",
          "message_id": "<CAFULd4a3RFZVRs12iX7+K=i1Xj0rZAyD6djrmUpmAuU4VULCrg () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 20:22:19+00:00",
          "date_str": "Wed, 25 Sep 2024 20:22:19 +0000",
          "body": "On Wed, Sep 25, 2024 at 10:01=E2=80=AFPM Ard Biesheuvel <ardb@kernel.org> w=\nrote:\n>\n> On Wed, 25 Sept 2024 at 21:39, Uros Bizjak <ubizjak@gmail.com> wrote:\n> >\n> > On Wed, Sep 25, 2024 at 9:14=E2=80=AFPM Ard Biesheuvel <ardb@kernel.org=\n> wrote:\n> > >\n> > > On Wed, 25 Sept 2024 at 20:54, Uros Bizjak <ubizjak@gmail.com> wrote:\n> > > >\n> > > > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@go=\nogle.com> wrote:\n> > > > >\n> > > > > From: Ard Biesheuvel <ardb@kernel.org>\n> > > > >\n> > > > > Build the kernel as a Position Independent Executable (PIE). This\n> > > > > results in more efficient relocation processing for the virtual\n> > > > > displacement of the kernel (for KASLR). More importantly, it inst=\nructs\n> > > > > the linker to generate what is actually needed (a program that ca=\nn be\n> > > > > moved around in memory before execution), which is better than ha=\nving to\n> > > > > rely on the linker to create a position dependent binary that hap=\npens to\n> > > > > tolerate being moved around after poking it in exactly the right =\nmanner.\n> > > > >\n> > > > > Note that this means that all codegen should be compatible with P=\nIE,\n> > > > > including Rust objects, so this needs to switch to the small code=\n model\n> > > > > with the PIE relocation model as well.\n> > > >\n> > > > I think that related to this work is the patch series [1] that\n> > > > introduces the changes necessary to build the kernel as Position\n> > > > Independent Executable (PIE) on x86_64 [1]. There are some more pla=\nces\n> > > > that need to be adapted for PIE. The patch series also introduces\n> > > > objtool functionality to add validation for x86 PIE.\n> > > >\n> > > > [1] \"[PATCH RFC 00/43] x86/pie: Make kernel image's virtual address=\n flexible\"\n> > > > https://lore.kernel.org/lkml/cover.1682673542.git.houwenlong.hwl@an=\ntgroup.com/\n> > > >\n> > >\n> > > Hi Uros,\n> > >\n> > > I am aware of that discussion, as I took part in it as well.\n> > >\n> > > I don't think any of those changes are actually needed now - did you\n> > > notice anything in particular that is missing?\n> >\n> > Some time ago I went through the kernel sources and proposed several\n> > patches that changed all trivial occurrences of non-RIP addresses to\n> > RIP ones. The work was partially based on the mentioned patch series,\n> > and I remember, I left some of them out [e.g. 1], because they\n> > required a temporary variable.\n>\n> I have a similar patch in my series, but the DEBUG_ENTRY code just uses\n>\n> pushf 1f@GOTPCREL(%rip)\n>\n> so no temporaries are needed.\n>\n> > Also, there was discussion about ftrace\n> > [2], where no solution was found.\n> >\n>\n> When linking with -z call-nop=3Dsuffix-nop, the __fentry__ call via the\n> GOT will be relaxed by the linker into a 5 byte call followed by a 1\n> byte NOP, so I don't think we need to do anything special here. It\n> might mean we currently lose -mnop-mcount until we find a solution for\n> that in the compiler. In case you remember, I contributed and you\n> merged a GCC patch that makes the __fentry__ emission logic honour\n> -fdirect-access-external-data which should help here. This landed in\n> GCC 14.\n>\n> > Looking through your series, I didn't find some of the non-RIP -> RIP\n> > changes proposed by the original series (especially the ftrace part),\n> > and noticed that there is no objtool validator proposed to ensure that\n> > all generated code is indeed PIE compatible.\n> >\n>\n> What would be the point of that? The linker will complain and throw an\n> error if the code cannot be converted into a PIE executable, so I\n> don't think we need objtool's help for that.\n\nIndeed.\n\n> > Speaking of non-RIP -> RIP changes that require a temporary - would it\n> > be beneficial to make a macro that would use the RIP form only when\n> > #ifdef CONFIG_X86_PIE? That would avoid code size increase when PIE is\n> > not needed.\n> >\n>\n> This series does not make the PIE support configurable. Do you think\n> the code size increase is a concern if all GOT based symbol references\n> are elided, e.g, via -fdirect-access-external-data?\n\nI was looking at the code size measurement of the original patch\nseries (perhaps these are not relevant with your series) and I think\n2.2% - 2.4% code size increase can be problematic. Can you perhaps\nprovide new code size increase measurements with your patches applied?\n\nThanks and BR,\nUros.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172729565731570.mbox",
          "message_id": "<CAFULd4a3RFZVRs12iX7+K=i1Xj0rZAyD6djrmUpmAuU4VULCrg () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 20:22:19+00:00",
          "date_str": "Wed, 25 Sep 2024 20:22:19 +0000",
          "body": "On Wed, Sep 25, 2024 at 10:01=E2=80=AFPM Ard Biesheuvel <ardb@kernel.org> w=\nrote:\n>\n> On Wed, 25 Sept 2024 at 21:39, Uros Bizjak <ubizjak@gmail.com> wrote:\n> >\n> > On Wed, Sep 25, 2024 at 9:14=E2=80=AFPM Ard Biesheuvel <ardb@kernel.org=\n> wrote:\n> > >\n> > > On Wed, 25 Sept 2024 at 20:54, Uros Bizjak <ubizjak@gmail.com> wrote:\n> > > >\n> > > > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@go=\nogle.com> wrote:\n> > > > >\n> > > > > From: Ard Biesheuvel <ardb@kernel.org>\n> > > > >\n> > > > > Build the kernel as a Position Independent Executable (PIE). This\n> > > > > results in more efficient relocation processing for the virtual\n> > > > > displacement of the kernel (for KASLR). More importantly, it inst=\nructs\n> > > > > the linker to generate what is actually needed (a program that ca=\nn be\n> > > > > moved around in memory before execution), which is better than ha=\nving to\n> > > > > rely on the linker to create a position dependent binary that hap=\npens to\n> > > > > tolerate being moved around after poking it in exactly the right =\nmanner.\n> > > > >\n> > > > > Note that this means that all codegen should be compatible with P=\nIE,\n> > > > > including Rust objects, so this needs to switch to the small code=\n model\n> > > > > with the PIE relocation model as well.\n> > > >\n> > > > I think that related to this work is the patch series [1] that\n> > > > introduces the changes necessary to build the kernel as Position\n> > > > Independent Executable (PIE) on x86_64 [1]. There are some more pla=\nces\n> > > > that need to be adapted for PIE. The patch series also introduces\n> > > > objtool functionality to add validation for x86 PIE.\n> > > >\n> > > > [1] \"[PATCH RFC 00/43] x86/pie: Make kernel image's virtual address=\n flexible\"\n> > > > https://lore.kernel.org/lkml/cover.1682673542.git.houwenlong.hwl@an=\ntgroup.com/\n> > > >\n> > >\n> > > Hi Uros,\n> > >\n> > > I am aware of that discussion, as I took part in it as well.\n> > >\n> > > I don't think any of those changes are actually needed now - did you\n> > > notice anything in particular that is missing?\n> >\n> > Some time ago I went through the kernel sources and proposed several\n> > patches that changed all trivial occurrences of non-RIP addresses to\n> > RIP ones. The work was partially based on the mentioned patch series,\n> > and I remember, I left some of them out [e.g. 1], because they\n> > required a temporary variable.\n>\n> I have a similar patch in my series, but the DEBUG_ENTRY code just uses\n>\n> pushf 1f@GOTPCREL(%rip)\n>\n> so no temporaries are needed.\n>\n> > Also, there was discussion about ftrace\n> > [2], where no solution was found.\n> >\n>\n> When linking with -z call-nop=3Dsuffix-nop, the __fentry__ call via the\n> GOT will be relaxed by the linker into a 5 byte call followed by a 1\n> byte NOP, so I don't think we need to do anything special here. It\n> might mean we currently lose -mnop-mcount until we find a solution for\n> that in the compiler. In case you remember, I contributed and you\n> merged a GCC patch that makes the __fentry__ emission logic honour\n> -fdirect-access-external-data which should help here. This landed in\n> GCC 14.\n>\n> > Looking through your series, I didn't find some of the non-RIP -> RIP\n> > changes proposed by the original series (especially the ftrace part),\n> > and noticed that there is no objtool validator proposed to ensure that\n> > all generated code is indeed PIE compatible.\n> >\n>\n> What would be the point of that? The linker will complain and throw an\n> error if the code cannot be converted into a PIE executable, so I\n> don't think we need objtool's help for that.\n\nIndeed.\n\n> > Speaking of non-RIP -> RIP changes that require a temporary - would it\n> > be beneficial to make a macro that would use the RIP form only when\n> > #ifdef CONFIG_X86_PIE? That would avoid code size increase when PIE is\n> > not needed.\n> >\n>\n> This series does not make the PIE support configurable. Do you think\n> the code size increase is a concern if all GOT based symbol references\n> are elided, e.g, via -fdirect-access-external-data?\n\nI was looking at the code size measurement of the original patch\nseries (perhaps these are not relevant with your series) and I think\n2.2% - 2.4% code size increase can be problematic. Can you perhaps\nprovide new code size increase measurements with your patches applied?\n\nThanks and BR,\nUros.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172729564731565.mbox",
          "message_id": "<CAFULd4a3RFZVRs12iX7+K=i1Xj0rZAyD6djrmUpmAuU4VULCrg () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 20:22:19+00:00",
          "date_str": "Wed, 25 Sep 2024 20:22:19 +0000",
          "body": "On Wed, Sep 25, 2024 at 10:01=E2=80=AFPM Ard Biesheuvel <ardb@kernel.org> w=\nrote:\n>\n> On Wed, 25 Sept 2024 at 21:39, Uros Bizjak <ubizjak@gmail.com> wrote:\n> >\n> > On Wed, Sep 25, 2024 at 9:14=E2=80=AFPM Ard Biesheuvel <ardb@kernel.org=\n> wrote:\n> > >\n> > > On Wed, 25 Sept 2024 at 20:54, Uros Bizjak <ubizjak@gmail.com> wrote:\n> > > >\n> > > > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@go=\nogle.com> wrote:\n> > > > >\n> > > > > From: Ard Biesheuvel <ardb@kernel.org>\n> > > > >\n> > > > > Build the kernel as a Position Independent Executable (PIE). This\n> > > > > results in more efficient relocation processing for the virtual\n> > > > > displacement of the kernel (for KASLR). More importantly, it inst=\nructs\n> > > > > the linker to generate what is actually needed (a program that ca=\nn be\n> > > > > moved around in memory before execution), which is better than ha=\nving to\n> > > > > rely on the linker to create a position dependent binary that hap=\npens to\n> > > > > tolerate being moved around after poking it in exactly the right =\nmanner.\n> > > > >\n> > > > > Note that this means that all codegen should be compatible with P=\nIE,\n> > > > > including Rust objects, so this needs to switch to the small code=\n model\n> > > > > with the PIE relocation model as well.\n> > > >\n> > > > I think that related to this work is the patch series [1] that\n> > > > introduces the changes necessary to build the kernel as Position\n> > > > Independent Executable (PIE) on x86_64 [1]. There are some more pla=\nces\n> > > > that need to be adapted for PIE. The patch series also introduces\n> > > > objtool functionality to add validation for x86 PIE.\n> > > >\n> > > > [1] \"[PATCH RFC 00/43] x86/pie: Make kernel image's virtual address=\n flexible\"\n> > > > https://lore.kernel.org/lkml/cover.1682673542.git.houwenlong.hwl@an=\ntgroup.com/\n> > > >\n> > >\n> > > Hi Uros,\n> > >\n> > > I am aware of that discussion, as I took part in it as well.\n> > >\n> > > I don't think any of those changes are actually needed now - did you\n> > > notice anything in particular that is missing?\n> >\n> > Some time ago I went through the kernel sources and proposed several\n> > patches that changed all trivial occurrences of non-RIP addresses to\n> > RIP ones. The work was partially based on the mentioned patch series,\n> > and I remember, I left some of them out [e.g. 1], because they\n> > required a temporary variable.\n>\n> I have a similar patch in my series, but the DEBUG_ENTRY code just uses\n>\n> pushf 1f@GOTPCREL(%rip)\n>\n> so no temporaries are needed.\n>\n> > Also, there was discussion about ftrace\n> > [2], where no solution was found.\n> >\n>\n> When linking with -z call-nop=3Dsuffix-nop, the __fentry__ call via the\n> GOT will be relaxed by the linker into a 5 byte call followed by a 1\n> byte NOP, so I don't think we need to do anything special here. It\n> might mean we currently lose -mnop-mcount until we find a solution for\n> that in the compiler. In case you remember, I contributed and you\n> merged a GCC patch that makes the __fentry__ emission logic honour\n> -fdirect-access-external-data which should help here. This landed in\n> GCC 14.\n>\n> > Looking through your series, I didn't find some of the non-RIP -> RIP\n> > changes proposed by the original series (especially the ftrace part),\n> > and noticed that there is no objtool validator proposed to ensure that\n> > all generated code is indeed PIE compatible.\n> >\n>\n> What would be the point of that? The linker will complain and throw an\n> error if the code cannot be converted into a PIE executable, so I\n> don't think we need objtool's help for that.\n\nIndeed.\n\n> > Speaking of non-RIP -> RIP changes that require a temporary - would it\n> > be beneficial to make a macro that would use the RIP form only when\n> > #ifdef CONFIG_X86_PIE? That would avoid code size increase when PIE is\n> > not needed.\n> >\n>\n> This series does not make the PIE support configurable. Do you think\n> the code size increase is a concern if all GOT based symbol references\n> are elided, e.g, via -fdirect-access-external-data?\n\nI was looking at the code size measurement of the original patch\nseries (perhaps these are not relevant with your series) and I think\n2.2% - 2.4% code size increase can be problematic. Can you perhaps\nprovide new code size increase measurements with your patches applied?\n\nThanks and BR,\nUros.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172729564531554.mbox",
          "message_id": "<CAFULd4a3RFZVRs12iX7+K=i1Xj0rZAyD6djrmUpmAuU4VULCrg () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 20:22:19+00:00",
          "date_str": "Wed, 25 Sep 2024 20:22:19 +0000",
          "body": "On Wed, Sep 25, 2024 at 10:01=E2=80=AFPM Ard Biesheuvel <ardb@kernel.org> w=\nrote:\n>\n> On Wed, 25 Sept 2024 at 21:39, Uros Bizjak <ubizjak@gmail.com> wrote:\n> >\n> > On Wed, Sep 25, 2024 at 9:14=E2=80=AFPM Ard Biesheuvel <ardb@kernel.org=\n> wrote:\n> > >\n> > > On Wed, 25 Sept 2024 at 20:54, Uros Bizjak <ubizjak@gmail.com> wrote:\n> > > >\n> > > > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@go=\nogle.com> wrote:\n> > > > >\n> > > > > From: Ard Biesheuvel <ardb@kernel.org>\n> > > > >\n> > > > > Build the kernel as a Position Independent Executable (PIE). This\n> > > > > results in more efficient relocation processing for the virtual\n> > > > > displacement of the kernel (for KASLR). More importantly, it inst=\nructs\n> > > > > the linker to generate what is actually needed (a program that ca=\nn be\n> > > > > moved around in memory before execution), which is better than ha=\nving to\n> > > > > rely on the linker to create a position dependent binary that hap=\npens to\n> > > > > tolerate being moved around after poking it in exactly the right =\nmanner.\n> > > > >\n> > > > > Note that this means that all codegen should be compatible with P=\nIE,\n> > > > > including Rust objects, so this needs to switch to the small code=\n model\n> > > > > with the PIE relocation model as well.\n> > > >\n> > > > I think that related to this work is the patch series [1] that\n> > > > introduces the changes necessary to build the kernel as Position\n> > > > Independent Executable (PIE) on x86_64 [1]. There are some more pla=\nces\n> > > > that need to be adapted for PIE. The patch series also introduces\n> > > > objtool functionality to add validation for x86 PIE.\n> > > >\n> > > > [1] \"[PATCH RFC 00/43] x86/pie: Make kernel image's virtual address=\n flexible\"\n> > > > https://lore.kernel.org/lkml/cover.1682673542.git.houwenlong.hwl@an=\ntgroup.com/\n> > > >\n> > >\n> > > Hi Uros,\n> > >\n> > > I am aware of that discussion, as I took part in it as well.\n> > >\n> > > I don't think any of those changes are actually needed now - did you\n> > > notice anything in particular that is missing?\n> >\n> > Some time ago I went through the kernel sources and proposed several\n> > patches that changed all trivial occurrences of non-RIP addresses to\n> > RIP ones. The work was partially based on the mentioned patch series,\n> > and I remember, I left some of them out [e.g. 1], because they\n> > required a temporary variable.\n>\n> I have a similar patch in my series, but the DEBUG_ENTRY code just uses\n>\n> pushf 1f@GOTPCREL(%rip)\n>\n> so no temporaries are needed.\n>\n> > Also, there was discussion about ftrace\n> > [2], where no solution was found.\n> >\n>\n> When linking with -z call-nop=3Dsuffix-nop, the __fentry__ call via the\n> GOT will be relaxed by the linker into a 5 byte call followed by a 1\n> byte NOP, so I don't think we need to do anything special here. It\n> might mean we currently lose -mnop-mcount until we find a solution for\n> that in the compiler. In case you remember, I contributed and you\n> merged a GCC patch that makes the __fentry__ emission logic honour\n> -fdirect-access-external-data which should help here. This landed in\n> GCC 14.\n>\n> > Looking through your series, I didn't find some of the non-RIP -> RIP\n> > changes proposed by the original series (especially the ftrace part),\n> > and noticed that there is no objtool validator proposed to ensure that\n> > all generated code is indeed PIE compatible.\n> >\n>\n> What would be the point of that? The linker will complain and throw an\n> error if the code cannot be converted into a PIE executable, so I\n> don't think we need objtool's help for that.\n\nIndeed.\n\n> > Speaking of non-RIP -> RIP changes that require a temporary - would it\n> > be beneficial to make a macro that would use the RIP form only when\n> > #ifdef CONFIG_X86_PIE? That would avoid code size increase when PIE is\n> > not needed.\n> >\n>\n> This series does not make the PIE support configurable. Do you think\n> the code size increase is a concern if all GOT based symbol references\n> are elided, e.g, via -fdirect-access-external-data?\n\nI was looking at the code size measurement of the original patch\nseries (perhaps these are not relevant with your series) and I think\n2.2% - 2.4% code size increase can be problematic. Can you perhaps\nprovide new code size increase measurements with your patches applied?\n\nThanks and BR,\nUros.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172729564531555.mbox",
          "message_id": "<CAFULd4a3RFZVRs12iX7+K=i1Xj0rZAyD6djrmUpmAuU4VULCrg () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 20:22:19+00:00",
          "date_str": "Wed, 25 Sep 2024 20:22:19 +0000",
          "body": "On Wed, Sep 25, 2024 at 10:01=E2=80=AFPM Ard Biesheuvel <ardb@kernel.org> w=\nrote:\n>\n> On Wed, 25 Sept 2024 at 21:39, Uros Bizjak <ubizjak@gmail.com> wrote:\n> >\n> > On Wed, Sep 25, 2024 at 9:14=E2=80=AFPM Ard Biesheuvel <ardb@kernel.org=\n> wrote:\n> > >\n> > > On Wed, 25 Sept 2024 at 20:54, Uros Bizjak <ubizjak@gmail.com> wrote:\n> > > >\n> > > > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@go=\nogle.com> wrote:\n> > > > >\n> > > > > From: Ard Biesheuvel <ardb@kernel.org>\n> > > > >\n> > > > > Build the kernel as a Position Independent Executable (PIE). This\n> > > > > results in more efficient relocation processing for the virtual\n> > > > > displacement of the kernel (for KASLR). More importantly, it inst=\nructs\n> > > > > the linker to generate what is actually needed (a program that ca=\nn be\n> > > > > moved around in memory before execution), which is better than ha=\nving to\n> > > > > rely on the linker to create a position dependent binary that hap=\npens to\n> > > > > tolerate being moved around after poking it in exactly the right =\nmanner.\n> > > > >\n> > > > > Note that this means that all codegen should be compatible with P=\nIE,\n> > > > > including Rust objects, so this needs to switch to the small code=\n model\n> > > > > with the PIE relocation model as well.\n> > > >\n> > > > I think that related to this work is the patch series [1] that\n> > > > introduces the changes necessary to build the kernel as Position\n> > > > Independent Executable (PIE) on x86_64 [1]. There are some more pla=\nces\n> > > > that need to be adapted for PIE. The patch series also introduces\n> > > > objtool functionality to add validation for x86 PIE.\n> > > >\n> > > > [1] \"[PATCH RFC 00/43] x86/pie: Make kernel image's virtual address=\n flexible\"\n> > > > https://lore.kernel.org/lkml/cover.1682673542.git.houwenlong.hwl@an=\ntgroup.com/\n> > > >\n> > >\n> > > Hi Uros,\n> > >\n> > > I am aware of that discussion, as I took part in it as well.\n> > >\n> > > I don't think any of those changes are actually needed now - did you\n> > > notice anything in particular that is missing?\n> >\n> > Some time ago I went through the kernel sources and proposed several\n> > patches that changed all trivial occurrences of non-RIP addresses to\n> > RIP ones. The work was partially based on the mentioned patch series,\n> > and I remember, I left some of them out [e.g. 1], because they\n> > required a temporary variable.\n>\n> I have a similar patch in my series, but the DEBUG_ENTRY code just uses\n>\n> pushf 1f@GOTPCREL(%rip)\n>\n> so no temporaries are needed.\n>\n> > Also, there was discussion about ftrace\n> > [2], where no solution was found.\n> >\n>\n> When linking with -z call-nop=3Dsuffix-nop, the __fentry__ call via the\n> GOT will be relaxed by the linker into a 5 byte call followed by a 1\n> byte NOP, so I don't think we need to do anything special here. It\n> might mean we currently lose -mnop-mcount until we find a solution for\n> that in the compiler. In case you remember, I contributed and you\n> merged a GCC patch that makes the __fentry__ emission logic honour\n> -fdirect-access-external-data which should help here. This landed in\n> GCC 14.\n>\n> > Looking through your series, I didn't find some of the non-RIP -> RIP\n> > changes proposed by the original series (especially the ftrace part),\n> > and noticed that there is no objtool validator proposed to ensure that\n> > all generated code is indeed PIE compatible.\n> >\n>\n> What would be the point of that? The linker will complain and throw an\n> error if the code cannot be converted into a PIE executable, so I\n> don't think we need objtool's help for that.\n\nIndeed.\n\n> > Speaking of non-RIP -> RIP changes that require a temporary - would it\n> > be beneficial to make a macro that would use the RIP form only when\n> > #ifdef CONFIG_X86_PIE? That would avoid code size increase when PIE is\n> > not needed.\n> >\n>\n> This series does not make the PIE support configurable. Do you think\n> the code size increase is a concern if all GOT based symbol references\n> are elided, e.g, via -fdirect-access-external-data?\n\nI was looking at the code size measurement of the original patch\nseries (perhaps these are not relevant with your series) and I think\n2.2% - 2.4% code size increase can be problematic. Can you perhaps\nprovide new code size increase measurements with your patches applied?\n\nThanks and BR,\nUros.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172729564231543.mbox",
          "message_id": "<CAFULd4a3RFZVRs12iX7+K=i1Xj0rZAyD6djrmUpmAuU4VULCrg () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 20:22:19+00:00",
          "date_str": "Wed, 25 Sep 2024 20:22:19 +0000",
          "body": "On Wed, Sep 25, 2024 at 10:01=E2=80=AFPM Ard Biesheuvel <ardb@kernel.org> w=\nrote:\n>\n> On Wed, 25 Sept 2024 at 21:39, Uros Bizjak <ubizjak@gmail.com> wrote:\n> >\n> > On Wed, Sep 25, 2024 at 9:14=E2=80=AFPM Ard Biesheuvel <ardb@kernel.org=\n> wrote:\n> > >\n> > > On Wed, 25 Sept 2024 at 20:54, Uros Bizjak <ubizjak@gmail.com> wrote:\n> > > >\n> > > > On Wed, Sep 25, 2024 at 5:02=E2=80=AFPM Ard Biesheuvel <ardb+git@go=\nogle.com> wrote:\n> > > > >\n> > > > > From: Ard Biesheuvel <ardb@kernel.org>\n> > > > >\n> > > > > Build the kernel as a Position Independent Executable (PIE). This\n> > > > > results in more efficient relocation processing for the virtual\n> > > > > displacement of the kernel (for KASLR). More importantly, it inst=\nructs\n> > > > > the linker to generate what is actually needed (a program that ca=\nn be\n> > > > > moved around in memory before execution), which is better than ha=\nving to\n> > > > > rely on the linker to create a position dependent binary that hap=\npens to\n> > > > > tolerate being moved around after poking it in exactly the right =\nmanner.\n> > > > >\n> > > > > Note that this means that all codegen should be compatible with P=\nIE,\n> > > > > including Rust objects, so this needs to switch to the small code=\n model\n> > > > > with the PIE relocation model as well.\n> > > >\n> > > > I think that related to this work is the patch series [1] that\n> > > > introduces the changes necessary to build the kernel as Position\n> > > > Independent Executable (PIE) on x86_64 [1]. There are some more pla=\nces\n> > > > that need to be adapted for PIE. The patch series also introduces\n> > > > objtool functionality to add validation for x86 PIE.\n> > > >\n> > > > [1] \"[PATCH RFC 00/43] x86/pie: Make kernel image's virtual address=\n flexible\"\n> > > > https://lore.kernel.org/lkml/cover.1682673542.git.houwenlong.hwl@an=\ntgroup.com/\n> > > >\n> > >\n> > > Hi Uros,\n> > >\n> > > I am aware of that discussion, as I took part in it as well.\n> > >\n> > > I don't think any of those changes are actually needed now - did you\n> > > notice anything in particular that is missing?\n> >\n> > Some time ago I went through the kernel sources and proposed several\n> > patches that changed all trivial occurrences of non-RIP addresses to\n> > RIP ones. The work was partially based on the mentioned patch series,\n> > and I remember, I left some of them out [e.g. 1], because they\n> > required a temporary variable.\n>\n> I have a similar patch in my series, but the DEBUG_ENTRY code just uses\n>\n> pushf 1f@GOTPCREL(%rip)\n>\n> so no temporaries are needed.\n>\n> > Also, there was discussion about ftrace\n> > [2], where no solution was found.\n> >\n>\n> When linking with -z call-nop=3Dsuffix-nop, the __fentry__ call via the\n> GOT will be relaxed by the linker into a 5 byte call followed by a 1\n> byte NOP, so I don't think we need to do anything special here. It\n> might mean we currently lose -mnop-mcount until we find a solution for\n> that in the compiler. In case you remember, I contributed and you\n> merged a GCC patch that makes the __fentry__ emission logic honour\n> -fdirect-access-external-data which should help here. This landed in\n> GCC 14.\n>\n> > Looking through your series, I didn't find some of the non-RIP -> RIP\n> > changes proposed by the original series (especially the ftrace part),\n> > and noticed that there is no objtool validator proposed to ensure that\n> > all generated code is indeed PIE compatible.\n> >\n>\n> What would be the point of that? The linker will complain and throw an\n> error if the code cannot be converted into a PIE executable, so I\n> don't think we need objtool's help for that.\n\nIndeed.\n\n> > Speaking of non-RIP -> RIP changes that require a temporary - would it\n> > be beneficial to make a macro that would use the RIP form only when\n> > #ifdef CONFIG_X86_PIE? That would avoid code size increase when PIE is\n> > not needed.\n> >\n>\n> This series does not make the PIE support configurable. Do you think\n> the code size increase is a concern if all GOT based symbol references\n> are elided, e.g, via -fdirect-access-external-data?\n\nI was looking at the code size measurement of the original patch\nseries (perhaps these are not relevant with your series) and I think\n2.2% - 2.4% code size increase can be problematic. Can you perhaps\nprovide new code size increase measurements with your patches applied?\n\nThanks and BR,\nUros.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172729582631676.mbox",
          "message_id": "<4eca972d-a462-4cc5-9238-5d63485e1af4 () oracle ! com>",
          "author_name": "Vegard Nossum",
          "author_email": "vegard.nossum () oracle ! com",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 20:24:22+00:00",
          "date_str": "Wed, 25 Sep 2024 20:24:22 +0000",
          "body": "\nOn 25/09/2024 17:01, Ard Biesheuvel wrote:\n> From: Ard Biesheuvel <ardb@kernel.org>\n> \n> Build the kernel as a Position Independent Executable (PIE). This\n> results in more efficient relocation processing for the virtual\n> displacement of the kernel (for KASLR). More importantly, it instructs\n> the linker to generate what is actually needed (a program that can be\n> moved around in memory before execution), which is better than having to\n> rely on the linker to create a position dependent binary that happens to\n> tolerate being moved around after poking it in exactly the right manner.\n> \n> Note that this means that all codegen should be compatible with PIE,\n> including Rust objects, so this needs to switch to the small code model\n> with the PIE relocation model as well.\n> \n> Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> ---\n>   arch/x86/Kconfig                        |  2 +-\n>   arch/x86/Makefile                       | 11 +++++++----\n>   arch/x86/boot/compressed/misc.c         |  2 ++\n>   arch/x86/kernel/vmlinux.lds.S           |  5 +++++\n>   drivers/firmware/efi/libstub/x86-stub.c |  2 ++\n>   5 files changed, 17 insertions(+), 5 deletions(-)\n> \n> diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig\n> index 54cb1f14218b..dbb4d284b0e1 100644\n> --- a/arch/x86/Kconfig\n> +++ b/arch/x86/Kconfig\n> @@ -2187,7 +2187,7 @@ config RANDOMIZE_BASE\n>   # Relocation on x86 needs some additional build support\n>   config X86_NEED_RELOCS\n>   \tdef_bool y\n> -\tdepends on RANDOMIZE_BASE || (X86_32 && RELOCATABLE)\n> +\tdepends on X86_32 && RELOCATABLE\n>   \n>   config PHYSICAL_ALIGN\n>   \thex \"Alignment value to which kernel should be aligned\"\n> diff --git a/arch/x86/Makefile b/arch/x86/Makefile\n> index 83d20f402535..c1dcff444bc8 100644\n> --- a/arch/x86/Makefile\n> +++ b/arch/x86/Makefile\n> @@ -206,9 +206,8 @@ else\n>                   PIE_CFLAGS-$(CONFIG_SMP) += -mstack-protector-guard-reg=gs\n>           endif\n>   \n> -        # Don't emit relaxable GOTPCREL relocations\n> -        KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n> -        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no $(PIE_CFLAGS-y)\n> +        KBUILD_CFLAGS_KERNEL\t+= $(PIE_CFLAGS-y)\n> +        KBUILD_RUSTFLAGS_KERNEL\t+= -Ccode-model=small -Crelocation-model=pie\n>   endif\n>   \n>   #\n> @@ -264,12 +263,16 @@ else\n>   LDFLAGS_vmlinux :=\n>   endif\n>   \n> +ifdef CONFIG_X86_64\n> +ldflags-pie-$(CONFIG_LD_IS_LLD)\t:= --apply-dynamic-relocs\n> +ldflags-pie-$(CONFIG_LD_IS_BFD)\t:= -z call-nop=suffix-nop\n> +LDFLAGS_vmlinux\t\t\t+= --pie -z text $(ldflags-pie-y)\n> +\n>   #\n>   # The 64-bit kernel must be aligned to 2MB.  Pass -z max-page-size=0x200000 to\n>   # the linker to force 2MB page size regardless of the default page size used\n>   # by the linker.\n>   #\n> -ifdef CONFIG_X86_64\n>   LDFLAGS_vmlinux += -z max-page-size=0x200000\n>   endif\n>   \n> diff --git a/arch/x86/boot/compressed/misc.c b/arch/x86/boot/compressed/misc.c\n> index 89f01375cdb7..79e3ffe16f61 100644\n> --- a/arch/x86/boot/compressed/misc.c\n> +++ b/arch/x86/boot/compressed/misc.c\n> @@ -495,6 +495,8 @@ asmlinkage __visible void *extract_kernel(void *rmode, unsigned char *output)\n>   \t\terror(\"Destination virtual address changed when not relocatable\");\n>   #endif\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tdebug_putstr(\"\\nDecompressing Linux... \");\n>   \n>   \tif (init_unaccepted_memory()) {\n> diff --git a/arch/x86/kernel/vmlinux.lds.S b/arch/x86/kernel/vmlinux.lds.S\n> index f7e832c2ac61..d172e6e8eaaf 100644\n> --- a/arch/x86/kernel/vmlinux.lds.S\n> +++ b/arch/x86/kernel/vmlinux.lds.S\n> @@ -459,6 +459,11 @@ xen_elfnote_phys32_entry_offset =\n>   \n>   \tDISCARDS\n>   \n> +\t/DISCARD/ : {\n> +\t\t*(.dynsym .gnu.hash .hash .dynamic .dynstr)\n> +\t\t*(.interp .dynbss .eh_frame .sframe)\n> +\t}\n> +\n>   \t/*\n>   \t * Make sure that the .got.plt is either completely empty or it\n>   \t * contains only the lazy dispatch entries.\n> diff --git a/drivers/firmware/efi/libstub/x86-stub.c b/drivers/firmware/efi/libstub/x86-stub.c\n> index f8e465da344d..5c03954924fe 100644\n> --- a/drivers/firmware/efi/libstub/x86-stub.c\n> +++ b/drivers/firmware/efi/libstub/x86-stub.c\n> @@ -912,6 +912,8 @@ static efi_status_t efi_decompress_kernel(unsigned long *kernel_entry)\n>   \tif (status != EFI_SUCCESS)\n>   \t\treturn status;\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tentry = decompress_kernel((void *)addr, virt_addr, error);\n>   \tif (entry == ULONG_MAX) {\n>   \t\tefi_free(alloc_size, addr);\n\nThis patch causes a build failure here (on 64-bit):\n\n   LD      .tmp_vmlinux2\n   NM      .tmp_vmlinux2.syms\n   KSYMS   .tmp_vmlinux2.kallsyms.S\n   AS      .tmp_vmlinux2.kallsyms.o\n   LD      vmlinux\n   BTFIDS  vmlinux\nWARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\nFAILED elf_update(WRITE): invalid section entry size\nmake[5]: *** [scripts/Makefile.vmlinux:34: vmlinux] Error 255\nmake[5]: *** Deleting file 'vmlinux'\nmake[4]: *** [Makefile:1153: vmlinux] Error 2\nmake[3]: *** [debian/rules:74: buil",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172729584331704.mbox",
          "message_id": "<4eca972d-a462-4cc5-9238-5d63485e1af4 () oracle ! com>",
          "author_name": "Vegard Nossum",
          "author_email": "vegard.nossum () oracle ! com",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 20:24:22+00:00",
          "date_str": "Wed, 25 Sep 2024 20:24:22 +0000",
          "body": "\nOn 25/09/2024 17:01, Ard Biesheuvel wrote:\n> From: Ard Biesheuvel <ardb@kernel.org>\n> \n> Build the kernel as a Position Independent Executable (PIE). This\n> results in more efficient relocation processing for the virtual\n> displacement of the kernel (for KASLR). More importantly, it instructs\n> the linker to generate what is actually needed (a program that can be\n> moved around in memory before execution), which is better than having to\n> rely on the linker to create a position dependent binary that happens to\n> tolerate being moved around after poking it in exactly the right manner.\n> \n> Note that this means that all codegen should be compatible with PIE,\n> including Rust objects, so this needs to switch to the small code model\n> with the PIE relocation model as well.\n> \n> Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> ---\n>   arch/x86/Kconfig                        |  2 +-\n>   arch/x86/Makefile                       | 11 +++++++----\n>   arch/x86/boot/compressed/misc.c         |  2 ++\n>   arch/x86/kernel/vmlinux.lds.S           |  5 +++++\n>   drivers/firmware/efi/libstub/x86-stub.c |  2 ++\n>   5 files changed, 17 insertions(+), 5 deletions(-)\n> \n> diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig\n> index 54cb1f14218b..dbb4d284b0e1 100644\n> --- a/arch/x86/Kconfig\n> +++ b/arch/x86/Kconfig\n> @@ -2187,7 +2187,7 @@ config RANDOMIZE_BASE\n>   # Relocation on x86 needs some additional build support\n>   config X86_NEED_RELOCS\n>   \tdef_bool y\n> -\tdepends on RANDOMIZE_BASE || (X86_32 && RELOCATABLE)\n> +\tdepends on X86_32 && RELOCATABLE\n>   \n>   config PHYSICAL_ALIGN\n>   \thex \"Alignment value to which kernel should be aligned\"\n> diff --git a/arch/x86/Makefile b/arch/x86/Makefile\n> index 83d20f402535..c1dcff444bc8 100644\n> --- a/arch/x86/Makefile\n> +++ b/arch/x86/Makefile\n> @@ -206,9 +206,8 @@ else\n>                   PIE_CFLAGS-$(CONFIG_SMP) += -mstack-protector-guard-reg=gs\n>           endif\n>   \n> -        # Don't emit relaxable GOTPCREL relocations\n> -        KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n> -        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no $(PIE_CFLAGS-y)\n> +        KBUILD_CFLAGS_KERNEL\t+= $(PIE_CFLAGS-y)\n> +        KBUILD_RUSTFLAGS_KERNEL\t+= -Ccode-model=small -Crelocation-model=pie\n>   endif\n>   \n>   #\n> @@ -264,12 +263,16 @@ else\n>   LDFLAGS_vmlinux :=\n>   endif\n>   \n> +ifdef CONFIG_X86_64\n> +ldflags-pie-$(CONFIG_LD_IS_LLD)\t:= --apply-dynamic-relocs\n> +ldflags-pie-$(CONFIG_LD_IS_BFD)\t:= -z call-nop=suffix-nop\n> +LDFLAGS_vmlinux\t\t\t+= --pie -z text $(ldflags-pie-y)\n> +\n>   #\n>   # The 64-bit kernel must be aligned to 2MB.  Pass -z max-page-size=0x200000 to\n>   # the linker to force 2MB page size regardless of the default page size used\n>   # by the linker.\n>   #\n> -ifdef CONFIG_X86_64\n>   LDFLAGS_vmlinux += -z max-page-size=0x200000\n>   endif\n>   \n> diff --git a/arch/x86/boot/compressed/misc.c b/arch/x86/boot/compressed/misc.c\n> index 89f01375cdb7..79e3ffe16f61 100644\n> --- a/arch/x86/boot/compressed/misc.c\n> +++ b/arch/x86/boot/compressed/misc.c\n> @@ -495,6 +495,8 @@ asmlinkage __visible void *extract_kernel(void *rmode, unsigned char *output)\n>   \t\terror(\"Destination virtual address changed when not relocatable\");\n>   #endif\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tdebug_putstr(\"\\nDecompressing Linux... \");\n>   \n>   \tif (init_unaccepted_memory()) {\n> diff --git a/arch/x86/kernel/vmlinux.lds.S b/arch/x86/kernel/vmlinux.lds.S\n> index f7e832c2ac61..d172e6e8eaaf 100644\n> --- a/arch/x86/kernel/vmlinux.lds.S\n> +++ b/arch/x86/kernel/vmlinux.lds.S\n> @@ -459,6 +459,11 @@ xen_elfnote_phys32_entry_offset =\n>   \n>   \tDISCARDS\n>   \n> +\t/DISCARD/ : {\n> +\t\t*(.dynsym .gnu.hash .hash .dynamic .dynstr)\n> +\t\t*(.interp .dynbss .eh_frame .sframe)\n> +\t}\n> +\n>   \t/*\n>   \t * Make sure that the .got.plt is either completely empty or it\n>   \t * contains only the lazy dispatch entries.\n> diff --git a/drivers/firmware/efi/libstub/x86-stub.c b/drivers/firmware/efi/libstub/x86-stub.c\n> index f8e465da344d..5c03954924fe 100644\n> --- a/drivers/firmware/efi/libstub/x86-stub.c\n> +++ b/drivers/firmware/efi/libstub/x86-stub.c\n> @@ -912,6 +912,8 @@ static efi_status_t efi_decompress_kernel(unsigned long *kernel_entry)\n>   \tif (status != EFI_SUCCESS)\n>   \t\treturn status;\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tentry = decompress_kernel((void *)addr, virt_addr, error);\n>   \tif (entry == ULONG_MAX) {\n>   \t\tefi_free(alloc_size, addr);\n\nThis patch causes a build failure here (on 64-bit):\n\n   LD      .tmp_vmlinux2\n   NM      .tmp_vmlinux2.syms\n   KSYMS   .tmp_vmlinux2.kallsyms.S\n   AS      .tmp_vmlinux2.kallsyms.o\n   LD      vmlinux\n   BTFIDS  vmlinux\nWARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\nFAILED elf_update(WRITE): invalid section entry size\nmake[5]: *** [scripts/Makefile.vmlinux:34: vmlinux] Error 255\nmake[5]: *** Deleting file 'vmlinux'\nmake[4]: *** [Makefile:1153: vmlinux] Error 2\nmake[3]: *** [debian/rules:74: buil",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172729584031697.mbox",
          "message_id": "<4eca972d-a462-4cc5-9238-5d63485e1af4 () oracle ! com>",
          "author_name": "Vegard Nossum",
          "author_email": "vegard.nossum () oracle ! com",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 20:24:22+00:00",
          "date_str": "Wed, 25 Sep 2024 20:24:22 +0000",
          "body": "\nOn 25/09/2024 17:01, Ard Biesheuvel wrote:\n> From: Ard Biesheuvel <ardb@kernel.org>\n> \n> Build the kernel as a Position Independent Executable (PIE). This\n> results in more efficient relocation processing for the virtual\n> displacement of the kernel (for KASLR). More importantly, it instructs\n> the linker to generate what is actually needed (a program that can be\n> moved around in memory before execution), which is better than having to\n> rely on the linker to create a position dependent binary that happens to\n> tolerate being moved around after poking it in exactly the right manner.\n> \n> Note that this means that all codegen should be compatible with PIE,\n> including Rust objects, so this needs to switch to the small code model\n> with the PIE relocation model as well.\n> \n> Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> ---\n>   arch/x86/Kconfig                        |  2 +-\n>   arch/x86/Makefile                       | 11 +++++++----\n>   arch/x86/boot/compressed/misc.c         |  2 ++\n>   arch/x86/kernel/vmlinux.lds.S           |  5 +++++\n>   drivers/firmware/efi/libstub/x86-stub.c |  2 ++\n>   5 files changed, 17 insertions(+), 5 deletions(-)\n> \n> diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig\n> index 54cb1f14218b..dbb4d284b0e1 100644\n> --- a/arch/x86/Kconfig\n> +++ b/arch/x86/Kconfig\n> @@ -2187,7 +2187,7 @@ config RANDOMIZE_BASE\n>   # Relocation on x86 needs some additional build support\n>   config X86_NEED_RELOCS\n>   \tdef_bool y\n> -\tdepends on RANDOMIZE_BASE || (X86_32 && RELOCATABLE)\n> +\tdepends on X86_32 && RELOCATABLE\n>   \n>   config PHYSICAL_ALIGN\n>   \thex \"Alignment value to which kernel should be aligned\"\n> diff --git a/arch/x86/Makefile b/arch/x86/Makefile\n> index 83d20f402535..c1dcff444bc8 100644\n> --- a/arch/x86/Makefile\n> +++ b/arch/x86/Makefile\n> @@ -206,9 +206,8 @@ else\n>                   PIE_CFLAGS-$(CONFIG_SMP) += -mstack-protector-guard-reg=gs\n>           endif\n>   \n> -        # Don't emit relaxable GOTPCREL relocations\n> -        KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n> -        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no $(PIE_CFLAGS-y)\n> +        KBUILD_CFLAGS_KERNEL\t+= $(PIE_CFLAGS-y)\n> +        KBUILD_RUSTFLAGS_KERNEL\t+= -Ccode-model=small -Crelocation-model=pie\n>   endif\n>   \n>   #\n> @@ -264,12 +263,16 @@ else\n>   LDFLAGS_vmlinux :=\n>   endif\n>   \n> +ifdef CONFIG_X86_64\n> +ldflags-pie-$(CONFIG_LD_IS_LLD)\t:= --apply-dynamic-relocs\n> +ldflags-pie-$(CONFIG_LD_IS_BFD)\t:= -z call-nop=suffix-nop\n> +LDFLAGS_vmlinux\t\t\t+= --pie -z text $(ldflags-pie-y)\n> +\n>   #\n>   # The 64-bit kernel must be aligned to 2MB.  Pass -z max-page-size=0x200000 to\n>   # the linker to force 2MB page size regardless of the default page size used\n>   # by the linker.\n>   #\n> -ifdef CONFIG_X86_64\n>   LDFLAGS_vmlinux += -z max-page-size=0x200000\n>   endif\n>   \n> diff --git a/arch/x86/boot/compressed/misc.c b/arch/x86/boot/compressed/misc.c\n> index 89f01375cdb7..79e3ffe16f61 100644\n> --- a/arch/x86/boot/compressed/misc.c\n> +++ b/arch/x86/boot/compressed/misc.c\n> @@ -495,6 +495,8 @@ asmlinkage __visible void *extract_kernel(void *rmode, unsigned char *output)\n>   \t\terror(\"Destination virtual address changed when not relocatable\");\n>   #endif\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tdebug_putstr(\"\\nDecompressing Linux... \");\n>   \n>   \tif (init_unaccepted_memory()) {\n> diff --git a/arch/x86/kernel/vmlinux.lds.S b/arch/x86/kernel/vmlinux.lds.S\n> index f7e832c2ac61..d172e6e8eaaf 100644\n> --- a/arch/x86/kernel/vmlinux.lds.S\n> +++ b/arch/x86/kernel/vmlinux.lds.S\n> @@ -459,6 +459,11 @@ xen_elfnote_phys32_entry_offset =\n>   \n>   \tDISCARDS\n>   \n> +\t/DISCARD/ : {\n> +\t\t*(.dynsym .gnu.hash .hash .dynamic .dynstr)\n> +\t\t*(.interp .dynbss .eh_frame .sframe)\n> +\t}\n> +\n>   \t/*\n>   \t * Make sure that the .got.plt is either completely empty or it\n>   \t * contains only the lazy dispatch entries.\n> diff --git a/drivers/firmware/efi/libstub/x86-stub.c b/drivers/firmware/efi/libstub/x86-stub.c\n> index f8e465da344d..5c03954924fe 100644\n> --- a/drivers/firmware/efi/libstub/x86-stub.c\n> +++ b/drivers/firmware/efi/libstub/x86-stub.c\n> @@ -912,6 +912,8 @@ static efi_status_t efi_decompress_kernel(unsigned long *kernel_entry)\n>   \tif (status != EFI_SUCCESS)\n>   \t\treturn status;\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tentry = decompress_kernel((void *)addr, virt_addr, error);\n>   \tif (entry == ULONG_MAX) {\n>   \t\tefi_free(alloc_size, addr);\n\nThis patch causes a build failure here (on 64-bit):\n\n   LD      .tmp_vmlinux2\n   NM      .tmp_vmlinux2.syms\n   KSYMS   .tmp_vmlinux2.kallsyms.S\n   AS      .tmp_vmlinux2.kallsyms.o\n   LD      vmlinux\n   BTFIDS  vmlinux\nWARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\nFAILED elf_update(WRITE): invalid section entry size\nmake[5]: *** [scripts/Makefile.vmlinux:34: vmlinux] Error 255\nmake[5]: *** Deleting file 'vmlinux'\nmake[4]: *** [Makefile:1153: vmlinux] Error 2\nmake[3]: *** [debian/rules:74: buil",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172729582731684.mbox",
          "message_id": "<4eca972d-a462-4cc5-9238-5d63485e1af4 () oracle ! com>",
          "author_name": "Vegard Nossum",
          "author_email": "vegard.nossum () oracle ! com",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 20:24:22+00:00",
          "date_str": "Wed, 25 Sep 2024 20:24:22 +0000",
          "body": "\nOn 25/09/2024 17:01, Ard Biesheuvel wrote:\n> From: Ard Biesheuvel <ardb@kernel.org>\n> \n> Build the kernel as a Position Independent Executable (PIE). This\n> results in more efficient relocation processing for the virtual\n> displacement of the kernel (for KASLR). More importantly, it instructs\n> the linker to generate what is actually needed (a program that can be\n> moved around in memory before execution), which is better than having to\n> rely on the linker to create a position dependent binary that happens to\n> tolerate being moved around after poking it in exactly the right manner.\n> \n> Note that this means that all codegen should be compatible with PIE,\n> including Rust objects, so this needs to switch to the small code model\n> with the PIE relocation model as well.\n> \n> Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> ---\n>   arch/x86/Kconfig                        |  2 +-\n>   arch/x86/Makefile                       | 11 +++++++----\n>   arch/x86/boot/compressed/misc.c         |  2 ++\n>   arch/x86/kernel/vmlinux.lds.S           |  5 +++++\n>   drivers/firmware/efi/libstub/x86-stub.c |  2 ++\n>   5 files changed, 17 insertions(+), 5 deletions(-)\n> \n> diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig\n> index 54cb1f14218b..dbb4d284b0e1 100644\n> --- a/arch/x86/Kconfig\n> +++ b/arch/x86/Kconfig\n> @@ -2187,7 +2187,7 @@ config RANDOMIZE_BASE\n>   # Relocation on x86 needs some additional build support\n>   config X86_NEED_RELOCS\n>   \tdef_bool y\n> -\tdepends on RANDOMIZE_BASE || (X86_32 && RELOCATABLE)\n> +\tdepends on X86_32 && RELOCATABLE\n>   \n>   config PHYSICAL_ALIGN\n>   \thex \"Alignment value to which kernel should be aligned\"\n> diff --git a/arch/x86/Makefile b/arch/x86/Makefile\n> index 83d20f402535..c1dcff444bc8 100644\n> --- a/arch/x86/Makefile\n> +++ b/arch/x86/Makefile\n> @@ -206,9 +206,8 @@ else\n>                   PIE_CFLAGS-$(CONFIG_SMP) += -mstack-protector-guard-reg=gs\n>           endif\n>   \n> -        # Don't emit relaxable GOTPCREL relocations\n> -        KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n> -        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no $(PIE_CFLAGS-y)\n> +        KBUILD_CFLAGS_KERNEL\t+= $(PIE_CFLAGS-y)\n> +        KBUILD_RUSTFLAGS_KERNEL\t+= -Ccode-model=small -Crelocation-model=pie\n>   endif\n>   \n>   #\n> @@ -264,12 +263,16 @@ else\n>   LDFLAGS_vmlinux :=\n>   endif\n>   \n> +ifdef CONFIG_X86_64\n> +ldflags-pie-$(CONFIG_LD_IS_LLD)\t:= --apply-dynamic-relocs\n> +ldflags-pie-$(CONFIG_LD_IS_BFD)\t:= -z call-nop=suffix-nop\n> +LDFLAGS_vmlinux\t\t\t+= --pie -z text $(ldflags-pie-y)\n> +\n>   #\n>   # The 64-bit kernel must be aligned to 2MB.  Pass -z max-page-size=0x200000 to\n>   # the linker to force 2MB page size regardless of the default page size used\n>   # by the linker.\n>   #\n> -ifdef CONFIG_X86_64\n>   LDFLAGS_vmlinux += -z max-page-size=0x200000\n>   endif\n>   \n> diff --git a/arch/x86/boot/compressed/misc.c b/arch/x86/boot/compressed/misc.c\n> index 89f01375cdb7..79e3ffe16f61 100644\n> --- a/arch/x86/boot/compressed/misc.c\n> +++ b/arch/x86/boot/compressed/misc.c\n> @@ -495,6 +495,8 @@ asmlinkage __visible void *extract_kernel(void *rmode, unsigned char *output)\n>   \t\terror(\"Destination virtual address changed when not relocatable\");\n>   #endif\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tdebug_putstr(\"\\nDecompressing Linux... \");\n>   \n>   \tif (init_unaccepted_memory()) {\n> diff --git a/arch/x86/kernel/vmlinux.lds.S b/arch/x86/kernel/vmlinux.lds.S\n> index f7e832c2ac61..d172e6e8eaaf 100644\n> --- a/arch/x86/kernel/vmlinux.lds.S\n> +++ b/arch/x86/kernel/vmlinux.lds.S\n> @@ -459,6 +459,11 @@ xen_elfnote_phys32_entry_offset =\n>   \n>   \tDISCARDS\n>   \n> +\t/DISCARD/ : {\n> +\t\t*(.dynsym .gnu.hash .hash .dynamic .dynstr)\n> +\t\t*(.interp .dynbss .eh_frame .sframe)\n> +\t}\n> +\n>   \t/*\n>   \t * Make sure that the .got.plt is either completely empty or it\n>   \t * contains only the lazy dispatch entries.\n> diff --git a/drivers/firmware/efi/libstub/x86-stub.c b/drivers/firmware/efi/libstub/x86-stub.c\n> index f8e465da344d..5c03954924fe 100644\n> --- a/drivers/firmware/efi/libstub/x86-stub.c\n> +++ b/drivers/firmware/efi/libstub/x86-stub.c\n> @@ -912,6 +912,8 @@ static efi_status_t efi_decompress_kernel(unsigned long *kernel_entry)\n>   \tif (status != EFI_SUCCESS)\n>   \t\treturn status;\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tentry = decompress_kernel((void *)addr, virt_addr, error);\n>   \tif (entry == ULONG_MAX) {\n>   \t\tefi_free(alloc_size, addr);\n\nThis patch causes a build failure here (on 64-bit):\n\n   LD      .tmp_vmlinux2\n   NM      .tmp_vmlinux2.syms\n   KSYMS   .tmp_vmlinux2.kallsyms.S\n   AS      .tmp_vmlinux2.kallsyms.o\n   LD      vmlinux\n   BTFIDS  vmlinux\nWARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\nFAILED elf_update(WRITE): invalid section entry size\nmake[5]: *** [scripts/Makefile.vmlinux:34: vmlinux] Error 255\nmake[5]: *** Deleting file 'vmlinux'\nmake[4]: *** [Makefile:1153: vmlinux] Error 2\nmake[3]: *** [debian/rules:74: buil",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172729582531672.mbox",
          "message_id": "<4eca972d-a462-4cc5-9238-5d63485e1af4 () oracle ! com>",
          "author_name": "Vegard Nossum",
          "author_email": "vegard.nossum () oracle ! com",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 20:24:22+00:00",
          "date_str": "Wed, 25 Sep 2024 20:24:22 +0000",
          "body": "\nOn 25/09/2024 17:01, Ard Biesheuvel wrote:\n> From: Ard Biesheuvel <ardb@kernel.org>\n> \n> Build the kernel as a Position Independent Executable (PIE). This\n> results in more efficient relocation processing for the virtual\n> displacement of the kernel (for KASLR). More importantly, it instructs\n> the linker to generate what is actually needed (a program that can be\n> moved around in memory before execution), which is better than having to\n> rely on the linker to create a position dependent binary that happens to\n> tolerate being moved around after poking it in exactly the right manner.\n> \n> Note that this means that all codegen should be compatible with PIE,\n> including Rust objects, so this needs to switch to the small code model\n> with the PIE relocation model as well.\n> \n> Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> ---\n>   arch/x86/Kconfig                        |  2 +-\n>   arch/x86/Makefile                       | 11 +++++++----\n>   arch/x86/boot/compressed/misc.c         |  2 ++\n>   arch/x86/kernel/vmlinux.lds.S           |  5 +++++\n>   drivers/firmware/efi/libstub/x86-stub.c |  2 ++\n>   5 files changed, 17 insertions(+), 5 deletions(-)\n> \n> diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig\n> index 54cb1f14218b..dbb4d284b0e1 100644\n> --- a/arch/x86/Kconfig\n> +++ b/arch/x86/Kconfig\n> @@ -2187,7 +2187,7 @@ config RANDOMIZE_BASE\n>   # Relocation on x86 needs some additional build support\n>   config X86_NEED_RELOCS\n>   \tdef_bool y\n> -\tdepends on RANDOMIZE_BASE || (X86_32 && RELOCATABLE)\n> +\tdepends on X86_32 && RELOCATABLE\n>   \n>   config PHYSICAL_ALIGN\n>   \thex \"Alignment value to which kernel should be aligned\"\n> diff --git a/arch/x86/Makefile b/arch/x86/Makefile\n> index 83d20f402535..c1dcff444bc8 100644\n> --- a/arch/x86/Makefile\n> +++ b/arch/x86/Makefile\n> @@ -206,9 +206,8 @@ else\n>                   PIE_CFLAGS-$(CONFIG_SMP) += -mstack-protector-guard-reg=gs\n>           endif\n>   \n> -        # Don't emit relaxable GOTPCREL relocations\n> -        KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n> -        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no $(PIE_CFLAGS-y)\n> +        KBUILD_CFLAGS_KERNEL\t+= $(PIE_CFLAGS-y)\n> +        KBUILD_RUSTFLAGS_KERNEL\t+= -Ccode-model=small -Crelocation-model=pie\n>   endif\n>   \n>   #\n> @@ -264,12 +263,16 @@ else\n>   LDFLAGS_vmlinux :=\n>   endif\n>   \n> +ifdef CONFIG_X86_64\n> +ldflags-pie-$(CONFIG_LD_IS_LLD)\t:= --apply-dynamic-relocs\n> +ldflags-pie-$(CONFIG_LD_IS_BFD)\t:= -z call-nop=suffix-nop\n> +LDFLAGS_vmlinux\t\t\t+= --pie -z text $(ldflags-pie-y)\n> +\n>   #\n>   # The 64-bit kernel must be aligned to 2MB.  Pass -z max-page-size=0x200000 to\n>   # the linker to force 2MB page size regardless of the default page size used\n>   # by the linker.\n>   #\n> -ifdef CONFIG_X86_64\n>   LDFLAGS_vmlinux += -z max-page-size=0x200000\n>   endif\n>   \n> diff --git a/arch/x86/boot/compressed/misc.c b/arch/x86/boot/compressed/misc.c\n> index 89f01375cdb7..79e3ffe16f61 100644\n> --- a/arch/x86/boot/compressed/misc.c\n> +++ b/arch/x86/boot/compressed/misc.c\n> @@ -495,6 +495,8 @@ asmlinkage __visible void *extract_kernel(void *rmode, unsigned char *output)\n>   \t\terror(\"Destination virtual address changed when not relocatable\");\n>   #endif\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tdebug_putstr(\"\\nDecompressing Linux... \");\n>   \n>   \tif (init_unaccepted_memory()) {\n> diff --git a/arch/x86/kernel/vmlinux.lds.S b/arch/x86/kernel/vmlinux.lds.S\n> index f7e832c2ac61..d172e6e8eaaf 100644\n> --- a/arch/x86/kernel/vmlinux.lds.S\n> +++ b/arch/x86/kernel/vmlinux.lds.S\n> @@ -459,6 +459,11 @@ xen_elfnote_phys32_entry_offset =\n>   \n>   \tDISCARDS\n>   \n> +\t/DISCARD/ : {\n> +\t\t*(.dynsym .gnu.hash .hash .dynamic .dynstr)\n> +\t\t*(.interp .dynbss .eh_frame .sframe)\n> +\t}\n> +\n>   \t/*\n>   \t * Make sure that the .got.plt is either completely empty or it\n>   \t * contains only the lazy dispatch entries.\n> diff --git a/drivers/firmware/efi/libstub/x86-stub.c b/drivers/firmware/efi/libstub/x86-stub.c\n> index f8e465da344d..5c03954924fe 100644\n> --- a/drivers/firmware/efi/libstub/x86-stub.c\n> +++ b/drivers/firmware/efi/libstub/x86-stub.c\n> @@ -912,6 +912,8 @@ static efi_status_t efi_decompress_kernel(unsigned long *kernel_entry)\n>   \tif (status != EFI_SUCCESS)\n>   \t\treturn status;\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tentry = decompress_kernel((void *)addr, virt_addr, error);\n>   \tif (entry == ULONG_MAX) {\n>   \t\tefi_free(alloc_size, addr);\n\nThis patch causes a build failure here (on 64-bit):\n\n   LD      .tmp_vmlinux2\n   NM      .tmp_vmlinux2.syms\n   KSYMS   .tmp_vmlinux2.kallsyms.S\n   AS      .tmp_vmlinux2.kallsyms.o\n   LD      vmlinux\n   BTFIDS  vmlinux\nWARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\nFAILED elf_update(WRITE): invalid section entry size\nmake[5]: *** [scripts/Makefile.vmlinux:34: vmlinux] Error 255\nmake[5]: *** Deleting file 'vmlinux'\nmake[4]: *** [Makefile:1153: vmlinux] Error 2\nmake[3]: *** [debian/rules:74: buil",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172729582531673.mbox",
          "message_id": "<4eca972d-a462-4cc5-9238-5d63485e1af4 () oracle ! com>",
          "author_name": "Vegard Nossum",
          "author_email": "vegard.nossum () oracle ! com",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 20:24:22+00:00",
          "date_str": "Wed, 25 Sep 2024 20:24:22 +0000",
          "body": "\nOn 25/09/2024 17:01, Ard Biesheuvel wrote:\n> From: Ard Biesheuvel <ardb@kernel.org>\n> \n> Build the kernel as a Position Independent Executable (PIE). This\n> results in more efficient relocation processing for the virtual\n> displacement of the kernel (for KASLR). More importantly, it instructs\n> the linker to generate what is actually needed (a program that can be\n> moved around in memory before execution), which is better than having to\n> rely on the linker to create a position dependent binary that happens to\n> tolerate being moved around after poking it in exactly the right manner.\n> \n> Note that this means that all codegen should be compatible with PIE,\n> including Rust objects, so this needs to switch to the small code model\n> with the PIE relocation model as well.\n> \n> Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> ---\n>   arch/x86/Kconfig                        |  2 +-\n>   arch/x86/Makefile                       | 11 +++++++----\n>   arch/x86/boot/compressed/misc.c         |  2 ++\n>   arch/x86/kernel/vmlinux.lds.S           |  5 +++++\n>   drivers/firmware/efi/libstub/x86-stub.c |  2 ++\n>   5 files changed, 17 insertions(+), 5 deletions(-)\n> \n> diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig\n> index 54cb1f14218b..dbb4d284b0e1 100644\n> --- a/arch/x86/Kconfig\n> +++ b/arch/x86/Kconfig\n> @@ -2187,7 +2187,7 @@ config RANDOMIZE_BASE\n>   # Relocation on x86 needs some additional build support\n>   config X86_NEED_RELOCS\n>   \tdef_bool y\n> -\tdepends on RANDOMIZE_BASE || (X86_32 && RELOCATABLE)\n> +\tdepends on X86_32 && RELOCATABLE\n>   \n>   config PHYSICAL_ALIGN\n>   \thex \"Alignment value to which kernel should be aligned\"\n> diff --git a/arch/x86/Makefile b/arch/x86/Makefile\n> index 83d20f402535..c1dcff444bc8 100644\n> --- a/arch/x86/Makefile\n> +++ b/arch/x86/Makefile\n> @@ -206,9 +206,8 @@ else\n>                   PIE_CFLAGS-$(CONFIG_SMP) += -mstack-protector-guard-reg=gs\n>           endif\n>   \n> -        # Don't emit relaxable GOTPCREL relocations\n> -        KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n> -        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no $(PIE_CFLAGS-y)\n> +        KBUILD_CFLAGS_KERNEL\t+= $(PIE_CFLAGS-y)\n> +        KBUILD_RUSTFLAGS_KERNEL\t+= -Ccode-model=small -Crelocation-model=pie\n>   endif\n>   \n>   #\n> @@ -264,12 +263,16 @@ else\n>   LDFLAGS_vmlinux :=\n>   endif\n>   \n> +ifdef CONFIG_X86_64\n> +ldflags-pie-$(CONFIG_LD_IS_LLD)\t:= --apply-dynamic-relocs\n> +ldflags-pie-$(CONFIG_LD_IS_BFD)\t:= -z call-nop=suffix-nop\n> +LDFLAGS_vmlinux\t\t\t+= --pie -z text $(ldflags-pie-y)\n> +\n>   #\n>   # The 64-bit kernel must be aligned to 2MB.  Pass -z max-page-size=0x200000 to\n>   # the linker to force 2MB page size regardless of the default page size used\n>   # by the linker.\n>   #\n> -ifdef CONFIG_X86_64\n>   LDFLAGS_vmlinux += -z max-page-size=0x200000\n>   endif\n>   \n> diff --git a/arch/x86/boot/compressed/misc.c b/arch/x86/boot/compressed/misc.c\n> index 89f01375cdb7..79e3ffe16f61 100644\n> --- a/arch/x86/boot/compressed/misc.c\n> +++ b/arch/x86/boot/compressed/misc.c\n> @@ -495,6 +495,8 @@ asmlinkage __visible void *extract_kernel(void *rmode, unsigned char *output)\n>   \t\terror(\"Destination virtual address changed when not relocatable\");\n>   #endif\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tdebug_putstr(\"\\nDecompressing Linux... \");\n>   \n>   \tif (init_unaccepted_memory()) {\n> diff --git a/arch/x86/kernel/vmlinux.lds.S b/arch/x86/kernel/vmlinux.lds.S\n> index f7e832c2ac61..d172e6e8eaaf 100644\n> --- a/arch/x86/kernel/vmlinux.lds.S\n> +++ b/arch/x86/kernel/vmlinux.lds.S\n> @@ -459,6 +459,11 @@ xen_elfnote_phys32_entry_offset =\n>   \n>   \tDISCARDS\n>   \n> +\t/DISCARD/ : {\n> +\t\t*(.dynsym .gnu.hash .hash .dynamic .dynstr)\n> +\t\t*(.interp .dynbss .eh_frame .sframe)\n> +\t}\n> +\n>   \t/*\n>   \t * Make sure that the .got.plt is either completely empty or it\n>   \t * contains only the lazy dispatch entries.\n> diff --git a/drivers/firmware/efi/libstub/x86-stub.c b/drivers/firmware/efi/libstub/x86-stub.c\n> index f8e465da344d..5c03954924fe 100644\n> --- a/drivers/firmware/efi/libstub/x86-stub.c\n> +++ b/drivers/firmware/efi/libstub/x86-stub.c\n> @@ -912,6 +912,8 @@ static efi_status_t efi_decompress_kernel(unsigned long *kernel_entry)\n>   \tif (status != EFI_SUCCESS)\n>   \t\treturn status;\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tentry = decompress_kernel((void *)addr, virt_addr, error);\n>   \tif (entry == ULONG_MAX) {\n>   \t\tefi_free(alloc_size, addr);\n\nThis patch causes a build failure here (on 64-bit):\n\n   LD      .tmp_vmlinux2\n   NM      .tmp_vmlinux2.syms\n   KSYMS   .tmp_vmlinux2.kallsyms.S\n   AS      .tmp_vmlinux2.kallsyms.o\n   LD      vmlinux\n   BTFIDS  vmlinux\nWARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\nFAILED elf_update(WRITE): invalid section entry size\nmake[5]: *** [scripts/Makefile.vmlinux:34: vmlinux] Error 255\nmake[5]: *** Deleting file 'vmlinux'\nmake[4]: *** [Makefile:1153: vmlinux] Error 2\nmake[3]: *** [debian/rules:74: buil",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172729582831685.mbox",
          "message_id": "<4eca972d-a462-4cc5-9238-5d63485e1af4 () oracle ! com>",
          "author_name": "Vegard Nossum",
          "author_email": "vegard.nossum () oracle ! com",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 20:24:22+00:00",
          "date_str": "Wed, 25 Sep 2024 20:24:22 +0000",
          "body": "\nOn 25/09/2024 17:01, Ard Biesheuvel wrote:\n> From: Ard Biesheuvel <ardb@kernel.org>\n> \n> Build the kernel as a Position Independent Executable (PIE). This\n> results in more efficient relocation processing for the virtual\n> displacement of the kernel (for KASLR). More importantly, it instructs\n> the linker to generate what is actually needed (a program that can be\n> moved around in memory before execution), which is better than having to\n> rely on the linker to create a position dependent binary that happens to\n> tolerate being moved around after poking it in exactly the right manner.\n> \n> Note that this means that all codegen should be compatible with PIE,\n> including Rust objects, so this needs to switch to the small code model\n> with the PIE relocation model as well.\n> \n> Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> ---\n>   arch/x86/Kconfig                        |  2 +-\n>   arch/x86/Makefile                       | 11 +++++++----\n>   arch/x86/boot/compressed/misc.c         |  2 ++\n>   arch/x86/kernel/vmlinux.lds.S           |  5 +++++\n>   drivers/firmware/efi/libstub/x86-stub.c |  2 ++\n>   5 files changed, 17 insertions(+), 5 deletions(-)\n> \n> diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig\n> index 54cb1f14218b..dbb4d284b0e1 100644\n> --- a/arch/x86/Kconfig\n> +++ b/arch/x86/Kconfig\n> @@ -2187,7 +2187,7 @@ config RANDOMIZE_BASE\n>   # Relocation on x86 needs some additional build support\n>   config X86_NEED_RELOCS\n>   \tdef_bool y\n> -\tdepends on RANDOMIZE_BASE || (X86_32 && RELOCATABLE)\n> +\tdepends on X86_32 && RELOCATABLE\n>   \n>   config PHYSICAL_ALIGN\n>   \thex \"Alignment value to which kernel should be aligned\"\n> diff --git a/arch/x86/Makefile b/arch/x86/Makefile\n> index 83d20f402535..c1dcff444bc8 100644\n> --- a/arch/x86/Makefile\n> +++ b/arch/x86/Makefile\n> @@ -206,9 +206,8 @@ else\n>                   PIE_CFLAGS-$(CONFIG_SMP) += -mstack-protector-guard-reg=gs\n>           endif\n>   \n> -        # Don't emit relaxable GOTPCREL relocations\n> -        KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n> -        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no $(PIE_CFLAGS-y)\n> +        KBUILD_CFLAGS_KERNEL\t+= $(PIE_CFLAGS-y)\n> +        KBUILD_RUSTFLAGS_KERNEL\t+= -Ccode-model=small -Crelocation-model=pie\n>   endif\n>   \n>   #\n> @@ -264,12 +263,16 @@ else\n>   LDFLAGS_vmlinux :=\n>   endif\n>   \n> +ifdef CONFIG_X86_64\n> +ldflags-pie-$(CONFIG_LD_IS_LLD)\t:= --apply-dynamic-relocs\n> +ldflags-pie-$(CONFIG_LD_IS_BFD)\t:= -z call-nop=suffix-nop\n> +LDFLAGS_vmlinux\t\t\t+= --pie -z text $(ldflags-pie-y)\n> +\n>   #\n>   # The 64-bit kernel must be aligned to 2MB.  Pass -z max-page-size=0x200000 to\n>   # the linker to force 2MB page size regardless of the default page size used\n>   # by the linker.\n>   #\n> -ifdef CONFIG_X86_64\n>   LDFLAGS_vmlinux += -z max-page-size=0x200000\n>   endif\n>   \n> diff --git a/arch/x86/boot/compressed/misc.c b/arch/x86/boot/compressed/misc.c\n> index 89f01375cdb7..79e3ffe16f61 100644\n> --- a/arch/x86/boot/compressed/misc.c\n> +++ b/arch/x86/boot/compressed/misc.c\n> @@ -495,6 +495,8 @@ asmlinkage __visible void *extract_kernel(void *rmode, unsigned char *output)\n>   \t\terror(\"Destination virtual address changed when not relocatable\");\n>   #endif\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tdebug_putstr(\"\\nDecompressing Linux... \");\n>   \n>   \tif (init_unaccepted_memory()) {\n> diff --git a/arch/x86/kernel/vmlinux.lds.S b/arch/x86/kernel/vmlinux.lds.S\n> index f7e832c2ac61..d172e6e8eaaf 100644\n> --- a/arch/x86/kernel/vmlinux.lds.S\n> +++ b/arch/x86/kernel/vmlinux.lds.S\n> @@ -459,6 +459,11 @@ xen_elfnote_phys32_entry_offset =\n>   \n>   \tDISCARDS\n>   \n> +\t/DISCARD/ : {\n> +\t\t*(.dynsym .gnu.hash .hash .dynamic .dynstr)\n> +\t\t*(.interp .dynbss .eh_frame .sframe)\n> +\t}\n> +\n>   \t/*\n>   \t * Make sure that the .got.plt is either completely empty or it\n>   \t * contains only the lazy dispatch entries.\n> diff --git a/drivers/firmware/efi/libstub/x86-stub.c b/drivers/firmware/efi/libstub/x86-stub.c\n> index f8e465da344d..5c03954924fe 100644\n> --- a/drivers/firmware/efi/libstub/x86-stub.c\n> +++ b/drivers/firmware/efi/libstub/x86-stub.c\n> @@ -912,6 +912,8 @@ static efi_status_t efi_decompress_kernel(unsigned long *kernel_entry)\n>   \tif (status != EFI_SUCCESS)\n>   \t\treturn status;\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tentry = decompress_kernel((void *)addr, virt_addr, error);\n>   \tif (entry == ULONG_MAX) {\n>   \t\tefi_free(alloc_size, addr);\n\nThis patch causes a build failure here (on 64-bit):\n\n   LD      .tmp_vmlinux2\n   NM      .tmp_vmlinux2.syms\n   KSYMS   .tmp_vmlinux2.kallsyms.S\n   AS      .tmp_vmlinux2.kallsyms.o\n   LD      vmlinux\n   BTFIDS  vmlinux\nWARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\nFAILED elf_update(WRITE): invalid section entry size\nmake[5]: *** [scripts/Makefile.vmlinux:34: vmlinux] Error 255\nmake[5]: *** Deleting file 'vmlinux'\nmake[4]: *** [Makefile:1153: vmlinux] Error 2\nmake[3]: *** [debian/rules:74: buil",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172729582731681.mbox",
          "message_id": "<4eca972d-a462-4cc5-9238-5d63485e1af4 () oracle ! com>",
          "author_name": "Vegard Nossum",
          "author_email": "vegard.nossum () oracle ! com",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 20:24:22+00:00",
          "date_str": "Wed, 25 Sep 2024 20:24:22 +0000",
          "body": "\nOn 25/09/2024 17:01, Ard Biesheuvel wrote:\n> From: Ard Biesheuvel <ardb@kernel.org>\n> \n> Build the kernel as a Position Independent Executable (PIE). This\n> results in more efficient relocation processing for the virtual\n> displacement of the kernel (for KASLR). More importantly, it instructs\n> the linker to generate what is actually needed (a program that can be\n> moved around in memory before execution), which is better than having to\n> rely on the linker to create a position dependent binary that happens to\n> tolerate being moved around after poking it in exactly the right manner.\n> \n> Note that this means that all codegen should be compatible with PIE,\n> including Rust objects, so this needs to switch to the small code model\n> with the PIE relocation model as well.\n> \n> Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> ---\n>   arch/x86/Kconfig                        |  2 +-\n>   arch/x86/Makefile                       | 11 +++++++----\n>   arch/x86/boot/compressed/misc.c         |  2 ++\n>   arch/x86/kernel/vmlinux.lds.S           |  5 +++++\n>   drivers/firmware/efi/libstub/x86-stub.c |  2 ++\n>   5 files changed, 17 insertions(+), 5 deletions(-)\n> \n> diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig\n> index 54cb1f14218b..dbb4d284b0e1 100644\n> --- a/arch/x86/Kconfig\n> +++ b/arch/x86/Kconfig\n> @@ -2187,7 +2187,7 @@ config RANDOMIZE_BASE\n>   # Relocation on x86 needs some additional build support\n>   config X86_NEED_RELOCS\n>   \tdef_bool y\n> -\tdepends on RANDOMIZE_BASE || (X86_32 && RELOCATABLE)\n> +\tdepends on X86_32 && RELOCATABLE\n>   \n>   config PHYSICAL_ALIGN\n>   \thex \"Alignment value to which kernel should be aligned\"\n> diff --git a/arch/x86/Makefile b/arch/x86/Makefile\n> index 83d20f402535..c1dcff444bc8 100644\n> --- a/arch/x86/Makefile\n> +++ b/arch/x86/Makefile\n> @@ -206,9 +206,8 @@ else\n>                   PIE_CFLAGS-$(CONFIG_SMP) += -mstack-protector-guard-reg=gs\n>           endif\n>   \n> -        # Don't emit relaxable GOTPCREL relocations\n> -        KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n> -        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no $(PIE_CFLAGS-y)\n> +        KBUILD_CFLAGS_KERNEL\t+= $(PIE_CFLAGS-y)\n> +        KBUILD_RUSTFLAGS_KERNEL\t+= -Ccode-model=small -Crelocation-model=pie\n>   endif\n>   \n>   #\n> @@ -264,12 +263,16 @@ else\n>   LDFLAGS_vmlinux :=\n>   endif\n>   \n> +ifdef CONFIG_X86_64\n> +ldflags-pie-$(CONFIG_LD_IS_LLD)\t:= --apply-dynamic-relocs\n> +ldflags-pie-$(CONFIG_LD_IS_BFD)\t:= -z call-nop=suffix-nop\n> +LDFLAGS_vmlinux\t\t\t+= --pie -z text $(ldflags-pie-y)\n> +\n>   #\n>   # The 64-bit kernel must be aligned to 2MB.  Pass -z max-page-size=0x200000 to\n>   # the linker to force 2MB page size regardless of the default page size used\n>   # by the linker.\n>   #\n> -ifdef CONFIG_X86_64\n>   LDFLAGS_vmlinux += -z max-page-size=0x200000\n>   endif\n>   \n> diff --git a/arch/x86/boot/compressed/misc.c b/arch/x86/boot/compressed/misc.c\n> index 89f01375cdb7..79e3ffe16f61 100644\n> --- a/arch/x86/boot/compressed/misc.c\n> +++ b/arch/x86/boot/compressed/misc.c\n> @@ -495,6 +495,8 @@ asmlinkage __visible void *extract_kernel(void *rmode, unsigned char *output)\n>   \t\terror(\"Destination virtual address changed when not relocatable\");\n>   #endif\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tdebug_putstr(\"\\nDecompressing Linux... \");\n>   \n>   \tif (init_unaccepted_memory()) {\n> diff --git a/arch/x86/kernel/vmlinux.lds.S b/arch/x86/kernel/vmlinux.lds.S\n> index f7e832c2ac61..d172e6e8eaaf 100644\n> --- a/arch/x86/kernel/vmlinux.lds.S\n> +++ b/arch/x86/kernel/vmlinux.lds.S\n> @@ -459,6 +459,11 @@ xen_elfnote_phys32_entry_offset =\n>   \n>   \tDISCARDS\n>   \n> +\t/DISCARD/ : {\n> +\t\t*(.dynsym .gnu.hash .hash .dynamic .dynstr)\n> +\t\t*(.interp .dynbss .eh_frame .sframe)\n> +\t}\n> +\n>   \t/*\n>   \t * Make sure that the .got.plt is either completely empty or it\n>   \t * contains only the lazy dispatch entries.\n> diff --git a/drivers/firmware/efi/libstub/x86-stub.c b/drivers/firmware/efi/libstub/x86-stub.c\n> index f8e465da344d..5c03954924fe 100644\n> --- a/drivers/firmware/efi/libstub/x86-stub.c\n> +++ b/drivers/firmware/efi/libstub/x86-stub.c\n> @@ -912,6 +912,8 @@ static efi_status_t efi_decompress_kernel(unsigned long *kernel_entry)\n>   \tif (status != EFI_SUCCESS)\n>   \t\treturn status;\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tentry = decompress_kernel((void *)addr, virt_addr, error);\n>   \tif (entry == ULONG_MAX) {\n>   \t\tefi_free(alloc_size, addr);\n\nThis patch causes a build failure here (on 64-bit):\n\n   LD      .tmp_vmlinux2\n   NM      .tmp_vmlinux2.syms\n   KSYMS   .tmp_vmlinux2.kallsyms.S\n   AS      .tmp_vmlinux2.kallsyms.o\n   LD      vmlinux\n   BTFIDS  vmlinux\nWARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\nFAILED elf_update(WRITE): invalid section entry size\nmake[5]: *** [scripts/Makefile.vmlinux:34: vmlinux] Error 255\nmake[5]: *** Deleting file 'vmlinux'\nmake[4]: *** [Makefile:1153: vmlinux] Error 2\nmake[3]: *** [debian/rules:74: buil",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172729585631716.mbox",
          "message_id": "<4eca972d-a462-4cc5-9238-5d63485e1af4 () oracle ! com>",
          "author_name": "Vegard Nossum",
          "author_email": "vegard.nossum () oracle ! com",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-25 20:24:22+00:00",
          "date_str": "Wed, 25 Sep 2024 20:24:22 +0000",
          "body": "\nOn 25/09/2024 17:01, Ard Biesheuvel wrote:\n> From: Ard Biesheuvel <ardb@kernel.org>\n> \n> Build the kernel as a Position Independent Executable (PIE). This\n> results in more efficient relocation processing for the virtual\n> displacement of the kernel (for KASLR). More importantly, it instructs\n> the linker to generate what is actually needed (a program that can be\n> moved around in memory before execution), which is better than having to\n> rely on the linker to create a position dependent binary that happens to\n> tolerate being moved around after poking it in exactly the right manner.\n> \n> Note that this means that all codegen should be compatible with PIE,\n> including Rust objects, so this needs to switch to the small code model\n> with the PIE relocation model as well.\n> \n> Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> ---\n>   arch/x86/Kconfig                        |  2 +-\n>   arch/x86/Makefile                       | 11 +++++++----\n>   arch/x86/boot/compressed/misc.c         |  2 ++\n>   arch/x86/kernel/vmlinux.lds.S           |  5 +++++\n>   drivers/firmware/efi/libstub/x86-stub.c |  2 ++\n>   5 files changed, 17 insertions(+), 5 deletions(-)\n> \n> diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig\n> index 54cb1f14218b..dbb4d284b0e1 100644\n> --- a/arch/x86/Kconfig\n> +++ b/arch/x86/Kconfig\n> @@ -2187,7 +2187,7 @@ config RANDOMIZE_BASE\n>   # Relocation on x86 needs some additional build support\n>   config X86_NEED_RELOCS\n>   \tdef_bool y\n> -\tdepends on RANDOMIZE_BASE || (X86_32 && RELOCATABLE)\n> +\tdepends on X86_32 && RELOCATABLE\n>   \n>   config PHYSICAL_ALIGN\n>   \thex \"Alignment value to which kernel should be aligned\"\n> diff --git a/arch/x86/Makefile b/arch/x86/Makefile\n> index 83d20f402535..c1dcff444bc8 100644\n> --- a/arch/x86/Makefile\n> +++ b/arch/x86/Makefile\n> @@ -206,9 +206,8 @@ else\n>                   PIE_CFLAGS-$(CONFIG_SMP) += -mstack-protector-guard-reg=gs\n>           endif\n>   \n> -        # Don't emit relaxable GOTPCREL relocations\n> -        KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n> -        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no $(PIE_CFLAGS-y)\n> +        KBUILD_CFLAGS_KERNEL\t+= $(PIE_CFLAGS-y)\n> +        KBUILD_RUSTFLAGS_KERNEL\t+= -Ccode-model=small -Crelocation-model=pie\n>   endif\n>   \n>   #\n> @@ -264,12 +263,16 @@ else\n>   LDFLAGS_vmlinux :=\n>   endif\n>   \n> +ifdef CONFIG_X86_64\n> +ldflags-pie-$(CONFIG_LD_IS_LLD)\t:= --apply-dynamic-relocs\n> +ldflags-pie-$(CONFIG_LD_IS_BFD)\t:= -z call-nop=suffix-nop\n> +LDFLAGS_vmlinux\t\t\t+= --pie -z text $(ldflags-pie-y)\n> +\n>   #\n>   # The 64-bit kernel must be aligned to 2MB.  Pass -z max-page-size=0x200000 to\n>   # the linker to force 2MB page size regardless of the default page size used\n>   # by the linker.\n>   #\n> -ifdef CONFIG_X86_64\n>   LDFLAGS_vmlinux += -z max-page-size=0x200000\n>   endif\n>   \n> diff --git a/arch/x86/boot/compressed/misc.c b/arch/x86/boot/compressed/misc.c\n> index 89f01375cdb7..79e3ffe16f61 100644\n> --- a/arch/x86/boot/compressed/misc.c\n> +++ b/arch/x86/boot/compressed/misc.c\n> @@ -495,6 +495,8 @@ asmlinkage __visible void *extract_kernel(void *rmode, unsigned char *output)\n>   \t\terror(\"Destination virtual address changed when not relocatable\");\n>   #endif\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tdebug_putstr(\"\\nDecompressing Linux... \");\n>   \n>   \tif (init_unaccepted_memory()) {\n> diff --git a/arch/x86/kernel/vmlinux.lds.S b/arch/x86/kernel/vmlinux.lds.S\n> index f7e832c2ac61..d172e6e8eaaf 100644\n> --- a/arch/x86/kernel/vmlinux.lds.S\n> +++ b/arch/x86/kernel/vmlinux.lds.S\n> @@ -459,6 +459,11 @@ xen_elfnote_phys32_entry_offset =\n>   \n>   \tDISCARDS\n>   \n> +\t/DISCARD/ : {\n> +\t\t*(.dynsym .gnu.hash .hash .dynamic .dynstr)\n> +\t\t*(.interp .dynbss .eh_frame .sframe)\n> +\t}\n> +\n>   \t/*\n>   \t * Make sure that the .got.plt is either completely empty or it\n>   \t * contains only the lazy dispatch entries.\n> diff --git a/drivers/firmware/efi/libstub/x86-stub.c b/drivers/firmware/efi/libstub/x86-stub.c\n> index f8e465da344d..5c03954924fe 100644\n> --- a/drivers/firmware/efi/libstub/x86-stub.c\n> +++ b/drivers/firmware/efi/libstub/x86-stub.c\n> @@ -912,6 +912,8 @@ static efi_status_t efi_decompress_kernel(unsigned long *kernel_entry)\n>   \tif (status != EFI_SUCCESS)\n>   \t\treturn status;\n>   \n> +\tboot_params_ptr->kaslr_va_shift = virt_addr - LOAD_PHYSICAL_ADDR;\n> +\n>   \tentry = decompress_kernel((void *)addr, virt_addr, error);\n>   \tif (entry == ULONG_MAX) {\n>   \t\tefi_free(alloc_size, addr);\n\nThis patch causes a build failure here (on 64-bit):\n\n   LD      .tmp_vmlinux2\n   NM      .tmp_vmlinux2.syms\n   KSYMS   .tmp_vmlinux2.kallsyms.S\n   AS      .tmp_vmlinux2.kallsyms.o\n   LD      vmlinux\n   BTFIDS  vmlinux\nWARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\nFAILED elf_update(WRITE): invalid section entry size\nmake[5]: *** [scripts/Makefile.vmlinux:34: vmlinux] Error 255\nmake[5]: *** Deleting file 'vmlinux'\nmake[4]: *** [Makefile:1153: vmlinux] Error 2\nmake[3]: *** [debian/rules:74: buil",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172735782306805.mbox",
          "message_id": "<CAMj1kXEOFDwoYrLH9f-d46HRPMw7HjWRQGNdMu5_D_Ny3UtPxg () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-26 13:38:27+00:00",
          "date_str": "Thu, 26 Sep 2024 13:38:27 +0000",
          "body": "On Wed, 25 Sept 2024 at 22:25, Vegard Nossum <vegard.nossum@oracle.com> wrote:\n>\n>\n> On 25/09/2024 17:01, Ard Biesheuvel wrote:\n> > From: Ard Biesheuvel <ardb@kernel.org>\n> >\n> > Build the kernel as a Position Independent Executable (PIE). This\n> > results in more efficient relocation processing for the virtual\n> > displacement of the kernel (for KASLR). More importantly, it instructs\n> > the linker to generate what is actually needed (a program that can be\n> > moved around in memory before execution), which is better than having to\n> > rely on the linker to create a position dependent binary that happens to\n> > tolerate being moved around after poking it in exactly the right manner.\n> >\n> > Note that this means that all codegen should be compatible with PIE,\n> > including Rust objects, so this needs to switch to the small code model\n> > with the PIE relocation model as well.\n> >\n> > Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> > ---\n> >   arch/x86/Kconfig                        |  2 +-\n> >   arch/x86/Makefile                       | 11 +++++++----\n> >   arch/x86/boot/compressed/misc.c         |  2 ++\n> >   arch/x86/kernel/vmlinux.lds.S           |  5 +++++\n> >   drivers/firmware/efi/libstub/x86-stub.c |  2 ++\n> >   5 files changed, 17 insertions(+), 5 deletions(-)\n> >\n...\n>\n> This patch causes a build failure here (on 64-bit):\n>\n>    LD      .tmp_vmlinux2\n>    NM      .tmp_vmlinux2.syms\n>    KSYMS   .tmp_vmlinux2.kallsyms.S\n>    AS      .tmp_vmlinux2.kallsyms.o\n>    LD      vmlinux\n>    BTFIDS  vmlinux\n> WARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\n> FAILED elf_update(WRITE): invalid section entry size\n> make[5]: *** [scripts/Makefile.vmlinux:34: vmlinux] Error 255\n> make[5]: *** Deleting file 'vmlinux'\n> make[4]: *** [Makefile:1153: vmlinux] Error 2\n> make[3]: *** [debian/rules:74: build-arch] Error 2\n> dpkg-buildpackage: error: make -f debian/rules binary subprocess\n> returned exit status 2\n> make[2]: *** [scripts/Makefile.package:121: bindeb-pkg] Error 2\n> make[1]: *** [/home/opc/linux-mainline-worktree2/Makefile:1544:\n> bindeb-pkg] Error 2\n> make: *** [Makefile:224: __sub-make] Error 2\n>\n> The parent commit builds fine. With V=1:\n>\n> + ldflags='-m elf_x86_64 -z noexecstack --pie -z text -z\n> call-nop=suffix-nop -z max-page-size=0x200000 --build-id=sha1\n> --orphan-handling=warn --script=./arch/x86/kernel/vmlinux.lds\n> -Map=vmlinux.map'\n> + ld -m elf_x86_64 -z noexecstack --pie -z text -z call-nop=suffix-nop\n> -z max-page-size=0x200000 --build-id=sha1 --orphan-handling=warn\n> --script=./arch/x86/kernel/vmlinux.lds -Map=vmlinux.map -o vmlinux\n> --whole-archive vmlinux.a .vmlinux.export.o init/version-timestamp.o\n> --no-whole-archive --start-group --end-group .tmp_vmlinux2.kallsyms.o\n> .tmp_vmlinux1.btf.o\n> + is_enabled CONFIG_DEBUG_INFO_BTF\n> + grep -q '^CONFIG_DEBUG_INFO_BTF=y' include/config/auto.conf\n> + info BTFIDS vmlinux\n> + printf '  %-7s %s\\n' BTFIDS vmlinux\n>    BTFIDS  vmlinux\n> + ./tools/bpf/resolve_btfids/resolve_btfids vmlinux\n> WARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\n> FAILED elf_update(WRITE): invalid section entry size\n>\n> I can send the full config off-list if necessary, but looks like it\n> might be enough to set CONFIG_DEBUG_INFO_BTF=y.\n>\n\nThanks for the report. Turns out that adding the GOT to .rodata bumps\nthe section's sh_entsize to 8, and libelf complains if the section\nsize is not a multiple of the entry size.\n\nI'll include a fix in the next revision.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172735782006796.mbox",
          "message_id": "<CAMj1kXEOFDwoYrLH9f-d46HRPMw7HjWRQGNdMu5_D_Ny3UtPxg () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-26 13:38:27+00:00",
          "date_str": "Thu, 26 Sep 2024 13:38:27 +0000",
          "body": "On Wed, 25 Sept 2024 at 22:25, Vegard Nossum <vegard.nossum@oracle.com> wrote:\n>\n>\n> On 25/09/2024 17:01, Ard Biesheuvel wrote:\n> > From: Ard Biesheuvel <ardb@kernel.org>\n> >\n> > Build the kernel as a Position Independent Executable (PIE). This\n> > results in more efficient relocation processing for the virtual\n> > displacement of the kernel (for KASLR). More importantly, it instructs\n> > the linker to generate what is actually needed (a program that can be\n> > moved around in memory before execution), which is better than having to\n> > rely on the linker to create a position dependent binary that happens to\n> > tolerate being moved around after poking it in exactly the right manner.\n> >\n> > Note that this means that all codegen should be compatible with PIE,\n> > including Rust objects, so this needs to switch to the small code model\n> > with the PIE relocation model as well.\n> >\n> > Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> > ---\n> >   arch/x86/Kconfig                        |  2 +-\n> >   arch/x86/Makefile                       | 11 +++++++----\n> >   arch/x86/boot/compressed/misc.c         |  2 ++\n> >   arch/x86/kernel/vmlinux.lds.S           |  5 +++++\n> >   drivers/firmware/efi/libstub/x86-stub.c |  2 ++\n> >   5 files changed, 17 insertions(+), 5 deletions(-)\n> >\n...\n>\n> This patch causes a build failure here (on 64-bit):\n>\n>    LD      .tmp_vmlinux2\n>    NM      .tmp_vmlinux2.syms\n>    KSYMS   .tmp_vmlinux2.kallsyms.S\n>    AS      .tmp_vmlinux2.kallsyms.o\n>    LD      vmlinux\n>    BTFIDS  vmlinux\n> WARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\n> FAILED elf_update(WRITE): invalid section entry size\n> make[5]: *** [scripts/Makefile.vmlinux:34: vmlinux] Error 255\n> make[5]: *** Deleting file 'vmlinux'\n> make[4]: *** [Makefile:1153: vmlinux] Error 2\n> make[3]: *** [debian/rules:74: build-arch] Error 2\n> dpkg-buildpackage: error: make -f debian/rules binary subprocess\n> returned exit status 2\n> make[2]: *** [scripts/Makefile.package:121: bindeb-pkg] Error 2\n> make[1]: *** [/home/opc/linux-mainline-worktree2/Makefile:1544:\n> bindeb-pkg] Error 2\n> make: *** [Makefile:224: __sub-make] Error 2\n>\n> The parent commit builds fine. With V=1:\n>\n> + ldflags='-m elf_x86_64 -z noexecstack --pie -z text -z\n> call-nop=suffix-nop -z max-page-size=0x200000 --build-id=sha1\n> --orphan-handling=warn --script=./arch/x86/kernel/vmlinux.lds\n> -Map=vmlinux.map'\n> + ld -m elf_x86_64 -z noexecstack --pie -z text -z call-nop=suffix-nop\n> -z max-page-size=0x200000 --build-id=sha1 --orphan-handling=warn\n> --script=./arch/x86/kernel/vmlinux.lds -Map=vmlinux.map -o vmlinux\n> --whole-archive vmlinux.a .vmlinux.export.o init/version-timestamp.o\n> --no-whole-archive --start-group --end-group .tmp_vmlinux2.kallsyms.o\n> .tmp_vmlinux1.btf.o\n> + is_enabled CONFIG_DEBUG_INFO_BTF\n> + grep -q '^CONFIG_DEBUG_INFO_BTF=y' include/config/auto.conf\n> + info BTFIDS vmlinux\n> + printf '  %-7s %s\\n' BTFIDS vmlinux\n>    BTFIDS  vmlinux\n> + ./tools/bpf/resolve_btfids/resolve_btfids vmlinux\n> WARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\n> FAILED elf_update(WRITE): invalid section entry size\n>\n> I can send the full config off-list if necessary, but looks like it\n> might be enough to set CONFIG_DEBUG_INFO_BTF=y.\n>\n\nThanks for the report. Turns out that adding the GOT to .rodata bumps\nthe section's sh_entsize to 8, and libelf complains if the section\nsize is not a multiple of the entry size.\n\nI'll include a fix in the next revision.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172735783506817.mbox",
          "message_id": "<CAMj1kXEOFDwoYrLH9f-d46HRPMw7HjWRQGNdMu5_D_Ny3UtPxg () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-26 13:38:27+00:00",
          "date_str": "Thu, 26 Sep 2024 13:38:27 +0000",
          "body": "On Wed, 25 Sept 2024 at 22:25, Vegard Nossum <vegard.nossum@oracle.com> wrote:\n>\n>\n> On 25/09/2024 17:01, Ard Biesheuvel wrote:\n> > From: Ard Biesheuvel <ardb@kernel.org>\n> >\n> > Build the kernel as a Position Independent Executable (PIE). This\n> > results in more efficient relocation processing for the virtual\n> > displacement of the kernel (for KASLR). More importantly, it instructs\n> > the linker to generate what is actually needed (a program that can be\n> > moved around in memory before execution), which is better than having to\n> > rely on the linker to create a position dependent binary that happens to\n> > tolerate being moved around after poking it in exactly the right manner.\n> >\n> > Note that this means that all codegen should be compatible with PIE,\n> > including Rust objects, so this needs to switch to the small code model\n> > with the PIE relocation model as well.\n> >\n> > Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> > ---\n> >   arch/x86/Kconfig                        |  2 +-\n> >   arch/x86/Makefile                       | 11 +++++++----\n> >   arch/x86/boot/compressed/misc.c         |  2 ++\n> >   arch/x86/kernel/vmlinux.lds.S           |  5 +++++\n> >   drivers/firmware/efi/libstub/x86-stub.c |  2 ++\n> >   5 files changed, 17 insertions(+), 5 deletions(-)\n> >\n...\n>\n> This patch causes a build failure here (on 64-bit):\n>\n>    LD      .tmp_vmlinux2\n>    NM      .tmp_vmlinux2.syms\n>    KSYMS   .tmp_vmlinux2.kallsyms.S\n>    AS      .tmp_vmlinux2.kallsyms.o\n>    LD      vmlinux\n>    BTFIDS  vmlinux\n> WARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\n> FAILED elf_update(WRITE): invalid section entry size\n> make[5]: *** [scripts/Makefile.vmlinux:34: vmlinux] Error 255\n> make[5]: *** Deleting file 'vmlinux'\n> make[4]: *** [Makefile:1153: vmlinux] Error 2\n> make[3]: *** [debian/rules:74: build-arch] Error 2\n> dpkg-buildpackage: error: make -f debian/rules binary subprocess\n> returned exit status 2\n> make[2]: *** [scripts/Makefile.package:121: bindeb-pkg] Error 2\n> make[1]: *** [/home/opc/linux-mainline-worktree2/Makefile:1544:\n> bindeb-pkg] Error 2\n> make: *** [Makefile:224: __sub-make] Error 2\n>\n> The parent commit builds fine. With V=1:\n>\n> + ldflags='-m elf_x86_64 -z noexecstack --pie -z text -z\n> call-nop=suffix-nop -z max-page-size=0x200000 --build-id=sha1\n> --orphan-handling=warn --script=./arch/x86/kernel/vmlinux.lds\n> -Map=vmlinux.map'\n> + ld -m elf_x86_64 -z noexecstack --pie -z text -z call-nop=suffix-nop\n> -z max-page-size=0x200000 --build-id=sha1 --orphan-handling=warn\n> --script=./arch/x86/kernel/vmlinux.lds -Map=vmlinux.map -o vmlinux\n> --whole-archive vmlinux.a .vmlinux.export.o init/version-timestamp.o\n> --no-whole-archive --start-group --end-group .tmp_vmlinux2.kallsyms.o\n> .tmp_vmlinux1.btf.o\n> + is_enabled CONFIG_DEBUG_INFO_BTF\n> + grep -q '^CONFIG_DEBUG_INFO_BTF=y' include/config/auto.conf\n> + info BTFIDS vmlinux\n> + printf '  %-7s %s\\n' BTFIDS vmlinux\n>    BTFIDS  vmlinux\n> + ./tools/bpf/resolve_btfids/resolve_btfids vmlinux\n> WARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\n> FAILED elf_update(WRITE): invalid section entry size\n>\n> I can send the full config off-list if necessary, but looks like it\n> might be enough to set CONFIG_DEBUG_INFO_BTF=y.\n>\n\nThanks for the report. Turns out that adding the GOT to .rodata bumps\nthe section's sh_entsize to 8, and libelf complains if the section\nsize is not a multiple of the entry size.\n\nI'll include a fix in the next revision.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172735783406816.mbox",
          "message_id": "<CAMj1kXEOFDwoYrLH9f-d46HRPMw7HjWRQGNdMu5_D_Ny3UtPxg () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-26 13:38:27+00:00",
          "date_str": "Thu, 26 Sep 2024 13:38:27 +0000",
          "body": "On Wed, 25 Sept 2024 at 22:25, Vegard Nossum <vegard.nossum@oracle.com> wrote:\n>\n>\n> On 25/09/2024 17:01, Ard Biesheuvel wrote:\n> > From: Ard Biesheuvel <ardb@kernel.org>\n> >\n> > Build the kernel as a Position Independent Executable (PIE). This\n> > results in more efficient relocation processing for the virtual\n> > displacement of the kernel (for KASLR). More importantly, it instructs\n> > the linker to generate what is actually needed (a program that can be\n> > moved around in memory before execution), which is better than having to\n> > rely on the linker to create a position dependent binary that happens to\n> > tolerate being moved around after poking it in exactly the right manner.\n> >\n> > Note that this means that all codegen should be compatible with PIE,\n> > including Rust objects, so this needs to switch to the small code model\n> > with the PIE relocation model as well.\n> >\n> > Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> > ---\n> >   arch/x86/Kconfig                        |  2 +-\n> >   arch/x86/Makefile                       | 11 +++++++----\n> >   arch/x86/boot/compressed/misc.c         |  2 ++\n> >   arch/x86/kernel/vmlinux.lds.S           |  5 +++++\n> >   drivers/firmware/efi/libstub/x86-stub.c |  2 ++\n> >   5 files changed, 17 insertions(+), 5 deletions(-)\n> >\n...\n>\n> This patch causes a build failure here (on 64-bit):\n>\n>    LD      .tmp_vmlinux2\n>    NM      .tmp_vmlinux2.syms\n>    KSYMS   .tmp_vmlinux2.kallsyms.S\n>    AS      .tmp_vmlinux2.kallsyms.o\n>    LD      vmlinux\n>    BTFIDS  vmlinux\n> WARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\n> FAILED elf_update(WRITE): invalid section entry size\n> make[5]: *** [scripts/Makefile.vmlinux:34: vmlinux] Error 255\n> make[5]: *** Deleting file 'vmlinux'\n> make[4]: *** [Makefile:1153: vmlinux] Error 2\n> make[3]: *** [debian/rules:74: build-arch] Error 2\n> dpkg-buildpackage: error: make -f debian/rules binary subprocess\n> returned exit status 2\n> make[2]: *** [scripts/Makefile.package:121: bindeb-pkg] Error 2\n> make[1]: *** [/home/opc/linux-mainline-worktree2/Makefile:1544:\n> bindeb-pkg] Error 2\n> make: *** [Makefile:224: __sub-make] Error 2\n>\n> The parent commit builds fine. With V=1:\n>\n> + ldflags='-m elf_x86_64 -z noexecstack --pie -z text -z\n> call-nop=suffix-nop -z max-page-size=0x200000 --build-id=sha1\n> --orphan-handling=warn --script=./arch/x86/kernel/vmlinux.lds\n> -Map=vmlinux.map'\n> + ld -m elf_x86_64 -z noexecstack --pie -z text -z call-nop=suffix-nop\n> -z max-page-size=0x200000 --build-id=sha1 --orphan-handling=warn\n> --script=./arch/x86/kernel/vmlinux.lds -Map=vmlinux.map -o vmlinux\n> --whole-archive vmlinux.a .vmlinux.export.o init/version-timestamp.o\n> --no-whole-archive --start-group --end-group .tmp_vmlinux2.kallsyms.o\n> .tmp_vmlinux1.btf.o\n> + is_enabled CONFIG_DEBUG_INFO_BTF\n> + grep -q '^CONFIG_DEBUG_INFO_BTF=y' include/config/auto.conf\n> + info BTFIDS vmlinux\n> + printf '  %-7s %s\\n' BTFIDS vmlinux\n>    BTFIDS  vmlinux\n> + ./tools/bpf/resolve_btfids/resolve_btfids vmlinux\n> WARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\n> FAILED elf_update(WRITE): invalid section entry size\n>\n> I can send the full config off-list if necessary, but looks like it\n> might be enough to set CONFIG_DEBUG_INFO_BTF=y.\n>\n\nThanks for the report. Turns out that adding the GOT to .rodata bumps\nthe section's sh_entsize to 8, and libelf complains if the section\nsize is not a multiple of the entry size.\n\nI'll include a fix in the next revision.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172735781606785.mbox",
          "message_id": "<CAMj1kXEOFDwoYrLH9f-d46HRPMw7HjWRQGNdMu5_D_Ny3UtPxg () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-26 13:38:27+00:00",
          "date_str": "Thu, 26 Sep 2024 13:38:27 +0000",
          "body": "On Wed, 25 Sept 2024 at 22:25, Vegard Nossum <vegard.nossum@oracle.com> wrote:\n>\n>\n> On 25/09/2024 17:01, Ard Biesheuvel wrote:\n> > From: Ard Biesheuvel <ardb@kernel.org>\n> >\n> > Build the kernel as a Position Independent Executable (PIE). This\n> > results in more efficient relocation processing for the virtual\n> > displacement of the kernel (for KASLR). More importantly, it instructs\n> > the linker to generate what is actually needed (a program that can be\n> > moved around in memory before execution), which is better than having to\n> > rely on the linker to create a position dependent binary that happens to\n> > tolerate being moved around after poking it in exactly the right manner.\n> >\n> > Note that this means that all codegen should be compatible with PIE,\n> > including Rust objects, so this needs to switch to the small code model\n> > with the PIE relocation model as well.\n> >\n> > Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> > ---\n> >   arch/x86/Kconfig                        |  2 +-\n> >   arch/x86/Makefile                       | 11 +++++++----\n> >   arch/x86/boot/compressed/misc.c         |  2 ++\n> >   arch/x86/kernel/vmlinux.lds.S           |  5 +++++\n> >   drivers/firmware/efi/libstub/x86-stub.c |  2 ++\n> >   5 files changed, 17 insertions(+), 5 deletions(-)\n> >\n...\n>\n> This patch causes a build failure here (on 64-bit):\n>\n>    LD      .tmp_vmlinux2\n>    NM      .tmp_vmlinux2.syms\n>    KSYMS   .tmp_vmlinux2.kallsyms.S\n>    AS      .tmp_vmlinux2.kallsyms.o\n>    LD      vmlinux\n>    BTFIDS  vmlinux\n> WARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\n> FAILED elf_update(WRITE): invalid section entry size\n> make[5]: *** [scripts/Makefile.vmlinux:34: vmlinux] Error 255\n> make[5]: *** Deleting file 'vmlinux'\n> make[4]: *** [Makefile:1153: vmlinux] Error 2\n> make[3]: *** [debian/rules:74: build-arch] Error 2\n> dpkg-buildpackage: error: make -f debian/rules binary subprocess\n> returned exit status 2\n> make[2]: *** [scripts/Makefile.package:121: bindeb-pkg] Error 2\n> make[1]: *** [/home/opc/linux-mainline-worktree2/Makefile:1544:\n> bindeb-pkg] Error 2\n> make: *** [Makefile:224: __sub-make] Error 2\n>\n> The parent commit builds fine. With V=1:\n>\n> + ldflags='-m elf_x86_64 -z noexecstack --pie -z text -z\n> call-nop=suffix-nop -z max-page-size=0x200000 --build-id=sha1\n> --orphan-handling=warn --script=./arch/x86/kernel/vmlinux.lds\n> -Map=vmlinux.map'\n> + ld -m elf_x86_64 -z noexecstack --pie -z text -z call-nop=suffix-nop\n> -z max-page-size=0x200000 --build-id=sha1 --orphan-handling=warn\n> --script=./arch/x86/kernel/vmlinux.lds -Map=vmlinux.map -o vmlinux\n> --whole-archive vmlinux.a .vmlinux.export.o init/version-timestamp.o\n> --no-whole-archive --start-group --end-group .tmp_vmlinux2.kallsyms.o\n> .tmp_vmlinux1.btf.o\n> + is_enabled CONFIG_DEBUG_INFO_BTF\n> + grep -q '^CONFIG_DEBUG_INFO_BTF=y' include/config/auto.conf\n> + info BTFIDS vmlinux\n> + printf '  %-7s %s\\n' BTFIDS vmlinux\n>    BTFIDS  vmlinux\n> + ./tools/bpf/resolve_btfids/resolve_btfids vmlinux\n> WARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\n> FAILED elf_update(WRITE): invalid section entry size\n>\n> I can send the full config off-list if necessary, but looks like it\n> might be enough to set CONFIG_DEBUG_INFO_BTF=y.\n>\n\nThanks for the report. Turns out that adding the GOT to .rodata bumps\nthe section's sh_entsize to 8, and libelf complains if the section\nsize is not a multiple of the entry size.\n\nI'll include a fix in the next revision.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172735782306801.mbox",
          "message_id": "<CAMj1kXEOFDwoYrLH9f-d46HRPMw7HjWRQGNdMu5_D_Ny3UtPxg () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-26 13:38:27+00:00",
          "date_str": "Thu, 26 Sep 2024 13:38:27 +0000",
          "body": "On Wed, 25 Sept 2024 at 22:25, Vegard Nossum <vegard.nossum@oracle.com> wrote:\n>\n>\n> On 25/09/2024 17:01, Ard Biesheuvel wrote:\n> > From: Ard Biesheuvel <ardb@kernel.org>\n> >\n> > Build the kernel as a Position Independent Executable (PIE). This\n> > results in more efficient relocation processing for the virtual\n> > displacement of the kernel (for KASLR). More importantly, it instructs\n> > the linker to generate what is actually needed (a program that can be\n> > moved around in memory before execution), which is better than having to\n> > rely on the linker to create a position dependent binary that happens to\n> > tolerate being moved around after poking it in exactly the right manner.\n> >\n> > Note that this means that all codegen should be compatible with PIE,\n> > including Rust objects, so this needs to switch to the small code model\n> > with the PIE relocation model as well.\n> >\n> > Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> > ---\n> >   arch/x86/Kconfig                        |  2 +-\n> >   arch/x86/Makefile                       | 11 +++++++----\n> >   arch/x86/boot/compressed/misc.c         |  2 ++\n> >   arch/x86/kernel/vmlinux.lds.S           |  5 +++++\n> >   drivers/firmware/efi/libstub/x86-stub.c |  2 ++\n> >   5 files changed, 17 insertions(+), 5 deletions(-)\n> >\n...\n>\n> This patch causes a build failure here (on 64-bit):\n>\n>    LD      .tmp_vmlinux2\n>    NM      .tmp_vmlinux2.syms\n>    KSYMS   .tmp_vmlinux2.kallsyms.S\n>    AS      .tmp_vmlinux2.kallsyms.o\n>    LD      vmlinux\n>    BTFIDS  vmlinux\n> WARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\n> FAILED elf_update(WRITE): invalid section entry size\n> make[5]: *** [scripts/Makefile.vmlinux:34: vmlinux] Error 255\n> make[5]: *** Deleting file 'vmlinux'\n> make[4]: *** [Makefile:1153: vmlinux] Error 2\n> make[3]: *** [debian/rules:74: build-arch] Error 2\n> dpkg-buildpackage: error: make -f debian/rules binary subprocess\n> returned exit status 2\n> make[2]: *** [scripts/Makefile.package:121: bindeb-pkg] Error 2\n> make[1]: *** [/home/opc/linux-mainline-worktree2/Makefile:1544:\n> bindeb-pkg] Error 2\n> make: *** [Makefile:224: __sub-make] Error 2\n>\n> The parent commit builds fine. With V=1:\n>\n> + ldflags='-m elf_x86_64 -z noexecstack --pie -z text -z\n> call-nop=suffix-nop -z max-page-size=0x200000 --build-id=sha1\n> --orphan-handling=warn --script=./arch/x86/kernel/vmlinux.lds\n> -Map=vmlinux.map'\n> + ld -m elf_x86_64 -z noexecstack --pie -z text -z call-nop=suffix-nop\n> -z max-page-size=0x200000 --build-id=sha1 --orphan-handling=warn\n> --script=./arch/x86/kernel/vmlinux.lds -Map=vmlinux.map -o vmlinux\n> --whole-archive vmlinux.a .vmlinux.export.o init/version-timestamp.o\n> --no-whole-archive --start-group --end-group .tmp_vmlinux2.kallsyms.o\n> .tmp_vmlinux1.btf.o\n> + is_enabled CONFIG_DEBUG_INFO_BTF\n> + grep -q '^CONFIG_DEBUG_INFO_BTF=y' include/config/auto.conf\n> + info BTFIDS vmlinux\n> + printf '  %-7s %s\\n' BTFIDS vmlinux\n>    BTFIDS  vmlinux\n> + ./tools/bpf/resolve_btfids/resolve_btfids vmlinux\n> WARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\n> FAILED elf_update(WRITE): invalid section entry size\n>\n> I can send the full config off-list if necessary, but looks like it\n> might be enough to set CONFIG_DEBUG_INFO_BTF=y.\n>\n\nThanks for the report. Turns out that adding the GOT to .rodata bumps\nthe section's sh_entsize to 8, and libelf complains if the section\nsize is not a multiple of the entry size.\n\nI'll include a fix in the next revision.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172735781906793.mbox",
          "message_id": "<CAMj1kXEOFDwoYrLH9f-d46HRPMw7HjWRQGNdMu5_D_Ny3UtPxg () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 27/28] x86/kernel: Switch to PIE linking for the core kernel",
          "date": "2024-09-26 13:38:27+00:00",
          "date_str": "Thu, 26 Sep 2024 13:38:27 +0000",
          "body": "On Wed, 25 Sept 2024 at 22:25, Vegard Nossum <vegard.nossum@oracle.com> wrote:\n>\n>\n> On 25/09/2024 17:01, Ard Biesheuvel wrote:\n> > From: Ard Biesheuvel <ardb@kernel.org>\n> >\n> > Build the kernel as a Position Independent Executable (PIE). This\n> > results in more efficient relocation processing for the virtual\n> > displacement of the kernel (for KASLR). More importantly, it instructs\n> > the linker to generate what is actually needed (a program that can be\n> > moved around in memory before execution), which is better than having to\n> > rely on the linker to create a position dependent binary that happens to\n> > tolerate being moved around after poking it in exactly the right manner.\n> >\n> > Note that this means that all codegen should be compatible with PIE,\n> > including Rust objects, so this needs to switch to the small code model\n> > with the PIE relocation model as well.\n> >\n> > Signed-off-by: Ard Biesheuvel <ardb@kernel.org>\n> > ---\n> >   arch/x86/Kconfig                        |  2 +-\n> >   arch/x86/Makefile                       | 11 +++++++----\n> >   arch/x86/boot/compressed/misc.c         |  2 ++\n> >   arch/x86/kernel/vmlinux.lds.S           |  5 +++++\n> >   drivers/firmware/efi/libstub/x86-stub.c |  2 ++\n> >   5 files changed, 17 insertions(+), 5 deletions(-)\n> >\n...\n>\n> This patch causes a build failure here (on 64-bit):\n>\n>    LD      .tmp_vmlinux2\n>    NM      .tmp_vmlinux2.syms\n>    KSYMS   .tmp_vmlinux2.kallsyms.S\n>    AS      .tmp_vmlinux2.kallsyms.o\n>    LD      vmlinux\n>    BTFIDS  vmlinux\n> WARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\n> FAILED elf_update(WRITE): invalid section entry size\n> make[5]: *** [scripts/Makefile.vmlinux:34: vmlinux] Error 255\n> make[5]: *** Deleting file 'vmlinux'\n> make[4]: *** [Makefile:1153: vmlinux] Error 2\n> make[3]: *** [debian/rules:74: build-arch] Error 2\n> dpkg-buildpackage: error: make -f debian/rules binary subprocess\n> returned exit status 2\n> make[2]: *** [scripts/Makefile.package:121: bindeb-pkg] Error 2\n> make[1]: *** [/home/opc/linux-mainline-worktree2/Makefile:1544:\n> bindeb-pkg] Error 2\n> make: *** [Makefile:224: __sub-make] Error 2\n>\n> The parent commit builds fine. With V=1:\n>\n> + ldflags='-m elf_x86_64 -z noexecstack --pie -z text -z\n> call-nop=suffix-nop -z max-page-size=0x200000 --build-id=sha1\n> --orphan-handling=warn --script=./arch/x86/kernel/vmlinux.lds\n> -Map=vmlinux.map'\n> + ld -m elf_x86_64 -z noexecstack --pie -z text -z call-nop=suffix-nop\n> -z max-page-size=0x200000 --build-id=sha1 --orphan-handling=warn\n> --script=./arch/x86/kernel/vmlinux.lds -Map=vmlinux.map -o vmlinux\n> --whole-archive vmlinux.a .vmlinux.export.o init/version-timestamp.o\n> --no-whole-archive --start-group --end-group .tmp_vmlinux2.kallsyms.o\n> .tmp_vmlinux1.btf.o\n> + is_enabled CONFIG_DEBUG_INFO_BTF\n> + grep -q '^CONFIG_DEBUG_INFO_BTF=y' include/config/auto.conf\n> + info BTFIDS vmlinux\n> + printf '  %-7s %s\\n' BTFIDS vmlinux\n>    BTFIDS  vmlinux\n> + ./tools/bpf/resolve_btfids/resolve_btfids vmlinux\n> WARN: resolve_btfids: unresolved symbol bpf_lsm_key_free\n> FAILED elf_update(WRITE): invalid section entry size\n>\n> I can send the full config off-list if necessary, but looks like it\n> might be enough to set CONFIG_DEBUG_INFO_BTF=y.\n>\n\nThanks for the report. Turns out that adding the GOT to .rodata bumps\nthe section's sh_entsize to 8, and libelf complains if the section\nsize is not a multiple of the entry size.\n\nI'll include a fix in the next revision.\n",
          "year": "2024",
          "month": "09"
        }
      ],
      "primary_category": "kernel_integration"
    },
    {
      "subject": "[RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
      "normalized_subject": "x86: Use PIE codegen for the core kernel",
      "message_count": 23,
      "participants": [
        "H. Peter Anvin",
        "Ard Biesheuvel",
        "David Laight",
        "Uros Bizjak"
      ],
      "categories": [
        "kernel_integration",
        "rfc_proposals",
        "compiler_compat"
      ],
      "first_date": "2024-09-25T15:01:25+00:00",
      "last_date": "2024-10-06T19:38:52+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/09/172727753618868.mbox",
          "message_id": "<20240925150059.3955569-55-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-09-25 15:01:25+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:25 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nAs an intermediate step towards enabling PIE linking for the 64-bit x86\nkernel, enable PIE codegen for all objects that are linked into the\nkernel proper.\n\nThis substantially reduces the number of relocations that need to be\nprocessed when booting a relocatable KASLR kernel.\n\nBefore (size in bytes of the reloc table):\n\n  797372 arch/x86/boot/compressed/vmlinux.relocs\n\nAfter:\n\n  400252 arch/x86/boot/compressed/vmlinux.relocs\n\nSigned-off-by: Ard Biesheuvel <ardb@kernel.org>\n---\n arch/x86/Makefile                 | 11 ++++++++++-\n arch/x86/boot/Makefile            |  1 +\n arch/x86/boot/compressed/Makefile |  2 +-\n arch/x86/entry/vdso/Makefile      |  1 +\n arch/x86/realmode/rm/Makefile     |  1 +\n include/asm-generic/vmlinux.lds.h |  1 +\n 6 files changed, 15 insertions(+), 2 deletions(-)\n\ndiff --git a/arch/x86/Makefile b/arch/x86/Makefile\nindex b78b7623a4a9..83d20f402535 100644\n--- a/arch/x86/Makefile\n+++ b/arch/x86/Makefile\n@@ -193,13 +193,22 @@ else\n         KBUILD_RUSTFLAGS += -Cno-redzone=y\n         KBUILD_RUSTFLAGS += -Ccode-model=kernel\n \n+        PIE_CFLAGS-y := -fpie -mcmodel=small \\\n+                        -include $(srctree)/include/linux/hidden.h\n+\n+        PIE_CFLAGS-$(CONFIG_CC_IS_GCC) += $(call cc-option.-mdirect-extern-access)\n+        PIE_CFLAGS-$(CONFIG_CC_IS_CLANG) += -fdirect-access-external-data\n+\n         ifeq ($(CONFIG_STACKPROTECTOR),y)\n                 KBUILD_CFLAGS += -mstack-protector-guard-symbol=fixed_percpu_data\n+\n+                # the 'small' C model defaults to %fs\n+                PIE_CFLAGS-$(CONFIG_SMP) += -mstack-protector-guard-reg=gs\n         endif\n \n         # Don't emit relaxable GOTPCREL relocations\n         KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n-        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n+        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no $(PIE_CFLAGS-y)\n endif\n \n #\ndiff --git a/arch/x86/boot/Makefile b/arch/x86/boot/Makefile\nindex 9cc0ff6e9067..4d3ba35cb619 100644\n--- a/arch/x86/boot/Makefile\n+++ b/arch/x86/boot/Makefile\n@@ -57,6 +57,7 @@ KBUILD_AFLAGS\t:= $(KBUILD_CFLAGS) -D__ASSEMBLY__\n KBUILD_CFLAGS\t+= $(call cc-option,-fmacro-prefix-map=$(srctree)/=)\n KBUILD_CFLAGS\t+= -fno-asynchronous-unwind-tables\n KBUILD_CFLAGS\t+= $(CONFIG_CC_IMPLICIT_FALLTHROUGH)\n+KBUILD_CFLAGS_KERNEL :=\n \n $(obj)/bzImage: asflags-y  := $(SVGA_MODE)\n \ndiff --git a/arch/x86/boot/compressed/Makefile b/arch/x86/boot/compressed/Makefile\nindex f2051644de94..c362d36b5b69 100644\n--- a/arch/x86/boot/compressed/Makefile\n+++ b/arch/x86/boot/compressed/Makefile\n@@ -73,7 +73,7 @@ LDFLAGS_vmlinux += -T\n hostprogs\t:= mkpiggy\n HOST_EXTRACFLAGS += -I$(srctree)/tools/include\n \n-sed-voffset := -e 's/^\\([0-9a-fA-F]*\\) [ABCDGRSTVW] \\(_text\\|__start_rodata\\|__bss_start\\|_end\\)$$/\\#define VO_\\2 _AC(0x\\1,UL)/p'\n+sed-voffset := -e 's/^\\([0-9a-fA-F]*\\) [ABbCDdGRSTtVW] \\(_text\\|__start_rodata\\|__bss_start\\|_end\\)$$/\\#define VO_\\2 _AC(0x\\1,UL)/p'\n \n quiet_cmd_voffset = VOFFSET $@\n       cmd_voffset = $(NM) $< | sed -n $(sed-voffset) > $@\ndiff --git a/arch/x86/entry/vdso/Makefile b/arch/x86/entry/vdso/Makefile\nindex c9216ac4fb1e..7af9fecf9abb 100644\n--- a/arch/x86/entry/vdso/Makefile\n+++ b/arch/x86/entry/vdso/Makefile\n@@ -141,6 +141,7 @@ endif\n endif\n \n $(obj)/vdso32.so.dbg: KBUILD_CFLAGS = $(KBUILD_CFLAGS_32)\n+$(obj)/vdso32.so.dbg: KBUILD_CFLAGS_KERNEL :=\n \n $(obj)/vdso32.so.dbg: $(obj)/vdso32/vdso32.lds $(vobjs32) FORCE\n \t$(call if_changed,vdso_and_check)\ndiff --git a/arch/x86/realmode/rm/Makefile b/arch/x86/realmode/rm/Makefile\nindex a0fb39abc5c8..70bf0a26da91 100644\n--- a/arch/x86/realmode/rm/Makefile\n+++ b/arch/x86/realmode/rm/Makefile\n@@ -67,3 +67,4 @@ KBUILD_CFLAGS\t:= $(REALMODE_CFLAGS) -D_SETUP -D_WAKEUP \\\n \t\t   -I$(srctree)/arch/x86/boot\n KBUILD_AFLAGS\t:= $(KBUILD_CFLAGS) -D__ASSEMBLY__\n KBUILD_CFLAGS\t+= -fno-asynchronous-unwind-tables\n+KBUILD_CFLAGS_KERNEL :=\ndiff --git a/include/asm-generic/vmlinux.lds.h b/include/asm-generic/vmlinux.lds.h\nindex 2b079f73820f..3a084ac77109 100644\n--- a/include/asm-generic/vmlinux.lds.h\n+++ b/include/asm-generic/vmlinux.lds.h\n@@ -349,6 +349,7 @@\n \t*(DATA_MAIN)\t\t\t\t\t\t\t\\\n \t*(.data..decrypted)\t\t\t\t\t\t\\\n \t*(.ref.data)\t\t\t\t\t\t\t\\\n+\t*(.data.rel*)\t\t\t\t\t\t\t\\\n \t*(.data..shared_aligned) /* percpu related */\t\t\t\\\n \t*(.data.unlikely)\t\t\t\t\t\t\\\n \t__start_once = .;\t\t\t\t\t\t\\\n-- \n2.46.0.792.g87dc391469-goog\n\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/10/172820189521417.mbox",
          "message_id": "<CAFULd4ZZxrJvJ9gF5tC-m-tmcDMvVM3te4xc7vnbF_OFU0D2=A () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 08:06:33+00:00",
          "date_str": "Sun, 06 Oct 2024 08:06:33 +0000",
          "body": "On Sun, Oct 6, 2024 at 2:00=E2=80=AFAM Linus Torvalds\n<torvalds@linux-foundation.org> wrote:\n>\n> On Sat, 5 Oct 2024 at 16:37, H. Peter Anvin <hpa@zytor.com> wrote:\n> >\n> > Sadly, that is not correct; neither gcc nor clang uses lea:\n>\n> Looking around, this may be intentional. At least according to Agner,\n> several cores do better at \"mov immediate\" compared to \"lea\".\n>\n> Eg a RIP-relative LEA on Zen 2 gets a throughput of two per cycle, but\n> a \"MOV r,i\" gets four. That got fixed in Zen 3 and later, but\n> apparently Intel had similar issues (Ivy Bridge: 1 LEA per cycle, vs 3\n> \"mov i,r\". Haswell is 1:4).\n\nYes, this is the case. I just missed your reply when replying to\nPeter's mail with a not so precise answer.\n\nUros.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172820189821421.mbox",
          "message_id": "<CAFULd4ZZxrJvJ9gF5tC-m-tmcDMvVM3te4xc7vnbF_OFU0D2=A () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 08:06:33+00:00",
          "date_str": "Sun, 06 Oct 2024 08:06:33 +0000",
          "body": "On Sun, Oct 6, 2024 at 2:00=E2=80=AFAM Linus Torvalds\n<torvalds@linux-foundation.org> wrote:\n>\n> On Sat, 5 Oct 2024 at 16:37, H. Peter Anvin <hpa@zytor.com> wrote:\n> >\n> > Sadly, that is not correct; neither gcc nor clang uses lea:\n>\n> Looking around, this may be intentional. At least according to Agner,\n> several cores do better at \"mov immediate\" compared to \"lea\".\n>\n> Eg a RIP-relative LEA on Zen 2 gets a throughput of two per cycle, but\n> a \"MOV r,i\" gets four. That got fixed in Zen 3 and later, but\n> apparently Intel had similar issues (Ivy Bridge: 1 LEA per cycle, vs 3\n> \"mov i,r\". Haswell is 1:4).\n\nYes, this is the case. I just missed your reply when replying to\nPeter's mail with a not so precise answer.\n\nUros.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172823754703032.mbox",
          "message_id": "<bfa1a86c3e4348159049e8277e9859dd () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 17:59:07+00:00",
          "date_str": "Sun, 06 Oct 2024 17:59:07 +0000",
          "body": "Li4uDQo+IER1ZSB0byB0aGUgbm9uLW5lZ2xpZ2libGUgaW1wYWN0IG9mIFBJRSwgcGVyaGFwcyBz\nb21lIGtpbmQgb2YNCj4gQ09ORklHX1BJRSBjb25maWcgZGVmaW5pdGlvbiBzaG91bGQgYmUgaW50\ncm9kdWNlZCwgc28gdGhlIGFzc2VtYmx5DQo+IGNvZGUgd291bGQgYmUgYWJsZSB0byBjaG9vc2Ug\nb3B0aW1hbCBhc20gc2VxdWVuY2Ugd2hlbiBQSUUgYW5kIG5vbi1QSUUNCj4gaXMgcmVxdWVzdGVk\nPw0KDQpJIHdvdWxkbid0IGhhdmUgdGhvdWdodCB0aGF0IHBlcmZvcm1hbmNlIG1hdHRlcmVkIGlu\nIHRoZSBhc20gY29kZQ0KdGhhdCBydW5zIGR1cmluZyBzdGFydHVwPw0KDQpXaGlsZSB4ODYtODQg\nY29kZSAoaWdub3JpbmcgZGF0YSByZWZlcmVuY2VzKSBpcyBwcmV0dHkgbXVjaCBhbHdheXMNCnBv\nc2l0aW9uIGluZGVwZW5kZW50LCB0aGUgc2FtZSBpc24ndCB0cnVlIG9mIGFsbCBhcmNoaXRlY3R1\ncmVzLg0KU29tZSAoYXQgbGVhc3QgTmlvcy1JSSkgb25seSBoYXZlIGFic29sdXRlIGNhbGwgaW5z\ndHJ1Y3Rpb25zLg0KU28geW91IGNhbid0IHJlYWxseSBtb3ZlIHRvIHBpYyBjb2RlIGdsb2JhbGx5\nLg0KDQpZb3UnZCBhbHNvIHdhbnQgJ2JhZCcgcGljIGNvZGUgdGhhdCBjb250YWluZWQgc29tZSBm\naXh1cHMgdGhhdA0KbmVlZGVkIHRoZSBjb2RlIHBhdGNoaW5nLg0KKFdoaWNoIHlvdSByZWFsbHkg\nZG9uJ3Qgd2FudCBmb3IgYSBzaGFyZWQgbGlicmFyeS4pDQpPdGhlcndpc2UgeW91IGdldCBhbiBl\neHRyYSBpbnN0cnVjdGlvbiBmb3Igbm9uLXRyaXZpYWwgZGF0YQ0KYWNjZXNzZXMuDQoNClRoaW5r\naW5nLi4uLg0KRG9lc24ndCB0aGUgY29kZSBnZW5lcmF0ZWQgZm9yIC1mcGljIGFzc3VtZSB0aGF0\nIHRoZSBkeW5hbWljIGxvYWRlcg0KaGFzIHByb2Nlc3NlZCB0aGUgcmVsb2NhdGlvbnMgYmVmb3Jl\nIGl0IGlzIHJ1bj8NCkJ1dCB0aGUga2VybmVsIHN0YXJ0dXAgY29kZSBpcyBydW5uaW5nIGJlZm9y\nZSB0aGV5IGNhbiBoYXZlIGJlZW4gZG9uZT8NClNvIGV2ZW4gaWYgdGhhdCBDIGNvZGUgd2VyZSAn\ncGljJyBpdCBjb3VsZCBzdGlsbCBjb250YWluIHRoaW5ncyB0aGF0DQphcmUgaW52YWxpZCAocHJv\nYmFibHkgYXJyYXlzIG9mIHBvaW50ZXJzPykuDQpTbyB5b3UgbG9zZSBvbmUgc2V0IG9mIGJ1Z3Mg\nYW5kIGdhaW4gYW5vdGhlci4NCg0KCURhdmlkDQoNCi0NClJlZ2lzdGVyZWQgQWRkcmVzcyBMYWtl\nc2lkZSwgQnJhbWxleSBSb2FkLCBNb3VudCBGYXJtLCBNaWx0b24gS2V5bmVzLCBNSzEgMVBULCBV\nSw0KUmVnaXN0cmF0aW9uIE5vOiAxMzk3Mzg2IChXYWxlcykNCg==\n\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172823754803035.mbox",
          "message_id": "<bfa1a86c3e4348159049e8277e9859dd () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 17:59:08+00:00",
          "date_str": "Sun, 06 Oct 2024 17:59:08 +0000",
          "body": "Li4uDQo+IER1ZSB0byB0aGUgbm9uLW5lZ2xpZ2libGUgaW1wYWN0IG9mIFBJRSwgcGVyaGFwcyBz\nb21lIGtpbmQgb2YNCj4gQ09ORklHX1BJRSBjb25maWcgZGVmaW5pdGlvbiBzaG91bGQgYmUgaW50\ncm9kdWNlZCwgc28gdGhlIGFzc2VtYmx5DQo+IGNvZGUgd291bGQgYmUgYWJsZSB0byBjaG9vc2Ug\nb3B0aW1hbCBhc20gc2VxdWVuY2Ugd2hlbiBQSUUgYW5kIG5vbi1QSUUNCj4gaXMgcmVxdWVzdGVk\nPw0KDQpJIHdvdWxkbid0IGhhdmUgdGhvdWdodCB0aGF0IHBlcmZvcm1hbmNlIG1hdHRlcmVkIGlu\nIHRoZSBhc20gY29kZQ0KdGhhdCBydW5zIGR1cmluZyBzdGFydHVwPw0KDQpXaGlsZSB4ODYtODQg\nY29kZSAoaWdub3JpbmcgZGF0YSByZWZlcmVuY2VzKSBpcyBwcmV0dHkgbXVjaCBhbHdheXMNCnBv\nc2l0aW9uIGluZGVwZW5kZW50LCB0aGUgc2FtZSBpc24ndCB0cnVlIG9mIGFsbCBhcmNoaXRlY3R1\ncmVzLg0KU29tZSAoYXQgbGVhc3QgTmlvcy1JSSkgb25seSBoYXZlIGFic29sdXRlIGNhbGwgaW5z\ndHJ1Y3Rpb25zLg0KU28geW91IGNhbid0IHJlYWxseSBtb3ZlIHRvIHBpYyBjb2RlIGdsb2JhbGx5\nLg0KDQpZb3UnZCBhbHNvIHdhbnQgJ2JhZCcgcGljIGNvZGUgdGhhdCBjb250YWluZWQgc29tZSBm\naXh1cHMgdGhhdA0KbmVlZGVkIHRoZSBjb2RlIHBhdGNoaW5nLg0KKFdoaWNoIHlvdSByZWFsbHkg\nZG9uJ3Qgd2FudCBmb3IgYSBzaGFyZWQgbGlicmFyeS4pDQpPdGhlcndpc2UgeW91IGdldCBhbiBl\neHRyYSBpbnN0cnVjdGlvbiBmb3Igbm9uLXRyaXZpYWwgZGF0YQ0KYWNjZXNzZXMuDQoNClRoaW5r\naW5nLi4uLg0KRG9lc24ndCB0aGUgY29kZSBnZW5lcmF0ZWQgZm9yIC1mcGljIGFzc3VtZSB0aGF0\nIHRoZSBkeW5hbWljIGxvYWRlcg0KaGFzIHByb2Nlc3NlZCB0aGUgcmVsb2NhdGlvbnMgYmVmb3Jl\nIGl0IGlzIHJ1bj8NCkJ1dCB0aGUga2VybmVsIHN0YXJ0dXAgY29kZSBpcyBydW5uaW5nIGJlZm9y\nZSB0aGV5IGNhbiBoYXZlIGJlZW4gZG9uZT8NClNvIGV2ZW4gaWYgdGhhdCBDIGNvZGUgd2VyZSAn\ncGljJyBpdCBjb3VsZCBzdGlsbCBjb250YWluIHRoaW5ncyB0aGF0DQphcmUgaW52YWxpZCAocHJv\nYmFibHkgYXJyYXlzIG9mIHBvaW50ZXJzPykuDQpTbyB5b3UgbG9zZSBvbmUgc2V0IG9mIGJ1Z3Mg\nYW5kIGdhaW4gYW5vdGhlci4NCg0KCURhdmlkDQoNCi0NClJlZ2lzdGVyZWQgQWRkcmVzcyBMYWtl\nc2lkZSwgQnJhbWxleSBSb2FkLCBNb3VudCBGYXJtLCBNaWx0b24gS2V5bmVzLCBNSzEgMVBULCBV\nSw0KUmVnaXN0cmF0aW9uIE5vOiAxMzk3Mzg2IChXYWxlcykNCg==\n\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172823754903038.mbox",
          "message_id": "<bfa1a86c3e4348159049e8277e9859dd () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 17:59:09+00:00",
          "date_str": "Sun, 06 Oct 2024 17:59:09 +0000",
          "body": "Li4uDQo+IER1ZSB0byB0aGUgbm9uLW5lZ2xpZ2libGUgaW1wYWN0IG9mIFBJRSwgcGVyaGFwcyBz\nb21lIGtpbmQgb2YNCj4gQ09ORklHX1BJRSBjb25maWcgZGVmaW5pdGlvbiBzaG91bGQgYmUgaW50\ncm9kdWNlZCwgc28gdGhlIGFzc2VtYmx5DQo+IGNvZGUgd291bGQgYmUgYWJsZSB0byBjaG9vc2Ug\nb3B0aW1hbCBhc20gc2VxdWVuY2Ugd2hlbiBQSUUgYW5kIG5vbi1QSUUNCj4gaXMgcmVxdWVzdGVk\nPw0KDQpJIHdvdWxkbid0IGhhdmUgdGhvdWdodCB0aGF0IHBlcmZvcm1hbmNlIG1hdHRlcmVkIGlu\nIHRoZSBhc20gY29kZQ0KdGhhdCBydW5zIGR1cmluZyBzdGFydHVwPw0KDQpXaGlsZSB4ODYtODQg\nY29kZSAoaWdub3JpbmcgZGF0YSByZWZlcmVuY2VzKSBpcyBwcmV0dHkgbXVjaCBhbHdheXMNCnBv\nc2l0aW9uIGluZGVwZW5kZW50LCB0aGUgc2FtZSBpc24ndCB0cnVlIG9mIGFsbCBhcmNoaXRlY3R1\ncmVzLg0KU29tZSAoYXQgbGVhc3QgTmlvcy1JSSkgb25seSBoYXZlIGFic29sdXRlIGNhbGwgaW5z\ndHJ1Y3Rpb25zLg0KU28geW91IGNhbid0IHJlYWxseSBtb3ZlIHRvIHBpYyBjb2RlIGdsb2JhbGx5\nLg0KDQpZb3UnZCBhbHNvIHdhbnQgJ2JhZCcgcGljIGNvZGUgdGhhdCBjb250YWluZWQgc29tZSBm\naXh1cHMgdGhhdA0KbmVlZGVkIHRoZSBjb2RlIHBhdGNoaW5nLg0KKFdoaWNoIHlvdSByZWFsbHkg\nZG9uJ3Qgd2FudCBmb3IgYSBzaGFyZWQgbGlicmFyeS4pDQpPdGhlcndpc2UgeW91IGdldCBhbiBl\neHRyYSBpbnN0cnVjdGlvbiBmb3Igbm9uLXRyaXZpYWwgZGF0YQ0KYWNjZXNzZXMuDQoNClRoaW5r\naW5nLi4uLg0KRG9lc24ndCB0aGUgY29kZSBnZW5lcmF0ZWQgZm9yIC1mcGljIGFzc3VtZSB0aGF0\nIHRoZSBkeW5hbWljIGxvYWRlcg0KaGFzIHByb2Nlc3NlZCB0aGUgcmVsb2NhdGlvbnMgYmVmb3Jl\nIGl0IGlzIHJ1bj8NCkJ1dCB0aGUga2VybmVsIHN0YXJ0dXAgY29kZSBpcyBydW5uaW5nIGJlZm9y\nZSB0aGV5IGNhbiBoYXZlIGJlZW4gZG9uZT8NClNvIGV2ZW4gaWYgdGhhdCBDIGNvZGUgd2VyZSAn\ncGljJyBpdCBjb3VsZCBzdGlsbCBjb250YWluIHRoaW5ncyB0aGF0DQphcmUgaW52YWxpZCAocHJv\nYmFibHkgYXJyYXlzIG9mIHBvaW50ZXJzPykuDQpTbyB5b3UgbG9zZSBvbmUgc2V0IG9mIGJ1Z3Mg\nYW5kIGdhaW4gYW5vdGhlci4NCg0KCURhdmlkDQoNCi0NClJlZ2lzdGVyZWQgQWRkcmVzcyBMYWtl\nc2lkZSwgQnJhbWxleSBSb2FkLCBNb3VudCBGYXJtLCBNaWx0b24gS2V5bmVzLCBNSzEgMVBULCBV\nSw0KUmVnaXN0cmF0aW9uIE5vOiAxMzk3Mzg2IChXYWxlcykNCg==\n\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172823755103048.mbox",
          "message_id": "<bfa1a86c3e4348159049e8277e9859dd () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 17:59:11+00:00",
          "date_str": "Sun, 06 Oct 2024 17:59:11 +0000",
          "body": "Li4uDQo+IER1ZSB0byB0aGUgbm9uLW5lZ2xpZ2libGUgaW1wYWN0IG9mIFBJRSwgcGVyaGFwcyBz\nb21lIGtpbmQgb2YNCj4gQ09ORklHX1BJRSBjb25maWcgZGVmaW5pdGlvbiBzaG91bGQgYmUgaW50\ncm9kdWNlZCwgc28gdGhlIGFzc2VtYmx5DQo+IGNvZGUgd291bGQgYmUgYWJsZSB0byBjaG9vc2Ug\nb3B0aW1hbCBhc20gc2VxdWVuY2Ugd2hlbiBQSUUgYW5kIG5vbi1QSUUNCj4gaXMgcmVxdWVzdGVk\nPw0KDQpJIHdvdWxkbid0IGhhdmUgdGhvdWdodCB0aGF0IHBlcmZvcm1hbmNlIG1hdHRlcmVkIGlu\nIHRoZSBhc20gY29kZQ0KdGhhdCBydW5zIGR1cmluZyBzdGFydHVwPw0KDQpXaGlsZSB4ODYtODQg\nY29kZSAoaWdub3JpbmcgZGF0YSByZWZlcmVuY2VzKSBpcyBwcmV0dHkgbXVjaCBhbHdheXMNCnBv\nc2l0aW9uIGluZGVwZW5kZW50LCB0aGUgc2FtZSBpc24ndCB0cnVlIG9mIGFsbCBhcmNoaXRlY3R1\ncmVzLg0KU29tZSAoYXQgbGVhc3QgTmlvcy1JSSkgb25seSBoYXZlIGFic29sdXRlIGNhbGwgaW5z\ndHJ1Y3Rpb25zLg0KU28geW91IGNhbid0IHJlYWxseSBtb3ZlIHRvIHBpYyBjb2RlIGdsb2JhbGx5\nLg0KDQpZb3UnZCBhbHNvIHdhbnQgJ2JhZCcgcGljIGNvZGUgdGhhdCBjb250YWluZWQgc29tZSBm\naXh1cHMgdGhhdA0KbmVlZGVkIHRoZSBjb2RlIHBhdGNoaW5nLg0KKFdoaWNoIHlvdSByZWFsbHkg\nZG9uJ3Qgd2FudCBmb3IgYSBzaGFyZWQgbGlicmFyeS4pDQpPdGhlcndpc2UgeW91IGdldCBhbiBl\neHRyYSBpbnN0cnVjdGlvbiBmb3Igbm9uLXRyaXZpYWwgZGF0YQ0KYWNjZXNzZXMuDQoNClRoaW5r\naW5nLi4uLg0KRG9lc24ndCB0aGUgY29kZSBnZW5lcmF0ZWQgZm9yIC1mcGljIGFzc3VtZSB0aGF0\nIHRoZSBkeW5hbWljIGxvYWRlcg0KaGFzIHByb2Nlc3NlZCB0aGUgcmVsb2NhdGlvbnMgYmVmb3Jl\nIGl0IGlzIHJ1bj8NCkJ1dCB0aGUga2VybmVsIHN0YXJ0dXAgY29kZSBpcyBydW5uaW5nIGJlZm9y\nZSB0aGV5IGNhbiBoYXZlIGJlZW4gZG9uZT8NClNvIGV2ZW4gaWYgdGhhdCBDIGNvZGUgd2VyZSAn\ncGljJyBpdCBjb3VsZCBzdGlsbCBjb250YWluIHRoaW5ncyB0aGF0DQphcmUgaW52YWxpZCAocHJv\nYmFibHkgYXJyYXlzIG9mIHBvaW50ZXJzPykuDQpTbyB5b3UgbG9zZSBvbmUgc2V0IG9mIGJ1Z3Mg\nYW5kIGdhaW4gYW5vdGhlci4NCg0KCURhdmlkDQoNCi0NClJlZ2lzdGVyZWQgQWRkcmVzcyBMYWtl\nc2lkZSwgQnJhbWxleSBSb2FkLCBNb3VudCBGYXJtLCBNaWx0b24gS2V5bmVzLCBNSzEgMVBULCBV\nSw0KUmVnaXN0cmF0aW9uIE5vOiAxMzk3Mzg2IChXYWxlcykNCg==\n\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172823755103047.mbox",
          "message_id": "<bfa1a86c3e4348159049e8277e9859dd () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 17:59:11+00:00",
          "date_str": "Sun, 06 Oct 2024 17:59:11 +0000",
          "body": "Li4uDQo+IER1ZSB0byB0aGUgbm9uLW5lZ2xpZ2libGUgaW1wYWN0IG9mIFBJRSwgcGVyaGFwcyBz\nb21lIGtpbmQgb2YNCj4gQ09ORklHX1BJRSBjb25maWcgZGVmaW5pdGlvbiBzaG91bGQgYmUgaW50\ncm9kdWNlZCwgc28gdGhlIGFzc2VtYmx5DQo+IGNvZGUgd291bGQgYmUgYWJsZSB0byBjaG9vc2Ug\nb3B0aW1hbCBhc20gc2VxdWVuY2Ugd2hlbiBQSUUgYW5kIG5vbi1QSUUNCj4gaXMgcmVxdWVzdGVk\nPw0KDQpJIHdvdWxkbid0IGhhdmUgdGhvdWdodCB0aGF0IHBlcmZvcm1hbmNlIG1hdHRlcmVkIGlu\nIHRoZSBhc20gY29kZQ0KdGhhdCBydW5zIGR1cmluZyBzdGFydHVwPw0KDQpXaGlsZSB4ODYtODQg\nY29kZSAoaWdub3JpbmcgZGF0YSByZWZlcmVuY2VzKSBpcyBwcmV0dHkgbXVjaCBhbHdheXMNCnBv\nc2l0aW9uIGluZGVwZW5kZW50LCB0aGUgc2FtZSBpc24ndCB0cnVlIG9mIGFsbCBhcmNoaXRlY3R1\ncmVzLg0KU29tZSAoYXQgbGVhc3QgTmlvcy1JSSkgb25seSBoYXZlIGFic29sdXRlIGNhbGwgaW5z\ndHJ1Y3Rpb25zLg0KU28geW91IGNhbid0IHJlYWxseSBtb3ZlIHRvIHBpYyBjb2RlIGdsb2JhbGx5\nLg0KDQpZb3UnZCBhbHNvIHdhbnQgJ2JhZCcgcGljIGNvZGUgdGhhdCBjb250YWluZWQgc29tZSBm\naXh1cHMgdGhhdA0KbmVlZGVkIHRoZSBjb2RlIHBhdGNoaW5nLg0KKFdoaWNoIHlvdSByZWFsbHkg\nZG9uJ3Qgd2FudCBmb3IgYSBzaGFyZWQgbGlicmFyeS4pDQpPdGhlcndpc2UgeW91IGdldCBhbiBl\neHRyYSBpbnN0cnVjdGlvbiBmb3Igbm9uLXRyaXZpYWwgZGF0YQ0KYWNjZXNzZXMuDQoNClRoaW5r\naW5nLi4uLg0KRG9lc24ndCB0aGUgY29kZSBnZW5lcmF0ZWQgZm9yIC1mcGljIGFzc3VtZSB0aGF0\nIHRoZSBkeW5hbWljIGxvYWRlcg0KaGFzIHByb2Nlc3NlZCB0aGUgcmVsb2NhdGlvbnMgYmVmb3Jl\nIGl0IGlzIHJ1bj8NCkJ1dCB0aGUga2VybmVsIHN0YXJ0dXAgY29kZSBpcyBydW5uaW5nIGJlZm9y\nZSB0aGV5IGNhbiBoYXZlIGJlZW4gZG9uZT8NClNvIGV2ZW4gaWYgdGhhdCBDIGNvZGUgd2VyZSAn\ncGljJyBpdCBjb3VsZCBzdGlsbCBjb250YWluIHRoaW5ncyB0aGF0DQphcmUgaW52YWxpZCAocHJv\nYmFibHkgYXJyYXlzIG9mIHBvaW50ZXJzPykuDQpTbyB5b3UgbG9zZSBvbmUgc2V0IG9mIGJ1Z3Mg\nYW5kIGdhaW4gYW5vdGhlci4NCg0KCURhdmlkDQoNCi0NClJlZ2lzdGVyZWQgQWRkcmVzcyBMYWtl\nc2lkZSwgQnJhbWxleSBSb2FkLCBNb3VudCBGYXJtLCBNaWx0b24gS2V5bmVzLCBNSzEgMVBULCBV\nSw0KUmVnaXN0cmF0aW9uIE5vOiAxMzk3Mzg2IChXYWxlcykNCg==\n\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172823755903051.mbox",
          "message_id": "<bfa1a86c3e4348159049e8277e9859dd () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 17:59:19+00:00",
          "date_str": "Sun, 06 Oct 2024 17:59:19 +0000",
          "body": "Li4uDQo+IER1ZSB0byB0aGUgbm9uLW5lZ2xpZ2libGUgaW1wYWN0IG9mIFBJRSwgcGVyaGFwcyBz\nb21lIGtpbmQgb2YNCj4gQ09ORklHX1BJRSBjb25maWcgZGVmaW5pdGlvbiBzaG91bGQgYmUgaW50\ncm9kdWNlZCwgc28gdGhlIGFzc2VtYmx5DQo+IGNvZGUgd291bGQgYmUgYWJsZSB0byBjaG9vc2Ug\nb3B0aW1hbCBhc20gc2VxdWVuY2Ugd2hlbiBQSUUgYW5kIG5vbi1QSUUNCj4gaXMgcmVxdWVzdGVk\nPw0KDQpJIHdvdWxkbid0IGhhdmUgdGhvdWdodCB0aGF0IHBlcmZvcm1hbmNlIG1hdHRlcmVkIGlu\nIHRoZSBhc20gY29kZQ0KdGhhdCBydW5zIGR1cmluZyBzdGFydHVwPw0KDQpXaGlsZSB4ODYtODQg\nY29kZSAoaWdub3JpbmcgZGF0YSByZWZlcmVuY2VzKSBpcyBwcmV0dHkgbXVjaCBhbHdheXMNCnBv\nc2l0aW9uIGluZGVwZW5kZW50LCB0aGUgc2FtZSBpc24ndCB0cnVlIG9mIGFsbCBhcmNoaXRlY3R1\ncmVzLg0KU29tZSAoYXQgbGVhc3QgTmlvcy1JSSkgb25seSBoYXZlIGFic29sdXRlIGNhbGwgaW5z\ndHJ1Y3Rpb25zLg0KU28geW91IGNhbid0IHJlYWxseSBtb3ZlIHRvIHBpYyBjb2RlIGdsb2JhbGx5\nLg0KDQpZb3UnZCBhbHNvIHdhbnQgJ2JhZCcgcGljIGNvZGUgdGhhdCBjb250YWluZWQgc29tZSBm\naXh1cHMgdGhhdA0KbmVlZGVkIHRoZSBjb2RlIHBhdGNoaW5nLg0KKFdoaWNoIHlvdSByZWFsbHkg\nZG9uJ3Qgd2FudCBmb3IgYSBzaGFyZWQgbGlicmFyeS4pDQpPdGhlcndpc2UgeW91IGdldCBhbiBl\neHRyYSBpbnN0cnVjdGlvbiBmb3Igbm9uLXRyaXZpYWwgZGF0YQ0KYWNjZXNzZXMuDQoNClRoaW5r\naW5nLi4uLg0KRG9lc24ndCB0aGUgY29kZSBnZW5lcmF0ZWQgZm9yIC1mcGljIGFzc3VtZSB0aGF0\nIHRoZSBkeW5hbWljIGxvYWRlcg0KaGFzIHByb2Nlc3NlZCB0aGUgcmVsb2NhdGlvbnMgYmVmb3Jl\nIGl0IGlzIHJ1bj8NCkJ1dCB0aGUga2VybmVsIHN0YXJ0dXAgY29kZSBpcyBydW5uaW5nIGJlZm9y\nZSB0aGV5IGNhbiBoYXZlIGJlZW4gZG9uZT8NClNvIGV2ZW4gaWYgdGhhdCBDIGNvZGUgd2VyZSAn\ncGljJyBpdCBjb3VsZCBzdGlsbCBjb250YWluIHRoaW5ncyB0aGF0DQphcmUgaW52YWxpZCAocHJv\nYmFibHkgYXJyYXlzIG9mIHBvaW50ZXJzPykuDQpTbyB5b3UgbG9zZSBvbmUgc2V0IG9mIGJ1Z3Mg\nYW5kIGdhaW4gYW5vdGhlci4NCg0KCURhdmlkDQoNCi0NClJlZ2lzdGVyZWQgQWRkcmVzcyBMYWtl\nc2lkZSwgQnJhbWxleSBSb2FkLCBNb3VudCBGYXJtLCBNaWx0b24gS2V5bmVzLCBNSzEgMVBULCBV\nSw0KUmVnaXN0cmF0aW9uIE5vOiAxMzk3Mzg2IChXYWxlcykNCg==\n\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172823756003056.mbox",
          "message_id": "<bfa1a86c3e4348159049e8277e9859dd () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 17:59:20+00:00",
          "date_str": "Sun, 06 Oct 2024 17:59:20 +0000",
          "body": "Li4uDQo+IER1ZSB0byB0aGUgbm9uLW5lZ2xpZ2libGUgaW1wYWN0IG9mIFBJRSwgcGVyaGFwcyBz\nb21lIGtpbmQgb2YNCj4gQ09ORklHX1BJRSBjb25maWcgZGVmaW5pdGlvbiBzaG91bGQgYmUgaW50\ncm9kdWNlZCwgc28gdGhlIGFzc2VtYmx5DQo+IGNvZGUgd291bGQgYmUgYWJsZSB0byBjaG9vc2Ug\nb3B0aW1hbCBhc20gc2VxdWVuY2Ugd2hlbiBQSUUgYW5kIG5vbi1QSUUNCj4gaXMgcmVxdWVzdGVk\nPw0KDQpJIHdvdWxkbid0IGhhdmUgdGhvdWdodCB0aGF0IHBlcmZvcm1hbmNlIG1hdHRlcmVkIGlu\nIHRoZSBhc20gY29kZQ0KdGhhdCBydW5zIGR1cmluZyBzdGFydHVwPw0KDQpXaGlsZSB4ODYtODQg\nY29kZSAoaWdub3JpbmcgZGF0YSByZWZlcmVuY2VzKSBpcyBwcmV0dHkgbXVjaCBhbHdheXMNCnBv\nc2l0aW9uIGluZGVwZW5kZW50LCB0aGUgc2FtZSBpc24ndCB0cnVlIG9mIGFsbCBhcmNoaXRlY3R1\ncmVzLg0KU29tZSAoYXQgbGVhc3QgTmlvcy1JSSkgb25seSBoYXZlIGFic29sdXRlIGNhbGwgaW5z\ndHJ1Y3Rpb25zLg0KU28geW91IGNhbid0IHJlYWxseSBtb3ZlIHRvIHBpYyBjb2RlIGdsb2JhbGx5\nLg0KDQpZb3UnZCBhbHNvIHdhbnQgJ2JhZCcgcGljIGNvZGUgdGhhdCBjb250YWluZWQgc29tZSBm\naXh1cHMgdGhhdA0KbmVlZGVkIHRoZSBjb2RlIHBhdGNoaW5nLg0KKFdoaWNoIHlvdSByZWFsbHkg\nZG9uJ3Qgd2FudCBmb3IgYSBzaGFyZWQgbGlicmFyeS4pDQpPdGhlcndpc2UgeW91IGdldCBhbiBl\neHRyYSBpbnN0cnVjdGlvbiBmb3Igbm9uLXRyaXZpYWwgZGF0YQ0KYWNjZXNzZXMuDQoNClRoaW5r\naW5nLi4uLg0KRG9lc24ndCB0aGUgY29kZSBnZW5lcmF0ZWQgZm9yIC1mcGljIGFzc3VtZSB0aGF0\nIHRoZSBkeW5hbWljIGxvYWRlcg0KaGFzIHByb2Nlc3NlZCB0aGUgcmVsb2NhdGlvbnMgYmVmb3Jl\nIGl0IGlzIHJ1bj8NCkJ1dCB0aGUga2VybmVsIHN0YXJ0dXAgY29kZSBpcyBydW5uaW5nIGJlZm9y\nZSB0aGV5IGNhbiBoYXZlIGJlZW4gZG9uZT8NClNvIGV2ZW4gaWYgdGhhdCBDIGNvZGUgd2VyZSAn\ncGljJyBpdCBjb3VsZCBzdGlsbCBjb250YWluIHRoaW5ncyB0aGF0DQphcmUgaW52YWxpZCAocHJv\nYmFibHkgYXJyYXlzIG9mIHBvaW50ZXJzPykuDQpTbyB5b3UgbG9zZSBvbmUgc2V0IG9mIGJ1Z3Mg\nYW5kIGdhaW4gYW5vdGhlci4NCg0KCURhdmlkDQoNCi0NClJlZ2lzdGVyZWQgQWRkcmVzcyBMYWtl\nc2lkZSwgQnJhbWxleSBSb2FkLCBNb3VudCBGYXJtLCBNaWx0b24gS2V5bmVzLCBNSzEgMVBULCBV\nSw0KUmVnaXN0cmF0aW9uIE5vOiAxMzk3Mzg2IChXYWxlcykNCg==\n\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172824215104689.mbox",
          "message_id": "<CAFULd4awNUm8MpZQ6XhPTRs6+2ZLtfnr=6vkK5DrY9L2rGR-5w () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 19:17:40+00:00",
          "date_str": "Sun, 06 Oct 2024 19:17:40 +0000",
          "body": "On Sun, Oct 6, 2024 at 8:01=E2=80=AFPM David Laight <David.Laight@aculab.co=\nm> wrote:\n>\n> ...\n> > Due to the non-negligible impact of PIE, perhaps some kind of\n> > CONFIG_PIE config definition should be introduced, so the assembly\n> > code would be able to choose optimal asm sequence when PIE and non-PIE\n> > is requested?\n>\n> I wouldn't have thought that performance mattered in the asm code\n> that runs during startup?\n\nNo, not the code that runs only once, where performance impact can be toler=\nated.\n\nThis one:\n\nhttps://lore.kernel.org/lkml/20240925150059.3955569-44-ardb+git@google.com/\n\nUros.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172824216404714.mbox",
          "message_id": "<CAFULd4awNUm8MpZQ6XhPTRs6+2ZLtfnr=6vkK5DrY9L2rGR-5w () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 19:17:40+00:00",
          "date_str": "Sun, 06 Oct 2024 19:17:40 +0000",
          "body": "On Sun, Oct 6, 2024 at 8:01=E2=80=AFPM David Laight <David.Laight@aculab.co=\nm> wrote:\n>\n> ...\n> > Due to the non-negligible impact of PIE, perhaps some kind of\n> > CONFIG_PIE config definition should be introduced, so the assembly\n> > code would be able to choose optimal asm sequence when PIE and non-PIE\n> > is requested?\n>\n> I wouldn't have thought that performance mattered in the asm code\n> that runs during startup?\n\nNo, not the code that runs only once, where performance impact can be toler=\nated.\n\nThis one:\n\nhttps://lore.kernel.org/lkml/20240925150059.3955569-44-ardb+git@google.com/\n\nUros.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172824215404701.mbox",
          "message_id": "<CAFULd4awNUm8MpZQ6XhPTRs6+2ZLtfnr=6vkK5DrY9L2rGR-5w () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 19:17:40+00:00",
          "date_str": "Sun, 06 Oct 2024 19:17:40 +0000",
          "body": "On Sun, Oct 6, 2024 at 8:01=E2=80=AFPM David Laight <David.Laight@aculab.co=\nm> wrote:\n>\n> ...\n> > Due to the non-negligible impact of PIE, perhaps some kind of\n> > CONFIG_PIE config definition should be introduced, so the assembly\n> > code would be able to choose optimal asm sequence when PIE and non-PIE\n> > is requested?\n>\n> I wouldn't have thought that performance mattered in the asm code\n> that runs during startup?\n\nNo, not the code that runs only once, where performance impact can be toler=\nated.\n\nThis one:\n\nhttps://lore.kernel.org/lkml/20240925150059.3955569-44-ardb+git@google.com/\n\nUros.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172824215604707.mbox",
          "message_id": "<CAFULd4awNUm8MpZQ6XhPTRs6+2ZLtfnr=6vkK5DrY9L2rGR-5w () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 19:17:40+00:00",
          "date_str": "Sun, 06 Oct 2024 19:17:40 +0000",
          "body": "On Sun, Oct 6, 2024 at 8:01=E2=80=AFPM David Laight <David.Laight@aculab.co=\nm> wrote:\n>\n> ...\n> > Due to the non-negligible impact of PIE, perhaps some kind of\n> > CONFIG_PIE config definition should be introduced, so the assembly\n> > code would be able to choose optimal asm sequence when PIE and non-PIE\n> > is requested?\n>\n> I wouldn't have thought that performance mattered in the asm code\n> that runs during startup?\n\nNo, not the code that runs only once, where performance impact can be toler=\nated.\n\nThis one:\n\nhttps://lore.kernel.org/lkml/20240925150059.3955569-44-ardb+git@google.com/\n\nUros.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172824215204695.mbox",
          "message_id": "<CAFULd4awNUm8MpZQ6XhPTRs6+2ZLtfnr=6vkK5DrY9L2rGR-5w () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 19:17:40+00:00",
          "date_str": "Sun, 06 Oct 2024 19:17:40 +0000",
          "body": "On Sun, Oct 6, 2024 at 8:01=E2=80=AFPM David Laight <David.Laight@aculab.co=\nm> wrote:\n>\n> ...\n> > Due to the non-negligible impact of PIE, perhaps some kind of\n> > CONFIG_PIE config definition should be introduced, so the assembly\n> > code would be able to choose optimal asm sequence when PIE and non-PIE\n> > is requested?\n>\n> I wouldn't have thought that performance mattered in the asm code\n> that runs during startup?\n\nNo, not the code that runs only once, where performance impact can be toler=\nated.\n\nThis one:\n\nhttps://lore.kernel.org/lkml/20240925150059.3955569-44-ardb+git@google.com/\n\nUros.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172824216204710.mbox",
          "message_id": "<CAFULd4awNUm8MpZQ6XhPTRs6+2ZLtfnr=6vkK5DrY9L2rGR-5w () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 19:17:40+00:00",
          "date_str": "Sun, 06 Oct 2024 19:17:40 +0000",
          "body": "On Sun, Oct 6, 2024 at 8:01=E2=80=AFPM David Laight <David.Laight@aculab.co=\nm> wrote:\n>\n> ...\n> > Due to the non-negligible impact of PIE, perhaps some kind of\n> > CONFIG_PIE config definition should be introduced, so the assembly\n> > code would be able to choose optimal asm sequence when PIE and non-PIE\n> > is requested?\n>\n> I wouldn't have thought that performance mattered in the asm code\n> that runs during startup?\n\nNo, not the code that runs only once, where performance impact can be toler=\nated.\n\nThis one:\n\nhttps://lore.kernel.org/lkml/20240925150059.3955569-44-ardb+git@google.com/\n\nUros.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172824215204694.mbox",
          "message_id": "<CAFULd4awNUm8MpZQ6XhPTRs6+2ZLtfnr=6vkK5DrY9L2rGR-5w () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 19:17:40+00:00",
          "date_str": "Sun, 06 Oct 2024 19:17:40 +0000",
          "body": "On Sun, Oct 6, 2024 at 8:01=E2=80=AFPM David Laight <David.Laight@aculab.co=\nm> wrote:\n>\n> ...\n> > Due to the non-negligible impact of PIE, perhaps some kind of\n> > CONFIG_PIE config definition should be introduced, so the assembly\n> > code would be able to choose optimal asm sequence when PIE and non-PIE\n> > is requested?\n>\n> I wouldn't have thought that performance mattered in the asm code\n> that runs during startup?\n\nNo, not the code that runs only once, where performance impact can be toler=\nated.\n\nThis one:\n\nhttps://lore.kernel.org/lkml/20240925150059.3955569-44-ardb+git@google.com/\n\nUros.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172824346805143.mbox",
          "message_id": "<2E1160A8-3A0C-45BD-B729-D20EAE97A075 () zytor ! com>",
          "author_name": "H. Peter Anvin",
          "author_email": "hpa () zytor ! com",
          "subject": "Re: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 19:38:52+00:00",
          "date_str": "Sun, 06 Oct 2024 19:38:52 +0000",
          "body": "On October 6, 2024 12:17:40 PM PDT, Uros Bizjak <ubizjak@gmail=2Ecom> wrote=\n:\n>On Sun, Oct 6, 2024 at 8:01=E2=80=AFPM David Laight <David=2ELaight@acula=\nb=2Ecom> wrote:\n>>\n>> =2E=2E=2E\n>> > Due to the non-negligible impact of PIE, perhaps some kind of\n>> > CONFIG_PIE config definition should be introduced, so the assembly\n>> > code would be able to choose optimal asm sequence when PIE and non-PI=\nE\n>> > is requested?\n>>\n>> I wouldn't have thought that performance mattered in the asm code\n>> that runs during startup?\n>\n>No, not the code that runs only once, where performance impact can be tol=\nerated=2E\n>\n>This one:\n>\n>https://lore=2Ekernel=2Eorg/lkml/20240925150059=2E3955569-44-ardb+git@goo=\ngle=2Ecom/\n>\n>Uros=2E\n>\n\nYeah, running the kernel proper as PIE seems like a lose all around=2E The=\n decompressor, ELF stub, etc, are of course a different matter entirely (an=\nd at least the latter can't rely on the small or kernel memory models anywa=\ny=2E)\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172824347505151.mbox",
          "message_id": "<2E1160A8-3A0C-45BD-B729-D20EAE97A075 () zytor ! com>",
          "author_name": "H. Peter Anvin",
          "author_email": "hpa () zytor ! com",
          "subject": "Re: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 19:38:52+00:00",
          "date_str": "Sun, 06 Oct 2024 19:38:52 +0000",
          "body": "On October 6, 2024 12:17:40 PM PDT, Uros Bizjak <ubizjak@gmail=2Ecom> wrote=\n:\n>On Sun, Oct 6, 2024 at 8:01=E2=80=AFPM David Laight <David=2ELaight@acula=\nb=2Ecom> wrote:\n>>\n>> =2E=2E=2E\n>> > Due to the non-negligible impact of PIE, perhaps some kind of\n>> > CONFIG_PIE config definition should be introduced, so the assembly\n>> > code would be able to choose optimal asm sequence when PIE and non-PI=\nE\n>> > is requested?\n>>\n>> I wouldn't have thought that performance mattered in the asm code\n>> that runs during startup?\n>\n>No, not the code that runs only once, where performance impact can be tol=\nerated=2E\n>\n>This one:\n>\n>https://lore=2Ekernel=2Eorg/lkml/20240925150059=2E3955569-44-ardb+git@goo=\ngle=2Ecom/\n>\n>Uros=2E\n>\n\nYeah, running the kernel proper as PIE seems like a lose all around=2E The=\n decompressor, ELF stub, etc, are of course a different matter entirely (an=\nd at least the latter can't rely on the small or kernel memory models anywa=\ny=2E)\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172824346505135.mbox",
          "message_id": "<2E1160A8-3A0C-45BD-B729-D20EAE97A075 () zytor ! com>",
          "author_name": "H. Peter Anvin",
          "author_email": "hpa () zytor ! com",
          "subject": "Re: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 19:38:52+00:00",
          "date_str": "Sun, 06 Oct 2024 19:38:52 +0000",
          "body": "On October 6, 2024 12:17:40 PM PDT, Uros Bizjak <ubizjak@gmail=2Ecom> wrote=\n:\n>On Sun, Oct 6, 2024 at 8:01=E2=80=AFPM David Laight <David=2ELaight@acula=\nb=2Ecom> wrote:\n>>\n>> =2E=2E=2E\n>> > Due to the non-negligible impact of PIE, perhaps some kind of\n>> > CONFIG_PIE config definition should be introduced, so the assembly\n>> > code would be able to choose optimal asm sequence when PIE and non-PI=\nE\n>> > is requested?\n>>\n>> I wouldn't have thought that performance mattered in the asm code\n>> that runs during startup?\n>\n>No, not the code that runs only once, where performance impact can be tol=\nerated=2E\n>\n>This one:\n>\n>https://lore=2Ekernel=2Eorg/lkml/20240925150059=2E3955569-44-ardb+git@goo=\ngle=2Ecom/\n>\n>Uros=2E\n>\n\nYeah, running the kernel proper as PIE seems like a lose all around=2E The=\n decompressor, ELF stub, etc, are of course a different matter entirely (an=\nd at least the latter can't rely on the small or kernel memory models anywa=\ny=2E)\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172824347005147.mbox",
          "message_id": "<2E1160A8-3A0C-45BD-B729-D20EAE97A075 () zytor ! com>",
          "author_name": "H. Peter Anvin",
          "author_email": "hpa () zytor ! com",
          "subject": "Re: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 19:38:52+00:00",
          "date_str": "Sun, 06 Oct 2024 19:38:52 +0000",
          "body": "On October 6, 2024 12:17:40 PM PDT, Uros Bizjak <ubizjak@gmail=2Ecom> wrote=\n:\n>On Sun, Oct 6, 2024 at 8:01=E2=80=AFPM David Laight <David=2ELaight@acula=\nb=2Ecom> wrote:\n>>\n>> =2E=2E=2E\n>> > Due to the non-negligible impact of PIE, perhaps some kind of\n>> > CONFIG_PIE config definition should be introduced, so the assembly\n>> > code would be able to choose optimal asm sequence when PIE and non-PI=\nE\n>> > is requested?\n>>\n>> I wouldn't have thought that performance mattered in the asm code\n>> that runs during startup?\n>\n>No, not the code that runs only once, where performance impact can be tol=\nerated=2E\n>\n>This one:\n>\n>https://lore=2Ekernel=2Eorg/lkml/20240925150059=2E3955569-44-ardb+git@goo=\ngle=2Ecom/\n>\n>Uros=2E\n>\n\nYeah, running the kernel proper as PIE seems like a lose all around=2E The=\n decompressor, ELF stub, etc, are of course a different matter entirely (an=\nd at least the latter can't rely on the small or kernel memory models anywa=\ny=2E)\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172824346105129.mbox",
          "message_id": "<2E1160A8-3A0C-45BD-B729-D20EAE97A075 () zytor ! com>",
          "author_name": "H. Peter Anvin",
          "author_email": "hpa () zytor ! com",
          "subject": "Re: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 19:38:52+00:00",
          "date_str": "Sun, 06 Oct 2024 19:38:52 +0000",
          "body": "On October 6, 2024 12:17:40 PM PDT, Uros Bizjak <ubizjak@gmail=2Ecom> wrote=\n:\n>On Sun, Oct 6, 2024 at 8:01=E2=80=AFPM David Laight <David=2ELaight@acula=\nb=2Ecom> wrote:\n>>\n>> =2E=2E=2E\n>> > Due to the non-negligible impact of PIE, perhaps some kind of\n>> > CONFIG_PIE config definition should be introduced, so the assembly\n>> > code would be able to choose optimal asm sequence when PIE and non-PI=\nE\n>> > is requested?\n>>\n>> I wouldn't have thought that performance mattered in the asm code\n>> that runs during startup?\n>\n>No, not the code that runs only once, where performance impact can be tol=\nerated=2E\n>\n>This one:\n>\n>https://lore=2Ekernel=2Eorg/lkml/20240925150059=2E3955569-44-ardb+git@goo=\ngle=2Ecom/\n>\n>Uros=2E\n>\n\nYeah, running the kernel proper as PIE seems like a lose all around=2E The=\n decompressor, ELF stub, etc, are of course a different matter entirely (an=\nd at least the latter can't rely on the small or kernel memory models anywa=\ny=2E)\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172824347805154.mbox",
          "message_id": "<2E1160A8-3A0C-45BD-B729-D20EAE97A075 () zytor ! com>",
          "author_name": "H. Peter Anvin",
          "author_email": "hpa () zytor ! com",
          "subject": "Re: [RFC PATCH 25/28] x86: Use PIE codegen for the core kernel",
          "date": "2024-10-06 19:38:52+00:00",
          "date_str": "Sun, 06 Oct 2024 19:38:52 +0000",
          "body": "On October 6, 2024 12:17:40 PM PDT, Uros Bizjak <ubizjak@gmail=2Ecom> wrote=\n:\n>On Sun, Oct 6, 2024 at 8:01=E2=80=AFPM David Laight <David=2ELaight@acula=\nb=2Ecom> wrote:\n>>\n>> =2E=2E=2E\n>> > Due to the non-negligible impact of PIE, perhaps some kind of\n>> > CONFIG_PIE config definition should be introduced, so the assembly\n>> > code would be able to choose optimal asm sequence when PIE and non-PI=\nE\n>> > is requested?\n>>\n>> I wouldn't have thought that performance mattered in the asm code\n>> that runs during startup?\n>\n>No, not the code that runs only once, where performance impact can be tol=\nerated=2E\n>\n>This one:\n>\n>https://lore=2Ekernel=2Eorg/lkml/20240925150059=2E3955569-44-ardb+git@goo=\ngle=2Ecom/\n>\n>Uros=2E\n>\n\nYeah, running the kernel proper as PIE seems like a lose all around=2E The=\n decompressor, ELF stub, etc, are of course a different matter entirely (an=\nd at least the latter can't rely on the small or kernel memory models anywa=\ny=2E)\n",
          "year": "2024",
          "month": "10"
        }
      ],
      "primary_category": "kernel_integration"
    },
    {
      "subject": "[RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
      "normalized_subject": "x86/rethook: Use RIP-relative reference for return address",
      "message_count": 23,
      "participants": [
        "Ard Biesheuvel",
        "Linus Torvalds",
        "Andrew Cooper"
      ],
      "categories": [
        "rfc_proposals",
        "compiler_compat",
        "address_space"
      ],
      "first_date": "2024-09-25T15:01:14+00:00",
      "last_date": "2024-09-25T16:51:17+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/09/172727726418451.mbox",
          "message_id": "<20240925150059.3955569-44-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 15:01:14+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:14 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nInstead of pushing an immediate absolute address, which is incompatible\nwith PIE codegen or linking, use a LEA instruction to take the address\ninto a register.\n\nSigned-off-by: Ard Biesheuvel <ardb@kernel.org>\n---\n arch/x86/kernel/rethook.c | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\ndiff --git a/arch/x86/kernel/rethook.c b/arch/x86/kernel/rethook.c\nindex 8a1c0111ae79..3b3c17ba3cd5 100644\n--- a/arch/x86/kernel/rethook.c\n+++ b/arch/x86/kernel/rethook.c\n@@ -27,7 +27,8 @@ asm(\n #ifdef CONFIG_X86_64\n \tANNOTATE_NOENDBR\t/* This is only jumped from ret instruction */\n \t/* Push a fake return address to tell the unwinder it's a rethook. */\n-\t\"\tpushq $arch_rethook_trampoline\\n\"\n+\t\"\tleaq arch_rethook_trampoline(%rip), %rdi\\n\"\n+\t\"\tpushq %rdi\\n\"\n \tUNWIND_HINT_FUNC\n \t\"       pushq $\" __stringify(__KERNEL_DS) \"\\n\"\n \t/* Save the 'sp - 16', this will be fixed later. */\n-- \n2.46.0.792.g87dc391469-goog\n\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172727726818457.mbox",
          "message_id": "<20240925150059.3955569-44-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 15:01:14+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:14 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nInstead of pushing an immediate absolute address, which is incompatible\nwith PIE codegen or linking, use a LEA instruction to take the address\ninto a register.\n\nSigned-off-by: Ard Biesheuvel <ardb@kernel.org>\n---\n arch/x86/kernel/rethook.c | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\ndiff --git a/arch/x86/kernel/rethook.c b/arch/x86/kernel/rethook.c\nindex 8a1c0111ae79..3b3c17ba3cd5 100644\n--- a/arch/x86/kernel/rethook.c\n+++ b/arch/x86/kernel/rethook.c\n@@ -27,7 +27,8 @@ asm(\n #ifdef CONFIG_X86_64\n \tANNOTATE_NOENDBR\t/* This is only jumped from ret instruction */\n \t/* Push a fake return address to tell the unwinder it's a rethook. */\n-\t\"\tpushq $arch_rethook_trampoline\\n\"\n+\t\"\tleaq arch_rethook_trampoline(%rip), %rdi\\n\"\n+\t\"\tpushq %rdi\\n\"\n \tUNWIND_HINT_FUNC\n \t\"       pushq $\" __stringify(__KERNEL_DS) \"\\n\"\n \t/* Save the 'sp - 16', this will be fixed later. */\n-- \n2.46.0.792.g87dc391469-goog\n\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172727725218433.mbox",
          "message_id": "<20240925150059.3955569-44-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 15:01:14+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:14 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nInstead of pushing an immediate absolute address, which is incompatible\nwith PIE codegen or linking, use a LEA instruction to take the address\ninto a register.\n\nSigned-off-by: Ard Biesheuvel <ardb@kernel.org>\n---\n arch/x86/kernel/rethook.c | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\ndiff --git a/arch/x86/kernel/rethook.c b/arch/x86/kernel/rethook.c\nindex 8a1c0111ae79..3b3c17ba3cd5 100644\n--- a/arch/x86/kernel/rethook.c\n+++ b/arch/x86/kernel/rethook.c\n@@ -27,7 +27,8 @@ asm(\n #ifdef CONFIG_X86_64\n \tANNOTATE_NOENDBR\t/* This is only jumped from ret instruction */\n \t/* Push a fake return address to tell the unwinder it's a rethook. */\n-\t\"\tpushq $arch_rethook_trampoline\\n\"\n+\t\"\tleaq arch_rethook_trampoline(%rip), %rdi\\n\"\n+\t\"\tpushq %rdi\\n\"\n \tUNWIND_HINT_FUNC\n \t\"       pushq $\" __stringify(__KERNEL_DS) \"\\n\"\n \t/* Save the 'sp - 16', this will be fixed later. */\n-- \n2.46.0.792.g87dc391469-goog\n\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172727725018430.mbox",
          "message_id": "<20240925150059.3955569-44-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 15:01:14+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:14 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nInstead of pushing an immediate absolute address, which is incompatible\nwith PIE codegen or linking, use a LEA instruction to take the address\ninto a register.\n\nSigned-off-by: Ard Biesheuvel <ardb@kernel.org>\n---\n arch/x86/kernel/rethook.c | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\ndiff --git a/arch/x86/kernel/rethook.c b/arch/x86/kernel/rethook.c\nindex 8a1c0111ae79..3b3c17ba3cd5 100644\n--- a/arch/x86/kernel/rethook.c\n+++ b/arch/x86/kernel/rethook.c\n@@ -27,7 +27,8 @@ asm(\n #ifdef CONFIG_X86_64\n \tANNOTATE_NOENDBR\t/* This is only jumped from ret instruction */\n \t/* Push a fake return address to tell the unwinder it's a rethook. */\n-\t\"\tpushq $arch_rethook_trampoline\\n\"\n+\t\"\tleaq arch_rethook_trampoline(%rip), %rdi\\n\"\n+\t\"\tpushq %rdi\\n\"\n \tUNWIND_HINT_FUNC\n \t\"       pushq $\" __stringify(__KERNEL_DS) \"\\n\"\n \t/* Save the 'sp - 16', this will be fixed later. */\n-- \n2.46.0.792.g87dc391469-goog\n\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172727725918442.mbox",
          "message_id": "<20240925150059.3955569-44-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 15:01:14+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:14 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nInstead of pushing an immediate absolute address, which is incompatible\nwith PIE codegen or linking, use a LEA instruction to take the address\ninto a register.\n\nSigned-off-by: Ard Biesheuvel <ardb@kernel.org>\n---\n arch/x86/kernel/rethook.c | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\ndiff --git a/arch/x86/kernel/rethook.c b/arch/x86/kernel/rethook.c\nindex 8a1c0111ae79..3b3c17ba3cd5 100644\n--- a/arch/x86/kernel/rethook.c\n+++ b/arch/x86/kernel/rethook.c\n@@ -27,7 +27,8 @@ asm(\n #ifdef CONFIG_X86_64\n \tANNOTATE_NOENDBR\t/* This is only jumped from ret instruction */\n \t/* Push a fake return address to tell the unwinder it's a rethook. */\n-\t\"\tpushq $arch_rethook_trampoline\\n\"\n+\t\"\tleaq arch_rethook_trampoline(%rip), %rdi\\n\"\n+\t\"\tpushq %rdi\\n\"\n \tUNWIND_HINT_FUNC\n \t\"       pushq $\" __stringify(__KERNEL_DS) \"\\n\"\n \t/* Save the 'sp - 16', this will be fixed later. */\n-- \n2.46.0.792.g87dc391469-goog\n\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172727727318462.mbox",
          "message_id": "<20240925150059.3955569-44-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 15:01:14+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:14 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nInstead of pushing an immediate absolute address, which is incompatible\nwith PIE codegen or linking, use a LEA instruction to take the address\ninto a register.\n\nSigned-off-by: Ard Biesheuvel <ardb@kernel.org>\n---\n arch/x86/kernel/rethook.c | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\ndiff --git a/arch/x86/kernel/rethook.c b/arch/x86/kernel/rethook.c\nindex 8a1c0111ae79..3b3c17ba3cd5 100644\n--- a/arch/x86/kernel/rethook.c\n+++ b/arch/x86/kernel/rethook.c\n@@ -27,7 +27,8 @@ asm(\n #ifdef CONFIG_X86_64\n \tANNOTATE_NOENDBR\t/* This is only jumped from ret instruction */\n \t/* Push a fake return address to tell the unwinder it's a rethook. */\n-\t\"\tpushq $arch_rethook_trampoline\\n\"\n+\t\"\tleaq arch_rethook_trampoline(%rip), %rdi\\n\"\n+\t\"\tpushq %rdi\\n\"\n \tUNWIND_HINT_FUNC\n \t\"       pushq $\" __stringify(__KERNEL_DS) \"\\n\"\n \t/* Save the 'sp - 16', this will be fixed later. */\n-- \n2.46.0.792.g87dc391469-goog\n\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172727718918313.mbox",
          "message_id": "<20240925150059.3955569-44-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 15:01:14+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:14 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nInstead of pushing an immediate absolute address, which is incompatible\nwith PIE codegen or linking, use a LEA instruction to take the address\ninto a register.\n\nSigned-off-by: Ard Biesheuvel <ardb@kernel.org>\n---\n arch/x86/kernel/rethook.c | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\ndiff --git a/arch/x86/kernel/rethook.c b/arch/x86/kernel/rethook.c\nindex 8a1c0111ae79..3b3c17ba3cd5 100644\n--- a/arch/x86/kernel/rethook.c\n+++ b/arch/x86/kernel/rethook.c\n@@ -27,7 +27,8 @@ asm(\n #ifdef CONFIG_X86_64\n \tANNOTATE_NOENDBR\t/* This is only jumped from ret instruction */\n \t/* Push a fake return address to tell the unwinder it's a rethook. */\n-\t\"\tpushq $arch_rethook_trampoline\\n\"\n+\t\"\tleaq arch_rethook_trampoline(%rip), %rdi\\n\"\n+\t\"\tpushq %rdi\\n\"\n \tUNWIND_HINT_FUNC\n \t\"       pushq $\" __stringify(__KERNEL_DS) \"\\n\"\n \t/* Save the 'sp - 16', this will be fixed later. */\n-- \n2.46.0.792.g87dc391469-goog\n\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172727725518436.mbox",
          "message_id": "<20240925150059.3955569-44-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 15:01:14+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:14 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nInstead of pushing an immediate absolute address, which is incompatible\nwith PIE codegen or linking, use a LEA instruction to take the address\ninto a register.\n\nSigned-off-by: Ard Biesheuvel <ardb@kernel.org>\n---\n arch/x86/kernel/rethook.c | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\ndiff --git a/arch/x86/kernel/rethook.c b/arch/x86/kernel/rethook.c\nindex 8a1c0111ae79..3b3c17ba3cd5 100644\n--- a/arch/x86/kernel/rethook.c\n+++ b/arch/x86/kernel/rethook.c\n@@ -27,7 +27,8 @@ asm(\n #ifdef CONFIG_X86_64\n \tANNOTATE_NOENDBR\t/* This is only jumped from ret instruction */\n \t/* Push a fake return address to tell the unwinder it's a rethook. */\n-\t\"\tpushq $arch_rethook_trampoline\\n\"\n+\t\"\tleaq arch_rethook_trampoline(%rip), %rdi\\n\"\n+\t\"\tpushq %rdi\\n\"\n \tUNWIND_HINT_FUNC\n \t\"       pushq $\" __stringify(__KERNEL_DS) \"\\n\"\n \t/* Save the 'sp - 16', this will be fixed later. */\n-- \n2.46.0.792.g87dc391469-goog\n\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172728272822860.mbox",
          "message_id": "<CAHk-=wiLYCoGSnqqPq+7fHWgmyf5DpO4SLDJ4kF=EGZVVZOX4A () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 16:39:23+00:00",
          "date_str": "Wed, 25 Sep 2024 16:39:23 +0000",
          "body": "On Wed, 25 Sept 2024 at 08:16, Ard Biesheuvel <ardb+git@google.com> wrote:\n>\n> Instead of pushing an immediate absolute address, which is incompatible\n> with PIE codegen or linking, use a LEA instruction to take the address\n> into a register.\n\nI don't think you can do this - it corrupts %rdi.\n\nYes, the code uses  %rdi later, but that's inside the SAVE_REGS_STRING\n/ RESTORE_REGS_STRING area.\n\nAnd we do have special calling conventions that aren't the regular\nones, so %rdi might actually be used elsewhere. For example,\n__get_user_X and __put_user_X all have magical calling conventions:\nthey don't actually use %rdi, but part of the calling convention is\nthat the unused registers aren't modified.\n\nOf course, I'm not actually sure you can probe those and trigger this\nissue, but it all makes me think it's broken.\n\nAnd it's entirely possible that I'm wrong for some reason, but this\njust _looks_ very very wrong to me.\n\nI think you can do this with a \"pushq mem\" instead, and put the\nrelocation into the memory location.\n\n                 Linus\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172728227522493.mbox",
          "message_id": "<CAHk-=wiLYCoGSnqqPq+7fHWgmyf5DpO4SLDJ4kF=EGZVVZOX4A () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 16:39:23+00:00",
          "date_str": "Wed, 25 Sep 2024 16:39:23 +0000",
          "body": "On Wed, 25 Sept 2024 at 08:16, Ard Biesheuvel <ardb+git@google.com> wrote:\n>\n> Instead of pushing an immediate absolute address, which is incompatible\n> with PIE codegen or linking, use a LEA instruction to take the address\n> into a register.\n\nI don't think you can do this - it corrupts %rdi.\n\nYes, the code uses  %rdi later, but that's inside the SAVE_REGS_STRING\n/ RESTORE_REGS_STRING area.\n\nAnd we do have special calling conventions that aren't the regular\nones, so %rdi might actually be used elsewhere. For example,\n__get_user_X and __put_user_X all have magical calling conventions:\nthey don't actually use %rdi, but part of the calling convention is\nthat the unused registers aren't modified.\n\nOf course, I'm not actually sure you can probe those and trigger this\nissue, but it all makes me think it's broken.\n\nAnd it's entirely possible that I'm wrong for some reason, but this\njust _looks_ very very wrong to me.\n\nI think you can do this with a \"pushq mem\" instead, and put the\nrelocation into the memory location.\n\n                 Linus\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172728276622880.mbox",
          "message_id": "<CAHk-=wiLYCoGSnqqPq+7fHWgmyf5DpO4SLDJ4kF=EGZVVZOX4A () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 16:39:23+00:00",
          "date_str": "Wed, 25 Sep 2024 16:39:23 +0000",
          "body": "On Wed, 25 Sept 2024 at 08:16, Ard Biesheuvel <ardb+git@google.com> wrote:\n>\n> Instead of pushing an immediate absolute address, which is incompatible\n> with PIE codegen or linking, use a LEA instruction to take the address\n> into a register.\n\nI don't think you can do this - it corrupts %rdi.\n\nYes, the code uses  %rdi later, but that's inside the SAVE_REGS_STRING\n/ RESTORE_REGS_STRING area.\n\nAnd we do have special calling conventions that aren't the regular\nones, so %rdi might actually be used elsewhere. For example,\n__get_user_X and __put_user_X all have magical calling conventions:\nthey don't actually use %rdi, but part of the calling convention is\nthat the unused registers aren't modified.\n\nOf course, I'm not actually sure you can probe those and trigger this\nissue, but it all makes me think it's broken.\n\nAnd it's entirely possible that I'm wrong for some reason, but this\njust _looks_ very very wrong to me.\n\nI think you can do this with a \"pushq mem\" instead, and put the\nrelocation into the memory location.\n\n                 Linus\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172728271322851.mbox",
          "message_id": "<CAHk-=wiLYCoGSnqqPq+7fHWgmyf5DpO4SLDJ4kF=EGZVVZOX4A () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 16:39:23+00:00",
          "date_str": "Wed, 25 Sep 2024 16:39:23 +0000",
          "body": "On Wed, 25 Sept 2024 at 08:16, Ard Biesheuvel <ardb+git@google.com> wrote:\n>\n> Instead of pushing an immediate absolute address, which is incompatible\n> with PIE codegen or linking, use a LEA instruction to take the address\n> into a register.\n\nI don't think you can do this - it corrupts %rdi.\n\nYes, the code uses  %rdi later, but that's inside the SAVE_REGS_STRING\n/ RESTORE_REGS_STRING area.\n\nAnd we do have special calling conventions that aren't the regular\nones, so %rdi might actually be used elsewhere. For example,\n__get_user_X and __put_user_X all have magical calling conventions:\nthey don't actually use %rdi, but part of the calling convention is\nthat the unused registers aren't modified.\n\nOf course, I'm not actually sure you can probe those and trigger this\nissue, but it all makes me think it's broken.\n\nAnd it's entirely possible that I'm wrong for some reason, but this\njust _looks_ very very wrong to me.\n\nI think you can do this with a \"pushq mem\" instead, and put the\nrelocation into the memory location.\n\n                 Linus\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172728280722903.mbox",
          "message_id": "<CAHk-=wiLYCoGSnqqPq+7fHWgmyf5DpO4SLDJ4kF=EGZVVZOX4A () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 16:39:23+00:00",
          "date_str": "Wed, 25 Sep 2024 16:39:23 +0000",
          "body": "On Wed, 25 Sept 2024 at 08:16, Ard Biesheuvel <ardb+git@google.com> wrote:\n>\n> Instead of pushing an immediate absolute address, which is incompatible\n> with PIE codegen or linking, use a LEA instruction to take the address\n> into a register.\n\nI don't think you can do this - it corrupts %rdi.\n\nYes, the code uses  %rdi later, but that's inside the SAVE_REGS_STRING\n/ RESTORE_REGS_STRING area.\n\nAnd we do have special calling conventions that aren't the regular\nones, so %rdi might actually be used elsewhere. For example,\n__get_user_X and __put_user_X all have magical calling conventions:\nthey don't actually use %rdi, but part of the calling convention is\nthat the unused registers aren't modified.\n\nOf course, I'm not actually sure you can probe those and trigger this\nissue, but it all makes me think it's broken.\n\nAnd it's entirely possible that I'm wrong for some reason, but this\njust _looks_ very very wrong to me.\n\nI think you can do this with a \"pushq mem\" instead, and put the\nrelocation into the memory location.\n\n                 Linus\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172728266922812.mbox",
          "message_id": "<CAHk-=wiLYCoGSnqqPq+7fHWgmyf5DpO4SLDJ4kF=EGZVVZOX4A () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 16:39:23+00:00",
          "date_str": "Wed, 25 Sep 2024 16:39:23 +0000",
          "body": "On Wed, 25 Sept 2024 at 08:16, Ard Biesheuvel <ardb+git@google.com> wrote:\n>\n> Instead of pushing an immediate absolute address, which is incompatible\n> with PIE codegen or linking, use a LEA instruction to take the address\n> into a register.\n\nI don't think you can do this - it corrupts %rdi.\n\nYes, the code uses  %rdi later, but that's inside the SAVE_REGS_STRING\n/ RESTORE_REGS_STRING area.\n\nAnd we do have special calling conventions that aren't the regular\nones, so %rdi might actually be used elsewhere. For example,\n__get_user_X and __put_user_X all have magical calling conventions:\nthey don't actually use %rdi, but part of the calling convention is\nthat the unused registers aren't modified.\n\nOf course, I'm not actually sure you can probe those and trigger this\nissue, but it all makes me think it's broken.\n\nAnd it's entirely possible that I'm wrong for some reason, but this\njust _looks_ very very wrong to me.\n\nI think you can do this with a \"pushq mem\" instead, and put the\nrelocation into the memory location.\n\n                 Linus\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172728258122731.mbox",
          "message_id": "<CAHk-=wiLYCoGSnqqPq+7fHWgmyf5DpO4SLDJ4kF=EGZVVZOX4A () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: [RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 16:39:23+00:00",
          "date_str": "Wed, 25 Sep 2024 16:39:23 +0000",
          "body": "On Wed, 25 Sept 2024 at 08:16, Ard Biesheuvel <ardb+git@google.com> wrote:\n>\n> Instead of pushing an immediate absolute address, which is incompatible\n> with PIE codegen or linking, use a LEA instruction to take the address\n> into a register.\n\nI don't think you can do this - it corrupts %rdi.\n\nYes, the code uses  %rdi later, but that's inside the SAVE_REGS_STRING\n/ RESTORE_REGS_STRING area.\n\nAnd we do have special calling conventions that aren't the regular\nones, so %rdi might actually be used elsewhere. For example,\n__get_user_X and __put_user_X all have magical calling conventions:\nthey don't actually use %rdi, but part of the calling convention is\nthat the unused registers aren't modified.\n\nOf course, I'm not actually sure you can probe those and trigger this\nissue, but it all makes me think it's broken.\n\nAnd it's entirely possible that I'm wrong for some reason, but this\njust _looks_ very very wrong to me.\n\nI think you can do this with a \"pushq mem\" instead, and put the\nrelocation into the memory location.\n\n                 Linus\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172728260922776.mbox",
          "message_id": "<CAMj1kXH1xqYwhG16XxoBpoedTkBvt72xBjO259174jHirdf47A () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 16:45:05+00:00",
          "date_str": "Wed, 25 Sep 2024 16:45:05 +0000",
          "body": "On Wed, 25 Sept 2024 at 18:39, Linus Torvalds\n<torvalds@linux-foundation.org> wrote:\n>\n> On Wed, 25 Sept 2024 at 08:16, Ard Biesheuvel <ardb+git@google.com> wrote:\n> >\n> > Instead of pushing an immediate absolute address, which is incompatible\n> > with PIE codegen or linking, use a LEA instruction to take the address\n> > into a register.\n>\n> I don't think you can do this - it corrupts %rdi.\n>\n> Yes, the code uses  %rdi later, but that's inside the SAVE_REGS_STRING\n> / RESTORE_REGS_STRING area.\n>\n\nOops, I missed that.\n\n> And we do have special calling conventions that aren't the regular\n> ones, so %rdi might actually be used elsewhere. For example,\n> __get_user_X and __put_user_X all have magical calling conventions:\n> they don't actually use %rdi, but part of the calling convention is\n> that the unused registers aren't modified.\n>\n> Of course, I'm not actually sure you can probe those and trigger this\n> issue, but it all makes me think it's broken.\n>\n> And it's entirely possible that I'm wrong for some reason, but this\n> just _looks_ very very wrong to me.\n>\n> I think you can do this with a \"pushq mem\" instead, and put the\n> relocation into the memory location.\n>\n\nI'll change this into\n\n  pushq arch_rethook_trampoline@GOTPCREL(%rip)\n\nwhich I had originally. I was trying to avoid the load from memory,\nbut that obviously only works if the register is not live.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172728261022783.mbox",
          "message_id": "<CAMj1kXH1xqYwhG16XxoBpoedTkBvt72xBjO259174jHirdf47A () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 16:45:05+00:00",
          "date_str": "Wed, 25 Sep 2024 16:45:05 +0000",
          "body": "On Wed, 25 Sept 2024 at 18:39, Linus Torvalds\n<torvalds@linux-foundation.org> wrote:\n>\n> On Wed, 25 Sept 2024 at 08:16, Ard Biesheuvel <ardb+git@google.com> wrote:\n> >\n> > Instead of pushing an immediate absolute address, which is incompatible\n> > with PIE codegen or linking, use a LEA instruction to take the address\n> > into a register.\n>\n> I don't think you can do this - it corrupts %rdi.\n>\n> Yes, the code uses  %rdi later, but that's inside the SAVE_REGS_STRING\n> / RESTORE_REGS_STRING area.\n>\n\nOops, I missed that.\n\n> And we do have special calling conventions that aren't the regular\n> ones, so %rdi might actually be used elsewhere. For example,\n> __get_user_X and __put_user_X all have magical calling conventions:\n> they don't actually use %rdi, but part of the calling convention is\n> that the unused registers aren't modified.\n>\n> Of course, I'm not actually sure you can probe those and trigger this\n> issue, but it all makes me think it's broken.\n>\n> And it's entirely possible that I'm wrong for some reason, but this\n> just _looks_ very very wrong to me.\n>\n> I think you can do this with a \"pushq mem\" instead, and put the\n> relocation into the memory location.\n>\n\nI'll change this into\n\n  pushq arch_rethook_trampoline@GOTPCREL(%rip)\n\nwhich I had originally. I was trying to avoid the load from memory,\nbut that obviously only works if the register is not live.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172728261922798.mbox",
          "message_id": "<CAMj1kXH1xqYwhG16XxoBpoedTkBvt72xBjO259174jHirdf47A () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 16:45:05+00:00",
          "date_str": "Wed, 25 Sep 2024 16:45:05 +0000",
          "body": "On Wed, 25 Sept 2024 at 18:39, Linus Torvalds\n<torvalds@linux-foundation.org> wrote:\n>\n> On Wed, 25 Sept 2024 at 08:16, Ard Biesheuvel <ardb+git@google.com> wrote:\n> >\n> > Instead of pushing an immediate absolute address, which is incompatible\n> > with PIE codegen or linking, use a LEA instruction to take the address\n> > into a register.\n>\n> I don't think you can do this - it corrupts %rdi.\n>\n> Yes, the code uses  %rdi later, but that's inside the SAVE_REGS_STRING\n> / RESTORE_REGS_STRING area.\n>\n\nOops, I missed that.\n\n> And we do have special calling conventions that aren't the regular\n> ones, so %rdi might actually be used elsewhere. For example,\n> __get_user_X and __put_user_X all have magical calling conventions:\n> they don't actually use %rdi, but part of the calling convention is\n> that the unused registers aren't modified.\n>\n> Of course, I'm not actually sure you can probe those and trigger this\n> issue, but it all makes me think it's broken.\n>\n> And it's entirely possible that I'm wrong for some reason, but this\n> just _looks_ very very wrong to me.\n>\n> I think you can do this with a \"pushq mem\" instead, and put the\n> relocation into the memory location.\n>\n\nI'll change this into\n\n  pushq arch_rethook_trampoline@GOTPCREL(%rip)\n\nwhich I had originally. I was trying to avoid the load from memory,\nbut that obviously only works if the register is not live.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172728260922772.mbox",
          "message_id": "<CAMj1kXH1xqYwhG16XxoBpoedTkBvt72xBjO259174jHirdf47A () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 16:45:05+00:00",
          "date_str": "Wed, 25 Sep 2024 16:45:05 +0000",
          "body": "On Wed, 25 Sept 2024 at 18:39, Linus Torvalds\n<torvalds@linux-foundation.org> wrote:\n>\n> On Wed, 25 Sept 2024 at 08:16, Ard Biesheuvel <ardb+git@google.com> wrote:\n> >\n> > Instead of pushing an immediate absolute address, which is incompatible\n> > with PIE codegen or linking, use a LEA instruction to take the address\n> > into a register.\n>\n> I don't think you can do this - it corrupts %rdi.\n>\n> Yes, the code uses  %rdi later, but that's inside the SAVE_REGS_STRING\n> / RESTORE_REGS_STRING area.\n>\n\nOops, I missed that.\n\n> And we do have special calling conventions that aren't the regular\n> ones, so %rdi might actually be used elsewhere. For example,\n> __get_user_X and __put_user_X all have magical calling conventions:\n> they don't actually use %rdi, but part of the calling convention is\n> that the unused registers aren't modified.\n>\n> Of course, I'm not actually sure you can probe those and trigger this\n> issue, but it all makes me think it's broken.\n>\n> And it's entirely possible that I'm wrong for some reason, but this\n> just _looks_ very very wrong to me.\n>\n> I think you can do this with a \"pushq mem\" instead, and put the\n> relocation into the memory location.\n>\n\nI'll change this into\n\n  pushq arch_rethook_trampoline@GOTPCREL(%rip)\n\nwhich I had originally. I was trying to avoid the load from memory,\nbut that obviously only works if the register is not live.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172728262022803.mbox",
          "message_id": "<CAMj1kXH1xqYwhG16XxoBpoedTkBvt72xBjO259174jHirdf47A () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 16:45:05+00:00",
          "date_str": "Wed, 25 Sep 2024 16:45:05 +0000",
          "body": "On Wed, 25 Sept 2024 at 18:39, Linus Torvalds\n<torvalds@linux-foundation.org> wrote:\n>\n> On Wed, 25 Sept 2024 at 08:16, Ard Biesheuvel <ardb+git@google.com> wrote:\n> >\n> > Instead of pushing an immediate absolute address, which is incompatible\n> > with PIE codegen or linking, use a LEA instruction to take the address\n> > into a register.\n>\n> I don't think you can do this - it corrupts %rdi.\n>\n> Yes, the code uses  %rdi later, but that's inside the SAVE_REGS_STRING\n> / RESTORE_REGS_STRING area.\n>\n\nOops, I missed that.\n\n> And we do have special calling conventions that aren't the regular\n> ones, so %rdi might actually be used elsewhere. For example,\n> __get_user_X and __put_user_X all have magical calling conventions:\n> they don't actually use %rdi, but part of the calling convention is\n> that the unused registers aren't modified.\n>\n> Of course, I'm not actually sure you can probe those and trigger this\n> issue, but it all makes me think it's broken.\n>\n> And it's entirely possible that I'm wrong for some reason, but this\n> just _looks_ very very wrong to me.\n>\n> I think you can do this with a \"pushq mem\" instead, and put the\n> relocation into the memory location.\n>\n\nI'll change this into\n\n  pushq arch_rethook_trampoline@GOTPCREL(%rip)\n\nwhich I had originally. I was trying to avoid the load from memory,\nbut that obviously only works if the register is not live.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172728260922773.mbox",
          "message_id": "<CAMj1kXH1xqYwhG16XxoBpoedTkBvt72xBjO259174jHirdf47A () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 16:45:05+00:00",
          "date_str": "Wed, 25 Sep 2024 16:45:05 +0000",
          "body": "On Wed, 25 Sept 2024 at 18:39, Linus Torvalds\n<torvalds@linux-foundation.org> wrote:\n>\n> On Wed, 25 Sept 2024 at 08:16, Ard Biesheuvel <ardb+git@google.com> wrote:\n> >\n> > Instead of pushing an immediate absolute address, which is incompatible\n> > with PIE codegen or linking, use a LEA instruction to take the address\n> > into a register.\n>\n> I don't think you can do this - it corrupts %rdi.\n>\n> Yes, the code uses  %rdi later, but that's inside the SAVE_REGS_STRING\n> / RESTORE_REGS_STRING area.\n>\n\nOops, I missed that.\n\n> And we do have special calling conventions that aren't the regular\n> ones, so %rdi might actually be used elsewhere. For example,\n> __get_user_X and __put_user_X all have magical calling conventions:\n> they don't actually use %rdi, but part of the calling convention is\n> that the unused registers aren't modified.\n>\n> Of course, I'm not actually sure you can probe those and trigger this\n> issue, but it all makes me think it's broken.\n>\n> And it's entirely possible that I'm wrong for some reason, but this\n> just _looks_ very very wrong to me.\n>\n> I think you can do this with a \"pushq mem\" instead, and put the\n> relocation into the memory location.\n>\n\nI'll change this into\n\n  pushq arch_rethook_trampoline@GOTPCREL(%rip)\n\nwhich I had originally. I was trying to avoid the load from memory,\nbut that obviously only works if the register is not live.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172728262122804.mbox",
          "message_id": "<CAMj1kXH1xqYwhG16XxoBpoedTkBvt72xBjO259174jHirdf47A () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 16:45:05+00:00",
          "date_str": "Wed, 25 Sep 2024 16:45:05 +0000",
          "body": "On Wed, 25 Sept 2024 at 18:39, Linus Torvalds\n<torvalds@linux-foundation.org> wrote:\n>\n> On Wed, 25 Sept 2024 at 08:16, Ard Biesheuvel <ardb+git@google.com> wrote:\n> >\n> > Instead of pushing an immediate absolute address, which is incompatible\n> > with PIE codegen or linking, use a LEA instruction to take the address\n> > into a register.\n>\n> I don't think you can do this - it corrupts %rdi.\n>\n> Yes, the code uses  %rdi later, but that's inside the SAVE_REGS_STRING\n> / RESTORE_REGS_STRING area.\n>\n\nOops, I missed that.\n\n> And we do have special calling conventions that aren't the regular\n> ones, so %rdi might actually be used elsewhere. For example,\n> __get_user_X and __put_user_X all have magical calling conventions:\n> they don't actually use %rdi, but part of the calling convention is\n> that the unused registers aren't modified.\n>\n> Of course, I'm not actually sure you can probe those and trigger this\n> issue, but it all makes me think it's broken.\n>\n> And it's entirely possible that I'm wrong for some reason, but this\n> just _looks_ very very wrong to me.\n>\n> I think you can do this with a \"pushq mem\" instead, and put the\n> relocation into the memory location.\n>\n\nI'll change this into\n\n  pushq arch_rethook_trampoline@GOTPCREL(%rip)\n\nwhich I had originally. I was trying to avoid the load from memory,\nbut that obviously only works if the register is not live.\n",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/09/172728297523019.mbox",
          "message_id": "<bffb4569-af56-4ea0-92e3-a9259c48a58f () citrix ! com>",
          "author_name": "Andrew Cooper",
          "author_email": "andrew.cooper3 () citrix ! com",
          "subject": "Re: [RFC PATCH 14/28] x86/rethook: Use RIP-relative reference for return address",
          "date": "2024-09-25 16:51:17+00:00",
          "date_str": "Wed, 25 Sep 2024 16:51:17 +0000",
          "body": "On 25/09/2024 5:45 pm, Ard Biesheuvel wrote:\n> On Wed, 25 Sept 2024 at 18:39, Linus Torvalds\n> <torvalds@linux-foundation.org> wrote:\n>> And we do have special calling conventions that aren't the regular\n>> ones, so %rdi might actually be used elsewhere. For example,\n>> __get_user_X and __put_user_X all have magical calling conventions:\n>> they don't actually use %rdi, but part of the calling convention is\n>> that the unused registers aren't modified.\n>>\n>> Of course, I'm not actually sure you can probe those and trigger this\n>> issue, but it all makes me think it's broken.\n>>\n>> And it's entirely possible that I'm wrong for some reason, but this\n>> just _looks_ very very wrong to me.\n>>\n>> I think you can do this with a \"pushq mem\" instead, and put the\n>> relocation into the memory location.\n>>\n> I'll change this into\n>\n>   pushq arch_rethook_trampoline@GOTPCREL(%rip)\n>\n> which I had originally. I was trying to avoid the load from memory,\n> but that obviously only works if the register is not live.\n\nBut does that work?\u00a0 Won't that will push the 8 bytes from the start of\narch_rethook_trampoline, when what's wanted is simply the address of\narch_rethook_trampoline itself.\n\n~Andrew\n",
          "year": "2024",
          "month": "09"
        }
      ],
      "primary_category": "address_space"
    },
    {
      "subject": "[RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
      "normalized_subject": "x86/boot: Permit GOTPCREL relocations for x86_64 builds",
      "message_count": 22,
      "participants": [
        "Ard Biesheuvel",
        "Josh Poimboeuf"
      ],
      "categories": [
        "kernel_integration",
        "rfc_proposals",
        "compiler_compat"
      ],
      "first_date": "2024-09-25T15:01:04+00:00",
      "last_date": "2024-10-01T06:56:12+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/09/172727696417846.mbox",
          "message_id": "<20240925150059.3955569-34-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-09-25 15:01:04+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:04 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nSome of the early x86_64 startup code is written in C, and executes in\nthe early 1:1 mapping of the kernel, which is not the address it was\nlinked at, and this requires special care when accessing global\nvariables. This is currently being dealt with on an ad-hoc basis,\nprimarily in head64.c, using explicit pointer fixups, but it would be\nbetter to rely on the compiler for this, by using -fPIE to generate code\nthat can run at any address, and uses RIP-relative accesses to refer to\nglobal variables.\n\nWhile it is possible to avoid most GOT based symbol references that the\ncompiler typically emits when running in -fPIE mode, by using 'hidden'\nvisibility, there are cases where the compiler will always rely on the\nGOT, for instance, for weak external references (which may remain\nunsatisfied at link time).\n\nThis means the build may produce a small number of GOT entries\nnonetheless. So update the reloc processing host tool to add support for\nthis, and place the GOT in the .text section rather than discard it.\n\nNote that multiple GOT based references to the same symbol will share a\nsingle GOT entry, and so naively emitting a relocation for the GOT entry\neach time a reference to it is encountered could result in duplicates.\nWork around this by relying on the fact that the relocation lists are\nsorted, and deduplicate 64-bit relocations as they are emitted by\ncomparing each entry with the previous one.\n\nSigned-off-by: Ard Biesheuvel <ardb@kernel.org>\n---\n arch/x86/Makefile                 |  4 +++\n arch/x86/kernel/vmlinux.lds.S     |  5 +++\n arch/x86/tools/relocs.c           | 33 ++++++++++++++++++--\n include/asm-generic/vmlinux.lds.h |  7 +++++\n 4 files changed, 47 insertions(+), 2 deletions(-)\n\ndiff --git a/arch/x86/Makefile b/arch/x86/Makefile\nindex 801fd85c3ef6..6b3fe6e2aadd 100644\n--- a/arch/x86/Makefile\n+++ b/arch/x86/Makefile\n@@ -192,6 +192,10 @@ else\n         KBUILD_CFLAGS += -mcmodel=kernel\n         KBUILD_RUSTFLAGS += -Cno-redzone=y\n         KBUILD_RUSTFLAGS += -Ccode-model=kernel\n+\n+        # Don't emit relaxable GOTPCREL relocations\n+        KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n+        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n endif\n \n #\ndiff --git a/arch/x86/kernel/vmlinux.lds.S b/arch/x86/kernel/vmlinux.lds.S\nindex 6e73403e874f..7f060d873f75 100644\n--- a/arch/x86/kernel/vmlinux.lds.S\n+++ b/arch/x86/kernel/vmlinux.lds.S\n@@ -20,6 +20,9 @@\n #define RUNTIME_DISCARD_EXIT\n #define EMITS_PT_NOTE\n #define RO_EXCEPTION_TABLE_ALIGN\t16\n+#ifdef CONFIG_X86_64\n+#define GOT_IN_RODATA\n+#endif\n \n #include <asm-generic/vmlinux.lds.h>\n #include <asm/asm-offsets.h>\n@@ -464,10 +467,12 @@ SECTIONS\n \t * Sections that should stay zero sized, which is safer to\n \t * explicitly check instead of blindly discarding.\n \t */\n+#ifdef CONFIG_X86_32\n \t.got : {\n \t\t*(.got) *(.igot.*)\n \t}\n \tASSERT(SIZEOF(.got) == 0, \"Unexpected GOT entries detected!\")\n+#endif\n \n \t.plt : {\n \t\t*(.plt) *(.plt.*) *(.iplt)\ndiff --git a/arch/x86/tools/relocs.c b/arch/x86/tools/relocs.c\nindex 35a73e4aa74d..880f0f2e465e 100644\n--- a/arch/x86/tools/relocs.c\n+++ b/arch/x86/tools/relocs.c\n@@ -223,6 +223,8 @@ static const char *rel_type(unsigned type)\n \t\tREL_TYPE(R_X86_64_JUMP_SLOT),\n \t\tREL_TYPE(R_X86_64_RELATIVE),\n \t\tREL_TYPE(R_X86_64_GOTPCREL),\n+\t\tREL_TYPE(R_X86_64_GOTPCRELX),\n+\t\tREL_TYPE(R_X86_64_REX_GOTPCRELX),\n \t\tREL_TYPE(R_X86_64_32),\n \t\tREL_TYPE(R_X86_64_32S),\n \t\tREL_TYPE(R_X86_64_16),\n@@ -843,6 +845,7 @@ static int do_reloc64(struct section *sec, Elf_Rel *rel, ElfW(Sym) *sym,\n \tcase R_X86_64_32:\n \tcase R_X86_64_32S:\n \tcase R_X86_64_64:\n+\tcase R_X86_64_GOTPCREL:\n \t\t/*\n \t\t * References to the percpu area don't need to be adjusted.\n \t\t */\n@@ -861,6 +864,31 @@ static int do_reloc64(struct section *sec, Elf_Rel *rel, ElfW(Sym) *sym,\n \t\t\tbreak;\n \t\t}\n \n+\t\tif (r_type == R_X86_64_GOTPCREL) {\n+\t\t\tElf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n+\t\t\tunsigned file_off = offset - s->sh_addr + s->sh_offset;\n+\n+\t\t\t/*\n+\t\t\t * GOTPCREL relocations refer to instructions that load\n+\t\t\t * a 64-bit address via a 32-bit relative reference to\n+\t\t\t * the GOT.  In this case, it is the GOT entry that\n+\t\t\t * needs to be fixed up, not the immediate offset in\n+\t\t\t * the opcode. Note that the linker will have applied an\n+\t\t\t * addend of -4 to compensate for the delta between the\n+\t\t\t * relocation offset and the value of RIP when the\n+\t\t\t * instruction executes, and this needs to be backed out\n+\t\t\t * again. (Addends other than -4 are permitted in\n+\t\t\t * principle, but make no sense in practice so they are\n+\t\t\t * not supported.)\n+                         */\n+\t\t\tif (rel->r_addend != -4) {\n+\t\t\t\tdie(\"invalid addend (%ld) for %s relocation: %s\\n\",\n+\t\t\t\t    rel->r_addend, rel_type(r_type), symname);\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\toffset += 4 + (int32_t)get_unaligned_le32(elf_image + file_off);\n+\t\t}\n+\n \t\t/*\n \t\t * Relocation offsets for 64 bit kernels are output\n \t\t * as 32 bits and sign extended back to 64 bits when\n@@ -870,7 +898,7 @@ static int do_",
          "year": "2024",
          "month": "09"
        },
        {
          "filepath": "emails/2024/10/172727696917857.mbox",
          "message_id": "<20240925150059.3955569-34-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-09-25 15:01:04+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:04 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nSome of the early x86_64 startup code is written in C, and executes in\nthe early 1:1 mapping of the kernel, which is not the address it was\nlinked at, and this requires special care when accessing global\nvariables. This is currently being dealt with on an ad-hoc basis,\nprimarily in head64.c, using explicit pointer fixups, but it would be\nbetter to rely on the compiler for this, by using -fPIE to generate code\nthat can run at any address, and uses RIP-relative accesses to refer to\nglobal variables.\n\nWhile it is possible to avoid most GOT based symbol references that the\ncompiler typically emits when running in -fPIE mode, by using 'hidden'\nvisibility, there are cases where the compiler will always rely on the\nGOT, for instance, for weak external references (which may remain\nunsatisfied at link time).\n\nThis means the build may produce a small number of GOT entries\nnonetheless. So update the reloc processing host tool to add support for\nthis, and place the GOT in the .text section rather than discard it.\n\nNote that multiple GOT based references to the same symbol will share a\nsingle GOT entry, and so naively emitting a relocation for the GOT entry\neach time a reference to it is encountered could result in duplicates.\nWork around this by relying on the fact that the relocation lists are\nsorted, and deduplicate 64-bit relocations as they are emitted by\ncomparing each entry with the previous one.\n\nSigned-off-by: Ard Biesheuvel <ardb@kernel.org>\n---\n arch/x86/Makefile                 |  4 +++\n arch/x86/kernel/vmlinux.lds.S     |  5 +++\n arch/x86/tools/relocs.c           | 33 ++++++++++++++++++--\n include/asm-generic/vmlinux.lds.h |  7 +++++\n 4 files changed, 47 insertions(+), 2 deletions(-)\n\ndiff --git a/arch/x86/Makefile b/arch/x86/Makefile\nindex 801fd85c3ef6..6b3fe6e2aadd 100644\n--- a/arch/x86/Makefile\n+++ b/arch/x86/Makefile\n@@ -192,6 +192,10 @@ else\n         KBUILD_CFLAGS += -mcmodel=kernel\n         KBUILD_RUSTFLAGS += -Cno-redzone=y\n         KBUILD_RUSTFLAGS += -Ccode-model=kernel\n+\n+        # Don't emit relaxable GOTPCREL relocations\n+        KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n+        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n endif\n \n #\ndiff --git a/arch/x86/kernel/vmlinux.lds.S b/arch/x86/kernel/vmlinux.lds.S\nindex 6e73403e874f..7f060d873f75 100644\n--- a/arch/x86/kernel/vmlinux.lds.S\n+++ b/arch/x86/kernel/vmlinux.lds.S\n@@ -20,6 +20,9 @@\n #define RUNTIME_DISCARD_EXIT\n #define EMITS_PT_NOTE\n #define RO_EXCEPTION_TABLE_ALIGN\t16\n+#ifdef CONFIG_X86_64\n+#define GOT_IN_RODATA\n+#endif\n \n #include <asm-generic/vmlinux.lds.h>\n #include <asm/asm-offsets.h>\n@@ -464,10 +467,12 @@ SECTIONS\n \t * Sections that should stay zero sized, which is safer to\n \t * explicitly check instead of blindly discarding.\n \t */\n+#ifdef CONFIG_X86_32\n \t.got : {\n \t\t*(.got) *(.igot.*)\n \t}\n \tASSERT(SIZEOF(.got) == 0, \"Unexpected GOT entries detected!\")\n+#endif\n \n \t.plt : {\n \t\t*(.plt) *(.plt.*) *(.iplt)\ndiff --git a/arch/x86/tools/relocs.c b/arch/x86/tools/relocs.c\nindex 35a73e4aa74d..880f0f2e465e 100644\n--- a/arch/x86/tools/relocs.c\n+++ b/arch/x86/tools/relocs.c\n@@ -223,6 +223,8 @@ static const char *rel_type(unsigned type)\n \t\tREL_TYPE(R_X86_64_JUMP_SLOT),\n \t\tREL_TYPE(R_X86_64_RELATIVE),\n \t\tREL_TYPE(R_X86_64_GOTPCREL),\n+\t\tREL_TYPE(R_X86_64_GOTPCRELX),\n+\t\tREL_TYPE(R_X86_64_REX_GOTPCRELX),\n \t\tREL_TYPE(R_X86_64_32),\n \t\tREL_TYPE(R_X86_64_32S),\n \t\tREL_TYPE(R_X86_64_16),\n@@ -843,6 +845,7 @@ static int do_reloc64(struct section *sec, Elf_Rel *rel, ElfW(Sym) *sym,\n \tcase R_X86_64_32:\n \tcase R_X86_64_32S:\n \tcase R_X86_64_64:\n+\tcase R_X86_64_GOTPCREL:\n \t\t/*\n \t\t * References to the percpu area don't need to be adjusted.\n \t\t */\n@@ -861,6 +864,31 @@ static int do_reloc64(struct section *sec, Elf_Rel *rel, ElfW(Sym) *sym,\n \t\t\tbreak;\n \t\t}\n \n+\t\tif (r_type == R_X86_64_GOTPCREL) {\n+\t\t\tElf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n+\t\t\tunsigned file_off = offset - s->sh_addr + s->sh_offset;\n+\n+\t\t\t/*\n+\t\t\t * GOTPCREL relocations refer to instructions that load\n+\t\t\t * a 64-bit address via a 32-bit relative reference to\n+\t\t\t * the GOT.  In this case, it is the GOT entry that\n+\t\t\t * needs to be fixed up, not the immediate offset in\n+\t\t\t * the opcode. Note that the linker will have applied an\n+\t\t\t * addend of -4 to compensate for the delta between the\n+\t\t\t * relocation offset and the value of RIP when the\n+\t\t\t * instruction executes, and this needs to be backed out\n+\t\t\t * again. (Addends other than -4 are permitted in\n+\t\t\t * principle, but make no sense in practice so they are\n+\t\t\t * not supported.)\n+                         */\n+\t\t\tif (rel->r_addend != -4) {\n+\t\t\t\tdie(\"invalid addend (%ld) for %s relocation: %s\\n\",\n+\t\t\t\t    rel->r_addend, rel_type(r_type), symname);\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\toffset += 4 + (int32_t)get_unaligned_le32(elf_image + file_off);\n+\t\t}\n+\n \t\t/*\n \t\t * Relocation offsets for 64 bit kernels are output\n \t\t * as 32 bits and sign extended back to 64 bits when\n@@ -870,7 +898,7 @@ static int do_",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172727696917856.mbox",
          "message_id": "<20240925150059.3955569-34-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-09-25 15:01:04+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:04 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nSome of the early x86_64 startup code is written in C, and executes in\nthe early 1:1 mapping of the kernel, which is not the address it was\nlinked at, and this requires special care when accessing global\nvariables. This is currently being dealt with on an ad-hoc basis,\nprimarily in head64.c, using explicit pointer fixups, but it would be\nbetter to rely on the compiler for this, by using -fPIE to generate code\nthat can run at any address, and uses RIP-relative accesses to refer to\nglobal variables.\n\nWhile it is possible to avoid most GOT based symbol references that the\ncompiler typically emits when running in -fPIE mode, by using 'hidden'\nvisibility, there are cases where the compiler will always rely on the\nGOT, for instance, for weak external references (which may remain\nunsatisfied at link time).\n\nThis means the build may produce a small number of GOT entries\nnonetheless. So update the reloc processing host tool to add support for\nthis, and place the GOT in the .text section rather than discard it.\n\nNote that multiple GOT based references to the same symbol will share a\nsingle GOT entry, and so naively emitting a relocation for the GOT entry\neach time a reference to it is encountered could result in duplicates.\nWork around this by relying on the fact that the relocation lists are\nsorted, and deduplicate 64-bit relocations as they are emitted by\ncomparing each entry with the previous one.\n\nSigned-off-by: Ard Biesheuvel <ardb@kernel.org>\n---\n arch/x86/Makefile                 |  4 +++\n arch/x86/kernel/vmlinux.lds.S     |  5 +++\n arch/x86/tools/relocs.c           | 33 ++++++++++++++++++--\n include/asm-generic/vmlinux.lds.h |  7 +++++\n 4 files changed, 47 insertions(+), 2 deletions(-)\n\ndiff --git a/arch/x86/Makefile b/arch/x86/Makefile\nindex 801fd85c3ef6..6b3fe6e2aadd 100644\n--- a/arch/x86/Makefile\n+++ b/arch/x86/Makefile\n@@ -192,6 +192,10 @@ else\n         KBUILD_CFLAGS += -mcmodel=kernel\n         KBUILD_RUSTFLAGS += -Cno-redzone=y\n         KBUILD_RUSTFLAGS += -Ccode-model=kernel\n+\n+        # Don't emit relaxable GOTPCREL relocations\n+        KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n+        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n endif\n \n #\ndiff --git a/arch/x86/kernel/vmlinux.lds.S b/arch/x86/kernel/vmlinux.lds.S\nindex 6e73403e874f..7f060d873f75 100644\n--- a/arch/x86/kernel/vmlinux.lds.S\n+++ b/arch/x86/kernel/vmlinux.lds.S\n@@ -20,6 +20,9 @@\n #define RUNTIME_DISCARD_EXIT\n #define EMITS_PT_NOTE\n #define RO_EXCEPTION_TABLE_ALIGN\t16\n+#ifdef CONFIG_X86_64\n+#define GOT_IN_RODATA\n+#endif\n \n #include <asm-generic/vmlinux.lds.h>\n #include <asm/asm-offsets.h>\n@@ -464,10 +467,12 @@ SECTIONS\n \t * Sections that should stay zero sized, which is safer to\n \t * explicitly check instead of blindly discarding.\n \t */\n+#ifdef CONFIG_X86_32\n \t.got : {\n \t\t*(.got) *(.igot.*)\n \t}\n \tASSERT(SIZEOF(.got) == 0, \"Unexpected GOT entries detected!\")\n+#endif\n \n \t.plt : {\n \t\t*(.plt) *(.plt.*) *(.iplt)\ndiff --git a/arch/x86/tools/relocs.c b/arch/x86/tools/relocs.c\nindex 35a73e4aa74d..880f0f2e465e 100644\n--- a/arch/x86/tools/relocs.c\n+++ b/arch/x86/tools/relocs.c\n@@ -223,6 +223,8 @@ static const char *rel_type(unsigned type)\n \t\tREL_TYPE(R_X86_64_JUMP_SLOT),\n \t\tREL_TYPE(R_X86_64_RELATIVE),\n \t\tREL_TYPE(R_X86_64_GOTPCREL),\n+\t\tREL_TYPE(R_X86_64_GOTPCRELX),\n+\t\tREL_TYPE(R_X86_64_REX_GOTPCRELX),\n \t\tREL_TYPE(R_X86_64_32),\n \t\tREL_TYPE(R_X86_64_32S),\n \t\tREL_TYPE(R_X86_64_16),\n@@ -843,6 +845,7 @@ static int do_reloc64(struct section *sec, Elf_Rel *rel, ElfW(Sym) *sym,\n \tcase R_X86_64_32:\n \tcase R_X86_64_32S:\n \tcase R_X86_64_64:\n+\tcase R_X86_64_GOTPCREL:\n \t\t/*\n \t\t * References to the percpu area don't need to be adjusted.\n \t\t */\n@@ -861,6 +864,31 @@ static int do_reloc64(struct section *sec, Elf_Rel *rel, ElfW(Sym) *sym,\n \t\t\tbreak;\n \t\t}\n \n+\t\tif (r_type == R_X86_64_GOTPCREL) {\n+\t\t\tElf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n+\t\t\tunsigned file_off = offset - s->sh_addr + s->sh_offset;\n+\n+\t\t\t/*\n+\t\t\t * GOTPCREL relocations refer to instructions that load\n+\t\t\t * a 64-bit address via a 32-bit relative reference to\n+\t\t\t * the GOT.  In this case, it is the GOT entry that\n+\t\t\t * needs to be fixed up, not the immediate offset in\n+\t\t\t * the opcode. Note that the linker will have applied an\n+\t\t\t * addend of -4 to compensate for the delta between the\n+\t\t\t * relocation offset and the value of RIP when the\n+\t\t\t * instruction executes, and this needs to be backed out\n+\t\t\t * again. (Addends other than -4 are permitted in\n+\t\t\t * principle, but make no sense in practice so they are\n+\t\t\t * not supported.)\n+                         */\n+\t\t\tif (rel->r_addend != -4) {\n+\t\t\t\tdie(\"invalid addend (%ld) for %s relocation: %s\\n\",\n+\t\t\t\t    rel->r_addend, rel_type(r_type), symname);\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\toffset += 4 + (int32_t)get_unaligned_le32(elf_image + file_off);\n+\t\t}\n+\n \t\t/*\n \t\t * Relocation offsets for 64 bit kernels are output\n \t\t * as 32 bits and sign extended back to 64 bits when\n@@ -870,7 +898,7 @@ static int do_",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172727698417891.mbox",
          "message_id": "<20240925150059.3955569-34-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-09-25 15:01:04+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:04 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nSome of the early x86_64 startup code is written in C, and executes in\nthe early 1:1 mapping of the kernel, which is not the address it was\nlinked at, and this requires special care when accessing global\nvariables. This is currently being dealt with on an ad-hoc basis,\nprimarily in head64.c, using explicit pointer fixups, but it would be\nbetter to rely on the compiler for this, by using -fPIE to generate code\nthat can run at any address, and uses RIP-relative accesses to refer to\nglobal variables.\n\nWhile it is possible to avoid most GOT based symbol references that the\ncompiler typically emits when running in -fPIE mode, by using 'hidden'\nvisibility, there are cases where the compiler will always rely on the\nGOT, for instance, for weak external references (which may remain\nunsatisfied at link time).\n\nThis means the build may produce a small number of GOT entries\nnonetheless. So update the reloc processing host tool to add support for\nthis, and place the GOT in the .text section rather than discard it.\n\nNote that multiple GOT based references to the same symbol will share a\nsingle GOT entry, and so naively emitting a relocation for the GOT entry\neach time a reference to it is encountered could result in duplicates.\nWork around this by relying on the fact that the relocation lists are\nsorted, and deduplicate 64-bit relocations as they are emitted by\ncomparing each entry with the previous one.\n\nSigned-off-by: Ard Biesheuvel <ardb@kernel.org>\n---\n arch/x86/Makefile                 |  4 +++\n arch/x86/kernel/vmlinux.lds.S     |  5 +++\n arch/x86/tools/relocs.c           | 33 ++++++++++++++++++--\n include/asm-generic/vmlinux.lds.h |  7 +++++\n 4 files changed, 47 insertions(+), 2 deletions(-)\n\ndiff --git a/arch/x86/Makefile b/arch/x86/Makefile\nindex 801fd85c3ef6..6b3fe6e2aadd 100644\n--- a/arch/x86/Makefile\n+++ b/arch/x86/Makefile\n@@ -192,6 +192,10 @@ else\n         KBUILD_CFLAGS += -mcmodel=kernel\n         KBUILD_RUSTFLAGS += -Cno-redzone=y\n         KBUILD_RUSTFLAGS += -Ccode-model=kernel\n+\n+        # Don't emit relaxable GOTPCREL relocations\n+        KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n+        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n endif\n \n #\ndiff --git a/arch/x86/kernel/vmlinux.lds.S b/arch/x86/kernel/vmlinux.lds.S\nindex 6e73403e874f..7f060d873f75 100644\n--- a/arch/x86/kernel/vmlinux.lds.S\n+++ b/arch/x86/kernel/vmlinux.lds.S\n@@ -20,6 +20,9 @@\n #define RUNTIME_DISCARD_EXIT\n #define EMITS_PT_NOTE\n #define RO_EXCEPTION_TABLE_ALIGN\t16\n+#ifdef CONFIG_X86_64\n+#define GOT_IN_RODATA\n+#endif\n \n #include <asm-generic/vmlinux.lds.h>\n #include <asm/asm-offsets.h>\n@@ -464,10 +467,12 @@ SECTIONS\n \t * Sections that should stay zero sized, which is safer to\n \t * explicitly check instead of blindly discarding.\n \t */\n+#ifdef CONFIG_X86_32\n \t.got : {\n \t\t*(.got) *(.igot.*)\n \t}\n \tASSERT(SIZEOF(.got) == 0, \"Unexpected GOT entries detected!\")\n+#endif\n \n \t.plt : {\n \t\t*(.plt) *(.plt.*) *(.iplt)\ndiff --git a/arch/x86/tools/relocs.c b/arch/x86/tools/relocs.c\nindex 35a73e4aa74d..880f0f2e465e 100644\n--- a/arch/x86/tools/relocs.c\n+++ b/arch/x86/tools/relocs.c\n@@ -223,6 +223,8 @@ static const char *rel_type(unsigned type)\n \t\tREL_TYPE(R_X86_64_JUMP_SLOT),\n \t\tREL_TYPE(R_X86_64_RELATIVE),\n \t\tREL_TYPE(R_X86_64_GOTPCREL),\n+\t\tREL_TYPE(R_X86_64_GOTPCRELX),\n+\t\tREL_TYPE(R_X86_64_REX_GOTPCRELX),\n \t\tREL_TYPE(R_X86_64_32),\n \t\tREL_TYPE(R_X86_64_32S),\n \t\tREL_TYPE(R_X86_64_16),\n@@ -843,6 +845,7 @@ static int do_reloc64(struct section *sec, Elf_Rel *rel, ElfW(Sym) *sym,\n \tcase R_X86_64_32:\n \tcase R_X86_64_32S:\n \tcase R_X86_64_64:\n+\tcase R_X86_64_GOTPCREL:\n \t\t/*\n \t\t * References to the percpu area don't need to be adjusted.\n \t\t */\n@@ -861,6 +864,31 @@ static int do_reloc64(struct section *sec, Elf_Rel *rel, ElfW(Sym) *sym,\n \t\t\tbreak;\n \t\t}\n \n+\t\tif (r_type == R_X86_64_GOTPCREL) {\n+\t\t\tElf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n+\t\t\tunsigned file_off = offset - s->sh_addr + s->sh_offset;\n+\n+\t\t\t/*\n+\t\t\t * GOTPCREL relocations refer to instructions that load\n+\t\t\t * a 64-bit address via a 32-bit relative reference to\n+\t\t\t * the GOT.  In this case, it is the GOT entry that\n+\t\t\t * needs to be fixed up, not the immediate offset in\n+\t\t\t * the opcode. Note that the linker will have applied an\n+\t\t\t * addend of -4 to compensate for the delta between the\n+\t\t\t * relocation offset and the value of RIP when the\n+\t\t\t * instruction executes, and this needs to be backed out\n+\t\t\t * again. (Addends other than -4 are permitted in\n+\t\t\t * principle, but make no sense in practice so they are\n+\t\t\t * not supported.)\n+                         */\n+\t\t\tif (rel->r_addend != -4) {\n+\t\t\t\tdie(\"invalid addend (%ld) for %s relocation: %s\\n\",\n+\t\t\t\t    rel->r_addend, rel_type(r_type), symname);\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\toffset += 4 + (int32_t)get_unaligned_le32(elf_image + file_off);\n+\t\t}\n+\n \t\t/*\n \t\t * Relocation offsets for 64 bit kernels are output\n \t\t * as 32 bits and sign extended back to 64 bits when\n@@ -870,7 +898,7 @@ static int do_",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172727697917879.mbox",
          "message_id": "<20240925150059.3955569-34-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-09-25 15:01:04+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:04 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nSome of the early x86_64 startup code is written in C, and executes in\nthe early 1:1 mapping of the kernel, which is not the address it was\nlinked at, and this requires special care when accessing global\nvariables. This is currently being dealt with on an ad-hoc basis,\nprimarily in head64.c, using explicit pointer fixups, but it would be\nbetter to rely on the compiler for this, by using -fPIE to generate code\nthat can run at any address, and uses RIP-relative accesses to refer to\nglobal variables.\n\nWhile it is possible to avoid most GOT based symbol references that the\ncompiler typically emits when running in -fPIE mode, by using 'hidden'\nvisibility, there are cases where the compiler will always rely on the\nGOT, for instance, for weak external references (which may remain\nunsatisfied at link time).\n\nThis means the build may produce a small number of GOT entries\nnonetheless. So update the reloc processing host tool to add support for\nthis, and place the GOT in the .text section rather than discard it.\n\nNote that multiple GOT based references to the same symbol will share a\nsingle GOT entry, and so naively emitting a relocation for the GOT entry\neach time a reference to it is encountered could result in duplicates.\nWork around this by relying on the fact that the relocation lists are\nsorted, and deduplicate 64-bit relocations as they are emitted by\ncomparing each entry with the previous one.\n\nSigned-off-by: Ard Biesheuvel <ardb@kernel.org>\n---\n arch/x86/Makefile                 |  4 +++\n arch/x86/kernel/vmlinux.lds.S     |  5 +++\n arch/x86/tools/relocs.c           | 33 ++++++++++++++++++--\n include/asm-generic/vmlinux.lds.h |  7 +++++\n 4 files changed, 47 insertions(+), 2 deletions(-)\n\ndiff --git a/arch/x86/Makefile b/arch/x86/Makefile\nindex 801fd85c3ef6..6b3fe6e2aadd 100644\n--- a/arch/x86/Makefile\n+++ b/arch/x86/Makefile\n@@ -192,6 +192,10 @@ else\n         KBUILD_CFLAGS += -mcmodel=kernel\n         KBUILD_RUSTFLAGS += -Cno-redzone=y\n         KBUILD_RUSTFLAGS += -Ccode-model=kernel\n+\n+        # Don't emit relaxable GOTPCREL relocations\n+        KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n+        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n endif\n \n #\ndiff --git a/arch/x86/kernel/vmlinux.lds.S b/arch/x86/kernel/vmlinux.lds.S\nindex 6e73403e874f..7f060d873f75 100644\n--- a/arch/x86/kernel/vmlinux.lds.S\n+++ b/arch/x86/kernel/vmlinux.lds.S\n@@ -20,6 +20,9 @@\n #define RUNTIME_DISCARD_EXIT\n #define EMITS_PT_NOTE\n #define RO_EXCEPTION_TABLE_ALIGN\t16\n+#ifdef CONFIG_X86_64\n+#define GOT_IN_RODATA\n+#endif\n \n #include <asm-generic/vmlinux.lds.h>\n #include <asm/asm-offsets.h>\n@@ -464,10 +467,12 @@ SECTIONS\n \t * Sections that should stay zero sized, which is safer to\n \t * explicitly check instead of blindly discarding.\n \t */\n+#ifdef CONFIG_X86_32\n \t.got : {\n \t\t*(.got) *(.igot.*)\n \t}\n \tASSERT(SIZEOF(.got) == 0, \"Unexpected GOT entries detected!\")\n+#endif\n \n \t.plt : {\n \t\t*(.plt) *(.plt.*) *(.iplt)\ndiff --git a/arch/x86/tools/relocs.c b/arch/x86/tools/relocs.c\nindex 35a73e4aa74d..880f0f2e465e 100644\n--- a/arch/x86/tools/relocs.c\n+++ b/arch/x86/tools/relocs.c\n@@ -223,6 +223,8 @@ static const char *rel_type(unsigned type)\n \t\tREL_TYPE(R_X86_64_JUMP_SLOT),\n \t\tREL_TYPE(R_X86_64_RELATIVE),\n \t\tREL_TYPE(R_X86_64_GOTPCREL),\n+\t\tREL_TYPE(R_X86_64_GOTPCRELX),\n+\t\tREL_TYPE(R_X86_64_REX_GOTPCRELX),\n \t\tREL_TYPE(R_X86_64_32),\n \t\tREL_TYPE(R_X86_64_32S),\n \t\tREL_TYPE(R_X86_64_16),\n@@ -843,6 +845,7 @@ static int do_reloc64(struct section *sec, Elf_Rel *rel, ElfW(Sym) *sym,\n \tcase R_X86_64_32:\n \tcase R_X86_64_32S:\n \tcase R_X86_64_64:\n+\tcase R_X86_64_GOTPCREL:\n \t\t/*\n \t\t * References to the percpu area don't need to be adjusted.\n \t\t */\n@@ -861,6 +864,31 @@ static int do_reloc64(struct section *sec, Elf_Rel *rel, ElfW(Sym) *sym,\n \t\t\tbreak;\n \t\t}\n \n+\t\tif (r_type == R_X86_64_GOTPCREL) {\n+\t\t\tElf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n+\t\t\tunsigned file_off = offset - s->sh_addr + s->sh_offset;\n+\n+\t\t\t/*\n+\t\t\t * GOTPCREL relocations refer to instructions that load\n+\t\t\t * a 64-bit address via a 32-bit relative reference to\n+\t\t\t * the GOT.  In this case, it is the GOT entry that\n+\t\t\t * needs to be fixed up, not the immediate offset in\n+\t\t\t * the opcode. Note that the linker will have applied an\n+\t\t\t * addend of -4 to compensate for the delta between the\n+\t\t\t * relocation offset and the value of RIP when the\n+\t\t\t * instruction executes, and this needs to be backed out\n+\t\t\t * again. (Addends other than -4 are permitted in\n+\t\t\t * principle, but make no sense in practice so they are\n+\t\t\t * not supported.)\n+                         */\n+\t\t\tif (rel->r_addend != -4) {\n+\t\t\t\tdie(\"invalid addend (%ld) for %s relocation: %s\\n\",\n+\t\t\t\t    rel->r_addend, rel_type(r_type), symname);\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\toffset += 4 + (int32_t)get_unaligned_le32(elf_image + file_off);\n+\t\t}\n+\n \t\t/*\n \t\t * Relocation offsets for 64 bit kernels are output\n \t\t * as 32 bits and sign extended back to 64 bits when\n@@ -870,7 +898,7 @@ static int do_",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172727696417846.mbox",
          "message_id": "<20240925150059.3955569-34-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-09-25 15:01:04+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:04 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nSome of the early x86_64 startup code is written in C, and executes in\nthe early 1:1 mapping of the kernel, which is not the address it was\nlinked at, and this requires special care when accessing global\nvariables. This is currently being dealt with on an ad-hoc basis,\nprimarily in head64.c, using explicit pointer fixups, but it would be\nbetter to rely on the compiler for this, by using -fPIE to generate code\nthat can run at any address, and uses RIP-relative accesses to refer to\nglobal variables.\n\nWhile it is possible to avoid most GOT based symbol references that the\ncompiler typically emits when running in -fPIE mode, by using 'hidden'\nvisibility, there are cases where the compiler will always rely on the\nGOT, for instance, for weak external references (which may remain\nunsatisfied at link time).\n\nThis means the build may produce a small number of GOT entries\nnonetheless. So update the reloc processing host tool to add support for\nthis, and place the GOT in the .text section rather than discard it.\n\nNote that multiple GOT based references to the same symbol will share a\nsingle GOT entry, and so naively emitting a relocation for the GOT entry\neach time a reference to it is encountered could result in duplicates.\nWork around this by relying on the fact that the relocation lists are\nsorted, and deduplicate 64-bit relocations as they are emitted by\ncomparing each entry with the previous one.\n\nSigned-off-by: Ard Biesheuvel <ardb@kernel.org>\n---\n arch/x86/Makefile                 |  4 +++\n arch/x86/kernel/vmlinux.lds.S     |  5 +++\n arch/x86/tools/relocs.c           | 33 ++++++++++++++++++--\n include/asm-generic/vmlinux.lds.h |  7 +++++\n 4 files changed, 47 insertions(+), 2 deletions(-)\n\ndiff --git a/arch/x86/Makefile b/arch/x86/Makefile\nindex 801fd85c3ef6..6b3fe6e2aadd 100644\n--- a/arch/x86/Makefile\n+++ b/arch/x86/Makefile\n@@ -192,6 +192,10 @@ else\n         KBUILD_CFLAGS += -mcmodel=kernel\n         KBUILD_RUSTFLAGS += -Cno-redzone=y\n         KBUILD_RUSTFLAGS += -Ccode-model=kernel\n+\n+        # Don't emit relaxable GOTPCREL relocations\n+        KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n+        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n endif\n \n #\ndiff --git a/arch/x86/kernel/vmlinux.lds.S b/arch/x86/kernel/vmlinux.lds.S\nindex 6e73403e874f..7f060d873f75 100644\n--- a/arch/x86/kernel/vmlinux.lds.S\n+++ b/arch/x86/kernel/vmlinux.lds.S\n@@ -20,6 +20,9 @@\n #define RUNTIME_DISCARD_EXIT\n #define EMITS_PT_NOTE\n #define RO_EXCEPTION_TABLE_ALIGN\t16\n+#ifdef CONFIG_X86_64\n+#define GOT_IN_RODATA\n+#endif\n \n #include <asm-generic/vmlinux.lds.h>\n #include <asm/asm-offsets.h>\n@@ -464,10 +467,12 @@ SECTIONS\n \t * Sections that should stay zero sized, which is safer to\n \t * explicitly check instead of blindly discarding.\n \t */\n+#ifdef CONFIG_X86_32\n \t.got : {\n \t\t*(.got) *(.igot.*)\n \t}\n \tASSERT(SIZEOF(.got) == 0, \"Unexpected GOT entries detected!\")\n+#endif\n \n \t.plt : {\n \t\t*(.plt) *(.plt.*) *(.iplt)\ndiff --git a/arch/x86/tools/relocs.c b/arch/x86/tools/relocs.c\nindex 35a73e4aa74d..880f0f2e465e 100644\n--- a/arch/x86/tools/relocs.c\n+++ b/arch/x86/tools/relocs.c\n@@ -223,6 +223,8 @@ static const char *rel_type(unsigned type)\n \t\tREL_TYPE(R_X86_64_JUMP_SLOT),\n \t\tREL_TYPE(R_X86_64_RELATIVE),\n \t\tREL_TYPE(R_X86_64_GOTPCREL),\n+\t\tREL_TYPE(R_X86_64_GOTPCRELX),\n+\t\tREL_TYPE(R_X86_64_REX_GOTPCRELX),\n \t\tREL_TYPE(R_X86_64_32),\n \t\tREL_TYPE(R_X86_64_32S),\n \t\tREL_TYPE(R_X86_64_16),\n@@ -843,6 +845,7 @@ static int do_reloc64(struct section *sec, Elf_Rel *rel, ElfW(Sym) *sym,\n \tcase R_X86_64_32:\n \tcase R_X86_64_32S:\n \tcase R_X86_64_64:\n+\tcase R_X86_64_GOTPCREL:\n \t\t/*\n \t\t * References to the percpu area don't need to be adjusted.\n \t\t */\n@@ -861,6 +864,31 @@ static int do_reloc64(struct section *sec, Elf_Rel *rel, ElfW(Sym) *sym,\n \t\t\tbreak;\n \t\t}\n \n+\t\tif (r_type == R_X86_64_GOTPCREL) {\n+\t\t\tElf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n+\t\t\tunsigned file_off = offset - s->sh_addr + s->sh_offset;\n+\n+\t\t\t/*\n+\t\t\t * GOTPCREL relocations refer to instructions that load\n+\t\t\t * a 64-bit address via a 32-bit relative reference to\n+\t\t\t * the GOT.  In this case, it is the GOT entry that\n+\t\t\t * needs to be fixed up, not the immediate offset in\n+\t\t\t * the opcode. Note that the linker will have applied an\n+\t\t\t * addend of -4 to compensate for the delta between the\n+\t\t\t * relocation offset and the value of RIP when the\n+\t\t\t * instruction executes, and this needs to be backed out\n+\t\t\t * again. (Addends other than -4 are permitted in\n+\t\t\t * principle, but make no sense in practice so they are\n+\t\t\t * not supported.)\n+                         */\n+\t\t\tif (rel->r_addend != -4) {\n+\t\t\t\tdie(\"invalid addend (%ld) for %s relocation: %s\\n\",\n+\t\t\t\t    rel->r_addend, rel_type(r_type), symname);\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\toffset += 4 + (int32_t)get_unaligned_le32(elf_image + file_off);\n+\t\t}\n+\n \t\t/*\n \t\t * Relocation offsets for 64 bit kernels are output\n \t\t * as 32 bits and sign extended back to 64 bits when\n@@ -870,7 +898,7 @@ static int do_",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172727698417892.mbox",
          "message_id": "<20240925150059.3955569-34-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-09-25 15:01:04+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:04 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nSome of the early x86_64 startup code is written in C, and executes in\nthe early 1:1 mapping of the kernel, which is not the address it was\nlinked at, and this requires special care when accessing global\nvariables. This is currently being dealt with on an ad-hoc basis,\nprimarily in head64.c, using explicit pointer fixups, but it would be\nbetter to rely on the compiler for this, by using -fPIE to generate code\nthat can run at any address, and uses RIP-relative accesses to refer to\nglobal variables.\n\nWhile it is possible to avoid most GOT based symbol references that the\ncompiler typically emits when running in -fPIE mode, by using 'hidden'\nvisibility, there are cases where the compiler will always rely on the\nGOT, for instance, for weak external references (which may remain\nunsatisfied at link time).\n\nThis means the build may produce a small number of GOT entries\nnonetheless. So update the reloc processing host tool to add support for\nthis, and place the GOT in the .text section rather than discard it.\n\nNote that multiple GOT based references to the same symbol will share a\nsingle GOT entry, and so naively emitting a relocation for the GOT entry\neach time a reference to it is encountered could result in duplicates.\nWork around this by relying on the fact that the relocation lists are\nsorted, and deduplicate 64-bit relocations as they are emitted by\ncomparing each entry with the previous one.\n\nSigned-off-by: Ard Biesheuvel <ardb@kernel.org>\n---\n arch/x86/Makefile                 |  4 +++\n arch/x86/kernel/vmlinux.lds.S     |  5 +++\n arch/x86/tools/relocs.c           | 33 ++++++++++++++++++--\n include/asm-generic/vmlinux.lds.h |  7 +++++\n 4 files changed, 47 insertions(+), 2 deletions(-)\n\ndiff --git a/arch/x86/Makefile b/arch/x86/Makefile\nindex 801fd85c3ef6..6b3fe6e2aadd 100644\n--- a/arch/x86/Makefile\n+++ b/arch/x86/Makefile\n@@ -192,6 +192,10 @@ else\n         KBUILD_CFLAGS += -mcmodel=kernel\n         KBUILD_RUSTFLAGS += -Cno-redzone=y\n         KBUILD_RUSTFLAGS += -Ccode-model=kernel\n+\n+        # Don't emit relaxable GOTPCREL relocations\n+        KBUILD_AFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n+        KBUILD_CFLAGS_KERNEL += -Wa,-mrelax-relocations=no\n endif\n \n #\ndiff --git a/arch/x86/kernel/vmlinux.lds.S b/arch/x86/kernel/vmlinux.lds.S\nindex 6e73403e874f..7f060d873f75 100644\n--- a/arch/x86/kernel/vmlinux.lds.S\n+++ b/arch/x86/kernel/vmlinux.lds.S\n@@ -20,6 +20,9 @@\n #define RUNTIME_DISCARD_EXIT\n #define EMITS_PT_NOTE\n #define RO_EXCEPTION_TABLE_ALIGN\t16\n+#ifdef CONFIG_X86_64\n+#define GOT_IN_RODATA\n+#endif\n \n #include <asm-generic/vmlinux.lds.h>\n #include <asm/asm-offsets.h>\n@@ -464,10 +467,12 @@ SECTIONS\n \t * Sections that should stay zero sized, which is safer to\n \t * explicitly check instead of blindly discarding.\n \t */\n+#ifdef CONFIG_X86_32\n \t.got : {\n \t\t*(.got) *(.igot.*)\n \t}\n \tASSERT(SIZEOF(.got) == 0, \"Unexpected GOT entries detected!\")\n+#endif\n \n \t.plt : {\n \t\t*(.plt) *(.plt.*) *(.iplt)\ndiff --git a/arch/x86/tools/relocs.c b/arch/x86/tools/relocs.c\nindex 35a73e4aa74d..880f0f2e465e 100644\n--- a/arch/x86/tools/relocs.c\n+++ b/arch/x86/tools/relocs.c\n@@ -223,6 +223,8 @@ static const char *rel_type(unsigned type)\n \t\tREL_TYPE(R_X86_64_JUMP_SLOT),\n \t\tREL_TYPE(R_X86_64_RELATIVE),\n \t\tREL_TYPE(R_X86_64_GOTPCREL),\n+\t\tREL_TYPE(R_X86_64_GOTPCRELX),\n+\t\tREL_TYPE(R_X86_64_REX_GOTPCRELX),\n \t\tREL_TYPE(R_X86_64_32),\n \t\tREL_TYPE(R_X86_64_32S),\n \t\tREL_TYPE(R_X86_64_16),\n@@ -843,6 +845,7 @@ static int do_reloc64(struct section *sec, Elf_Rel *rel, ElfW(Sym) *sym,\n \tcase R_X86_64_32:\n \tcase R_X86_64_32S:\n \tcase R_X86_64_64:\n+\tcase R_X86_64_GOTPCREL:\n \t\t/*\n \t\t * References to the percpu area don't need to be adjusted.\n \t\t */\n@@ -861,6 +864,31 @@ static int do_reloc64(struct section *sec, Elf_Rel *rel, ElfW(Sym) *sym,\n \t\t\tbreak;\n \t\t}\n \n+\t\tif (r_type == R_X86_64_GOTPCREL) {\n+\t\t\tElf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n+\t\t\tunsigned file_off = offset - s->sh_addr + s->sh_offset;\n+\n+\t\t\t/*\n+\t\t\t * GOTPCREL relocations refer to instructions that load\n+\t\t\t * a 64-bit address via a 32-bit relative reference to\n+\t\t\t * the GOT.  In this case, it is the GOT entry that\n+\t\t\t * needs to be fixed up, not the immediate offset in\n+\t\t\t * the opcode. Note that the linker will have applied an\n+\t\t\t * addend of -4 to compensate for the delta between the\n+\t\t\t * relocation offset and the value of RIP when the\n+\t\t\t * instruction executes, and this needs to be backed out\n+\t\t\t * again. (Addends other than -4 are permitted in\n+\t\t\t * principle, but make no sense in practice so they are\n+\t\t\t * not supported.)\n+                         */\n+\t\t\tif (rel->r_addend != -4) {\n+\t\t\t\tdie(\"invalid addend (%ld) for %s relocation: %s\\n\",\n+\t\t\t\t    rel->r_addend, rel_type(r_type), symname);\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\toffset += 4 + (int32_t)get_unaligned_le32(elf_image + file_off);\n+\t\t}\n+\n \t\t/*\n \t\t * Relocation offsets for 64 bit kernels are output\n \t\t * as 32 bits and sign extended back to 64 bits when\n@@ -870,7 +898,7 @@ static int do_",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172776068918147.mbox",
          "message_id": "<20241001053318.elfwwiyluw6rlynz () treble>",
          "author_name": "Josh Poimboeuf",
          "author_email": "jpoimboe () kernel ! org",
          "subject": "Re: [RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-10-01 05:33:18+00:00",
          "date_str": "Tue, 01 Oct 2024 05:33:18 +0000",
          "body": "On Wed, Sep 25, 2024 at 05:01:04PM +0200, Ard Biesheuvel wrote:\n> +\t\tif (r_type == R_X86_64_GOTPCREL) {\n> +\t\t\tElf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n> +\t\t\tunsigned file_off = offset - s->sh_addr + s->sh_offset;\n> +\n> +\t\t\t/*\n> +\t\t\t * GOTPCREL relocations refer to instructions that load\n> +\t\t\t * a 64-bit address via a 32-bit relative reference to\n> +\t\t\t * the GOT.  In this case, it is the GOT entry that\n> +\t\t\t * needs to be fixed up, not the immediate offset in\n> +\t\t\t * the opcode. Note that the linker will have applied an\n> +\t\t\t * addend of -4 to compensate for the delta between the\n> +\t\t\t * relocation offset and the value of RIP when the\n> +\t\t\t * instruction executes, and this needs to be backed out\n> +\t\t\t * again. (Addends other than -4 are permitted in\n> +\t\t\t * principle, but make no sense in practice so they are\n> +\t\t\t * not supported.)\n> +                         */\n> +\t\t\tif (rel->r_addend != -4) {\n> +\t\t\t\tdie(\"invalid addend (%ld) for %s relocation: %s\\n\",\n> +\t\t\t\t    rel->r_addend, rel_type(r_type), symname);\n> +\t\t\t\tbreak;\n> +\t\t\t}\n\nFor x86 PC-relative addressing, the addend is <reloc offset> -\n<subsequent insn offset>.  So a PC-relative addend can be something\nother than -4 when the relocation applies to the middle of an\ninstruction, e.g.:\n\n   5b381:\t66 81 3d 00 00 00 00 01 06 \tcmpw   $0x601,0x0(%rip)        # 5b38a <generic_validate_add_page+0x4a>\t5b384: R_X86_64_PC32\tboot_cpu_data-0x6\n\n   5f283:\t81 3d 00 00 00 00 ff ff ff 00 \tcmpl   $0xffffff,0x0(%rip)        # 5f28d <x86_acpi_suspend_lowlevel+0x9d>\t5f285: R_X86_64_PC32\tsmpboot_control-0x8\n\n   72f67:       c6 05 00 00 00 00 01    movb   $0x1,0x0(%rip)        # 72f6e <sched_itmt_update_handler+0x6e>   72f69: R_X86_64_PC32    x86_topology_update-0x5\n\nPresumably that could also happen with R_X86_64_GOTPCREL?\n\n-- \nJosh\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172776068618142.mbox",
          "message_id": "<20241001053318.elfwwiyluw6rlynz () treble>",
          "author_name": "Josh Poimboeuf",
          "author_email": "jpoimboe () kernel ! org",
          "subject": "Re: [RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-10-01 05:33:18+00:00",
          "date_str": "Tue, 01 Oct 2024 05:33:18 +0000",
          "body": "On Wed, Sep 25, 2024 at 05:01:04PM +0200, Ard Biesheuvel wrote:\n> +\t\tif (r_type == R_X86_64_GOTPCREL) {\n> +\t\t\tElf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n> +\t\t\tunsigned file_off = offset - s->sh_addr + s->sh_offset;\n> +\n> +\t\t\t/*\n> +\t\t\t * GOTPCREL relocations refer to instructions that load\n> +\t\t\t * a 64-bit address via a 32-bit relative reference to\n> +\t\t\t * the GOT.  In this case, it is the GOT entry that\n> +\t\t\t * needs to be fixed up, not the immediate offset in\n> +\t\t\t * the opcode. Note that the linker will have applied an\n> +\t\t\t * addend of -4 to compensate for the delta between the\n> +\t\t\t * relocation offset and the value of RIP when the\n> +\t\t\t * instruction executes, and this needs to be backed out\n> +\t\t\t * again. (Addends other than -4 are permitted in\n> +\t\t\t * principle, but make no sense in practice so they are\n> +\t\t\t * not supported.)\n> +                         */\n> +\t\t\tif (rel->r_addend != -4) {\n> +\t\t\t\tdie(\"invalid addend (%ld) for %s relocation: %s\\n\",\n> +\t\t\t\t    rel->r_addend, rel_type(r_type), symname);\n> +\t\t\t\tbreak;\n> +\t\t\t}\n\nFor x86 PC-relative addressing, the addend is <reloc offset> -\n<subsequent insn offset>.  So a PC-relative addend can be something\nother than -4 when the relocation applies to the middle of an\ninstruction, e.g.:\n\n   5b381:\t66 81 3d 00 00 00 00 01 06 \tcmpw   $0x601,0x0(%rip)        # 5b38a <generic_validate_add_page+0x4a>\t5b384: R_X86_64_PC32\tboot_cpu_data-0x6\n\n   5f283:\t81 3d 00 00 00 00 ff ff ff 00 \tcmpl   $0xffffff,0x0(%rip)        # 5f28d <x86_acpi_suspend_lowlevel+0x9d>\t5f285: R_X86_64_PC32\tsmpboot_control-0x8\n\n   72f67:       c6 05 00 00 00 00 01    movb   $0x1,0x0(%rip)        # 72f6e <sched_itmt_update_handler+0x6e>   72f69: R_X86_64_PC32    x86_topology_update-0x5\n\nPresumably that could also happen with R_X86_64_GOTPCREL?\n\n-- \nJosh\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172776068418127.mbox",
          "message_id": "<20241001053318.elfwwiyluw6rlynz () treble>",
          "author_name": "Josh Poimboeuf",
          "author_email": "jpoimboe () kernel ! org",
          "subject": "Re: [RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-10-01 05:33:18+00:00",
          "date_str": "Tue, 01 Oct 2024 05:33:18 +0000",
          "body": "On Wed, Sep 25, 2024 at 05:01:04PM +0200, Ard Biesheuvel wrote:\n> +\t\tif (r_type == R_X86_64_GOTPCREL) {\n> +\t\t\tElf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n> +\t\t\tunsigned file_off = offset - s->sh_addr + s->sh_offset;\n> +\n> +\t\t\t/*\n> +\t\t\t * GOTPCREL relocations refer to instructions that load\n> +\t\t\t * a 64-bit address via a 32-bit relative reference to\n> +\t\t\t * the GOT.  In this case, it is the GOT entry that\n> +\t\t\t * needs to be fixed up, not the immediate offset in\n> +\t\t\t * the opcode. Note that the linker will have applied an\n> +\t\t\t * addend of -4 to compensate for the delta between the\n> +\t\t\t * relocation offset and the value of RIP when the\n> +\t\t\t * instruction executes, and this needs to be backed out\n> +\t\t\t * again. (Addends other than -4 are permitted in\n> +\t\t\t * principle, but make no sense in practice so they are\n> +\t\t\t * not supported.)\n> +                         */\n> +\t\t\tif (rel->r_addend != -4) {\n> +\t\t\t\tdie(\"invalid addend (%ld) for %s relocation: %s\\n\",\n> +\t\t\t\t    rel->r_addend, rel_type(r_type), symname);\n> +\t\t\t\tbreak;\n> +\t\t\t}\n\nFor x86 PC-relative addressing, the addend is <reloc offset> -\n<subsequent insn offset>.  So a PC-relative addend can be something\nother than -4 when the relocation applies to the middle of an\ninstruction, e.g.:\n\n   5b381:\t66 81 3d 00 00 00 00 01 06 \tcmpw   $0x601,0x0(%rip)        # 5b38a <generic_validate_add_page+0x4a>\t5b384: R_X86_64_PC32\tboot_cpu_data-0x6\n\n   5f283:\t81 3d 00 00 00 00 ff ff ff 00 \tcmpl   $0xffffff,0x0(%rip)        # 5f28d <x86_acpi_suspend_lowlevel+0x9d>\t5f285: R_X86_64_PC32\tsmpboot_control-0x8\n\n   72f67:       c6 05 00 00 00 00 01    movb   $0x1,0x0(%rip)        # 72f6e <sched_itmt_update_handler+0x6e>   72f69: R_X86_64_PC32    x86_topology_update-0x5\n\nPresumably that could also happen with R_X86_64_GOTPCREL?\n\n-- \nJosh\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172776068618139.mbox",
          "message_id": "<20241001053318.elfwwiyluw6rlynz () treble>",
          "author_name": "Josh Poimboeuf",
          "author_email": "jpoimboe () kernel ! org",
          "subject": "Re: [RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-10-01 05:33:18+00:00",
          "date_str": "Tue, 01 Oct 2024 05:33:18 +0000",
          "body": "On Wed, Sep 25, 2024 at 05:01:04PM +0200, Ard Biesheuvel wrote:\n> +\t\tif (r_type == R_X86_64_GOTPCREL) {\n> +\t\t\tElf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n> +\t\t\tunsigned file_off = offset - s->sh_addr + s->sh_offset;\n> +\n> +\t\t\t/*\n> +\t\t\t * GOTPCREL relocations refer to instructions that load\n> +\t\t\t * a 64-bit address via a 32-bit relative reference to\n> +\t\t\t * the GOT.  In this case, it is the GOT entry that\n> +\t\t\t * needs to be fixed up, not the immediate offset in\n> +\t\t\t * the opcode. Note that the linker will have applied an\n> +\t\t\t * addend of -4 to compensate for the delta between the\n> +\t\t\t * relocation offset and the value of RIP when the\n> +\t\t\t * instruction executes, and this needs to be backed out\n> +\t\t\t * again. (Addends other than -4 are permitted in\n> +\t\t\t * principle, but make no sense in practice so they are\n> +\t\t\t * not supported.)\n> +                         */\n> +\t\t\tif (rel->r_addend != -4) {\n> +\t\t\t\tdie(\"invalid addend (%ld) for %s relocation: %s\\n\",\n> +\t\t\t\t    rel->r_addend, rel_type(r_type), symname);\n> +\t\t\t\tbreak;\n> +\t\t\t}\n\nFor x86 PC-relative addressing, the addend is <reloc offset> -\n<subsequent insn offset>.  So a PC-relative addend can be something\nother than -4 when the relocation applies to the middle of an\ninstruction, e.g.:\n\n   5b381:\t66 81 3d 00 00 00 00 01 06 \tcmpw   $0x601,0x0(%rip)        # 5b38a <generic_validate_add_page+0x4a>\t5b384: R_X86_64_PC32\tboot_cpu_data-0x6\n\n   5f283:\t81 3d 00 00 00 00 ff ff ff 00 \tcmpl   $0xffffff,0x0(%rip)        # 5f28d <x86_acpi_suspend_lowlevel+0x9d>\t5f285: R_X86_64_PC32\tsmpboot_control-0x8\n\n   72f67:       c6 05 00 00 00 00 01    movb   $0x1,0x0(%rip)        # 72f6e <sched_itmt_update_handler+0x6e>   72f69: R_X86_64_PC32    x86_topology_update-0x5\n\nPresumably that could also happen with R_X86_64_GOTPCREL?\n\n-- \nJosh\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172776068718143.mbox",
          "message_id": "<20241001053318.elfwwiyluw6rlynz () treble>",
          "author_name": "Josh Poimboeuf",
          "author_email": "jpoimboe () kernel ! org",
          "subject": "Re: [RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-10-01 05:33:18+00:00",
          "date_str": "Tue, 01 Oct 2024 05:33:18 +0000",
          "body": "On Wed, Sep 25, 2024 at 05:01:04PM +0200, Ard Biesheuvel wrote:\n> +\t\tif (r_type == R_X86_64_GOTPCREL) {\n> +\t\t\tElf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n> +\t\t\tunsigned file_off = offset - s->sh_addr + s->sh_offset;\n> +\n> +\t\t\t/*\n> +\t\t\t * GOTPCREL relocations refer to instructions that load\n> +\t\t\t * a 64-bit address via a 32-bit relative reference to\n> +\t\t\t * the GOT.  In this case, it is the GOT entry that\n> +\t\t\t * needs to be fixed up, not the immediate offset in\n> +\t\t\t * the opcode. Note that the linker will have applied an\n> +\t\t\t * addend of -4 to compensate for the delta between the\n> +\t\t\t * relocation offset and the value of RIP when the\n> +\t\t\t * instruction executes, and this needs to be backed out\n> +\t\t\t * again. (Addends other than -4 are permitted in\n> +\t\t\t * principle, but make no sense in practice so they are\n> +\t\t\t * not supported.)\n> +                         */\n> +\t\t\tif (rel->r_addend != -4) {\n> +\t\t\t\tdie(\"invalid addend (%ld) for %s relocation: %s\\n\",\n> +\t\t\t\t    rel->r_addend, rel_type(r_type), symname);\n> +\t\t\t\tbreak;\n> +\t\t\t}\n\nFor x86 PC-relative addressing, the addend is <reloc offset> -\n<subsequent insn offset>.  So a PC-relative addend can be something\nother than -4 when the relocation applies to the middle of an\ninstruction, e.g.:\n\n   5b381:\t66 81 3d 00 00 00 00 01 06 \tcmpw   $0x601,0x0(%rip)        # 5b38a <generic_validate_add_page+0x4a>\t5b384: R_X86_64_PC32\tboot_cpu_data-0x6\n\n   5f283:\t81 3d 00 00 00 00 ff ff ff 00 \tcmpl   $0xffffff,0x0(%rip)        # 5f28d <x86_acpi_suspend_lowlevel+0x9d>\t5f285: R_X86_64_PC32\tsmpboot_control-0x8\n\n   72f67:       c6 05 00 00 00 00 01    movb   $0x1,0x0(%rip)        # 72f6e <sched_itmt_update_handler+0x6e>   72f69: R_X86_64_PC32    x86_topology_update-0x5\n\nPresumably that could also happen with R_X86_64_GOTPCREL?\n\n-- \nJosh\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172776069518156.mbox",
          "message_id": "<20241001053318.elfwwiyluw6rlynz () treble>",
          "author_name": "Josh Poimboeuf",
          "author_email": "jpoimboe () kernel ! org",
          "subject": "Re: [RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-10-01 05:33:18+00:00",
          "date_str": "Tue, 01 Oct 2024 05:33:18 +0000",
          "body": "On Wed, Sep 25, 2024 at 05:01:04PM +0200, Ard Biesheuvel wrote:\n> +\t\tif (r_type == R_X86_64_GOTPCREL) {\n> +\t\t\tElf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n> +\t\t\tunsigned file_off = offset - s->sh_addr + s->sh_offset;\n> +\n> +\t\t\t/*\n> +\t\t\t * GOTPCREL relocations refer to instructions that load\n> +\t\t\t * a 64-bit address via a 32-bit relative reference to\n> +\t\t\t * the GOT.  In this case, it is the GOT entry that\n> +\t\t\t * needs to be fixed up, not the immediate offset in\n> +\t\t\t * the opcode. Note that the linker will have applied an\n> +\t\t\t * addend of -4 to compensate for the delta between the\n> +\t\t\t * relocation offset and the value of RIP when the\n> +\t\t\t * instruction executes, and this needs to be backed out\n> +\t\t\t * again. (Addends other than -4 are permitted in\n> +\t\t\t * principle, but make no sense in practice so they are\n> +\t\t\t * not supported.)\n> +                         */\n> +\t\t\tif (rel->r_addend != -4) {\n> +\t\t\t\tdie(\"invalid addend (%ld) for %s relocation: %s\\n\",\n> +\t\t\t\t    rel->r_addend, rel_type(r_type), symname);\n> +\t\t\t\tbreak;\n> +\t\t\t}\n\nFor x86 PC-relative addressing, the addend is <reloc offset> -\n<subsequent insn offset>.  So a PC-relative addend can be something\nother than -4 when the relocation applies to the middle of an\ninstruction, e.g.:\n\n   5b381:\t66 81 3d 00 00 00 00 01 06 \tcmpw   $0x601,0x0(%rip)        # 5b38a <generic_validate_add_page+0x4a>\t5b384: R_X86_64_PC32\tboot_cpu_data-0x6\n\n   5f283:\t81 3d 00 00 00 00 ff ff ff 00 \tcmpl   $0xffffff,0x0(%rip)        # 5f28d <x86_acpi_suspend_lowlevel+0x9d>\t5f285: R_X86_64_PC32\tsmpboot_control-0x8\n\n   72f67:       c6 05 00 00 00 00 01    movb   $0x1,0x0(%rip)        # 72f6e <sched_itmt_update_handler+0x6e>   72f69: R_X86_64_PC32    x86_topology_update-0x5\n\nPresumably that could also happen with R_X86_64_GOTPCREL?\n\n-- \nJosh\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172776068518128.mbox",
          "message_id": "<20241001053318.elfwwiyluw6rlynz () treble>",
          "author_name": "Josh Poimboeuf",
          "author_email": "jpoimboe () kernel ! org",
          "subject": "Re: [RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-10-01 05:33:18+00:00",
          "date_str": "Tue, 01 Oct 2024 05:33:18 +0000",
          "body": "On Wed, Sep 25, 2024 at 05:01:04PM +0200, Ard Biesheuvel wrote:\n> +\t\tif (r_type == R_X86_64_GOTPCREL) {\n> +\t\t\tElf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n> +\t\t\tunsigned file_off = offset - s->sh_addr + s->sh_offset;\n> +\n> +\t\t\t/*\n> +\t\t\t * GOTPCREL relocations refer to instructions that load\n> +\t\t\t * a 64-bit address via a 32-bit relative reference to\n> +\t\t\t * the GOT.  In this case, it is the GOT entry that\n> +\t\t\t * needs to be fixed up, not the immediate offset in\n> +\t\t\t * the opcode. Note that the linker will have applied an\n> +\t\t\t * addend of -4 to compensate for the delta between the\n> +\t\t\t * relocation offset and the value of RIP when the\n> +\t\t\t * instruction executes, and this needs to be backed out\n> +\t\t\t * again. (Addends other than -4 are permitted in\n> +\t\t\t * principle, but make no sense in practice so they are\n> +\t\t\t * not supported.)\n> +                         */\n> +\t\t\tif (rel->r_addend != -4) {\n> +\t\t\t\tdie(\"invalid addend (%ld) for %s relocation: %s\\n\",\n> +\t\t\t\t    rel->r_addend, rel_type(r_type), symname);\n> +\t\t\t\tbreak;\n> +\t\t\t}\n\nFor x86 PC-relative addressing, the addend is <reloc offset> -\n<subsequent insn offset>.  So a PC-relative addend can be something\nother than -4 when the relocation applies to the middle of an\ninstruction, e.g.:\n\n   5b381:\t66 81 3d 00 00 00 00 01 06 \tcmpw   $0x601,0x0(%rip)        # 5b38a <generic_validate_add_page+0x4a>\t5b384: R_X86_64_PC32\tboot_cpu_data-0x6\n\n   5f283:\t81 3d 00 00 00 00 ff ff ff 00 \tcmpl   $0xffffff,0x0(%rip)        # 5f28d <x86_acpi_suspend_lowlevel+0x9d>\t5f285: R_X86_64_PC32\tsmpboot_control-0x8\n\n   72f67:       c6 05 00 00 00 00 01    movb   $0x1,0x0(%rip)        # 72f6e <sched_itmt_update_handler+0x6e>   72f69: R_X86_64_PC32    x86_topology_update-0x5\n\nPresumably that could also happen with R_X86_64_GOTPCREL?\n\n-- \nJosh\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172776068818144.mbox",
          "message_id": "<20241001053318.elfwwiyluw6rlynz () treble>",
          "author_name": "Josh Poimboeuf",
          "author_email": "jpoimboe () kernel ! org",
          "subject": "Re: [RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-10-01 05:33:18+00:00",
          "date_str": "Tue, 01 Oct 2024 05:33:18 +0000",
          "body": "On Wed, Sep 25, 2024 at 05:01:04PM +0200, Ard Biesheuvel wrote:\n> +\t\tif (r_type == R_X86_64_GOTPCREL) {\n> +\t\t\tElf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n> +\t\t\tunsigned file_off = offset - s->sh_addr + s->sh_offset;\n> +\n> +\t\t\t/*\n> +\t\t\t * GOTPCREL relocations refer to instructions that load\n> +\t\t\t * a 64-bit address via a 32-bit relative reference to\n> +\t\t\t * the GOT.  In this case, it is the GOT entry that\n> +\t\t\t * needs to be fixed up, not the immediate offset in\n> +\t\t\t * the opcode. Note that the linker will have applied an\n> +\t\t\t * addend of -4 to compensate for the delta between the\n> +\t\t\t * relocation offset and the value of RIP when the\n> +\t\t\t * instruction executes, and this needs to be backed out\n> +\t\t\t * again. (Addends other than -4 are permitted in\n> +\t\t\t * principle, but make no sense in practice so they are\n> +\t\t\t * not supported.)\n> +                         */\n> +\t\t\tif (rel->r_addend != -4) {\n> +\t\t\t\tdie(\"invalid addend (%ld) for %s relocation: %s\\n\",\n> +\t\t\t\t    rel->r_addend, rel_type(r_type), symname);\n> +\t\t\t\tbreak;\n> +\t\t\t}\n\nFor x86 PC-relative addressing, the addend is <reloc offset> -\n<subsequent insn offset>.  So a PC-relative addend can be something\nother than -4 when the relocation applies to the middle of an\ninstruction, e.g.:\n\n   5b381:\t66 81 3d 00 00 00 00 01 06 \tcmpw   $0x601,0x0(%rip)        # 5b38a <generic_validate_add_page+0x4a>\t5b384: R_X86_64_PC32\tboot_cpu_data-0x6\n\n   5f283:\t81 3d 00 00 00 00 ff ff ff 00 \tcmpl   $0xffffff,0x0(%rip)        # 5f28d <x86_acpi_suspend_lowlevel+0x9d>\t5f285: R_X86_64_PC32\tsmpboot_control-0x8\n\n   72f67:       c6 05 00 00 00 00 01    movb   $0x1,0x0(%rip)        # 72f6e <sched_itmt_update_handler+0x6e>   72f69: R_X86_64_PC32    x86_topology_update-0x5\n\nPresumably that could also happen with R_X86_64_GOTPCREL?\n\n-- \nJosh\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172776069818161.mbox",
          "message_id": "<20241001053318.elfwwiyluw6rlynz () treble>",
          "author_name": "Josh Poimboeuf",
          "author_email": "jpoimboe () kernel ! org",
          "subject": "Re: [RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-10-01 05:33:18+00:00",
          "date_str": "Tue, 01 Oct 2024 05:33:18 +0000",
          "body": "On Wed, Sep 25, 2024 at 05:01:04PM +0200, Ard Biesheuvel wrote:\n> +\t\tif (r_type == R_X86_64_GOTPCREL) {\n> +\t\t\tElf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n> +\t\t\tunsigned file_off = offset - s->sh_addr + s->sh_offset;\n> +\n> +\t\t\t/*\n> +\t\t\t * GOTPCREL relocations refer to instructions that load\n> +\t\t\t * a 64-bit address via a 32-bit relative reference to\n> +\t\t\t * the GOT.  In this case, it is the GOT entry that\n> +\t\t\t * needs to be fixed up, not the immediate offset in\n> +\t\t\t * the opcode. Note that the linker will have applied an\n> +\t\t\t * addend of -4 to compensate for the delta between the\n> +\t\t\t * relocation offset and the value of RIP when the\n> +\t\t\t * instruction executes, and this needs to be backed out\n> +\t\t\t * again. (Addends other than -4 are permitted in\n> +\t\t\t * principle, but make no sense in practice so they are\n> +\t\t\t * not supported.)\n> +                         */\n> +\t\t\tif (rel->r_addend != -4) {\n> +\t\t\t\tdie(\"invalid addend (%ld) for %s relocation: %s\\n\",\n> +\t\t\t\t    rel->r_addend, rel_type(r_type), symname);\n> +\t\t\t\tbreak;\n> +\t\t\t}\n\nFor x86 PC-relative addressing, the addend is <reloc offset> -\n<subsequent insn offset>.  So a PC-relative addend can be something\nother than -4 when the relocation applies to the middle of an\ninstruction, e.g.:\n\n   5b381:\t66 81 3d 00 00 00 00 01 06 \tcmpw   $0x601,0x0(%rip)        # 5b38a <generic_validate_add_page+0x4a>\t5b384: R_X86_64_PC32\tboot_cpu_data-0x6\n\n   5f283:\t81 3d 00 00 00 00 ff ff ff 00 \tcmpl   $0xffffff,0x0(%rip)        # 5f28d <x86_acpi_suspend_lowlevel+0x9d>\t5f285: R_X86_64_PC32\tsmpboot_control-0x8\n\n   72f67:       c6 05 00 00 00 00 01    movb   $0x1,0x0(%rip)        # 72f6e <sched_itmt_update_handler+0x6e>   72f69: R_X86_64_PC32    x86_topology_update-0x5\n\nPresumably that could also happen with R_X86_64_GOTPCREL?\n\n-- \nJosh\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172776567020948.mbox",
          "message_id": "<CAMj1kXFyd7zDqnFzHTZmcR+ktxRVdOnuF-VOW+E0PYPNaQGXzQ () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-10-01 06:56:12+00:00",
          "date_str": "Tue, 01 Oct 2024 06:56:12 +0000",
          "body": "On Tue, 1 Oct 2024 at 07:33, Josh Poimboeuf <jpoimboe@kernel.org> wrote:\n>\n> On Wed, Sep 25, 2024 at 05:01:04PM +0200, Ard Biesheuvel wrote:\n> > +             if (r_type == R_X86_64_GOTPCREL) {\n> > +                     Elf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n> > +                     unsigned file_off = offset - s->sh_addr + s->sh_offset;\n> > +\n> > +                     /*\n> > +                      * GOTPCREL relocations refer to instructions that load\n> > +                      * a 64-bit address via a 32-bit relative reference to\n> > +                      * the GOT.  In this case, it is the GOT entry that\n> > +                      * needs to be fixed up, not the immediate offset in\n> > +                      * the opcode. Note that the linker will have applied an\n> > +                      * addend of -4 to compensate for the delta between the\n> > +                      * relocation offset and the value of RIP when the\n> > +                      * instruction executes, and this needs to be backed out\n> > +                      * again. (Addends other than -4 are permitted in\n> > +                      * principle, but make no sense in practice so they are\n> > +                      * not supported.)\n> > +                         */\n> > +                     if (rel->r_addend != -4) {\n> > +                             die(\"invalid addend (%ld) for %s relocation: %s\\n\",\n> > +                                 rel->r_addend, rel_type(r_type), symname);\n> > +                             break;\n> > +                     }\n>\n> For x86 PC-relative addressing, the addend is <reloc offset> -\n> <subsequent insn offset>.  So a PC-relative addend can be something\n> other than -4 when the relocation applies to the middle of an\n> instruction, e.g.:\n>\n>    5b381:       66 81 3d 00 00 00 00 01 06      cmpw   $0x601,0x0(%rip)        # 5b38a <generic_validate_add_page+0x4a> 5b384: R_X86_64_PC32    boot_cpu_data-0x6\n>\n>    5f283:       81 3d 00 00 00 00 ff ff ff 00   cmpl   $0xffffff,0x0(%rip)        # 5f28d <x86_acpi_suspend_lowlevel+0x9d>      5f285: R_X86_64_PC32    smpboot_control-0x8\n>\n>    72f67:       c6 05 00 00 00 00 01    movb   $0x1,0x0(%rip)        # 72f6e <sched_itmt_update_handler+0x6e>   72f69: R_X86_64_PC32    x86_topology_update-0x5\n>\n> Presumably that could also happen with R_X86_64_GOTPCREL?\n>\n\nIn theory, yes.\n\nBut for the class of GOTPCREL relaxable instructions listed in the\npsABI, the addend is always -4, and these are the only ones we might\nexpect from the compiler when using -fpic with 'hidden' visibility\nand/or -mdirect-extern-access. Note that the memory operand\nfoo@GOTPCREL(%rip) produces the *address* of foo, and so it is always\nthe source operand, appearing at the end of the encoding.\n\nAlternatively, we might simply subtract the addend from 'offset'\nbefore applying the displacement from the opcode.\n\nNote that this code gets removed again in the last patch, after\nswitching to PIE linking.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172776567320960.mbox",
          "message_id": "<CAMj1kXFyd7zDqnFzHTZmcR+ktxRVdOnuF-VOW+E0PYPNaQGXzQ () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-10-01 06:56:12+00:00",
          "date_str": "Tue, 01 Oct 2024 06:56:12 +0000",
          "body": "On Tue, 1 Oct 2024 at 07:33, Josh Poimboeuf <jpoimboe@kernel.org> wrote:\n>\n> On Wed, Sep 25, 2024 at 05:01:04PM +0200, Ard Biesheuvel wrote:\n> > +             if (r_type == R_X86_64_GOTPCREL) {\n> > +                     Elf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n> > +                     unsigned file_off = offset - s->sh_addr + s->sh_offset;\n> > +\n> > +                     /*\n> > +                      * GOTPCREL relocations refer to instructions that load\n> > +                      * a 64-bit address via a 32-bit relative reference to\n> > +                      * the GOT.  In this case, it is the GOT entry that\n> > +                      * needs to be fixed up, not the immediate offset in\n> > +                      * the opcode. Note that the linker will have applied an\n> > +                      * addend of -4 to compensate for the delta between the\n> > +                      * relocation offset and the value of RIP when the\n> > +                      * instruction executes, and this needs to be backed out\n> > +                      * again. (Addends other than -4 are permitted in\n> > +                      * principle, but make no sense in practice so they are\n> > +                      * not supported.)\n> > +                         */\n> > +                     if (rel->r_addend != -4) {\n> > +                             die(\"invalid addend (%ld) for %s relocation: %s\\n\",\n> > +                                 rel->r_addend, rel_type(r_type), symname);\n> > +                             break;\n> > +                     }\n>\n> For x86 PC-relative addressing, the addend is <reloc offset> -\n> <subsequent insn offset>.  So a PC-relative addend can be something\n> other than -4 when the relocation applies to the middle of an\n> instruction, e.g.:\n>\n>    5b381:       66 81 3d 00 00 00 00 01 06      cmpw   $0x601,0x0(%rip)        # 5b38a <generic_validate_add_page+0x4a> 5b384: R_X86_64_PC32    boot_cpu_data-0x6\n>\n>    5f283:       81 3d 00 00 00 00 ff ff ff 00   cmpl   $0xffffff,0x0(%rip)        # 5f28d <x86_acpi_suspend_lowlevel+0x9d>      5f285: R_X86_64_PC32    smpboot_control-0x8\n>\n>    72f67:       c6 05 00 00 00 00 01    movb   $0x1,0x0(%rip)        # 72f6e <sched_itmt_update_handler+0x6e>   72f69: R_X86_64_PC32    x86_topology_update-0x5\n>\n> Presumably that could also happen with R_X86_64_GOTPCREL?\n>\n\nIn theory, yes.\n\nBut for the class of GOTPCREL relaxable instructions listed in the\npsABI, the addend is always -4, and these are the only ones we might\nexpect from the compiler when using -fpic with 'hidden' visibility\nand/or -mdirect-extern-access. Note that the memory operand\nfoo@GOTPCREL(%rip) produces the *address* of foo, and so it is always\nthe source operand, appearing at the end of the encoding.\n\nAlternatively, we might simply subtract the addend from 'offset'\nbefore applying the displacement from the opcode.\n\nNote that this code gets removed again in the last patch, after\nswitching to PIE linking.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172776568020965.mbox",
          "message_id": "<CAMj1kXFyd7zDqnFzHTZmcR+ktxRVdOnuF-VOW+E0PYPNaQGXzQ () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-10-01 06:56:12+00:00",
          "date_str": "Tue, 01 Oct 2024 06:56:12 +0000",
          "body": "On Tue, 1 Oct 2024 at 07:33, Josh Poimboeuf <jpoimboe@kernel.org> wrote:\n>\n> On Wed, Sep 25, 2024 at 05:01:04PM +0200, Ard Biesheuvel wrote:\n> > +             if (r_type == R_X86_64_GOTPCREL) {\n> > +                     Elf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n> > +                     unsigned file_off = offset - s->sh_addr + s->sh_offset;\n> > +\n> > +                     /*\n> > +                      * GOTPCREL relocations refer to instructions that load\n> > +                      * a 64-bit address via a 32-bit relative reference to\n> > +                      * the GOT.  In this case, it is the GOT entry that\n> > +                      * needs to be fixed up, not the immediate offset in\n> > +                      * the opcode. Note that the linker will have applied an\n> > +                      * addend of -4 to compensate for the delta between the\n> > +                      * relocation offset and the value of RIP when the\n> > +                      * instruction executes, and this needs to be backed out\n> > +                      * again. (Addends other than -4 are permitted in\n> > +                      * principle, but make no sense in practice so they are\n> > +                      * not supported.)\n> > +                         */\n> > +                     if (rel->r_addend != -4) {\n> > +                             die(\"invalid addend (%ld) for %s relocation: %s\\n\",\n> > +                                 rel->r_addend, rel_type(r_type), symname);\n> > +                             break;\n> > +                     }\n>\n> For x86 PC-relative addressing, the addend is <reloc offset> -\n> <subsequent insn offset>.  So a PC-relative addend can be something\n> other than -4 when the relocation applies to the middle of an\n> instruction, e.g.:\n>\n>    5b381:       66 81 3d 00 00 00 00 01 06      cmpw   $0x601,0x0(%rip)        # 5b38a <generic_validate_add_page+0x4a> 5b384: R_X86_64_PC32    boot_cpu_data-0x6\n>\n>    5f283:       81 3d 00 00 00 00 ff ff ff 00   cmpl   $0xffffff,0x0(%rip)        # 5f28d <x86_acpi_suspend_lowlevel+0x9d>      5f285: R_X86_64_PC32    smpboot_control-0x8\n>\n>    72f67:       c6 05 00 00 00 00 01    movb   $0x1,0x0(%rip)        # 72f6e <sched_itmt_update_handler+0x6e>   72f69: R_X86_64_PC32    x86_topology_update-0x5\n>\n> Presumably that could also happen with R_X86_64_GOTPCREL?\n>\n\nIn theory, yes.\n\nBut for the class of GOTPCREL relaxable instructions listed in the\npsABI, the addend is always -4, and these are the only ones we might\nexpect from the compiler when using -fpic with 'hidden' visibility\nand/or -mdirect-extern-access. Note that the memory operand\nfoo@GOTPCREL(%rip) produces the *address* of foo, and so it is always\nthe source operand, appearing at the end of the encoding.\n\nAlternatively, we might simply subtract the addend from 'offset'\nbefore applying the displacement from the opcode.\n\nNote that this code gets removed again in the last patch, after\nswitching to PIE linking.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172776567020943.mbox",
          "message_id": "<CAMj1kXFyd7zDqnFzHTZmcR+ktxRVdOnuF-VOW+E0PYPNaQGXzQ () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-10-01 06:56:12+00:00",
          "date_str": "Tue, 01 Oct 2024 06:56:12 +0000",
          "body": "On Tue, 1 Oct 2024 at 07:33, Josh Poimboeuf <jpoimboe@kernel.org> wrote:\n>\n> On Wed, Sep 25, 2024 at 05:01:04PM +0200, Ard Biesheuvel wrote:\n> > +             if (r_type == R_X86_64_GOTPCREL) {\n> > +                     Elf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n> > +                     unsigned file_off = offset - s->sh_addr + s->sh_offset;\n> > +\n> > +                     /*\n> > +                      * GOTPCREL relocations refer to instructions that load\n> > +                      * a 64-bit address via a 32-bit relative reference to\n> > +                      * the GOT.  In this case, it is the GOT entry that\n> > +                      * needs to be fixed up, not the immediate offset in\n> > +                      * the opcode. Note that the linker will have applied an\n> > +                      * addend of -4 to compensate for the delta between the\n> > +                      * relocation offset and the value of RIP when the\n> > +                      * instruction executes, and this needs to be backed out\n> > +                      * again. (Addends other than -4 are permitted in\n> > +                      * principle, but make no sense in practice so they are\n> > +                      * not supported.)\n> > +                         */\n> > +                     if (rel->r_addend != -4) {\n> > +                             die(\"invalid addend (%ld) for %s relocation: %s\\n\",\n> > +                                 rel->r_addend, rel_type(r_type), symname);\n> > +                             break;\n> > +                     }\n>\n> For x86 PC-relative addressing, the addend is <reloc offset> -\n> <subsequent insn offset>.  So a PC-relative addend can be something\n> other than -4 when the relocation applies to the middle of an\n> instruction, e.g.:\n>\n>    5b381:       66 81 3d 00 00 00 00 01 06      cmpw   $0x601,0x0(%rip)        # 5b38a <generic_validate_add_page+0x4a> 5b384: R_X86_64_PC32    boot_cpu_data-0x6\n>\n>    5f283:       81 3d 00 00 00 00 ff ff ff 00   cmpl   $0xffffff,0x0(%rip)        # 5f28d <x86_acpi_suspend_lowlevel+0x9d>      5f285: R_X86_64_PC32    smpboot_control-0x8\n>\n>    72f67:       c6 05 00 00 00 00 01    movb   $0x1,0x0(%rip)        # 72f6e <sched_itmt_update_handler+0x6e>   72f69: R_X86_64_PC32    x86_topology_update-0x5\n>\n> Presumably that could also happen with R_X86_64_GOTPCREL?\n>\n\nIn theory, yes.\n\nBut for the class of GOTPCREL relaxable instructions listed in the\npsABI, the addend is always -4, and these are the only ones we might\nexpect from the compiler when using -fpic with 'hidden' visibility\nand/or -mdirect-extern-access. Note that the memory operand\nfoo@GOTPCREL(%rip) produces the *address* of foo, and so it is always\nthe source operand, appearing at the end of the encoding.\n\nAlternatively, we might simply subtract the addend from 'offset'\nbefore applying the displacement from the opcode.\n\nNote that this code gets removed again in the last patch, after\nswitching to PIE linking.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172776567320959.mbox",
          "message_id": "<CAMj1kXFyd7zDqnFzHTZmcR+ktxRVdOnuF-VOW+E0PYPNaQGXzQ () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-10-01 06:56:12+00:00",
          "date_str": "Tue, 01 Oct 2024 06:56:12 +0000",
          "body": "On Tue, 1 Oct 2024 at 07:33, Josh Poimboeuf <jpoimboe@kernel.org> wrote:\n>\n> On Wed, Sep 25, 2024 at 05:01:04PM +0200, Ard Biesheuvel wrote:\n> > +             if (r_type == R_X86_64_GOTPCREL) {\n> > +                     Elf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n> > +                     unsigned file_off = offset - s->sh_addr + s->sh_offset;\n> > +\n> > +                     /*\n> > +                      * GOTPCREL relocations refer to instructions that load\n> > +                      * a 64-bit address via a 32-bit relative reference to\n> > +                      * the GOT.  In this case, it is the GOT entry that\n> > +                      * needs to be fixed up, not the immediate offset in\n> > +                      * the opcode. Note that the linker will have applied an\n> > +                      * addend of -4 to compensate for the delta between the\n> > +                      * relocation offset and the value of RIP when the\n> > +                      * instruction executes, and this needs to be backed out\n> > +                      * again. (Addends other than -4 are permitted in\n> > +                      * principle, but make no sense in practice so they are\n> > +                      * not supported.)\n> > +                         */\n> > +                     if (rel->r_addend != -4) {\n> > +                             die(\"invalid addend (%ld) for %s relocation: %s\\n\",\n> > +                                 rel->r_addend, rel_type(r_type), symname);\n> > +                             break;\n> > +                     }\n>\n> For x86 PC-relative addressing, the addend is <reloc offset> -\n> <subsequent insn offset>.  So a PC-relative addend can be something\n> other than -4 when the relocation applies to the middle of an\n> instruction, e.g.:\n>\n>    5b381:       66 81 3d 00 00 00 00 01 06      cmpw   $0x601,0x0(%rip)        # 5b38a <generic_validate_add_page+0x4a> 5b384: R_X86_64_PC32    boot_cpu_data-0x6\n>\n>    5f283:       81 3d 00 00 00 00 ff ff ff 00   cmpl   $0xffffff,0x0(%rip)        # 5f28d <x86_acpi_suspend_lowlevel+0x9d>      5f285: R_X86_64_PC32    smpboot_control-0x8\n>\n>    72f67:       c6 05 00 00 00 00 01    movb   $0x1,0x0(%rip)        # 72f6e <sched_itmt_update_handler+0x6e>   72f69: R_X86_64_PC32    x86_topology_update-0x5\n>\n> Presumably that could also happen with R_X86_64_GOTPCREL?\n>\n\nIn theory, yes.\n\nBut for the class of GOTPCREL relaxable instructions listed in the\npsABI, the addend is always -4, and these are the only ones we might\nexpect from the compiler when using -fpic with 'hidden' visibility\nand/or -mdirect-extern-access. Note that the memory operand\nfoo@GOTPCREL(%rip) produces the *address* of foo, and so it is always\nthe source operand, appearing at the end of the encoding.\n\nAlternatively, we might simply subtract the addend from 'offset'\nbefore applying the displacement from the opcode.\n\nNote that this code gets removed again in the last patch, after\nswitching to PIE linking.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172776567220955.mbox",
          "message_id": "<CAMj1kXFyd7zDqnFzHTZmcR+ktxRVdOnuF-VOW+E0PYPNaQGXzQ () mail ! gmail ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb () kernel ! org",
          "subject": "Re: [RFC PATCH 04/28] x86/boot: Permit GOTPCREL relocations for x86_64 builds",
          "date": "2024-10-01 06:56:12+00:00",
          "date_str": "Tue, 01 Oct 2024 06:56:12 +0000",
          "body": "On Tue, 1 Oct 2024 at 07:33, Josh Poimboeuf <jpoimboe@kernel.org> wrote:\n>\n> On Wed, Sep 25, 2024 at 05:01:04PM +0200, Ard Biesheuvel wrote:\n> > +             if (r_type == R_X86_64_GOTPCREL) {\n> > +                     Elf_Shdr *s = &secs[sec->shdr.sh_info].shdr;\n> > +                     unsigned file_off = offset - s->sh_addr + s->sh_offset;\n> > +\n> > +                     /*\n> > +                      * GOTPCREL relocations refer to instructions that load\n> > +                      * a 64-bit address via a 32-bit relative reference to\n> > +                      * the GOT.  In this case, it is the GOT entry that\n> > +                      * needs to be fixed up, not the immediate offset in\n> > +                      * the opcode. Note that the linker will have applied an\n> > +                      * addend of -4 to compensate for the delta between the\n> > +                      * relocation offset and the value of RIP when the\n> > +                      * instruction executes, and this needs to be backed out\n> > +                      * again. (Addends other than -4 are permitted in\n> > +                      * principle, but make no sense in practice so they are\n> > +                      * not supported.)\n> > +                         */\n> > +                     if (rel->r_addend != -4) {\n> > +                             die(\"invalid addend (%ld) for %s relocation: %s\\n\",\n> > +                                 rel->r_addend, rel_type(r_type), symname);\n> > +                             break;\n> > +                     }\n>\n> For x86 PC-relative addressing, the addend is <reloc offset> -\n> <subsequent insn offset>.  So a PC-relative addend can be something\n> other than -4 when the relocation applies to the middle of an\n> instruction, e.g.:\n>\n>    5b381:       66 81 3d 00 00 00 00 01 06      cmpw   $0x601,0x0(%rip)        # 5b38a <generic_validate_add_page+0x4a> 5b384: R_X86_64_PC32    boot_cpu_data-0x6\n>\n>    5f283:       81 3d 00 00 00 00 ff ff ff 00   cmpl   $0xffffff,0x0(%rip)        # 5f28d <x86_acpi_suspend_lowlevel+0x9d>      5f285: R_X86_64_PC32    smpboot_control-0x8\n>\n>    72f67:       c6 05 00 00 00 00 01    movb   $0x1,0x0(%rip)        # 72f6e <sched_itmt_update_handler+0x6e>   72f69: R_X86_64_PC32    x86_topology_update-0x5\n>\n> Presumably that could also happen with R_X86_64_GOTPCREL?\n>\n\nIn theory, yes.\n\nBut for the class of GOTPCREL relaxable instructions listed in the\npsABI, the addend is always -4, and these are the only ones we might\nexpect from the compiler when using -fpic with 'hidden' visibility\nand/or -mdirect-extern-access. Note that the memory operand\nfoo@GOTPCREL(%rip) produces the *address* of foo, and so it is always\nthe source operand, appearing at the end of the encoding.\n\nAlternatively, we might simply subtract the addend from 'offset'\nbefore applying the displacement from the opcode.\n\nNote that this code gets removed again in the last patch, after\nswitching to PIE linking.\n",
          "year": "2024",
          "month": "10"
        }
      ],
      "primary_category": "kernel_integration"
    },
    {
      "subject": "[RFC PATCH 00/28] x86: Rely on toolchain for relocatable code",
      "normalized_subject": "x86: Rely on toolchain for relocatable code",
      "message_count": 1,
      "participants": [
        "Ard Biesheuvel"
      ],
      "categories": [
        "rfc_proposals",
        "address_space"
      ],
      "first_date": "2024-09-25T15:01:00+00:00",
      "last_date": "2024-09-25T15:01:00+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/09/172727686717704.mbox",
          "message_id": "<20240925150059.3955569-30-ardb+git () google ! com>",
          "author_name": "Ard Biesheuvel",
          "author_email": "ardb+git () google ! com",
          "subject": "[RFC PATCH 00/28] x86: Rely on toolchain for relocatable code",
          "date": "2024-09-25 15:01:00+00:00",
          "date_str": "Wed, 25 Sep 2024 15:01:00 +0000",
          "body": "From: Ard Biesheuvel <ardb@kernel.org>\n\nThe x86_64 port has a number of historical quirks that result in a\nreliance on toolchain features that are either poorly specified or\nbasically implementation details of the toolchain:\n\n- the 'kernel' C model implemented by the compiler is intended for\n  position dependent code residing in the 'negative' 2 GiB of the\n  virtual address space, but is used to create a position independent\n  executable (for virtual KASLR);\n\n- the 'kernel' C model has other properties that are not written down\n  anywhere, and may therefore deviate between compilers and versions,\n  which now includes the Rust compilers too (e.g., use %gs not %fs for\n  per-CPU references); \n\n- the relocation format used to perform the PIE relocation at boot is\n  complicated and non-standard, as it deals with 3 types of\n  displacements, including 32-bit negative displacements for\n  RIP-relative per-CPU references that are not subject to relocation\n  fixups (as they are places in a separate, disjoint address space);\n\n- the relocation table is generated from static relocation metadata\n  taken from the ELF input objects into the linker, and these describe\n  the input not the output - relaxations or other linker tweaks may\n  result in a mismatch between the two, and GNU ld and LLD display\n  different behavior here;\n\n- this disjoint per-CPU address space requires elaborate hacks in the\n  linker script and the startup code;\n\n- some of the startup code executes from a 1:1 mapping of memory, where\n  RIP-relative references are mandatory, whereas RIP-relative per-CPU\n  variable references can only work correctly from the kernel virtual\n  mapping (as they need to wrap around from the negative 2 GiB space\n  into the 0x0 based per-CPU region);\n\nThe reason for this odd situation wrt per-CPU variable addressing is the\nfact that we rely on the user-space TLS arrangement for per-task stack\ncookies, and this was implemented using a fixed offset of 40 bytes from\n%GS. If we bump the minimum GCC version to 8.1, we can switch to symbol\nbased stack cookie references, allowing the same arrangement to be\nadopted as on other architectures, i.e., where the CPU register carries\nthe per-CPU offset, and UP or boot-time per-CPU references point into\nthe per-CPU load area directly (using an offset of 0x0).\n\nWith that out of the way, we can untangle this whole thing, and replace\nthe bespoke tooling and relocation formats with ordinary, linker\ngenerated relocation tables, using the RELR format that reduces the\nmemory footprint of the relocation table by 20x. The compilers can\nefficiently generate position independent code these days, without\nunnecessary indirections via the Global Object Table (GOT) except for a\nhandful of special cases (see the KVM patch for an example where a\nGOT-based indirection is the best choice for pushing the absolute\naddress of a symbol onto the stack in a position independent manner when\nthere are no free GPRs)\n\nIt also brings us much closer to the ordinary PIE relocation model used\nfor most of user space, which is therefore much better supported and\nless likely to create problems as we increase the range of compilers and\nlinkers that need to be supported.\n\nTested on GCC 8 - 14 and Clang 15 - 17, using EFI and bare metal boot\nusing a variety of entry points (decompressor, EFI stub, XenPV, PVH)\n \nCc: x86@kernel.org\nCc: \"H. Peter Anvin\" <hpa@zytor.com>\nCc: Andy Lutomirski <luto@kernel.org>\nCc: Peter Zijlstra <peterz@infradead.org>\nCc: Uros Bizjak <ubizjak@gmail.com>\nCc: Dennis Zhou <dennis@kernel.org>\nCc: Tejun Heo <tj@kernel.org>\nCc: Christoph Lameter <cl@linux.com>\nCc: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>\nCc: Paolo Bonzini <pbonzini@redhat.com>\nCc: Vitaly Kuznetsov <vkuznets@redhat.com>\nCc: Juergen Gross <jgross@suse.com>\nCc: Boris Ostrovsky <boris.ostrovsky@oracle.com>\nCc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>\nCc: Arnd Bergmann <arnd@arndb.de>\nCc: Masahiro Yamada <masahiroy@kernel.org>\nCc: Kees Cook <kees@kernel.org>\nCc: Nathan Chancellor <nathan@kernel.org>\nCc: Keith Packard <keithp@keithp.com>\nCc: Justin Stitt <justinstitt@google.com>\nCc: Josh Poimboeuf <jpoimboe@kernel.org>\nCc: Peter Zijlstra <peterz@infradead.org>\nCc: Arnaldo Carvalho de Melo <acme@kernel.org>\nCc: Namhyung Kim <namhyung@kernel.org>\nCc: Jiri Olsa <jolsa@kernel.org>\nCc: Ian Rogers <irogers@google.com>\nCc: Adrian Hunter <adrian.hunter@intel.com>\nCc: Kan Liang  <kan.liang@linux.intel.com>\nCc: linux-doc@vger.kernel.org\nCc: linux-pm@vger.kernel.org\nCc: kvm@vger.kernel.org\nCc: xen-devel@lists.xenproject.org\nCc: linux-efi@vger.kernel.org\nCc: linux-arch@vger.kernel.org\nCc: linux-sparse@vger.kernel.org\nCc: linux-kbuild@vger.kernel.org\nCc: linux-perf-users@vger.kernel.org\nCc: rust-for-linux@vger.kernel.org\nCc: llvm@lists.linux.dev\n\nArd Biesheuvel (28):\n  x86/pvh: Call C code via the kernel virtual mapping\n  Documentation: Bump minimum GCC version to 8.1\n  x86/tools: Use mmap() to simplify relocs host tool\n  x86/boot: Permit GOTPCR",
          "year": "2024",
          "month": "09"
        }
      ],
      "primary_category": "address_space"
    },
    {
      "subject": "[PATCH net] net: add inline annotation to fix the build warning",
      "normalized_subject": "net: add inline annotation to fix the build warning",
      "message_count": 19,
      "participants": [
        "Moon Yeounsu",
        "Edward Cree",
        "Simon Horman",
        "Eric Dumazet",
        "Stephen Hemminger"
      ],
      "categories": [
        "kernel_integration",
        "context_analysis",
        "sparse_internals",
        "compiler_compat",
        "rfc_proposals"
      ],
      "first_date": "2024-09-19T14:21:49+00:00",
      "last_date": "2024-10-03T18:39:47+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/10/172675567521184.mbox",
          "message_id": "<20240919142149.282175-1-yyyynoom () gmail ! com>",
          "author_name": "Moon Yeounsu",
          "author_email": "yyyynoom () gmail ! com",
          "subject": "[PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-09-19 14:21:49+00:00",
          "date_str": "Thu, 19 Sep 2024 14:21:49 +0000",
          "body": "This patch fixes two sparse warnings (`make C=1`):\nnet/ipv6/icmp.c:103:20: warning: context imbalance in 'icmpv6_xmit_lock' - wrong count at exit\nnet/ipv6/icmp.c:119:13: warning: context imbalance in 'icmpv6_xmit_unlock' - unexpected unlock\n\nSince `icmp6_xmit_lock()` and `icmp6_xmit_unlock()` are designed as they\nare named, entering/returning the function without lock/unlock doesn't\nmatter.\n\nSigned-off-by: Moon Yeounsu <yyyynoom@gmail.com>\n---\n net/ipv6/icmp.c | 2 ++\n 1 file changed, 2 insertions(+)\n\ndiff --git a/net/ipv6/icmp.c b/net/ipv6/icmp.c\nindex 071b0bc1179d..d8cc3d63c942 100644\n--- a/net/ipv6/icmp.c\n+++ b/net/ipv6/icmp.c\n@@ -101,6 +101,7 @@ static const struct inet6_protocol icmpv6_protocol = {\n \n /* Called with BH disabled */\n static struct sock *icmpv6_xmit_lock(struct net *net)\n+\t__acquires(&sk->sk_lock.slock)\n {\n \tstruct sock *sk;\n \n@@ -117,6 +118,7 @@ static struct sock *icmpv6_xmit_lock(struct net *net)\n }\n \n static void icmpv6_xmit_unlock(struct sock *sk)\n+\t__releases(&sk->sk_lock.slock)\n {\n \tsock_net_set(sk, &init_net);\n \tspin_unlock(&sk->sk_lock.slock);\n-- \n2.46.1\n\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172675567221178.mbox",
          "message_id": "<20240919142149.282175-1-yyyynoom () gmail ! com>",
          "author_name": "Moon Yeounsu",
          "author_email": "yyyynoom () gmail ! com",
          "subject": "[PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-09-19 14:21:49+00:00",
          "date_str": "Thu, 19 Sep 2024 14:21:49 +0000",
          "body": "This patch fixes two sparse warnings (`make C=1`):\nnet/ipv6/icmp.c:103:20: warning: context imbalance in 'icmpv6_xmit_lock' - wrong count at exit\nnet/ipv6/icmp.c:119:13: warning: context imbalance in 'icmpv6_xmit_unlock' - unexpected unlock\n\nSince `icmp6_xmit_lock()` and `icmp6_xmit_unlock()` are designed as they\nare named, entering/returning the function without lock/unlock doesn't\nmatter.\n\nSigned-off-by: Moon Yeounsu <yyyynoom@gmail.com>\n---\n net/ipv6/icmp.c | 2 ++\n 1 file changed, 2 insertions(+)\n\ndiff --git a/net/ipv6/icmp.c b/net/ipv6/icmp.c\nindex 071b0bc1179d..d8cc3d63c942 100644\n--- a/net/ipv6/icmp.c\n+++ b/net/ipv6/icmp.c\n@@ -101,6 +101,7 @@ static const struct inet6_protocol icmpv6_protocol = {\n \n /* Called with BH disabled */\n static struct sock *icmpv6_xmit_lock(struct net *net)\n+\t__acquires(&sk->sk_lock.slock)\n {\n \tstruct sock *sk;\n \n@@ -117,6 +118,7 @@ static struct sock *icmpv6_xmit_lock(struct net *net)\n }\n \n static void icmpv6_xmit_unlock(struct sock *sk)\n+\t__releases(&sk->sk_lock.slock)\n {\n \tsock_net_set(sk, &init_net);\n \tspin_unlock(&sk->sk_lock.slock);\n-- \n2.46.1\n\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172675768522388.mbox",
          "message_id": "<20240919145609.GF1571683 () kernel ! org>",
          "author_name": "Simon Horman",
          "author_email": "horms () kernel ! org",
          "subject": "Re: [PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-09-19 14:56:09+00:00",
          "date_str": "Thu, 19 Sep 2024 14:56:09 +0000",
          "body": "On Thu, Sep 19, 2024 at 11:21:49PM +0900, Moon Yeounsu wrote:\n> This patch fixes two sparse warnings (`make C=1`):\n> net/ipv6/icmp.c:103:20: warning: context imbalance in 'icmpv6_xmit_lock' - wrong count at exit\n> net/ipv6/icmp.c:119:13: warning: context imbalance in 'icmpv6_xmit_unlock' - unexpected unlock\n> \n> Since `icmp6_xmit_lock()` and `icmp6_xmit_unlock()` are designed as they\n> are named, entering/returning the function without lock/unlock doesn't\n> matter.\n> \n> Signed-off-by: Moon Yeounsu <yyyynoom@gmail.com>\n\nHi Moon,\n\nWithout this patch applied I see the warnings cited above.\n\nHowever, with this patch applied, I see the following.\nSo I think this needs more work.\n\nnet/ipv6/icmp.c: note: in included file (through include/linux/sched.h, include/linux/percpu.h, arch/x86/include/asm/msr.h, arch/x86/include/asm/tsc.h, arch/x86/include/asm/timex.h, include/linux/timex.h, ...):\n./include/linux/spinlock.h:361:16: warning: context imbalance in 'icmpv6_xmit_lock' - different lock contexts for basic block\nnet/ipv6/icmp.c: note: in included file (through include/linux/spinlock.h, include/linux/sched.h, include/linux/percpu.h, arch/x86/include/asm/msr.h, arch/x86/include/asm/tsc.h, arch/x86/include/asm/timex.h, ...):\n./include/linux/bottom_half.h:33:30: warning: context imbalance in 'icmp6_send' - different lock contexts for basic block\n./include/linux/bottom_half.h:33:30: warning: context imbalance in 'icmpv6_echo_reply' - different lock contexts for basic block\n\nAlso, It is my feeling that addressing warnings of this nature\nis not a fix for net, but rather but rather an enhancement for net-next.\n\nnet-next is currently closed for the v6.12 merge windows, so non-RFC,\npatches should not be posted for net-next until it re-opens once v6.12-rc1\nhas been released, most likely during the week of 30th September.\n\n-- \npw-bot: changes-requested\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172681714402795.mbox",
          "message_id": "<CAAjsZQyruuyN6VC5T=xQHFVWeOLhz4D3H0vBrwTRoqQHDbtsEg () mail ! gmail ! com>",
          "author_name": "Moon Yeounsu",
          "author_email": "yyyynoom () gmail ! com",
          "subject": "Re: [PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-09-20 07:27:13+00:00",
          "date_str": "Fri, 20 Sep 2024 07:27:13 +0000",
          "body": "On Thu, Sep 19, 2024 at 11:56=E2=80=AFPM Simon Horman <horms@kernel.org> wr=\note:\n\n> Hi Moon,\n>\n> Without this patch applied I see the warnings cited above.\n>\n> However, with this patch applied, I see the following.\n> So I think this needs more work.\nOkay, I'll fix and update. (Of course, patch after release `-rc1`)\n\n> net-next is currently closed for the v6.12 merge windows, so non-RFC,\n> patches should not be posted for net-next until it re-opens once v6.12-rc=\n1\n> has been released, most likely during the week of 30th September.\nThank you for letting me know : )\nDuring this time, I'll read patches, docs, and code to increase my sense.\n\nI appreciate you reviewing my patch!\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172681714402796.mbox",
          "message_id": "<CAAjsZQyruuyN6VC5T=xQHFVWeOLhz4D3H0vBrwTRoqQHDbtsEg () mail ! gmail ! com>",
          "author_name": "Moon Yeounsu",
          "author_email": "yyyynoom () gmail ! com",
          "subject": "Re: [PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-09-20 07:27:13+00:00",
          "date_str": "Fri, 20 Sep 2024 07:27:13 +0000",
          "body": "On Thu, Sep 19, 2024 at 11:56=E2=80=AFPM Simon Horman <horms@kernel.org> wr=\note:\n\n> Hi Moon,\n>\n> Without this patch applied I see the warnings cited above.\n>\n> However, with this patch applied, I see the following.\n> So I think this needs more work.\nOkay, I'll fix and update. (Of course, patch after release `-rc1`)\n\n> net-next is currently closed for the v6.12 merge windows, so non-RFC,\n> patches should not be posted for net-next until it re-opens once v6.12-rc=\n1\n> has been released, most likely during the week of 30th September.\nThank you for letting me know : )\nDuring this time, I'll read patches, docs, and code to increase my sense.\n\nI appreciate you reviewing my patch!\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172781112824142.mbox",
          "message_id": "<20241001193352.151102-1-yyyynoom () gmail ! com>",
          "author_name": "Moon Yeounsu",
          "author_email": "yyyynoom () gmail ! com",
          "subject": "[PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-10-01 19:33:52+00:00",
          "date_str": "Tue, 01 Oct 2024 19:33:52 +0000",
          "body": "This patch fixes two `sparse` warnings:\nnet/core/neighbour.c:453:9: warning: context imbalance in '__neigh_ifdown' - wrong count at exit\nnet/core/neighbour.c:871:9: warning: context imbalance in 'pneigh_ifdown_and_unlock' - unexpected unlock\n\nYou can check it by running:\n`make C=1 net/core/neighbour.o`\n\nSigned-off-by: Moon Yeounsu <yyyynoom@gmail.com>\n---\n net/core/neighbour.c | 4 ++++\n 1 file changed, 4 insertions(+)\n\ndiff --git a/net/core/neighbour.c b/net/core/neighbour.c\nindex 77b819cd995b..6b5ec9a44556 100644\n--- a/net/core/neighbour.c\n+++ b/net/core/neighbour.c\n@@ -441,6 +441,7 @@ EXPORT_SYMBOL(neigh_changeaddr);\n \n static int __neigh_ifdown(struct neigh_table *tbl, struct net_device *dev,\n \t\t\t  bool skip_perm)\n+\t__acquires(&tbl->lock)\n {\n \twrite_lock_bh(&tbl->lock);\n \tneigh_flush_dev(tbl, dev, skip_perm);\n@@ -453,6 +454,7 @@ static int __neigh_ifdown(struct neigh_table *tbl, struct net_device *dev,\n }\n \n int neigh_carrier_down(struct neigh_table *tbl, struct net_device *dev)\n+\t__acquires(&tbl->lock)\n {\n \t__neigh_ifdown(tbl, dev, true);\n \treturn 0;\n@@ -460,6 +462,7 @@ int neigh_carrier_down(struct neigh_table *tbl, struct net_device *dev)\n EXPORT_SYMBOL(neigh_carrier_down);\n \n int neigh_ifdown(struct neigh_table *tbl, struct net_device *dev)\n+\t__acquires(&tbl->lock)\n {\n \t__neigh_ifdown(tbl, dev, false);\n \treturn 0;\n@@ -848,6 +851,7 @@ int pneigh_delete(struct neigh_table *tbl, struct net *net, const void *pkey,\n \n static int pneigh_ifdown_and_unlock(struct neigh_table *tbl,\n \t\t\t\t    struct net_device *dev)\n+\t__releases(&tbl->lock)\n {\n \tstruct pneigh_entry *n, **np, *freelist = NULL;\n \tu32 h;\n-- \n2.46.1\n\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172781113224148.mbox",
          "message_id": "<20241001193352.151102-1-yyyynoom () gmail ! com>",
          "author_name": "Moon Yeounsu",
          "author_email": "yyyynoom () gmail ! com",
          "subject": "[PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-10-01 19:33:52+00:00",
          "date_str": "Tue, 01 Oct 2024 19:33:52 +0000",
          "body": "This patch fixes two `sparse` warnings:\nnet/core/neighbour.c:453:9: warning: context imbalance in '__neigh_ifdown' - wrong count at exit\nnet/core/neighbour.c:871:9: warning: context imbalance in 'pneigh_ifdown_and_unlock' - unexpected unlock\n\nYou can check it by running:\n`make C=1 net/core/neighbour.o`\n\nSigned-off-by: Moon Yeounsu <yyyynoom@gmail.com>\n---\n net/core/neighbour.c | 4 ++++\n 1 file changed, 4 insertions(+)\n\ndiff --git a/net/core/neighbour.c b/net/core/neighbour.c\nindex 77b819cd995b..6b5ec9a44556 100644\n--- a/net/core/neighbour.c\n+++ b/net/core/neighbour.c\n@@ -441,6 +441,7 @@ EXPORT_SYMBOL(neigh_changeaddr);\n \n static int __neigh_ifdown(struct neigh_table *tbl, struct net_device *dev,\n \t\t\t  bool skip_perm)\n+\t__acquires(&tbl->lock)\n {\n \twrite_lock_bh(&tbl->lock);\n \tneigh_flush_dev(tbl, dev, skip_perm);\n@@ -453,6 +454,7 @@ static int __neigh_ifdown(struct neigh_table *tbl, struct net_device *dev,\n }\n \n int neigh_carrier_down(struct neigh_table *tbl, struct net_device *dev)\n+\t__acquires(&tbl->lock)\n {\n \t__neigh_ifdown(tbl, dev, true);\n \treturn 0;\n@@ -460,6 +462,7 @@ int neigh_carrier_down(struct neigh_table *tbl, struct net_device *dev)\n EXPORT_SYMBOL(neigh_carrier_down);\n \n int neigh_ifdown(struct neigh_table *tbl, struct net_device *dev)\n+\t__acquires(&tbl->lock)\n {\n \t__neigh_ifdown(tbl, dev, false);\n \treturn 0;\n@@ -848,6 +851,7 @@ int pneigh_delete(struct neigh_table *tbl, struct net *net, const void *pkey,\n \n static int pneigh_ifdown_and_unlock(struct neigh_table *tbl,\n \t\t\t\t    struct net_device *dev)\n+\t__releases(&tbl->lock)\n {\n \tstruct pneigh_entry *n, **np, *freelist = NULL;\n \tu32 h;\n-- \n2.46.1\n\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172788026131671.mbox",
          "message_id": "<CANn89i+aHZWGqWjCQXacRV4SBGXJvyEVeNcZb7LA0rCwifQH2w () mail ! gmail ! com>",
          "author_name": "Eric Dumazet",
          "author_email": "edumazet () google ! com",
          "subject": "Re: [PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-10-02 14:41:34+00:00",
          "date_str": "Wed, 02 Oct 2024 14:41:34 +0000",
          "body": "On Wed, Oct 2, 2024 at 3:47=E2=80=AFPM Moon Yeounsu <yyyynoom@gmail.com> wr=\note:\n>\n> Moon is stupid. He doesn't understand what's going on. It makes me upset.\n>\n> https://lore.kernel.org/netdev/20240919145609.GF1571683@kernel.org/\n>\n> Simon did the best effort for him, but he didn't remember that.\n>\n> Please don't reply to this careless patch.\n>\n> Replies to me to remember all the maintainer's dedication and thoughtfuln=\ness and to take this to heart.\n>\n> Before I send the patch, I'll check it again and again. And fix the subje=\nct `net` to `net-next`.\n>\n> I'm very very disappointed to myself :(\n\nLOCKDEP is more powerful than sparse, I would not bother with this at all.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172788026531674.mbox",
          "message_id": "<CANn89i+aHZWGqWjCQXacRV4SBGXJvyEVeNcZb7LA0rCwifQH2w () mail ! gmail ! com>",
          "author_name": "Eric Dumazet",
          "author_email": "edumazet () google ! com",
          "subject": "Re: [PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-10-02 14:41:34+00:00",
          "date_str": "Wed, 02 Oct 2024 14:41:34 +0000",
          "body": "On Wed, Oct 2, 2024 at 3:47=E2=80=AFPM Moon Yeounsu <yyyynoom@gmail.com> wr=\note:\n>\n> Moon is stupid. He doesn't understand what's going on. It makes me upset.\n>\n> https://lore.kernel.org/netdev/20240919145609.GF1571683@kernel.org/\n>\n> Simon did the best effort for him, but he didn't remember that.\n>\n> Please don't reply to this careless patch.\n>\n> Replies to me to remember all the maintainer's dedication and thoughtfuln=\ness and to take this to heart.\n>\n> Before I send the patch, I'll check it again and again. And fix the subje=\nct `net` to `net-next`.\n>\n> I'm very very disappointed to myself :(\n\nLOCKDEP is more powerful than sparse, I would not bother with this at all.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172796371713321.mbox",
          "message_id": "<CAAjsZQxEKLZd-fQdRiu68uX6Kg4opW4wsQRaLcKyfnQ+UyO+vw () mail ! gmail ! com>",
          "author_name": "Moon Yeounsu",
          "author_email": "yyyynoom () gmail ! com",
          "subject": "Re: [PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-10-03 13:56:59+00:00",
          "date_str": "Thu, 03 Oct 2024 13:56:59 +0000",
          "body": "On Wed, Oct 2, 2024 at 11:41=E2=80=AFPM Eric Dumazet <edumazet@google.com> =\nwrote:\n>\n> On Wed, Oct 2, 2024 at 3:47=E2=80=AFPM Moon Yeounsu <yyyynoom@gmail.com> =\nwrote:\n> >\n> > Moon is stupid. He doesn't understand what's going on. It makes me upse=\nt.\n> >\n> > https://lore.kernel.org/netdev/20240919145609.GF1571683@kernel.org/\n> >\n> > Simon did the best effort for him, but he didn't remember that.\n> >\n> > Please don't reply to this careless patch.\n> >\n> > Replies to me to remember all the maintainer's dedication and thoughtfu=\nlness and to take this to heart.\n> >\n> > Before I send the patch, I'll check it again and again. And fix the sub=\nject `net` to `net-next`.\n> >\n> > I'm very very disappointed to myself :(\n>\n> LOCKDEP is more powerful than sparse, I would not bother with this at all=\n.\n\nTotally agree with that. `Sparse` has a lot of problems derived from its na=\nture.\nAnd It is too annoying to silence the warning message. I know that\nthis patch just fixes for a fix. (What a trivial?)\nBut, even though `LOCKDEP` is more powerful than `Sparse`, that can't\nbe the reason to ignore the warning message.\n\nIt is only my opinion and this topic may be outside of the net\nsubsystem. Please don't be offended by my words and ignorance. I don't\nwant to make a problem, rather want to fix a problem.\nIf there's no reason to use `Sparse`, then, how about just removing it\nfrom the kernel? If It can't, we have to make Sparse more useful at\nleast make to have to care about this warning message.\n\n> LOCKDEP is more powerful than sparse, I would not bother with this at all=\n.\n\nLeastways, This sentence is irrational in my view. Let me know, world!\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172796371813322.mbox",
          "message_id": "<CAAjsZQxEKLZd-fQdRiu68uX6Kg4opW4wsQRaLcKyfnQ+UyO+vw () mail ! gmail ! com>",
          "author_name": "Moon Yeounsu",
          "author_email": "yyyynoom () gmail ! com",
          "subject": "Re: [PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-10-03 13:56:59+00:00",
          "date_str": "Thu, 03 Oct 2024 13:56:59 +0000",
          "body": "On Wed, Oct 2, 2024 at 11:41=E2=80=AFPM Eric Dumazet <edumazet@google.com> =\nwrote:\n>\n> On Wed, Oct 2, 2024 at 3:47=E2=80=AFPM Moon Yeounsu <yyyynoom@gmail.com> =\nwrote:\n> >\n> > Moon is stupid. He doesn't understand what's going on. It makes me upse=\nt.\n> >\n> > https://lore.kernel.org/netdev/20240919145609.GF1571683@kernel.org/\n> >\n> > Simon did the best effort for him, but he didn't remember that.\n> >\n> > Please don't reply to this careless patch.\n> >\n> > Replies to me to remember all the maintainer's dedication and thoughtfu=\nlness and to take this to heart.\n> >\n> > Before I send the patch, I'll check it again and again. And fix the sub=\nject `net` to `net-next`.\n> >\n> > I'm very very disappointed to myself :(\n>\n> LOCKDEP is more powerful than sparse, I would not bother with this at all=\n.\n\nTotally agree with that. `Sparse` has a lot of problems derived from its na=\nture.\nAnd It is too annoying to silence the warning message. I know that\nthis patch just fixes for a fix. (What a trivial?)\nBut, even though `LOCKDEP` is more powerful than `Sparse`, that can't\nbe the reason to ignore the warning message.\n\nIt is only my opinion and this topic may be outside of the net\nsubsystem. Please don't be offended by my words and ignorance. I don't\nwant to make a problem, rather want to fix a problem.\nIf there's no reason to use `Sparse`, then, how about just removing it\nfrom the kernel? If It can't, we have to make Sparse more useful at\nleast make to have to care about this warning message.\n\n> LOCKDEP is more powerful than sparse, I would not bother with this at all=\n.\n\nLeastways, This sentence is irrational in my view. Let me know, world!\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172796507414154.mbox",
          "message_id": "<CANn89i+hNfRjhvpRR+WXqD72ko4_-N+Tj3CqmJTBGyi3SpQ+Og () mail ! gmail ! com>",
          "author_name": "Eric Dumazet",
          "author_email": "edumazet () google ! com",
          "subject": "Re: [PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-10-03 14:19:35+00:00",
          "date_str": "Thu, 03 Oct 2024 14:19:35 +0000",
          "body": "On Thu, Oct 3, 2024 at 3:57=E2=80=AFPM Moon Yeounsu <yyyynoom@gmail.com> wr=\note:\n>\n> On Wed, Oct 2, 2024 at 11:41=E2=80=AFPM Eric Dumazet <edumazet@google.com=\n> wrote:\n> >\n> > On Wed, Oct 2, 2024 at 3:47=E2=80=AFPM Moon Yeounsu <yyyynoom@gmail.com=\n> wrote:\n> > >\n> > > Moon is stupid. He doesn't understand what's going on. It makes me up=\nset.\n> > >\n> > > https://lore.kernel.org/netdev/20240919145609.GF1571683@kernel.org/\n> > >\n> > > Simon did the best effort for him, but he didn't remember that.\n> > >\n> > > Please don't reply to this careless patch.\n> > >\n> > > Replies to me to remember all the maintainer's dedication and thought=\nfulness and to take this to heart.\n> > >\n> > > Before I send the patch, I'll check it again and again. And fix the s=\nubject `net` to `net-next`.\n> > >\n> > > I'm very very disappointed to myself :(\n> >\n> > LOCKDEP is more powerful than sparse, I would not bother with this at a=\nll.\n>\n> Totally agree with that. `Sparse` has a lot of problems derived from its =\nnature.\n> And It is too annoying to silence the warning message. I know that\n> this patch just fixes for a fix. (What a trivial?)\n> But, even though `LOCKDEP` is more powerful than `Sparse`, that can't\n> be the reason to ignore the warning message.\n>\n> It is only my opinion and this topic may be outside of the net\n> subsystem. Please don't be offended by my words and ignorance. I don't\n> want to make a problem, rather want to fix a problem.\n> If there's no reason to use `Sparse`, then, how about just removing it\n> from the kernel? If It can't, we have to make Sparse more useful at\n> least make to have to care about this warning message.\n\nsparse is not in the kernel. Feel free to remove it from your hosts.\n\nAnyway, the __acquires(XXX) annotations means nothing, XXX is\ncompletely ignored.\n\n$ diff --git a/net/ipv4/fib_trie.c b/net/ipv4/fib_trie.c\nindex 09e31757e96c7472af2a9dfff7a731d4d076aa11..50fc48c6d0c99d91f5a8eb15c4e=\n3dd0304a83e0b\n100644\n--- a/net/ipv4/fib_trie.c\n+++ b/net/ipv4/fib_trie.c\n@@ -2888,7 +2888,7 @@ static struct key_vector\n*fib_route_get_idx(struct fib_route_iter *iter,\n }\n\n static void *fib_route_seq_start(struct seq_file *seq, loff_t *pos)\n-       __acquires(RCU)\n+       __acquires(some_random_stuff)\n {\n        struct fib_route_iter *iter =3D seq->private;\n        struct fib_table *tb;\n\n\n$ make C=3D1 net/ipv4/fib_trie.o\n  CALL    scripts/checksyscalls.sh\n  DESCEND objtool\n  INSTALL libsubcmd_headers\n  DESCEND bpf/resolve_btfids\n  INSTALL libsubcmd_headers\n  CC      net/ipv4/fib_trie.o\n  CHECK   net/ipv4/fib_trie.c\n\nNo error at all.\n\nIt also does not know about conditional locking, it is quite useless.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172796508414158.mbox",
          "message_id": "<CANn89i+hNfRjhvpRR+WXqD72ko4_-N+Tj3CqmJTBGyi3SpQ+Og () mail ! gmail ! com>",
          "author_name": "Eric Dumazet",
          "author_email": "edumazet () google ! com",
          "subject": "Re: [PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-10-03 14:19:35+00:00",
          "date_str": "Thu, 03 Oct 2024 14:19:35 +0000",
          "body": "On Thu, Oct 3, 2024 at 3:57=E2=80=AFPM Moon Yeounsu <yyyynoom@gmail.com> wr=\note:\n>\n> On Wed, Oct 2, 2024 at 11:41=E2=80=AFPM Eric Dumazet <edumazet@google.com=\n> wrote:\n> >\n> > On Wed, Oct 2, 2024 at 3:47=E2=80=AFPM Moon Yeounsu <yyyynoom@gmail.com=\n> wrote:\n> > >\n> > > Moon is stupid. He doesn't understand what's going on. It makes me up=\nset.\n> > >\n> > > https://lore.kernel.org/netdev/20240919145609.GF1571683@kernel.org/\n> > >\n> > > Simon did the best effort for him, but he didn't remember that.\n> > >\n> > > Please don't reply to this careless patch.\n> > >\n> > > Replies to me to remember all the maintainer's dedication and thought=\nfulness and to take this to heart.\n> > >\n> > > Before I send the patch, I'll check it again and again. And fix the s=\nubject `net` to `net-next`.\n> > >\n> > > I'm very very disappointed to myself :(\n> >\n> > LOCKDEP is more powerful than sparse, I would not bother with this at a=\nll.\n>\n> Totally agree with that. `Sparse` has a lot of problems derived from its =\nnature.\n> And It is too annoying to silence the warning message. I know that\n> this patch just fixes for a fix. (What a trivial?)\n> But, even though `LOCKDEP` is more powerful than `Sparse`, that can't\n> be the reason to ignore the warning message.\n>\n> It is only my opinion and this topic may be outside of the net\n> subsystem. Please don't be offended by my words and ignorance. I don't\n> want to make a problem, rather want to fix a problem.\n> If there's no reason to use `Sparse`, then, how about just removing it\n> from the kernel? If It can't, we have to make Sparse more useful at\n> least make to have to care about this warning message.\n\nsparse is not in the kernel. Feel free to remove it from your hosts.\n\nAnyway, the __acquires(XXX) annotations means nothing, XXX is\ncompletely ignored.\n\n$ diff --git a/net/ipv4/fib_trie.c b/net/ipv4/fib_trie.c\nindex 09e31757e96c7472af2a9dfff7a731d4d076aa11..50fc48c6d0c99d91f5a8eb15c4e=\n3dd0304a83e0b\n100644\n--- a/net/ipv4/fib_trie.c\n+++ b/net/ipv4/fib_trie.c\n@@ -2888,7 +2888,7 @@ static struct key_vector\n*fib_route_get_idx(struct fib_route_iter *iter,\n }\n\n static void *fib_route_seq_start(struct seq_file *seq, loff_t *pos)\n-       __acquires(RCU)\n+       __acquires(some_random_stuff)\n {\n        struct fib_route_iter *iter =3D seq->private;\n        struct fib_table *tb;\n\n\n$ make C=3D1 net/ipv4/fib_trie.o\n  CALL    scripts/checksyscalls.sh\n  DESCEND objtool\n  INSTALL libsubcmd_headers\n  DESCEND bpf/resolve_btfids\n  INSTALL libsubcmd_headers\n  CC      net/ipv4/fib_trie.o\n  CHECK   net/ipv4/fib_trie.c\n\nNo error at all.\n\nIt also does not know about conditional locking, it is quite useless.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172796948717088.mbox",
          "message_id": "<CAAjsZQxkH8nmHchtFFPm5VouLEaViR5HTRCCnrP0d9jSF2pGAQ () mail ! gmail ! com>",
          "author_name": "Moon Yeounsu",
          "author_email": "yyyynoom () gmail ! com",
          "subject": "Re: [PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-10-03 15:33:06+00:00",
          "date_str": "Thu, 03 Oct 2024 15:33:06 +0000",
          "body": "> sparse is not in the kernel. Feel free to remove it from your hosts.\nOh... I see. Yes, you are right. Sparse is just a program like other\ntools like gcc.\n\n>\n> $ diff --git a/net/ipv4/fib_trie.c b/net/ipv4/fib_trie.c\n> index 09e31757e96c7472af2a9dfff7a731d4d076aa11..50fc48c6d0c99d91f5a8eb15c4e3dd0304a83e0b\n> 100644\n> --- a/net/ipv4/fib_trie.c\n> +++ b/net/ipv4/fib_trie.c\n> @@ -2888,7 +2888,7 @@ static struct key_vector\n> *fib_route_get_idx(struct fib_route_iter *iter,\n>  }\n>\n>  static void *fib_route_seq_start(struct seq_file *seq, loff_t *pos)\n> -       __acquires(RCU)\n> +       __acquires(some_random_stuff)\n>  {\n>         struct fib_route_iter *iter = seq->private;\n>         struct fib_table *tb;\n>\n>\n> $ make C=1 net/ipv4/fib_trie.o\n>   CALL    scripts/checksyscalls.sh\n>   DESCEND objtool\n>   INSTALL libsubcmd_headers\n>   DESCEND bpf/resolve_btfids\n>   INSTALL libsubcmd_headers\n>   CC      net/ipv4/fib_trie.o\n>   CHECK   net/ipv4/fib_trie.c\n>\n> No error at all.\n> It also does not know about conditional locking, it is quite useless.\nYes, exactly. And It makes me crazy.\n`net/ipv6/icmp.c` was written to use the conditional lock as you mentioned.\nThis is not a problem and can easily be verified intuitively, but\nSparse can't sense it.\nTo refactor the code to silent `Sparse` is putting the cart before the\nhorse. NON-SENSE.\n\nSo... What do you think about who wants to send the patch to silence\nthe Sparse's warning message, nevertheless?\nI know him who was just about to write the next patch by correcting\nmistakes (Seems like he wrote the subject prefix to `net`, not a\n`net-next`, what a foolish one).\nIs he wasting his life and taking other people's invaluable time? What\ndo you think about it?\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172796948117085.mbox",
          "message_id": "<CAAjsZQxkH8nmHchtFFPm5VouLEaViR5HTRCCnrP0d9jSF2pGAQ () mail ! gmail ! com>",
          "author_name": "Moon Yeounsu",
          "author_email": "yyyynoom () gmail ! com",
          "subject": "Re: [PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-10-03 15:33:06+00:00",
          "date_str": "Thu, 03 Oct 2024 15:33:06 +0000",
          "body": "> sparse is not in the kernel. Feel free to remove it from your hosts.\nOh... I see. Yes, you are right. Sparse is just a program like other\ntools like gcc.\n\n>\n> $ diff --git a/net/ipv4/fib_trie.c b/net/ipv4/fib_trie.c\n> index 09e31757e96c7472af2a9dfff7a731d4d076aa11..50fc48c6d0c99d91f5a8eb15c4e3dd0304a83e0b\n> 100644\n> --- a/net/ipv4/fib_trie.c\n> +++ b/net/ipv4/fib_trie.c\n> @@ -2888,7 +2888,7 @@ static struct key_vector\n> *fib_route_get_idx(struct fib_route_iter *iter,\n>  }\n>\n>  static void *fib_route_seq_start(struct seq_file *seq, loff_t *pos)\n> -       __acquires(RCU)\n> +       __acquires(some_random_stuff)\n>  {\n>         struct fib_route_iter *iter = seq->private;\n>         struct fib_table *tb;\n>\n>\n> $ make C=1 net/ipv4/fib_trie.o\n>   CALL    scripts/checksyscalls.sh\n>   DESCEND objtool\n>   INSTALL libsubcmd_headers\n>   DESCEND bpf/resolve_btfids\n>   INSTALL libsubcmd_headers\n>   CC      net/ipv4/fib_trie.o\n>   CHECK   net/ipv4/fib_trie.c\n>\n> No error at all.\n> It also does not know about conditional locking, it is quite useless.\nYes, exactly. And It makes me crazy.\n`net/ipv6/icmp.c` was written to use the conditional lock as you mentioned.\nThis is not a problem and can easily be verified intuitively, but\nSparse can't sense it.\nTo refactor the code to silent `Sparse` is putting the cart before the\nhorse. NON-SENSE.\n\nSo... What do you think about who wants to send the patch to silence\nthe Sparse's warning message, nevertheless?\nI know him who was just about to write the next patch by correcting\nmistakes (Seems like he wrote the subject prefix to `net`, not a\n`net-next`, what a foolish one).\nIs he wasting his life and taking other people's invaluable time? What\ndo you think about it?\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172797177519259.mbox",
          "message_id": "<e5cb1a17-72e1-529c-0f46-404dcdb3e5f3 () gmail ! com>",
          "author_name": "Edward Cree",
          "author_email": "ecree.xilinx () gmail ! com",
          "subject": "Re: [PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-10-03 16:11:26+00:00",
          "date_str": "Thu, 03 Oct 2024 16:11:26 +0000",
          "body": "On 03/10/2024 16:33, Moon Yeounsu wrote:\n> On 03/10/2024 15:19, Eric Dumazet wrote:\n>> It also does not know about conditional locking, it is quite useless.\n> So... What do you think about who wants to send the patch to silence\n> the Sparse's warning message, nevertheless?\n\nFwiw, my experience is that if I can't explain the locking to sparse\n that's usually a sign that the code is too complex and needs to be\n rewritten.\nIn general I'm in favour of patches to fix sparse warnings.  In this\n case it looks like what's needed is __cond_acquires, but the patch\n to implement that in sparse[1] doesn't seem to have gotten anywhere\n near Luc's tree.  (Yet it's present and occasionally used in the\n kernel...)  CCing the sparse ML to find out why.\n\n-ed\n\n[1]: https://lore.kernel.org/all/CAHk-=wjZfO9hGqJ2_hGQG3U_XzSh9_XaXze=HgPdvJbgrvASfA@mail.gmail.com/#t\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172797177119251.mbox",
          "message_id": "<e5cb1a17-72e1-529c-0f46-404dcdb3e5f3 () gmail ! com>",
          "author_name": "Edward Cree",
          "author_email": "ecree.xilinx () gmail ! com",
          "subject": "Re: [PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-10-03 16:11:26+00:00",
          "date_str": "Thu, 03 Oct 2024 16:11:26 +0000",
          "body": "On 03/10/2024 16:33, Moon Yeounsu wrote:\n> On 03/10/2024 15:19, Eric Dumazet wrote:\n>> It also does not know about conditional locking, it is quite useless.\n> So... What do you think about who wants to send the patch to silence\n> the Sparse's warning message, nevertheless?\n\nFwiw, my experience is that if I can't explain the locking to sparse\n that's usually a sign that the code is too complex and needs to be\n rewritten.\nIn general I'm in favour of patches to fix sparse warnings.  In this\n case it looks like what's needed is __cond_acquires, but the patch\n to implement that in sparse[1] doesn't seem to have gotten anywhere\n near Luc's tree.  (Yet it's present and occasionally used in the\n kernel...)  CCing the sparse ML to find out why.\n\n-ed\n\n[1]: https://lore.kernel.org/all/CAHk-=wjZfO9hGqJ2_hGQG3U_XzSh9_XaXze=HgPdvJbgrvASfA@mail.gmail.com/#t\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172798067124724.mbox",
          "message_id": "<20241003113947.6e605b8c () hermes ! local>",
          "author_name": "Stephen Hemminger",
          "author_email": "stephen () networkplumber ! org",
          "subject": "Re: [PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-10-03 18:39:47+00:00",
          "date_str": "Thu, 03 Oct 2024 18:39:47 +0000",
          "body": "On Thu, 3 Oct 2024 17:11:26 +0100\nEdward Cree <ecree.xilinx@gmail.com> wrote:\n\n> On 03/10/2024 16:33, Moon Yeounsu wrote:\n> > On 03/10/2024 15:19, Eric Dumazet wrote:  \n> >> It also does not know about conditional locking, it is quite useless.  \n> > So... What do you think about who wants to send the patch to silence\n> > the Sparse's warning message, nevertheless?  \n\nIn my experience, conditional locking is often a cause of bugs.\n",
          "year": "2024",
          "month": "10"
        },
        {
          "filepath": "emails/2024/10/172798067524728.mbox",
          "message_id": "<20241003113947.6e605b8c () hermes ! local>",
          "author_name": "Stephen Hemminger",
          "author_email": "stephen () networkplumber ! org",
          "subject": "Re: [PATCH net] net: add inline annotation to fix the build warning",
          "date": "2024-10-03 18:39:47+00:00",
          "date_str": "Thu, 03 Oct 2024 18:39:47 +0000",
          "body": "On Thu, 3 Oct 2024 17:11:26 +0100\nEdward Cree <ecree.xilinx@gmail.com> wrote:\n\n> On 03/10/2024 16:33, Moon Yeounsu wrote:\n> > On 03/10/2024 15:19, Eric Dumazet wrote:  \n> >> It also does not know about conditional locking, it is quite useless.  \n> > So... What do you think about who wants to send the patch to silence\n> > the Sparse's warning message, nevertheless?  \n\nIn my experience, conditional locking is often a cause of bugs.\n",
          "year": "2024",
          "month": "10"
        }
      ],
      "primary_category": "kernel_integration"
    },
    {
      "subject": "Re: [PATCH] sentinel_ctltable: Add a check for sentinel elements in ctl_table arrays",
      "normalized_subject": "sentinel_ctltable: Add a check for sentinel elements in ctl_table arrays",
      "message_count": 2,
      "participants": [
        "Joel Granados via B4 Relay",
        "Dan Carpenter"
      ],
      "categories": [
        "kernel_integration"
      ],
      "first_date": "2024-06-14T12:29:41+00:00",
      "last_date": "2024-06-14T13:28:52+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/06/171836800226823.mbox",
          "message_id": "<20240614-master-v1-1-c652f5aa15fb () samsung ! com>",
          "author_name": "Joel Granados via B4 Relay",
          "author_email": "devnull+j.granados.samsung.com () kernel ! org",
          "subject": "[PATCH] sentinel_ctltable: Add a check for sentinel elements in ctl_table arrays",
          "date": "2024-06-14 12:29:41+00:00",
          "date_str": "Fri, 14 Jun 2024 12:29:41 +0000",
          "body": "From: Joel Granados <j.granados@samsung.com>\n\nAdded a new check named check_sentinel_ctltable that prints a warning\nwhen a sentinel element is detected in a ctl_table struct array.\nSentinels marking the end of a ctl_table array where completely removed\nfrom the linux kernel in [1]. We add this warning to avoid cases where a\nsentinel gets added by mistake.\n\n[1] https://lore.kernel.org/20240604-jag-sysctl_remset-v1-0-2df7ecdba0bd@samsung.com\n\nSigned-off-by: Joel Granados <j.granados@samsung.com>\n---\nSigned-off-by: Joel Granados <j.granados@samsung.com>\n\n--\n---\n check_list.h              |  1 +\n check_sentinel_ctltable.c | 41 +++++++++++++++++++++++++++++++++++++++++\n 2 files changed, 42 insertions(+)\n\ndiff --git a/check_list.h b/check_list.h\nindex 7115b069..a870c95f 100644\n--- a/check_list.h\n+++ b/check_list.h\n@@ -252,6 +252,7 @@ CK(check_direct_return_instead_of_goto)\n CK(check_double_fget)\n CK(check_negative_error_code_type_promoted)\n CK(check_uninitialized_kobj)\n+CK(check_sentinel_ctltable)\n \n /* wine specific stuff */\n CK(check_wine_filehandles)\ndiff --git a/check_sentinel_ctltable.c b/check_sentinel_ctltable.c\nnew file mode 100644\nindex 00000000..8bdb582a\n--- /dev/null\n+++ b/check_sentinel_ctltable.c\n@@ -0,0 +1,41 @@\n+#include \"smatch.h\"\n+\n+struct non_null_ctltable_elems {\n+\tconst char *name;\n+\tconst int len;\n+};\n+\n+static struct non_null_ctltable_elems non_null_elems[] = {\n+\t{.name = \"->procname\", .len = 10},\n+\t{.name = \"->proc_handler\", .len = 14},\n+};\n+\n+static int match_ctl_table_array_sentinel(struct expression *expr)\n+{\n+\tchar * member_name = NULL;\n+\tif (!expr)\n+\t\treturn 0;\n+\n+\tmember_name = get_member_name(expr);\n+\tif (!member_name)\n+\t\treturn 0;\n+\n+\tif (strncmp(member_name, \"(struct ctl_table)\", 18) != 0)\n+\t\treturn 0;\n+\n+\tfor (int i = 0 ; i < ARRAY_SIZE(non_null_elems) ; ++i) {\n+\t\tif (strncmp(member_name + 18, non_null_elems[i].name, non_null_elems[i].len) ==0) {\n+\t\t\tsm_warning (\"(struct ctl_table)%s cannot be NULL. Expression : %s\",\n+\t\t\t\t    non_null_elems[i].name, expr_to_str(expr));\n+\t\t\treturn 0;\n+\t\t}\n+\t}\n+\n+\treturn 0;\n+}\n+\n+void check_sentinel_ctltable(int id)\n+{\n+\tadd_hook(&match_ctl_table_array_sentinel, EXPR_HOOK);\n+}\n+\n\n---\nbase-commit: ff1cc4d453ffeddf3cf3dc031c5b129eefbf3e2c\nchange-id: 20240614-master-db259d890db0\n\nBest regards,\n-- \nJoel Granados <j.granados@samsung.com>\n\n\n",
          "year": "2024",
          "month": "06"
        },
        {
          "filepath": "emails/2024/06/171837151629284.mbox",
          "message_id": "<b8162eb2-eeb2-44e0-9f3f-13af426a8a53 () moroto ! mountain>",
          "author_name": "Dan Carpenter",
          "author_email": "dan.carpenter () linaro ! org",
          "subject": "Re: [PATCH] sentinel_ctltable: Add a check for sentinel elements in ctl_table arrays",
          "date": "2024-06-14 13:28:52+00:00",
          "date_str": "Fri, 14 Jun 2024 13:28:52 +0000",
          "body": "On Fri, Jun 14, 2024 at 02:29:41PM +0200, Joel Granados via B4 Relay wrote:\n> From: Joel Granados <j.granados@samsung.com>\n> \n> Added a new check named check_sentinel_ctltable that prints a warning\n> when a sentinel element is detected in a ctl_table struct array.\n> Sentinels marking the end of a ctl_table array where completely removed\n> from the linux kernel in [1]. We add this warning to avoid cases where a\n> sentinel gets added by mistake.\n> \n> [1] https://lore.kernel.org/20240604-jag-sysctl_remset-v1-0-2df7ecdba0bd@samsung.com\n> \n> Signed-off-by: Joel Granados <j.granados@samsung.com>\n> ---\n\nApplied, thanks!\n\nregards,\ndan carpenter\n\n",
          "year": "2024",
          "month": "06"
        }
      ],
      "primary_category": "kernel_integration"
    },
    {
      "subject": "[RFC PATCH] Use x86 named address spaces to catch \"sparse: incorrect type in initializer (different ",
      "normalized_subject": "Use x86 named address spaces to catch \"sparse: incorrect type in initializer (different",
      "message_count": 1,
      "participants": [
        "Uros Bizjak"
      ],
      "categories": [
        "type_system",
        "rfc_proposals",
        "compiler_compat",
        "address_space"
      ],
      "first_date": "2024-04-29T21:30:09+00:00",
      "last_date": "2024-04-29T21:30:09+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/04/171442605112847.mbox",
          "message_id": "<CAFULd4Z-stHtu2UWv02S+Nbx51QqytGUO8ZeW50Fc_PbsfF8BA () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "[RFC PATCH] Use x86 named address spaces to catch \"sparse: incorrect type in initializer (different ",
          "date": "2024-04-29 21:30:09+00:00",
          "date_str": "Mon, 29 Apr 2024 21:30:09 +0000",
          "body": "--000000000000f1b815061742f5a7\nContent-Type: text/plain; charset=\"UTF-8\"\nContent-Transfer-Encoding: quoted-printable\n\nOn Mon, Mar 4, 2024 at 12:49=E2=80=AFAM Thomas Gleixner <tglx@linutronix.de=\n> wrote:\n\n> >> > That's so sad because it would provide us compiler based __percpu\n> >> > validation.\n> >>\n> >> Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n> >> of limited use also when const and volatile qualifiers are used.\n> >> Perhaps some extension could be introduced to c standard to provide an\n> >> unqualified type, e.g. typeof_unqual().\n> >\n> > Oh, there is one in C23 [1].\n>\n> Yes. I found it right after ranting.\n>\n> gcc >=3D 14 and clang >=3D 16 have support for it of course only when add=\ning\n> -std=3Dc2x to the command line.\n>\n> Sigh. The name space qualifiers are non standard and then the thing\n> which makes them more useful is hidden behind a standard.\n>\n> Why can't we have useful tools?\n>\n> Though the whole thing looks worthwhile:\n>\n> #define verify_per_cpu_ptr(ptr)                                         \\\n> do {                                                                    \\\n>         const void __seg_gs *__vpp_verify =3D (typeof((ptr) + 0))NULL;   =\n \\\n>         (void)__vpp_verify;                                             \\\n> } while (0)\n>\n> #define per_cpu_ptr(ptr, cpu)                                           \\\n> ({                                                                      \\\n>         verify_per_cpu_ptr(ptr);                                        \\\n>         (typeof_unqual(*(ptr)) *)(uintptr_t)ptr + per_cpu_offset(cpu);  \\\n> })\n>\n> unsigned int __seg_gs test;\n>\n> unsigned int foo1(unsigned int cpu)\n> {\n>         return *per_cpu_ptr(&test, cpu);\n> }\n>\n> unsigned int foo2(unsigned int cpu)\n> {\n>         unsigned int x, *p =3D per_cpu_ptr(&x, cpu);\n>\n>         return *p;\n> }\n>\n> x.c:29:23: error: initializing 'const __attribute__((address_space(256)))=\n void *' with an expression of type 'typeof ((&x) + 0)' (aka 'unsigned int =\n*') changes address space of pointer\n>         unsigned int x, *p =3D per_cpu_ptr(&x, cpu);\n>\n> That's exactly what we want. It would have caught all the long standing\n> and ignored __percpu sparse warnings right away.\n>\n> This also simplifies all the other per cpu accessors. The most trivial\n> is read()\n>\n> #define verify_per_cpu(variable)                                        \\\n> {                                                                       \\\n>         const unsigned int __s =3D sizeof(variable);                     =\n \\\n>                                                                         \\\n>         verify_per_cpu_ptr(&(variable));                                \\\n>         BUILD_BUG_ON(__s =3D=3D 1 || __s =3D=3D 2 || __s =3D=3D 4 || __s =\n=3D=3D 8,      \\\n>                      \"Wrong size for per CPU variable\");                \\\n> }\n>\n> #define __pcpu_read(variable)                                           \\\n> ({                                                                      \\\n>         verify_per_cpu(variable);                                       \\\n>         READ_ONCE(variable);                                            \\\n> })\n>\n> which in turn catches all the mistakes, i.e. wrong namespace and wrong\n> size.\n>\n> I'm really tempted to implement this as an alternative to the current\n> pile of macro horrors. Of course this requires to figure out first what\n> kind of damage -std=3Dc2x will do.\n>\n> I get to that in my copious spare time some day.\n\nPlease find attached the prototype patch that does the above.\n\nThe idea of the patch is to add named address qualifier to the __percpu tag=\n:\n\n-# define __percpu    BTF_TYPE_TAG(percpu)\n+# define __percpu    __percpu_seg_override BTF_TYPE_TAG(percpu)\n\nSo instead of being merely a benign hint to the checker, __percpu\nbecomes the real x86 named address space qualifier to enable the\ncompiler checks for access to different address spaces. Following the\nabove change, we can remove various casts that cast \"fake\" percpu\naddresses at the usage site and use the kernel type system to handle\nnamed AS qualified addresses instead:\n\n-#define __my_cpu_type(var)    typeof(var) __percpu_seg_override\n-#define __my_cpu_ptr(ptr)    (__my_cpu_type(*(ptr))*)(__force uintptr_t)(p=\ntr)\n-#define __my_cpu_var(var)    (*__my_cpu_ptr(&(var)))\n-#define __percpu_arg(x)        __percpu_prefix \"%\" #x\n+#define __my_cpu_type(var)    typeof(var)\n+#define __my_cpu_ptr(ptr)    (ptr)\n+#define __my_cpu_var(var)    (var)\n+#define __percpu_arg(x)        \"%\" #x\n\nAs can be seen from the patch, various temporary non-percpu variables\nneed to be declared with __typeof_unqual__ to use unqualified base\ntype without named AS qualifier. In addition to the named AS\nqualifier, __typeof_unqual__ also strips const and volatile\nqualifiers, so it can enable some further optimizations involving\nthis_cpu_read_stable, not a topic of this patch.\n\nThe patch is against the recent -tip tree and needs to be compiled\nwith gcc",
          "year": "2024",
          "month": "04"
        }
      ],
      "primary_category": "address_space"
    },
    {
      "subject": "Re: warning: cast removes address space '__percpu' of expression",
      "normalized_subject": "warning: cast removes address space '__percpu' of expression",
      "message_count": 1,
      "participants": [
        "Charlemagne Lasse"
      ],
      "categories": [
        "kernel_integration",
        "sparse_internals",
        "type_system",
        "address_space",
        "compiler_compat"
      ],
      "first_date": "2024-04-22T07:22:39+00:00",
      "last_date": "2024-04-22T07:22:39+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/04/171377055727949.mbox",
          "message_id": "<CAFGhKbwXOpR4GaQF11BA2viCTa6Zbcmd=fF+2yxvPiROmF+yVw () mail ! gmail ! com>",
          "author_name": "Charlemagne Lasse",
          "author_email": "charlemagnelasse () gmail ! com",
          "subject": "Re: warning: cast removes address space '__percpu' of expression",
          "date": "2024-04-22 07:22:39+00:00",
          "date_str": "Mon, 22 Apr 2024 07:22:39 +0000",
          "body": "Am Mi., 3. Apr. 2024 um 09:14 Uhr schrieb Charlemagne Lasse\n<charlemagnelasse@gmail.com>:\n>\n> Am Di., 2. Apr. 2024 um 22:40 Uhr schrieb Uros Bizjak <ubizjak@gmail.com>:\n> [snip]\n> > > ```\n> > > git reset --hard ed2f752e0e0a21d941ca0ee539ef3d4cd576bc5e\n> > > git cherry-pick 3a1d3829e193c091475ceab481c5f8deab385023\n> > > patch -p1 -i ~/p.diff.txt\n> > > git clean -dfx\n> > > make allnoconfig -j$(nproc)\n> > > make kvm_guest.config\n> > > echo CONFIG_MODULES=y >> .config\n> > > echo CONFIG_NET_9P_VIRTIO=m >> .config\n> > > make olddefconfig\n> > > make prepare -j$(nproc)\n> > > touch net/9p/trans_virtio.c\n> > > make C=1 M=net/9p/ trans_virtio.o CHECK=\"sparse -Wconstexpr-not-const\"\n> > > ```\n> > >\n> > > This now shows the warning:\n> > >\n> > > ```\n> > > net/9p/trans_virtio.c:831:1: warning: non-constant initializer for static object\n> > > net/9p/trans_virtio.c:832:1: warning: non-constant initializer for static object\n> > > ```\n> [snip]\n> > It's this part:\n> >\n> > diff --git a/include/linux/compiler.h b/include/linux/compiler.h\n> > index d7779a18b24fc3..bf9815eaf4aabf 100644\n> > --- a/include/linux/compiler.h\n> > +++ b/include/linux/compiler.h\n> > @@ -212,7 +212,7 @@ void ftrace_likely_update(struct\n> > ftrace_likely_data *f, int val,\n> > */\n> > #define ___ADDRESSABLE(sym, __attrs) \\\n> > static void * __used __attrs \\\n> > - __UNIQUE_ID(__PASTE(__addressable_,sym)) = (void *)&sym;\n> > + __UNIQUE_ID(__PASTE(__addressable_,sym)) = (void *)(uintptr_t)&sym;\n> > #define __ADDRESSABLE(sym) \\\n> > ___ADDRESSABLE(sym, __section(\".discard.addressable\"))\n> >\n> > But ... how is this not const?\n>\n> @Luc Van Oostenryck Do you have any idea how to correctly implement it\n> to make sparse happy?\n\nping?\n",
          "year": "2024",
          "month": "04"
        }
      ],
      "primary_category": "kernel_integration"
    },
    {
      "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
      "normalized_subject": "[patch 5/9] x86: Cure per CPU madness on UP",
      "message_count": 26,
      "participants": [
        "Guenter Roeck",
        "Linus Torvalds",
        "David Laight",
        "Thomas Gleixner",
        "Arnd Bergmann"
      ],
      "categories": [
        "general",
        "sparse_internals"
      ],
      "first_date": "2024-03-16T00:56:36+00:00",
      "last_date": "2024-03-21T16:49:30+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/03/171055049627655.mbox",
          "message_id": "<7d0be0f7-e988-4ca2-b61b-21853e4268f6 () roeck-us ! net>",
          "author_name": "Guenter Roeck",
          "author_email": "linux () roeck-us ! net",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-16 00:56:36+00:00",
          "date_str": "Sat, 16 Mar 2024 00:56:36 +0000",
          "body": "On 3/15/24 15:55, Thomas Gleixner wrote:\n> On Fri, Mar 15 2024 at 18:40, Thomas Gleixner wrote:\n>> On Fri, Mar 15 2024 at 09:42, Linus Torvalds wrote:\n>>> On Fri, 15 Mar 2024 at 09:17, Guenter Roeck <linux@roeck-us.net> wrote:\n>>> Thomas, over to you. I wonder if maybe all those topology macros\n>>> should just return 0 on an UP build, but that\n>>> topology_get_logical_id() thing looks a bit wrong regardless.\n>>>\n>>> It really shouldn't depend on local apic data for configs that may not\n>>> *have* a local apic.\n>>\n>> Right. Let me look.\n> \n> Not really. The problem is that a SMP build can run on a UP machine w/o\n> APIC or command line disables the APIC and will run into the exactly\n> same problem. The only case where we know that it is impossible is when\n> APIC support is disabled, which is silly but topic for a different\n> discussion.\n> \n> So the proper thing to do is to check for num_possible_cpus() == 1 in\n> that function.\n> \n> Sure you can argue that we could avoid it for SMP=n builds completely,\n> but I think the right thing to do is to aim for removing CONFIG_SMP and\n> make the UP build a subset of a generic SMP capable build which has\n> CONFIG_NR_CPUS=1, i.e. num_possible_cpus() = 1. Why?\n> \n> Because it consolidates the code and makes UP use exactly the same\n> mechanisms as SMP which pretty much avoids the problem we see today that\n> UP lacks test coverage and becomes more esoteric and untested over time.\n> \n> The downside is a slightly larger kernel image for such a build.\n> \n> Though if we pretend that we seriously care about that 10% larger memory\n> footprint or about the marginal performance benefit of SMP=n on dead\n> hardware, then we are just taking the wrong pills.\n> \n\nFWIW, I would very much prefer for SMP=n builds to go away for x86.\nI don't think anyone uses that in the real world nowadays, and I never\nknow if I should report problems like this one or just stop testing it.\n\n> The point is that this very commit in question was heading deliberately\n> into the direction of removing the by now silly differences of UP/SMP\n> for correctness sake. It just happened to unearth the missing check in\n> topology_get_logical_id(), but that check is required independent of\n> SMP=y/n as I pointed out above.\n> \n> Thanks,\n> \n>          tglx\n> \n> ---\n> diff --git a/arch/x86/kernel/cpu/topology.c b/arch/x86/kernel/cpu/topology.c\n> index 3259b1d4fefe..118d9f7792ee 100644\n> --- a/arch/x86/kernel/cpu/topology.c\n> +++ b/arch/x86/kernel/cpu/topology.c\n> @@ -279,6 +279,15 @@ int topology_get_logical_id(u32 apicid, enum x86_topology_domains at_level)\n>   \n>   \tif (lvlid >= MAX_LOCAL_APIC)\n>   \t\treturn -ERANGE;\n> +\t/*\n> +\t * Spare the exercise on UP as there is only one instance at any\n> +\t * level and the map check below might fail because the CPU does\n> +\t * not have a local APIC or local APIC has been disabled on the\n> +\t * kernel command line.\n> +\t */\n> +\tif (num_possible_cpus() == 1)\n> +\t\treturn 0;\n> +\n\nThat works.\n\nTested-by: Guenter Roeck <linux@roeck-us.net>\n\n>   \tif (!test_bit(lvlid, apic_maps[at_level].map))\n>   \t\treturn -ENODEV;\n>   \t/* Get the number of set bits before @lvlid. */\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171055049427652.mbox",
          "message_id": "<7d0be0f7-e988-4ca2-b61b-21853e4268f6 () roeck-us ! net>",
          "author_name": "Guenter Roeck",
          "author_email": "linux () roeck-us ! net",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-16 00:56:36+00:00",
          "date_str": "Sat, 16 Mar 2024 00:56:36 +0000",
          "body": "On 3/15/24 15:55, Thomas Gleixner wrote:\n> On Fri, Mar 15 2024 at 18:40, Thomas Gleixner wrote:\n>> On Fri, Mar 15 2024 at 09:42, Linus Torvalds wrote:\n>>> On Fri, 15 Mar 2024 at 09:17, Guenter Roeck <linux@roeck-us.net> wrote:\n>>> Thomas, over to you. I wonder if maybe all those topology macros\n>>> should just return 0 on an UP build, but that\n>>> topology_get_logical_id() thing looks a bit wrong regardless.\n>>>\n>>> It really shouldn't depend on local apic data for configs that may not\n>>> *have* a local apic.\n>>\n>> Right. Let me look.\n> \n> Not really. The problem is that a SMP build can run on a UP machine w/o\n> APIC or command line disables the APIC and will run into the exactly\n> same problem. The only case where we know that it is impossible is when\n> APIC support is disabled, which is silly but topic for a different\n> discussion.\n> \n> So the proper thing to do is to check for num_possible_cpus() == 1 in\n> that function.\n> \n> Sure you can argue that we could avoid it for SMP=n builds completely,\n> but I think the right thing to do is to aim for removing CONFIG_SMP and\n> make the UP build a subset of a generic SMP capable build which has\n> CONFIG_NR_CPUS=1, i.e. num_possible_cpus() = 1. Why?\n> \n> Because it consolidates the code and makes UP use exactly the same\n> mechanisms as SMP which pretty much avoids the problem we see today that\n> UP lacks test coverage and becomes more esoteric and untested over time.\n> \n> The downside is a slightly larger kernel image for such a build.\n> \n> Though if we pretend that we seriously care about that 10% larger memory\n> footprint or about the marginal performance benefit of SMP=n on dead\n> hardware, then we are just taking the wrong pills.\n> \n\nFWIW, I would very much prefer for SMP=n builds to go away for x86.\nI don't think anyone uses that in the real world nowadays, and I never\nknow if I should report problems like this one or just stop testing it.\n\n> The point is that this very commit in question was heading deliberately\n> into the direction of removing the by now silly differences of UP/SMP\n> for correctness sake. It just happened to unearth the missing check in\n> topology_get_logical_id(), but that check is required independent of\n> SMP=y/n as I pointed out above.\n> \n> Thanks,\n> \n>          tglx\n> \n> ---\n> diff --git a/arch/x86/kernel/cpu/topology.c b/arch/x86/kernel/cpu/topology.c\n> index 3259b1d4fefe..118d9f7792ee 100644\n> --- a/arch/x86/kernel/cpu/topology.c\n> +++ b/arch/x86/kernel/cpu/topology.c\n> @@ -279,6 +279,15 @@ int topology_get_logical_id(u32 apicid, enum x86_topology_domains at_level)\n>   \n>   \tif (lvlid >= MAX_LOCAL_APIC)\n>   \t\treturn -ERANGE;\n> +\t/*\n> +\t * Spare the exercise on UP as there is only one instance at any\n> +\t * level and the map check below might fail because the CPU does\n> +\t * not have a local APIC or local APIC has been disabled on the\n> +\t * kernel command line.\n> +\t */\n> +\tif (num_possible_cpus() == 1)\n> +\t\treturn 0;\n> +\n\nThat works.\n\nTested-by: Guenter Roeck <linux@roeck-us.net>\n\n>   \tif (!test_bit(lvlid, apic_maps[at_level].map))\n>   \t\treturn -ENODEV;\n>   \t/* Get the number of set bits before @lvlid. */\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171055135327883.mbox",
          "message_id": "<877ci3j80k.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-16 01:11:07+00:00",
          "date_str": "Sat, 16 Mar 2024 01:11:07 +0000",
          "body": "On Fri, Mar 15 2024 at 16:23, Linus Torvalds wrote:\n> On Fri, 15 Mar 2024 at 15:55, Thomas Gleixner <tglx@linutronix.de> wrote:\n>> So the proper thing to do is to check for num_possible_cpus() == 1 in\n>> that function.\n>\n> I think that's _one_ proper thing. I still think that the deeper\n> problem is that it still looks at local apic rules even when those\n> rules are completely nonsensical.\n>\n> For example, that MAX_LOCAL_APIC range test may not matter simply\n> because it's testing a constant value, but it still smells entirely\n> wrong to even check for that, when the system doesn't necessarily have\n> one.\n\ncpu_info.apic_id defaults to 0, so unless the calling code is completely\nbroken it will be correct. And I rather catch the case of calling code\nbeing broken in the !APIC case if we still want to support systems\nwithout a local APIC.\n\n> So I think your patch may fix the immediate bug, but I think it's\n> still just a band-aid.\n>\n> Either we should just make all machines look like they have the proper\n> local apic mappings, or we shouldn't look at any local apic rules AT\n> ALL.\n\nSure. I can simply check if there was an APIC registered instead.\n\n>> Sure you can argue that we could avoid it for SMP=n builds completely,\n>> but I think the right thing to do is to aim for removing CONFIG_SMP and\n>> make the UP build a subset of a generic SMP capable build which has\n>> CONFIG_NR_CPUS=1, i.e. num_possible_cpus() = 1. Why?\n>\n> I wouldn't be entirely opposed to just doing that. UP has become\n> fairly irrelevant.\n>\n> That said, UP is *not* entirely irrelevant on other architectures, and\n> if we drop UP support on x86, we'll be effectively dropping a lot of\n> coverage testing. The number of people who do cross-compilers is\n> pretty small.\n>\n> End result: I'd *much* rather get rid of X86_UP_APIC and the \"nolapic\"\n> kernel command line, and say \"even UP has to have a local APIC\".\n>\n> We already require a Pentium-class CPU, so in practice we already\n> require that local APIC setup. And yes, machines existed where it\n> could be turned off, but I don't think that is relevant any more.\n\nYou wish. We still support 486 and some of the still produced 486 clones\ndo not have a local APIC.\n\nNot that I care and yes I'm all for getting rid of CONFIG_.*_APIC and of\nthe related config/command line options. If we refuse to boot on\nhardware which does not enumerate an APIC then even better.\n\nBut that is only a part of the overall problem.\n\n> Put another way: I think \"UP config for wider build testing\" is a\n> _lot_ more relevant than \"no LAPIC support\".\n\nI really have to disagree here.\n\nThe concept of making UP a proper subset of SMP has absolutely nothing\nto do with x86 and UP test coverage.\n\nWe want SMP as a general concept and overhaul the whole kernel to get\nrid of this ever increasing non-sensical UP burden. The real world UP\nsmall system use cases have moved over to other OSes like Zephyr & Co\nlong ago.\n\nJust because some esoteric architectures (m68k comes to my mind) will\nhave serious issues with that for the very wrong reasons does not mean\nthat we should not go there.\n\nIt's going to be quite some effort, but the overall benefit is worth it.\n\nOTOH, it's absolutely not rocket science to pretend to be SMP capable\nand if some architectures fail to accomodate on the way then we just\nshould remove them as that's a clear sign of being unmaintained and\nirrelevant.\n\nThe amount of untested SMP=n code in the kernel becomes frigthening and\nyour argument that build coverage is making a difference is wishful\nthinking at best.\n\nAnything else than making the kernel SMP capable and making UP builds a\nwell defined subset via CONFIG_NR_CPUS=1 is a complete waste of time and\neffort.\n\nIf your intention is to indulge in the historical glory of Linux running\non any (by now) irrelevant hardware on the planet, then I stop arguing\nright here.\n\nIf not, can we please have a serious discussion about going SMP only and\nmaking UP the simple and obvious NR_CPUS=1 subset?\n\nThe amount of subtle SMP=n fallout has been kinda exponentially\nincreasing over the years and it's just putting burden on the wrong\npeople. TBH, I'm tired of this nonsense.\n\nThanks,\n\n        tglx\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171055209228428.mbox",
          "message_id": "<CAHk-=wg50AGnzhmOK0TNqDN99T3dWd747h3y-ZFuv4bNZ4Q0tw () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linuxfoundation ! org",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-16 01:23:12+00:00",
          "date_str": "Sat, 16 Mar 2024 01:23:12 +0000",
          "body": "On Fri, 15 Mar 2024 at 18:11, Thomas Gleixner <tglx@linutronix.de> wrote:\n>\n> You wish. We still support 486 and some of the still produced 486 clones\n> do not have a local APIC.\n\nOuch. I was _sure_ we had dropped i486 support too due to cmpxchg8b.\n\nBut apparently that was just a discussion, and my wishful thinking,\nand we never actually followed through.\n\n         Linus\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171055209228427.mbox",
          "message_id": "<CAHk-=wg50AGnzhmOK0TNqDN99T3dWd747h3y-ZFuv4bNZ4Q0tw () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linuxfoundation ! org",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-16 01:23:12+00:00",
          "date_str": "Sat, 16 Mar 2024 01:23:12 +0000",
          "body": "On Fri, 15 Mar 2024 at 18:11, Thomas Gleixner <tglx@linutronix.de> wrote:\n>\n> You wish. We still support 486 and some of the still produced 486 clones\n> do not have a local APIC.\n\nOuch. I was _sure_ we had dropped i486 support too due to cmpxchg8b.\n\nBut apparently that was just a discussion, and my wishful thinking,\nand we never actually followed through.\n\n         Linus\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171062490627797.mbox",
          "message_id": "<dd494544-6dbf-4e83-8060-1f8b7b07a8c4 () app ! fastmail ! com>",
          "author_name": "Arnd Bergmann",
          "author_email": "arnd () kernel ! org",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-16 21:34:55+00:00",
          "date_str": "Sat, 16 Mar 2024 21:34:55 +0000",
          "body": "On Sat, Mar 16, 2024, at 02:23, Linus Torvalds wrote:\n> On Fri, 15 Mar 2024 at 18:11, Thomas Gleixner <tglx@linutronix.de> wrote:\n>>\n>> You wish. We still support 486 and some of the still produced 486 clones\n>> do not have a local APIC.\n>\n> Ouch. I was _sure_ we had dropped i486 support too due to cmpxchg8b.\n>\n> But apparently that was just a discussion, and my wishful thinking,\n> and we never actually followed through.\n\nMaciej Rozycki still cares about i486 type hardware, and he was\nasking for it to be kept around in the thread following [1]\n\nI think the best suggestion at the time was to make cmpxchg8b\na compile-time feature and I had expected Maciej to follow up with\na patch for that, but this never happend, and nobody sent a patch\nto remove support 486 and the early 586 clones either.\n\nI saw recently that there are still distros that advertise 486\nsupport on modern kernels: Tiny Core Linux and Damn Small\nLinux. Both ship with a 486 SMP kernel but fail to boot\non qemu unless an APIC is enabled (DSL also requires i686 or\nhigher to run userspace).\n\n       Arnd\n\n[1] https://lore.kernel.org/all/20220815071332.627393-9-yuzhao@google.com/\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171062490327793.mbox",
          "message_id": "<dd494544-6dbf-4e83-8060-1f8b7b07a8c4 () app ! fastmail ! com>",
          "author_name": "Arnd Bergmann",
          "author_email": "arnd () kernel ! org",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-16 21:34:55+00:00",
          "date_str": "Sat, 16 Mar 2024 21:34:55 +0000",
          "body": "On Sat, Mar 16, 2024, at 02:23, Linus Torvalds wrote:\n> On Fri, 15 Mar 2024 at 18:11, Thomas Gleixner <tglx@linutronix.de> wrote:\n>>\n>> You wish. We still support 486 and some of the still produced 486 clones\n>> do not have a local APIC.\n>\n> Ouch. I was _sure_ we had dropped i486 support too due to cmpxchg8b.\n>\n> But apparently that was just a discussion, and my wishful thinking,\n> and we never actually followed through.\n\nMaciej Rozycki still cares about i486 type hardware, and he was\nasking for it to be kept around in the thread following [1]\n\nI think the best suggestion at the time was to make cmpxchg8b\na compile-time feature and I had expected Maciej to follow up with\na patch for that, but this never happend, and nobody sent a patch\nto remove support 486 and the early 586 clones either.\n\nI saw recently that there are still distros that advertise 486\nsupport on modern kernels: Tiny Core Linux and Damn Small\nLinux. Both ship with a 486 SMP kernel but fail to boot\non qemu unless an APIC is enabled (DSL also requires i686 or\nhigher to run userspace).\n\n       Arnd\n\n[1] https://lore.kernel.org/all/20220815071332.627393-9-yuzhao@google.com/\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171070929823843.mbox",
          "message_id": "<285eeccc46bb4d5bb471071964ddce48 () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-17 21:03:16+00:00",
          "date_str": "Sun, 17 Mar 2024 21:03:16 +0000",
          "body": "From: Thomas Gleixner\n> Sent: 16 March 2024 01:11\n..\n> We want SMP as a general concept and overhaul the whole kernel to get\n> rid of this ever increasing non-sensical UP burden. The real world UP\n> small system use cases have moved over to other OSes like Zephyr & Co\n> long ago.\n>=20\n> Just because some esoteric architectures (m68k comes to my mind) will\n> have serious issues with that for the very wrong reasons does not mean\n> that we should not go there.\n>=20\n> It's going to be quite some effort, but the overall benefit is worth it.\n>=20\n> OTOH, it's absolutely not rocket science to pretend to be SMP capable\n> and if some architectures fail to accomodate on the way then we just\n> should remove them as that's a clear sign of being unmaintained and\n> irrelevant.\n\nThere are fpga soft-cpu (eg Nios & Risc-V) that can run linux.\nThey are definitely memory constrained and really wouldn't want\nmost of the SMP overhead.\n\nI'm not what it involves apart from simplified startup, compiling\nout IPI and spinlocks and optimising per-cpu data.\nBut you wouldn't want to be running an SMP capable kernel on such systems.\nx86 is a different beast - except perhaps 486.\n\nIt has to be said that I've never understood why anyone would run\nLinux on a Nios-II cpu. Far too slow for anything useful (you might\nget 100MHz if you are lucky), caches will be small and external memory\naccesses slow.\nI doubt soft RISC-V are any better (and I suspect they are worse).\nWe do have 4 Nios-II in the fpga image for a PCIe card.\nThey run very small programs (one has 2kB of code memory) to do things\nthat would be impossible to write (sensibly) in VHDL.\nThere are fpga with embedded ARM (and probably RISC-V) cores for\nrunning real OS.\n\n=09David\n\n-\nRegistered Address Lakeside, Bramley Road, Mount Farm, Milton Keynes, MK1 1=\nPT, UK\nRegistration No: 1397386 (Wales)\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171070929523840.mbox",
          "message_id": "<285eeccc46bb4d5bb471071964ddce48 () AcuMS ! aculab ! com>",
          "author_name": "David Laight",
          "author_email": "David.Laight () ACULAB ! COM",
          "subject": "RE: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-17 21:03:16+00:00",
          "date_str": "Sun, 17 Mar 2024 21:03:16 +0000",
          "body": "From: Thomas Gleixner\n> Sent: 16 March 2024 01:11\n...\n> We want SMP as a general concept and overhaul the whole kernel to get\n> rid of this ever increasing non-sensical UP burden. The real world UP\n> small system use cases have moved over to other OSes like Zephyr & Co\n> long ago.\n>=20\n> Just because some esoteric architectures (m68k comes to my mind) will\n> have serious issues with that for the very wrong reasons does not mean\n> that we should not go there.\n>=20\n> It's going to be quite some effort, but the overall benefit is worth it.\n>=20\n> OTOH, it's absolutely not rocket science to pretend to be SMP capable\n> and if some architectures fail to accomodate on the way then we just\n> should remove them as that's a clear sign of being unmaintained and\n> irrelevant.\n\nThere are fpga soft-cpu (eg Nios & Risc-V) that can run linux.\nThey are definitely memory constrained and really wouldn't want\nmost of the SMP overhead.\n\nI'm not what it involves apart from simplified startup, compiling\nout IPI and spinlocks and optimising per-cpu data.\nBut you wouldn't want to be running an SMP capable kernel on such systems.\nx86 is a different beast - except perhaps 486.\n\nIt has to be said that I've never understood why anyone would run\nLinux on a Nios-II cpu. Far too slow for anything useful (you might\nget 100MHz if you are lucky), caches will be small and external memory\naccesses slow.\nI doubt soft RISC-V are any better (and I suspect they are worse).\nWe do have 4 Nios-II in the fpga image for a PCIe card.\nThey run very small programs (one has 2kB of code memory) to do things\nthat would be impossible to write (sensibly) in VHDL.\nThere are fpga with embedded ARM (and probably RISC-V) cores for\nrunning real OS.\n\n=09David\n\n-\nRegistered Address Lakeside, Bramley Road, Mount Farm, Milton Keynes, MK1 1=\nPT, UK\nRegistration No: 1397386 (Wales)\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171076019015267.mbox",
          "message_id": "<87zfuviyl0.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-18 11:11:39+00:00",
          "date_str": "Mon, 18 Mar 2024 11:11:39 +0000",
          "body": "On Sat, Mar 16 2024 at 02:11, Thomas Gleixner wrote:\n> On Fri, Mar 15 2024 at 16:23, Linus Torvalds wrote:\n>> Either we should just make all machines look like they have the proper\n>> local apic mappings, or we shouldn't look at any local apic rules AT\n>> ALL.\n>\n> Sure. I can simply check if there was an APIC registered instead.\n\nLike the below. I'm not entirely sure though whether the sanity checks\nshould return an error code, which is what caused the crash Guenter\nobserved, but I couldn't come up with something sensible either.\n\nReturning 0 might keep the machine alive, but does it make sense?\n\nThanks,\n\n        tglx\n---\n arch/x86/kernel/cpu/topology.c |   15 +++++++++++++--\n 1 file changed, 13 insertions(+), 2 deletions(-)\n\n--- a/arch/x86/kernel/cpu/topology.c\n+++ b/arch/x86/kernel/cpu/topology.c\n@@ -277,10 +277,21 @@ int topology_get_logical_id(u32 apicid,\n \t/* Remove the bits below @at_level to get the proper level ID of @apicid */\n \tunsigned int lvlid = topo_apicid(apicid, at_level);\n \n-\tif (lvlid >= MAX_LOCAL_APIC)\n+\tif (WARN_ON_ONCE(lvlid >= MAX_LOCAL_APIC))\n \t\treturn -ERANGE;\n-\tif (!test_bit(lvlid, apic_maps[at_level].map))\n+\n+\t/*\n+\t * If there was no APIC registered, then the map check below would\n+\t * fail. With no APIC this is guaranteed to be an UP system and\n+\t * therefore all topology levels have only one entry and their\n+\t * logical ID is obviously 0.\n+\t */\n+\tif (topo_info.boot_cpu_apic_id == BAD_APICID)\n+\t\treturn 0;\n+\n+\tif (WARN_ON_ONCE(!test_bit(lvlid, apic_maps[at_level].map)))\n \t\treturn -ENODEV;\n+\n \t/* Get the number of set bits before @lvlid. */\n \treturn bitmap_weight(apic_maps[at_level].map, lvlid);\n }\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171076019015268.mbox",
          "message_id": "<87zfuviyl0.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-18 11:11:39+00:00",
          "date_str": "Mon, 18 Mar 2024 11:11:39 +0000",
          "body": "On Sat, Mar 16 2024 at 02:11, Thomas Gleixner wrote:\n> On Fri, Mar 15 2024 at 16:23, Linus Torvalds wrote:\n>> Either we should just make all machines look like they have the proper\n>> local apic mappings, or we shouldn't look at any local apic rules AT\n>> ALL.\n>\n> Sure. I can simply check if there was an APIC registered instead.\n\nLike the below. I'm not entirely sure though whether the sanity checks\nshould return an error code, which is what caused the crash Guenter\nobserved, but I couldn't come up with something sensible either.\n\nReturning 0 might keep the machine alive, but does it make sense?\n\nThanks,\n\n        tglx\n---\n arch/x86/kernel/cpu/topology.c |   15 +++++++++++++--\n 1 file changed, 13 insertions(+), 2 deletions(-)\n\n--- a/arch/x86/kernel/cpu/topology.c\n+++ b/arch/x86/kernel/cpu/topology.c\n@@ -277,10 +277,21 @@ int topology_get_logical_id(u32 apicid,\n \t/* Remove the bits below @at_level to get the proper level ID of @apicid */\n \tunsigned int lvlid = topo_apicid(apicid, at_level);\n \n-\tif (lvlid >= MAX_LOCAL_APIC)\n+\tif (WARN_ON_ONCE(lvlid >= MAX_LOCAL_APIC))\n \t\treturn -ERANGE;\n-\tif (!test_bit(lvlid, apic_maps[at_level].map))\n+\n+\t/*\n+\t * If there was no APIC registered, then the map check below would\n+\t * fail. With no APIC this is guaranteed to be an UP system and\n+\t * therefore all topology levels have only one entry and their\n+\t * logical ID is obviously 0.\n+\t */\n+\tif (topo_info.boot_cpu_apic_id == BAD_APICID)\n+\t\treturn 0;\n+\n+\tif (WARN_ON_ONCE(!test_bit(lvlid, apic_maps[at_level].map)))\n \t\treturn -ENODEV;\n+\n \t/* Get the number of set bits before @lvlid. */\n \treturn bitmap_weight(apic_maps[at_level].map, lvlid);\n }\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171078275231537.mbox",
          "message_id": "<87le6fih5w.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-18 17:27:55+00:00",
          "date_str": "Mon, 18 Mar 2024 17:27:55 +0000",
          "body": "On Sat, Mar 16 2024 at 02:11, Thomas Gleixner wrote:\n> On Fri, Mar 15 2024 at 16:23, Linus Torvalds wrote:\n> The amount of subtle SMP=n fallout has been kinda exponentially\n> increasing over the years and it's just putting burden on the wrong\n> people. TBH, I'm tired of this nonsense.\n\nAnd for the fun of it I hacked Kconfig to allow a SMP=y NR_CPUS=1 build\nand checked the size of vmlinux:\n\n                64-bit          32-bit\nSMP, NCPUS=1    38438400        22110177\nUP              38393703        21682041\nDelta              44697          428076\n                     0.1%              2%              \n\nThe UP savings are not really impressive...\n\nLet me look what it actually takes to do that.\n\nThanks,\n\n        tglx\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171078911803843.mbox",
          "message_id": "<28ceb124-b634-44e0-bcd4-848fc3b0be7a () app ! fastmail ! com>",
          "author_name": "Arnd Bergmann",
          "author_email": "arnd () kernel ! org",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-18 19:13:05+00:00",
          "date_str": "Mon, 18 Mar 2024 19:13:05 +0000",
          "body": "On Mon, Mar 18, 2024, at 18:27, Thomas Gleixner wrote:\n> On Sat, Mar 16 2024 at 02:11, Thomas Gleixner wrote:\n>> On Fri, Mar 15 2024 at 16:23, Linus Torvalds wrote:\n>> The amount of subtle SMP=n fallout has been kinda exponentially\n>> increasing over the years and it's just putting burden on the wrong\n>> people. TBH, I'm tired of this nonsense.\n>\n> And for the fun of it I hacked Kconfig to allow a SMP=y NR_CPUS=1 build\n> and checked the size of vmlinux:\n>\n>                 64-bit          32-bit\n> SMP, NCPUS=1    38438400        22110177\n> UP              38393703        21682041\n> Delta              44697          428076\n>                      0.1%              2%              \n>\n> The UP savings are not really impressive...\n>\n> Let me look what it actually takes to do that.\n\nFWIW, I did some experiments a few weeks ago on 32-bit ARM,\nusing a fairly minimal kernel in a virtual machine, and\nchecking the runtime memory consumption rather than compile-time.\nIn a kvm guest with 32MiB RAM, I saw a difference of multiple\nmegabytes in memory usage:\n\nLinux testvm 6.8.0-rc4-00410-gc02197fc9076-dirty #1 SMP PREEMPT armv7l\nroot@testvm:~# free\n           \ttotal   used    free  \tshared  buff/cache   available\nMem:       \t26932   14956   1732   \t    52       12800   \t11976\nSwap:      \t16360    3632   12728\n\nLinux testvm 6.8.0-rc4-00410-gc02197fc9076-dirty #2 PREEMPT armv7l\nroot@testvm:~# free\n           \ttotal    used  \tfree  \tshared  buff/cache   available\nMem:       \t26932   13744  \t5648        32       10092   \t13188\nSwap:      \t16360    3880  \t12480\n\nThere is a little difference between runs, but this does seem\nsignificant enough to keep it. The SMP build was with\nCONFIG_NR_CPUS=2 (the smallest supported compile-time number),\nbut running on a single-CPU qemu instance.\n\n      Arnd\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171078912003844.mbox",
          "message_id": "<28ceb124-b634-44e0-bcd4-848fc3b0be7a () app ! fastmail ! com>",
          "author_name": "Arnd Bergmann",
          "author_email": "arnd () kernel ! org",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-18 19:13:05+00:00",
          "date_str": "Mon, 18 Mar 2024 19:13:05 +0000",
          "body": "On Mon, Mar 18, 2024, at 18:27, Thomas Gleixner wrote:\n> On Sat, Mar 16 2024 at 02:11, Thomas Gleixner wrote:\n>> On Fri, Mar 15 2024 at 16:23, Linus Torvalds wrote:\n>> The amount of subtle SMP=n fallout has been kinda exponentially\n>> increasing over the years and it's just putting burden on the wrong\n>> people. TBH, I'm tired of this nonsense.\n>\n> And for the fun of it I hacked Kconfig to allow a SMP=y NR_CPUS=1 build\n> and checked the size of vmlinux:\n>\n>                 64-bit          32-bit\n> SMP, NCPUS=1    38438400        22110177\n> UP              38393703        21682041\n> Delta              44697          428076\n>                      0.1%              2%              \n>\n> The UP savings are not really impressive...\n>\n> Let me look what it actually takes to do that.\n\nFWIW, I did some experiments a few weeks ago on 32-bit ARM,\nusing a fairly minimal kernel in a virtual machine, and\nchecking the runtime memory consumption rather than compile-time.\nIn a kvm guest with 32MiB RAM, I saw a difference of multiple\nmegabytes in memory usage:\n\nLinux testvm 6.8.0-rc4-00410-gc02197fc9076-dirty #1 SMP PREEMPT armv7l\nroot@testvm:~# free\n           \ttotal   used    free  \tshared  buff/cache   available\nMem:       \t26932   14956   1732   \t    52       12800   \t11976\nSwap:      \t16360    3632   12728\n\nLinux testvm 6.8.0-rc4-00410-gc02197fc9076-dirty #2 PREEMPT armv7l\nroot@testvm:~# free\n           \ttotal    used  \tfree  \tshared  buff/cache   available\nMem:       \t26932   13744  \t5648        32       10092   \t13188\nSwap:      \t16360    3880  \t12480\n\nThere is a little difference between runs, but this does seem\nsignificant enough to keep it. The SMP build was with\nCONFIG_NR_CPUS=2 (the smallest supported compile-time number),\nbut running on a single-CPU qemu instance.\n\n      Arnd\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171086549620352.mbox",
          "message_id": "<87edc6i45s.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-19 16:21:03+00:00",
          "date_str": "Tue, 19 Mar 2024 16:21:03 +0000",
          "body": "On Mon, Mar 18 2024 at 20:13, Arnd Bergmann wrote:\n> FWIW, I did some experiments a few weeks ago on 32-bit ARM,\n> using a fairly minimal kernel in a virtual machine, and\n> checking the runtime memory consumption rather than compile-time.\n> In a kvm guest with 32MiB RAM, I saw a difference of multiple\n> megabytes in memory usage:\n>\n> Linux testvm 6.8.0-rc4-00410-gc02197fc9076-dirty #1 SMP PREEMPT armv7l\n> root@testvm:~# free\n>            \ttotal   used    free  \tshared  buff/cache   available\n> Mem:       \t26932   14956   1732   \t    52       12800   \t11976\n> Swap:      \t16360    3632   12728\n>\n> Linux testvm 6.8.0-rc4-00410-gc02197fc9076-dirty #2 PREEMPT armv7l\n> root@testvm:~# free\n>            \ttotal    used  \tfree  \tshared  buff/cache   available\n> Mem:       \t26932   13744  \t5648        32       10092   \t13188\n> Swap:      \t16360    3880  \t12480\n>\n> There is a little difference between runs, but this does seem\n> significant enough to keep it. The SMP build was with\n> CONFIG_NR_CPUS=2 (the smallest supported compile-time number),\n> but running on a single-CPU qemu instance.\n\nWith a SMP=y, NR_CPUS=1 build on x86 64bit I get:\n\n               total        used        free      shared  buff/cache   available\nMem:        32882056      498068    32590580        4884      128884    32383988\nSwap:         998396           0      998396\n\nSame config just SMP=n:\n\n               total        used        free      shared  buff/cache   available\nMem:        32885804      461704    32635284        4876      119480    32424100\nSwap:         998396           0      998396\n\nSo the delta for available is ~40 MiB.\n\nBut if I look at it with init=/bin/sh on the command line then the delta\nis significantly different:\n\nWith a SMP=y, NR_CPUS=1 build on x86 64bit I get:\n\n               total        used        free      shared  buff/cache   available\nMem:        32883680      324120    32822728         216       10864    32559560\nSwap:              0           0           0\n\nSame config just SMP=n:\n\n               total        used        free      shared  buff/cache   available\nMem:        32885804      326876    32821972         216       11100    32558928\nSwap:              0           0           0\n\nDelta available = 632 KiB\n\nI haven't had the time to stare at that in detail, but comparing\n/proc/meminfo for the full boot case above does not immediately give me\na hint. It's confusing at best...\n\nThanks,\n\n        tglx\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171086549720353.mbox",
          "message_id": "<87edc6i45s.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-19 16:21:03+00:00",
          "date_str": "Tue, 19 Mar 2024 16:21:03 +0000",
          "body": "On Mon, Mar 18 2024 at 20:13, Arnd Bergmann wrote:\n> FWIW, I did some experiments a few weeks ago on 32-bit ARM,\n> using a fairly minimal kernel in a virtual machine, and\n> checking the runtime memory consumption rather than compile-time.\n> In a kvm guest with 32MiB RAM, I saw a difference of multiple\n> megabytes in memory usage:\n>\n> Linux testvm 6.8.0-rc4-00410-gc02197fc9076-dirty #1 SMP PREEMPT armv7l\n> root@testvm:~# free\n>            \ttotal   used    free  \tshared  buff/cache   available\n> Mem:       \t26932   14956   1732   \t    52       12800   \t11976\n> Swap:      \t16360    3632   12728\n>\n> Linux testvm 6.8.0-rc4-00410-gc02197fc9076-dirty #2 PREEMPT armv7l\n> root@testvm:~# free\n>            \ttotal    used  \tfree  \tshared  buff/cache   available\n> Mem:       \t26932   13744  \t5648        32       10092   \t13188\n> Swap:      \t16360    3880  \t12480\n>\n> There is a little difference between runs, but this does seem\n> significant enough to keep it. The SMP build was with\n> CONFIG_NR_CPUS=2 (the smallest supported compile-time number),\n> but running on a single-CPU qemu instance.\n\nWith a SMP=y, NR_CPUS=1 build on x86 64bit I get:\n\n               total        used        free      shared  buff/cache   available\nMem:        32882056      498068    32590580        4884      128884    32383988\nSwap:         998396           0      998396\n\nSame config just SMP=n:\n\n               total        used        free      shared  buff/cache   available\nMem:        32885804      461704    32635284        4876      119480    32424100\nSwap:         998396           0      998396\n\nSo the delta for available is ~40 MiB.\n\nBut if I look at it with init=/bin/sh on the command line then the delta\nis significantly different:\n\nWith a SMP=y, NR_CPUS=1 build on x86 64bit I get:\n\n               total        used        free      shared  buff/cache   available\nMem:        32883680      324120    32822728         216       10864    32559560\nSwap:              0           0           0\n\nSame config just SMP=n:\n\n               total        used        free      shared  buff/cache   available\nMem:        32885804      326876    32821972         216       11100    32558928\nSwap:              0           0           0\n\nDelta available = 632 KiB\n\nI haven't had the time to stare at that in detail, but comparing\n/proc/meminfo for the full boot case above does not immediately give me\na hint. It's confusing at best...\n\nThanks,\n\n        tglx\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171087267326048.mbox",
          "message_id": "<02180516-6d4c-4446-b12b-8451cb4adebc () roeck-us ! net>",
          "author_name": "Guenter Roeck",
          "author_email": "linux () roeck-us ! net",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-19 18:26:16+00:00",
          "date_str": "Tue, 19 Mar 2024 18:26:16 +0000",
          "body": "On 3/19/24 09:21, Thomas Gleixner wrote:\n> On Mon, Mar 18 2024 at 20:13, Arnd Bergmann wrote:\n>> FWIW, I did some experiments a few weeks ago on 32-bit ARM,\n>> using a fairly minimal kernel in a virtual machine, and\n>> checking the runtime memory consumption rather than compile-time.\n>> In a kvm guest with 32MiB RAM, I saw a difference of multiple\n>> megabytes in memory usage:\n>>\n>> Linux testvm 6.8.0-rc4-00410-gc02197fc9076-dirty #1 SMP PREEMPT armv7l\n>> root@testvm:~# free\n>>             \ttotal   used    free  \tshared  buff/cache   available\n>> Mem:       \t26932   14956   1732   \t    52       12800   \t11976\n>> Swap:      \t16360    3632   12728\n>>\n>> Linux testvm 6.8.0-rc4-00410-gc02197fc9076-dirty #2 PREEMPT armv7l\n>> root@testvm:~# free\n>>             \ttotal    used  \tfree  \tshared  buff/cache   available\n>> Mem:       \t26932   13744  \t5648        32       10092   \t13188\n>> Swap:      \t16360    3880  \t12480\n>>\n>> There is a little difference between runs, but this does seem\n>> significant enough to keep it. The SMP build was with\n>> CONFIG_NR_CPUS=2 (the smallest supported compile-time number),\n>> but running on a single-CPU qemu instance.\n> \n> With a SMP=y, NR_CPUS=1 build on x86 64bit I get:\n> \n>                 total        used        free      shared  buff/cache   available\n> Mem:        32882056      498068    32590580        4884      128884    32383988\n> Swap:         998396           0      998396\n> \n> Same config just SMP=n:\n> \n>                 total        used        free      shared  buff/cache   available\n> Mem:        32885804      461704    32635284        4876      119480    32424100\n> Swap:         998396           0      998396\n> \n> So the delta for available is ~40 MiB.\n> \n> But if I look at it with init=/bin/sh on the command line then the delta\n> is significantly different:\n> \n> With a SMP=y, NR_CPUS=1 build on x86 64bit I get:\n> \n>                 total        used        free      shared  buff/cache   available\n> Mem:        32883680      324120    32822728         216       10864    32559560\n> Swap:              0           0           0\n> \n> Same config just SMP=n:\n> \n>                 total        used        free      shared  buff/cache   available\n> Mem:        32885804      326876    32821972         216       11100    32558928\n> Swap:              0           0           0\n> \n> Delta available = 632 KiB\n> \n> I haven't had the time to stare at that in detail, but comparing\n> /proc/meminfo for the full boot case above does not immediately give me\n> a hint. It's confusing at best...\n>\n\nThat makes me wonder if the number is affected by the total memory size.\nHow about a system with 1GB of memory or less ?\n\nGuenter\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171087266726043.mbox",
          "message_id": "<02180516-6d4c-4446-b12b-8451cb4adebc () roeck-us ! net>",
          "author_name": "Guenter Roeck",
          "author_email": "linux () roeck-us ! net",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-19 18:26:16+00:00",
          "date_str": "Tue, 19 Mar 2024 18:26:16 +0000",
          "body": "On 3/19/24 09:21, Thomas Gleixner wrote:\n> On Mon, Mar 18 2024 at 20:13, Arnd Bergmann wrote:\n>> FWIW, I did some experiments a few weeks ago on 32-bit ARM,\n>> using a fairly minimal kernel in a virtual machine, and\n>> checking the runtime memory consumption rather than compile-time.\n>> In a kvm guest with 32MiB RAM, I saw a difference of multiple\n>> megabytes in memory usage:\n>>\n>> Linux testvm 6.8.0-rc4-00410-gc02197fc9076-dirty #1 SMP PREEMPT armv7l\n>> root@testvm:~# free\n>>             \ttotal   used    free  \tshared  buff/cache   available\n>> Mem:       \t26932   14956   1732   \t    52       12800   \t11976\n>> Swap:      \t16360    3632   12728\n>>\n>> Linux testvm 6.8.0-rc4-00410-gc02197fc9076-dirty #2 PREEMPT armv7l\n>> root@testvm:~# free\n>>             \ttotal    used  \tfree  \tshared  buff/cache   available\n>> Mem:       \t26932   13744  \t5648        32       10092   \t13188\n>> Swap:      \t16360    3880  \t12480\n>>\n>> There is a little difference between runs, but this does seem\n>> significant enough to keep it. The SMP build was with\n>> CONFIG_NR_CPUS=2 (the smallest supported compile-time number),\n>> but running on a single-CPU qemu instance.\n> \n> With a SMP=y, NR_CPUS=1 build on x86 64bit I get:\n> \n>                 total        used        free      shared  buff/cache   available\n> Mem:        32882056      498068    32590580        4884      128884    32383988\n> Swap:         998396           0      998396\n> \n> Same config just SMP=n:\n> \n>                 total        used        free      shared  buff/cache   available\n> Mem:        32885804      461704    32635284        4876      119480    32424100\n> Swap:         998396           0      998396\n> \n> So the delta for available is ~40 MiB.\n> \n> But if I look at it with init=/bin/sh on the command line then the delta\n> is significantly different:\n> \n> With a SMP=y, NR_CPUS=1 build on x86 64bit I get:\n> \n>                 total        used        free      shared  buff/cache   available\n> Mem:        32883680      324120    32822728         216       10864    32559560\n> Swap:              0           0           0\n> \n> Same config just SMP=n:\n> \n>                 total        used        free      shared  buff/cache   available\n> Mem:        32885804      326876    32821972         216       11100    32558928\n> Swap:              0           0           0\n> \n> Delta available = 632 KiB\n> \n> I haven't had the time to stare at that in detail, but comparing\n> /proc/meminfo for the full boot case above does not immediately give me\n> a hint. It's confusing at best...\n>\n\nThat makes me wonder if the number is affected by the total memory size.\nHow about a system with 1GB of memory or less ?\n\nGuenter\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171092538522307.mbox",
          "message_id": "<87bk79i8km.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-20 08:58:01+00:00",
          "date_str": "Wed, 20 Mar 2024 08:58:01 +0000",
          "body": "On Fri, Mar 15 2024 at 09:17, Guenter Roeck wrote:\n> I don't know the code well enough to determine what is wrong.\n> Please let me know what I can do to help debugging the problem.\n\nCould you provide me the config and the qemu command line?\n\nThanks,\n\n        tglx\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171094945206689.mbox",
          "message_id": "<d51ec9a1-5221-4005-9980-8258df8b5102 () roeck-us ! net>",
          "author_name": "Guenter Roeck",
          "author_email": "linux () roeck-us ! net",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-20 15:46:20+00:00",
          "date_str": "Wed, 20 Mar 2024 15:46:20 +0000",
          "body": "On 3/20/24 01:58, Thomas Gleixner wrote:\n> On Fri, Mar 15 2024 at 09:17, Guenter Roeck wrote:\n>> I don't know the code well enough to determine what is wrong.\n>> Please let me know what I can do to help debugging the problem.\n> \n> Could you provide me the config and the qemu command line?\n> \n\ndefconfig-CONFIG_SMP and\n\nqemu-system-x86_64 -kernel arch/x86/boot/bzImage -cpu Haswell \\\n      --append \"console=ttyS0\" -nographic -monitor none\n\nThe cpu doesn't really matter as long as it is an Intel CPU.\nA root file system isn't needed since the boot doesn't get that far.\n\nGuenter\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171094945606695.mbox",
          "message_id": "<d51ec9a1-5221-4005-9980-8258df8b5102 () roeck-us ! net>",
          "author_name": "Guenter Roeck",
          "author_email": "linux () roeck-us ! net",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-20 15:46:20+00:00",
          "date_str": "Wed, 20 Mar 2024 15:46:20 +0000",
          "body": "On 3/20/24 01:58, Thomas Gleixner wrote:\n> On Fri, Mar 15 2024 at 09:17, Guenter Roeck wrote:\n>> I don't know the code well enough to determine what is wrong.\n>> Please let me know what I can do to help debugging the problem.\n> \n> Could you provide me the config and the qemu command line?\n> \n\ndefconfig-CONFIG_SMP and\n\nqemu-system-x86_64 -kernel arch/x86/boot/bzImage -cpu Haswell \\\n      --append \"console=ttyS0\" -nographic -monitor none\n\nThe cpu doesn't really matter as long as it is an Intel CPU.\nA root file system isn't needed since the boot doesn't get that far.\n\nGuenter\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171101959815793.mbox",
          "message_id": "<87r0g3hm5o.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-21 11:14:27+00:00",
          "date_str": "Thu, 21 Mar 2024 11:14:27 +0000",
          "body": "On Wed, Mar 20 2024 at 08:46, Guenter Roeck wrote:\n> On 3/20/24 01:58, Thomas Gleixner wrote:\n>> On Fri, Mar 15 2024 at 09:17, Guenter Roeck wrote:\n>>> I don't know the code well enough to determine what is wrong.\n>>> Please let me know what I can do to help debugging the problem.\n>> \n>> Could you provide me the config and the qemu command line?\n>> \n>\n> defconfig-CONFIG_SMP and\n>\n> qemu-system-x86_64 -kernel arch/x86/boot/bzImage -cpu Haswell \\\n>       --append \"console=ttyS0\" -nographic -monitor none\n>\n> The cpu doesn't really matter as long as it is an Intel CPU.\n> A root file system isn't needed since the boot doesn't get that far.\n\nNow it get's interesting because I can't reproduce it with that setup at\nall.\n\nWhat's weird is that I saw it exactly once on 64-bit in a VM with a UP\nconfig two days ago, but when I started to add instrumentation it never\ncame back even after backing the instrumentation changes out. I have\nseriously no idea what's going on there.\n\nIs it fully reproducible on your side?\n\nIf so can you please provide a full dmesg and then apply the patch below\nand provide the resulting full dmesg too?\n\nI found two other issues while trying to find a way to reproduce, but\nthose are completely unrelated to the problem you are observing.\n\nThanks,\n\n        tglx\n---\n arch/x86/kernel/cpu/topology.c |   19 +++++++++++++++++--\n 1 file changed, 17 insertions(+), 2 deletions(-)\n\n--- a/arch/x86/kernel/cpu/topology.c\n+++ b/arch/x86/kernel/cpu/topology.c\n@@ -176,6 +176,8 @@ static __init void topo_register_apic(u3\n {\n \tint cpu, dom;\n \n+\tpr_info(\"APIC: %x %d\\n\", apic_id, present);\n+\n \tif (present) {\n \t\tset_bit(apic_id, phys_cpu_present_map);\n \n@@ -277,10 +279,23 @@ int topology_get_logical_id(u32 apicid,\n \t/* Remove the bits below @at_level to get the proper level ID of @apicid */\n \tunsigned int lvlid = topo_apicid(apicid, at_level);\n \n-\tif (lvlid >= MAX_LOCAL_APIC)\n+\tpr_info(\"APIC logical ID: %x %x %d\\n\", apicid, lvlid, at_level);\n+\n+\tif (WARN_ON_ONCE(lvlid >= MAX_LOCAL_APIC))\n \t\treturn -ERANGE;\n-\tif (!test_bit(lvlid, apic_maps[at_level].map))\n+\n+\t/*\n+\t * If there was no APIC registered, then the map check below would\n+\t * fail. With no APIC this is guaranteed to be an UP system and\n+\t * therefore all topology levels have only one entry and their\n+\t * logical ID is obviously 0.\n+\t */\n+\tif (topo_info.boot_cpu_apic_id == BAD_APICID)\n+\t\treturn 0;\n+\n+\tif (WARN_ON_ONCE(!test_bit(lvlid, apic_maps[at_level].map)))\n \t\treturn -ENODEV;\n+\n \t/* Get the number of set bits before @lvlid. */\n \treturn bitmap_weight(apic_maps[at_level].map, lvlid);\n }\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171101960315802.mbox",
          "message_id": "<87r0g3hm5o.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-21 11:14:27+00:00",
          "date_str": "Thu, 21 Mar 2024 11:14:27 +0000",
          "body": "On Wed, Mar 20 2024 at 08:46, Guenter Roeck wrote:\n> On 3/20/24 01:58, Thomas Gleixner wrote:\n>> On Fri, Mar 15 2024 at 09:17, Guenter Roeck wrote:\n>>> I don't know the code well enough to determine what is wrong.\n>>> Please let me know what I can do to help debugging the problem.\n>> \n>> Could you provide me the config and the qemu command line?\n>> \n>\n> defconfig-CONFIG_SMP and\n>\n> qemu-system-x86_64 -kernel arch/x86/boot/bzImage -cpu Haswell \\\n>       --append \"console=ttyS0\" -nographic -monitor none\n>\n> The cpu doesn't really matter as long as it is an Intel CPU.\n> A root file system isn't needed since the boot doesn't get that far.\n\nNow it get's interesting because I can't reproduce it with that setup at\nall.\n\nWhat's weird is that I saw it exactly once on 64-bit in a VM with a UP\nconfig two days ago, but when I started to add instrumentation it never\ncame back even after backing the instrumentation changes out. I have\nseriously no idea what's going on there.\n\nIs it fully reproducible on your side?\n\nIf so can you please provide a full dmesg and then apply the patch below\nand provide the resulting full dmesg too?\n\nI found two other issues while trying to find a way to reproduce, but\nthose are completely unrelated to the problem you are observing.\n\nThanks,\n\n        tglx\n---\n arch/x86/kernel/cpu/topology.c |   19 +++++++++++++++++--\n 1 file changed, 17 insertions(+), 2 deletions(-)\n\n--- a/arch/x86/kernel/cpu/topology.c\n+++ b/arch/x86/kernel/cpu/topology.c\n@@ -176,6 +176,8 @@ static __init void topo_register_apic(u3\n {\n \tint cpu, dom;\n \n+\tpr_info(\"APIC: %x %d\\n\", apic_id, present);\n+\n \tif (present) {\n \t\tset_bit(apic_id, phys_cpu_present_map);\n \n@@ -277,10 +279,23 @@ int topology_get_logical_id(u32 apicid,\n \t/* Remove the bits below @at_level to get the proper level ID of @apicid */\n \tunsigned int lvlid = topo_apicid(apicid, at_level);\n \n-\tif (lvlid >= MAX_LOCAL_APIC)\n+\tpr_info(\"APIC logical ID: %x %x %d\\n\", apicid, lvlid, at_level);\n+\n+\tif (WARN_ON_ONCE(lvlid >= MAX_LOCAL_APIC))\n \t\treturn -ERANGE;\n-\tif (!test_bit(lvlid, apic_maps[at_level].map))\n+\n+\t/*\n+\t * If there was no APIC registered, then the map check below would\n+\t * fail. With no APIC this is guaranteed to be an UP system and\n+\t * therefore all topology levels have only one entry and their\n+\t * logical ID is obviously 0.\n+\t */\n+\tif (topo_info.boot_cpu_apic_id == BAD_APICID)\n+\t\treturn 0;\n+\n+\tif (WARN_ON_ONCE(!test_bit(lvlid, apic_maps[at_level].map)))\n \t\treturn -ENODEV;\n+\n \t/* Get the number of set bits before @lvlid. */\n \treturn bitmap_weight(apic_maps[at_level].map, lvlid);\n }\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171102989022392.mbox",
          "message_id": "<86796005-f1d9-4c8c-80d8-f1f88ca220ba () roeck-us ! net>",
          "author_name": "Guenter Roeck",
          "author_email": "linux () roeck-us ! net",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-21 14:06:53+00:00",
          "date_str": "Thu, 21 Mar 2024 14:06:53 +0000",
          "body": "On 3/21/24 04:14, Thomas Gleixner wrote:\n> On Wed, Mar 20 2024 at 08:46, Guenter Roeck wrote:\n>> On 3/20/24 01:58, Thomas Gleixner wrote:\n>>> On Fri, Mar 15 2024 at 09:17, Guenter Roeck wrote:\n>>>> I don't know the code well enough to determine what is wrong.\n>>>> Please let me know what I can do to help debugging the problem.\n>>>\n>>> Could you provide me the config and the qemu command line?\n>>>\n>>\n>> defconfig-CONFIG_SMP and\n>>\n>> qemu-system-x86_64 -kernel arch/x86/boot/bzImage -cpu Haswell \\\n>>        --append \"console=ttyS0\" -nographic -monitor none\n>>\n>> The cpu doesn't really matter as long as it is an Intel CPU.\n>> A root file system isn't needed since the boot doesn't get that far.\n> \n> Now it get's interesting because I can't reproduce it with that setup at\n> all.\n> \n> What's weird is that I saw it exactly once on 64-bit in a VM with a UP\n> config two days ago, but when I started to add instrumentation it never\n> came back even after backing the instrumentation changes out. I have\n> seriously no idea what's going on there.\n> \n> Is it fully reproducible on your side?\n> \n\nYes, always.\n\n> If so can you please provide a full dmesg and then apply the patch below\n> and provide the resulting full dmesg too?\n> \n\nYou'll find everything at http://server.roeck-us.net/qemu/x86-nosmp/\n\nThe crash is gone after applying your patch. The difference is:\n\n+       /*\n+        * If there was no APIC registered, then the map check below would\n+        * fail. With no APIC this is guaranteed to be an UP system and\n+        * therefore all topology levels have only one entry and their\n+        * logical ID is obviously 0.\n+        */\n+       if (topo_info.boot_cpu_apic_id == BAD_APICID) {\n+               pr_info(\"#### topo_info.boot_cpu_apic_id == BAD_APICID\\n\");\n                 ^^^^ I added this\n+               return 0;\n+       }\n+\n\nI see the \"#### topo_info.boot_cpu_apic_id == BAD_APICID\" message\ntwice in the log. See patched.log at the page pointed to above.\n\nHope the helps,\nGuenter\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171102988322386.mbox",
          "message_id": "<86796005-f1d9-4c8c-80d8-f1f88ca220ba () roeck-us ! net>",
          "author_name": "Guenter Roeck",
          "author_email": "linux () roeck-us ! net",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-21 14:06:53+00:00",
          "date_str": "Thu, 21 Mar 2024 14:06:53 +0000",
          "body": "On 3/21/24 04:14, Thomas Gleixner wrote:\n> On Wed, Mar 20 2024 at 08:46, Guenter Roeck wrote:\n>> On 3/20/24 01:58, Thomas Gleixner wrote:\n>>> On Fri, Mar 15 2024 at 09:17, Guenter Roeck wrote:\n>>>> I don't know the code well enough to determine what is wrong.\n>>>> Please let me know what I can do to help debugging the problem.\n>>>\n>>> Could you provide me the config and the qemu command line?\n>>>\n>>\n>> defconfig-CONFIG_SMP and\n>>\n>> qemu-system-x86_64 -kernel arch/x86/boot/bzImage -cpu Haswell \\\n>>        --append \"console=ttyS0\" -nographic -monitor none\n>>\n>> The cpu doesn't really matter as long as it is an Intel CPU.\n>> A root file system isn't needed since the boot doesn't get that far.\n> \n> Now it get's interesting because I can't reproduce it with that setup at\n> all.\n> \n> What's weird is that I saw it exactly once on 64-bit in a VM with a UP\n> config two days ago, but when I started to add instrumentation it never\n> came back even after backing the instrumentation changes out. I have\n> seriously no idea what's going on there.\n> \n> Is it fully reproducible on your side?\n> \n\nYes, always.\n\n> If so can you please provide a full dmesg and then apply the patch below\n> and provide the resulting full dmesg too?\n> \n\nYou'll find everything at http://server.roeck-us.net/qemu/x86-nosmp/\n\nThe crash is gone after applying your patch. The difference is:\n\n+       /*\n+        * If there was no APIC registered, then the map check below would\n+        * fail. With no APIC this is guaranteed to be an UP system and\n+        * therefore all topology levels have only one entry and their\n+        * logical ID is obviously 0.\n+        */\n+       if (topo_info.boot_cpu_apic_id == BAD_APICID) {\n+               pr_info(\"#### topo_info.boot_cpu_apic_id == BAD_APICID\\n\");\n                 ^^^^ I added this\n+               return 0;\n+       }\n+\n\nI see the \"#### topo_info.boot_cpu_apic_id == BAD_APICID\" message\ntwice in the log. See patched.log at the page pointed to above.\n\nHope the helps,\nGuenter\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171104014431384.mbox",
          "message_id": "<87il1fh6n9.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: [patch 5/9] x86: Cure per CPU madness on UP",
          "date": "2024-03-21 16:49:30+00:00",
          "date_str": "Thu, 21 Mar 2024 16:49:30 +0000",
          "body": "On Thu, Mar 21 2024 at 07:06, Guenter Roeck wrote:\n> On 3/21/24 04:14, Thomas Gleixner wrote:\n>> If so can you please provide a full dmesg and then apply the patch below\n>> and provide the resulting full dmesg too?\n>\n> You'll find everything at http://server.roeck-us.net/qemu/x86-nosmp/\n\nThanks for providing this.\n\n> The crash is gone after applying your patch. The difference is:\n>\n> +       /*\n> +        * If there was no APIC registered, then the map check below would\n> +        * fail. With no APIC this is guaranteed to be an UP system and\n> +        * therefore all topology levels have only one entry and their\n> +        * logical ID is obviously 0.\n> +        */\n> +       if (topo_info.boot_cpu_apic_id == BAD_APICID) {\n> +               pr_info(\"#### topo_info.boot_cpu_apic_id == BAD_APICID\\n\");\n>                  ^^^^ I added this\n> +               return 0;\n> +       }\n> +\n>\n> I see the \"#### topo_info.boot_cpu_apic_id == BAD_APICID\" message\n> twice in the log. See patched.log at the page pointed to above.\n\nI can see why this is emitted. That happens on the initial CPUID\nevaluation of the boot CPU very early during boot.\n\n[    0.000000] Command line: console=ttyS0\n[    0.000000] CPU topo: APIC logical ID: 0 0 6\n[    0.000000] CPU topo: #### topo_info.boot_cpu_apic_id == BAD_APICID\n[    0.000000] CPU topo: APIC logical ID: 0 0 4\n[    0.000000] CPU topo: #### topo_info.boot_cpu_apic_id == BAD_APICID\n\nThe later full CPUID evaluation happens after the ACPI enumeration and\nway before the affected RAPL driver is initialized:\n\n[    0.088029] CPU topo: APIC logical ID: 0 0 6\n[    0.088084] CPU topo: APIC logical ID: 0 0 4\n\nThis invocation has the boot APIC registered as your extra print does\nnot show up.\n\n...\n\n[    0.585850] RAPL PMU: API unit is 2^-32 Joules, 0 fixed counters, 10737418240 ms ovfl timer\n\nSo even without that guard (which we need anyway for the non APIC case)\ntopology_logical_die_id() == cpu_data(cpu).topo.logical_die_id must have\nthe correct value in that RAPL initialization and CPU hotplug callback\ncode.\n\nBut our absolutely convoluted startup logic prevents that because:\n\n    identify_cpu_early()      operates on boot_cpu_data\n    smp_prepare_boot_cpu()    copies boot_cpu_data to per CPU cpu data\n    identify_boot_cpu()       operates on boot_cpu_data\n\nidentify_boot_cpu() is the one which gets the correct logical die info,\nbut that never gets copied over to the per CPU data instance on which\nthe RAPL code and everything else works on.\n\nI'll cook up a patch later.\n\nThanks for providing the info!\n\n       tglx\n\n",
          "year": "2024",
          "month": "03"
        }
      ],
      "primary_category": "general"
    },
    {
      "subject": "[patch 9/9] x86/callthunks: Use EXPORT_PER_CPU_SYMBOL_GPL() for per CPU variables",
      "normalized_subject": "[patch 9/9] x86/callthunks: Use EXPORT_PER_CPU_SYMBOL_GPL() for per CPU variables",
      "message_count": 1,
      "participants": [
        "Thomas Gleixner"
      ],
      "categories": [
        "address_space"
      ],
      "first_date": "2024-03-04T10:12:29+00:00",
      "last_date": "2024-03-04T10:12:29+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/03/170954723724167.mbox",
          "message_id": "<20240304005104.841915535 () linutronix ! de>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "[patch 9/9] x86/callthunks: Use EXPORT_PER_CPU_SYMBOL_GPL() for per CPU variables",
          "date": "2024-03-04 10:12:29+00:00",
          "date_str": "Mon, 04 Mar 2024 10:12:29 +0000",
          "body": "sparse complains rightfully about the usage of EXPORT_SYMBOL_GPL() for per\nCPU variables:\n\ncallthunks.c:346:20: sparse: warning: incorrect type in initializer (different address spaces)\ncallthunks.c:346:20: sparse:    expected void const [noderef] __percpu *__vpp_verify\ncallthunks.c:346:20: sparse:    got unsigned long long *\n\nUse EXPORT_PER_CPU_SYMBOL_GPL instead.\n\nSigned-off-by: Thomas Gleixner <tglx@linutronix.de>\n---\n arch/x86/kernel/callthunks.c |    4 ++--\n 1 file changed, 2 insertions(+), 2 deletions(-)\n\n--- a/arch/x86/kernel/callthunks.c\n+++ b/arch/x86/kernel/callthunks.c\n@@ -44,8 +44,8 @@ DEFINE_PER_CPU(u64, __x86_call_count);\n DEFINE_PER_CPU(u64, __x86_ret_count);\n DEFINE_PER_CPU(u64, __x86_stuffs_count);\n DEFINE_PER_CPU(u64, __x86_ctxsw_count);\n-EXPORT_SYMBOL_GPL(__x86_ctxsw_count);\n-EXPORT_SYMBOL_GPL(__x86_call_count);\n+EXPORT_PER_CPU_SYMBOL_GPL(__x86_ctxsw_count);\n+EXPORT_PER_CPU_SYMBOL_GPL(__x86_call_count);\n #endif\n \n extern s32 __call_sites[], __call_sites_end[];\n\n",
          "year": "2024",
          "month": "03"
        }
      ],
      "primary_category": "address_space"
    },
    {
      "subject": "[patch 7/9] x86/cpu: Use EXPORT_PER_CPU_SYMBOL_GPL() for x86_spec_ctrl_current",
      "normalized_subject": "[patch 7/9] x86/cpu: Use EXPORT_PER_CPU_SYMBOL_GPL() for x86_spec_ctrl_current",
      "message_count": 1,
      "participants": [
        "Thomas Gleixner"
      ],
      "categories": [
        "address_space"
      ],
      "first_date": "2024-03-04T10:12:26+00:00",
      "last_date": "2024-03-04T10:12:26+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/03/170954721024145.mbox",
          "message_id": "<20240304005104.732288812 () linutronix ! de>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "[patch 7/9] x86/cpu: Use EXPORT_PER_CPU_SYMBOL_GPL() for x86_spec_ctrl_current",
          "date": "2024-03-04 10:12:26+00:00",
          "date_str": "Mon, 04 Mar 2024 10:12:26 +0000",
          "body": "sparse rightfully complains:\n\nbugs.c:71:9: sparse: warning: incorrect type in initializer (different address spaces)\nbugs.c:71:9: sparse:    expected void const [noderef] __percpu *__vpp_verify\nbugs.c:71:9: sparse:    got unsigned long long *\n\nThe reason is that x86_spec_ctrl_current which is a per CPU variable is\nexported with EXPORT_SYMBOL_GPL().\n\nUse EXPORT_PER_CPU_SYMBOL_GPL() instead.\n\nSigned-off-by: Thomas Gleixner <tglx@linutronix.de>\n---\n arch/x86/kernel/cpu/bugs.c |    2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\n--- a/arch/x86/kernel/cpu/bugs.c\n+++ b/arch/x86/kernel/cpu/bugs.c\n@@ -56,7 +56,7 @@ EXPORT_SYMBOL_GPL(x86_spec_ctrl_base);\n \n /* The current value of the SPEC_CTRL MSR with task-specific bits set */\n DEFINE_PER_CPU(u64, x86_spec_ctrl_current);\n-EXPORT_SYMBOL_GPL(x86_spec_ctrl_current);\n+EXPORT_PER_CPU_SYMBOL_GPL(x86_spec_ctrl_current);\n \n u64 x86_pred_cmd __ro_after_init = PRED_CMD_IBPB;\n EXPORT_SYMBOL_GPL(x86_pred_cmd);\n\n",
          "year": "2024",
          "month": "03"
        }
      ],
      "primary_category": "address_space"
    },
    {
      "subject": "[patch 6/9] x86/uaccess: Add missing __force to casts in __access_ok() and valid_user_address()",
      "normalized_subject": "[patch 6/9] x86/uaccess: Add missing __force to casts in __access_ok() and valid_user_address()",
      "message_count": 1,
      "participants": [
        "Thomas Gleixner"
      ],
      "categories": [
        "type_system",
        "compiler_compat",
        "address_space"
      ],
      "first_date": "2024-03-04T10:12:25+00:00",
      "last_date": "2024-03-04T10:12:25+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/03/170954719324133.mbox",
          "message_id": "<20240304005104.677606054 () linutronix ! de>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "[patch 6/9] x86/uaccess: Add missing __force to casts in __access_ok() and valid_user_address()",
          "date": "2024-03-04 10:12:25+00:00",
          "date_str": "Mon, 04 Mar 2024 10:12:25 +0000",
          "body": "sparse complains about losing the __user address space due to the cast to\nlong:\n\nuaccess_64.h:88:24: sparse: warning: cast removes address space '__user' of expression\n\nAnnotate it with __force to tell sparse that this is intentional.\n\nSigned-off-by: Thomas Gleixner <tglx@linutronix.de>\n---\n arch/x86/include/asm/uaccess_64.h |    7 ++++---\n 1 file changed, 4 insertions(+), 3 deletions(-)\n\n--- a/arch/x86/include/asm/uaccess_64.h\n+++ b/arch/x86/include/asm/uaccess_64.h\n@@ -54,7 +54,7 @@ static inline unsigned long __untagged_a\n  * half and a user half.  When cast to a signed type, user pointers\n  * are positive and kernel pointers are negative.\n  */\n-#define valid_user_address(x) ((long)(x) >= 0)\n+#define valid_user_address(x) ((__force long)(x) >= 0)\n \n /*\n  * User pointers can have tag bits on x86-64.  This scheme tolerates\n@@ -87,8 +87,9 @@ static inline bool __access_ok(const voi\n \tif (__builtin_constant_p(size <= PAGE_SIZE) && size <= PAGE_SIZE) {\n \t\treturn valid_user_address(ptr);\n \t} else {\n-\t\tunsigned long sum = size + (unsigned long)ptr;\n-\t\treturn valid_user_address(sum) && sum >= (unsigned long)ptr;\n+\t\tunsigned long sum = size + (__force unsigned long)ptr;\n+\n+\t\treturn valid_user_address(sum) && sum >= (__force unsigned long)ptr;\n \t}\n }\n #define __access_ok __access_ok\n\n",
          "year": "2024",
          "month": "03"
        }
      ],
      "primary_category": "address_space"
    },
    {
      "subject": "[patch 3/9] x86/msr: Add missing __percpu annotations",
      "normalized_subject": "[patch 3/9] x86/msr: Add missing __percpu annotations",
      "message_count": 1,
      "participants": [
        "Thomas Gleixner"
      ],
      "categories": [
        "kernel_integration",
        "compiler_compat",
        "address_space"
      ],
      "first_date": "2024-03-04T10:12:20+00:00",
      "last_date": "2024-03-04T10:12:20+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/03/170954714724099.mbox",
          "message_id": "<20240304005104.513181735 () linutronix ! de>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "[patch 3/9] x86/msr: Add missing __percpu annotations",
          "date": "2024-03-04 10:12:20+00:00",
          "date_str": "Mon, 04 Mar 2024 10:12:20 +0000",
          "body": "sparse complains rightfully about using a plain pointer for per CPU\naccessors:\n\nmsr-smp.c:15:23: sparse: warning: incorrect type in initializer (different address spaces)\nmsr-smp.c:15:23: sparse:    expected void const [noderef] __percpu *__vpp_verify\nmsr-smp.c:15:23: sparse:    got struct msr *\n\nAdd __percpu annotations to the related datastructure and function\narguments to cure this. This also cures the related sparse warnings at the\ncallsites in drivers/edac/amd64_edac.c.\n\nSigned-off-by: Thomas Gleixner <tglx@linutronix.de>\n---\n arch/x86/include/asm/msr.h       |   26 ++++++++++++++------------\n arch/x86/include/asm/processor.h |    1 -\n arch/x86/include/asm/tsc.h       |    3 ++-\n arch/x86/lib/msr-smp.c           |   12 +++++-------\n arch/x86/lib/msr.c               |    6 +++---\n 5 files changed, 24 insertions(+), 24 deletions(-)\n\n--- a/arch/x86/include/asm/msr.h\n+++ b/arch/x86/include/asm/msr.h\n@@ -12,11 +12,13 @@\n #include <uapi/asm/msr.h>\n #include <asm/shared/msr.h>\n \n+#include <linux/percpu.h>\n+\n struct msr_info {\n-\tu32 msr_no;\n-\tstruct msr reg;\n-\tstruct msr *msrs;\n-\tint err;\n+\tu32\t\t\tmsr_no;\n+\tstruct msr\t\treg;\n+\tstruct msr __percpu\t*msrs;\n+\tint\t\t\terr;\n };\n \n struct msr_regs_info {\n@@ -323,8 +325,8 @@ static inline int wrmsrl_safe(u32 msr, u\n \treturn wrmsr_safe(msr, (u32)val,  (u32)(val >> 32));\n }\n \n-struct msr *msrs_alloc(void);\n-void msrs_free(struct msr *msrs);\n+struct msr __percpu *msrs_alloc(void);\n+void msrs_free(struct msr __percpu *msrs);\n int msr_set_bit(u32 msr, u8 bit);\n int msr_clear_bit(u32 msr, u8 bit);\n \n@@ -333,8 +335,8 @@ int rdmsr_on_cpu(unsigned int cpu, u32 m\n int wrmsr_on_cpu(unsigned int cpu, u32 msr_no, u32 l, u32 h);\n int rdmsrl_on_cpu(unsigned int cpu, u32 msr_no, u64 *q);\n int wrmsrl_on_cpu(unsigned int cpu, u32 msr_no, u64 q);\n-void rdmsr_on_cpus(const struct cpumask *mask, u32 msr_no, struct msr *msrs);\n-void wrmsr_on_cpus(const struct cpumask *mask, u32 msr_no, struct msr *msrs);\n+void rdmsr_on_cpus(const struct cpumask *mask, u32 msr_no, struct msr __percpu *msrs);\n+void wrmsr_on_cpus(const struct cpumask *mask, u32 msr_no, struct msr __percpu *msrs);\n int rdmsr_safe_on_cpu(unsigned int cpu, u32 msr_no, u32 *l, u32 *h);\n int wrmsr_safe_on_cpu(unsigned int cpu, u32 msr_no, u32 l, u32 h);\n int rdmsrl_safe_on_cpu(unsigned int cpu, u32 msr_no, u64 *q);\n@@ -363,14 +365,14 @@ static inline int wrmsrl_on_cpu(unsigned\n \treturn 0;\n }\n static inline void rdmsr_on_cpus(const struct cpumask *m, u32 msr_no,\n-\t\t\t\tstruct msr *msrs)\n+\t\t\t\tstruct msr __percpu *msrs)\n {\n-\trdmsr_on_cpu(0, msr_no, &(msrs[0].l), &(msrs[0].h));\n+\trdmsr_on_cpu(0, msr_no, raw_cpu_ptr(&msrs->l), raw_cpu_ptr(&msrs->h));\n }\n static inline void wrmsr_on_cpus(const struct cpumask *m, u32 msr_no,\n-\t\t\t\tstruct msr *msrs)\n+\t\t\t\tstruct msr __percpu *msrs)\n {\n-\twrmsr_on_cpu(0, msr_no, msrs[0].l, msrs[0].h);\n+\twrmsr_on_cpu(0, msr_no, raw_cpu_read(msrs->l), raw_cpu_read(msrs->h));\n }\n static inline int rdmsr_safe_on_cpu(unsigned int cpu, u32 msr_no,\n \t\t\t\t    u32 *l, u32 *h)\n--- a/arch/x86/include/asm/processor.h\n+++ b/arch/x86/include/asm/processor.h\n@@ -20,7 +20,6 @@ struct vm86;\n #include <asm/page.h>\n #include <asm/pgtable_types.h>\n #include <asm/percpu.h>\n-#include <asm/msr.h>\n #include <asm/desc_defs.h>\n #include <asm/nops.h>\n #include <asm/special_insns.h>\n--- a/arch/x86/include/asm/tsc.h\n+++ b/arch/x86/include/asm/tsc.h\n@@ -5,8 +5,9 @@\n #ifndef _ASM_X86_TSC_H\n #define _ASM_X86_TSC_H\n \n-#include <asm/processor.h>\n #include <asm/cpufeature.h>\n+#include <asm/processor.h>\n+#include <asm/msr.h>\n \n /*\n  * Standard way to access the cycle counter.\n--- a/arch/x86/lib/msr-smp.c\n+++ b/arch/x86/lib/msr-smp.c\n@@ -9,10 +9,9 @@ static void __rdmsr_on_cpu(void *info)\n {\n \tstruct msr_info *rv = info;\n \tstruct msr *reg;\n-\tint this_cpu = raw_smp_processor_id();\n \n \tif (rv->msrs)\n-\t\treg = per_cpu_ptr(rv->msrs, this_cpu);\n+\t\treg = this_cpu_ptr(rv->msrs);\n \telse\n \t\treg = &rv->reg;\n \n@@ -23,10 +22,9 @@ static void __wrmsr_on_cpu(void *info)\n {\n \tstruct msr_info *rv = info;\n \tstruct msr *reg;\n-\tint this_cpu = raw_smp_processor_id();\n \n \tif (rv->msrs)\n-\t\treg = per_cpu_ptr(rv->msrs, this_cpu);\n+\t\treg = this_cpu_ptr(rv->msrs);\n \telse\n \t\treg = &rv->reg;\n \n@@ -97,7 +95,7 @@ int wrmsrl_on_cpu(unsigned int cpu, u32\n EXPORT_SYMBOL(wrmsrl_on_cpu);\n \n static void __rwmsr_on_cpus(const struct cpumask *mask, u32 msr_no,\n-\t\t\t    struct msr *msrs,\n+\t\t\t    struct msr __percpu *msrs,\n \t\t\t    void (*msr_func) (void *info))\n {\n \tstruct msr_info rv;\n@@ -124,7 +122,7 @@ static void __rwmsr_on_cpus(const struct\n  * @msrs:       array of MSR values\n  *\n  */\n-void rdmsr_on_cpus(const struct cpumask *mask, u32 msr_no, struct msr *msrs)\n+void rdmsr_on_cpus(const struct cpumask *mask, u32 msr_no, struct msr __percpu *msrs)\n {\n \t__rwmsr_on_cpus(mask, msr_no, msrs, __rdmsr_on_cpu);\n }\n@@ -138,7 +136,7 @@ EXPORT_SYMBOL(rdmsr_on_cpus);\n  * @msrs:       array of MSR values\n  *\n  */\n-void wrmsr_on_cpus(const struct cpumask *mask, u32 msr_no, struct msr *msrs)\n+void wrms",
          "year": "2024",
          "month": "03"
        }
      ],
      "primary_category": "kernel_integration"
    },
    {
      "subject": "[patch 1/9] perf/x86/amd/uncore: Fix __percpu annotation",
      "normalized_subject": "[patch 1/9] perf/x86/amd/uncore: Fix __percpu annotation",
      "message_count": 1,
      "participants": [
        "Thomas Gleixner"
      ],
      "categories": [
        "address_space"
      ],
      "first_date": "2024-03-04T10:12:18+00:00",
      "last_date": "2024-03-04T10:12:18+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/03/170954712424080.mbox",
          "message_id": "<20240304005104.394845326 () linutronix ! de>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "[patch 1/9] perf/x86/amd/uncore: Fix __percpu annotation",
          "date": "2024-03-04 10:12:18+00:00",
          "date_str": "Mon, 04 Mar 2024 10:12:18 +0000",
          "body": "The __percpu annotation in struct amd_uncore is confusing sparse:\n\nuncore.c:649:10: sparse: warning: incorrect type in initializer (different address spaces)\nuncore.c:649:10: sparse:    expected void const [noderef] __percpu *__vpp_verify\nuncore.c:649:10: sparse:    got union amd_uncore_info *\n\nThe reason is that the __percpu annotation sits between the '*'\ndereferencing operator and the member name.\n\nMove it before the dereferencing operator to cure this.\n\nSigned-off-by: Thomas Gleixner <tglx@linutronix.de>\n---\n arch/x86/events/amd/uncore.c |    2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\n--- a/arch/x86/events/amd/uncore.c\n+++ b/arch/x86/events/amd/uncore.c\n@@ -71,7 +71,7 @@ union amd_uncore_info {\n };\n \n struct amd_uncore {\n-\tunion amd_uncore_info * __percpu info;\n+\tunion amd_uncore_info  __percpu *info;\n \tstruct amd_uncore_pmu *pmus;\n \tunsigned int num_pmus;\n \tbool init_done;\n\n",
          "year": "2024",
          "month": "03"
        }
      ],
      "primary_category": "address_space"
    },
    {
      "subject": "Re: [patch 0/9] x86: Cure tons of sparse warnings (mostly __percpu)",
      "normalized_subject": "[patch 0/9] x86: Cure tons of sparse warnings (mostly __percpu)",
      "message_count": 2,
      "participants": [
        "Ingo Molnar",
        "Thomas Gleixner"
      ],
      "categories": [
        "kernel_integration",
        "compiler_compat",
        "context_analysis",
        "address_space"
      ],
      "first_date": "2024-03-04T10:12:16+00:00",
      "last_date": "2024-03-04T11:08:24+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/03/170954711924070.mbox",
          "message_id": "<20240303235029.555787150 () linutronix ! de>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "[patch 0/9] x86: Cure tons of sparse warnings (mostly __percpu)",
          "date": "2024-03-04 10:12:16+00:00",
          "date_str": "Mon, 04 Mar 2024 10:12:16 +0000",
          "body": "A recent 0-day report about new __percpu related sparse warnings made me\nlook deeper into it after I dismissed the report as bogus initially.\n\nIt turned out that sparse is actually right and all of these warnings (not\nonly the most recent ones) are valid and got ignored. Some of them for many\nyears.\n\nThe worst offender is an UP build because that maps the per CPU cpu_info to\nboot_cpu_data, which is regular data.\n\nAs a consequence all per CPU accessors which look like legit code and are\nlegit code in the SMP build are causing sparse to emit warnings.\n\nThis series addresses this by:\n\n     - Adding the missing __percpu annotations all over the place\n\n     - Curing the UP madness by exposing a proper per CPU cpu_info for the\n       price of wasting 320 byte of memory.\n\n       Even if the size police will hate me for that, this cures most of\n       the madness in one go and avoids to add more hideous macro mess\n       similar to the completely bogus cpu_data() one which should have\n       never been there in the first place.\n\n       I know that there are people who think that size matters, but the\n       only things which really matter in software are correctness and\n       maintainability. The latter simply forbids to add more hideous macro\n       mess just to avoid wasting 320 bytes of memory for something which\n       is mostly a reminiscence of the good old days...\n       \n     - Fixing a few obvious non __percpu related warnings which stood out\n       prominently.\n\nThat reduces the sparse warnings in arch/x86 significantly. The remaining\nones are less trivial to address:\n\n     - The non-x86 specific warning vs. sighand::lock:\n\n       sparse: warning: incorrect type in argument 1 (different address spaces)\n       sparse:    expected struct lockdep_map const *lock\n       sparse:    got struct lockdep_map [noderef] __rcu *\n\n     - A bunch of lock scope false positives which are non-trivial to solve\n\n     - A gazillion of __iomem warnings with the vast majority in the HPE/UV\n       code which are _all_ legit because neither UV nor the other places\n       care about the name space annotations at all. Pointer is pointer\n       after all.\n\n     - Tons of truncation warnings like this:\n\n       sparse: warning: cast truncates bits from constant value (20002 becomes 2)\n\n       mostly in the hypervisor space (kvm, hyperv). I did not look at\n       those at all so I don't know whether they matter or not.\n\nI really think sparse is valuable, but all of us should spend more time on\nthis to weed out false positives or at least have some filtering of things\nwhich are simply not solvable at the sparse level.\n\nComing back to __percpu. As I mentioned in the original thread it's a sad\nstate of affairs that the only way to detect the __percpu fails is sparse\nor some other static checker:\n\n      https://lore.kernel.org/all/87bk7vuldh.ffs@tglx\n\nBut that's a different problem to solve and does not invalidate the fixes\nwhich come with this series in any way.\n\nIf the compiler people would have provided a way to utilize the anyway\nnon-standard name space support in a useful way, I could have spared the\ntime to bang my head agaist the wall simply because this would have failed\nto build in the first place long ago. That just makes me sad.\n\nAfter wading through this, I really ask the 0-day people to push hard on\nany sparse fallout which involves __percpu. The resulting failures can be\ntruly subtle and not necessarily fatal right away.\n\nThe series is based on Linus tree and also available from git:\n\n   git://git.kernel.org/pub/scm/linux/kernel/git/tglx/devel.git x86/core\n\nThanks,\n\n\ttglx\n---\n arch/alpha/kernel/smp.c              |    5 -----\n arch/arc/kernel/smp.c                |    5 -----\n arch/csky/kernel/smp.c               |    4 ----\n arch/hexagon/kernel/smp.c            |    4 ----\n arch/openrisc/kernel/smp.c           |    4 ----\n arch/riscv/kernel/smpboot.c          |    4 ----\n arch/sparc/kernel/smp_64.c           |    4 ----\n arch/x86/events/amd/uncore.c         |    2 +-\n arch/x86/events/intel/core.c         |    1 +\n arch/x86/events/intel/ds.c           |    1 +\n arch/x86/include/asm/debugreg.h      |   24 ++++++++++++++++++++++++\n arch/x86/include/asm/fsgsbase.h      |    2 +-\n arch/x86/include/asm/msr.h           |   26 ++++++++++++++------------\n arch/x86/include/asm/processor.h     |   28 ----------------------------\n arch/x86/include/asm/smp.h           |    5 -----\n arch/x86/include/asm/spec-ctrl.h     |    2 ++\n arch/x86/include/asm/special_insns.h |    4 ++--\n arch/x86/include/asm/tsc.h           |    3 ++-\n arch/x86/include/asm/uaccess_64.h    |    7 ++++---\n arch/x86/kernel/callthunks.c         |    4 ++--\n arch/x86/kernel/cpu/bugs.c           |    2 +-\n arch/x86/kernel/cpu/common.c         |    3 +++\n arch/x86/kernel/cpu/intel_pconfig.c  |    2 ++\n arch/x86/kernel/cpu/rdrand.c         |    1 +\n arch/x86/kernel/fpu/bugs.c           |    2 ++\n arch/x86/kernel/setup.c              |   10 ++++++++++\n arch/x86/kernel/sm",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/170955045226850.mbox",
          "message_id": "<ZeWrqNcbSFJrQddR () gmail ! com>",
          "author_name": "Ingo Molnar",
          "author_email": "mingo () kernel ! org",
          "subject": "Re: [patch 0/9] x86: Cure tons of sparse warnings (mostly __percpu)",
          "date": "2024-03-04 11:08:24+00:00",
          "date_str": "Mon, 04 Mar 2024 11:08:24 +0000",
          "body": "\n* Thomas Gleixner <tglx@linutronix.de> wrote:\n\n> A recent 0-day report about new __percpu related sparse warnings made me\n> look deeper into it after I dismissed the report as bogus initially.\n> \n> It turned out that sparse is actually right and all of these warnings (not\n> only the most recent ones) are valid and got ignored. Some of them for many\n> years.\n> \n> The worst offender is an UP build because that maps the per CPU cpu_info to\n> boot_cpu_data, which is regular data.\n> \n> As a consequence all per CPU accessors which look like legit code and are\n> legit code in the SMP build are causing sparse to emit warnings.\n> \n> This series addresses this by:\n> \n>      - Adding the missing __percpu annotations all over the place\n> \n>      - Curing the UP madness by exposing a proper per CPU cpu_info for the\n>        price of wasting 320 byte of memory.\n> \n>        Even if the size police will hate me for that, this cures most of\n>        the madness in one go and avoids to add more hideous macro mess\n>        similar to the completely bogus cpu_data() one which should have\n>        never been there in the first place.\n\nThe market of UP-only systems running an upstream Linux kernel is shrinking \nfast, so I doubt this is a real concern.\n\n>        I know that there are people who think that size matters, but the\n>        only things which really matter in software are correctness and\n>        maintainability. The latter simply forbids to add more hideous macro\n>        mess just to avoid wasting 320 bytes of memory for something which\n>        is mostly a reminiscence of the good old days...\n>        \n>      - Fixing a few obvious non __percpu related warnings which stood out\n>        prominently.\n> \n> That reduces the sparse warnings in arch/x86 significantly.\n\nGreat - there's also the side benefit of reduction in <asm/processor.h> \ncomplexity via patch #2, which is great for ongoing work to reduce header \ndepdency hell ...\n\nI've applied your Sparse fixes to tip:x86/cleanups straight away, so they \nhave a chance to make it into v6.9.\n\nThanks,\n\n\tIngo\n",
          "year": "2024",
          "month": "03"
        }
      ],
      "primary_category": "kernel_integration"
    },
    {
      "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
      "normalized_subject": "arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
      "message_count": 45,
      "participants": [
        "Nathan Chancellor",
        "Thomas Gleixner",
        "Linus Torvalds",
        "Uros Bizjak"
      ],
      "categories": [
        "kernel_integration",
        "sparse_internals",
        "type_system",
        "address_space",
        "compiler_compat",
        "rfc_proposals"
      ],
      "first_date": "2024-03-02T15:44:37+00:00",
      "last_date": "2024-04-04T06:56:19+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/03/170939417623400.mbox",
          "message_id": "<87sf18vdsq.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-02 15:44:37+00:00",
          "date_str": "Sat, 02 Mar 2024 15:44:37 +0000",
          "body": "On Sat, Mar 02 2024 at 12:37, Thomas Gleixner wrote:\n> Bah. sparse is actually right. I completely missed the fact that this is\n> an UP build which has:\n>\n> extern struct cpuinfo_x86\tboot_cpu_data;\n>\n> #define cpu_info\t\tboot_cpu_data\n>\n> So any access with this_cpu*(), per_cpu*() etc. is actually incorrect from\n> sparse's point of view.\n>\n> From a compiler point of view it just works because __percpu dissolves\n> and the whole thing produces correct code magically.\n>\n> Most places in x86 use cpu_data(cpu) to access per cpu data which is\n> defined as per_cpu(cpu_info, cpu) for SMP and boot_cpu_info for UP.\n>\n> That's fine, but there are places like the MCE code which really needs\n> raw_cpu_ptr(). Sure we can write ugly wrappers for that and for some\n> other accessors. But that's all just wrong and ugly.\n>\n> The proper solution would be to force SMP for x86, but Linus shot it\n> down when I wanted to do that last time.\n>\n> Let me think about it.\n\nThe below addresses _all_ percpu related sparse warnings except\nthe ones in arch/x86/cpu/bugs.o but that's a sparse problem:\n\n   The following is handled correctly:\n\n\tDECLARE_PER_CPU(u64, foo);\n\tthis_cpu_read(foo);\n\n   But this is not:\n\n\tDECLARE_PER_CPU(u64, foo);\n\tDEFINE_PER_CPU(u64, foo);\n\tthis_cpu_read(foo);\n\narch/x86/kernel/cpu/bugs.c:71:9: sparse: warning: incorrect type in initializer (different address spaces)\narch/x86/kernel/cpu/bugs.c:71:9: sparse:    expected void const [noderef] __percpu *__vpp_verify\narch/x86/kernel/cpu/bugs.c:71:9: sparse:    got unsigned long long *\n\nCommenting out the DEFINE_PER_CPU(u64, x86_spec_ctrl_current) in that\nfile makes sparse happy, but that's obviously not a solution :)\n\nThis problem is unrelated to the UP cpu_info issue, which made me look\nat this mess in the first place. It happens on SMP too and both on 32\nand 64 bit.\n\nThe other __percpu related sparse warnings are valid.\n\n  - The UP cpu_info mechanics are just a horrible hackery.\n\n    The cure is to \"waste\" one 'struct cpu_info' size of memory and\n    provide the per CPU cpu_info in the same way as on SMP with\n    DEFINE_PER_CPU() and copy the boot_cpu_data over at the same point\n    in the boot process.\n\n    With that the unholy #define hack goes away and _all_ per CPU\n    accessors can now be used. That allows to get rid of the cpu_data()\n    indirection which is just annoying for SMP because it creates\n    suboptimal code.\n\n  - smp-msr and amd uncore lack __percpu annotations in data structures\n    and function arguments. That's not UP specific and just plain wrong.\n\nWhile at it I fixed also the valid_user_address() complaint which lacks\na __force in the type cast.\n\nThe UP muck is only compiled and not boot tested. There might be a few\nthings which need to be adjusted, but from a quick scan I did not see\nanything obvious.\n\nI'll go and split it up into reviewable chunks and actually test UP\nunless someone beats me to it and is brave enough to give the below a\ntest ride.\n\nThanks,\n\n        tglx\n---\n arch/alpha/kernel/smp.c           |    5 -----\n arch/arc/kernel/smp.c             |    5 -----\n arch/csky/kernel/smp.c            |    4 ----\n arch/hexagon/kernel/smp.c         |    4 ----\n arch/openrisc/kernel/smp.c        |    4 ----\n arch/riscv/kernel/smpboot.c       |    4 ----\n arch/sparc/kernel/smp_64.c        |    4 ----\n arch/x86/events/amd/uncore.c      |    2 +-\n arch/x86/include/asm/desc.h       |    4 ++--\n arch/x86/include/asm/msr.h        |   20 ++++++++++----------\n arch/x86/include/asm/processor.h  |    5 -----\n arch/x86/include/asm/smp.h        |    5 -----\n arch/x86/include/asm/uaccess_64.h |    2 +-\n arch/x86/kernel/setup.c           |   13 +++++++++++++\n arch/x86/kernel/smpboot.c         |    5 +++++\n arch/x86/lib/msr-smp.c            |    9 ++++-----\n arch/x86/lib/msr.c                |    2 +-\n include/linux/smp.h               |   13 ++++++-------\n init/main.c                       |    4 ++++\n 19 files changed, 47 insertions(+), 67 deletions(-)\n\n--- a/arch/alpha/kernel/smp.c\n+++ b/arch/alpha/kernel/smp.c\n@@ -467,11 +467,6 @@ smp_prepare_cpus(unsigned int max_cpus)\n \tsmp_num_cpus = smp_num_probed;\n }\n \n-void\n-smp_prepare_boot_cpu(void)\n-{\n-}\n-\n int\n __cpu_up(unsigned int cpu, struct task_struct *tidle)\n {\n--- a/arch/arc/kernel/smp.c\n+++ b/arch/arc/kernel/smp.c\n@@ -39,11 +39,6 @@ struct plat_smp_ops  __weak plat_smp_ops\n /* XXX: per cpu ? Only needed once in early secondary boot */\n struct task_struct *secondary_idle_tsk;\n \n-/* Called from start_kernel */\n-void __init smp_prepare_boot_cpu(void)\n-{\n-}\n-\n static int __init arc_get_cpu_map(const char *name, struct cpumask *cpumask)\n {\n \tunsigned long dt_root = of_get_flat_dt_root();\n--- a/arch/csky/kernel/smp.c\n+++ b/arch/csky/kernel/smp.c\n@@ -152,10 +152,6 @@ void arch_irq_work_raise(void)\n }\n #endif\n \n-void __init smp_prepare_boot_cpu(void)\n-{\n-}\n-\n void __init smp_prepare_cpus(unsigned int max_cpus)\n {\n }\n--- a/arch/hexagon/kernel/smp.c\n+++ b/arch/hexagon/kernel/smp.c\n@@ -114,10 +114,6 @@ void send_ipi(con",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/170939417123397.mbox",
          "message_id": "<87sf18vdsq.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-02 15:44:37+00:00",
          "date_str": "Sat, 02 Mar 2024 15:44:37 +0000",
          "body": "On Sat, Mar 02 2024 at 12:37, Thomas Gleixner wrote:\n> Bah. sparse is actually right. I completely missed the fact that this is\n> an UP build which has:\n>\n> extern struct cpuinfo_x86\tboot_cpu_data;\n>\n> #define cpu_info\t\tboot_cpu_data\n>\n> So any access with this_cpu*(), per_cpu*() etc. is actually incorrect from\n> sparse's point of view.\n>\n> From a compiler point of view it just works because __percpu dissolves\n> and the whole thing produces correct code magically.\n>\n> Most places in x86 use cpu_data(cpu) to access per cpu data which is\n> defined as per_cpu(cpu_info, cpu) for SMP and boot_cpu_info for UP.\n>\n> That's fine, but there are places like the MCE code which really needs\n> raw_cpu_ptr(). Sure we can write ugly wrappers for that and for some\n> other accessors. But that's all just wrong and ugly.\n>\n> The proper solution would be to force SMP for x86, but Linus shot it\n> down when I wanted to do that last time.\n>\n> Let me think about it.\n\nThe below addresses _all_ percpu related sparse warnings except\nthe ones in arch/x86/cpu/bugs.o but that's a sparse problem:\n\n   The following is handled correctly:\n\n\tDECLARE_PER_CPU(u64, foo);\n\tthis_cpu_read(foo);\n\n   But this is not:\n\n\tDECLARE_PER_CPU(u64, foo);\n\tDEFINE_PER_CPU(u64, foo);\n\tthis_cpu_read(foo);\n\narch/x86/kernel/cpu/bugs.c:71:9: sparse: warning: incorrect type in initializer (different address spaces)\narch/x86/kernel/cpu/bugs.c:71:9: sparse:    expected void const [noderef] __percpu *__vpp_verify\narch/x86/kernel/cpu/bugs.c:71:9: sparse:    got unsigned long long *\n\nCommenting out the DEFINE_PER_CPU(u64, x86_spec_ctrl_current) in that\nfile makes sparse happy, but that's obviously not a solution :)\n\nThis problem is unrelated to the UP cpu_info issue, which made me look\nat this mess in the first place. It happens on SMP too and both on 32\nand 64 bit.\n\nThe other __percpu related sparse warnings are valid.\n\n  - The UP cpu_info mechanics are just a horrible hackery.\n\n    The cure is to \"waste\" one 'struct cpu_info' size of memory and\n    provide the per CPU cpu_info in the same way as on SMP with\n    DEFINE_PER_CPU() and copy the boot_cpu_data over at the same point\n    in the boot process.\n\n    With that the unholy #define hack goes away and _all_ per CPU\n    accessors can now be used. That allows to get rid of the cpu_data()\n    indirection which is just annoying for SMP because it creates\n    suboptimal code.\n\n  - smp-msr and amd uncore lack __percpu annotations in data structures\n    and function arguments. That's not UP specific and just plain wrong.\n\nWhile at it I fixed also the valid_user_address() complaint which lacks\na __force in the type cast.\n\nThe UP muck is only compiled and not boot tested. There might be a few\nthings which need to be adjusted, but from a quick scan I did not see\nanything obvious.\n\nI'll go and split it up into reviewable chunks and actually test UP\nunless someone beats me to it and is brave enough to give the below a\ntest ride.\n\nThanks,\n\n        tglx\n---\n arch/alpha/kernel/smp.c           |    5 -----\n arch/arc/kernel/smp.c             |    5 -----\n arch/csky/kernel/smp.c            |    4 ----\n arch/hexagon/kernel/smp.c         |    4 ----\n arch/openrisc/kernel/smp.c        |    4 ----\n arch/riscv/kernel/smpboot.c       |    4 ----\n arch/sparc/kernel/smp_64.c        |    4 ----\n arch/x86/events/amd/uncore.c      |    2 +-\n arch/x86/include/asm/desc.h       |    4 ++--\n arch/x86/include/asm/msr.h        |   20 ++++++++++----------\n arch/x86/include/asm/processor.h  |    5 -----\n arch/x86/include/asm/smp.h        |    5 -----\n arch/x86/include/asm/uaccess_64.h |    2 +-\n arch/x86/kernel/setup.c           |   13 +++++++++++++\n arch/x86/kernel/smpboot.c         |    5 +++++\n arch/x86/lib/msr-smp.c            |    9 ++++-----\n arch/x86/lib/msr.c                |    2 +-\n include/linux/smp.h               |   13 ++++++-------\n init/main.c                       |    4 ++++\n 19 files changed, 47 insertions(+), 67 deletions(-)\n\n--- a/arch/alpha/kernel/smp.c\n+++ b/arch/alpha/kernel/smp.c\n@@ -467,11 +467,6 @@ smp_prepare_cpus(unsigned int max_cpus)\n \tsmp_num_cpus = smp_num_probed;\n }\n \n-void\n-smp_prepare_boot_cpu(void)\n-{\n-}\n-\n int\n __cpu_up(unsigned int cpu, struct task_struct *tidle)\n {\n--- a/arch/arc/kernel/smp.c\n+++ b/arch/arc/kernel/smp.c\n@@ -39,11 +39,6 @@ struct plat_smp_ops  __weak plat_smp_ops\n /* XXX: per cpu ? Only needed once in early secondary boot */\n struct task_struct *secondary_idle_tsk;\n \n-/* Called from start_kernel */\n-void __init smp_prepare_boot_cpu(void)\n-{\n-}\n-\n static int __init arc_get_cpu_map(const char *name, struct cpumask *cpumask)\n {\n \tunsigned long dt_root = of_get_flat_dt_root();\n--- a/arch/csky/kernel/smp.c\n+++ b/arch/csky/kernel/smp.c\n@@ -152,10 +152,6 @@ void arch_irq_work_raise(void)\n }\n #endif\n \n-void __init smp_prepare_boot_cpu(void)\n-{\n-}\n-\n void __init smp_prepare_cpus(unsigned int max_cpus)\n {\n }\n--- a/arch/hexagon/kernel/smp.c\n+++ b/arch/hexagon/kernel/smp.c\n@@ -114,10 +114,6 @@ void send_ipi(con",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/04/170939417623400.mbox",
          "message_id": "<87sf18vdsq.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-02 15:44:37+00:00",
          "date_str": "Sat, 02 Mar 2024 15:44:37 +0000",
          "body": "On Sat, Mar 02 2024 at 12:37, Thomas Gleixner wrote:\n> Bah. sparse is actually right. I completely missed the fact that this is\n> an UP build which has:\n>\n> extern struct cpuinfo_x86\tboot_cpu_data;\n>\n> #define cpu_info\t\tboot_cpu_data\n>\n> So any access with this_cpu*(), per_cpu*() etc. is actually incorrect from\n> sparse's point of view.\n>\n> From a compiler point of view it just works because __percpu dissolves\n> and the whole thing produces correct code magically.\n>\n> Most places in x86 use cpu_data(cpu) to access per cpu data which is\n> defined as per_cpu(cpu_info, cpu) for SMP and boot_cpu_info for UP.\n>\n> That's fine, but there are places like the MCE code which really needs\n> raw_cpu_ptr(). Sure we can write ugly wrappers for that and for some\n> other accessors. But that's all just wrong and ugly.\n>\n> The proper solution would be to force SMP for x86, but Linus shot it\n> down when I wanted to do that last time.\n>\n> Let me think about it.\n\nThe below addresses _all_ percpu related sparse warnings except\nthe ones in arch/x86/cpu/bugs.o but that's a sparse problem:\n\n   The following is handled correctly:\n\n\tDECLARE_PER_CPU(u64, foo);\n\tthis_cpu_read(foo);\n\n   But this is not:\n\n\tDECLARE_PER_CPU(u64, foo);\n\tDEFINE_PER_CPU(u64, foo);\n\tthis_cpu_read(foo);\n\narch/x86/kernel/cpu/bugs.c:71:9: sparse: warning: incorrect type in initializer (different address spaces)\narch/x86/kernel/cpu/bugs.c:71:9: sparse:    expected void const [noderef] __percpu *__vpp_verify\narch/x86/kernel/cpu/bugs.c:71:9: sparse:    got unsigned long long *\n\nCommenting out the DEFINE_PER_CPU(u64, x86_spec_ctrl_current) in that\nfile makes sparse happy, but that's obviously not a solution :)\n\nThis problem is unrelated to the UP cpu_info issue, which made me look\nat this mess in the first place. It happens on SMP too and both on 32\nand 64 bit.\n\nThe other __percpu related sparse warnings are valid.\n\n  - The UP cpu_info mechanics are just a horrible hackery.\n\n    The cure is to \"waste\" one 'struct cpu_info' size of memory and\n    provide the per CPU cpu_info in the same way as on SMP with\n    DEFINE_PER_CPU() and copy the boot_cpu_data over at the same point\n    in the boot process.\n\n    With that the unholy #define hack goes away and _all_ per CPU\n    accessors can now be used. That allows to get rid of the cpu_data()\n    indirection which is just annoying for SMP because it creates\n    suboptimal code.\n\n  - smp-msr and amd uncore lack __percpu annotations in data structures\n    and function arguments. That's not UP specific and just plain wrong.\n\nWhile at it I fixed also the valid_user_address() complaint which lacks\na __force in the type cast.\n\nThe UP muck is only compiled and not boot tested. There might be a few\nthings which need to be adjusted, but from a quick scan I did not see\nanything obvious.\n\nI'll go and split it up into reviewable chunks and actually test UP\nunless someone beats me to it and is brave enough to give the below a\ntest ride.\n\nThanks,\n\n        tglx\n---\n arch/alpha/kernel/smp.c           |    5 -----\n arch/arc/kernel/smp.c             |    5 -----\n arch/csky/kernel/smp.c            |    4 ----\n arch/hexagon/kernel/smp.c         |    4 ----\n arch/openrisc/kernel/smp.c        |    4 ----\n arch/riscv/kernel/smpboot.c       |    4 ----\n arch/sparc/kernel/smp_64.c        |    4 ----\n arch/x86/events/amd/uncore.c      |    2 +-\n arch/x86/include/asm/desc.h       |    4 ++--\n arch/x86/include/asm/msr.h        |   20 ++++++++++----------\n arch/x86/include/asm/processor.h  |    5 -----\n arch/x86/include/asm/smp.h        |    5 -----\n arch/x86/include/asm/uaccess_64.h |    2 +-\n arch/x86/kernel/setup.c           |   13 +++++++++++++\n arch/x86/kernel/smpboot.c         |    5 +++++\n arch/x86/lib/msr-smp.c            |    9 ++++-----\n arch/x86/lib/msr.c                |    2 +-\n include/linux/smp.h               |   13 ++++++-------\n init/main.c                       |    4 ++++\n 19 files changed, 47 insertions(+), 67 deletions(-)\n\n--- a/arch/alpha/kernel/smp.c\n+++ b/arch/alpha/kernel/smp.c\n@@ -467,11 +467,6 @@ smp_prepare_cpus(unsigned int max_cpus)\n \tsmp_num_cpus = smp_num_probed;\n }\n \n-void\n-smp_prepare_boot_cpu(void)\n-{\n-}\n-\n int\n __cpu_up(unsigned int cpu, struct task_struct *tidle)\n {\n--- a/arch/arc/kernel/smp.c\n+++ b/arch/arc/kernel/smp.c\n@@ -39,11 +39,6 @@ struct plat_smp_ops  __weak plat_smp_ops\n /* XXX: per cpu ? Only needed once in early secondary boot */\n struct task_struct *secondary_idle_tsk;\n \n-/* Called from start_kernel */\n-void __init smp_prepare_boot_cpu(void)\n-{\n-}\n-\n static int __init arc_get_cpu_map(const char *name, struct cpumask *cpumask)\n {\n \tunsigned long dt_root = of_get_flat_dt_root();\n--- a/arch/csky/kernel/smp.c\n+++ b/arch/csky/kernel/smp.c\n@@ -152,10 +152,6 @@ void arch_irq_work_raise(void)\n }\n #endif\n \n-void __init smp_prepare_boot_cpu(void)\n-{\n-}\n-\n void __init smp_prepare_cpus(unsigned int max_cpus)\n {\n }\n--- a/arch/hexagon/kernel/smp.c\n+++ b/arch/hexagon/kernel/smp.c\n@@ -114,10 +114,6 @@ void send_ipi(con",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/04/170941669532447.mbox",
          "message_id": "<87le70uwf0.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-02 21:58:15+00:00",
          "date_str": "Sat, 02 Mar 2024 21:58:15 +0000",
          "body": "On Sat, Mar 02 2024 at 16:44, Thomas Gleixner wrote:\n> On Sat, Mar 02 2024 at 12:37, Thomas Gleixner wrote:\n> The below addresses _all_ percpu related sparse warnings except\n> the ones in arch/x86/cpu/bugs.o but that's a sparse problem:\n>\n>    The following is handled correctly:\n>\n> \tDECLARE_PER_CPU(u64, foo);\n> \tthis_cpu_read(foo);\n>\n>    But this is not:\n>\n> \tDECLARE_PER_CPU(u64, foo);\n> \tDEFINE_PER_CPU(u64, foo);\n> \tthis_cpu_read(foo);\n>\n> arch/x86/kernel/cpu/bugs.c:71:9: sparse: warning: incorrect type in initializer (different address spaces)\n> arch/x86/kernel/cpu/bugs.c:71:9: sparse:    expected void const [noderef] __percpu *__vpp_verify\n> arch/x86/kernel/cpu/bugs.c:71:9: sparse:    got unsigned long long *\n>\n> Commenting out the DEFINE_PER_CPU(u64, x86_spec_ctrl_current) in that\n> file makes sparse happy, but that's obviously not a solution :)\n\nCorrection. I found the real issue:\n\nDEFINE_PER_CPU(u64, x86_spec_ctrl_current);\nEXPORT_SYMBOL_GPL(x86_spec_ctrl_current);\n\nI had commented out both. But the real reason is the EXPORT_SYMBOL,\nwhich obviously wants to be EXPORT_PER_CPU_SYMBOL_GPL...\n\nSo sparse was right. Nothing to see here.\n\nThanks,\n\n        tglx\n\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/03/170941670132453.mbox",
          "message_id": "<87le70uwf0.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-02 21:58:21+00:00",
          "date_str": "Sat, 02 Mar 2024 21:58:21 +0000",
          "body": "On Sat, Mar 02 2024 at 16:44, Thomas Gleixner wrote:\n> On Sat, Mar 02 2024 at 12:37, Thomas Gleixner wrote:\n> The below addresses _all_ percpu related sparse warnings except\n> the ones in arch/x86/cpu/bugs.o but that's a sparse problem:\n>\n>    The following is handled correctly:\n>\n> \tDECLARE_PER_CPU(u64, foo);\n> \tthis_cpu_read(foo);\n>\n>    But this is not:\n>\n> \tDECLARE_PER_CPU(u64, foo);\n> \tDEFINE_PER_CPU(u64, foo);\n> \tthis_cpu_read(foo);\n>\n> arch/x86/kernel/cpu/bugs.c:71:9: sparse: warning: incorrect type in initializer (different address spaces)\n> arch/x86/kernel/cpu/bugs.c:71:9: sparse:    expected void const [noderef] __percpu *__vpp_verify\n> arch/x86/kernel/cpu/bugs.c:71:9: sparse:    got unsigned long long *\n>\n> Commenting out the DEFINE_PER_CPU(u64, x86_spec_ctrl_current) in that\n> file makes sparse happy, but that's obviously not a solution :)\n\nCorrection. I found the real issue:\n\nDEFINE_PER_CPU(u64, x86_spec_ctrl_current);\nEXPORT_SYMBOL_GPL(x86_spec_ctrl_current);\n\nI had commented out both. But the real reason is the EXPORT_SYMBOL,\nwhich obviously wants to be EXPORT_PER_CPU_SYMBOL_GPL...\n\nSo sparse was right. Nothing to see here.\n\nThanks,\n\n        tglx\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/04/170941670132453.mbox",
          "message_id": "<87le70uwf0.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-02 21:58:21+00:00",
          "date_str": "Sat, 02 Mar 2024 21:58:21 +0000",
          "body": "On Sat, Mar 02 2024 at 16:44, Thomas Gleixner wrote:\n> On Sat, Mar 02 2024 at 12:37, Thomas Gleixner wrote:\n> The below addresses _all_ percpu related sparse warnings except\n> the ones in arch/x86/cpu/bugs.o but that's a sparse problem:\n>\n>    The following is handled correctly:\n>\n> \tDECLARE_PER_CPU(u64, foo);\n> \tthis_cpu_read(foo);\n>\n>    But this is not:\n>\n> \tDECLARE_PER_CPU(u64, foo);\n> \tDEFINE_PER_CPU(u64, foo);\n> \tthis_cpu_read(foo);\n>\n> arch/x86/kernel/cpu/bugs.c:71:9: sparse: warning: incorrect type in initializer (different address spaces)\n> arch/x86/kernel/cpu/bugs.c:71:9: sparse:    expected void const [noderef] __percpu *__vpp_verify\n> arch/x86/kernel/cpu/bugs.c:71:9: sparse:    got unsigned long long *\n>\n> Commenting out the DEFINE_PER_CPU(u64, x86_spec_ctrl_current) in that\n> file makes sparse happy, but that's obviously not a solution :)\n\nCorrection. I found the real issue:\n\nDEFINE_PER_CPU(u64, x86_spec_ctrl_current);\nEXPORT_SYMBOL_GPL(x86_spec_ctrl_current);\n\nI had commented out both. But the real reason is the EXPORT_SYMBOL,\nwhich obviously wants to be EXPORT_PER_CPU_SYMBOL_GPL...\n\nSo sparse was right. Nothing to see here.\n\nThanks,\n\n        tglx\n\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/03/170941966701787.mbox",
          "message_id": "<CAHk-=wiWhfdc4Sw2VBq_2nL2NDxmZS32xG4P7mBVwABGqUoJnw () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-02 22:49:15+00:00",
          "date_str": "Sat, 02 Mar 2024 22:49:15 +0000",
          "body": "On Sat, 2 Mar 2024 at 14:00, Thomas Gleixner <tglx@linutronix.de> wrote:\n>\n> I had commented out both. But the real reason is the EXPORT_SYMBOL,\n> which obviously wants to be EXPORT_PER_CPU_SYMBOL_GPL...\n\nSide note: while it's nice to hear that sparse kind of got this right,\nI wonder what gcc does when we start using the named address spaces\nfor percpu variables.\n\nWe actively make EXPORT_PER_CPU_SYMBOL_XYZ be a no-op for sparse\nexactly because sparse ended up warning about the regular\nEXPORT_SYMBOL, and we didn't have any \"real\" per-cpu export model.\n\nSo EXPORT_PER_CPU_SYMBOL_GPL() is kind of an artificial \"shut up\nsparse\". But with __seg_gs/fs support for native percpu symbols with\ngcc, I wonder if we'll hit the same thing. Or is there something that\nmakes gcc not warn about the named address spaces?\n\nBecause in many ways the gcc named address spaces _should_ be pretty\nmuch equivalent to the sparse ones.\n\n            Linus\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/170941966501784.mbox",
          "message_id": "<CAHk-=wiWhfdc4Sw2VBq_2nL2NDxmZS32xG4P7mBVwABGqUoJnw () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-02 22:49:15+00:00",
          "date_str": "Sat, 02 Mar 2024 22:49:15 +0000",
          "body": "On Sat, 2 Mar 2024 at 14:00, Thomas Gleixner <tglx@linutronix.de> wrote:\n>\n> I had commented out both. But the real reason is the EXPORT_SYMBOL,\n> which obviously wants to be EXPORT_PER_CPU_SYMBOL_GPL...\n\nSide note: while it's nice to hear that sparse kind of got this right,\nI wonder what gcc does when we start using the named address spaces\nfor percpu variables.\n\nWe actively make EXPORT_PER_CPU_SYMBOL_XYZ be a no-op for sparse\nexactly because sparse ended up warning about the regular\nEXPORT_SYMBOL, and we didn't have any \"real\" per-cpu export model.\n\nSo EXPORT_PER_CPU_SYMBOL_GPL() is kind of an artificial \"shut up\nsparse\". But with __seg_gs/fs support for native percpu symbols with\ngcc, I wonder if we'll hit the same thing. Or is there something that\nmakes gcc not warn about the named address spaces?\n\nBecause in many ways the gcc named address spaces _should_ be pretty\nmuch equivalent to the sparse ones.\n\n            Linus\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/04/170941966701787.mbox",
          "message_id": "<CAHk-=wiWhfdc4Sw2VBq_2nL2NDxmZS32xG4P7mBVwABGqUoJnw () mail ! gmail ! com>",
          "author_name": "Linus Torvalds",
          "author_email": "torvalds () linux-foundation ! org",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-02 22:49:15+00:00",
          "date_str": "Sat, 02 Mar 2024 22:49:15 +0000",
          "body": "On Sat, 2 Mar 2024 at 14:00, Thomas Gleixner <tglx@linutronix.de> wrote:\n>\n> I had commented out both. But the real reason is the EXPORT_SYMBOL,\n> which obviously wants to be EXPORT_PER_CPU_SYMBOL_GPL...\n\nSide note: while it's nice to hear that sparse kind of got this right,\nI wonder what gcc does when we start using the named address spaces\nfor percpu variables.\n\nWe actively make EXPORT_PER_CPU_SYMBOL_XYZ be a no-op for sparse\nexactly because sparse ended up warning about the regular\nEXPORT_SYMBOL, and we didn't have any \"real\" per-cpu export model.\n\nSo EXPORT_PER_CPU_SYMBOL_GPL() is kind of an artificial \"shut up\nsparse\". But with __seg_gs/fs support for native percpu symbols with\ngcc, I wonder if we'll hit the same thing. Or is there something that\nmakes gcc not warn about the named address spaces?\n\nBecause in many ways the gcc named address spaces _should_ be pretty\nmuch equivalent to the sparse ones.\n\n            Linus\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/03/170948339325941.mbox",
          "message_id": "<87edcruvja.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 16:31:21+00:00",
          "date_str": "Sun, 03 Mar 2024 16:31:21 +0000",
          "body": "On Sat, Mar 02 2024 at 14:49, Linus Torvalds wrote:\n> On Sat, 2 Mar 2024 at 14:00, Thomas Gleixner <tglx@linutronix.de> wrote:\n>>\n>> I had commented out both. But the real reason is the EXPORT_SYMBOL,\n>> which obviously wants to be EXPORT_PER_CPU_SYMBOL_GPL...\n>\n> Side note: while it's nice to hear that sparse kind of got this right,\n> I wonder what gcc does when we start using the named address spaces\n> for percpu variables.\n>\n> We actively make EXPORT_PER_CPU_SYMBOL_XYZ be a no-op for sparse\n> exactly because sparse ended up warning about the regular\n> EXPORT_SYMBOL, and we didn't have any \"real\" per-cpu export model.\n\nRight.\n\n> So EXPORT_PER_CPU_SYMBOL_GPL() is kind of an artificial \"shut up\n> sparse\".\n\nAside of that it's also making it clear what this is about. So I don't\nthink it's purely artifical.\n\n> But with __seg_gs/fs support for native percpu symbols with\n> gcc, I wonder if we'll hit the same thing. Or is there something that\n> makes gcc not warn about the named address spaces?\n\nRight now the pending code in tip does not complain about the\nEXPORT_PER_CPU_SYMBOL_GPL() part because our current macro maze is\nhideous. Here is the preprocessor output.\n\nThis is DECLARE_PER_CPU() in the header:\n\nextern __attribute__((section(\".data..percpu\" \"\"))) __typeof__(u64) x86_spec_ctrl_current;\n\nHere is DEFINE_PER_CPU():\n\n__attribute__((section(\".data..percpu\" \"\"))) __typeof__(u64) x86_spec_ctrl_current;\n\nAnd the EXPORT:\n\nextern typeof(x86_spec_ctrl_current) x86_spec_ctrl_current;\n\nstatic void * __attribute__((__used__))\n   __attribute__((__section__(\".discard.addressable\")))\n   __UNIQUE_ID___addressable_x86_spec_ctrl_current804 = (void *)(uintptr_t)&x86_spec_ctrl_current;\n\n   asm(\".section \\\".export_symbol\\\",\\\"a\\\" ;\n       __export_symbol_x86_spec_ctrl_current: ;\n       .asciz \\\"GPL\\\" ; .asciz \\\"\\\" ; .balign 8 ; .quad x86_spec_ctrl_current ; .previous\");\n\nAnd the __seg_gs magic happens only in the per CPU accessor itself:\n\n__attribute__((__noinline__)) __attribute__((no_instrument_function))\n __attribute((__section__(\".noinstr.text\")))\n __attribute__((__no_sanitize_address__))\n __attribute__((__no_profile_instrument_function__))\n u64 spec_ctrl_current(void)\n{\n return ({\n    // this_cpu_read(x86_spec_ctrl_current)\n\n    typeof(x86_spec_ctrl_current) pscr_ret__;\n\n    do { const void *__vpp_verify = (typeof((&(x86_spec_ctrl_current)) + 0))((void *)0); (void)__vpp_verify;\n    } while (0);\n\n    switch(sizeof(x86_spec_ctrl_current))\n    {\n    case 1: pscr_ret__ = ({\n            *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current)); });\n            break;\n    case 2: pscr_ret__ = ({\n            *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current)); });\n            break;\n    case 4: pscr_ret__ = ({\n            *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current)); });\n            break;\n    case 8: pscr_ret__ = ({\n            *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current)); });\n            break;\n\n    default: __bad_size_call_parameter(); break;\n    }\n\n    pscr_ret__;\n  });\n}\n\nSo all the export etc. just works because it all operates on a plain\ndata type and the __seg_gs is only bolted on via type casts in the\naccessors.\n\nAs the per cpu variables are in the .data..percpu section the linker\nputs them at address 0 and upwards. So the cast to a __seg_gs pointer\nmakes it end up at the real kernel address because of GSBASE + \"offset\".\n\nThe compiler converts this to RIP relative addressing:\n\n  movq   $0x0,%gs:0x7e14169f(%rip)        # 1ba08 <fpu_fpregs_owner_ctx>\n\nThis obviously has a downside. If I do:\n\n   u64 foo;\n\n   this_cpu_read(foo);\n\nthe compiler is just happy to build that w/o complaining and it will\nonly explode at runtime because foo is a kernel data address which added\nto GSBASE will result in accessing some random address:\n\n  mov    %gs:0x15d08d4(%rip),%rax        # ffffffff834aac60 <x86_spec_ctrl_base>\n\nThis is not at all different from the inline ASM based version which is\nin your tree. The only difference is that the macro maze is pure C and\nthe __set_gs cast allows the compiler to (micro) optimize, e.g. 'mov\n%gs:...; movzbl' into a single 'movzbl'.\n\nIOW, right now the only defense against such a mistake is actually the\nsparse check. Maybe one of the coccinelle scripts has something similar,\nI don't know.\n\nI did not follow the __set_gs work closely, so I don't know whether Uros\never tried to actually mark the per CPU variable __set_gs right away,\nwhich would obviously catch the above 'foo' nonsense.\n\nI think this should just work, but that would obviously require to do\nthe type cast magic at the EXPORT_SYMBOL side and in some other places.\n\nThanks,\n\n        tglx\n\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/04/170948339325941.mbox",
          "message_id": "<87edcruvja.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 16:31:21+00:00",
          "date_str": "Sun, 03 Mar 2024 16:31:21 +0000",
          "body": "On Sat, Mar 02 2024 at 14:49, Linus Torvalds wrote:\n> On Sat, 2 Mar 2024 at 14:00, Thomas Gleixner <tglx@linutronix.de> wrote:\n>>\n>> I had commented out both. But the real reason is the EXPORT_SYMBOL,\n>> which obviously wants to be EXPORT_PER_CPU_SYMBOL_GPL...\n>\n> Side note: while it's nice to hear that sparse kind of got this right,\n> I wonder what gcc does when we start using the named address spaces\n> for percpu variables.\n>\n> We actively make EXPORT_PER_CPU_SYMBOL_XYZ be a no-op for sparse\n> exactly because sparse ended up warning about the regular\n> EXPORT_SYMBOL, and we didn't have any \"real\" per-cpu export model.\n\nRight.\n\n> So EXPORT_PER_CPU_SYMBOL_GPL() is kind of an artificial \"shut up\n> sparse\".\n\nAside of that it's also making it clear what this is about. So I don't\nthink it's purely artifical.\n\n> But with __seg_gs/fs support for native percpu symbols with\n> gcc, I wonder if we'll hit the same thing. Or is there something that\n> makes gcc not warn about the named address spaces?\n\nRight now the pending code in tip does not complain about the\nEXPORT_PER_CPU_SYMBOL_GPL() part because our current macro maze is\nhideous. Here is the preprocessor output.\n\nThis is DECLARE_PER_CPU() in the header:\n\nextern __attribute__((section(\".data..percpu\" \"\"))) __typeof__(u64) x86_spec_ctrl_current;\n\nHere is DEFINE_PER_CPU():\n\n__attribute__((section(\".data..percpu\" \"\"))) __typeof__(u64) x86_spec_ctrl_current;\n\nAnd the EXPORT:\n\nextern typeof(x86_spec_ctrl_current) x86_spec_ctrl_current;\n\nstatic void * __attribute__((__used__))\n   __attribute__((__section__(\".discard.addressable\")))\n   __UNIQUE_ID___addressable_x86_spec_ctrl_current804 = (void *)(uintptr_t)&x86_spec_ctrl_current;\n\n   asm(\".section \\\".export_symbol\\\",\\\"a\\\" ;\n       __export_symbol_x86_spec_ctrl_current: ;\n       .asciz \\\"GPL\\\" ; .asciz \\\"\\\" ; .balign 8 ; .quad x86_spec_ctrl_current ; .previous\");\n\nAnd the __seg_gs magic happens only in the per CPU accessor itself:\n\n__attribute__((__noinline__)) __attribute__((no_instrument_function))\n __attribute((__section__(\".noinstr.text\")))\n __attribute__((__no_sanitize_address__))\n __attribute__((__no_profile_instrument_function__))\n u64 spec_ctrl_current(void)\n{\n return ({\n    // this_cpu_read(x86_spec_ctrl_current)\n\n    typeof(x86_spec_ctrl_current) pscr_ret__;\n\n    do { const void *__vpp_verify = (typeof((&(x86_spec_ctrl_current)) + 0))((void *)0); (void)__vpp_verify;\n    } while (0);\n\n    switch(sizeof(x86_spec_ctrl_current))\n    {\n    case 1: pscr_ret__ = ({\n            *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current)); });\n            break;\n    case 2: pscr_ret__ = ({\n            *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current)); });\n            break;\n    case 4: pscr_ret__ = ({\n            *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current)); });\n            break;\n    case 8: pscr_ret__ = ({\n            *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current)); });\n            break;\n\n    default: __bad_size_call_parameter(); break;\n    }\n\n    pscr_ret__;\n  });\n}\n\nSo all the export etc. just works because it all operates on a plain\ndata type and the __seg_gs is only bolted on via type casts in the\naccessors.\n\nAs the per cpu variables are in the .data..percpu section the linker\nputs them at address 0 and upwards. So the cast to a __seg_gs pointer\nmakes it end up at the real kernel address because of GSBASE + \"offset\".\n\nThe compiler converts this to RIP relative addressing:\n\n  movq   $0x0,%gs:0x7e14169f(%rip)        # 1ba08 <fpu_fpregs_owner_ctx>\n\nThis obviously has a downside. If I do:\n\n   u64 foo;\n\n   this_cpu_read(foo);\n\nthe compiler is just happy to build that w/o complaining and it will\nonly explode at runtime because foo is a kernel data address which added\nto GSBASE will result in accessing some random address:\n\n  mov    %gs:0x15d08d4(%rip),%rax        # ffffffff834aac60 <x86_spec_ctrl_base>\n\nThis is not at all different from the inline ASM based version which is\nin your tree. The only difference is that the macro maze is pure C and\nthe __set_gs cast allows the compiler to (micro) optimize, e.g. 'mov\n%gs:...; movzbl' into a single 'movzbl'.\n\nIOW, right now the only defense against such a mistake is actually the\nsparse check. Maybe one of the coccinelle scripts has something similar,\nI don't know.\n\nI did not follow the __set_gs work closely, so I don't know whether Uros\never tried to actually mark the per CPU variable __set_gs right away,\nwhich would obviously catch the above 'foo' nonsense.\n\nI think this should just work, but that would obviously require to do\nthe type cast magic at the EXPORT_SYMBOL side and in some other places.\n\nThanks,\n\n        tglx\n\n\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/03/170949253430237.mbox",
          "message_id": "<CAFULd4bVEUBEidTLbHNzRaJbSjXm99yC8LT=jdzFWb7xnuFH7g () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 19:03:56+00:00",
          "date_str": "Sun, 03 Mar 2024 19:03:56 +0000",
          "body": "On Sun, Mar 3, 2024 at 5:31=E2=80=AFPM Thomas Gleixner <tglx@linutronix.de>=\n wrote:\n>\n> On Sat, Mar 02 2024 at 14:49, Linus Torvalds wrote:\n> > On Sat, 2 Mar 2024 at 14:00, Thomas Gleixner <tglx@linutronix.de> wrote=\n:\n> >>\n> >> I had commented out both. But the real reason is the EXPORT_SYMBOL,\n> >> which obviously wants to be EXPORT_PER_CPU_SYMBOL_GPL...\n> >\n> > Side note: while it's nice to hear that sparse kind of got this right,\n> > I wonder what gcc does when we start using the named address spaces\n> > for percpu variables.\n> >\n> > We actively make EXPORT_PER_CPU_SYMBOL_XYZ be a no-op for sparse\n> > exactly because sparse ended up warning about the regular\n> > EXPORT_SYMBOL, and we didn't have any \"real\" per-cpu export model.\n>\n> Right.\n>\n> > So EXPORT_PER_CPU_SYMBOL_GPL() is kind of an artificial \"shut up\n> > sparse\".\n>\n> Aside of that it's also making it clear what this is about. So I don't\n> think it's purely artifical.\n>\n> > But with __seg_gs/fs support for native percpu symbols with\n> > gcc, I wonder if we'll hit the same thing. Or is there something that\n> > makes gcc not warn about the named address spaces?\n>\n> Right now the pending code in tip does not complain about the\n> EXPORT_PER_CPU_SYMBOL_GPL() part because our current macro maze is\n> hideous. Here is the preprocessor output.\n>\n> This is DECLARE_PER_CPU() in the header:\n>\n> extern __attribute__((section(\".data..percpu\" \"\"))) __typeof__(u64) x86_s=\npec_ctrl_current;\n>\n> Here is DEFINE_PER_CPU():\n>\n> __attribute__((section(\".data..percpu\" \"\"))) __typeof__(u64) x86_spec_ctr=\nl_current;\n>\n> And the EXPORT:\n>\n> extern typeof(x86_spec_ctrl_current) x86_spec_ctrl_current;\n>\n> static void * __attribute__((__used__))\n>    __attribute__((__section__(\".discard.addressable\")))\n>    __UNIQUE_ID___addressable_x86_spec_ctrl_current804 =3D (void *)(uintpt=\nr_t)&x86_spec_ctrl_current;\n>\n>    asm(\".section \\\".export_symbol\\\",\\\"a\\\" ;\n>        __export_symbol_x86_spec_ctrl_current: ;\n>        .asciz \\\"GPL\\\" ; .asciz \\\"\\\" ; .balign 8 ; .quad x86_spec_ctrl_cur=\nrent ; .previous\");\n>\n> And the __seg_gs magic happens only in the per CPU accessor itself:\n>\n> __attribute__((__noinline__)) __attribute__((no_instrument_function))\n>  __attribute((__section__(\".noinstr.text\")))\n>  __attribute__((__no_sanitize_address__))\n>  __attribute__((__no_profile_instrument_function__))\n>  u64 spec_ctrl_current(void)\n> {\n>  return ({\n>     // this_cpu_read(x86_spec_ctrl_current)\n>\n>     typeof(x86_spec_ctrl_current) pscr_ret__;\n>\n>     do { const void *__vpp_verify =3D (typeof((&(x86_spec_ctrl_current)) =\n+ 0))((void *)0); (void)__vpp_verify;\n>     } while (0);\n>\n>     switch(sizeof(x86_spec_ctrl_current))\n>     {\n>     case 1: pscr_ret__ =3D ({\n>             *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*=\n&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current));=\n });\n>             break;\n>     case 2: pscr_ret__ =3D ({\n>             *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*=\n&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current));=\n });\n>             break;\n>     case 4: pscr_ret__ =3D ({\n>             *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*=\n&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current));=\n });\n>             break;\n>     case 8: pscr_ret__ =3D ({\n>             *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*=\n&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current));=\n });\n>             break;\n>\n>     default: __bad_size_call_parameter(); break;\n>     }\n>\n>     pscr_ret__;\n>   });\n> }\n>\n> So all the export etc. just works because it all operates on a plain\n> data type and the __seg_gs is only bolted on via type casts in the\n> accessors.\n>\n> As the per cpu variables are in the .data..percpu section the linker\n> puts them at address 0 and upwards. So the cast to a __seg_gs pointer\n> makes it end up at the real kernel address because of GSBASE + \"offset\".\n>\n> The compiler converts this to RIP relative addressing:\n>\n>   movq   $0x0,%gs:0x7e14169f(%rip)        # 1ba08 <fpu_fpregs_owner_ctx>\n>\n> This obviously has a downside. If I do:\n>\n>    u64 foo;\n>\n>    this_cpu_read(foo);\n>\n> the compiler is just happy to build that w/o complaining and it will\n> only explode at runtime because foo is a kernel data address which added\n> to GSBASE will result in accessing some random address:\n>\n>   mov    %gs:0x15d08d4(%rip),%rax        # ffffffff834aac60 <x86_spec_ctr=\nl_base>\n>\n> This is not at all different from the inline ASM based version which is\n> in your tree. The only difference is that the macro maze is pure C and\n> the __set_gs cast allows the compiler to (micro) optimize, e.g. 'mov\n> %gs:...; movzbl' into a single 'movzbl'.\n>\n> IOW, right now the only defense against such a mistake is actually the\n> sparse check. Maybe one of the coccinelle scripts has something similar,\n> I don't know.\n>\n> I did not follow the __set_gs work closely,",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/170949253630240.mbox",
          "message_id": "<CAFULd4bVEUBEidTLbHNzRaJbSjXm99yC8LT=jdzFWb7xnuFH7g () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 19:03:56+00:00",
          "date_str": "Sun, 03 Mar 2024 19:03:56 +0000",
          "body": "On Sun, Mar 3, 2024 at 5:31=E2=80=AFPM Thomas Gleixner <tglx@linutronix.de>=\n wrote:\n>\n> On Sat, Mar 02 2024 at 14:49, Linus Torvalds wrote:\n> > On Sat, 2 Mar 2024 at 14:00, Thomas Gleixner <tglx@linutronix.de> wrote=\n:\n> >>\n> >> I had commented out both. But the real reason is the EXPORT_SYMBOL,\n> >> which obviously wants to be EXPORT_PER_CPU_SYMBOL_GPL...\n> >\n> > Side note: while it's nice to hear that sparse kind of got this right,\n> > I wonder what gcc does when we start using the named address spaces\n> > for percpu variables.\n> >\n> > We actively make EXPORT_PER_CPU_SYMBOL_XYZ be a no-op for sparse\n> > exactly because sparse ended up warning about the regular\n> > EXPORT_SYMBOL, and we didn't have any \"real\" per-cpu export model.\n>\n> Right.\n>\n> > So EXPORT_PER_CPU_SYMBOL_GPL() is kind of an artificial \"shut up\n> > sparse\".\n>\n> Aside of that it's also making it clear what this is about. So I don't\n> think it's purely artifical.\n>\n> > But with __seg_gs/fs support for native percpu symbols with\n> > gcc, I wonder if we'll hit the same thing. Or is there something that\n> > makes gcc not warn about the named address spaces?\n>\n> Right now the pending code in tip does not complain about the\n> EXPORT_PER_CPU_SYMBOL_GPL() part because our current macro maze is\n> hideous. Here is the preprocessor output.\n>\n> This is DECLARE_PER_CPU() in the header:\n>\n> extern __attribute__((section(\".data..percpu\" \"\"))) __typeof__(u64) x86_s=\npec_ctrl_current;\n>\n> Here is DEFINE_PER_CPU():\n>\n> __attribute__((section(\".data..percpu\" \"\"))) __typeof__(u64) x86_spec_ctr=\nl_current;\n>\n> And the EXPORT:\n>\n> extern typeof(x86_spec_ctrl_current) x86_spec_ctrl_current;\n>\n> static void * __attribute__((__used__))\n>    __attribute__((__section__(\".discard.addressable\")))\n>    __UNIQUE_ID___addressable_x86_spec_ctrl_current804 =3D (void *)(uintpt=\nr_t)&x86_spec_ctrl_current;\n>\n>    asm(\".section \\\".export_symbol\\\",\\\"a\\\" ;\n>        __export_symbol_x86_spec_ctrl_current: ;\n>        .asciz \\\"GPL\\\" ; .asciz \\\"\\\" ; .balign 8 ; .quad x86_spec_ctrl_cur=\nrent ; .previous\");\n>\n> And the __seg_gs magic happens only in the per CPU accessor itself:\n>\n> __attribute__((__noinline__)) __attribute__((no_instrument_function))\n>  __attribute((__section__(\".noinstr.text\")))\n>  __attribute__((__no_sanitize_address__))\n>  __attribute__((__no_profile_instrument_function__))\n>  u64 spec_ctrl_current(void)\n> {\n>  return ({\n>     // this_cpu_read(x86_spec_ctrl_current)\n>\n>     typeof(x86_spec_ctrl_current) pscr_ret__;\n>\n>     do { const void *__vpp_verify =3D (typeof((&(x86_spec_ctrl_current)) =\n+ 0))((void *)0); (void)__vpp_verify;\n>     } while (0);\n>\n>     switch(sizeof(x86_spec_ctrl_current))\n>     {\n>     case 1: pscr_ret__ =3D ({\n>             *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*=\n&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current));=\n });\n>             break;\n>     case 2: pscr_ret__ =3D ({\n>             *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*=\n&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current));=\n });\n>             break;\n>     case 4: pscr_ret__ =3D ({\n>             *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*=\n&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current));=\n });\n>             break;\n>     case 8: pscr_ret__ =3D ({\n>             *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*=\n&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current));=\n });\n>             break;\n>\n>     default: __bad_size_call_parameter(); break;\n>     }\n>\n>     pscr_ret__;\n>   });\n> }\n>\n> So all the export etc. just works because it all operates on a plain\n> data type and the __seg_gs is only bolted on via type casts in the\n> accessors.\n>\n> As the per cpu variables are in the .data..percpu section the linker\n> puts them at address 0 and upwards. So the cast to a __seg_gs pointer\n> makes it end up at the real kernel address because of GSBASE + \"offset\".\n>\n> The compiler converts this to RIP relative addressing:\n>\n>   movq   $0x0,%gs:0x7e14169f(%rip)        # 1ba08 <fpu_fpregs_owner_ctx>\n>\n> This obviously has a downside. If I do:\n>\n>    u64 foo;\n>\n>    this_cpu_read(foo);\n>\n> the compiler is just happy to build that w/o complaining and it will\n> only explode at runtime because foo is a kernel data address which added\n> to GSBASE will result in accessing some random address:\n>\n>   mov    %gs:0x15d08d4(%rip),%rax        # ffffffff834aac60 <x86_spec_ctr=\nl_base>\n>\n> This is not at all different from the inline ASM based version which is\n> in your tree. The only difference is that the macro maze is pure C and\n> the __set_gs cast allows the compiler to (micro) optimize, e.g. 'mov\n> %gs:...; movzbl' into a single 'movzbl'.\n>\n> IOW, right now the only defense against such a mistake is actually the\n> sparse check. Maybe one of the coccinelle scripts has something similar,\n> I don't know.\n>\n> I did not follow the __set_gs work closely,",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/04/170949253430237.mbox",
          "message_id": "<CAFULd4bVEUBEidTLbHNzRaJbSjXm99yC8LT=jdzFWb7xnuFH7g () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 19:03:56+00:00",
          "date_str": "Sun, 03 Mar 2024 19:03:56 +0000",
          "body": "On Sun, Mar 3, 2024 at 5:31=E2=80=AFPM Thomas Gleixner <tglx@linutronix.de>=\n wrote:\n>\n> On Sat, Mar 02 2024 at 14:49, Linus Torvalds wrote:\n> > On Sat, 2 Mar 2024 at 14:00, Thomas Gleixner <tglx@linutronix.de> wrote=\n:\n> >>\n> >> I had commented out both. But the real reason is the EXPORT_SYMBOL,\n> >> which obviously wants to be EXPORT_PER_CPU_SYMBOL_GPL...\n> >\n> > Side note: while it's nice to hear that sparse kind of got this right,\n> > I wonder what gcc does when we start using the named address spaces\n> > for percpu variables.\n> >\n> > We actively make EXPORT_PER_CPU_SYMBOL_XYZ be a no-op for sparse\n> > exactly because sparse ended up warning about the regular\n> > EXPORT_SYMBOL, and we didn't have any \"real\" per-cpu export model.\n>\n> Right.\n>\n> > So EXPORT_PER_CPU_SYMBOL_GPL() is kind of an artificial \"shut up\n> > sparse\".\n>\n> Aside of that it's also making it clear what this is about. So I don't\n> think it's purely artifical.\n>\n> > But with __seg_gs/fs support for native percpu symbols with\n> > gcc, I wonder if we'll hit the same thing. Or is there something that\n> > makes gcc not warn about the named address spaces?\n>\n> Right now the pending code in tip does not complain about the\n> EXPORT_PER_CPU_SYMBOL_GPL() part because our current macro maze is\n> hideous. Here is the preprocessor output.\n>\n> This is DECLARE_PER_CPU() in the header:\n>\n> extern __attribute__((section(\".data..percpu\" \"\"))) __typeof__(u64) x86_s=\npec_ctrl_current;\n>\n> Here is DEFINE_PER_CPU():\n>\n> __attribute__((section(\".data..percpu\" \"\"))) __typeof__(u64) x86_spec_ctr=\nl_current;\n>\n> And the EXPORT:\n>\n> extern typeof(x86_spec_ctrl_current) x86_spec_ctrl_current;\n>\n> static void * __attribute__((__used__))\n>    __attribute__((__section__(\".discard.addressable\")))\n>    __UNIQUE_ID___addressable_x86_spec_ctrl_current804 =3D (void *)(uintpt=\nr_t)&x86_spec_ctrl_current;\n>\n>    asm(\".section \\\".export_symbol\\\",\\\"a\\\" ;\n>        __export_symbol_x86_spec_ctrl_current: ;\n>        .asciz \\\"GPL\\\" ; .asciz \\\"\\\" ; .balign 8 ; .quad x86_spec_ctrl_cur=\nrent ; .previous\");\n>\n> And the __seg_gs magic happens only in the per CPU accessor itself:\n>\n> __attribute__((__noinline__)) __attribute__((no_instrument_function))\n>  __attribute((__section__(\".noinstr.text\")))\n>  __attribute__((__no_sanitize_address__))\n>  __attribute__((__no_profile_instrument_function__))\n>  u64 spec_ctrl_current(void)\n> {\n>  return ({\n>     // this_cpu_read(x86_spec_ctrl_current)\n>\n>     typeof(x86_spec_ctrl_current) pscr_ret__;\n>\n>     do { const void *__vpp_verify =3D (typeof((&(x86_spec_ctrl_current)) =\n+ 0))((void *)0); (void)__vpp_verify;\n>     } while (0);\n>\n>     switch(sizeof(x86_spec_ctrl_current))\n>     {\n>     case 1: pscr_ret__ =3D ({\n>             *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*=\n&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current));=\n });\n>             break;\n>     case 2: pscr_ret__ =3D ({\n>             *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*=\n&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current));=\n });\n>             break;\n>     case 4: pscr_ret__ =3D ({\n>             *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*=\n&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current));=\n });\n>             break;\n>     case 8: pscr_ret__ =3D ({\n>             *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*=\n&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current));=\n });\n>             break;\n>\n>     default: __bad_size_call_parameter(); break;\n>     }\n>\n>     pscr_ret__;\n>   });\n> }\n>\n> So all the export etc. just works because it all operates on a plain\n> data type and the __seg_gs is only bolted on via type casts in the\n> accessors.\n>\n> As the per cpu variables are in the .data..percpu section the linker\n> puts them at address 0 and upwards. So the cast to a __seg_gs pointer\n> makes it end up at the real kernel address because of GSBASE + \"offset\".\n>\n> The compiler converts this to RIP relative addressing:\n>\n>   movq   $0x0,%gs:0x7e14169f(%rip)        # 1ba08 <fpu_fpregs_owner_ctx>\n>\n> This obviously has a downside. If I do:\n>\n>    u64 foo;\n>\n>    this_cpu_read(foo);\n>\n> the compiler is just happy to build that w/o complaining and it will\n> only explode at runtime because foo is a kernel data address which added\n> to GSBASE will result in accessing some random address:\n>\n>   mov    %gs:0x15d08d4(%rip),%rax        # ffffffff834aac60 <x86_spec_ctr=\nl_base>\n>\n> This is not at all different from the inline ASM based version which is\n> in your tree. The only difference is that the macro maze is pure C and\n> the __set_gs cast allows the compiler to (micro) optimize, e.g. 'mov\n> %gs:...; movzbl' into a single 'movzbl'.\n>\n> IOW, right now the only defense against such a mistake is actually the\n> sparse check. Maybe one of the coccinelle scripts has something similar,\n> I don't know.\n>\n> I did not follow the __set_gs work closely,",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/04/170949253630240.mbox",
          "message_id": "<CAFULd4bVEUBEidTLbHNzRaJbSjXm99yC8LT=jdzFWb7xnuFH7g () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 19:03:56+00:00",
          "date_str": "Sun, 03 Mar 2024 19:03:56 +0000",
          "body": "On Sun, Mar 3, 2024 at 5:31=E2=80=AFPM Thomas Gleixner <tglx@linutronix.de>=\n wrote:\n>\n> On Sat, Mar 02 2024 at 14:49, Linus Torvalds wrote:\n> > On Sat, 2 Mar 2024 at 14:00, Thomas Gleixner <tglx@linutronix.de> wrote=\n:\n> >>\n> >> I had commented out both. But the real reason is the EXPORT_SYMBOL,\n> >> which obviously wants to be EXPORT_PER_CPU_SYMBOL_GPL...\n> >\n> > Side note: while it's nice to hear that sparse kind of got this right,\n> > I wonder what gcc does when we start using the named address spaces\n> > for percpu variables.\n> >\n> > We actively make EXPORT_PER_CPU_SYMBOL_XYZ be a no-op for sparse\n> > exactly because sparse ended up warning about the regular\n> > EXPORT_SYMBOL, and we didn't have any \"real\" per-cpu export model.\n>\n> Right.\n>\n> > So EXPORT_PER_CPU_SYMBOL_GPL() is kind of an artificial \"shut up\n> > sparse\".\n>\n> Aside of that it's also making it clear what this is about. So I don't\n> think it's purely artifical.\n>\n> > But with __seg_gs/fs support for native percpu symbols with\n> > gcc, I wonder if we'll hit the same thing. Or is there something that\n> > makes gcc not warn about the named address spaces?\n>\n> Right now the pending code in tip does not complain about the\n> EXPORT_PER_CPU_SYMBOL_GPL() part because our current macro maze is\n> hideous. Here is the preprocessor output.\n>\n> This is DECLARE_PER_CPU() in the header:\n>\n> extern __attribute__((section(\".data..percpu\" \"\"))) __typeof__(u64) x86_s=\npec_ctrl_current;\n>\n> Here is DEFINE_PER_CPU():\n>\n> __attribute__((section(\".data..percpu\" \"\"))) __typeof__(u64) x86_spec_ctr=\nl_current;\n>\n> And the EXPORT:\n>\n> extern typeof(x86_spec_ctrl_current) x86_spec_ctrl_current;\n>\n> static void * __attribute__((__used__))\n>    __attribute__((__section__(\".discard.addressable\")))\n>    __UNIQUE_ID___addressable_x86_spec_ctrl_current804 =3D (void *)(uintpt=\nr_t)&x86_spec_ctrl_current;\n>\n>    asm(\".section \\\".export_symbol\\\",\\\"a\\\" ;\n>        __export_symbol_x86_spec_ctrl_current: ;\n>        .asciz \\\"GPL\\\" ; .asciz \\\"\\\" ; .balign 8 ; .quad x86_spec_ctrl_cur=\nrent ; .previous\");\n>\n> And the __seg_gs magic happens only in the per CPU accessor itself:\n>\n> __attribute__((__noinline__)) __attribute__((no_instrument_function))\n>  __attribute((__section__(\".noinstr.text\")))\n>  __attribute__((__no_sanitize_address__))\n>  __attribute__((__no_profile_instrument_function__))\n>  u64 spec_ctrl_current(void)\n> {\n>  return ({\n>     // this_cpu_read(x86_spec_ctrl_current)\n>\n>     typeof(x86_spec_ctrl_current) pscr_ret__;\n>\n>     do { const void *__vpp_verify =3D (typeof((&(x86_spec_ctrl_current)) =\n+ 0))((void *)0); (void)__vpp_verify;\n>     } while (0);\n>\n>     switch(sizeof(x86_spec_ctrl_current))\n>     {\n>     case 1: pscr_ret__ =3D ({\n>             *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*=\n&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current));=\n });\n>             break;\n>     case 2: pscr_ret__ =3D ({\n>             *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*=\n&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current));=\n });\n>             break;\n>     case 4: pscr_ret__ =3D ({\n>             *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*=\n&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current));=\n });\n>             break;\n>     case 8: pscr_ret__ =3D ({\n>             *(volatile typeof(x86_spec_ctrl_current) __seg_gs *)(typeof(*=\n&(x86_spec_ctrl_current)) __seg_gs *)(uintptr_t)(&(x86_spec_ctrl_current));=\n });\n>             break;\n>\n>     default: __bad_size_call_parameter(); break;\n>     }\n>\n>     pscr_ret__;\n>   });\n> }\n>\n> So all the export etc. just works because it all operates on a plain\n> data type and the __seg_gs is only bolted on via type casts in the\n> accessors.\n>\n> As the per cpu variables are in the .data..percpu section the linker\n> puts them at address 0 and upwards. So the cast to a __seg_gs pointer\n> makes it end up at the real kernel address because of GSBASE + \"offset\".\n>\n> The compiler converts this to RIP relative addressing:\n>\n>   movq   $0x0,%gs:0x7e14169f(%rip)        # 1ba08 <fpu_fpregs_owner_ctx>\n>\n> This obviously has a downside. If I do:\n>\n>    u64 foo;\n>\n>    this_cpu_read(foo);\n>\n> the compiler is just happy to build that w/o complaining and it will\n> only explode at runtime because foo is a kernel data address which added\n> to GSBASE will result in accessing some random address:\n>\n>   mov    %gs:0x15d08d4(%rip),%rax        # ffffffff834aac60 <x86_spec_ctr=\nl_base>\n>\n> This is not at all different from the inline ASM based version which is\n> in your tree. The only difference is that the macro maze is pure C and\n> the __set_gs cast allows the compiler to (micro) optimize, e.g. 'mov\n> %gs:...; movzbl' into a single 'movzbl'.\n>\n> IOW, right now the only defense against such a mistake is actually the\n> sparse check. Maybe one of the coccinelle scripts has something similar,\n> I don't know.\n>\n> I did not follow the __set_gs work closely,",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/03/170949654531977.mbox",
          "message_id": "<87bk7vuldh.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 20:10:50+00:00",
          "date_str": "Sun, 03 Mar 2024 20:10:50 +0000",
          "body": "On Sun, Mar 03 2024 at 20:03, Uros Bizjak wrote:\n> On Sun, Mar 3, 2024 at 5:31=E2=80=AFPM Thomas Gleixner <tglx@linutronix.d=\ne> wrote:\n>> I did not follow the __set_gs work closely, so I don't know whether Uros\n>> ever tried to actually mark the per CPU variable __set_gs right away,\n>> which would obviously catch the above 'foo' nonsense.\n>\n> No, because [1]:\n>\n> \"gcc does not provide a way to remove segment qualifiers, which is needed\n> to use typeof() to create local instances of the per-cpu variable. For\n> this reason, do not use the segment qualifier for per-cpu variables, and\n> do casting using the segment qualifier instead.\"\n\nRight. I just figured that out myself when playing with it in user\nspace.\n\nThat's so sad because it would provide us compiler based __percpu\nvalidation.\n\nRight now this simply does not work and __verify_pcp_ptr(ptr) is not\ndoing anything except when sparse looks at it.\n\nSigh.\n\n        tglx\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/170949654431976.mbox",
          "message_id": "<87bk7vuldh.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 20:10:50+00:00",
          "date_str": "Sun, 03 Mar 2024 20:10:50 +0000",
          "body": "On Sun, Mar 03 2024 at 20:03, Uros Bizjak wrote:\n> On Sun, Mar 3, 2024 at 5:31=E2=80=AFPM Thomas Gleixner <tglx@linutronix.d=\ne> wrote:\n>> I did not follow the __set_gs work closely, so I don't know whether Uros\n>> ever tried to actually mark the per CPU variable __set_gs right away,\n>> which would obviously catch the above 'foo' nonsense.\n>\n> No, because [1]:\n>\n> \"gcc does not provide a way to remove segment qualifiers, which is needed\n> to use typeof() to create local instances of the per-cpu variable. For\n> this reason, do not use the segment qualifier for per-cpu variables, and\n> do casting using the segment qualifier instead.\"\n\nRight. I just figured that out myself when playing with it in user\nspace.\n\nThat's so sad because it would provide us compiler based __percpu\nvalidation.\n\nRight now this simply does not work and __verify_pcp_ptr(ptr) is not\ndoing anything except when sparse looks at it.\n\nSigh.\n\n        tglx\n\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/04/170949654431976.mbox",
          "message_id": "<87bk7vuldh.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 20:10:50+00:00",
          "date_str": "Sun, 03 Mar 2024 20:10:50 +0000",
          "body": "On Sun, Mar 03 2024 at 20:03, Uros Bizjak wrote:\n> On Sun, Mar 3, 2024 at 5:31=E2=80=AFPM Thomas Gleixner <tglx@linutronix.d=\ne> wrote:\n>> I did not follow the __set_gs work closely, so I don't know whether Uros\n>> ever tried to actually mark the per CPU variable __set_gs right away,\n>> which would obviously catch the above 'foo' nonsense.\n>\n> No, because [1]:\n>\n> \"gcc does not provide a way to remove segment qualifiers, which is needed\n> to use typeof() to create local instances of the per-cpu variable. For\n> this reason, do not use the segment qualifier for per-cpu variables, and\n> do casting using the segment qualifier instead.\"\n\nRight. I just figured that out myself when playing with it in user\nspace.\n\nThat's so sad because it would provide us compiler based __percpu\nvalidation.\n\nRight now this simply does not work and __verify_pcp_ptr(ptr) is not\ndoing anything except when sparse looks at it.\n\nSigh.\n\n        tglx\n\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/03/170949718732165.mbox",
          "message_id": "<CAFULd4arHT+_fy9_oUNpmsvyfVPGaeB_pdeuqVS3UTpP5R757A () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 20:21:21+00:00",
          "date_str": "Sun, 03 Mar 2024 20:21:21 +0000",
          "body": "On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutronix.de>=\n wrote:\n>\n> On Sun, Mar 03 2024 at 20:03, Uros Bizjak wrote:\n> > On Sun, Mar 3, 2024 at 5:31=E2=80=AFPM Thomas Gleixner <tglx@linutronix=\nde> wrote:\n> >> I did not follow the __set_gs work closely, so I don't know whether Ur=\nos\n> >> ever tried to actually mark the per CPU variable __set_gs right away,\n> >> which would obviously catch the above 'foo' nonsense.\n> >\n> > No, because [1]:\n> >\n> > \"gcc does not provide a way to remove segment qualifiers, which is need=\ned\n> > to use typeof() to create local instances of the per-cpu variable. For\n> > this reason, do not use the segment qualifier for per-cpu variables, an=\nd\n> > do casting using the segment qualifier instead.\"\n>\n> Right. I just figured that out myself when playing with it in user\n> space.\n>\n> That's so sad because it would provide us compiler based __percpu\n> validation.\n\nUnfortunately, the c compiler can't strip qualifiers, so typeof() is\nof limited use also when const and volatile qualifiers are used.\nPerhaps some extension could be introduced to c standard to provide an\nunqualified type, e.g. typeof_unqual().\n\nUros.\n\n> Right now this simply does not work and __verify_pcp_ptr(ptr) is not\n> doing anything except when sparse looks at it.\n>\n> Sigh.\n>\n>         tglx\n>\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/04/170949718732165.mbox",
          "message_id": "<CAFULd4arHT+_fy9_oUNpmsvyfVPGaeB_pdeuqVS3UTpP5R757A () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 20:21:21+00:00",
          "date_str": "Sun, 03 Mar 2024 20:21:21 +0000",
          "body": "On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutronix.de>=\n wrote:\n>\n> On Sun, Mar 03 2024 at 20:03, Uros Bizjak wrote:\n> > On Sun, Mar 3, 2024 at 5:31=E2=80=AFPM Thomas Gleixner <tglx@linutronix=\nde> wrote:\n> >> I did not follow the __set_gs work closely, so I don't know whether Ur=\nos\n> >> ever tried to actually mark the per CPU variable __set_gs right away,\n> >> which would obviously catch the above 'foo' nonsense.\n> >\n> > No, because [1]:\n> >\n> > \"gcc does not provide a way to remove segment qualifiers, which is need=\ned\n> > to use typeof() to create local instances of the per-cpu variable. For\n> > this reason, do not use the segment qualifier for per-cpu variables, an=\nd\n> > do casting using the segment qualifier instead.\"\n>\n> Right. I just figured that out myself when playing with it in user\n> space.\n>\n> That's so sad because it would provide us compiler based __percpu\n> validation.\n\nUnfortunately, the c compiler can't strip qualifiers, so typeof() is\nof limited use also when const and volatile qualifiers are used.\nPerhaps some extension could be introduced to c standard to provide an\nunqualified type, e.g. typeof_unqual().\n\nUros.\n\n> Right now this simply does not work and __verify_pcp_ptr(ptr) is not\n> doing anything except when sparse looks at it.\n>\n> Sigh.\n>\n>         tglx\n>\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/04/170949718332162.mbox",
          "message_id": "<CAFULd4arHT+_fy9_oUNpmsvyfVPGaeB_pdeuqVS3UTpP5R757A () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 20:21:21+00:00",
          "date_str": "Sun, 03 Mar 2024 20:21:21 +0000",
          "body": "On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutronix.de>=\n wrote:\n>\n> On Sun, Mar 03 2024 at 20:03, Uros Bizjak wrote:\n> > On Sun, Mar 3, 2024 at 5:31=E2=80=AFPM Thomas Gleixner <tglx@linutronix=\n.de> wrote:\n> >> I did not follow the __set_gs work closely, so I don't know whether Ur=\nos\n> >> ever tried to actually mark the per CPU variable __set_gs right away,\n> >> which would obviously catch the above 'foo' nonsense.\n> >\n> > No, because [1]:\n> >\n> > \"gcc does not provide a way to remove segment qualifiers, which is need=\ned\n> > to use typeof() to create local instances of the per-cpu variable. For\n> > this reason, do not use the segment qualifier for per-cpu variables, an=\nd\n> > do casting using the segment qualifier instead.\"\n>\n> Right. I just figured that out myself when playing with it in user\n> space.\n>\n> That's so sad because it would provide us compiler based __percpu\n> validation.\n\nUnfortunately, the c compiler can't strip qualifiers, so typeof() is\nof limited use also when const and volatile qualifiers are used.\nPerhaps some extension could be introduced to c standard to provide an\nunqualified type, e.g. typeof_unqual().\n\nUros.\n\n> Right now this simply does not work and __verify_pcp_ptr(ptr) is not\n> doing anything except when sparse looks at it.\n>\n> Sigh.\n>\n>         tglx\n>\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/03/170949734432238.mbox",
          "message_id": "<CAFULd4b0HN6eUJsOW6po8Hf16T3eMhjdKUvw-TS8yncNn-+Vyw () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 20:24:00+00:00",
          "date_str": "Sun, 03 Mar 2024 20:24:00 +0000",
          "body": "On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> wrot=\ne:\n>\n> On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutronix.d=\ne> wrote:\n> >\n> > On Sun, Mar 03 2024 at 20:03, Uros Bizjak wrote:\n> > > On Sun, Mar 3, 2024 at 5:31=E2=80=AFPM Thomas Gleixner <tglx@linutron=\nix.de> wrote:\n> > >> I did not follow the __set_gs work closely, so I don't know whether =\nUros\n> > >> ever tried to actually mark the per CPU variable __set_gs right away=\n,\n> > >> which would obviously catch the above 'foo' nonsense.\n> > >\n> > > No, because [1]:\n> > >\n> > > \"gcc does not provide a way to remove segment qualifiers, which is ne=\neded\n> > > to use typeof() to create local instances of the per-cpu variable. Fo=\nr\n> > > this reason, do not use the segment qualifier for per-cpu variables, =\nand\n> > > do casting using the segment qualifier instead.\"\n> >\n> > Right. I just figured that out myself when playing with it in user\n> > space.\n> >\n> > That's so sad because it would provide us compiler based __percpu\n> > validation.\n>\n> Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n> of limited use also when const and volatile qualifiers are used.\n> Perhaps some extension could be introduced to c standard to provide an\n> unqualified type, e.g. typeof_unqual().\n\nOh, there is one in C23 [1].\n\n[1] https://en.cppreference.com/w/c/language/typeof\n\nUros.\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/170949734432236.mbox",
          "message_id": "<CAFULd4b0HN6eUJsOW6po8Hf16T3eMhjdKUvw-TS8yncNn-+Vyw () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 20:24:00+00:00",
          "date_str": "Sun, 03 Mar 2024 20:24:00 +0000",
          "body": "On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> wrot=\ne:\n>\n> On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutronix.d=\ne> wrote:\n> >\n> > On Sun, Mar 03 2024 at 20:03, Uros Bizjak wrote:\n> > > On Sun, Mar 3, 2024 at 5:31=E2=80=AFPM Thomas Gleixner <tglx@linutron=\nix.de> wrote:\n> > >> I did not follow the __set_gs work closely, so I don't know whether =\nUros\n> > >> ever tried to actually mark the per CPU variable __set_gs right away=\n,\n> > >> which would obviously catch the above 'foo' nonsense.\n> > >\n> > > No, because [1]:\n> > >\n> > > \"gcc does not provide a way to remove segment qualifiers, which is ne=\neded\n> > > to use typeof() to create local instances of the per-cpu variable. Fo=\nr\n> > > this reason, do not use the segment qualifier for per-cpu variables, =\nand\n> > > do casting using the segment qualifier instead.\"\n> >\n> > Right. I just figured that out myself when playing with it in user\n> > space.\n> >\n> > That's so sad because it would provide us compiler based __percpu\n> > validation.\n>\n> Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n> of limited use also when const and volatile qualifiers are used.\n> Perhaps some extension could be introduced to c standard to provide an\n> unqualified type, e.g. typeof_unqual().\n\nOh, there is one in C23 [1].\n\n[1] https://en.cppreference.com/w/c/language/typeof\n\nUros.\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/04/170949734432238.mbox",
          "message_id": "<CAFULd4b0HN6eUJsOW6po8Hf16T3eMhjdKUvw-TS8yncNn-+Vyw () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 20:24:00+00:00",
          "date_str": "Sun, 03 Mar 2024 20:24:00 +0000",
          "body": "On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> wrot=\ne:\n>\n> On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutronix.d=\ne> wrote:\n> >\n> > On Sun, Mar 03 2024 at 20:03, Uros Bizjak wrote:\n> > > On Sun, Mar 3, 2024 at 5:31=E2=80=AFPM Thomas Gleixner <tglx@linutron=\nix.de> wrote:\n> > >> I did not follow the __set_gs work closely, so I don't know whether =\nUros\n> > >> ever tried to actually mark the per CPU variable __set_gs right away=\n,\n> > >> which would obviously catch the above 'foo' nonsense.\n> > >\n> > > No, because [1]:\n> > >\n> > > \"gcc does not provide a way to remove segment qualifiers, which is ne=\neded\n> > > to use typeof() to create local instances of the per-cpu variable. Fo=\nr\n> > > this reason, do not use the segment qualifier for per-cpu variables, =\nand\n> > > do casting using the segment qualifier instead.\"\n> >\n> > Right. I just figured that out myself when playing with it in user\n> > space.\n> >\n> > That's so sad because it would provide us compiler based __percpu\n> > validation.\n>\n> Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n> of limited use also when const and volatile qualifiers are used.\n> Perhaps some extension could be introduced to c standard to provide an\n> unqualified type, e.g. typeof_unqual().\n\nOh, there is one in C23 [1].\n\n[1] https://en.cppreference.com/w/c/language/typeof\n\nUros.\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/03/170950069301081.mbox",
          "message_id": "<CAFULd4ZQwhASjvfya6eYv+9hMf=aQmSpW0wLSKPES4DRm0qeWQ () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 21:19:50+00:00",
          "date_str": "Sun, 03 Mar 2024 21:19:50 +0000",
          "body": "On Sun, Mar 3, 2024 at 9:24=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> wrot=\ne:\n>\n> On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> wr=\note:\n> >\n> > On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutronix=\n.de> wrote:\n> > >\n> > > On Sun, Mar 03 2024 at 20:03, Uros Bizjak wrote:\n> > > > On Sun, Mar 3, 2024 at 5:31=E2=80=AFPM Thomas Gleixner <tglx@linutr=\nonix.de> wrote:\n> > > >> I did not follow the __set_gs work closely, so I don't know whethe=\nr Uros\n> > > >> ever tried to actually mark the per CPU variable __set_gs right aw=\nay,\n> > > >> which would obviously catch the above 'foo' nonsense.\n> > > >\n> > > > No, because [1]:\n> > > >\n> > > > \"gcc does not provide a way to remove segment qualifiers, which is =\nneeded\n> > > > to use typeof() to create local instances of the per-cpu variable. =\nFor\n> > > > this reason, do not use the segment qualifier for per-cpu variables=\n, and\n> > > > do casting using the segment qualifier instead.\"\n> > >\n> > > Right. I just figured that out myself when playing with it in user\n> > > space.\n> > >\n> > > That's so sad because it would provide us compiler based __percpu\n> > > validation.\n> >\n> > Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n> > of limited use also when const and volatile qualifiers are used.\n> > Perhaps some extension could be introduced to c standard to provide an\n> > unqualified type, e.g. typeof_unqual().\n>\n> Oh, there is one in C23 [1].\n>\n> [1] https://en.cppreference.com/w/c/language/typeof\n\nFYI: gcc-14 compiles this testcase:\n\n--cut here--\n__seg_gs int a;\n__typeof_unqual__(a) b;\n\nint foo (void)\n{\n  return a;\n}\n\nint bar (void)\n{\n  return b;\n}\n--cut here--\n\nto (gcc -O2):\n\nfoo:\n       movl    %gs:a(%rip), %eax\n       ret\n\nbar:\n       movl    b(%rip), %eax\n       ret\n\nSo, it *does* strip the __seg_gs qualifier here.\n\nUros.\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/04/170950069401084.mbox",
          "message_id": "<CAFULd4ZQwhASjvfya6eYv+9hMf=aQmSpW0wLSKPES4DRm0qeWQ () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 21:19:50+00:00",
          "date_str": "Sun, 03 Mar 2024 21:19:50 +0000",
          "body": "On Sun, Mar 3, 2024 at 9:24=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> wrot=\ne:\n>\n> On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> wr=\note:\n> >\n> > On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutronix=\nde> wrote:\n> > >\n> > > On Sun, Mar 03 2024 at 20:03, Uros Bizjak wrote:\n> > > > On Sun, Mar 3, 2024 at 5:31=E2=80=AFPM Thomas Gleixner <tglx@linutr=\nonix.de> wrote:\n> > > >> I did not follow the __set_gs work closely, so I don't know whethe=\nr Uros\n> > > >> ever tried to actually mark the per CPU variable __set_gs right aw=\nay,\n> > > >> which would obviously catch the above 'foo' nonsense.\n> > > >\n> > > > No, because [1]:\n> > > >\n> > > > \"gcc does not provide a way to remove segment qualifiers, which is =\nneeded\n> > > > to use typeof() to create local instances of the per-cpu variable. =\nFor\n> > > > this reason, do not use the segment qualifier for per-cpu variables=\n, and\n> > > > do casting using the segment qualifier instead.\"\n> > >\n> > > Right. I just figured that out myself when playing with it in user\n> > > space.\n> > >\n> > > That's so sad because it would provide us compiler based __percpu\n> > > validation.\n> >\n> > Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n> > of limited use also when const and volatile qualifiers are used.\n> > Perhaps some extension could be introduced to c standard to provide an\n> > unqualified type, e.g. typeof_unqual().\n>\n> Oh, there is one in C23 [1].\n>\n> [1] https://en.cppreference.com/w/c/language/typeof\n\nFYI: gcc-14 compiles this testcase:\n\n--cut here--\n__seg_gs int a;\n__typeof_unqual__(a) b;\n\nint foo (void)\n{\n  return a;\n}\n\nint bar (void)\n{\n  return b;\n}\n--cut here--\n\nto (gcc -O2):\n\nfoo:\n       movl    %gs:a(%rip), %eax\n       ret\n\nbar:\n       movl    b(%rip), %eax\n       ret\n\nSo, it *does* strip the __seg_gs qualifier here.\n\nUros.\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/04/170950069301081.mbox",
          "message_id": "<CAFULd4ZQwhASjvfya6eYv+9hMf=aQmSpW0wLSKPES4DRm0qeWQ () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 21:19:50+00:00",
          "date_str": "Sun, 03 Mar 2024 21:19:50 +0000",
          "body": "On Sun, Mar 3, 2024 at 9:24=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> wrot=\ne:\n>\n> On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> wr=\note:\n> >\n> > On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutronix=\n.de> wrote:\n> > >\n> > > On Sun, Mar 03 2024 at 20:03, Uros Bizjak wrote:\n> > > > On Sun, Mar 3, 2024 at 5:31=E2=80=AFPM Thomas Gleixner <tglx@linutr=\nonix.de> wrote:\n> > > >> I did not follow the __set_gs work closely, so I don't know whethe=\nr Uros\n> > > >> ever tried to actually mark the per CPU variable __set_gs right aw=\nay,\n> > > >> which would obviously catch the above 'foo' nonsense.\n> > > >\n> > > > No, because [1]:\n> > > >\n> > > > \"gcc does not provide a way to remove segment qualifiers, which is =\nneeded\n> > > > to use typeof() to create local instances of the per-cpu variable. =\nFor\n> > > > this reason, do not use the segment qualifier for per-cpu variables=\n, and\n> > > > do casting using the segment qualifier instead.\"\n> > >\n> > > Right. I just figured that out myself when playing with it in user\n> > > space.\n> > >\n> > > That's so sad because it would provide us compiler based __percpu\n> > > validation.\n> >\n> > Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n> > of limited use also when const and volatile qualifiers are used.\n> > Perhaps some extension could be introduced to c standard to provide an\n> > unqualified type, e.g. typeof_unqual().\n>\n> Oh, there is one in C23 [1].\n>\n> [1] https://en.cppreference.com/w/c/language/typeof\n\nFYI: gcc-14 compiles this testcase:\n\n--cut here--\n__seg_gs int a;\n__typeof_unqual__(a) b;\n\nint foo (void)\n{\n  return a;\n}\n\nint bar (void)\n{\n  return b;\n}\n--cut here--\n\nto (gcc -O2):\n\nfoo:\n       movl    %gs:a(%rip), %eax\n       ret\n\nbar:\n       movl    b(%rip), %eax\n       ret\n\nSo, it *does* strip the __seg_gs qualifier here.\n\nUros.\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/03/170950964704734.mbox",
          "message_id": "<87bk7ux4e9.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 23:49:18+00:00",
          "date_str": "Sun, 03 Mar 2024 23:49:18 +0000",
          "body": "On Sun, Mar 03 2024 at 21:24, Uros Bizjak wrote:\n> On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> wr=\note:\n>> On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutronix.=\nde> wrote:\n>> > That's so sad because it would provide us compiler based __percpu\n>> > validation.\n>>\n>> Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n>> of limited use also when const and volatile qualifiers are used.\n>> Perhaps some extension could be introduced to c standard to provide an\n>> unqualified type, e.g. typeof_unqual().\n>\n> Oh, there is one in C23 [1].\n\nYes. I found it right after ranting.\n\ngcc >=3D 14 and clang >=3D 16 have support for it of course only when adding\n-std=3Dc2x to the command line.\n\nSigh. The name space qualifiers are non standard and then the thing\nwhich makes them more useful is hidden behind a standard.\n\nWhy can't we have useful tools?\n\nThough the whole thing looks worthwhile:\n\n#define verify_per_cpu_ptr(ptr)\t\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tconst void __seg_gs *__vpp_verify =3D (typeof((ptr) + 0))NULL;    \\\n\t(void)__vpp_verify;\t\t\t\t\t\t\\\n} while (0)\n\n#define per_cpu_ptr(ptr, cpu)\t\t\t\t\t\t\\\n({\t\t\t\t\t\t\t\t\t\\\n\tverify_per_cpu_ptr(ptr);\t\t\t\t\t\\\n\t(typeof_unqual(*(ptr)) *)(uintptr_t)ptr + per_cpu_offset(cpu);\t\\\n})\n\nunsigned int __seg_gs test;\n\nunsigned int foo1(unsigned int cpu)\n{\n\treturn *per_cpu_ptr(&test, cpu);\n}\n\nunsigned int foo2(unsigned int cpu)\n{\n\tunsigned int x, *p =3D per_cpu_ptr(&x, cpu);\n\n\treturn *p;\n}\n\nx.c:29:23: error: initializing 'const __attribute__((address_space(256))) v=\noid *' with an expression of type 'typeof ((&x) + 0)' (aka 'unsigned int *'=\n) changes address space of pointer\n        unsigned int x, *p =3D per_cpu_ptr(&x, cpu);\n\nThat's exactly what we want. It would have caught all the long standing\nand ignored __percpu sparse warnings right away.\n\nThis also simplifies all the other per cpu accessors. The most trivial\nis read()\n\n#define verify_per_cpu(variable)\t\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\tconst unsigned int __s =3D sizeof(variable);\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\tverify_per_cpu_ptr(&(variable));\t\t\t\t\\\n\tBUILD_BUG_ON(__s =3D=3D 1 || __s =3D=3D 2 || __s =3D=3D 4 || __s =3D=3D 8,=\n\t\\\n\t\t     \"Wrong size for per CPU variable\");\t\t\\\n}\n\n#define __pcpu_read(variable)\t\t\t\t\t\t\\\n({\t\t\t\t\t\t\t\t\t\\\n\tverify_per_cpu(variable);\t\t\t\t\t\\\n\tREAD_ONCE(variable);\t\t\t\t\t\t\\\n})\n\nwhich in turn catches all the mistakes, i.e. wrong namespace and wrong\nsize.\n\nI'm really tempted to implement this as an alternative to the current\npile of macro horrors. Of course this requires to figure out first what\nkind of damage -std=3Dc2x will do.\n\nI get to that in my copious spare time some day.\n\nThanks,\n\n        tglx\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/04/170950965004740.mbox",
          "message_id": "<87bk7ux4e9.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 23:49:18+00:00",
          "date_str": "Sun, 03 Mar 2024 23:49:18 +0000",
          "body": "On Sun, Mar 03 2024 at 21:24, Uros Bizjak wrote:\n> On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> wr=\note:\n>> On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutronix.=\nde> wrote:\n>> > That's so sad because it would provide us compiler based __percpu\n>> > validation.\n>>\n>> Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n>> of limited use also when const and volatile qualifiers are used.\n>> Perhaps some extension could be introduced to c standard to provide an\n>> unqualified type, e.g. typeof_unqual().\n>\n> Oh, there is one in C23 [1].\n\nYes. I found it right after ranting.\n\ngcc >=3D 14 and clang >=3D 16 have support for it of course only when adding\n-std=3Dc2x to the command line.\n\nSigh. The name space qualifiers are non standard and then the thing\nwhich makes them more useful is hidden behind a standard.\n\nWhy can't we have useful tools?\n\nThough the whole thing looks worthwhile:\n\n#define verify_per_cpu_ptr(ptr)\t\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tconst void __seg_gs *__vpp_verify =3D (typeof((ptr) + 0))NULL;    \\\n\t(void)__vpp_verify;\t\t\t\t\t\t\\\n} while (0)\n\n#define per_cpu_ptr(ptr, cpu)\t\t\t\t\t\t\\\n({\t\t\t\t\t\t\t\t\t\\\n\tverify_per_cpu_ptr(ptr);\t\t\t\t\t\\\n\t(typeof_unqual(*(ptr)) *)(uintptr_t)ptr + per_cpu_offset(cpu);\t\\\n})\n\nunsigned int __seg_gs test;\n\nunsigned int foo1(unsigned int cpu)\n{\n\treturn *per_cpu_ptr(&test, cpu);\n}\n\nunsigned int foo2(unsigned int cpu)\n{\n\tunsigned int x, *p =3D per_cpu_ptr(&x, cpu);\n\n\treturn *p;\n}\n\nx.c:29:23: error: initializing 'const __attribute__((address_space(256))) v=\noid *' with an expression of type 'typeof ((&x) + 0)' (aka 'unsigned int *'=\n) changes address space of pointer\n        unsigned int x, *p =3D per_cpu_ptr(&x, cpu);\n\nThat's exactly what we want. It would have caught all the long standing\nand ignored __percpu sparse warnings right away.\n\nThis also simplifies all the other per cpu accessors. The most trivial\nis read()\n\n#define verify_per_cpu(variable)\t\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\tconst unsigned int __s =3D sizeof(variable);\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\tverify_per_cpu_ptr(&(variable));\t\t\t\t\\\n\tBUILD_BUG_ON(__s =3D=3D 1 || __s =3D=3D 2 || __s =3D=3D 4 || __s =3D=3D 8,=\n\t\\\n\t\t     \"Wrong size for per CPU variable\");\t\t\\\n}\n\n#define __pcpu_read(variable)\t\t\t\t\t\t\\\n({\t\t\t\t\t\t\t\t\t\\\n\tverify_per_cpu(variable);\t\t\t\t\t\\\n\tREAD_ONCE(variable);\t\t\t\t\t\t\\\n})\n\nwhich in turn catches all the mistakes, i.e. wrong namespace and wrong\nsize.\n\nI'm really tempted to implement this as an alternative to the current\npile of macro horrors. Of course this requires to figure out first what\nkind of damage -std=3Dc2x will do.\n\nI get to that in my copious spare time some day.\n\nThanks,\n\n        tglx\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/04/170950964704734.mbox",
          "message_id": "<87bk7ux4e9.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-03 23:49:18+00:00",
          "date_str": "Sun, 03 Mar 2024 23:49:18 +0000",
          "body": "On Sun, Mar 03 2024 at 21:24, Uros Bizjak wrote:\n> On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> wr=\note:\n>> On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutronix.=\nde> wrote:\n>> > That's so sad because it would provide us compiler based __percpu\n>> > validation.\n>>\n>> Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n>> of limited use also when const and volatile qualifiers are used.\n>> Perhaps some extension could be introduced to c standard to provide an\n>> unqualified type, e.g. typeof_unqual().\n>\n> Oh, there is one in C23 [1].\n\nYes. I found it right after ranting.\n\ngcc >=3D 14 and clang >=3D 16 have support for it of course only when adding\n-std=3Dc2x to the command line.\n\nSigh. The name space qualifiers are non standard and then the thing\nwhich makes them more useful is hidden behind a standard.\n\nWhy can't we have useful tools?\n\nThough the whole thing looks worthwhile:\n\n#define verify_per_cpu_ptr(ptr)\t\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tconst void __seg_gs *__vpp_verify =3D (typeof((ptr) + 0))NULL;    \\\n\t(void)__vpp_verify;\t\t\t\t\t\t\\\n} while (0)\n\n#define per_cpu_ptr(ptr, cpu)\t\t\t\t\t\t\\\n({\t\t\t\t\t\t\t\t\t\\\n\tverify_per_cpu_ptr(ptr);\t\t\t\t\t\\\n\t(typeof_unqual(*(ptr)) *)(uintptr_t)ptr + per_cpu_offset(cpu);\t\\\n})\n\nunsigned int __seg_gs test;\n\nunsigned int foo1(unsigned int cpu)\n{\n\treturn *per_cpu_ptr(&test, cpu);\n}\n\nunsigned int foo2(unsigned int cpu)\n{\n\tunsigned int x, *p =3D per_cpu_ptr(&x, cpu);\n\n\treturn *p;\n}\n\nx.c:29:23: error: initializing 'const __attribute__((address_space(256))) v=\noid *' with an expression of type 'typeof ((&x) + 0)' (aka 'unsigned int *'=\n) changes address space of pointer\n        unsigned int x, *p =3D per_cpu_ptr(&x, cpu);\n\nThat's exactly what we want. It would have caught all the long standing\nand ignored __percpu sparse warnings right away.\n\nThis also simplifies all the other per cpu accessors. The most trivial\nis read()\n\n#define verify_per_cpu(variable)\t\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\tconst unsigned int __s =3D sizeof(variable);\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\tverify_per_cpu_ptr(&(variable));\t\t\t\t\\\n\tBUILD_BUG_ON(__s =3D=3D 1 || __s =3D=3D 2 || __s =3D=3D 4 || __s =3D=3D 8,=\n\t\\\n\t\t     \"Wrong size for per CPU variable\");\t\t\\\n}\n\n#define __pcpu_read(variable)\t\t\t\t\t\t\\\n({\t\t\t\t\t\t\t\t\t\\\n\tverify_per_cpu(variable);\t\t\t\t\t\\\n\tREAD_ONCE(variable);\t\t\t\t\t\t\\\n})\n\nwhich in turn catches all the mistakes, i.e. wrong namespace and wrong\nsize.\n\nI'm really tempted to implement this as an alternative to the current\npile of macro horrors. Of course this requires to figure out first what\nkind of damage -std=3Dc2x will do.\n\nI get to that in my copious spare time some day.\n\nThanks,\n\n        tglx\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/03/170953087912762.mbox",
          "message_id": "<CAFULd4aEe2KU=UXEt2=GeLQq2uTSFvydBiwAdSa7B6T61Am=5w () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-04 05:42:57+00:00",
          "date_str": "Mon, 04 Mar 2024 05:42:57 +0000",
          "body": "On Mon, Mar 4, 2024 at 12:49=E2=80=AFAM Thomas Gleixner <tglx@linutronix.de=\n> wrote:\n>\n> On Sun, Mar 03 2024 at 21:24, Uros Bizjak wrote:\n> > On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> =\nwrote:\n> >> On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutroni=\nx.de> wrote:\n> >> > That's so sad because it would provide us compiler based __percpu\n> >> > validation.\n> >>\n> >> Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n> >> of limited use also when const and volatile qualifiers are used.\n> >> Perhaps some extension could be introduced to c standard to provide an\n> >> unqualified type, e.g. typeof_unqual().\n> >\n> > Oh, there is one in C23 [1].\n>\n> Yes. I found it right after ranting.\n>\n> gcc >=3D 14 and clang >=3D 16 have support for it of course only when add=\ning\n> -std=3Dc2x to the command line.\n>\n> Sigh. The name space qualifiers are non standard and then the thing\n> which makes them more useful is hidden behind a standard.\n\nWith GCC, you can use __typeof_unqual__ (please note underscores)\nwithout -std=3Dc2x [1]:\n\n\"... Alternate spelling __typeof_unqual__ is available in all C modes\nand provides non-atomic unqualified version of what __typeof__\noperator returns...\"\n\nPlease also see the example in my last post. It can be compiled without -st=\nd=3D...\n\n[1] https://gcc.gnu.org/onlinedocs/gcc/Typeof.html\n\nUros.\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/170953088512774.mbox",
          "message_id": "<CAFULd4aEe2KU=UXEt2=GeLQq2uTSFvydBiwAdSa7B6T61Am=5w () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-04 05:42:57+00:00",
          "date_str": "Mon, 04 Mar 2024 05:42:57 +0000",
          "body": "On Mon, Mar 4, 2024 at 12:49=E2=80=AFAM Thomas Gleixner <tglx@linutronix.de=\n> wrote:\n>\n> On Sun, Mar 03 2024 at 21:24, Uros Bizjak wrote:\n> > On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> =\nwrote:\n> >> On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutroni=\nx.de> wrote:\n> >> > That's so sad because it would provide us compiler based __percpu\n> >> > validation.\n> >>\n> >> Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n> >> of limited use also when const and volatile qualifiers are used.\n> >> Perhaps some extension could be introduced to c standard to provide an\n> >> unqualified type, e.g. typeof_unqual().\n> >\n> > Oh, there is one in C23 [1].\n>\n> Yes. I found it right after ranting.\n>\n> gcc >=3D 14 and clang >=3D 16 have support for it of course only when add=\ning\n> -std=3Dc2x to the command line.\n>\n> Sigh. The name space qualifiers are non standard and then the thing\n> which makes them more useful is hidden behind a standard.\n\nWith GCC, you can use __typeof_unqual__ (please note underscores)\nwithout -std=3Dc2x [1]:\n\n\"... Alternate spelling __typeof_unqual__ is available in all C modes\nand provides non-atomic unqualified version of what __typeof__\noperator returns...\"\n\nPlease also see the example in my last post. It can be compiled without -st=\nd=3D...\n\n[1] https://gcc.gnu.org/onlinedocs/gcc/Typeof.html\n\nUros.\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/04/170953087912762.mbox",
          "message_id": "<CAFULd4aEe2KU=UXEt2=GeLQq2uTSFvydBiwAdSa7B6T61Am=5w () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-04 05:42:57+00:00",
          "date_str": "Mon, 04 Mar 2024 05:42:57 +0000",
          "body": "On Mon, Mar 4, 2024 at 12:49=E2=80=AFAM Thomas Gleixner <tglx@linutronix.de=\n> wrote:\n>\n> On Sun, Mar 03 2024 at 21:24, Uros Bizjak wrote:\n> > On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> =\nwrote:\n> >> On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutroni=\nx.de> wrote:\n> >> > That's so sad because it would provide us compiler based __percpu\n> >> > validation.\n> >>\n> >> Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n> >> of limited use also when const and volatile qualifiers are used.\n> >> Perhaps some extension could be introduced to c standard to provide an\n> >> unqualified type, e.g. typeof_unqual().\n> >\n> > Oh, there is one in C23 [1].\n>\n> Yes. I found it right after ranting.\n>\n> gcc >=3D 14 and clang >=3D 16 have support for it of course only when add=\ning\n> -std=3Dc2x to the command line.\n>\n> Sigh. The name space qualifiers are non standard and then the thing\n> which makes them more useful is hidden behind a standard.\n\nWith GCC, you can use __typeof_unqual__ (please note underscores)\nwithout -std=3Dc2x [1]:\n\n\"... Alternate spelling __typeof_unqual__ is available in all C modes\nand provides non-atomic unqualified version of what __typeof__\noperator returns...\"\n\nPlease also see the example in my last post. It can be compiled without -st=\nd=3D...\n\n[1] https://gcc.gnu.org/onlinedocs/gcc/Typeof.html\n\nUros.\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/04/170953088512774.mbox",
          "message_id": "<CAFULd4aEe2KU=UXEt2=GeLQq2uTSFvydBiwAdSa7B6T61Am=5w () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-04 05:42:57+00:00",
          "date_str": "Mon, 04 Mar 2024 05:42:57 +0000",
          "body": "On Mon, Mar 4, 2024 at 12:49=E2=80=AFAM Thomas Gleixner <tglx@linutronix.de=\n> wrote:\n>\n> On Sun, Mar 03 2024 at 21:24, Uros Bizjak wrote:\n> > On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com> =\nwrote:\n> >> On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutroni=\nx.de> wrote:\n> >> > That's so sad because it would provide us compiler based __percpu\n> >> > validation.\n> >>\n> >> Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n> >> of limited use also when const and volatile qualifiers are used.\n> >> Perhaps some extension could be introduced to c standard to provide an\n> >> unqualified type, e.g. typeof_unqual().\n> >\n> > Oh, there is one in C23 [1].\n>\n> Yes. I found it right after ranting.\n>\n> gcc >=3D 14 and clang >=3D 16 have support for it of course only when add=\ning\n> -std=3Dc2x to the command line.\n>\n> Sigh. The name space qualifiers are non standard and then the thing\n> which makes them more useful is hidden behind a standard.\n\nWith GCC, you can use __typeof_unqual__ (please note underscores)\nwithout -std=3Dc2x [1]:\n\n\"... Alternate spelling __typeof_unqual__ is available in all C modes\nand provides non-atomic unqualified version of what __typeof__\noperator returns...\"\n\nPlease also see the example in my last post. It can be compiled without -st=\nd=3D...\n\n[1] https://gcc.gnu.org/onlinedocs/gcc/Typeof.html\n\nUros.\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/03/170953595115657.mbox",
          "message_id": "<878r2ywk3k.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-04 07:07:43+00:00",
          "date_str": "Mon, 04 Mar 2024 07:07:43 +0000",
          "body": "On Mon, Mar 04 2024 at 06:42, Uros Bizjak wrote:\n\n> On Mon, Mar 4, 2024 at 12:49=E2=80=AFAM Thomas Gleixner <tglx@linutronix.=\nde> wrote:\n>>\n>> On Sun, Mar 03 2024 at 21:24, Uros Bizjak wrote:\n>> > On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com>=\n wrote:\n>> >> On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutron=\nix.de> wrote:\n>> >> > That's so sad because it would provide us compiler based __percpu\n>> >> > validation.\n>> >>\n>> >> Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n>> >> of limited use also when const and volatile qualifiers are used.\n>> >> Perhaps some extension could be introduced to c standard to provide an\n>> >> unqualified type, e.g. typeof_unqual().\n>> >\n>> > Oh, there is one in C23 [1].\n>>\n>> Yes. I found it right after ranting.\n>>\n>> gcc >=3D 14 and clang >=3D 16 have support for it of course only when ad=\nding\n>> -std=3Dc2x to the command line.\n>>\n>> Sigh. The name space qualifiers are non standard and then the thing\n>> which makes them more useful is hidden behind a standard.\n>\n> With GCC, you can use __typeof_unqual__ (please note underscores)\n> without -std=3Dc2x [1]:\n>\n> \"... Alternate spelling __typeof_unqual__ is available in all C modes\n> and provides non-atomic unqualified version of what __typeof__\n> operator returns...\"\n>\n> Please also see the example in my last post. It can be compiled without -=\nstd=3D...\n\nWith gcc >=3D 14. Not so with clang...\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/04/170953595115657.mbox",
          "message_id": "<878r2ywk3k.ffs () tglx>",
          "author_name": "Thomas Gleixner",
          "author_email": "tglx () linutronix ! de",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-03-04 07:07:43+00:00",
          "date_str": "Mon, 04 Mar 2024 07:07:43 +0000",
          "body": "On Mon, Mar 04 2024 at 06:42, Uros Bizjak wrote:\n\n> On Mon, Mar 4, 2024 at 12:49=E2=80=AFAM Thomas Gleixner <tglx@linutronix.=\nde> wrote:\n>>\n>> On Sun, Mar 03 2024 at 21:24, Uros Bizjak wrote:\n>> > On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.com>=\n wrote:\n>> >> On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutron=\nix.de> wrote:\n>> >> > That's so sad because it would provide us compiler based __percpu\n>> >> > validation.\n>> >>\n>> >> Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n>> >> of limited use also when const and volatile qualifiers are used.\n>> >> Perhaps some extension could be introduced to c standard to provide an\n>> >> unqualified type, e.g. typeof_unqual().\n>> >\n>> > Oh, there is one in C23 [1].\n>>\n>> Yes. I found it right after ranting.\n>>\n>> gcc >=3D 14 and clang >=3D 16 have support for it of course only when ad=\nding\n>> -std=3Dc2x to the command line.\n>>\n>> Sigh. The name space qualifiers are non standard and then the thing\n>> which makes them more useful is hidden behind a standard.\n>\n> With GCC, you can use __typeof_unqual__ (please note underscores)\n> without -std=3Dc2x [1]:\n>\n> \"... Alternate spelling __typeof_unqual__ is available in all C modes\n> and provides non-atomic unqualified version of what __typeof__\n> operator returns...\"\n>\n> Please also see the example in my last post. It can be compiled without -=\nstd=3D...\n\nWith gcc >=3D 14. Not so with clang...\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/03/171208360522448.mbox",
          "message_id": "<CAFULd4YG21NdF_qNVBGDtXO6xnaYFeRPvKicB=gpgUUqYE=4jw () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-04-02 11:43:00+00:00",
          "date_str": "Tue, 02 Apr 2024 11:43:00 +0000",
          "body": "On Mon, Mar 4, 2024 at 8:07=E2=80=AFAM Thomas Gleixner <tglx@linutronix.de>=\n wrote:\n>\n> On Mon, Mar 04 2024 at 06:42, Uros Bizjak wrote:\n>\n> > On Mon, Mar 4, 2024 at 12:49=E2=80=AFAM Thomas Gleixner <tglx@linutroni=\nx.de> wrote:\n> >>\n> >> On Sun, Mar 03 2024 at 21:24, Uros Bizjak wrote:\n> >> > On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.co=\nm> wrote:\n> >> >> On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutr=\nonix.de> wrote:\n> >> >> > That's so sad because it would provide us compiler based __percpu\n> >> >> > validation.\n> >> >>\n> >> >> Unfortunately, the c compiler can't strip qualifiers, so typeof() i=\ns\n> >> >> of limited use also when const and volatile qualifiers are used.\n> >> >> Perhaps some extension could be introduced to c standard to provide=\n an\n> >> >> unqualified type, e.g. typeof_unqual().\n> >> >\n> >> > Oh, there is one in C23 [1].\n> >>\n> >> Yes. I found it right after ranting.\n> >>\n> >> gcc >=3D 14 and clang >=3D 16 have support for it of course only when =\nadding\n> >> -std=3Dc2x to the command line.\n> >>\n> >> Sigh. The name space qualifiers are non standard and then the thing\n> >> which makes them more useful is hidden behind a standard.\n> >\n> > With GCC, you can use __typeof_unqual__ (please note underscores)\n> > without -std=3Dc2x [1]:\n> >\n> > \"... Alternate spelling __typeof_unqual__ is available in all C modes\n> > and provides non-atomic unqualified version of what __typeof__\n> > operator returns...\"\n> >\n> > Please also see the example in my last post. It can be compiled without=\n -std=3D...\n>\n> With gcc >=3D 14. Not so with clang...\n\nPlease note that clang-17.0.6 currently fails to compile kernel with\nnamed address spaces [1]. So perhaps kernel can use __typeof_unqual__\n(available without -std=3Dc2x) in the hope that clang implements\n__typeof_unqual__ in one of its next releases, following the examples\nof GCC [2] and MSVC[3].\n\n[1] https://lore.kernel.org/lkml/20240320173758.GA3017166@dev-arch.thelio-3=\n990X/\n[2] https://gcc.gnu.org/onlinedocs/gcc/Typeof.html\n[3] https://learn.microsoft.com/en-us/cpp/c-language/typeof-unqual-c?view=\n=3Dmsvc-170\n\nUros.\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171208366324932.mbox",
          "message_id": "<CAFULd4YG21NdF_qNVBGDtXO6xnaYFeRPvKicB=gpgUUqYE=4jw () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-04-02 11:43:00+00:00",
          "date_str": "Tue, 02 Apr 2024 11:43:00 +0000",
          "body": "On Mon, Mar 4, 2024 at 8:07=E2=80=AFAM Thomas Gleixner <tglx@linutronix.de>=\n wrote:\n>\n> On Mon, Mar 04 2024 at 06:42, Uros Bizjak wrote:\n>\n> > On Mon, Mar 4, 2024 at 12:49=E2=80=AFAM Thomas Gleixner <tglx@linutroni=\nx.de> wrote:\n> >>\n> >> On Sun, Mar 03 2024 at 21:24, Uros Bizjak wrote:\n> >> > On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.co=\nm> wrote:\n> >> >> On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutr=\nonix.de> wrote:\n> >> >> > That's so sad because it would provide us compiler based __percpu\n> >> >> > validation.\n> >> >>\n> >> >> Unfortunately, the c compiler can't strip qualifiers, so typeof() i=\ns\n> >> >> of limited use also when const and volatile qualifiers are used.\n> >> >> Perhaps some extension could be introduced to c standard to provide=\n an\n> >> >> unqualified type, e.g. typeof_unqual().\n> >> >\n> >> > Oh, there is one in C23 [1].\n> >>\n> >> Yes. I found it right after ranting.\n> >>\n> >> gcc >=3D 14 and clang >=3D 16 have support for it of course only when =\nadding\n> >> -std=3Dc2x to the command line.\n> >>\n> >> Sigh. The name space qualifiers are non standard and then the thing\n> >> which makes them more useful is hidden behind a standard.\n> >\n> > With GCC, you can use __typeof_unqual__ (please note underscores)\n> > without -std=3Dc2x [1]:\n> >\n> > \"... Alternate spelling __typeof_unqual__ is available in all C modes\n> > and provides non-atomic unqualified version of what __typeof__\n> > operator returns...\"\n> >\n> > Please also see the example in my last post. It can be compiled without=\n -std=3D...\n>\n> With gcc >=3D 14. Not so with clang...\n\nPlease note that clang-17.0.6 currently fails to compile kernel with\nnamed address spaces [1]. So perhaps kernel can use __typeof_unqual__\n(available without -std=3Dc2x) in the hope that clang implements\n__typeof_unqual__ in one of its next releases, following the examples\nof GCC [2] and MSVC[3].\n\n[1] https://lore.kernel.org/lkml/20240320173758.GA3017166@dev-arch.thelio-3=\n990X/\n[2] https://gcc.gnu.org/onlinedocs/gcc/Typeof.html\n[3] https://learn.microsoft.com/en-us/cpp/c-language/typeof-unqual-c?view=\n=3Dmsvc-170\n\nUros.\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/04/171208360522448.mbox",
          "message_id": "<CAFULd4YG21NdF_qNVBGDtXO6xnaYFeRPvKicB=gpgUUqYE=4jw () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-04-02 11:43:00+00:00",
          "date_str": "Tue, 02 Apr 2024 11:43:00 +0000",
          "body": "On Mon, Mar 4, 2024 at 8:07=E2=80=AFAM Thomas Gleixner <tglx@linutronix.de>=\n wrote:\n>\n> On Mon, Mar 04 2024 at 06:42, Uros Bizjak wrote:\n>\n> > On Mon, Mar 4, 2024 at 12:49=E2=80=AFAM Thomas Gleixner <tglx@linutroni=\nx.de> wrote:\n> >>\n> >> On Sun, Mar 03 2024 at 21:24, Uros Bizjak wrote:\n> >> > On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.co=\nm> wrote:\n> >> >> On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutr=\nonix.de> wrote:\n> >> >> > That's so sad because it would provide us compiler based __percpu\n> >> >> > validation.\n> >> >>\n> >> >> Unfortunately, the c compiler can't strip qualifiers, so typeof() i=\ns\n> >> >> of limited use also when const and volatile qualifiers are used.\n> >> >> Perhaps some extension could be introduced to c standard to provide=\n an\n> >> >> unqualified type, e.g. typeof_unqual().\n> >> >\n> >> > Oh, there is one in C23 [1].\n> >>\n> >> Yes. I found it right after ranting.\n> >>\n> >> gcc >=3D 14 and clang >=3D 16 have support for it of course only when =\nadding\n> >> -std=3Dc2x to the command line.\n> >>\n> >> Sigh. The name space qualifiers are non standard and then the thing\n> >> which makes them more useful is hidden behind a standard.\n> >\n> > With GCC, you can use __typeof_unqual__ (please note underscores)\n> > without -std=3Dc2x [1]:\n> >\n> > \"... Alternate spelling __typeof_unqual__ is available in all C modes\n> > and provides non-atomic unqualified version of what __typeof__\n> > operator returns...\"\n> >\n> > Please also see the example in my last post. It can be compiled without=\n -std=3D...\n>\n> With gcc >=3D 14. Not so with clang...\n\nPlease note that clang-17.0.6 currently fails to compile kernel with\nnamed address spaces [1]. So perhaps kernel can use __typeof_unqual__\n(available without -std=3Dc2x) in the hope that clang implements\n__typeof_unqual__ in one of its next releases, following the examples\nof GCC [2] and MSVC[3].\n\n[1] https://lore.kernel.org/lkml/20240320173758.GA3017166@dev-arch.thelio-3=\n990X/\n[2] https://gcc.gnu.org/onlinedocs/gcc/Typeof.html\n[3] https://learn.microsoft.com/en-us/cpp/c-language/typeof-unqual-c?view=\n=3Dmsvc-170\n\nUros.\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/04/171208366324932.mbox",
          "message_id": "<CAFULd4YG21NdF_qNVBGDtXO6xnaYFeRPvKicB=gpgUUqYE=4jw () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-04-02 11:43:00+00:00",
          "date_str": "Tue, 02 Apr 2024 11:43:00 +0000",
          "body": "On Mon, Mar 4, 2024 at 8:07=E2=80=AFAM Thomas Gleixner <tglx@linutronix.de>=\n wrote:\n>\n> On Mon, Mar 04 2024 at 06:42, Uros Bizjak wrote:\n>\n> > On Mon, Mar 4, 2024 at 12:49=E2=80=AFAM Thomas Gleixner <tglx@linutroni=\nx.de> wrote:\n> >>\n> >> On Sun, Mar 03 2024 at 21:24, Uros Bizjak wrote:\n> >> > On Sun, Mar 3, 2024 at 9:21=E2=80=AFPM Uros Bizjak <ubizjak@gmail.co=\nm> wrote:\n> >> >> On Sun, Mar 3, 2024 at 9:10=E2=80=AFPM Thomas Gleixner <tglx@linutr=\nonix.de> wrote:\n> >> >> > That's so sad because it would provide us compiler based __percpu\n> >> >> > validation.\n> >> >>\n> >> >> Unfortunately, the c compiler can't strip qualifiers, so typeof() i=\ns\n> >> >> of limited use also when const and volatile qualifiers are used.\n> >> >> Perhaps some extension could be introduced to c standard to provide=\n an\n> >> >> unqualified type, e.g. typeof_unqual().\n> >> >\n> >> > Oh, there is one in C23 [1].\n> >>\n> >> Yes. I found it right after ranting.\n> >>\n> >> gcc >=3D 14 and clang >=3D 16 have support for it of course only when =\nadding\n> >> -std=3Dc2x to the command line.\n> >>\n> >> Sigh. The name space qualifiers are non standard and then the thing\n> >> which makes them more useful is hidden behind a standard.\n> >\n> > With GCC, you can use __typeof_unqual__ (please note underscores)\n> > without -std=3Dc2x [1]:\n> >\n> > \"... Alternate spelling __typeof_unqual__ is available in all C modes\n> > and provides non-atomic unqualified version of what __typeof__\n> > operator returns...\"\n> >\n> > Please also see the example in my last post. It can be compiled without=\n -std=3D...\n>\n> With gcc >=3D 14. Not so with clang...\n\nPlease note that clang-17.0.6 currently fails to compile kernel with\nnamed address spaces [1]. So perhaps kernel can use __typeof_unqual__\n(available without -std=3Dc2x) in the hope that clang implements\n__typeof_unqual__ in one of its next releases, following the examples\nof GCC [2] and MSVC[3].\n\n[1] https://lore.kernel.org/lkml/20240320173758.GA3017166@dev-arch.thelio-3=\n990X/\n[2] https://gcc.gnu.org/onlinedocs/gcc/Typeof.html\n[3] https://learn.microsoft.com/en-us/cpp/c-language/typeof-unqual-c?view=\n=3Dmsvc-170\n\nUros.\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/03/171216699316278.mbox",
          "message_id": "<20240403175723.GA2667607 () dev-arch ! thelio-3990X>",
          "author_name": "Nathan Chancellor",
          "author_email": "nathan () kernel ! org",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-04-03 17:57:23+00:00",
          "date_str": "Wed, 03 Apr 2024 17:57:23 +0000",
          "body": "On Tue, Apr 02, 2024 at 01:43:00PM +0200, Uros Bizjak wrote:\n> On Mon, Mar 4, 2024 at 8:07\u202fAM Thomas Gleixner <tglx@linutronix.de> wrote:\n> >\n> > On Mon, Mar 04 2024 at 06:42, Uros Bizjak wrote:\n> >\n> > > On Mon, Mar 4, 2024 at 12:49\u202fAM Thomas Gleixner <tglx@linutronix.de> wrote:\n> > >>\n> > >> On Sun, Mar 03 2024 at 21:24, Uros Bizjak wrote:\n> > >> > On Sun, Mar 3, 2024 at 9:21\u202fPM Uros Bizjak <ubizjak@gmail.com> wrote:\n> > >> >> On Sun, Mar 3, 2024 at 9:10\u202fPM Thomas Gleixner <tglx@linutronix.de> wrote:\n> > >> >> > That's so sad because it would provide us compiler based __percpu\n> > >> >> > validation.\n> > >> >>\n> > >> >> Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n> > >> >> of limited use also when const and volatile qualifiers are used.\n> > >> >> Perhaps some extension could be introduced to c standard to provide an\n> > >> >> unqualified type, e.g. typeof_unqual().\n> > >> >\n> > >> > Oh, there is one in C23 [1].\n> > >>\n> > >> Yes. I found it right after ranting.\n> > >>\n> > >> gcc >= 14 and clang >= 16 have support for it of course only when adding\n> > >> -std=c2x to the command line.\n> > >>\n> > >> Sigh. The name space qualifiers are non standard and then the thing\n> > >> which makes them more useful is hidden behind a standard.\n> > >\n> > > With GCC, you can use __typeof_unqual__ (please note underscores)\n> > > without -std=c2x [1]:\n> > >\n> > > \"... Alternate spelling __typeof_unqual__ is available in all C modes\n> > > and provides non-atomic unqualified version of what __typeof__\n> > > operator returns...\"\n> > >\n> > > Please also see the example in my last post. It can be compiled without -std=...\n> >\n> > With gcc >= 14. Not so with clang...\n> \n> Please note that clang-17.0.6 currently fails to compile kernel with\n> named address spaces [1]. So perhaps kernel can use __typeof_unqual__\n> (available without -std=c2x) in the hope that clang implements\n> __typeof_unqual__ in one of its next releases, following the examples\n> of GCC [2] and MSVC[3].\n\nThis is now supported in clang 19.0.0 (main):\n\nhttps://github.com/llvm/llvm-project/commit/cc308f60d41744b5920ec2e2e5b25e1273c8704b\n\nI have inquired about applying this to the 18.x series, such that it\nwould either make 18.1.3 or 18.1.4, but that is still open for\ndiscussion.\n\nI think the error that I mentioned at [1] is resolved with using\n__typeof_unqual__, I tested this diff, which is likely incorrect but\nallows me to continue testing without that warning/error due to -Werror:\n\ndiff --git a/arch/x86/include/asm/percpu.h b/arch/x86/include/asm/percpu.h\nindex 20696df5d567..fc77c99d2e80 100644\n--- a/arch/x86/include/asm/percpu.h\n+++ b/arch/x86/include/asm/percpu.h\n@@ -95,7 +95,7 @@\n \n #endif /* CONFIG_SMP */\n \n-#define __my_cpu_type(var)\ttypeof(var) __percpu_seg_override\n+#define __my_cpu_type(var)\t__typeof_unqual__(var) __percpu_seg_override\n #define __my_cpu_ptr(ptr)\t(__my_cpu_type(*ptr)*)(__force uintptr_t)(ptr)\n #define __my_cpu_var(var)\t(*__my_cpu_ptr(&(var)))\n #define __percpu_arg(x)\t\t__percpu_prefix \"%\" #x\n\nHowever, I get a crash in LLVM's backend with that diff applied on top\nof commit 034dd140a6d8 (\"Merge branch into tip/master: 'x86/shstk'\"),\nwhich appears to be another tangential issue. I've filed\nhttps://github.com/ClangBuiltLinux/linux/issues/2013 so that we don't\nlose track of this.\n\nCheers,\nNathan\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/04/171216699316278.mbox",
          "message_id": "<20240403175723.GA2667607 () dev-arch ! thelio-3990X>",
          "author_name": "Nathan Chancellor",
          "author_email": "nathan () kernel ! org",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-04-03 17:57:23+00:00",
          "date_str": "Wed, 03 Apr 2024 17:57:23 +0000",
          "body": "On Tue, Apr 02, 2024 at 01:43:00PM +0200, Uros Bizjak wrote:\n> On Mon, Mar 4, 2024 at 8:07\u202fAM Thomas Gleixner <tglx@linutronix.de> wrote:\n> >\n> > On Mon, Mar 04 2024 at 06:42, Uros Bizjak wrote:\n> >\n> > > On Mon, Mar 4, 2024 at 12:49\u202fAM Thomas Gleixner <tglx@linutronix.de> wrote:\n> > >>\n> > >> On Sun, Mar 03 2024 at 21:24, Uros Bizjak wrote:\n> > >> > On Sun, Mar 3, 2024 at 9:21\u202fPM Uros Bizjak <ubizjak@gmail.com> wrote:\n> > >> >> On Sun, Mar 3, 2024 at 9:10\u202fPM Thomas Gleixner <tglx@linutronix.de> wrote:\n> > >> >> > That's so sad because it would provide us compiler based __percpu\n> > >> >> > validation.\n> > >> >>\n> > >> >> Unfortunately, the c compiler can't strip qualifiers, so typeof() is\n> > >> >> of limited use also when const and volatile qualifiers are used.\n> > >> >> Perhaps some extension could be introduced to c standard to provide an\n> > >> >> unqualified type, e.g. typeof_unqual().\n> > >> >\n> > >> > Oh, there is one in C23 [1].\n> > >>\n> > >> Yes. I found it right after ranting.\n> > >>\n> > >> gcc >= 14 and clang >= 16 have support for it of course only when adding\n> > >> -std=c2x to the command line.\n> > >>\n> > >> Sigh. The name space qualifiers are non standard and then the thing\n> > >> which makes them more useful is hidden behind a standard.\n> > >\n> > > With GCC, you can use __typeof_unqual__ (please note underscores)\n> > > without -std=c2x [1]:\n> > >\n> > > \"... Alternate spelling __typeof_unqual__ is available in all C modes\n> > > and provides non-atomic unqualified version of what __typeof__\n> > > operator returns...\"\n> > >\n> > > Please also see the example in my last post. It can be compiled without -std=...\n> >\n> > With gcc >= 14. Not so with clang...\n> \n> Please note that clang-17.0.6 currently fails to compile kernel with\n> named address spaces [1]. So perhaps kernel can use __typeof_unqual__\n> (available without -std=c2x) in the hope that clang implements\n> __typeof_unqual__ in one of its next releases, following the examples\n> of GCC [2] and MSVC[3].\n\nThis is now supported in clang 19.0.0 (main):\n\nhttps://github.com/llvm/llvm-project/commit/cc308f60d41744b5920ec2e2e5b25e1273c8704b\n\nI have inquired about applying this to the 18.x series, such that it\nwould either make 18.1.3 or 18.1.4, but that is still open for\ndiscussion.\n\nI think the error that I mentioned at [1] is resolved with using\n__typeof_unqual__, I tested this diff, which is likely incorrect but\nallows me to continue testing without that warning/error due to -Werror:\n\ndiff --git a/arch/x86/include/asm/percpu.h b/arch/x86/include/asm/percpu.h\nindex 20696df5d567..fc77c99d2e80 100644\n--- a/arch/x86/include/asm/percpu.h\n+++ b/arch/x86/include/asm/percpu.h\n@@ -95,7 +95,7 @@\n \n #endif /* CONFIG_SMP */\n \n-#define __my_cpu_type(var)\ttypeof(var) __percpu_seg_override\n+#define __my_cpu_type(var)\t__typeof_unqual__(var) __percpu_seg_override\n #define __my_cpu_ptr(ptr)\t(__my_cpu_type(*ptr)*)(__force uintptr_t)(ptr)\n #define __my_cpu_var(var)\t(*__my_cpu_ptr(&(var)))\n #define __percpu_arg(x)\t\t__percpu_prefix \"%\" #x\n\nHowever, I get a crash in LLVM's backend with that diff applied on top\nof commit 034dd140a6d8 (\"Merge branch into tip/master: 'x86/shstk'\"),\nwhich appears to be another tangential issue. I've filed\nhttps://github.com/ClangBuiltLinux/linux/issues/2013 so that we don't\nlose track of this.\n\nCheers,\nNathan\n",
          "year": "2024",
          "month": "04"
        },
        {
          "filepath": "emails/2024/03/171221365008861.mbox",
          "message_id": "<CAFULd4bzZuv=gW63jay_mMuPSAdh01Y=LhdVHXq51-cYPCJR0A () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-04-04 06:56:19+00:00",
          "date_str": "Thu, 04 Apr 2024 06:56:19 +0000",
          "body": "--000000000000dc1a7f06153fd66f\nContent-Type: text/plain; charset=\"UTF-8\"\nContent-Transfer-Encoding: quoted-printable\n\nOn Wed, Apr 3, 2024 at 7:57=E2=80=AFPM Nathan Chancellor <nathan@kernel.org=\n> wrote:\n\n> > > > With GCC, you can use __typeof_unqual__ (please note underscores)\n> > > > without -std=3Dc2x [1]:\n> > > >\n> > > > \"... Alternate spelling __typeof_unqual__ is available in all C mod=\nes\n> > > > and provides non-atomic unqualified version of what __typeof__\n> > > > operator returns...\"\n> > > >\n> > > > Please also see the example in my last post. It can be compiled wit=\nhout -std=3D...\n> > >\n> > > With gcc >=3D 14. Not so with clang...\n> >\n> > Please note that clang-17.0.6 currently fails to compile kernel with\n> > named address spaces [1]. So perhaps kernel can use __typeof_unqual__\n> > (available without -std=3Dc2x) in the hope that clang implements\n> > __typeof_unqual__ in one of its next releases, following the examples\n> > of GCC [2] and MSVC[3].\n>\n> This is now supported in clang 19.0.0 (main):\n>\n> https://github.com/llvm/llvm-project/commit/cc308f60d41744b5920ec2e2e5b25=\ne1273c8704b\n>\n> I have inquired about applying this to the 18.x series, such that it\n> would either make 18.1.3 or 18.1.4, but that is still open for\n> discussion.\n>\n> I think the error that I mentioned at [1] is resolved with using\n> __typeof_unqual__, I tested this diff, which is likely incorrect but\n> allows me to continue testing without that warning/error due to -Werror:\n>\n> diff --git a/arch/x86/include/asm/percpu.h b/arch/x86/include/asm/percpu.=\nh\n> index 20696df5d567..fc77c99d2e80 100644\n> --- a/arch/x86/include/asm/percpu.h\n> +++ b/arch/x86/include/asm/percpu.h\n> @@ -95,7 +95,7 @@\n>\n>  #endif /* CONFIG_SMP */\n>\n> -#define __my_cpu_type(var)     typeof(var) __percpu_seg_override\n> +#define __my_cpu_type(var)     __typeof_unqual__(var) __percpu_seg_overr=\nide\n>  #define __my_cpu_ptr(ptr)      (__my_cpu_type(*ptr)*)(__force uintptr_t)=\n(ptr)\n>  #define __my_cpu_var(var)      (*__my_cpu_ptr(&(var)))\n>  #define __percpu_arg(x)                __percpu_prefix \"%\" #x\n\nIMO, the above change is not correct. Currently, the percpu variables\nstill live in generic address space, and the above casts are used at\nthe usage site of the percpu variable to convert pointer from generic\nto disjoint __seg_gs address space (please see [2], section 6.17.5).\nThe -Wduplicate-decl-specifier warning at [1] (if correct) perhaps\npoints to the percpu accessor chain. GCC does not care about duplicate\n__seg_gs conversions (the operation is idempotent), but the issue\nshould be corrected nevertheless.\n\nBTW: With the above approach we get all the benefits of named address\nspaces, but *not* checks for invalid access between disjoint address\nspaces. This check is currently done by sparse (this is the reason for\n__force in the above cast chain), but the check is not enabled by\ndefault. The proposed improvement would *define* the percpu variable\nin __seg_gs named address space, so the compiler will error out with\n\"assignment/return from pointer to non-enclosed address space\" when\ninvalid access is detected (please see attached testcase, should be\ncompiled with gcc-14 due to usage of __typeof_unqual__) or warn with\n\"cast to generic address space pointer from disjoint =E2=80=98__seg_gs=E2=\n=80=99\naddress space pointer\" with explicit cast.\n\n[1] https://lore.kernel.org/lkml/20240320173758.GA3017166@dev-arch.thelio-3=\n990X/\n[2] https://gcc.gnu.org/onlinedocs/gcc/Named-Address-Spaces.html\n\nUros.\n\n--000000000000dc1a7f06153fd66f\nContent-Type: text/x-csrc; charset=\"US-ASCII\"; name=\"seg.c\"\nContent-Disposition: attachment; filename=\"seg.c\"\nContent-Transfer-Encoding: base64\nContent-ID: <f_lukvrsfr0>\nX-Attachment-Id: f_lukvrsfr0\n\naW50IF9fc2VnX2dzIHZhcjsKCnZvaWQgZm9vMSAodm9pZCkKewogIGFzbSB2b2xhdGlsZSAoIiMg\nJTAiIDo6ICJtIiAodmFyKSk7Cn0KCmludCBmb28yICh2b2lkKQp7CiAgcmV0dXJuIHZhcjsKfQoK\naW50IF9fc2VnX2dzICpiYXIxICh2b2lkKQp7CiAgcmV0dXJuICZ2YXI7Cn0KCmludCAqYmFyMiAo\ndm9pZCkKewogIC8vIHJldHVybiAmdmFyOyAvKiBlcnJvciAqLwogIHJldHVybiAoaW50ICopJnZh\ncjsKfQoKaW50ICpiYXIzICh2b2lkKQp7CiAgaW50ICpwOwoKICAvLyAgcCA9ICZ2YXI7IC8qIGVy\ncm9yICovCiAgcCA9IChpbnQgKikmdmFyOwoKICByZXR1cm4gcDsKfQoKaW50IF9fc2VnX2dzICpi\nYXoxICh2b2lkKQp7CiAgdHlwZW9mKHZhcikgKnA7IC8qIChfX3NlZ19ncyBpbnQgKikgKi8KCiAg\ncCA9ICZ2YXI7CgogIHJldHVybiBwOwp9CgppbnQgKmJhejIgKHZvaWQpCnsKICBfX3R5cGVvZl91\nbnF1YWxfXyh2YXIpICpwOyAvKiAoaW50ICopICovCgogIC8vIHAgPSAmdmFyOyAvKiBlcnJvciAq\nLwogIHAgPSAoaW50ICopJnZhcjsKCiAgcmV0dXJuIHA7Cn0K\n--000000000000dc1a7f06153fd66f--\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/03/171221364808857.mbox",
          "message_id": "<CAFULd4bzZuv=gW63jay_mMuPSAdh01Y=LhdVHXq51-cYPCJR0A () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-04-04 06:56:19+00:00",
          "date_str": "Thu, 04 Apr 2024 06:56:19 +0000",
          "body": "--000000000000dc1a7f06153fd66f\nContent-Type: text/plain; charset=\"UTF-8\"\nContent-Transfer-Encoding: quoted-printable\n\nOn Wed, Apr 3, 2024 at 7:57=E2=80=AFPM Nathan Chancellor <nathan@kernel.org=\n> wrote:\n\n> > > > With GCC, you can use __typeof_unqual__ (please note underscores)\n> > > > without -std=3Dc2x [1]:\n> > > >\n> > > > \"... Alternate spelling __typeof_unqual__ is available in all C mod=\nes\n> > > > and provides non-atomic unqualified version of what __typeof__\n> > > > operator returns...\"\n> > > >\n> > > > Please also see the example in my last post. It can be compiled wit=\nhout -std=3D...\n> > >\n> > > With gcc >=3D 14. Not so with clang...\n> >\n> > Please note that clang-17.0.6 currently fails to compile kernel with\n> > named address spaces [1]. So perhaps kernel can use __typeof_unqual__\n> > (available without -std=3Dc2x) in the hope that clang implements\n> > __typeof_unqual__ in one of its next releases, following the examples\n> > of GCC [2] and MSVC[3].\n>\n> This is now supported in clang 19.0.0 (main):\n>\n> https://github.com/llvm/llvm-project/commit/cc308f60d41744b5920ec2e2e5b25=\ne1273c8704b\n>\n> I have inquired about applying this to the 18.x series, such that it\n> would either make 18.1.3 or 18.1.4, but that is still open for\n> discussion.\n>\n> I think the error that I mentioned at [1] is resolved with using\n> __typeof_unqual__, I tested this diff, which is likely incorrect but\n> allows me to continue testing without that warning/error due to -Werror:\n>\n> diff --git a/arch/x86/include/asm/percpu.h b/arch/x86/include/asm/percpu.=\nh\n> index 20696df5d567..fc77c99d2e80 100644\n> --- a/arch/x86/include/asm/percpu.h\n> +++ b/arch/x86/include/asm/percpu.h\n> @@ -95,7 +95,7 @@\n>\n>  #endif /* CONFIG_SMP */\n>\n> -#define __my_cpu_type(var)     typeof(var) __percpu_seg_override\n> +#define __my_cpu_type(var)     __typeof_unqual__(var) __percpu_seg_overr=\nide\n>  #define __my_cpu_ptr(ptr)      (__my_cpu_type(*ptr)*)(__force uintptr_t)=\n(ptr)\n>  #define __my_cpu_var(var)      (*__my_cpu_ptr(&(var)))\n>  #define __percpu_arg(x)                __percpu_prefix \"%\" #x\n\nIMO, the above change is not correct. Currently, the percpu variables\nstill live in generic address space, and the above casts are used at\nthe usage site of the percpu variable to convert pointer from generic\nto disjoint __seg_gs address space (please see [2], section 6.17.5).\nThe -Wduplicate-decl-specifier warning at [1] (if correct) perhaps\npoints to the percpu accessor chain. GCC does not care about duplicate\n__seg_gs conversions (the operation is idempotent), but the issue\nshould be corrected nevertheless.\n\nBTW: With the above approach we get all the benefits of named address\nspaces, but *not* checks for invalid access between disjoint address\nspaces. This check is currently done by sparse (this is the reason for\n__force in the above cast chain), but the check is not enabled by\ndefault. The proposed improvement would *define* the percpu variable\nin __seg_gs named address space, so the compiler will error out with\n\"assignment/return from pointer to non-enclosed address space\" when\ninvalid access is detected (please see attached testcase, should be\ncompiled with gcc-14 due to usage of __typeof_unqual__) or warn with\n\"cast to generic address space pointer from disjoint =E2=80=98__seg_gs=E2=\n=80=99\naddress space pointer\" with explicit cast.\n\n[1] https://lore.kernel.org/lkml/20240320173758.GA3017166@dev-arch.thelio-3=\n990X/\n[2] https://gcc.gnu.org/onlinedocs/gcc/Named-Address-Spaces.html\n\nUros.\n\n--000000000000dc1a7f06153fd66f\nContent-Type: text/x-csrc; charset=\"US-ASCII\"; name=\"seg.c\"\nContent-Disposition: attachment; filename=\"seg.c\"\nContent-Transfer-Encoding: base64\nContent-ID: <f_lukvrsfr0>\nX-Attachment-Id: f_lukvrsfr0\n\naW50IF9fc2VnX2dzIHZhcjsKCnZvaWQgZm9vMSAodm9pZCkKewogIGFzbSB2b2xhdGlsZSAoIiMg\nJTAiIDo6ICJtIiAodmFyKSk7Cn0KCmludCBmb28yICh2b2lkKQp7CiAgcmV0dXJuIHZhcjsKfQoK\naW50IF9fc2VnX2dzICpiYXIxICh2b2lkKQp7CiAgcmV0dXJuICZ2YXI7Cn0KCmludCAqYmFyMiAo\ndm9pZCkKewogIC8vIHJldHVybiAmdmFyOyAvKiBlcnJvciAqLwogIHJldHVybiAoaW50ICopJnZh\ncjsKfQoKaW50ICpiYXIzICh2b2lkKQp7CiAgaW50ICpwOwoKICAvLyAgcCA9ICZ2YXI7IC8qIGVy\ncm9yICovCiAgcCA9IChpbnQgKikmdmFyOwoKICByZXR1cm4gcDsKfQoKaW50IF9fc2VnX2dzICpi\nYXoxICh2b2lkKQp7CiAgdHlwZW9mKHZhcikgKnA7IC8qIChfX3NlZ19ncyBpbnQgKikgKi8KCiAg\ncCA9ICZ2YXI7CgogIHJldHVybiBwOwp9CgppbnQgKmJhejIgKHZvaWQpCnsKICBfX3R5cGVvZl91\nbnF1YWxfXyh2YXIpICpwOyAvKiAoaW50ICopICovCgogIC8vIHAgPSAmdmFyOyAvKiBlcnJvciAq\nLwogIHAgPSAoaW50ICopJnZhcjsKCiAgcmV0dXJuIHA7Cn0K\n--000000000000dc1a7f06153fd66f--\n",
          "year": "2024",
          "month": "03"
        },
        {
          "filepath": "emails/2024/04/171221365008861.mbox",
          "message_id": "<CAFULd4bzZuv=gW63jay_mMuPSAdh01Y=LhdVHXq51-cYPCJR0A () mail ! gmail ! com>",
          "author_name": "Uros Bizjak",
          "author_email": "ubizjak () gmail ! com",
          "subject": "Re: arch/x86/include/asm/processor.h:698:16: sparse: sparse: incorrect type in initializer (differen",
          "date": "2024-04-04 06:56:19+00:00",
          "date_str": "Thu, 04 Apr 2024 06:56:19 +0000",
          "body": "--000000000000dc1a7f06153fd66f\nContent-Type: text/plain; charset=\"UTF-8\"\nContent-Transfer-Encoding: quoted-printable\n\nOn Wed, Apr 3, 2024 at 7:57=E2=80=AFPM Nathan Chancellor <nathan@kernel.org=\n> wrote:\n\n> > > > With GCC, you can use __typeof_unqual__ (please note underscores)\n> > > > without -std=3Dc2x [1]:\n> > > >\n> > > > \"... Alternate spelling __typeof_unqual__ is available in all C mod=\nes\n> > > > and provides non-atomic unqualified version of what __typeof__\n> > > > operator returns...\"\n> > > >\n> > > > Please also see the example in my last post. It can be compiled wit=\nhout -std=3D...\n> > >\n> > > With gcc >=3D 14. Not so with clang...\n> >\n> > Please note that clang-17.0.6 currently fails to compile kernel with\n> > named address spaces [1]. So perhaps kernel can use __typeof_unqual__\n> > (available without -std=3Dc2x) in the hope that clang implements\n> > __typeof_unqual__ in one of its next releases, following the examples\n> > of GCC [2] and MSVC[3].\n>\n> This is now supported in clang 19.0.0 (main):\n>\n> https://github.com/llvm/llvm-project/commit/cc308f60d41744b5920ec2e2e5b25=\ne1273c8704b\n>\n> I have inquired about applying this to the 18.x series, such that it\n> would either make 18.1.3 or 18.1.4, but that is still open for\n> discussion.\n>\n> I think the error that I mentioned at [1] is resolved with using\n> __typeof_unqual__, I tested this diff, which is likely incorrect but\n> allows me to continue testing without that warning/error due to -Werror:\n>\n> diff --git a/arch/x86/include/asm/percpu.h b/arch/x86/include/asm/percpu.=\nh\n> index 20696df5d567..fc77c99d2e80 100644\n> --- a/arch/x86/include/asm/percpu.h\n> +++ b/arch/x86/include/asm/percpu.h\n> @@ -95,7 +95,7 @@\n>\n>  #endif /* CONFIG_SMP */\n>\n> -#define __my_cpu_type(var)     typeof(var) __percpu_seg_override\n> +#define __my_cpu_type(var)     __typeof_unqual__(var) __percpu_seg_overr=\nide\n>  #define __my_cpu_ptr(ptr)      (__my_cpu_type(*ptr)*)(__force uintptr_t)=\n(ptr)\n>  #define __my_cpu_var(var)      (*__my_cpu_ptr(&(var)))\n>  #define __percpu_arg(x)                __percpu_prefix \"%\" #x\n\nIMO, the above change is not correct. Currently, the percpu variables\nstill live in generic address space, and the above casts are used at\nthe usage site of the percpu variable to convert pointer from generic\nto disjoint __seg_gs address space (please see [2], section 6.17.5).\nThe -Wduplicate-decl-specifier warning at [1] (if correct) perhaps\npoints to the percpu accessor chain. GCC does not care about duplicate\n__seg_gs conversions (the operation is idempotent), but the issue\nshould be corrected nevertheless.\n\nBTW: With the above approach we get all the benefits of named address\nspaces, but *not* checks for invalid access between disjoint address\nspaces. This check is currently done by sparse (this is the reason for\n__force in the above cast chain), but the check is not enabled by\ndefault. The proposed improvement would *define* the percpu variable\nin __seg_gs named address space, so the compiler will error out with\n\"assignment/return from pointer to non-enclosed address space\" when\ninvalid access is detected (please see attached testcase, should be\ncompiled with gcc-14 due to usage of __typeof_unqual__) or warn with\n\"cast to generic address space pointer from disjoint =E2=80=98__seg_gs=E2=\n=80=99\naddress space pointer\" with explicit cast.\n\n[1] https://lore.kernel.org/lkml/20240320173758.GA3017166@dev-arch.thelio-3=\n990X/\n[2] https://gcc.gnu.org/onlinedocs/gcc/Named-Address-Spaces.html\n\nUros.\n\n--000000000000dc1a7f06153fd66f\nContent-Type: text/x-csrc; charset=\"US-ASCII\"; name=\"seg.c\"\nContent-Disposition: attachment; filename=\"seg.c\"\nContent-Transfer-Encoding: base64\nContent-ID: <f_lukvrsfr0>\nX-Attachment-Id: f_lukvrsfr0\n\naW50IF9fc2VnX2dzIHZhcjsKCnZvaWQgZm9vMSAodm9pZCkKewogIGFzbSB2b2xhdGlsZSAoIiMg\nJTAiIDo6ICJtIiAodmFyKSk7Cn0KCmludCBmb28yICh2b2lkKQp7CiAgcmV0dXJuIHZhcjsKfQoK\naW50IF9fc2VnX2dzICpiYXIxICh2b2lkKQp7CiAgcmV0dXJuICZ2YXI7Cn0KCmludCAqYmFyMiAo\ndm9pZCkKewogIC8vIHJldHVybiAmdmFyOyAvKiBlcnJvciAqLwogIHJldHVybiAoaW50ICopJnZh\ncjsKfQoKaW50ICpiYXIzICh2b2lkKQp7CiAgaW50ICpwOwoKICAvLyAgcCA9ICZ2YXI7IC8qIGVy\ncm9yICovCiAgcCA9IChpbnQgKikmdmFyOwoKICByZXR1cm4gcDsKfQoKaW50IF9fc2VnX2dzICpi\nYXoxICh2b2lkKQp7CiAgdHlwZW9mKHZhcikgKnA7IC8qIChfX3NlZ19ncyBpbnQgKikgKi8KCiAg\ncCA9ICZ2YXI7CgogIHJldHVybiBwOwp9CgppbnQgKmJhejIgKHZvaWQpCnsKICBfX3R5cGVvZl91\nbnF1YWxfXyh2YXIpICpwOyAvKiAoaW50ICopICovCgogIC8vIHAgPSAmdmFyOyAvKiBlcnJvciAq\nLwogIHAgPSAoaW50ICopJnZhcjsKCiAgcmV0dXJuIHA7Cn0K\n--000000000000dc1a7f06153fd66f--\n",
          "year": "2024",
          "month": "04"
        }
      ],
      "primary_category": "kernel_integration"
    },
    {
      "subject": "Re: Christmas wish list: -Werror and -Wno-warn-about-X",
      "normalized_subject": "Christmas wish list: -Werror and -Wno-warn-about-X",
      "message_count": 2,
      "participants": [
        "Herbert, Marc",
        "Luc Van Oostenryck"
      ],
      "categories": [
        "kernel_integration",
        "compiler_compat",
        "sparse_internals"
      ],
      "first_date": "2024-01-20T01:27:17+00:00",
      "last_date": "2024-10-09T21:18:24+00:00",
      "year": 2024,
      "messages": [
        {
          "filepath": "emails/2024/01/170571398021000.mbox",
          "message_id": "<3eifvstptigzcjthdjwshxxxqtn3yjtm4jifhs4sqcsrqhozjh () 6ixifzmsekkq>",
          "author_name": "Luc Van Oostenryck",
          "author_email": "lucvoo () kernel ! org",
          "subject": "Re: Christmas wish list: -Werror and -Wno-warn-about-X",
          "date": "2024-01-20 01:27:17+00:00",
          "date_str": "Sat, 20 Jan 2024 01:27:17 +0000",
          "body": "On Fri, Jan 19, 2024 at 11:09:47PM +0000, Herbert, Marc wrote:\n> \n> > Anyway, with this it was very easy to reproduce and find the cause.\n> > Fixed and pushed, so mainline Sparse should be OK now.\n> \n> > Many thanks for the bug report,\n> \n> Fix confirmed, many thanks for the super quick fix!\n> \n> It's also great to see that you seem to have more time to spend on\n> sparse right now.\n\nIf only ...\n\n> So trying to push my luck, here's the number 1 item on\n> my \"Christmas Wish List\": a combination of -Werror and -Wno-warn-about-X\n> options that would provides finer-grained and generally better control\n> on the exit status and output. After maintaining sparse automation for\n> many months, this is I think what would lower the CI adoption bar the\n> most.\n\nYes, I can understand that.\n\nAs far as I understand it, -Werror has been replaced by -Wsparse-error in\n2014 because sparse was mainly used with exactly the same options as the\nones used for the compiler (which is good), there was too much error\nmessages and people didn't want to have their build to fail (see commits\n4d8811879a1c & fe57afa0b44a). So, essentially the exact opposite of what\nyou would like :(\n\n-Wsparse-error is really a pain because it also turn every warning into\nan error (and then exit on these errors).\n\nIt should indeed be possible to have an exit(1) on errors but I'm very wary\nof changing the current behaviour. What about something like -ffail-on-error?\n\n> So far we've been using a brittle script that captures the incredibly\n> verbose and mostly unusable output (mostly due to some hard-to-fix\n> warnings located in common .h files) and \"post-processes\" it\n> with... \"grep\".\n>  https://github.com/thesofproject/sof/commit/b7708182fbe5d\n> \n> I'm curious how people typically automate runnning sparse on the\n> Linux kernel. Does everyone \"greps\" logs too? Or is it more like\n> `$(wc -l) == 0`?\n\nI think so (but I could be very wrong). An exit on error is only useful\nif the output is clean and the errors not too frequent. I think it's\noften not the case.\n\nBut, if your main problem is with error messages concerning address spaces,\nhave you tried to simply use -Wno-address-space?\n\nSome other error messages issued by sparse can't be disabled but most of these\nare, I think, parsing or typing errors that are more or less unrecoverable.\n\nPurely for my own curiosity, could you send me one of your log of sparse\nerrors?\n\nBest regards,\n-- Luc\n",
          "year": "2024",
          "month": "01"
        },
        {
          "filepath": "emails/2024/10/172850859001528.mbox",
          "message_id": "<DC94BE6E-41B2-45BA-A7D3-B8F19D535643 () intel ! com>",
          "author_name": "Herbert, Marc",
          "author_email": "marc.herbert () intel ! com",
          "subject": "Re: Christmas wish list: -Werror and -Wno-warn-about-X",
          "date": "2024-10-09 21:18:24+00:00",
          "date_str": "Wed, 09 Oct 2024 21:18:24 +0000",
          "body": "I just realized I never answered this? Sorry.\n\nAdding a couple people in Bcc:, full thread is here:\nhttps://lore.kernel.org/linux-sparse/3eifvstptigzcjthdjwshxxxqtn3yjtm4jifhs=\n4sqcsrqhozjh@6ixifzmsekkq/\n\n\n> On 19 Jan 2024, at 17:27, Luc Van Oostenryck <lucvoo@kernel.org> wrote:\n>=20\n> As far as I understand it, -Werror has been replaced by -Wsparse-error in\n> 2014 because sparse was mainly used with exactly the same options as the\n> ones used for the compiler (which is good), there was too much error\n> messages and people didn't want to have their build to fail (see commits\n> 4d8811879a1c & fe57afa0b44a). So, essentially the exact opposite of what\n> you would like :(\n>=20\n> -Wsparse-error is really a pain because it also turn every warning into\n> an error (and then exit on these errors).\n>=20\n> It should indeed be possible to have an exit(1) on errors but I'm very wa=\nry\n> of changing the current behaviour. What about something like -ffail-on-er=\nror?\n\n\nI'm not sure how the ideal user interface should look like but I know\nwhat it should _provide_. It should be possible to make this decision\nfor each error type/check individually:\n\n- silence\n- warning, exit 0\n- error, exit !0\n\ngcc does achieve this. It's a bit awkard and probably not the best user\ninterface but consistency and familiarity is key so why not the same UI\nfor sparse?\nhttps://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html\n\nSo this is one way CI has been successfully handling gcc warnings:\n\n- First, define the subset of \"forbidden\" warnings in your project.\n\n- Craft the corresponding -Wall + -Wno-warn-something command line.\n\n- Hardcode that list in the project build configuration.\n\n- Provide come EXTRA_CFLAGS=3D parameter for local/temporary\n  fine-tuning/experimentation.\n\n- Do NOT hardcode -Werror not to inconvenience developers. Obviously,\n  sometimes you want to run tests on code with warnings.\n\n- Do hardcode EXTRA_CFLAGS=3D-Werror in CI\n\nAnd that's it, grep-free!\n\nIf you need even more flexibility, use -W[no-]error=3Dsome-warning\n\n\n\n\n>> So far we've been using a brittle script that captures the incredibly\n>> verbose and mostly unusable output (mostly due to some hard-to-fix\n>> warnings located in common .h files) and \"post-processes\" it\n>> with... \"grep\".\n>> https://github.com/thesofproject/sof/commit/b7708182fbe5d\n>>=20\n>> I'm curious how people typically automate runnning sparse on the\n>> Linux kernel. Does everyone \"greps\" logs too? Or is it more like\n>> `$(wc -l) =3D=3D 0`?\n>=20\n> I think so (but I could be very wrong). An exit on error is only useful\n> if the output is clean and the errors not too frequent. I think it's\n> often not the case.\n\nThis is a problem only with parallel builds that have mostly unreadable\noutput anyway not matter what. Here's a dead-simple and very robust\nworkaround that I have successfully used a lot in CI:\n\n   make -j || make -j1\n\nTa-da: now the _error_ that stopped the build is last, _after_ all the\nwarnings that did not.\n\n> But, if your main problem is with error messages concerning address space=\ns,\n> have you tried to simply use -Wno-address-space?\n\nFunny you say that because address spaces is the one thing we care about\nthe most and why we started using sparse :-D It's the only thing\nwe \"grep\" for failures:\n\nhttps://github.com/thesofproject/sof/blob/d345c56e71b495a1e4eec1a48e48d3d5b=\ne055cda/scripts/parse_sparse_output.sh=20\n\nBut I get your point: \"someone\" should probably look at what -Wno-stuff\noptions sparse has available.\n\nAlso note: some warnings point at \"real\" issues and if you silence them\nthen they will never get fixed :-)\n\nAs a coincidence, this sign warning was just fixed after 2 years:\nhttps://github.com/zephyrproject-rtos/zephyr/issues/53505\nIt was especially verbose (half the total!) because located in a .h file.\n\n\n> Some other error messages issued by sparse can't be disabled but most of =\nthese\n> are, I think, parsing or typing errors that are more or less unrecoverabl=\ne.\n\nYes: failing on unrecoverable errors is good :-)\n\n\n> Purely for my own curiosity, could you send me one of your log of sparse\n> errors?\n\nRunning daily there:\nhttps://github.com/thesofproject/sof/actions/workflows/daily-tests.yml=20\n\n-> Sparse Zephyr -> zephyr-sparse-analyzer / warnings-subset=20\nhttps://github.com/thesofproject/sof/actions/runs/11206675653/job/311477703=\n59\n\nCorresponding script is here:=20\nhttps://github.com/thesofproject/sof/commit/0061953a595b18c12a5962edced12d9=\nac9ac1ce2\n\nTake care\n\nMarc=\n",
          "year": "2024",
          "month": "10"
        }
      ],
      "primary_category": "kernel_integration"
    }
  ]
}