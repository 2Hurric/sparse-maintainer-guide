<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparse Development History & Roadmap</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0f;
            --bg-card: #12121a;
            --bg-hover: #1a1a25;
            --bg-elevated: #1e1e2a;
            --text: #e4e4e7;
            --text-muted: #71717a;
            --text-secondary: #a1a1aa;
            --accent: #3b82f6;
            --accent-soft: rgba(59, 130, 246, 0.15);
            --border: #27272a;
            --border-light: #3f3f46;
            --green: #22c55e;
            --green-soft: rgba(34, 197, 94, 0.12);
            --yellow: #eab308;
            --yellow-soft: rgba(234, 179, 8, 0.12);
            --red: #ef4444;
            --red-soft: rgba(239, 68, 68, 0.12);
            --purple: #a78bfa;
            --purple-soft: rgba(167, 139, 250, 0.12);
            --cyan: #22d3ee;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 24px; }

        /* Header */
        header {
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
            position: sticky;
            top: 0;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(12px);
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: -0.02em;
        }

        nav { display: flex; gap: 32px; }

        nav a {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        nav a:hover, nav a.active { color: var(--text); }

        /* Hero */
        .hero {
            padding: 80px 0 60px;
            text-align: center;
        }

        .hero h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--text), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.03em;
        }

        .hero p {
            color: var(--text-muted);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto 40px;
        }

        .stats-row {
            display: flex;
            justify-content: center;
            gap: 48px;
        }

        .stat { text-align: center; }
        .stat-value { font-size: 2.5rem; font-weight: 700; color: var(--accent); }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); }

        /* Sections */
        section { padding: 60px 0; }

        .section-header { margin-bottom: 40px; }

        .section-header h2 {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .section-header p { color: var(--text-muted); }

        /* Topic Cards */
        .topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .topic-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .topic-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.08);
        }

        .topic-card h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .topic-card h3 .count {
            background: var(--accent-soft);
            color: var(--accent);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .topic-card p {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 16px;
        }

        .topic-tags { display: flex; flex-wrap: wrap; gap: 6px; }

        .topic-tag {
            background: var(--bg);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Roadmap */
        .roadmap-year { margin-bottom: 48px; }

        .year-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .year-badge {
            background: var(--accent);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .year-stats {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .roadmap-events {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-left: 20px;
            padding-left: 20px;
            border-left: 2px solid var(--border);
        }

        .roadmap-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .roadmap-item:hover {
            border-color: var(--accent);
            background: var(--bg-hover);
        }

        .roadmap-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 8px;
        }

        .roadmap-item-title { font-weight: 500; flex: 1; }

        .outcome-badge {
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .outcome-badge.merged { background: var(--green-soft); color: var(--green); }
        .outcome-badge.accepted { background: var(--accent-soft); color: var(--accent); }
        .outcome-badge.rejected { background: var(--red-soft); color: var(--red); }
        .outcome-badge.discussed { background: var(--yellow-soft); color: var(--yellow); }

        .item-meta {
            display: flex;
            gap: 16px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Decisions */
        .decisions-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .decision-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .decision-card:hover {
            border-color: var(--accent);
            background: var(--bg-hover);
        }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            overflow-y: auto;
            padding: 40px 20px;
        }

        .modal-overlay.active { display: block; }

        .modal {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 960px;
            margin: 0 auto;
            overflow: hidden;
        }

        .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            padding-right: 40px;
            margin-bottom: 10px;
            letter-spacing: -0.01em;
        }

        .modal-header-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .modal-header-meta .tag {
            background: var(--bg);
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .modal-close {
            position: absolute;
            right: 20px;
            top: 20px;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            color: var(--text-muted);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: var(--text);
            border-color: var(--text-muted);
        }

        .modal-body {
            padding: 24px 28px;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Thread list inside topic modal */
        .thread-list-item {
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-card);
        }

        .thread-list-item:hover {
            border-color: var(--accent);
            background: var(--bg-hover);
        }

        .thread-list-title {
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .thread-list-meta {
            display: flex;
            gap: 14px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Message cards in thread view */
        .message-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .message-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
        }

        .message-author-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .author-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-soft);
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .author-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .author-email {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .message-date {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .message-body-container {
            padding: 18px;
        }

        .message-body-container p {
            margin-bottom: 12px;
            line-height: 1.7;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .message-body-container p:last-child {
            margin-bottom: 0;
        }

        /* Quoted text */
        .email-quote {
            border-left: 3px solid var(--border-light);
            padding: 8px 14px;
            margin: 12px 0;
            background: rgba(255,255,255,0.02);
            border-radius: 0 8px 8px 0;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .email-quote .email-quote {
            border-left-color: var(--border);
            background: rgba(255,255,255,0.01);
            font-size: 0.82rem;
        }

        /* Code/diff blocks */
        .email-code {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px 16px;
            margin: 12px 0;
            font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
            font-size: 0.82rem;
            line-height: 1.5;
            color: var(--text-secondary);
            overflow-x: auto;
            white-space: pre;
        }

        .email-code .diff-add { color: var(--green); }
        .email-code .diff-del { color: var(--red); }
        .email-code .diff-hunk { color: var(--cyan); }

        /* Signature */
        .email-signature {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            font-size: 0.8rem;
            color: var(--text-muted);
            opacity: 0.6;
        }

        /* Back button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            color: var(--text);
            border-color: var(--accent);
        }

        /* Show more button */
        .show-more-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background: var(--bg-card);
            border: 1px dashed var(--border);
            border-radius: 10px;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            margin-top: 8px;
        }

        .show-more-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Collapsed quote toggle */
        .quote-toggle {
            display: inline-block;
            padding: 2px 8px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            margin: 4px 0;
        }

        .quote-toggle:hover { color: var(--accent); border-color: var(--accent); }

        /* MARC link */
        .marc-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--accent);
            text-decoration: none;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .marc-link:hover {
            background: var(--accent-soft);
            border-color: var(--accent);
        }

        /* Footer */
        footer {
            border-top: 1px solid var(--border);
            padding: 40px 0;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        footer a { color: var(--accent); text-decoration: none; }

        @media (max-width: 768px) {
            .hero h1 { font-size: 2rem; }
            .stats-row { flex-wrap: wrap; gap: 24px; }
            .topics-grid { grid-template-columns: 1fr; }
            nav { gap: 16px; font-size: 0.8rem; }
            .modal { border-radius: 12px; }
            .modal-body { padding: 16px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">Sparse</div>
            <nav>
                <a href="#topics" class="active">Topics</a>
                <a href="#roadmap">Roadmap</a>
                <a href="#decisions">Key Decisions</a>
            </nav>
        </div>
    </header>

    <main>
        <section class="hero">
            <div class="container">
                <h1>Sparse Development History</h1>
                <p>22 years of mailing list discussions, organized by topic. Understand how decisions were made and why.</p>
                <div class="stats-row" id="stats-row">
                    <div class="stat">
                        <div class="stat-value" id="stat-messages">--</div>
                        <div class="stat-label">Messages</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="stat-threads">--</div>
                        <div class="stat-label">Threads</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="stat-topics">--</div>
                        <div class="stat-label">Topic Areas</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="topics">
            <div class="container">
                <div class="section-header">
                    <h2>Browse by Topic</h2>
                    <p>Click any topic to explore related discussions and decisions</p>
                </div>
                <div class="topics-grid" id="topics-grid"></div>
            </div>
        </section>

        <section id="roadmap">
            <div class="container">
                <div class="section-header">
                    <h2>Development Roadmap</h2>
                    <p>Major decisions and milestones by year</p>
                </div>
                <div id="roadmap-content"></div>
            </div>
        </section>

        <section id="decisions">
            <div class="container">
                <div class="section-header">
                    <h2>Key Decisions</h2>
                    <p>Important technical decisions with their rationale</p>
                </div>
                <div id="decisions-list"></div>
            </div>
        </section>
    </main>

    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <button class="modal-close" id="modal-close-btn">&times;</button>
                <div class="modal-header-meta" id="modal-meta"></div>
            </div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>Data extracted from <a href="https://marc.info/?l=linux-sparse" target="_blank">MARC linux-sparse archive</a></p>
            <p>Filtered: 414 spam, 110 unrelated messages removed</p>
        </div>
    </footer>

    <script>
        let topicsData = null;

        // --- Data loading ---
        async function loadData() {
            try {
                const resp = await fetch('topics_data.json');
                topicsData = await resp.json();

                // Stats
                const s = topicsData.stats;
                document.getElementById('stat-messages').textContent = s.total_messages.toLocaleString();
                document.getElementById('stat-threads').textContent = s.total_threads.toLocaleString();
                document.getElementById('stat-topics').textContent = Object.keys(s.categories).length;

                renderTopics();
                renderRoadmap();
                renderDecisions();
            } catch (e) {
                console.error('Failed to load data:', e);
            }
        }

        // --- Escape HTML safely ---
        function esc(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- Format email body into readable HTML ---
        function formatEmailBody(raw) {
            if (!raw) return '<p style="color:var(--text-muted);font-style:italic;">(empty message)</p>';

            const lines = raw.split('\n');
            let html = '';
            let inCode = false;
            let codeLines = [];
            let inQuote = false;
            let quoteLines = [];
            let bodyLines = [];
            let signatureStarted = false;
            let signatureLines = [];

            function flushBody() {
                if (bodyLines.length > 0) {
                    const text = bodyLines.join('\n').trim();
                    if (text) {
                        // Split into paragraphs on double newlines
                        const paragraphs = text.split(/\n\s*\n/);
                        for (const para of paragraphs) {
                            const trimmed = para.trim();
                            if (trimmed) html += '<p>' + esc(trimmed) + '</p>';
                        }
                    }
                    bodyLines = [];
                }
            }

            function flushQuote() {
                if (quoteLines.length > 0) {
                    const text = quoteLines.map(l => l.replace(/^>+\s?/, '')).join('\n').trim();
                    if (text) {
                        // For long quotes, make them collapsible
                        if (quoteLines.length > 6) {
                            const id = 'q' + Math.random().toString(36).substr(2, 6);
                            const preview = quoteLines.slice(0, 3).map(l => l.replace(/^>+\s?/, '')).join('\n');
                            html += '<div class="email-quote">' + esc(preview) +
                                '<span class="quote-toggle" onclick="toggleQuote(\'' + id + '\', this)">... show more</span>' +
                                '<span id="' + id + '" style="display:none">\n' + esc(quoteLines.slice(3).map(l => l.replace(/^>+\s?/, '')).join('\n')) + '</span></div>';
                        } else {
                            html += '<div class="email-quote">' + esc(text) + '</div>';
                        }
                    }
                    quoteLines = [];
                }
            }

            function flushCode() {
                if (codeLines.length > 0) {
                    let codeHtml = '';
                    for (const cl of codeLines) {
                        if (cl.startsWith('+') && !cl.startsWith('+++')) {
                            codeHtml += '<span class="diff-add">' + esc(cl) + '</span>\n';
                        } else if (cl.startsWith('-') && !cl.startsWith('---')) {
                            codeHtml += '<span class="diff-del">' + esc(cl) + '</span>\n';
                        } else if (cl.startsWith('@@')) {
                            codeHtml += '<span class="diff-hunk">' + esc(cl) + '</span>\n';
                        } else {
                            codeHtml += esc(cl) + '\n';
                        }
                    }
                    html += '<div class="email-code">' + codeHtml.trimEnd() + '</div>';
                    codeLines = [];
                }
            }

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // Detect signature start
                if (line === '-- ' || line === '---' && i > lines.length * 0.7) {
                    flushBody();
                    flushQuote();
                    flushCode();
                    signatureStarted = true;
                    continue;
                }

                if (signatureStarted) {
                    signatureLines.push(line);
                    continue;
                }

                // Detect diff/patch blocks
                const isDiff = line.startsWith('diff --git') || line.startsWith('---') && lines[i+1]?.startsWith('+++');
                const isCodeContext = inCode && (
                    line.startsWith('+') || line.startsWith('-') ||
                    line.startsWith(' ') || line.startsWith('@@') ||
                    line === '' || line.startsWith('diff ') ||
                    line.startsWith('index ') || line.startsWith('---') || line.startsWith('+++')
                );

                if (isDiff && !inCode) {
                    flushBody();
                    flushQuote();
                    inCode = true;
                    codeLines.push(line);
                    continue;
                }

                if (inCode) {
                    if (isCodeContext || line.startsWith('diff ') || line.startsWith('index ')) {
                        codeLines.push(line);
                        continue;
                    } else {
                        flushCode();
                        inCode = false;
                    }
                }

                // Quoted lines
                if (line.startsWith('>')) {
                    flushBody();
                    if (!inQuote) inQuote = true;
                    quoteLines.push(line);
                    continue;
                } else if (inQuote) {
                    flushQuote();
                    inQuote = false;
                }

                // Regular body text
                bodyLines.push(line);
            }

            // Flush remaining
            flushBody();
            flushQuote();
            flushCode();

            if (signatureLines.length > 0) {
                const sigText = signatureLines.join('\n').trim();
                if (sigText) {
                    html += '<div class="email-signature">' + esc(sigText) + '</div>';
                }
            }

            return html || '<p style="color:var(--text-muted);font-style:italic;">(empty message)</p>';
        }

        function toggleQuote(id, btn) {
            const el = document.getElementById(id);
            if (el.style.display === 'none') {
                el.style.display = 'inline';
                btn.textContent = ' show less';
            } else {
                el.style.display = 'none';
                btn.textContent = '... show more';
            }
        }

        function getInitials(name) {
            if (!name) return '?';
            const parts = name.trim().split(/\s+/);
            if (parts.length >= 2) return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
            return name[0].toUpperCase();
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                const d = new Date(dateStr);
                if (isNaN(d)) return dateStr;
                return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch (e) {
                return dateStr;
            }
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            try {
                const d = new Date(dateStr);
                if (isNaN(d)) return dateStr;
                return d.toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
            } catch (e) {
                return dateStr;
            }
        }

        // --- Build MARC search URL ---
        function marcSearchUrl(subject) {
            const q = encodeURIComponent(subject.replace(/\[PATCH[^\]]*\]\s*/g, '').substring(0, 80));
            return 'https://marc.info/?l=linux-sparse&w=2&r=1&s=' + q + '&q=b';
        }

        // --- Render sections ---
        function renderTopics() {
            const grid = document.getElementById('topics-grid');
            const categories = topicsData.category_info;
            const stats = topicsData.stats.categories;

            let html = '';
            for (const [id, info] of Object.entries(categories)) {
                const count = stats[id] || 0;
                const keywords = info.keywords.slice(0, 5);
                html += `
                    <div class="topic-card" data-cat="${id}">
                        <h3>${esc(info.title)} <span class="count">${count} threads</span></h3>
                        <p>${esc(info.description)}</p>
                        <div class="topic-tags">
                            ${keywords.map(k => '<span class="topic-tag">' + esc(k) + '</span>').join('')}
                        </div>
                    </div>`;
            }
            grid.innerHTML = html;

            // Attach click handlers
            grid.querySelectorAll('.topic-card').forEach(card => {
                card.addEventListener('click', () => showTopicThreads(card.dataset.cat));
            });
        }

        function renderRoadmap() {
            const container = document.getElementById('roadmap-content');
            const roadmap = topicsData.roadmap;
            const years = Object.keys(roadmap).sort((a, b) => b - a);

            let html = '';
            for (const year of years.slice(0, 10)) {
                const data = roadmap[year];
                const events = data.events.slice(0, 6);

                html += `
                    <div class="roadmap-year">
                        <div class="year-header">
                            <div class="year-badge">${esc(year)}</div>
                            <div class="year-stats">${data.events.length} significant discussions</div>
                        </div>
                        <div class="roadmap-events">
                            ${events.map((e, idx) => `
                                <div class="roadmap-item" data-year="${year}" data-idx="${idx}">
                                    <div class="roadmap-item-header">
                                        <div class="roadmap-item-title">${esc(e.subject)}</div>
                                        <span class="outcome-badge ${e.outcome || 'discussed'}">${esc(e.outcome || 'discussed')}</span>
                                    </div>
                                    <div class="item-meta">
                                        <span>${e.message_count} messages</span>
                                        <span>${esc(e.participants.slice(0, 3).join(', '))}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            }
            container.innerHTML = html;

            // Attach click handlers via data attributes (avoids quote escaping issues)
            container.querySelectorAll('.roadmap-item').forEach(item => {
                item.addEventListener('click', () => {
                    const year = item.dataset.year;
                    const idx = parseInt(item.dataset.idx);
                    const event = topicsData.roadmap[year].events[idx];
                    if (event) findAndShowThread(event.subject);
                });
            });
        }

        function renderDecisions() {
            const container = document.getElementById('decisions-list');
            const decisions = topicsData.key_decisions.slice(0, 20);

            let html = '<div class="decisions-grid">';
            for (let i = 0; i < decisions.length; i++) {
                const d = decisions[i];
                html += `
                    <div class="decision-card" data-didx="${i}">
                        <div class="roadmap-item-header">
                            <div class="roadmap-item-title">${esc(d.normalized_subject)}</div>
                            <span class="outcome-badge ${d.outcome || 'discussed'}">${esc(d.outcome || 'discussed')}</span>
                        </div>
                        <div class="item-meta">
                            <span>${d.message_count} messages</span>
                            <span>${esc(String(d.year))}</span>
                            <span>${esc(d.participants.slice(0, 3).join(', '))}</span>
                        </div>
                    </div>`;
            }
            html += '</div>';
            container.innerHTML = html;

            container.querySelectorAll('.decision-card').forEach(card => {
                card.addEventListener('click', () => {
                    showDecision(parseInt(card.dataset.didx));
                });
            });
        }

        // --- Find a thread by subject across all categories ---
        function findThread(subject) {
            for (const cat of Object.values(topicsData.topics)) {
                const t = cat.find(t => t.subject === subject || t.normalized_subject === subject);
                if (t) return t;
            }
            return null;
        }

        function findAndShowThread(subject) {
            const thread = findThread(subject);
            if (thread) {
                showThreadMessages(thread);
            }
        }

        // --- Modal: Show topic threads list ---
        function showTopicThreads(categoryId) {
            const threads = topicsData.topics[categoryId] || [];
            const info = topicsData.category_info[categoryId];
            const sorted = [...threads].sort((a, b) => (b.first_date || '').localeCompare(a.first_date || ''));

            const limit = 30;
            let html = '';
            for (let i = 0; i < Math.min(sorted.length, limit); i++) {
                const t = sorted[i];
                html += `
                    <div class="thread-list-item" data-tidx="${i}">
                        <div class="thread-list-title">${esc(t.subject)}</div>
                        <div class="thread-list-meta">
                            <span>${t.message_count} messages</span>
                            <span>${formatDate(t.first_date)}</span>
                            <span>${esc(t.participants.slice(0, 3).join(', '))}</span>
                        </div>
                    </div>`;
            }

            if (sorted.length > limit) {
                html += `<div class="show-more-btn" style="pointer-events:none;">${sorted.length - limit} more threads not shown</div>`;
            }

            document.getElementById('modal-title').textContent = info.title;
            document.getElementById('modal-meta').innerHTML =
                `<span>${esc(info.description)}</span><span class="tag">${threads.length} threads</span>`;
            document.getElementById('modal-body').innerHTML = html;
            openModal();

            // Attach click handlers for thread items
            document.getElementById('modal-body').querySelectorAll('.thread-list-item').forEach(item => {
                item.addEventListener('click', () => {
                    const t = sorted[parseInt(item.dataset.tidx)];
                    if (t) showThreadMessages(t);
                });
            });
        }

        // --- Modal: Show thread messages (modern formatted) ---
        function showThreadMessages(thread, options) {
            const backTo = options?.backTo || null;

            let html = '';

            // Back button if navigated from topic list
            if (backTo) {
                html += `<button class="back-btn" id="back-to-topic">&larr; Back to topic</button>`;
            }

            // Thread info bar
            html += `<div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;align-items:center;">`;
            if (thread.categories) {
                for (const cat of thread.categories.slice(0, 3)) {
                    const info = topicsData.category_info[cat];
                    if (info) html += `<span class="outcome-badge discussed">${esc(info.title)}</span>`;
                }
            }
            html += `<a class="marc-link" href="${marcSearchUrl(thread.subject)}" target="_blank" rel="noopener">View on MARC &rarr;</a>`;
            html += `</div>`;

            // Messages
            const msgs = thread.messages || [];
            const showLimit = 15;
            const toShow = msgs.slice(0, showLimit);

            for (const msg of toShow) {
                html += renderMessageCard(msg);
            }

            if (msgs.length > showLimit) {
                html += `<div class="show-more-btn" style="pointer-events:none;">${msgs.length - showLimit} more messages in this thread</div>`;
            }

            document.getElementById('modal-title').textContent = thread.subject;
            document.getElementById('modal-meta').innerHTML = `
                <span>${thread.message_count} messages</span>
                <span>${formatDate(thread.first_date)} &ndash; ${formatDate(thread.last_date)}</span>
                <span>${esc(thread.participants.slice(0, 5).join(', '))}</span>`;
            document.getElementById('modal-body').innerHTML = html;

            // Scroll to top of modal body
            document.getElementById('modal-body').scrollTop = 0;

            if (!document.getElementById('modal').classList.contains('active')) {
                openModal();
            }

            // Back button handler
            if (backTo) {
                document.getElementById('back-to-topic')?.addEventListener('click', () => {
                    showTopicThreads(backTo);
                });
            }
        }

        function renderMessageCard(msg) {
            const date = formatDateTime(msg.date || msg.date_str);
            const initials = getInitials(msg.author_name);
            const formattedBody = formatEmailBody(msg.body);

            return `
                <div class="message-card">
                    <div class="message-card-header">
                        <div class="message-author-info">
                            <div class="author-avatar">${esc(initials)}</div>
                            <div>
                                <div class="author-name">${esc(msg.author_name)}</div>
                                ${msg.author_email ? '<div class="author-email">' + esc(msg.author_email) + '</div>' : ''}
                            </div>
                        </div>
                        <div class="message-date">${esc(date)}</div>
                    </div>
                    <div class="message-body-container">
                        ${formattedBody}
                    </div>
                </div>`;
        }

        // --- Modal: Show decision detail ---
        function showDecision(index) {
            const d = topicsData.key_decisions[index];
            if (!d) return;

            let html = '';

            // Try to find the full thread
            const thread = findThread(d.normalized_subject) || findThread(d.subject);

            if (thread) {
                html += `<div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;align-items:center;">`;
                html += `<a class="marc-link" href="${marcSearchUrl(d.normalized_subject)}" target="_blank" rel="noopener">View on MARC &rarr;</a>`;
                html += `</div>`;

                const msgs = thread.messages || [];
                for (const msg of msgs.slice(0, 10)) {
                    html += renderMessageCard(msg);
                }
                if (msgs.length > 10) {
                    html += `<div class="show-more-btn" style="pointer-events:none;">${msgs.length - 10} more messages</div>`;
                }
            } else {
                // Fallback: show first message body and rationale
                if (d.first_message_body) {
                    html += renderMessageCard({
                        author_name: d.participants[0] || 'Unknown',
                        date: d.year + '',
                        body: d.first_message_body
                    });
                }

                if (d.rationale && d.rationale.length > 0) {
                    html += '<h3 style="margin:24px 0 14px;font-size:1rem;color:var(--text-muted);">Key Rationale</h3>';
                    for (const r of d.rationale) {
                        html += renderMessageCard({
                            author_name: r.author,
                            body: r.text
                        });
                    }
                }
            }

            document.getElementById('modal-title').textContent = d.normalized_subject;
            document.getElementById('modal-meta').innerHTML = `
                <span>${d.message_count} messages</span>
                <span>${d.year}</span>
                <span class="outcome-badge ${d.outcome || 'discussed'}">${esc(d.outcome || 'discussed')}</span>`;
            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('modal-body').scrollTop = 0;
            openModal();
        }

        // --- Modal open/close ---
        function openModal() {
            document.getElementById('modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            document.body.style.overflow = '';
        }

        document.getElementById('modal-close-btn').addEventListener('click', closeModal);

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeModal();
        });

        document.getElementById('modal').addEventListener('click', e => {
            if (e.target.id === 'modal') closeModal();
        });

        // Smooth scroll for nav
        document.querySelectorAll('nav a').forEach(a => {
            a.addEventListener('click', e => {
                const href = a.getAttribute('href');
                if (href.startsWith('#')) {
                    e.preventDefault();
                    document.querySelector(href)?.scrollIntoView({ behavior: 'smooth' });
                    document.querySelectorAll('nav a').forEach(x => x.classList.remove('active'));
                    a.classList.add('active');
                }
            });
        });

        // Load on page load
        loadData();
    </script>
</body>
</html>
